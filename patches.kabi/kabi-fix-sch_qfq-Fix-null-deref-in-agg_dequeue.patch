From: Pedro Falcato <pfalcato@suse.de>
Date: Tue, 18 Nov 2025 12:48:00 +0000
Subject: kabi: fix sch_qfq-Fix-null-deref-in-agg_dequeue.patch
Patch-mainline: Never, kabi workaround
References: CVE-2025-40083 bsc#1252912

The patch "net/sched: sch_qfq: Fix null-deref in agg_dequeue" moves
an exported function into a header (as a static inline function) and
deletes the EXPORT_SYMBOL. This breaks kABI. Move it back into place,
and re-add the EXPORT_SYMBOL.

Signed-off-by: Pedro Falcato <pfalcato@suse.de>
Reviewed-by: Michal Koutn√Ω <mkoutny@suse.com>
---
 include/net/pkt_sched.h |   10 +---------
 net/sched/sch_api.c     |   10 ++++++++++
 2 files changed, 11 insertions(+), 9 deletions(-)

--- a/include/net/pkt_sched.h
+++ b/include/net/pkt_sched.h
@@ -114,6 +114,7 @@ struct qdisc_rate_table *qdisc_get_rtab(
 					struct netlink_ext_ack *extack);
 void qdisc_put_rtab(struct qdisc_rate_table *tab);
 void qdisc_put_stab(struct qdisc_size_table *tab);
+void qdisc_warn_nonwc(const char *txt, struct Qdisc *qdisc);
 bool sch_direct_xmit(struct sk_buff *skb, struct Qdisc *q,
 		     struct net_device *dev, struct netdev_queue *txq,
 		     spinlock_t *root_lock, bool validate);
@@ -307,15 +308,6 @@ static inline bool tc_qdisc_stats_dump(s
 	return true;
 }
 
-static inline void qdisc_warn_nonwc(const char *txt, struct Qdisc *qdisc)
-{
-	if (!(qdisc->flags & TCQ_F_WARN_NONWC)) {
-		pr_warn("%s: %s qdisc %X: is non-work-conserving?\n",
-			txt, qdisc->ops->id, qdisc->handle >> 16);
-		qdisc->flags |= TCQ_F_WARN_NONWC;
-	}
-}
-
 static inline unsigned int qdisc_peek_len(struct Qdisc *sch)
 {
 	struct sk_buff *skb;
--- a/net/sched/sch_api.c
+++ b/net/sched/sch_api.c
@@ -599,6 +599,16 @@ out:
 	qdisc_skb_cb(skb)->pkt_len = pkt_len;
 }
 
+void qdisc_warn_nonwc(const char *txt, struct Qdisc *qdisc)
+{
+	if (!(qdisc->flags & TCQ_F_WARN_NONWC)) {
+		pr_warn("%s: %s qdisc %X: is non-work-conserving?\n",
+			txt, qdisc->ops->id, qdisc->handle >> 16);
+		qdisc->flags |= TCQ_F_WARN_NONWC;
+	}
+}
+EXPORT_SYMBOL(qdisc_warn_nonwc);
+
 static enum hrtimer_restart qdisc_watchdog(struct hrtimer *timer)
 {
 	struct qdisc_watchdog *wd = container_of(timer, struct qdisc_watchdog,
