From cc773b1f068eef027245654db48646d07a5f7344 Mon Sep 17 00:00:00 2001
From: Thomas Zimmermann <tzimmermann@suse.com>
Date: Mon, 19 Jan 2026 14:38:21 +0100
Subject: kABI workaround for "drm, fbcon, vga_switcheroo: Avoid race condition
 in fbcon setup" (bsc#1255128)
Patch-mainline: Never, kABI workaround
References: bsc#1255128

Commit eb76d0f55535 ("drm, fbcon, vga_switcheroo: Avoid race condition in
fbcon setup") includes <linux/pci.h> in fbcon.c.  The include statement
changes the declaration of several types to actual definitions. For example

 The following '2' exports are different:
 fbcon_modechange_possible
 fbcon_update_vcs

 because of a changed 's#dma_map_ops':
 @@ -1,3 +1,24 @@
 struct dma_map_ops {
 -	UNKNOWN
 +	void * ( * alloc ) ( s#device *, t#size_t, t#dma_addr_t *, t#gfp_t, unsigned long );
 +	void ( * free ) ( s#device *, t#size_t, void *, t#dma_addr_t, unsigned long );
 +	s#page * ( * alloc_pages_op ) ( s#device *, t#size_t, t#dma_addr_t *, e#dma_data_direction, t#gfp_t );
 +	void ( * free_pages ) ( s#device *, t#size_t, s#page *, t#dma_addr_t, e#dma_data_direction );
 +	int ( * mmap ) ( s#device *, s#vm_area_struct *, void *, t#dma_addr_t, t#size_t, unsigned long );
 +	int ( * get_sgtable ) ( s#device *, s#sg_table *, void *, t#dma_addr_t, t#size_t, unsigned long );
 +	t#dma_addr_t ( * map_page ) ( s#device *, s#page *, unsigned long, t#size_t, e#dma_data_direction, unsigned long );
 +	void ( * unmap_page ) ( s#device *, t#dma_addr_t, t#size_t, e#dma_data_direction, unsigned long );
 +	int ( * map_sg ) ( s#device *, s#scatterlist *, int, e#dma_data_direction, unsigned long );
 +	void ( * unmap_sg ) ( s#device *, s#scatterlist *, int, e#dma_data_direction, unsigned long );
 +	t#dma_addr_t ( * map_resource ) ( s#device *, t#phys_addr_t, t#size_t, e#dma_data_direction, unsigned long );
 +	void ( * unmap_resource ) ( s#device *, t#dma_addr_t, t#size_t, e#dma_data_direction, unsigned long );
 +	void ( * sync_single_for_cpu ) ( s#device *, t#dma_addr_t, t#size_t, e#dma_data_direction );
 +	void ( * sync_single_for_device ) ( s#device *, t#dma_addr_t, t#size_t, e#dma_data_direction );
 +	void ( * sync_sg_for_cpu ) ( s#device *, s#scatterlist *, int, e#dma_data_direction );
 +	void ( * sync_sg_for_device ) ( s#device *, s#scatterlist *, int, e#dma_data_direction );
 +	void ( * cache_sync ) ( s#device *, void *, t#size_t, e#dma_data_direction );
 +	int ( * dma_supported ) ( s#device *, t#u64 );
 +	t#u64 ( * get_required_mask ) ( s#device * );
 +	t#size_t ( * max_mapping_size ) ( s#device * );
 +	t#size_t ( * opt_mapping_size ) ( void );
 +	unsigned long ( * get_merge_boundary ) ( s#device * );
 }

This affects

 struct dev_iommu
 struct dma_map_ops
 struct pci_bus
 struct pci_controller
 struct pci_dev
 struct pci_dn

Signed-off-by: Thomas Zimmermann <tzimmermann@suse.com>
Reviewed-by: Takashi Iwai <tiwai@suse.de>
Acked-by: Thomas Zimmermann <tzimmermann@suse.com>
---
 drivers/video/fbdev/core/fbcon.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.c
index 0e11515a73fec..e4f89971a93da 100644
--- a/drivers/video/fbdev/core/fbcon.c
+++ b/drivers/video/fbdev/core/fbcon.c
@@ -64,7 +64,9 @@
 #include <linux/console.h>
 #include <linux/string.h>
 #include <linux/kd.h>
+#ifndef __GENKSYMS__
 #include <linux/pci.h>
+#endif
 #include <linux/panic.h>
 #include <linux/printk.h>
 #include <linux/slab.h>
-- 
2.52.0

