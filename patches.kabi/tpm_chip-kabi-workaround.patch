From: Takashi Iwai <tiwai@suse.de>
Subject: kABI workaround for tpm_chip changes
Patch-mainline: Never, kABI workaround
References: CVE-2025-71077 bsc#1256613

The recent TPM fix by patches.suse/tpm-Cap-the-number-of-PCR-banks.patch
caused a kABI breakage due to the changes in struct tpm_chip; the formerly
dynamically allocated array was changed to a fixed size array.

For keeping the kABI, return to the old dynamic allocations, but just keep
the upper limit check.  The changes from TPM_MAX_DIGEST_SIZE to
TPM2_MAX_DIGEST_SIZE doesn't matter as both point to the same number.

Reviewed-by: Jan Kara <jack@suse.cz>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/char/tpm/tpm-chip.c |    1 +
 drivers/char/tpm/tpm1-cmd.c |    5 +++++
 drivers/char/tpm/tpm2-cmd.c |    8 ++++++++
 include/linux/tpm.h         |    2 +-
 4 files changed, 15 insertions(+), 1 deletion(-)

--- a/drivers/char/tpm/tpm-chip.c
+++ b/drivers/char/tpm/tpm-chip.c
@@ -274,6 +274,7 @@ static void tpm_dev_release(struct devic
 
 	kfree(chip->work_space.context_buf);
 	kfree(chip->work_space.session_buf);
+	kfree(chip->allocated_banks);
 	kfree(chip);
 }
 
--- a/drivers/char/tpm/tpm1-cmd.c
+++ b/drivers/char/tpm/tpm1-cmd.c
@@ -799,6 +799,11 @@ int tpm1_pm_suspend(struct tpm_chip *chi
  */
 int tpm1_get_pcr_allocation(struct tpm_chip *chip)
 {
+	chip->allocated_banks = kcalloc(1, sizeof(*chip->allocated_banks),
+					GFP_KERNEL);
+	if (!chip->allocated_banks)
+		return -ENOMEM;
+
 	chip->allocated_banks[0].alg_id = TPM_ALG_SHA1;
 	chip->allocated_banks[0].digest_size = hash_digest_size[HASH_ALGO_SHA1];
 	chip->allocated_banks[0].crypto_id = HASH_ALGO_SHA1;
--- a/drivers/char/tpm/tpm2-cmd.c
+++ b/drivers/char/tpm/tpm2-cmd.c
@@ -581,6 +581,14 @@ ssize_t tpm2_get_pcr_allocation(struct t
 		goto out;
 	}
 
+	 chip->allocated_banks = kcalloc(nr_possible_banks,
+					 sizeof(*chip->allocated_banks),
+					 GFP_KERNEL);
+	 if (!chip->allocated_banks) {
+		rc = -ENOMEM;
+		goto out;
+	}
+
 	marker = &buf.data[TPM_HEADER_SIZE + 9];
 
 	rsp_len = be32_to_cpup((__be32 *)&buf.data[2]);
--- a/include/linux/tpm.h
+++ b/include/linux/tpm.h
@@ -159,7 +159,7 @@ struct tpm_chip {
 	unsigned int groups_cnt;
 
 	u32 nr_allocated_banks;
-	struct tpm_bank_info allocated_banks[TPM2_MAX_PCR_BANKS];
+	struct tpm_bank_info *allocated_banks;
 #ifdef CONFIG_ACPI
 	acpi_handle acpi_dev_handle;
 	char ppi_version[TPM_PPI_VERSION_LEN + 1];
