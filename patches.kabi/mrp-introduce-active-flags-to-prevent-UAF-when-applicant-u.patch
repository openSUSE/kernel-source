From: "Ricardo B. Marlière" <rbm@suse.com>
Subject: kABI: Fixup for struct mrp_applicant
Patch-mainline: Never, kABI workaround
References: CVE-2022-50697 bsc#1255594

Mainline commit ab0377803daf ("mrp: introduce active flags to prevent UAF
when applicant uninit") added a new member to struct mrp_applicant. Use the
hole it has.

```
struct mrp_applicant {
	(...)
	spinlock_t                 lock;                 /*    96     4 */

	/* XXX 4 bytes hole, try to pack */

	struct sk_buff_head        queue;                /*   104    24 */
	(...)
} __attribute__((__aligned__(8)));
```

Acked-by: Fernando Fernandez Mancera <fmancera@suse.de>
Reviewed-by: Petr Pavlu <petr.pavlu@suse.com>
Signed-off-by: Ricardo B. Marlière <rbm@suse.com>
---
 include/net/mrp.h | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/include/net/mrp.h b/include/net/mrp.h
index a8102661fd61..df260405517d 100644
--- a/include/net/mrp.h
+++ b/include/net/mrp.h
@@ -115,13 +115,34 @@ struct mrp_applicant {
 	struct timer_list	join_timer;
 	struct timer_list	periodic_timer;
 
+	spinlock_t		lock;
+#ifndef __GENKSYMS__
+	bool			active;
+#endif
+	struct sk_buff_head	queue;
+	struct sk_buff		*pdu;
+	struct rb_root		mad;
+	struct rcu_head		rcu;
+};
+
+struct __orig_mrp_applicant {
+	struct mrp_application	*app;
+	struct net_device	*dev;
+	struct timer_list	join_timer;
+	struct timer_list	periodic_timer;
+
 	spinlock_t		lock;
 	struct sk_buff_head	queue;
 	struct sk_buff		*pdu;
 	struct rb_root		mad;
 	struct rcu_head		rcu;
-	bool			active;
 };
+suse_kabi_static_assert(offsetof(struct mrp_applicant, lock) ==
+			offsetof(struct __orig_mrp_applicant, lock));
+suse_kabi_static_assert(offsetof(struct mrp_applicant, queue) ==
+			offsetof(struct __orig_mrp_applicant, queue));
+suse_kabi_static_assert(sizeof(struct mrp_applicant) ==
+			sizeof(struct __orig_mrp_applicant));
 
 struct mrp_port {
 	struct mrp_applicant __rcu	*applicants[MRP_APPLICATION_MAX + 1];
-- 
2.52.0

