From: Takashi Iwai <tiwai@suse.de>
Subject: kABI workaround for tpm2_session changes
Patch-mainline: Never, kABI workaround
References: CVE-2025-68792 bsc#1256656

The fix for tpm2 session
  patches.suse/tpm2-sessions-Fix-out-of-range-indexing-in-name_size.patch
caused kABI breakage due to the changes of the function return types.

Restore the original function types for keeping kABI compatibility
while let them call the new functions internally.

(Note that the change is a bit hackish, but it should be relatively safe
to alias like this, as this is only changing the return type while
keeping the arguments unchanged.)

Reviewed-by: Jan Kara <jack@suse.cz>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/char/tpm/tpm2-sessions.c |   19 +++++++++++++++++++
 include/linux/tpm.h              |    2 ++
 2 files changed, 21 insertions(+)

--- a/drivers/char/tpm/tpm2-sessions.c
+++ b/drivers/char/tpm/tpm2-sessions.c
@@ -1435,3 +1435,22 @@ int tpm2_sessions_init(struct tpm_chip *
 	return rc;
 }
 #endif /* CONFIG_TCG_TPM2_HMAC */
+
+/* for kABI compatibility */
+#undef tpm_buf_append_name
+void tpm_buf_append_name(struct tpm_chip *chip, struct tpm_buf *buf,
+			 u32 handle, u8 *name)
+{
+	_tpm_buf_append_name(chip, buf, handle, name);
+}
+EXPORT_SYMBOL_GPL(tpm_buf_append_name);
+
+#ifdef CONFIG_TCG_TPM2_HMAC
+#undef tpm_buf_fill_hmac_session
+void tpm_buf_fill_hmac_session(struct tpm_chip *chip, struct tpm_buf *buf)
+{
+	_tpm_buf_fill_hmac_session(chip, buf);
+}
+EXPORT_SYMBOL(tpm_buf_fill_hmac_session);
+#endif
+
--- a/include/linux/tpm.h
+++ b/include/linux/tpm.h
@@ -533,6 +533,7 @@ static inline struct tpm2_auth *tpm2_chi
 #endif
 }
 
+#define tpm_buf_append_name _tpm_buf_append_name	// for kABI
 int tpm_buf_append_name(struct tpm_chip *chip, struct tpm_buf *buf,
 			u32 handle, u8 *name);
 void tpm_buf_append_hmac_session(struct tpm_chip *chip, struct tpm_buf *buf,
@@ -567,6 +568,7 @@ static inline void tpm_buf_append_hmac_s
 #ifdef CONFIG_TCG_TPM2_HMAC
 
 int tpm2_start_auth_session(struct tpm_chip *chip);
+#define tpm_buf_fill_hmac_session _tpm_buf_fill_hmac_session // for kABI
 int tpm_buf_fill_hmac_session(struct tpm_chip *chip, struct tpm_buf *buf);
 int tpm_buf_check_hmac_response(struct tpm_chip *chip, struct tpm_buf *buf,
 				int rc);
