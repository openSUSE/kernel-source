From: Michal Kubecek <mkubecek@suse.cz>
Date: Thu, 29 Jan 2026 07:40:51 +0100
Subject: kabi: export inet_frag_rbtree_purge() function again
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Patch-mainline: Never, kabi workaround
References: CVE-2025-68768 bsc#1256579

Backport of mainline commit 1231eec6994b ("inet: frags: add
inet_frag_queue_flush()") makes function inet_frag_rbtree_purge() static
and exports a new helper function based on it that is more convenient to
use.

To preserve kABI, we need to drop the static qualifier and export
inet_frag_rbtree_purge() again.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
Reviewed-by: Michal Koutn√Ω <mkoutny@suse.com>
Reviewed-by: Jan Kara <jack@suse.cz>
---
 include/net/inet_frag.h  | 3 +++
 net/ipv4/inet_fragment.c | 3 ++-
 2 files changed, 5 insertions(+), 1 deletion(-)

--- a/include/net/inet_frag.h
+++ b/include/net/inet_frag.h
@@ -141,6 +141,9 @@ void inet_frag_kill(struct inet_frag_queue *q);
 void inet_frag_destroy(struct inet_frag_queue *q);
 struct inet_frag_queue *inet_frag_find(struct fqdir *fqdir, void *key);
 
+/* Free all skbs in the queue; return the sum of their truesizes. */
+unsigned int inet_frag_rbtree_purge(struct rb_root *root,
+				    enum skb_drop_reason reason);
 void inet_frag_queue_flush(struct inet_frag_queue *q,
 			   enum skb_drop_reason reason);
 
--- a/net/ipv4/inet_fragment.c
+++ b/net/ipv4/inet_fragment.c
@@ -264,7 +264,7 @@ static void inet_frag_destroy_rcu(struct rcu_head *head)
 	kmem_cache_free(f->frags_cachep, q);
 }
 
-static unsigned int
+unsigned int
 inet_frag_rbtree_purge(struct rb_root *root, enum skb_drop_reason reason)
 {
 	struct rb_node *p = rb_first(root);
@@ -285,6 +285,7 @@ inet_frag_rbtree_purge(struct rb_root *root, enum skb_drop_reason reason)
 	}
 	return sum;
 }
+EXPORT_SYMBOL(inet_frag_rbtree_purge);
 
 void inet_frag_queue_flush(struct inet_frag_queue *q,
 			   enum skb_drop_reason reason)
