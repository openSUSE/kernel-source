From: Michal Kubecek <mkubecek@suse.cz>
Date: Wed, 5 Nov 2025 22:15:00 +0100
Subject: kabi: hide dst_entry::dev_rcu
Patch-mainline: Never, kabi workaround
References: CVE-2025-40139 bsc#1253409

Backport of mainline commit caedcc5b6df1 ("net: dst: introduce
dst->dev_rcu") aliases dst_entry::dev with dev_rcu member which only
differs by having __rcu annotation. In practice it's still the same pointer
so that out of tree modules built against old source would still work and
will only lack the proper lockdep checks which cannot be really helped.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
Reviewed-by: Petr Pavlu <petr.pavlu@suse.com>
---
 include/net/dst.h | 4 ++++
 1 file changed, 4 insertions(+)

--- a/include/net/dst.h
+++ b/include/net/dst.h
@@ -23,10 +23,14 @@
 struct sk_buff;
 
 struct dst_entry {
+#ifdef __GENKSYMS__
+	struct net_device       *dev;
+#else
 	union {
 		struct net_device       *dev;
 		struct net_device __rcu *dev_rcu;
 	};
+#endif
 	struct  dst_ops	        *ops;
 	unsigned long		_metrics;
 	unsigned long           expires;
