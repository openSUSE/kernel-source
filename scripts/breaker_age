#!/bin/bash

# Expects the following on stdin
# upstream_sha branch1[ branchN]
#
# Output
# upstream_sha;breaker:branch1 age_in_days[:branchN age_in_days][;breaker:branch1 age_in_days[:branchN age_in_days]];
# upstream_sha no breaker
#
# age_in_days = fix_commit_date - breaker_commit_date
#
# is the number of days since the breaker hasn't been fixed.
# fix_commit_date is commit date of the fix (upstream_sha) in kernel-source.git
# in the given branch if the fix has been backported or now otherwise
# breaker_commit_date is commit date of the breaker in kernel-source.git in
# the given branch if the breaker has been backported or upstream (Linus)
# commit date otherwise - i.e. it has been introduced by the base kernel
#
# If the breaker is not known then no breaker is printed.

. $(dirname "$0")/common-functions

now="$(date +%s)"
while read sha branches
do
	echo -n $sha
	breakers="$(sha_get_upstream_git_fixes $sha)"
	if [ -z "$breakers" ]
	then
		echo " no breaker"
		continue
	fi

	for breaker_sha in $breakers
	do
		echo -n ";$breaker_sha"
		for branch in $branches
		do
			patch_file="$(sha_to_patch_in_branch $sha $branch)"
			if [ -n "$patch_file" ]
			then
				suse_fix_sha=$(git log -1 --reverse --oneline origin/$branch -- $patch_file | head -n1 | cut -d" " -f1)
				fix_date=$(git log --format='%at' ${suse_fix_sha}^!)
			else
				fix_date=$now
			fi

			echo -n ":$branch"
			breaker_file="$(sha_to_patch_in_branch $breaker_sha $branch)"
			if [ -z "$breaker_file" ]
			then
				breaker_commit_date=$(git --git-dir=$LINUX_GIT/.git log --format='%at' ${breaker_sha}^!)
			else
				suse_breaker_sha=$(git log -1 --reverse --oneline origin/$branch -- $breaker_file | head -n1 | cut -d" " -f1)
				breaker_commit_date=$(git log --format='%at' ${suse_breaker_sha}^!)
			fi
			echo -n " $((($fix_date-$breaker_commit_date)/(60*60*24)))"
		done
	done
	echo
done
