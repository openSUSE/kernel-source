#!/bin/bash

# Expects the following on stdin
# upstream_sha branch1[ branchN]
#
# Output
# upstream_sha;breaker:branch1 age_in_days[:branchN age_in_days][;breaker:branch1 age_in_days[:branchN age_in_days]];
# upstream_sha no breaker
#
# age_in_days = fix_commit_date - breaker_commit_date
#
# is the number of days since the breaker hasn't been fixed.
# fix_commit_date is commit date of the fix (upstream_sha) in kernel-source.git
# in the given branch if the fix has been backported or now otherwise
# breaker_commit_date is commit date of the breaker in kernel-source.git in
# the given branch if the breaker has been backported or upstream (Linus)
# commit date otherwise - i.e. it has been introduced by the base kernel
#
# If the breaker is not known then no breaker is printed.

. $(dirname "$0")/common-functions

file_age()
{
	local file_name=$1
	local branch_name=$2

	# This is a dirty hack but it works for our kernel-source.git
	# patch files as they are seeing updates only for references
	# or diff body and neither tends to be on the first line
	# This is slightly more effective than git log method as our
	# history is really long and there is no effective way to cut
	# the history walk early
	local file_sha
	file_sha=$(file2first_sha $branch_name "$file_name")
	[ $? -gt 0 ] && return
	git log --format='%at' ${file_sha}^!
}

now="$(date +%s)"
while read sha branches
do
	echo -n $sha
	breakers="$(sha_get_upstream_git_fixes $sha)"
	if [ -z "$breakers" ]
	then
		echo " no breaker"
		continue
	fi

	for breaker_sha in $breakers
	do
		echo -n ";$breaker_sha"
		for branch in $branches
		do
			patch_file="$(sha_to_patch_in_branch $sha $branch)"
			if [ -n "$patch_file" ]
			then
				fix_date=$(file_age $patch_file origin/$branch)
			else
				fix_date=$now
			fi

			echo -n ":$branch"
			breaker_file="$(sha_to_patch_in_branch $breaker_sha origin/$branch)"
			if [ -z "$breaker_file" ]
			then
				breaker_commit_date=$(git --git-dir=$LINUX_GIT/.git log --format='%at' ${breaker_sha}^!)
			else
				breaker_commit_date=$(file_age $breaker_file origin/$branch)
			fi
			echo -n " $((($fix_date-$breaker_commit_date)/(60*60*24)))"
		done
	done
	echo
done
