#!/usr/bin/python3
from kutil.config import get_kernel_project_package, get_source_timestamp
from obsapi.uploader import Uploader
from obsapi.api import APIError
import subprocess
import tempfile
import argparse
import sys
import os

argv = sys.argv

params = sys.argv[1:]
progname = sys.argv[0]

parser = argparse.ArgumentParser()
parser.add_argument('-A', '--apiurl', default='https://api.opensuse.org', help='OBS API URL')
parser.add_argument('-i', '--ignore-kabi', action='store_true', help='disable kABI check at build time')
parser.add_argument('--no-init', action='store_true', help='do not create or update OBS project')
parser.add_argument('-c', '--enable-checks', action='store_true', help='do no skip rpmlint checks')
parser.add_argument('-d', '--debuginfo', action='store_true', help='enable debuginfo in OBS project')
parser.add_argument('-r', '--rebuild', action='store_true', help='do not ignore out-of-project dependency updates')
parser.add_argument('-s', '--submit', nargs='?', const=True, help='create a gitea PR, optionally provide text')
parser.add_argument('-l', '--log', nargs=1, help='log API calls to file')
parser.add_argument('--reset-branch', action='store_true', help='reset git branch head to upstream')
parser.add_argument('--maintainer', dest='maintainers', action='append', help='specify OBS project maintainers')
parser.add_argument('--flavor', dest='limit_packages', action='append', help='build only specified packages')
parser.add_argument('-q', '--quiet', dest='verbose', action='store_false', default=True, help='do not show progress')
parser.add_argument('-v', '--verbose', dest='verbose', action='store_true', default=True, help='show progress')
parser.add_argument('data', help='directory produced by tar-up')
parser.add_argument('project', help='OBS project to upload to')
args = parser.parse_args(params)
params = [p for p in params if p not in ['--reset-branch', '--submit', '-s', '-l', '--log', '-i', '--ignore-kabi']]

logfile = None
if args.log:
    logfile = open(args.log[0], 'a')
    sys.stderr.write('Logging API calls to %s\n' % (logfile.name,))


project, package = get_kernel_project_package(args.data)

try:
    ul = Uploader(api=args.apiurl, upstream_project=project, user_project=args.project, package=package, reset_branch=args.reset_branch, logfile=logfile, progress=args.verbose)
    if args.ignore_kabi:
        ul.ignore_kabi()
    ul.upload(args.data, get_source_timestamp(args.data))
    if args.submit:
        ul.submit(message=None if args.submit == True else args.submit)
    if not args.no_init:
        ul.create_project(limit_packages=args.limit_packages, maintainers=args.maintainers,
                          debuginfo=args.debuginfo, rpm_checks=args.enable_checks, rebuild=args.rebuild)
    ul.create_package(limit_packages=args.limit_packages)
except APIError as e:
    sys.stderr.write('ERROR: %s\n' % (e,))
    exit(1)
