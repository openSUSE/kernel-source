#!/usr/bin/python3

from obsapi.uploader import Uploader
from obsapi.api import APIError
import argparse
import sys

argv = sys.argv

progname = sys.argv[0]
params = sys.argv[1:]

parser = argparse.ArgumentParser()
parser.add_argument('-A', '--apiurl', default='https://api.opensuse.org')
parser.add_argument('-c', '--commit-message')
parser.add_argument('-s', '--submit-request-message')
parser.add_argument('-l', '--log', action='store_true')
parser.add_argument('--reset-branch', action='store_true')
parser.add_argument('project')
parser.add_argument('package')
parser.add_argument('package_directory', nargs='?')
args = parser.parse_args(params)

if '/' in args.project:
    pp = args.project.split('/')
    if len(pp) != 2:
        sys.stderr.write('Invalid project/package specification %s\n' % (args.project,))
        exit(1)
    if args.package_directory:
        sys.stderr.write('Too many arguments. Required: project/package package_directory\n')
    args.package_directory = args.package
    args.package = pp[1]
    args.project = pp[0]
else:
    if not args.package_directory:
        sys.stderr.write('Too few arguments. Required: project package package_directory\n')


logfile = None
if args.log:
    logfile = tempfile.NamedTemporaryFile(prefix=progname + '.', delete=False)
    sys.stderr.write('Logging API calls to %s\n' % (logfile.name,))

try:
    ul = Uploader(api=args.apiurl, upstream_project=args.project, user_project=None, package=args.package, reset_branch=args.reset_branch, logfile=logfile)
    ul.upload(args.package_directory, args.commit_message)
    ul.submit(args.submit_request_message)
except APIError as e:
    sys.stderr.write('ERROR: %s\n' % (e,))
    exit(1)
