From: Jeff Mahoney <jeffm@suse.com>
Subject: printk: Fix calculation of length used to discard records
Patch-mainline: Submitted to LKML 10 Aug 2012

While tracking down a weird buffer overflow issue in a program that
looked to be sane, I started double checking the length returned
by syslog(SYSLOG_ACTION_READ_ALL, ...) to make sure it wasn't overflowing
the buffer. Sure enough, it was.  I saw this in strace:

11339 syslog(SYSLOG_ACTION_READ_ALL, "<5>[244017.708129] REISERFS (dev"..., 8192) = 8279

It turns out that the loops that calculate how much space the entries
will take when they're copied don't include the newlines and
prefixes that will be included in the final output since prev flags
is passed as 0.

This patch properly accounts for it and fixes the overflow.

CC: stable@kernel.org
Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 kernel/printk.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/kernel/printk.c
+++ b/kernel/printk.c
@@ -1034,6 +1034,7 @@ static int syslog_print_all(char __user
 			struct log *msg = log_from_idx(idx);
 
 			len += msg_print_text(msg, prev, true, NULL, 0);
+			prev = msg->flags;
 			idx = log_next(idx);
 			seq++;
 		}
@@ -1046,6 +1047,7 @@ static int syslog_print_all(char __user
 			struct log *msg = log_from_idx(idx);
 
 			len -= msg_print_text(msg, prev, true, NULL, 0);
+			prev = msg->flags;
 			idx = log_next(idx);
 			seq++;
 		}
