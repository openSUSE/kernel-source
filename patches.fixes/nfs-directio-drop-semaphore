From: Chuck Lever <cel@netapp.com>
Subject: Prevent serialization of directio over NFS
Patch-mainline: no

This patch allows for more than one concurrent directio NFS read or write
request, by releasing the i_sem while we're doing the call. According
to Chuck Lever and Andrea Arcangeli, releasing the semaphore is not
problematic.

Not sure if/when Chuck is going to submit this to mainline.

Acked-by: Olaf Kirch <okir@suse.de>

diff -urNp linux-2.6.8/fs/nfs/direct.c linux-2.6.8.SUSE/fs/nfs/direct.c
--- linux-2.6.8/fs/nfs/direct.c	2004-08-30 15:20:19.863799882 +0200
+++ linux-2.6.8.SUSE/fs/nfs/direct.c	2004-08-30 15:21:18.403424116 +0200
@@ -422,6 +422,8 @@ nfs_direct_IO(int rw, struct kiocb *iocb
 	/*
 	 * No support for async yet
 	 */
+	up(&inode->i_sem);
+
 	if (!is_sync_kiocb(iocb))
 		return result;
 
@@ -444,6 +446,8 @@ nfs_direct_IO(int rw, struct kiocb *iocb
 	default:
 		break;
 	}
+
+	down(&inode->i_sem);
 	return result;
 }
 
