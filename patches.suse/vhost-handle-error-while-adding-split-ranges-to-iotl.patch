Patch-mainline: v5.18-rc1
Git-commit: 03a91c9af2c42ae14afafb829a4b7e6589ab5892
References: git-fixes
From: Anirudh Rayabharam <mail@anirudhrb.com>
Date: Sat, 12 Mar 2022 19:41:21 +0530
Subject: [PATCH] vhost: handle error while adding split ranges to iotlb

vhost_iotlb_add_range_ctx() handles the range [0, ULONG_MAX] by
splitting it into two ranges and adding them separately. The return
value of adding the first range to the iotlb is currently ignored.
Check the return value and bail out in case of an error.

Signed-off-by: Anirudh Rayabharam <mail@anirudhrb.com>
Link: https://lore.kernel.org/r/20220312141121.4981-1-mail@anirudhrb.com
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Fixes: e2ae38cf3d91 ("vhost: fix hung thread due to erroneous iotlb entries")
Reviewed-by: Stefano Garzarella <sgarzare@redhat.com>
Signed-off-by: Juergen Gross <jgross@suse.com>
---
 drivers/vhost/iotlb.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/vhost/iotlb.c b/drivers/vhost/iotlb.c
index 40b098320b2a..5829cf2d0552 100644
--- a/drivers/vhost/iotlb.c
+++ b/drivers/vhost/iotlb.c
@@ -62,8 +62,12 @@ int vhost_iotlb_add_range(struct vhost_iotlb *iotlb,
 	 */
 	if (start == 0 && last == ULONG_MAX) {
 		u64 mid = last / 2;
+		int err = vhost_iotlb_add_range(iotlb, start, mid, addr,
+				perm);
+
+		if (err)
+			return err;
 
-		vhost_iotlb_add_range(iotlb, start, mid, addr, perm);
 		addr += mid + 1;
 		start = mid + 1;
 	}
-- 
2.35.3

