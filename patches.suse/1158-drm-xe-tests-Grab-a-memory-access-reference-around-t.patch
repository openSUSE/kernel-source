From 9ca1c6d9f2045de9cefa5c4332b5aa620d60d144 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Date: Thu, 2 Mar 2023 10:01:41 +0100
Subject: drm/xe/tests: Grab a memory access reference around the migrate
 sanity test
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Git-commit: 907a319c8c8e125224b088f91f468f549f1e1da7
Patch-mainline: v6.8-rc1
References: drm-backport-placeholder

It appears we don't hold a memory access reference for the accesses in
this test, which may results in printed warnings and possibly the GT
not woken up for the memory accesses.

Add a memory access reference around the test.

Signed-off-by: Thomas Hellstr√∂m <thomas.hellstrom@linux.intel.com>
Reviewed-by: Matthew Auld <matthew.auld@intel.com>
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
Acked-by: Patrik Jakobsson <pjakobsson@suse.de>
---
 drivers/gpu/drm/xe/tests/xe_migrate.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/gpu/drm/xe/tests/xe_migrate.c b/drivers/gpu/drm/xe/tests/xe_migrate.c
index 0de17e90aba9..b7e4a126e8b7 100644
--- a/drivers/gpu/drm/xe/tests/xe_migrate.c
+++ b/drivers/gpu/drm/xe/tests/xe_migrate.c
@@ -366,7 +366,9 @@ static int migrate_test_run_device(struct xe_device *xe)
 
 		kunit_info(test, "Testing gt id %d.\n", id);
 		xe_vm_lock(m->eng->vm, &ww, 0, true);
+		xe_device_mem_access_get(xe);
 		xe_migrate_sanity_test(m, test);
+		xe_device_mem_access_put(xe);
 		xe_vm_unlock(m->eng->vm, &ww);
 	}
 
-- 
2.46.1

