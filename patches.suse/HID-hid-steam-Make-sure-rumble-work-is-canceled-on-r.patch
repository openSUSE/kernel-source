From cc4f952427aaa44ecfd92542e10a65cce67bd6f4 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Wed, 25 Dec 2024 18:34:24 -0800
Subject: [PATCH] HID: hid-steam: Make sure rumble work is canceled on removal
Git-commit: cc4f952427aaa44ecfd92542e10a65cce67bd6f4
Patch-mainline: v6.14-rc1
References: stable-fixes

When a force feedback command is sent from userspace, work is scheduled to pass
this data to the controller without blocking userspace itself. However, in
theory, this work might not be properly canceled if the controller is removed
at the exact right time. This patch ensures the work is properly canceled when
the device is removed.

Signed-off-by: Vicki Pfau <vi@endrift.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/hid/hid-steam.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/hid/hid-steam.c
+++ b/drivers/hid/hid-steam.c
@@ -1304,6 +1304,7 @@ static void steam_remove(struct hid_devi
 
 	cancel_delayed_work_sync(&steam->mode_switch);
 	cancel_work_sync(&steam->work_connect);
+	cancel_work_sync(&steam->rumble_work);
 	hid_destroy_device(steam->client_hdev);
 	steam->client_hdev = NULL;
 	steam->client_opened = false;
