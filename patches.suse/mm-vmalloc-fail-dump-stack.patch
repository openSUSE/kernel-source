From: Nick Piggin <npiggin@suse.de>
Subject: mm: improve vmalloc reporting
Patch-upstream: no (could be merged)
References: bnc#511079

Add a dump_stack and some information about allocation size when vmalloc
fails.

Signed-off-by: Nick Piggin <npiggin@suse.de>
---
 mm/vmalloc.c |    9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

Index: linux-2.6.27/mm/vmalloc.c
===================================================================
--- linux-2.6.27.orig/mm/vmalloc.c
+++ linux-2.6.27/mm/vmalloc.c
@@ -398,10 +398,13 @@ overflow:
 			purged = 1;
 			goto retry;
 		}
-		if (printk_ratelimit())
+		if (printk_ratelimit()) {
 			printk(KERN_WARNING
-				"vmap allocation for size %lu failed: "
-				"use vmalloc=<size> to increase size.\n", size);
+				"vmap allocation failed - "
+				"use vmalloc=<size> to increase size.\n");
+			printk(KERN_WARNING "vmalloc size=%lx start=%lx end=%lx node=%d gfp=%lx\n", size, vstart, vend, node, (unsigned long)gfp_mask);
+			dump_stack();
+		}
 		kfree(va);
 		return ERR_PTR(-EBUSY);
 	}
