From: Dan Carpenter <dan.carpenter@linaro.org>
Date: Tue, 23 Sep 2025 14:19:11 +0300
Subject: octeontx2-pf: Fix potential use after free in otx2_tc_add_flow()
Git-commit: d9c70e93ec5988ab07ad2a92d9f9d12867f02c56
References: CVE-2025-39978 bsc#1252069
Patch-mainline: v6.17

This code calls kfree_rcu(new_node, rcu) and then dereferences "new_node"
and then dereferences it on the next line.  Two lines later, we take
a mutex so I don't think this is an RCU safe region.  Re-order it to do
the dereferences before queuing up the free.

[jaeckel: backported to cve/linux-5.14-LTSS]

Fixes: 68fbff68dbea ("octeontx2-pf: Add police action for TC flower")
Signed-off-by: Dan Carpenter <dan.carpenter@linaro.org>
Reviewed-by: Vadim Fedorenko <vadim.fedorenko@linux.dev>
Link: https://patch.msgid.link/aNKCL1jKwK8GRJHh@stanley.mountain
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Steffen Jaeckel <sjaeckel@suse.de>

---
 drivers/net/ethernet/marvell/octeontx2/nic/otx2_tc.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/marvell/octeontx2/nic/otx2_tc.c b/drivers/net/ethernet/marvell/octeontx2/nic/otx2_tc.c
index 7e6f4c6ed1354..020ea1a273a71 100644
--- a/drivers/net/ethernet/marvell/octeontx2/nic/otx2_tc.c
+++ b/drivers/net/ethernet/marvell/octeontx2/nic/otx2_tc.c
@@ -789,7 +789,6 @@ static int otx2_tc_add_flow(struct otx2_nic *nic,
 	if (rc) {
 		NL_SET_ERR_MSG_MOD(extack, "Failed to install MCAM flow entry");
 		mutex_unlock(&nic->mbox.lock);
-		kfree_rcu(new_node, rcu);
 		goto free_leaf;
 	}
 	mutex_unlock(&nic->mbox.lock);
@@ -799,7 +798,6 @@ static int otx2_tc_add_flow(struct otx2_nic *nic,
 				    nic->tc_info.flow_ht_params);
 	if (rc) {
 		otx2_del_mcam_flow_entry(nic, req->entry);
-		kfree_rcu(new_node, rcu);
 		goto free_leaf;
 	}
 
@@ -828,6 +826,7 @@ static int otx2_tc_add_flow(struct otx2_nic *nic,
 
 		mutex_unlock(&nic->mbox.lock);
 	}
+	kfree_rcu(new_node, rcu);
 
 	return rc;
 }
-- 
2.50.1

