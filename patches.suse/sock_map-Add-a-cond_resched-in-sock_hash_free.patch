From: Eric Dumazet <edumazet@google.com>
Date: Fri, 6 Sep 2024 15:44:49 +0000
Subject: [PATCH] sock_map: Add a cond_resched() in sock_hash_free()
Git-commit: b1339be951ad31947ae19bc25cb08769bf255100
Patch-mainline: v6.12-rc1
References: CVE-2024-47710 bsc#1232049

Several syzbot soft lockup reports all have in common sock_hash_free()

If a map with a large number of buckets is destroyed, we need to yield
the cpu when needed.

Fixes: 75e68e5bf2c7 ("bpf, sockhash: Synchronize delete from bucket list on map free")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Martin KaFai Lau <martin.lau@kernel.org>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: https://lore.kernel.org/bpf/20240906154449.3742932-1-edumazet@google.com
Signed-off-by: David Sterba <dsterba@suse.com>
---
 net/core/sock_map.c |    1 +
 1 file changed, 1 insertion(+)

--- a/net/core/sock_map.c
+++ b/net/core/sock_map.c
@@ -1169,6 +1169,7 @@ static void sock_hash_free(struct bpf_ma
 			sock_put(elem->sk);
 			sock_hash_free_elem(htab, elem);
 		}
+		cond_resched();
 	}
 
 	/* wait for psock readers accessing its map link */
