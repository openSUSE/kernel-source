From: "D. Wythe" <alibuda@linux.alibaba.com>
Date: Fri, 7 Nov 2025 11:56:30 +0800
Subject: bpf: Export necessary symbols for modules with struct_ops
Git-commit: 07c428ece3222832bdbfcc4ffa8b8d3991c5eb39
References: jsc#PED-14951
Patch-mainline: v6.19-rc1

Exports three necessary symbols for implementing struct_ops with
tristate subsystem.

To hold or release refcnt of struct_ops refcnt by inline funcs
bpf_try_module_get and bpf_module_put which use bpf_struct_ops_get(put)
conditionally.

And to copy obj name from one to the other with effective checks by
bpf_obj_name_cpy.

Signed-off-by: D. Wythe <alibuda@linux.alibaba.com>
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Link: https://patch.msgid.link/20251107035632.115950-2-alibuda@linux.alibaba.com

Acked-by: Steffen Jaeckel <sjaeckel@suse.de>

---
 kernel/bpf/bpf_struct_ops.c |    2 ++
 kernel/bpf/syscall.c        |    1 +
 2 files changed, 3 insertions(+)

--- a/kernel/bpf/bpf_struct_ops.c
+++ b/kernel/bpf/bpf_struct_ops.c
@@ -1141,6 +1141,7 @@ bool bpf_struct_ops_get(const void *kdat
 	map = __bpf_map_inc_not_zero(&st_map->map, false);
 	return !IS_ERR(map);
 }
+EXPORT_SYMBOL_GPL(bpf_struct_ops_get);
 
 void bpf_struct_ops_put(const void *kdata)
 {
@@ -1152,6 +1153,7 @@ void bpf_struct_ops_put(const void *kdat
 
 	bpf_map_put(&st_map->map);
 }
+EXPORT_SYMBOL_GPL(bpf_struct_ops_put);
 
 int bpf_struct_ops_supported(const struct bpf_struct_ops *st_ops, u32 moff)
 {
--- a/kernel/bpf/syscall.c
+++ b/kernel/bpf/syscall.c
@@ -1081,6 +1081,7 @@ int bpf_obj_name_cpy(char *dst, const ch
 
 	return src - orig_src;
 }
+EXPORT_SYMBOL_GPL(bpf_obj_name_cpy);
 
 int map_check_no_btf(const struct bpf_map *map,
 		     const struct btf *btf,
