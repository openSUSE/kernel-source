From: Janosch Frank <frankja@linux.ibm.com>
Date: Tue, 20 Oct 2020 06:12:07 -0400
Subject: KVM: s390: pv: Mark mm as protected after the set secure parameters
 and improve cleanup
Git-commit: 1ed576a20cd5c93295f57d6b7400357bd8d01b21
Patch-mainline: v5.10-rc6
References: jsc#SLE-7512 bsc#1165545

We can only have protected guest pages after a successful set secure
parameters call as only then the UV allows imports and unpacks.

By moving the test we can now also check for it in s390_reset_acc()
and do an early return if it is 0.

Signed-off-by: Janosch Frank <frankja@linux.ibm.com>
Fixes: 29b40f105ec8 ("KVM: s390: protvirt: Add initial vm and cpu lifecycle handling")
Reviewed-by: Cornelia Huck <cohuck@redhat.com>
Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 arch/s390/kvm/kvm-s390.c |    2 +-
 arch/s390/kvm/pv.c       |    3 ++-
 arch/s390/mm/gmap.c      |    3 +++
 3 files changed, 6 insertions(+), 2 deletions(-)

--- a/arch/s390/kvm/kvm-s390.c
+++ b/arch/s390/kvm/kvm-s390.c
@@ -2311,7 +2311,7 @@ static int kvm_s390_handle_pv(struct kvm
 		struct kvm_s390_pv_unp unp = {};
 
 		r = -EINVAL;
-		if (!kvm_s390_pv_is_protected(kvm))
+		if (!kvm_s390_pv_is_protected(kvm) || !mm_is_protected(kvm->mm))
 			break;
 
 		r = -EFAULT;
--- a/arch/s390/kvm/pv.c
+++ b/arch/s390/kvm/pv.c
@@ -209,7 +209,6 @@ int kvm_s390_pv_init_vm(struct kvm *kvm,
 		return -EIO;
 	}
 	kvm->arch.gmap->guest_handle = uvcb.guest_handle;
-	atomic_set(&kvm->mm->context.is_protected, 1);
 	return 0;
 }
 
@@ -229,6 +228,8 @@ int kvm_s390_pv_set_sec_parms(struct kvm
 	*rrc = uvcb.header.rrc;
 	KVM_UV_EVENT(kvm, 3, "PROTVIRT VM SET PARMS: rc %x rrc %x",
 		     *rc, *rrc);
+	if (!cc)
+		atomic_set(&kvm->mm->context.is_protected, 1);
 	return cc ? -EINVAL : 0;
 }
 
--- a/arch/s390/mm/gmap.c
+++ b/arch/s390/mm/gmap.c
@@ -2677,6 +2677,9 @@ static int __s390_reset_acc(pte_t *ptep,
 void s390_reset_acc(struct mm_struct *mm)
 {
 	struct mm_walk walk = { .pte_entry = __s390_reset_acc };
+
+	if (!mm_is_protected(mm))
+		return;
 	/*
 	 * we might be called during
 	 * reset:                             we walk the pages and clear
