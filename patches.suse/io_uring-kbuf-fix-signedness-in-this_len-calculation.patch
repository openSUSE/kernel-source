From c64eff368ac676e8540344d27a3de47e0ad90d21 Mon Sep 17 00:00:00 2001
From: Qingyue Zhang <chunzhennn@qq.com>
Date: Wed, 27 Aug 2025 19:43:39 +0800
Subject: [PATCH] io_uring/kbuf: fix signedness in this_len calculation
Git-commit: c64eff368ac676e8540344d27a3de47e0ad90d21
Patch-mainline: v6.17-rc4
References: CVE-2025-39822 bsc#1250034

When importing and using buffers, buf->len is considered unsigned.
However, buf->len is converted to signed int when committing. This can
lead to unexpected behavior if the buffer is large enough to be
interpreted as a negative value. Make min_t calculation unsigned.

Fixes: ae98dbf43d75 ("io_uring/kbuf: add support for incremental buffer consumption")
Co-developed-by: Suoxing Zhang <aftern00n@qq.com>
Signed-off-by: Suoxing Zhang <aftern00n@qq.com>
Signed-off-by: Qingyue Zhang <chunzhennn@qq.com>
Link: https://lore.kernel.org/r/tencent_4DBB3674C0419BEC2C0C525949DA410CA307@qq.com
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Gabriel Krisman Bertazi <krisman@suse.de>
---
 io_uring/kbuf.h |    7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

--- a/io_uring/kbuf.h
+++ b/io_uring/kbuf.h
@@ -140,13 +140,14 @@ static inline bool io_kbuf_commit(struct
 
 	if (bl->flags & IOBL_INC) {
 		struct io_uring_buf *buf;
+		u32 this_len = len;
 
 		buf = io_ring_head_to_buf(bl->buf_ring, bl->head, bl->mask);
 		if (WARN_ON_ONCE(len > buf->len))
-			len = buf->len;
-		buf->len -= len;
+			this_len = buf->len;
+		buf->len -= this_len;
 		if (buf->len) {
-			buf->addr += len;
+			buf->addr += this_len;
 			return false;
 		}
 	}
