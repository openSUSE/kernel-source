From 5030abcb0aa3304bf91497844ffa9607a2d4ad5d Mon Sep 17 00:00:00 2001
From: Charles Keepax <ckeepax@opensource.cirrus.com>
Date: Fri, 11 Jul 2025 11:06:16 +0100
Subject: [PATCH] ASoC: SDCA: Pull HID and IRQ into the primary SDCA module
Git-commit: 5030abcb0aa3304bf91497844ffa9607a2d4ad5d
Patch-mainline: v6.17-rc1
References: jsc#PED-14430 jsc#PED-14297 jsc#PED-14024

If the HID or the IRQ are selected as options they will always require
loading alongside the main SDCA module. Since it will never be possible
to run without them the value of keeping them as separate modules is
fairly limited. Pull them into the main SDCA module to simplify things
still further.

Signed-off-by: Charles Keepax <ckeepax@opensource.cirrus.com>
Reviewed-by: Arnd Bergmann <arnd@arndb.de>
Link: https://patch.msgid.link/20250711100616.296329-3-ckeepax@opensource.cirrus.com
Signed-off-by: Mark Brown <broonie@kernel.org>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 sound/soc/sdca/Makefile          | 10 ++--------
 sound/soc/sdca/sdca_functions.c  |  1 -
 sound/soc/sdca/sdca_hid.c        |  2 +-
 sound/soc/sdca/sdca_interrupts.c |  8 ++++----
 4 files changed, 7 insertions(+), 14 deletions(-)

diff --git a/sound/soc/sdca/Makefile b/sound/soc/sdca/Makefile
index 58a8f3ef3feb..5e51760cb651 100644
--- a/sound/soc/sdca/Makefile
+++ b/sound/soc/sdca/Makefile
@@ -1,13 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 
 snd-soc-sdca-y := sdca_functions.o sdca_device.o sdca_regmap.o sdca_asoc.o
-snd-soc-sdca-hid-y := sdca_hid.o
-snd-soc-sdca-irq-y := sdca_interrupts.o
+snd-soc-sdca-$(CONFIG_SND_SOC_SDCA_HID) += sdca_hid.o
+snd-soc-sdca-$(CONFIG_SND_SOC_SDCA_IRQ) += sdca_interrupts.o
 
 obj-$(CONFIG_SND_SOC_SDCA) += snd-soc-sdca.o
-ifdef CONFIG_SND_SOC_SDCA_HID
-obj-$(CONFIG_SND_SOC_SDCA) += snd-soc-sdca-hid.o
-endif
-ifdef CONFIG_SND_SOC_SDCA_IRQ
-obj-$(CONFIG_SND_SOC_SDCA) += snd-soc-sdca-irq.o
-endif
diff --git a/sound/soc/sdca/sdca_functions.c b/sound/soc/sdca/sdca_functions.c
index c34f3bf62983..be09b7a34102 100644
--- a/sound/soc/sdca/sdca_functions.c
+++ b/sound/soc/sdca/sdca_functions.c
@@ -1943,4 +1943,3 @@ EXPORT_SYMBOL_NS(sdca_parse_function, SND_SOC_SDCA);
 
 MODULE_LICENSE("Dual BSD/GPL");
 MODULE_DESCRIPTION("SDCA library");
-MODULE_IMPORT_NS(SND_SOC_SDCA_HID);
diff --git a/sound/soc/sdca/sdca_hid.c b/sound/soc/sdca/sdca_hid.c
index b227ad94d08f..2224ade59aff 100644
--- a/sound/soc/sdca/sdca_hid.c
+++ b/sound/soc/sdca/sdca_hid.c
@@ -121,7 +121,7 @@ int sdca_add_hid_device(struct device *dev, struct sdca_entity *entity)
 
 	return 0;
 }
-EXPORT_SYMBOL_NS(sdca_add_hid_device, SND_SOC_SDCA_HID);
+EXPORT_SYMBOL_NS(sdca_add_hid_device, SND_SOC_SDCA);
 
 MODULE_LICENSE("Dual BSD/GPL");
 MODULE_DESCRIPTION("SDCA HID library");
diff --git a/sound/soc/sdca/sdca_interrupts.c b/sound/soc/sdca/sdca_interrupts.c
index edb045c7ebb0..2f85fcc6e544 100644
--- a/sound/soc/sdca/sdca_interrupts.c
+++ b/sound/soc/sdca/sdca_interrupts.c
@@ -279,7 +279,7 @@ int sdca_irq_request(struct device *dev, struct sdca_interrupt_info *info,
 
 	return 0;
 }
-EXPORT_SYMBOL_NS_GPL(sdca_irq_request, SND_SOC_SDCA_IRQ);
+EXPORT_SYMBOL_NS_GPL(sdca_irq_request, SND_SOC_SDCA);
 
 /**
  * sdca_irq_data_populate - Populate common interrupt data
@@ -313,7 +313,7 @@ int sdca_irq_data_populate(struct snd_soc_component *component,
 
 	return 0;
 }
-EXPORT_SYMBOL_NS_GPL(sdca_irq_data_populate, SND_SOC_SDCA_IRQ);
+EXPORT_SYMBOL_NS_GPL(sdca_irq_data_populate, SND_SOC_SDCA);
 
 /**
  * sdca_irq_populate - Request all the individual IRQs for an SDCA Function
@@ -393,7 +393,7 @@ int sdca_irq_populate(struct sdca_function_data *function,
 
 	return 0;
 }
-EXPORT_SYMBOL_NS_GPL(sdca_irq_populate, SND_SOC_SDCA_IRQ);
+EXPORT_SYMBOL_NS_GPL(sdca_irq_populate, SND_SOC_SDCA);
 
 /**
  * sdca_irq_allocate - allocate an SDCA interrupt structure for a device
@@ -433,7 +433,7 @@ struct sdca_interrupt_info *sdca_irq_allocate(struct device *dev,
 
 	return info;
 }
-EXPORT_SYMBOL_NS_GPL(sdca_irq_allocate, SND_SOC_SDCA_IRQ);
+EXPORT_SYMBOL_NS_GPL(sdca_irq_allocate, SND_SOC_SDCA);
 
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("SDCA IRQ library");
-- 
2.52.0

