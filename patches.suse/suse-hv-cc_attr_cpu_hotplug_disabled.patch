From: Dexuan Cui <decui@microsoft.com>
Date: Thu, 14 Sep 2023 05:06:46 +0000
Subject: x86/coco: Allow CPU online/offline for a TDX VM with the paravisor on Hyper-V
Patch-mainline: Never, wip
References: bsc#1206453

Hyper-V provides two modes for running Intel TDX VMs:

1) TD Partitioning mode with a paravisor.
2) In "fully enlightened" mode with normal TDX shared bit control
   over page encryption, and no paravisor.

For 1), Hyper-V is able to support CPU online/offline for the VM, so
allow it.

Signed-off-by: Dexuan Cui <decui@microsoft.com>
Acked-by: Olaf Hering <ohering@suse.de>
---
 arch/x86/coco/core.c        | 6 +++++-
 arch/x86/hyperv/ivm.c       | 1 +
 arch/x86/include/asm/coco.h | 1 +
 3 files changed, 7 insertions(+), 1 deletion(-)

--- a/arch/x86/coco/core.c
+++ b/arch/x86/coco/core.c
@@ -14,16 +14,20 @@
 #include <asm/processor.h>
 
 enum cc_vendor cc_vendor __ro_after_init;
+bool cc_attr_cpu_hotplug_disabled __ro_after_init = true;
 static u64 cc_mask __ro_after_init;
 
 static bool intel_cc_platform_has(enum cc_attr attr)
 {
 	switch (attr) {
 	case CC_ATTR_GUEST_UNROLL_STRING_IO:
-	case CC_ATTR_HOTPLUG_DISABLED:
 	case CC_ATTR_GUEST_MEM_ENCRYPT:
 	case CC_ATTR_MEM_ENCRYPT:
 		return true;
+
+	case CC_ATTR_HOTPLUG_DISABLED:
+		return cc_attr_cpu_hotplug_disabled;
+
 	default:
 		return false;
 	}
--- a/arch/x86/hyperv/ivm.c
+++ b/arch/x86/hyperv/ivm.c
@@ -597,6 +597,7 @@ void __init hv_vtom_init(void)
 
 	case HV_ISOLATION_TYPE_TDX:
 		cc_set_vendor(CC_VENDOR_INTEL);
+		cc_attr_cpu_hotplug_disabled = false;
 		break;
 
 	default:
--- a/arch/x86/include/asm/coco.h
+++ b/arch/x86/include/asm/coco.h
@@ -27,6 +27,7 @@ static inline void cc_set_vendor(enum cc_vendor vendor)
 void cc_set_mask(u64 mask);
 u64 cc_mkenc(u64 val);
 u64 cc_mkdec(u64 val);
+extern bool cc_attr_cpu_hotplug_disabled;
 #else
 static inline enum cc_vendor cc_get_vendor(void)
 {
