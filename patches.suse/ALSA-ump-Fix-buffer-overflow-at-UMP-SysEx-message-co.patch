From 56f1f30e6795b890463d9b20b11e576adf5a2f77 Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Tue, 29 Apr 2025 14:48:41 +0200
Subject: [PATCH] ALSA: ump: Fix buffer overflow at UMP SysEx message conversion
Git-commit: 56f1f30e6795b890463d9b20b11e576adf5a2f77
Patch-mainline: v6.15-rc5
References: bsc#1242044 CVE-2025-37891 bsc#1243589

[ backport note: due to kABI compatibility, we can't extend struct
  ump_cvt_to_ump, hence reduce the number of processed sysex bytes
  from 6 to 4 to fit with the existing buffer size, instead -- tiwai ]

The conversion function from MIDI 1.0 to UMP packet contains an
internal buffer to keep the incoming MIDI bytes, and its size is 4, as
it was supposed to be the max size for a MIDI1 UMP packet data.
However, the implementation overlooked that SysEx is handled in a
different format, and it can be up to 6 bytes, as found in
do_convert_to_ump().  It leads eventually to a buffer overflow, and
may corrupt the memory when a longer SysEx message is received.

The fix is simply to extend the buffer size to 6 to fit with the SysEx
UMP message.

Fixes: 0b5288f5fe63 ("ALSA: ump: Add legacy raw MIDI support")
Reported-by: Argusee <vr@darknavy.com>
Link: https://patch.msgid.link/20250429124845.25128-1-tiwai@suse.de
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/core/ump_convert.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/sound/core/ump_convert.c
+++ b/sound/core/ump_convert.c
@@ -493,7 +493,7 @@ static int do_convert_to_ump(struct ump_
 
 	if (cvt->in_sysex) {
 		cvt->buf[cvt->len++] = c;
-		if (cvt->len == 6)
+		if (cvt->len == 4) // FIXME: reduced to 4 for kABI compatibility
 			return cvt_legacy_sysex_to_ump(cvt, group, data, false);
 		return 0;
 	}
