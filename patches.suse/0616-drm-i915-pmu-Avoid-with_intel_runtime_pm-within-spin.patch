From ea1412caa511883fe15031cc9e26d4377ecc7ac9 Mon Sep 17 00:00:00 2001
From: Umesh Nerlige Ramappa <umesh.nerlige.ramappa@intel.com>
Date: Fri, 19 Nov 2021 17:42:01 -0800
Subject: drm/i915/pmu: Avoid with_intel_runtime_pm within spinlock
Git-commit: 865fbc0f8dc21e17dc3ad9f0f1ebf00a6696b2ca
Patch-mainline: v5.17-rc1
References: jsc#PED-1166 jsc#PED-1168 jsc#PED-1170 jsc#PED-1218 jsc#PED-1220 jsc#PED-1222 jsc#PED-1223 jsc#PED-1225

When guc timestamp ping worker runs it takes the spinlock and calls
with_intel_runtime_pm.  Since with_intel_runtime_pm may sleep, move the
spinlock inside __update_guc_busyness_stats.

Signed-off-by: Umesh Nerlige Ramappa <umesh.nerlige.ramappa@intel.com>
Reviewed-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20211120014201.26480-1-umesh.nerlige.ramappa@intel.com
Acked-by: Patrik Jakobsson <pjakobsson@suse.de>
---
 drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c | 12 +++---------
 1 file changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c b/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
index 543f4b80f207..ee5a1b82db88 100644
--- a/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
+++ b/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
@@ -1251,12 +1251,15 @@ static void __update_guc_busyness_stats(struct intel_guc *guc)
 	struct intel_gt *gt = guc_to_gt(guc);
 	struct intel_engine_cs *engine;
 	enum intel_engine_id id;
+	unsigned long flags;
 	ktime_t unused;
 
+	spin_lock_irqsave(&guc->timestamp.lock, flags);
 	for_each_engine(engine, gt, id) {
 		guc_update_pm_timestamp(guc, engine, &unused);
 		guc_update_engine_gt_clks(engine);
 	}
+	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
 }
 
 static void guc_timestamp_ping(struct work_struct *wrk)
@@ -1266,7 +1269,6 @@ static void guc_timestamp_ping(struct work_struct *wrk)
 	struct intel_uc *uc = container_of(guc, typeof(*uc), guc);
 	struct intel_gt *gt = guc_to_gt(guc);
 	intel_wakeref_t wakeref;
-	unsigned long flags;
 	int srcu, ret;
 
 	/*
@@ -1277,13 +1279,9 @@ static void guc_timestamp_ping(struct work_struct *wrk)
 	if (ret)
 		return;
 
-	spin_lock_irqsave(&guc->timestamp.lock, flags);
-
 	with_intel_runtime_pm(&gt->i915->runtime_pm, wakeref)
 		__update_guc_busyness_stats(guc);
 
-	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
-
 	intel_gt_reset_unlock(gt, srcu);
 
 	mod_delayed_work(system_highpri_wq, &guc->timestamp.work,
@@ -1322,16 +1320,12 @@ static void guc_init_engine_stats(struct intel_guc *guc)
 void intel_guc_busyness_park(struct intel_gt *gt)
 {
 	struct intel_guc *guc = &gt->uc.guc;
-	unsigned long flags;
 
 	if (!guc_submission_initialized(guc))
 		return;
 
 	cancel_delayed_work(&guc->timestamp.work);
-
-	spin_lock_irqsave(&guc->timestamp.lock, flags);
 	__update_guc_busyness_stats(guc);
-	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
 }
 
 void intel_guc_busyness_unpark(struct intel_gt *gt)
-- 
2.38.1

