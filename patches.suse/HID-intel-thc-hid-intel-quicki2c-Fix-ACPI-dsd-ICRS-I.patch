From 1db9df89a213318a48d958385dc1b17b379dc32b Mon Sep 17 00:00:00 2001
From: Aaron Ma <aaron.ma@canonical.com>
Date: Sun, 3 Aug 2025 14:57:25 +0800
Subject: [PATCH] HID: intel-thc-hid: intel-quicki2c: Fix ACPI dsd ICRS/ISUB length
Git-commit: 1db9df89a213318a48d958385dc1b17b379dc32b
Patch-mainline: v6.17-rc4
References: jsc#PED-14033

The QuickI2C ACPI _DSD methods return ICRS and ISUB data with a
trailing byte, making the actual length is one more byte than the
structs defined.

It caused stack-out-of-bounds and kernel crash:

Kernel: BUG: KASAN: stack-out-of-bounds in quicki2c_acpi_get_dsd_property.constprop.0+0x111/0x1b0 [intel_quicki2c]
Kernel: Write of size 12 at addr ffff888106d1f900 by task kworker/u33:2/75
Kernel: 
Kernel: CPU: 3 UID: 0 PID: 75 Comm: kworker/u33:2 Not tainted 6.16.0+ #3 PREEMPT(voluntary)
Kernel: Workqueue: async async_run_entry_fn
Kernel: Call Trace:
Kernel: <TASK>
Kernel: dump_stack_lvl+0x76/0xa0
Kernel: print_report+0xd1/0x660
Kernel: ? __pfx__raw_spin_lock_irqsave+0x10/0x10
Kernel: ? __kasan_slab_free+0x5d/0x80
Kernel: ? kasan_addr_to_slab+0xd/0xb0
Kernel: kasan_report+0xe1/0x120
Kernel: ? quicki2c_acpi_get_dsd_property.constprop.0+0x111/0x1b0 [intel_quicki2c]
Kernel: kasan_check_range+0x11c/0x200
Kernel: __asan_memcpy+0x3b/0x80
Kernel: quicki2c_acpi_get_dsd_property.constprop.0+0x111/0x1b0 [intel_quicki2c]
Kernel: ? __pfx_quicki2c_acpi_get_dsd_property.constprop.0+0x10/0x10 [intel_quicki2c]
Kernel: quicki2c_get_acpi_resources+0x237/0x730 [intel_quicki2c]
[...]
Kernel: </TASK>
Kernel: The buggy address belongs to stack of task kworker/u33:2/75
Kernel: and is located at offset 48 in frame:
Kernel: quicki2c_get_acpi_resources+0x0/0x730 [intel_quicki2c]
Kernel: This frame has 3 objects:
Kernel: [32, 36) 'hid_desc_addr'
Kernel: [48, 59) 'i2c_param'
Kernel: [80, 224) 'i2c_config'

ACPI DSD methods return:

\_SB.PC00.THC0.ICRS Buffer       000000003fdc947b 001 Len 0C = 0A 00 80 1A 06 00 00 00 00 00 00 00
\_SB.PC00.THC0.ISUB Buffer       00000000f2fcbdc4 001 Len 91 = 00 00 00 00 00 00 00 00 00 00 00 00

Adding reserved padding to quicki2c_subip_acpi_parameter/config.

Fixes: 5282e45ccbfa9 ("HID: intel-thc-hid: intel-quicki2c: Add THC QuickI2C ACPI interfaces")
Signed-off-by: Aaron Ma <aaron.ma@canonical.com>
Reviewed-by: Even Xu <even.xu@intel.com>
Tested-by: Even Xu <even.xu@intel.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/hid/intel-thc-hid/intel-quicki2c/quicki2c-dev.h | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/hid/intel-thc-hid/intel-quicki2c/quicki2c-dev.h b/drivers/hid/intel-thc-hid/intel-quicki2c/quicki2c-dev.h
index 93d6fa982d60..d412eafcf9ea 100644
--- a/drivers/hid/intel-thc-hid/intel-quicki2c/quicki2c-dev.h
+++ b/drivers/hid/intel-thc-hid/intel-quicki2c/quicki2c-dev.h
@@ -77,6 +77,7 @@ struct quicki2c_subip_acpi_parameter {
 	u16 device_address;
 	u64 connection_speed;
 	u8 addressing_mode;
+	u8 reserved;
 } __packed;
 
 /**
@@ -126,6 +127,7 @@ struct quicki2c_subip_acpi_config {
 	u64 HMTD;
 	u64 HMRD;
 	u64 HMSL;
+	u8 reserved;
 };
 
 /**
-- 
2.51.1

