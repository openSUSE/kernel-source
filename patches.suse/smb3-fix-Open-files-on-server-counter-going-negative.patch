From: Steve French <stfrench@microsoft.com>
Date: Sat, 6 Apr 2024 23:16:08 -0500
Subject: [PATCH] smb3: fix Open files on server counter going negative
Git-commit: 28e0947651ce6a2200b9a7eceb93282e97d7e51a
References: git-fixes
Patch-mainline: v6.9-rc4

[ ematsumiya: replace fs/smb/client path with fs/cifs, add 'rc' variable ]

We were decrementing the count of open files on server twice
for the case where we were closing cached directories.

Fixes: 8e843bf38f7b ("cifs: return a single-use cfid if we did not get a lease")
Cc: stable@vger.kernel.org
Acked-by: Bharath SM <bharathsm@microsoft.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Acked-by: Enzo Matsumiya <ematsumiya@suse.de>
---
 fs/cifs/smb2ops.c |    9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

--- a/fs/cifs/smb2ops.c
+++ b/fs/cifs/smb2ops.c
@@ -704,10 +704,13 @@
 					       refcount);
 
 	if (cfid->is_valid) {
+		int rc;
+
 		cifs_dbg(FYI, "clear cached root file handle\n");
-		SMB2_close(0, cfid->tcon, cfid->fid->persistent_fid,
-			   cfid->fid->volatile_fid);
-		atomic_dec(&cfid->tcon->num_remote_opens);
+		rc = SMB2_close(0, cfid->tcon, cfid->fid->persistent_fid,
+				cfid->fid->volatile_fid);
+		if (rc) /* should we retry on -EBUSY or -EAGAIN? */
+			cifs_dbg(VFS, "close cached dir rc %d\n", rc);
 	}
 
 	/*
