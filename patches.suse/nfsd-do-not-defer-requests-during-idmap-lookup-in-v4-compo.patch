From: Anthony Iliopoulos <ailiop@suse.com>
Date: Mon, 4 Aug 2025 00:15:19 +0200
Subject: nfsd: do not defer requests during idmap lookup in v4 compound decode
Patch-mainline: Not yet, to be submitted
References: bsc#1232223

During v4 compound decoding RQ_USEDEFERRAL is set by default. Some ops
(e.g. SETATTR) can trigger idmapping lookups that are performed via
upcalls to idmapd when the mapping is not already cached. If the idmapd
response is delayed beyond the allowed time limit, cache_check() will
call svc_defer(), which sets RQ_DROPME.

When the RQ_DROPME is set the request will be skipped by nfsd_dispatch()
and nfs4svc_encode_compoundres() will not run, so no reply will be sent.
Further nfsd4_sequence_done will not be called, and cl_rpc_users will
remain elevated and cause later requests to encounter check_slot_seqid()
errors (client reusing a slot) and receive NFS4ERR_DELAY responses from
the SEQUENCE op.

Fix this by making sure that RQ_USEDEFERRAL is always unset during
nfs4svc_decode_compoundargs(), since no v4 request should ever be
defered, and thus allow clients to retry.

Fixes: 2f425878b6a7 ("nfsd: don't use the deferral service, return NFS4ERR_DELAY")
Signed-off-by: Anthony Iliopoulos <ailiop@suse.com>
---
 fs/nfsd/nfs4xdr.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/fs/nfsd/nfs4xdr.c b/fs/nfsd/nfs4xdr.c
index ea82eb1c8796..380275420ee2 100644
--- a/fs/nfsd/nfs4xdr.c
+++ b/fs/nfsd/nfs4xdr.c
@@ -5482,6 +5482,7 @@ bool
 nfs4svc_decode_compoundargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)
 {
 	struct nfsd4_compoundargs *args = rqstp->rq_argp;
+	bool ret = false;
 
 	/* svcxdr_tmp_alloc */
 	args->to_free = NULL;
@@ -5490,7 +5491,11 @@ nfs4svc_decode_compoundargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)
 	args->ops = args->iops;
 	args->rqstp = rqstp;
 
-	return nfsd4_decode_compound(args);
+	clear_bit(RQ_USEDEFERRAL, &rqstp->rq_flags);
+	ret = nfsd4_decode_compound(args);
+	set_bit(RQ_USEDEFERRAL, &rqstp->rq_flags);
+
+	return ret;
 }
 
 bool

