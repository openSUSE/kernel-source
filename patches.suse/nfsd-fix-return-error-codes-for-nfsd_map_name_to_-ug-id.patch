From: Anthony Iliopoulos <ailiop@suse.com>
Date: Wed, 26 Nov 2025 18:09:45 +0100
Subject: nfsd: fix return error codes for nfsd_map_name_to_[ug]id
Patch-mainline: Not yet, to be submitted
References: bsc#1232223

idmap lookups can time out while the cache is waiting for a userspace upcall
reply. In that case cache_check() returns -ETIMEDOUT to callers.

The nfsd_map_name_to_[ug]id functions currently proceed with attempting
to map the id despite the potential temporary failure to perform the
idmap lookup. This results in the code returning NFSERR_BADOWNER which
can cause client operations to return to userspace with failure.

Return NFSERR_JUKEBOX on idmap lookup timeout so clients will retry the
operation instead of aborting it.

Fixes: 65e10f6d0ab0 ("nfsd: Convert idmap to use kuids and kgids")
Signed-off-by: Anthony Iliopoulos <ailiop@suse.com>
---
 fs/nfsd/nfs4idmap.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/fs/nfsd/nfs4idmap.c b/fs/nfsd/nfs4idmap.c
index 8cca1329f348..e143fdaef387 100644
--- a/fs/nfsd/nfs4idmap.c
+++ b/fs/nfsd/nfs4idmap.c
@@ -654,6 +654,8 @@ nfsd_map_name_to_uid(struct svc_rqst *rqstp, const char *name, size_t namelen,
 		return nfserr_inval;
 
 	status = do_name_to_id(rqstp, IDMAP_TYPE_USER, name, namelen, &id);
+	if (status == nfserr_jukebox)
+		return status;
 	*uid = make_kuid(nfsd_user_namespace(rqstp), id);
 	if (!uid_valid(*uid))
 		status = nfserr_badowner;
@@ -671,6 +673,8 @@ nfsd_map_name_to_gid(struct svc_rqst *rqstp, const char *name, size_t namelen,
 		return nfserr_inval;
 
 	status = do_name_to_id(rqstp, IDMAP_TYPE_GROUP, name, namelen, &id);
+	if (status == nfserr_jukebox)
+		return status;
 	*gid = make_kgid(nfsd_user_namespace(rqstp), id);
 	if (!gid_valid(*gid))
 		status = nfserr_badowner;

