From: Archie Pusaka <apusaka@chromium.org>
Date: Tue, 23 Aug 2022 12:39:22 +0800
Subject: Bluetooth: hci_event: Fix checking conn for le_conn_complete_evt
Patch-mainline: v6.0-rc4
Git-commit: f48735a9aaf8258f39918e13adf464ccd7dce33b
Alt-commit: 5356266552bbaaddb8d6b4b53450e290be2cd717
References: jsc#PED-1407 bsc#1238160 CVE-2022-49138

To prevent multiple conn complete events, we shouldn't look up the
conn with hci_lookup_le_connect, since it requires the state to be
BT_CONNECT. By the time the duplicate event is processed, the state
might have changed, so we end up processing the new event anyway.

Change the lookup function to hci_conn_hash_lookup_ba.

Fixes: d5ebaa7c5f6f6 ("Bluetooth: hci_event: Ignore multiple conn complete events")
Signed-off-by: Archie Pusaka <apusaka@chromium.org>
Reviewed-by: Sonny Sasaka <sonnysasaka@chromium.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Acked-by: Chun-Yi Lee <jlee@suse.com>
---
 net/bluetooth/hci_event.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/net/bluetooth/hci_event.c
+++ b/net/bluetooth/hci_event.c
@@ -5242,7 +5242,7 @@ static void le_conn_complete_evt(struct
 	 */
 	hci_dev_clear_flag(hdev, HCI_LE_ADV);
 
-	conn = hci_lookup_le_connect(hdev);
+	conn = hci_conn_hash_lookup_ba(hdev, LE_LINK, bdaddr);
 	if (!conn) {
 		conn = hci_conn_add(hdev, LE_LINK, bdaddr, role);
 		if (!conn) {
