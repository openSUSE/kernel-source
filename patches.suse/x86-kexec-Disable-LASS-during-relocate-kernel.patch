From: Sohil Mehta <sohil.mehta@intel.com>
Date: Tue, 18 Nov 2025 10:29:07 -0800
Subject: x86/kexec: Disable LASS during relocate kernel
Git-commit: 731d43750cf8d3c67df7aabc78cc567c6d684111
Patch-mainline: v6.19-rc1
References: jsc#PED-14226

The relocate kernel mechanism uses an identity mapping to copy the new
kernel, which leads to a LASS violation when executing from a low
address.

LASS must be disabled after the original CR4 value is saved because
kexec paths that preserve context need to restore CR4.LASS. But,
disabling it along with CET during identity_mapped() is too late. So,
disable LASS immediately after saving CR4, along with PGE, and before
jumping to the identity-mapped page.

Signed-off-by: Sohil Mehta <sohil.mehta@intel.com>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Dave Hansen <dave.hansen@linux.intel.com>
Link: https://patch.msgid.link/20251118182911.2983253-6-sohil.mehta%40intel.com

Acked-by: Nikolay Borisov <nik.borisov@suse.com>
---
 arch/x86/kernel/relocate_kernel_64.S |    5 +++++
 1 file changed, 5 insertions(+)

--- a/arch/x86/kernel/relocate_kernel_64.S
+++ b/arch/x86/kernel/relocate_kernel_64.S
@@ -77,6 +77,11 @@ SYM_CODE_START_NOALIGN(relocate_kernel)
 	/* Save CR4. Required to enable the right paging mode later. */
 	movq	%rax, %r13
 
+	/* Disable LASS before jumping to the identity mapped page. */
+	movq	%r13, %r12
+	andq	$(~X86_CR4_LASS), %r12
+	movq	%r12, %cr4
+
 	/* zero out flags, and disable interrupts */
 	pushq $0
 	popfq
