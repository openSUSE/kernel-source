From 36e56b1b002bb26440403053f19f9e1a8bc075b2 Mon Sep 17 00:00:00 2001
From: Duoming Zhou <duoming@zju.edu.cn>
Date: Thu, 9 May 2024 17:37:02 +0800
Subject: [PATCH] ax25: Fix reference count leak issue of net_device
Git-commit: 36e56b1b002bb26440403053f19f9e1a8bc075b2
Patch-mainline: v6.10-rc1
References: git-fixes CVE-2024-38554 bsc#1226742

[ backport note: major change due to the missing backport of a7d6e36b9ad0
  due to kabi breakage -- tiwai ]

There is a reference count leak issue of the object "net_device" in
ax25_dev_device_down(). When the ax25 device is shutting down, the
ax25_dev_device_down() drops the reference count of net_device one
or zero times depending on if we goto unlock_put or not, which will
cause memory leak.

In order to solve the above issue, decrease the reference count of
net_device after dev->ax25_ptr is set to null.

Fixes: d01ffb9eee4a ("ax25: add refcount in ax25_dev to avoid UAF bugs")
Suggested-by: Dan Carpenter <dan.carpenter@linaro.org>
Signed-off-by: Duoming Zhou <duoming@zju.edu.cn>
Reviewed-by: Dan Carpenter <dan.carpenter@linaro.org>
Link: https://lore.kernel.org/r/7ce3b23a40d9084657ba1125432f0ecc380cbc80.1715247018.git.duoming@zju.edu.cn
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 net/ax25/ax25_dev.c |    4 ----
 1 file changed, 4 deletions(-)

--- a/net/ax25/ax25_dev.c
+++ b/net/ax25/ax25_dev.c
@@ -128,10 +128,6 @@ void ax25_dev_device_down(struct net_dev
 
 		s = s->next;
 	}
-	spin_unlock_bh(&ax25_dev_lock);
-	dev->ax25_ptr = NULL;
-	ax25_dev_put(ax25_dev);
-	return;
 
 unlock_put:
 	spin_unlock_bh(&ax25_dev_lock);
