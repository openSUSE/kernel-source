From: Shyam Prasad N <sprasad@microsoft.com>
Date: Mon, 2 Jun 2025 22:37:17 +0530
Subject: [PATCH] cifs: do not disable interface polling on failure
Git-commit: 42ca547b13a20e7cbb04fbdf8d5f089ac4bb35b7
References: git-fixes
Patch-mainline: v6.16-rc1

When a server has multichannel enabled, we keep polling the server
for interfaces periodically. However, when this query fails, we
disable the polling. This can be problematic as it takes away the
chance for the server to start advertizing again.

This change reschedules the delayed work, even if the current call
failed. That way, multichannel sessions can recover.

Signed-off-by: Shyam Prasad N <sprasad@microsoft.com>
Cc: stable@vger.kernel.org
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Henrique Carvalho <henrique.carvalho@suse.com>
---
 fs/smb/client/connect.c |    6 +-----
 fs/smb/client/smb2pdu.c |   10 +++++-----
 2 files changed, 6 insertions(+), 10 deletions(-)

--- a/fs/smb/client/connect.c
+++ b/fs/smb/client/connect.c
@@ -116,13 +116,9 @@
        xid = get_xid();
        rc = server->ops->query_server_interfaces(xid, tcon, false);
        free_xid(xid);
-	if (rc) {
-		if (rc == -EOPNOTSUPP)
-			return;
-
+	if (rc)
 		cifs_dbg(FYI, "%s: failed to query server interfaces: %d\n",
 				__func__, rc);
-	}
 
 	queue_delayed_work(cifsiod_wq, &tcon->query_interfaces,
 			   (SMB_INTERFACE_POLL_INTERVAL * HZ));
--- a/fs/smb/client/smb2pdu.c
+++ b/fs/smb/client/smb2pdu.c
@@ -292,6 +292,10 @@
 		if (tcon->need_reconnect)
 			goto skip_sess_setup;
 
+		/* regardless of rc value, setup polling */
+		queue_delayed_work(cifsiod_wq, &tcon->query_interfaces,
+				   (SMB_INTERFACE_POLL_INTERVAL * HZ));
+
 		mutex_unlock(&ses->session_mutex);
 		goto out;
 	}
@@ -407,12 +411,8 @@
 
 		if (ses->chan_max > ses->chan_count &&
 		    !SERVER_IS_CHAN(server)) {
-                       if (ses->chan_count == 1) {
+                       if (ses->chan_count == 1)
 				cifs_server_dbg(VFS, "supports multichannel now\n");
-                               queue_delayed_work(cifsiod_wq, &tcon->query_interfaces,
-                                               (SMB_INTERFACE_POLL_INTERVAL * HZ));
-
-                               }
 
 			cifs_try_adding_channels(ses);
 		}
