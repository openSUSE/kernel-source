Subject: Linux-RT 2.6.25.4-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
---
 arch/x86/kernel/tsc_32.c |    9 ++++++++-
 arch/x86/kernel/tsc_64.c |    5 ++++-
 include/asm-x86/timer.h  |    3 ---
 3 files changed, 12 insertions(+), 5 deletions(-)

Index: linux-2.6.25.4-rt4/arch/x86/kernel/tsc_32.c
===================================================================
--- linux-2.6.25.4-rt4.orig/arch/x86/kernel/tsc_32.c	2008-05-29 09:46:04.000000000 -0400
+++ linux-2.6.25.4-rt4/arch/x86/kernel/tsc_32.c	2008-05-29 09:46:07.000000000 -0400
@@ -112,6 +112,7 @@ static void set_cyc2ns_scale(unsigned lo
 unsigned long long notrace  native_sched_clock(void)
 {
 	unsigned long long this_offset;
+	unsigned long long ret;
 
 	/*
 	 * Fall back to jiffies if there's no TSC available:
@@ -125,11 +126,17 @@ unsigned long long notrace  native_sched
 		/* No locking but a rare wrong value is not a big deal: */
 		return (jiffies_64 - INITIAL_JIFFIES) * (1000000000 / HZ);
 
+	preempt_disable_notrace();
+
 	/* read the Time Stamp Counter: */
 	rdtscll(this_offset);
 
 	/* return the value in ns */
-	return cycles_2_ns(this_offset);
+	ret = cycles_2_ns(this_offset);
+
+	preempt_enable_notrace();
+
+	return ret;
 }
 
 /* We need to define a real function for sched_clock, to override the
Index: linux-2.6.25.4-rt4/arch/x86/kernel/tsc_64.c
===================================================================
--- linux-2.6.25.4-rt4.orig/arch/x86/kernel/tsc_64.c	2008-05-29 09:46:00.000000000 -0400
+++ linux-2.6.25.4-rt4/arch/x86/kernel/tsc_64.c	2008-05-29 09:46:07.000000000 -0400
@@ -66,6 +66,7 @@ static void set_cyc2ns_scale(unsigned lo
 unsigned long long native_sched_clock(void)
 {
 	unsigned long a = 0;
+	unsigned long long ret;
 
 	/* Could do CPU core sync here. Opteron can execute rdtsc speculatively,
 	 * which means it is not completely exact and may not be monotonous
@@ -73,8 +74,10 @@ unsigned long long native_sched_clock(vo
 	 * scheduling purposes.
 	 */
 
+	preempt_disable_notrace();
 	rdtscll(a);
-	return cycles_2_ns(a);
+	ret = cycles_2_ns(a);
+	preempt_enable_notrace();
 }
 
 /* We need to define a real function for sched_clock, to override the
Index: linux-2.6.25.4-rt4/include/asm-x86/timer.h
===================================================================
--- linux-2.6.25.4-rt4.orig/include/asm-x86/timer.h	2008-05-29 09:46:04.000000000 -0400
+++ linux-2.6.25.4-rt4/include/asm-x86/timer.h	2008-05-29 09:46:07.000000000 -0400
@@ -51,11 +51,8 @@ static inline notrace unsigned long long
 static inline notrace unsigned long long cycles_2_ns(unsigned long long cyc)
 {
 	unsigned long long ns;
-	unsigned long flags;
 
-	local_irq_save(flags);
 	ns = __cycles_2_ns(cyc);
-	local_irq_restore(flags);
 
 	return ns;
 }
