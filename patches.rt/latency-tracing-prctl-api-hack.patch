Subject: Linux-RT 2.6.25-rt
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
 include/linux/ftrace.h |   12 +++++++++++-
 include/linux/prctl.h  |    1 +
 kernel/sys.c           |    8 ++++++++
 kernel/trace/trace.c   |   32 ++++++++++++++++++++++++++++++++
 4 files changed, 52 insertions(+), 1 deletion(-)

Index: linux-2.6.25.2-rt1/include/linux/prctl.h
===================================================================
--- linux-2.6.25.2-rt1.orig/include/linux/prctl.h	2008-05-08 16:18:18.000000000 -0400
+++ linux-2.6.25.2-rt1/include/linux/prctl.h	2008-05-08 16:18:27.000000000 -0400
@@ -3,6 +3,7 @@
 
 /* Values to pass as first argument to prctl() */
 
+#define PR_SET_TRACING    0  /* Second arg is tracing on/off */
 #define PR_SET_PDEATHSIG  1  /* Second arg is a signal */
 #define PR_GET_PDEATHSIG  2  /* Second arg is a ptr to return the signal */
 
Index: linux-2.6.25.2-rt1/kernel/sys.c
===================================================================
--- linux-2.6.25.2-rt1.orig/kernel/sys.c	2008-05-08 16:18:18.000000000 -0400
+++ linux-2.6.25.2-rt1/kernel/sys.c	2008-05-08 16:18:27.000000000 -0400
@@ -1628,6 +1628,14 @@ asmlinkage long sys_prctl(int option, un
 {
 	long error;
 
+#ifdef CONFIG_EVENT_TRACE
+	if (option == PR_SET_TRACING) {
+		if (arg2)
+			return user_trace_start();
+		return user_trace_stop();
+	}
+#endif
+
 	error = security_task_prctl(option, arg2, arg3, arg4, arg5);
 	if (error)
 		return error;
Index: linux-2.6.25.2-rt1/include/linux/ftrace.h
===================================================================
--- linux-2.6.25.2-rt1.orig/include/linux/ftrace.h	2008-05-08 16:18:25.000000000 -0400
+++ linux-2.6.25.2-rt1/include/linux/ftrace.h	2008-05-08 16:18:27.000000000 -0400
@@ -4,7 +4,6 @@
 #ifdef CONFIG_FTRACE
 
 #include <linux/linkage.h>
-#include <linux/ktime.h>
 
 extern int ftrace_enabled;
 extern int
@@ -130,6 +129,9 @@ enum ftrace_event_enum {
 	FTRACE_EVENTS_TIMESTAMP,
 	FTRACE_EVENTS_TASK,
 };
+
+#include <linux/ktime.h>
+
 extern void ftrace_record_event(enum ftrace_event_enum event, ...);
 static inline void ftrace_event_irq(int irq, int user, unsigned long ip)
 {
@@ -175,4 +177,12 @@ static inline void ftrace_event_task(pid
 # define ftrace_event_task(pid, prio, running)	do { } while (0)
 #endif /* CONFIG_TRACE_EVENTS */
 
+#ifdef CONFIG_TRACING
+extern void user_trace_start(void);
+extern void user_trace_stop(void);
+#else
+# define user_trace_start() do { } while (0)
+# define user_trace_stop() do { } while (0)
+#endif
+
 #endif /* _LINUX_FTRACE_H */
Index: linux-2.6.25.2-rt1/kernel/trace/trace.c
===================================================================
--- linux-2.6.25.2-rt1.orig/kernel/trace/trace.c	2008-05-08 16:18:27.000000000 -0400
+++ linux-2.6.25.2-rt1/kernel/trace/trace.c	2008-05-08 16:18:27.000000000 -0400
@@ -3015,6 +3015,38 @@ static struct file_operations tracing_en
 	.write		= tracing_entries_write,
 };
 
+void user_trace_start(void)
+{
+	struct trace_array *tr = &global_trace;
+
+	mutex_lock(&trace_types_lock);
+	if (tr->ctrl)
+		goto out;
+
+	tr->ctrl = 1;
+	if (current_trace && current_trace->ctrl_update)
+		current_trace->ctrl_update(tr);
+ out:
+	mutex_unlock(&trace_types_lock);
+}
+EXPORT_SYMBOL_GPL(user_trace_start);
+
+void user_trace_stop(void)
+{
+	struct trace_array *tr = &global_trace;
+
+	mutex_lock(&trace_types_lock);
+	if (!tr->ctrl)
+		goto out;
+
+	tr->ctrl = 0;
+	if (current_trace && current_trace->ctrl_update)
+		current_trace->ctrl_update(tr);
+ out:
+	mutex_unlock(&trace_types_lock);
+}
+EXPORT_SYMBOL_GPL(user_trace_stop);
+
 #ifdef CONFIG_DYNAMIC_FTRACE
 
 static ssize_t
