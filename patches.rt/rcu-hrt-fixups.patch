Subject: Linux-RT 2.6.25.4-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
 include/linux/rcuclassic.h |    3 +++
 include/linux/rcupreempt.h |    2 ++
 kernel/rcuclassic.c        |   19 ++++++++++++++++---
 kernel/rcupreempt.c        |    2 +-
 4 files changed, 22 insertions(+), 4 deletions(-)

Index: linux-2.6.25.4-rt4/include/linux/rcuclassic.h
===================================================================
--- linux-2.6.25.4-rt4.orig/include/linux/rcuclassic.h	2008-05-29 09:45:59.000000000 -0400
+++ linux-2.6.25.4-rt4/include/linux/rcuclassic.h	2008-05-29 09:46:02.000000000 -0400
@@ -163,5 +163,8 @@ extern long rcu_batches_completed_bh(voi
 #define rcu_enter_nohz()	do { } while (0)
 #define rcu_exit_nohz()		do { } while (0)
 
+struct softirq_action;
+extern void rcu_process_callbacks(struct softirq_action *unused);
+
 #endif /* __KERNEL__ */
 #endif /* __LINUX_RCUCLASSIC_H */
Index: linux-2.6.25.4-rt4/include/linux/rcupreempt.h
===================================================================
--- linux-2.6.25.4-rt4.orig/include/linux/rcupreempt.h	2008-05-29 09:46:01.000000000 -0400
+++ linux-2.6.25.4-rt4/include/linux/rcupreempt.h	2008-05-29 09:46:02.000000000 -0400
@@ -136,5 +136,7 @@ static inline void rcu_exit_nohz(void)
 #define rcu_exit_nohz()		do { } while (0)
 #endif /* CONFIG_NO_HZ */
 
+extern void rcu_process_callbacks(struct softirq_action *unused);
+
 #endif /* __KERNEL__ */
 #endif /* __LINUX_RCUPREEMPT_H */
Index: linux-2.6.25.4-rt4/kernel/rcuclassic.c
===================================================================
--- linux-2.6.25.4-rt4.orig/kernel/rcuclassic.c	2008-05-29 09:45:59.000000000 -0400
+++ linux-2.6.25.4-rt4/kernel/rcuclassic.c	2008-05-29 09:46:02.000000000 -0400
@@ -402,6 +402,8 @@ static void rcu_offline_cpu(int cpu)
 static void __rcu_process_callbacks(struct rcu_ctrlblk *rcp,
 					struct rcu_data *rdp)
 {
+	unsigned long flags;
+
 	if (rdp->curlist && !rcu_batch_before(rcp->completed, rdp->batch)) {
 		*rdp->donetail = rdp->curlist;
 		rdp->donetail = rdp->curtail;
@@ -410,12 +412,12 @@ static void __rcu_process_callbacks(stru
 	}
 
 	if (rdp->nxtlist && !rdp->curlist) {
-		local_irq_disable();
+		local_irq_save(flags);
 		rdp->curlist = rdp->nxtlist;
 		rdp->curtail = rdp->nxttail;
 		rdp->nxtlist = NULL;
 		rdp->nxttail = &rdp->nxtlist;
-		local_irq_enable();
+		local_irq_restore(flags);
 
 		/*
 		 * start the next batch of callbacks
@@ -442,7 +444,7 @@ static void __rcu_process_callbacks(stru
 		rcu_do_batch(rdp);
 }
 
-static void rcu_process_callbacks(struct softirq_action *unused)
+void rcu_process_callbacks(struct softirq_action *unused)
 {
 	__rcu_process_callbacks(&rcu_ctrlblk, &__get_cpu_var(rcu_data));
 	__rcu_process_callbacks(&rcu_bh_ctrlblk, &__get_cpu_var(rcu_bh_data));
@@ -497,6 +499,17 @@ int rcu_needs_cpu(int cpu)
 	return (!!rdp->curlist || !!rdp_bh->curlist || rcu_pending(cpu));
 }
 
+void rcu_advance_callbacks(int cpu, int user)
+{
+	if (user ||
+	    (idle_cpu(cpu) && !in_softirq() &&
+				hardirq_count() <= (1 << HARDIRQ_SHIFT))) {
+		rcu_qsctr_inc(cpu);
+		rcu_bh_qsctr_inc(cpu);
+	} else if (!in_softirq())
+		rcu_bh_qsctr_inc(cpu);
+}
+
 void rcu_check_callbacks(int cpu, int user)
 {
 	if (user ||
Index: linux-2.6.25.4-rt4/kernel/rcupreempt.c
===================================================================
--- linux-2.6.25.4-rt4.orig/kernel/rcupreempt.c	2008-05-29 09:46:01.000000000 -0400
+++ linux-2.6.25.4-rt4/kernel/rcupreempt.c	2008-05-29 09:46:02.000000000 -0400
@@ -950,7 +950,7 @@ void __devinit rcu_online_cpu(int cpu)
 
 #endif /* #else #ifdef CONFIG_HOTPLUG_CPU */
 
-static void rcu_process_callbacks(struct softirq_action *unused)
+void rcu_process_callbacks(struct softirq_action *unused)
 {
 	unsigned long flags;
 	struct rcu_head *next, *list;
