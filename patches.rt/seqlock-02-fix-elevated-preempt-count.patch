Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
From srostedt@redhat.com Wed Aug 20 17:25:30 2008
Date: Wed, 20 Aug 2008 17:22:34 -0400
From: Steven Rostedt <srostedt@redhat.com>
To: Steven Rostedt <rostedt@goodmis.org>
Subject: [Fwd: [PATCH 2/2] ftrace: fix elevated preempt_count in wakeup-tracer]

    [ The following text is in the "utf-8" character set. ]
    [ Your display is set for the "ANSI_X3.4-1968" character set.  ]
    [ Some characters may be displayed incorrectly. ]



-------- Original Message --------
Subject: 	[PATCH 2/2] ftrace: fix elevated preempt_count in wakeup-tracer
Date: 	Wed, 20 Aug 2008 14:28:25 -0400
From: 	Gregory Haskins <ghaskins@novell.com>
To: 	srostedt@redhat.com
References: 	<20080820182819.15463.4146.stgit@dev.haskins.net>



Suggested by Steve Rostedt to fix an observed "+1" in the preempt-count

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---

 kernel/trace/trace_sched_wakeup.c |    2 ++
 1 file changed, 2 insertions(+)

Index: linux-2.6.26.3-rt6/kernel/trace/trace_sched_wakeup.c
===================================================================
--- linux-2.6.26.3-rt6.orig/kernel/trace/trace_sched_wakeup.c	2008-09-05 00:22:27.000000000 -0400
+++ linux-2.6.26.3-rt6/kernel/trace/trace_sched_wakeup.c	2008-09-05 00:24:07.000000000 -0400
@@ -70,7 +70,9 @@ wakeup_tracer_call(unsigned long ip, uns
 	if (task_cpu(wakeup_task) != cpu)
 		goto unlock;
 
+	preempt_enable_no_resched_notrace();
 	trace_function(tr, data, ip, parent_ip, flags);
+	preempt_disable_notrace();
 
  unlock:
 	__raw_spin_unlock(&wakeup_lock);
