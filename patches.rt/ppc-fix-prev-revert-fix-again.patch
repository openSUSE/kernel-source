Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
From chirag@linux.vnet.ibm.com Fri Sep  5 02:40:04 2008
Date: Fri, 5 Sep 2008 11:52:09 +0530
From: Chirag Jog <chirag@linux.vnet.ibm.com>
To: Steven Rostedt <rostedt@goodmis.org>
Cc: Thomas Gleixner <tglx@linutronix.de>
Subject: [PATCH] Fix a reverted fix again.

    [ The following text is in the "iso-8859-1" character set. ]
    [ Your display is set for the "ANSI_X3.4-1968" character set.  ]
    [ Some characters may be displayed incorrectly. ]

Hi Steven,

* Steven Rostedt <rostedt@goodmis.org> [2008-09-04 17:24:31]:

> 
> On Thu, 4 Sep 2008, Chirag Jog wrote:
> 
> > 
> > Hi Steven/Thomas
> > * Steven Rostedt <rostedt@goodmis.org> [2008-09-04 00:09:56]:
> > 
> > > We are pleased to announce the 2.6.26.3-rt5 tree, which can be
> > > downloaded from the location:
> > > 
> > 
> > Please pick this patch,  essential for powerpc64 functioning:
> > 
> >     http://marc.info/?l=linux-rt-users&m=121811314916866&w=2
> > 
> 
> That patch does not apply cleanly. Could you fix it up against 
> 2.6.26.3-rt5, and resend.
> 

Resending the Patch:


    fix-a-reverted-fix-again
    
    
    This patch reintroduces a "fix" that got reverted.
    Here was the original patch http://lkml.org/lkml/2007/5/22/133
    
    Here is the new patch
    This patch also fixes OOPS reported here:
    http://lkml.org/lkml/2008/6/19/146
    
    From tsutomu.owa@toshiba.co.jp
    Signed-Off-By: Chirag <chirag@linux.vnet.ibm.com>

---
 arch/powerpc/kernel/entry_64.S |   14 ++++++++------
 1 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/kernel/entry_64.S b/arch/powerpc/kernel/entry_64.S
index 8c73f39..c0c3118 100644
--- a/arch/powerpc/kernel/entry_64.S
+++ b/arch/powerpc/kernel/entry_64.S
@@ -621,13 +621,15 @@ do_work:
 	 * we will hard-enable unconditionally, we can just reload the
 	 * current MSR into r10
 	 */
+	bl		.preempt_schedule_irq
 	mfmsr	r10
-
-	li	r0,1
-	stb	r0,PACASOFTIRQEN(r13)
-	stb	r0,PACAHARDIRQEN(r13)
-	ori	r10,r10,MSR_EE
-	mtmsrd	r10,1		/* reenable interrupts */
+	clrrdi  r9,r1,THREAD_SHIFT
+	rldicl  r10,r10,48,1    /* disable interrupts again */
+	rotldi  r10,r10,16
+	mtmsrd  r10,1
+	ld      r4,TI_FLAGS(r9)
+	andi.   r0,r4,(_TIF_NEED_RESCHED)
+	bne     1b
 	b	restore
 
 user_work:
