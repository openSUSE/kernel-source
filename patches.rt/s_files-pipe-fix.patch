Subject: Linux-RT 2.6.26-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
Subject: s_files: free_write_pipe() fix
From: Ingo Molnar <mingo@elte.hu>

file_kill() has to look at the file's inode (for the barrier logic),
hence make sure we free the inode before the file.

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 fs/pipe.c |   10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

Index: linux-2.6.26/fs/pipe.c
===================================================================
--- linux-2.6.26.orig/fs/pipe.c
+++ linux-2.6.26/fs/pipe.c
@@ -1014,9 +1014,17 @@ struct file *create_write_pipe(void)
 
 void free_write_pipe(struct file *f)
 {
+	struct path path;
+
 	free_pipe_info(f->f_dentry->d_inode);
-	path_put(&f->f_path);
+	/*
+	 * file_kill() looks at the file's inode (for barrier logic)
+	 * hence make sure we free the inode before the file.
+	 */
+	path = f->f_path;
+	memset(&f->f_path, 0, sizeof(f->f_path));
 	put_filp(f);
+	path_put(&path);
 }
 
 struct file *create_read_pipe(struct file *wrf)
