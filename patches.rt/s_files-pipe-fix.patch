Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
Subject: s_files: free_write_pipe() fix
From: Ingo Molnar <mingo@elte.hu>

file_kill() has to look at the file's inode (for the barrier logic),
hence make sure we free the inode before the file.

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 fs/pipe.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/fs/pipe.c b/fs/pipe.c
index cbc4492..029439a 100644
--- a/fs/pipe.c
+++ b/fs/pipe.c
@@ -979,9 +979,17 @@ struct file *create_write_pipe(int flags)
 
 void free_write_pipe(struct file *f)
 {
+	struct path path;
+
 	free_pipe_info(f->f_dentry->d_inode);
-	path_put(&f->f_path);
+	/*
+	 * file_kill() looks at the file's inode (for barrier logic)
+	 * hence make sure we free the inode before the file.
+	 */
+	path = f->f_path;
+	memset(&f->f_path, 0, sizeof(f->f_path));
 	put_filp(f);
+	path_put(&path);
 }
 
 struct file *create_read_pipe(struct file *wrf, int flags)
