Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
From: Steven Rostedt <srostedt@redhat.com>
Subject: ftrace: fix the command line printing

Only half of the command line recording was implemented. The reverse
map back from command line array to pid to verify that the command line
did indeed belong to the pid, was missing.

Signed-off-by: Steven Rostedt <srostedt@redhat.com>
---
 kernel/trace/trace.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index d0cc193..972162b 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -704,14 +704,19 @@ static void trace_save_cmdline(struct task_struct *tsk)
 	if (!spin_trylock(&trace_cmdline_lock))
 		return;
 
+	/* from the pid, find the index of the cmdline array */
 	idx = map_pid_to_cmdline[tsk->pid];
+
 	if (idx >= SAVED_CMDLINES) {
+		/* this is new */
 		idx = (cmdline_idx + 1) % SAVED_CMDLINES;
 
+		/* check the reverse map and reset it if needed */
 		map = map_cmdline_to_pid[idx];
 		if (map <= PID_MAX_DEFAULT)
 			map_pid_to_cmdline[map] = (unsigned)-1;
 
+		map_cmdline_to_pid[idx] = tsk->pid;
 		map_pid_to_cmdline[tsk->pid] = idx;
 
 		cmdline_idx = idx;
@@ -737,6 +742,9 @@ static char *trace_find_cmdline(int pid)
 	if (map >= SAVED_CMDLINES)
 		goto out;
 
+	if (map_cmdline_to_pid[map] != pid)
+		goto out;
+
 	cmdline = saved_cmdlines[map];
 
  out:
