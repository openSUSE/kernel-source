Subject: Linux-RT 2.6.25.4-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
From ghaskins@novell.com Tue Feb 26 13:05:53 2008
Date: Tue, 26 Feb 2008 12:14:27 -0500
From: Gregory Haskins <ghaskins@novell.com>
To: rostedt@goodmis.org
Cc: ghaskins@novell.com
Subject: [PATCH] fix oops in root-domain code during repartitioning

    [ The following text is in the "utf-8" character set. ]
    [ Your display is set for the "iso-8859-1" character set.  ]
    [ Some characters may be displayed incorrectly. ]

we cannot kfree while in_atomic in -rt, and we currently hold the
(raw_spinlock_t)rq->lock while we try.  So defer the operation until
we are out of the critical section.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---

 kernel/sched.c |    7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

Index: linux-2.6.25.4-rt2/kernel/sched.c
===================================================================
--- linux-2.6.25.4-rt2.orig/kernel/sched.c	2008-05-19 16:56:21.000000000 -0400
+++ linux-2.6.25.4-rt2/kernel/sched.c	2008-05-19 16:56:32.000000000 -0400
@@ -6554,6 +6554,7 @@ static void rq_attach_root(struct rq *rq
 {
 	unsigned long flags;
 	const struct sched_class *class;
+	struct root_domain *reap = NULL;
 
 	spin_lock_irqsave(&rq->lock, flags);
 
@@ -6569,7 +6570,7 @@ static void rq_attach_root(struct rq *rq
 		cpu_clear(rq->cpu, old_rd->online);
 
 		if (atomic_dec_and_test(&old_rd->refcount))
-			kfree(old_rd);
+			reap = old_rd;
 	}
 
 	atomic_inc(&rd->refcount);
@@ -6585,6 +6586,10 @@ static void rq_attach_root(struct rq *rq
 	}
 
 	spin_unlock_irqrestore(&rq->lock, flags);
+
+	/* Don't try to free the memory while in-atomic() */
+	if (unlikely(reap))
+		kfree(reap);
 }
 
 static void init_rootdomain(struct root_domain *rd)
