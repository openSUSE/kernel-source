Subject: Linux-RT 2.6.24-rc2-rt1
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>

undo:

 commit a1a70c25bed75ed36ed48bbe18b9029428d2452d
 Author: Adrian Bunk <bunk@stusta.de>
 Date:   Thu Dec 7 02:14:12 2006 +0100

    [PATCH] i386: always enable regparm

needed for latency tracing.

---
 Documentation/stable_api_nonsense.txt |    3 +++
 arch/x86/Kconfig.i386                 |    7 +++++++
 arch/x86/Makefile_32                  |    2 ++
 include/asm-x86/module_32.h           |    8 +++++++-
 4 files changed, 19 insertions(+), 1 deletion(-)

Index: linux-2.6.23/Documentation/stable_api_nonsense.txt
===================================================================
--- linux-2.6.23.orig/Documentation/stable_api_nonsense.txt
+++ linux-2.6.23/Documentation/stable_api_nonsense.txt
@@ -62,6 +62,9 @@ consider the following facts about the L
       - different structures can contain different fields
       - Some functions may not be implemented at all, (i.e. some locks
 	compile away to nothing for non-SMP builds.)
+      - Parameter passing of variables from function to function can be
+	done in different ways (the CONFIG_REGPARM option controls
+	this.)
       - Memory within the kernel can be aligned in different ways,
 	depending on the build options.
   - Linux runs on a wide range of different processor architectures.
Index: linux-2.6.23/arch/x86/Makefile_32
===================================================================
--- linux-2.6.23.orig/arch/x86/Makefile_32
+++ linux-2.6.23/arch/x86/Makefile_32
@@ -45,6 +45,8 @@ KBUILD_CFLAGS += $(call cc-option,-mpref
 # CPU-specific tuning. Anything which can be shared with UML should go here.
 include $(srctree)/arch/x86/Makefile_32.cpu
 
+cflags-$(CONFIG_REGPARM) += -mregparm=3
+
 # temporary until string.h is fixed
 cflags-y += -ffreestanding
 
Index: linux-2.6.23/include/asm-x86/module_32.h
===================================================================
--- linux-2.6.23.orig/include/asm-x86/module_32.h
+++ linux-2.6.23/include/asm-x86/module_32.h
@@ -64,12 +64,18 @@ struct mod_arch_specific
 #error unknown processor family
 #endif
 
+#ifdef CONFIG_REGPARM
+#define MODULE_REGPARM "REGPARM "
+#else
+#define MODULE_REGPARM ""
+#endif
+
 #ifdef CONFIG_4KSTACKS
 #define MODULE_STACKSIZE "4KSTACKS "
 #else
 #define MODULE_STACKSIZE ""
 #endif
 
-#define MODULE_ARCH_VERMAGIC MODULE_PROC_FAMILY MODULE_STACKSIZE
+#define MODULE_ARCH_VERMAGIC MODULE_PROC_FAMILY MODULE_REGPARM MODULE_STACKSIZE
 
 #endif /* _ASM_I386_MODULE_H */
Index: linux-2.6.23/arch/x86/Kconfig
===================================================================
--- linux-2.6.23.orig/arch/x86/Kconfig
+++ linux-2.6.23/arch/x86/Kconfig
@@ -1017,6 +1017,13 @@ config BOOT_IOREMAP
 	depends on X86_32 && (((X86_SUMMIT || X86_GENERICARCH) && NUMA) || (X86 && EFI))
 	default y
 
+#
+# function tracing might turn this off:
+#
+config REGPARM
+	bool
+	default y
+
 config SECCOMP
 	bool "Enable seccomp to safely compute untrusted bytecode"
 	depends on PROC_FS
