
undo:

 commit a1a70c25bed75ed36ed48bbe18b9029428d2452d
 Author: Adrian Bunk <bunk@stusta.de>
 Date:   Thu Dec 7 02:14:12 2006 +0100

    [PATCH] i386: always enable regparm

needed for latency tracing.

---
 Documentation/stable_api_nonsense.txt |    3 +++
 arch/i386/Kconfig                     |    7 +++++++
 arch/i386/Makefile                    |    4 +++-
 include/asm-i386/module.h             |    8 +++++++-
 4 files changed, 20 insertions(+), 2 deletions(-)

Index: linux-2.6.22/Documentation/stable_api_nonsense.txt
===================================================================
--- linux-2.6.22.orig/Documentation/stable_api_nonsense.txt	2007-07-24 08:56:37.000000000 +0200
+++ linux-2.6.22/Documentation/stable_api_nonsense.txt	2007-07-24 08:57:04.000000000 +0200
@@ -62,6 +62,9 @@ consider the following facts about the L
       - different structures can contain different fields
       - Some functions may not be implemented at all, (i.e. some locks
 	compile away to nothing for non-SMP builds.)
+      - Parameter passing of variables from function to function can be
+	done in different ways (the CONFIG_REGPARM option controls
+	this.)
       - Memory within the kernel can be aligned in different ways,
 	depending on the build options.
   - Linux runs on a wide range of different processor architectures.
Index: linux-2.6.22/arch/i386/Kconfig
===================================================================
--- linux-2.6.22.orig/arch/i386/Kconfig	2007-07-24 08:56:53.000000000 +0200
+++ linux-2.6.22/arch/i386/Kconfig	2007-07-24 08:57:04.000000000 +0200
@@ -772,6 +772,13 @@ config BOOT_IOREMAP
 	depends on (((X86_SUMMIT || X86_GENERICARCH) && NUMA) || (X86 && EFI))
 	default y
 
+#
+# function tracing might turn this off:
+#
+config REGPARM
+	bool
+	default y
+
 config SECCOMP
 	bool "Enable seccomp to safely compute untrusted bytecode"
 	depends on PROC_FS
Index: linux-2.6.22/arch/i386/Makefile
===================================================================
--- linux-2.6.22.orig/arch/i386/Makefile	2007-07-24 08:56:37.000000000 +0200
+++ linux-2.6.22/arch/i386/Makefile	2007-07-24 08:57:04.000000000 +0200
@@ -31,7 +31,7 @@ LDFLAGS_vmlinux := --emit-relocs
 endif
 CHECKFLAGS	+= -D__i386__
 
-CFLAGS += -pipe -msoft-float -mregparm=3 -freg-struct-return
+CFLAGS += -pipe -msoft-float
 
 # prevent gcc from keeping the stack 16 byte aligned
 CFLAGS += $(call cc-option,-mpreferred-stack-boundary=2)
@@ -39,6 +39,8 @@ CFLAGS += $(call cc-option,-mpreferred-s
 # CPU-specific tuning. Anything which can be shared with UML should go here.
 include $(srctree)/arch/i386/Makefile.cpu
 
+cflags-$(CONFIG_REGPARM) += -mregparm=3 -freg-struct-return
+
 # temporary until string.h is fixed
 cflags-y += -ffreestanding
 
Index: linux-2.6.22/include/asm-i386/module.h
===================================================================
--- linux-2.6.22.orig/include/asm-i386/module.h	2007-07-24 08:56:37.000000000 +0200
+++ linux-2.6.22/include/asm-i386/module.h	2007-07-24 08:57:04.000000000 +0200
@@ -64,12 +64,18 @@ struct mod_arch_specific
 #error unknown processor family
 #endif
 
+#ifdef CONFIG_REGPARM
+#define MODULE_REGPARM "REGPARM "
+#else
+#define MODULE_REGPARM ""
+#endif
+
 #ifdef CONFIG_4KSTACKS
 #define MODULE_STACKSIZE "4KSTACKS "
 #else
 #define MODULE_STACKSIZE ""
 #endif
 
-#define MODULE_ARCH_VERMAGIC MODULE_PROC_FAMILY MODULE_STACKSIZE
+#define MODULE_ARCH_VERMAGIC MODULE_PROC_FAMILY MODULE_REGPARM MODULE_STACKSIZE
 
 #endif /* _ASM_I386_MODULE_H */
