Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
Subject: nfs: fix missing preemption check
From: Thomas Gleixner <tglx@linutronix.de>
Date: Sun, 27 Jul 2008 00:54:19 +0200

NFS iostats use get_cpu()/put_cpu_no_preempt(). That misses a
preemption check for no good reason and introduces long latencies when
a wakeup of a higher priority task happens in the preempt disabled
region.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
---
 fs/nfs/iostat.h |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/fs/nfs/iostat.h b/fs/nfs/iostat.h
index a369528..90b538d 100644
--- a/fs/nfs/iostat.h
+++ b/fs/nfs/iostat.h
@@ -28,7 +28,7 @@ static inline void nfs_inc_server_stats(const struct nfs_server *server,
 	cpu = get_cpu();
 	iostats = per_cpu_ptr(server->io_stats, cpu);
 	iostats->events[stat]++;
-	put_cpu_no_resched();
+	put_cpu();
 }
 
 static inline void nfs_inc_stats(const struct inode *inode,
@@ -47,7 +47,7 @@ static inline void nfs_add_server_stats(const struct nfs_server *server,
 	cpu = get_cpu();
 	iostats = per_cpu_ptr(server->io_stats, cpu);
 	iostats->bytes[stat] += addend;
-	put_cpu_no_resched();
+	put_cpu();
 }
 
 static inline void nfs_add_stats(const struct inode *inode,
