Subject: Linux-RT 2.6.25.4-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
Add protection to per_cpu variables in pcounter addition.

Signed-off-by: Steven Rostedt <srostedt@redhat.com>

---
 include/linux/pcounter.h |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

Index: linux-2.6.25.4-rt1/include/linux/pcounter.h
===================================================================
--- linux-2.6.25.4-rt1.orig/include/linux/pcounter.h	2008-05-17 08:26:03.000000000 -0400
+++ linux-2.6.25.4-rt1/include/linux/pcounter.h	2008-05-17 08:28:13.000000000 -0400
@@ -28,7 +28,9 @@ struct pcounter {
 static DEFINE_PER_CPU(int, NAME##_pcounter_values);			\
 static void NAME##_pcounter_add(struct pcounter *self, int val)		\
 {									\
-       __get_cpu_var(NAME##_pcounter_values) += val;			\
+	preempt_disable();						\
+	__get_cpu_var(NAME##_pcounter_values) += val;			\
+	preempt_enable();						\
 }									\
 static int NAME##_pcounter_getval(const struct pcounter *self, int cpu)	\
 {									\
