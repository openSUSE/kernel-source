Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Tony Jones <tonyj@suse.de>
---
 include/linux/futex.h |    1 +
 kernel/futex.c        |   11 +++++++++++
 kernel/sysctl.c       |   11 +++++++++++
 3 files changed, 23 insertions(+)

Index: linux-2.6.27-RT/include/linux/futex.h
===================================================================
--- linux-2.6.27-RT.orig/include/linux/futex.h
+++ linux-2.6.27-RT/include/linux/futex.h
@@ -168,6 +168,7 @@ union futex_key {
 extern void exit_robust_list(struct task_struct *curr);
 extern void exit_pi_state_list(struct task_struct *curr);
 extern int futex_cmpxchg_enabled;
+extern int futex_rt_pi_warning;
 #else
 static inline void exit_robust_list(struct task_struct *curr)
 {
Index: linux-2.6.27-RT/kernel/futex.c
===================================================================
--- linux-2.6.27-RT.orig/kernel/futex.c
+++ linux-2.6.27-RT/kernel/futex.c
@@ -61,6 +61,7 @@
 #include "rtmutex_common.h"
 
 int __read_mostly futex_cmpxchg_enabled;
+int __read_mostly futex_rt_pi_warning;
 
 #define FUTEX_HASHBITS (CONFIG_BASE_SMALL ? 4 : 8)
 
@@ -1234,6 +1235,16 @@ static int futex_wait(u32 __user *uaddr,
 
 	hb = queue_lock(&q);
 
+	if (futex_rt_pi_warning && unlikely(rt_task(curr))) {
+		if (printk_ratelimit()) {
+			printk(KERN_WARNING
+			       "RT task %s:%d with priority %d"
+			       " using non PI futex\n",
+			       current->comm, current->pid,
+			       100 - current->prio);
+		}
+	}
+
 	/*
 	 * Access the page AFTER the futex is queued.
 	 * Order is important:
Index: linux-2.6.27-RT/kernel/sysctl.c
===================================================================
--- linux-2.6.27-RT.orig/kernel/sysctl.c
+++ linux-2.6.27-RT/kernel/sysctl.c
@@ -49,6 +49,7 @@
 #include <linux/reboot.h>
 #include <linux/ftrace.h>
 #include <linux/profile.h>
+#include <linux/futex.h>
 
 #include <asm/uaccess.h>
 #include <asm/processor.h>
@@ -367,6 +368,16 @@ static struct ctl_table kern_table[] = {
 		.maxlen		= sizeof(int),
 		.mode		= 0644,
 		.proc_handler	= &proc_dointvec,
+	},
+#endif
+#ifdef CONFIG_FUTEX
+	{
+		.ctl_name	= CTL_UNNUMBERED,
+		.procname	= "futex_rt_pi_warning",
+		.data		= &futex_rt_pi_warning,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= &proc_dointvec,
 	},
 #endif
 	{
