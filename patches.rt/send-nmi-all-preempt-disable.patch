Subject: Linux-RT 2.6.25.4-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
---
 arch/x86/kernel/nmi_32.c |    2 ++
 arch/x86/kernel/nmi_64.c |    2 ++
 2 files changed, 4 insertions(+)

Index: linux-2.6.25.4-rt2/arch/x86/kernel/nmi_32.c
===================================================================
--- linux-2.6.25.4-rt2.orig/arch/x86/kernel/nmi_32.c	2008-05-19 16:56:12.000000000 -0400
+++ linux-2.6.25.4-rt2/arch/x86/kernel/nmi_32.c	2008-05-19 16:56:25.000000000 -0400
@@ -536,9 +536,11 @@ void smp_send_nmi_allbutself(void)
 {
 #ifdef CONFIG_SMP
 	cpumask_t mask = cpu_online_map;
+	preempt_disable();
 	cpu_clear(safe_smp_processor_id(), mask);
 	if (!cpus_empty(mask))
 		send_IPI_mask(mask, NMI_VECTOR);
+	preempt_enable();
 #endif
 }
 
Index: linux-2.6.25.4-rt2/arch/x86/kernel/nmi_64.c
===================================================================
--- linux-2.6.25.4-rt2.orig/arch/x86/kernel/nmi_64.c	2008-05-19 16:56:21.000000000 -0400
+++ linux-2.6.25.4-rt2/arch/x86/kernel/nmi_64.c	2008-05-19 16:56:25.000000000 -0400
@@ -535,7 +535,9 @@ void __trigger_all_cpu_backtrace(void)
 void smp_send_nmi_allbutself(void)
 {
 #ifdef CONFIG_SMP
+	preempt_disable();
 	send_IPI_allbutself(NMI_VECTOR);
+	preempt_enable();
 #endif
 }
 
