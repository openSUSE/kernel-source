Subject: Linux-RT 2.6.27-RT
From: http://www.kernel.org/pub/linux/kernel/projects/rt/
Acked-by: Sven-Thorsten Dietrich <sdietrich@suse.de>
---
 kernel/posix-cpu-timers.c |   27 ++++++++++++++-------------
 1 file changed, 14 insertions(+), 13 deletions(-)

Index: linux-2.6.26.3-rt6/kernel/posix-cpu-timers.c
===================================================================
--- linux-2.6.26.3-rt6.orig/kernel/posix-cpu-timers.c	2008-09-05 00:22:56.000000000 -0400
+++ linux-2.6.26.3-rt6/kernel/posix-cpu-timers.c	2008-09-05 00:22:56.000000000 -0400
@@ -1321,18 +1321,6 @@ void __run_posix_cpu_timers(struct task_
 	LIST_HEAD(firing);
 	struct k_itimer *timer, *next;
 
-
-#define UNEXPIRED(clock) \
-		(cputime_eq(tsk->it_##clock##_expires, cputime_zero) || \
-		 cputime_lt(clock##_ticks(tsk), tsk->it_##clock##_expires))
-
-	if (UNEXPIRED(prof) && UNEXPIRED(virt) &&
-	    (tsk->it_sched_expires == 0 ||
-	     tsk->se.sum_exec_runtime < tsk->it_sched_expires))
-		return;
-
-#undef	UNEXPIRED
-
 	/*
 	 * Double-check with locks held.
 	 */
@@ -1457,6 +1445,19 @@ void run_posix_cpu_timers(struct task_st
 	BUG_ON(!irqs_disabled());
 	if(!per_cpu(posix_timer_task, cpu))
 		return;
+
+
+#define UNEXPIRED(clock) \
+		(cputime_eq(tsk->it_##clock##_expires, cputime_zero) || \
+		 cputime_lt(clock##_ticks(tsk), tsk->it_##clock##_expires))
+
+	if (UNEXPIRED(prof) && UNEXPIRED(virt) &&
+	    (tsk->it_sched_expires == 0 ||
+	     tsk->sum_exec_runtime < tsk->it_sched_expires))
+		return;
+
+#undef	UNEXPIRED
+
 	/* get per-cpu references */
 	tasklist = per_cpu(posix_timer_tasklist, cpu);
 
@@ -1475,7 +1476,7 @@ void run_posix_cpu_timers(struct task_st
 		per_cpu(posix_timer_tasklist, cpu) = tsk;
 	}
 	/* XXX signal the thread somehow */
-	wake_up_process(per_cpu(posix_timer_task,cpu));
+	wake_up_process(per_cpu(posix_timer_task, cpu));
 }
 
 
