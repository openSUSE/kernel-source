From ce@ceag.ch Sun Jun  3 17:30:11 2007
Return-Path: <ce@ceag.ch>
Received: from toro.web-alm.net (toro.web-alm.net [62.245.132.31]) by
	mail.tglx.de (Postfix) with ESMTP id DC0AF65C065 for <tglx@linutronix.de>;
	Sun,  3 Jun 2007 17:30:11 +0200 (CEST)
Received: from toro.web-alm.net (localhost.localdomain [127.0.0.1]) by
	toro.web-alm.net (8.12.11.20060308/8.12.11/Web-Alm-2003112001) with ESMTP
	id l53FU9Dp010764 for <tglx@linutronix.de>; Sun, 3 Jun 2007 17:30:09 +0200
Received: from thllin.ceag.ch (uucp@localhost) by toro.web-alm.net
	(8.12.11.20060308/8.12.10/Submit/Web-Alm-2003112001) with bsmtp id
	l53FU8ol010731 for tglx@linutronix.de; Sun, 3 Jun 2007 17:30:08 +0200
Received: from [192.168.255.76] (thlblade.ceag.ch [192.168.255.76]) by
	thllin.ceag.ch (8.12.11.20060308/8.12.11/CE-2005091901) with ESMTP id
	l53FMsUX003540 for <tglx@linutronix.de>; Sun, 3 Jun 2007 17:22:55 +0200
Message-ID: <4662DCCE.8070002@ceag.ch>
Date: Sun, 03 Jun 2007 17:22:54 +0200
From: Carsten Emde <ce@ceag.ch>
Organization: CE Computer Experts AG
User-Agent: Mozilla/5.0 (X11; U; SunOS sun4u; en-US; rv:1.8.1.2)
	Gecko/20070301 SeaMonkey/1.1.1
MIME-Version: 1.0
To: Thomas Gleixner <tglx@linutronix.de>
Subject: [PATCH] Make threshold to print '!' in latency trace variable
Content-Type: multipart/mixed; boundary="------------020807010006040805040904"
X-Virus-Scanned: ClamAV 0.90.1/3340/Sun Jun  3 00:40:38 2007 on
	thllin.ceag.ch
X-Virus-Status: Clean
X-Evolution-Source: imap://tglx%40linutronix.de@localhost:8993/

This is a multi-part message in MIME format.
--------------020807010006040805040904
Content-Type: text/plain; charset=ISO-8859-1; format=flowed
Content-Transfer-Encoding: 8bit

Thomas,

this patch introduces a variable threshold to print the exclamation mark 
in the latency_trace output instead of the constant 100 microseconds.

	--cbe

--------------020807010006040805040904
Content-Type: text/plain; name="linux-2.6.21.3-rt9-mark_thresh.patch"
Content-Disposition: inline; filename="linux-2.6.21.3-rt9-mark_thresh.patch"
Content-Transfer-Encoding: 8bit

---
 include/linux/clocksource.h |    1 +
 kernel/latency_trace.c      |    4 +++-
 kernel/sysctl.c             |    8 ++++++++
 3 files changed, 12 insertions(+), 1 deletion(-)

Index: linux-2.6.22/include/linux/clocksource.h
===================================================================
--- linux-2.6.22.orig/include/linux/clocksource.h	2007-07-24 08:57:05.000000000 +0200
+++ linux-2.6.22/include/linux/clocksource.h	2007-07-24 08:57:08.000000000 +0200
@@ -23,6 +23,7 @@ struct clocksource;
 
 extern unsigned long preempt_max_latency;
 extern unsigned long preempt_thresh;
+extern unsigned long preempt_mark_thresh;
 
 /**
  * struct clocksource - hardware abstraction for a free running counter
Index: linux-2.6.22/kernel/latency_trace.c
===================================================================
--- linux-2.6.22.orig/kernel/latency_trace.c	2007-07-24 08:57:08.000000000 +0200
+++ linux-2.6.22/kernel/latency_trace.c	2007-07-24 08:57:08.000000000 +0200
@@ -1296,11 +1296,13 @@ static void notrace l_stop(struct seq_fi
 	up(&out_mutex);
 }
 
+unsigned long preempt_mark_thresh = 100;
+
 static void print_timestamp(struct seq_file *m, unsigned long abs_usecs,
 						unsigned long rel_usecs)
 {
 	seq_printf(m, " %4ldus", abs_usecs);
-	if (rel_usecs > 100)
+	if (rel_usecs > preempt_mark_thresh)
 		seq_puts(m, "!: ");
 	else if (rel_usecs > 1)
 		seq_puts(m, "+: ");
Index: linux-2.6.22/kernel/sysctl.c
===================================================================
--- linux-2.6.22.orig/kernel/sysctl.c	2007-07-24 08:57:04.000000000 +0200
+++ linux-2.6.22/kernel/sysctl.c	2007-07-24 08:57:08.000000000 +0200
@@ -324,6 +324,14 @@ static ctl_table kern_table[] = {
 #ifdef CONFIG_EVENT_TRACE
 	{
 		.ctl_name	= CTL_UNNUMBERED,
+		.procname	= "preempt_mark_thresh",
+		.data		= &preempt_mark_thresh,
+		.maxlen		= sizeof(preempt_mark_thresh),
+		.mode		= 0644,
+		.proc_handler	= &proc_doulongvec_minmax,
+	},
+	{
+		.ctl_name	= CTL_UNNUMBERED,
 		.procname	= "trace_enabled",
 		.data		= &trace_enabled,
 		.maxlen		= sizeof(int),
