From: Linux Kernel Mailing Linux <linux-kernel@vger.kernel.org>
Subject: Linux: 2.6.34-rc4
Patch-mainline: 2.6.34-rc4

 This patch contains the differences between 2.6.34-rc3 and -rc4.

Acked-by: Jeff Mahoney <jeffm@suse.com>
---

 Documentation/DocBook/tracepoint.tmpl                      |   13 
 Documentation/block/biodoc.txt                             |    4 
 Documentation/connector/cn_test.c                          |    1 
 Documentation/fb/efifb.txt                                 |   31 
 Documentation/fb/imacfb.txt                                |   31 
 Documentation/filesystems/9p.txt                           |   18 
 Documentation/networking/stmmac.txt                        |  143 
 Documentation/powerpc/dts-bindings/fsl/cpm_qe/qe.txt       |   54 
 Documentation/sound/alsa/HD-Audio.txt                      |   16 
 Documentation/watchdog/src/watchdog-simple.c               |    3 
 Documentation/watchdog/src/watchdog-test.c                 |    8 
 Documentation/watchdog/watchdog-api.txt                    |    5 
 MAINTAINERS                                                |   23 
 Makefile                                                   |    2 
 arch/alpha/boot/bootp.c                                    |    1 
 arch/alpha/boot/bootpz.c                                   |    1 
 arch/alpha/boot/main.c                                     |    1 
 arch/alpha/boot/misc.c                                     |    1 
 arch/alpha/kernel/irq.c                                    |    1 
 arch/alpha/kernel/osf_sys.c                                |    2 
 arch/alpha/kernel/pci-noop.c                               |    1 
 arch/alpha/kernel/pci-sysfs.c                              |    1 
 arch/alpha/kernel/pci_iommu.c                              |    2 
 arch/alpha/kernel/process.c                                |    2 
 arch/alpha/kernel/ptrace.c                                 |    1 
 arch/alpha/kernel/smc37c669.c                              |    1 
 arch/alpha/kernel/smc37c93x.c                              |    1 
 arch/alpha/kernel/srm_env.c                                |    1 
 arch/alpha/mm/init.c                                       |    1 
 arch/arm/boot/compressed/head.S                            |    2 
 arch/arm/common/clkdev.c                                   |    1 
 arch/arm/common/it8152.c                                   |    1 
 arch/arm/include/asm/cacheflush.h                          |   38 
 arch/arm/include/asm/clkdev.h                              |    1 
 arch/arm/include/asm/irq.h                                 |    1 
 arch/arm/include/asm/outercache.h                          |   75 
 arch/arm/include/asm/system.h                              |   16 
 arch/arm/kernel/irq.c                                      |    1 
 arch/arm/kernel/kprobes.c                                  |   11 
 arch/arm/kernel/module.c                                   |    2 
 arch/arm/kernel/process.c                                  |    1 
 arch/arm/kernel/sys_arm.c                                  |    2 
 arch/arm/lib/memmove.S                                     |    4 
 arch/arm/lib/uaccess_with_memcpy.c                         |    1 
 arch/arm/mach-aaec2000/core.c                              |    1 
 arch/arm/mach-at91/pm_slowclock.S                          |   12 
 arch/arm/mach-bcmring/dma.c                                |   14 
 arch/arm/mach-davinci/board-dm365-evm.c                    |    1 
 arch/arm/mach-davinci/dm365.c                              |    1 
 arch/arm/mach-davinci/dma.c                                |    4 
 arch/arm/mach-davinci/include/mach/da8xx.h                 |    8 
 arch/arm/mach-davinci/time.c                               |    6 
 arch/arm/mach-ep93xx/gpio.c                                |    6 
 arch/arm/mach-h720x/common.c                               |    1 
 arch/arm/mach-integrator/cpu.c                             |    1 
 arch/arm/mach-integrator/impd1.c                           |    1 
 arch/arm/mach-integrator/integrator_cp.c                   |    2 
 arch/arm/mach-integrator/pci_v3.c                          |    1 
 arch/arm/mach-iop13xx/pci.c                                |    1 
 arch/arm/mach-iop32x/glantank.c                            |    1 
 arch/arm/mach-iop32x/iq31244.c                             |    1 
 arch/arm/mach-iop32x/iq80321.c                             |    1 
 arch/arm/mach-iop32x/n2100.c                               |    1 
 arch/arm/mach-iop33x/iq80331.c                             |    1 
 arch/arm/mach-iop33x/iq80332.c                             |    1 
 arch/arm/mach-ixp2000/enp2611.c                            |    1 
 arch/arm/mach-ixp2000/ixdp2400.c                           |    1 
 arch/arm/mach-ixp2000/ixdp2800.c                           |    1 
 arch/arm/mach-ixp2000/ixdp2x00.c                           |    1 
 arch/arm/mach-ixp2000/ixdp2x01.c                           |    1 
 arch/arm/mach-ixp2000/pci.c                                |    1 
 arch/arm/mach-ixp23xx/pci.c                                |    1 
 arch/arm/mach-ixp4xx/avila-setup.c                         |    1 
 arch/arm/mach-ixp4xx/coyote-setup.c                        |    1 
 arch/arm/mach-ixp4xx/gateway7001-setup.c                   |    1 
 arch/arm/mach-ixp4xx/gtwx5715-setup.c                      |    1 
 arch/arm/mach-ixp4xx/ixdp425-setup.c                       |    1 
 arch/arm/mach-ixp4xx/ixp4xx_npe.c                          |    1 
 arch/arm/mach-ixp4xx/wg302v2-setup.c                       |    1 
 arch/arm/mach-kirkwood/pcie.c                              |    1 
 arch/arm/mach-lh7a40x/clcd.c                               |    1 
 arch/arm/mach-mx3/Kconfig                                  |   10 
 arch/arm/mach-mx3/clock-imx31.c                            |    5 
 arch/arm/mach-mx3/devices.c                                |   19 
 arch/arm/mach-mx3/devices.h                                |    3 
 arch/arm/mach-mx3/mach-armadillo5x0.c                      |  166 
 arch/arm/mach-mx3/mach-mx31_3ds.c                          |  116 
 arch/arm/mach-mx3/mach-mx31moboard.c                       |    1 
 arch/arm/mach-mx3/mach-pcm037.c                            |    2 
 arch/arm/mach-mx3/mx31lite-db.c                            |    2 
 arch/arm/mach-mx3/mx31moboard-devboard.c                   |    1 
 arch/arm/mach-mx3/mx31moboard-marxbot.c                    |    1 
 arch/arm/mach-mx5/clock-mx51.c                             |    2 
 arch/arm/mach-mx5/cpu.c                                    |   53 
 arch/arm/mach-mx5/mm.c                                     |   32 
 arch/arm/mach-netx/fb.c                                    |    1 
 arch/arm/mach-netx/xc.c                                    |    1 
 arch/arm/mach-nomadik/gpio.c                               |    1 
 arch/arm/mach-ns9xxx/plat-serial8250.c                     |    1 
 arch/arm/mach-ns9xxx/processor-ns9360.c                    |    1 
 arch/arm/mach-omap1/mcbsp.c                                |    1 
 arch/arm/mach-omap2/clkt2xxx_virt_prcm_set.c               |    1 
 arch/arm/mach-omap2/iommu2.c                               |    1 
 arch/arm/mach-omap2/mcbsp.c                                |    1 
 arch/arm/mach-omap2/mux.c                                  |    1 
 arch/arm/mach-omap2/pm-debug.c                             |    1 
 arch/arm/mach-omap2/pm34xx.c                               |    1 
 arch/arm/mach-orion5x/pci.c                                |    1 
 arch/arm/mach-pnx4008/dma.c                                |    1 
 arch/arm/mach-pnx4008/pm.c                                 |    1 
 arch/arm/mach-pxa/corgi_ssp.c                              |    1 
 arch/arm/mach-pxa/cpufreq-pxa3xx.c                         |    1 
 arch/arm/mach-pxa/mioa701.c                                |    1 
 arch/arm/mach-pxa/pm.c                                     |    1 
 arch/arm/mach-pxa/viper.c                                  |    1 
 arch/arm/mach-realview/core.c                              |    1 
 arch/arm/mach-rpc/dma.c                                    |    1 
 arch/arm/mach-s3c64xx/dma.c                                |    1 
 arch/arm/mach-sa1100/jornada720_ssp.c                      |    1 
 arch/arm/mach-sa1100/neponset.c                            |    1 
 arch/arm/mach-u300/dummyspichip.c                          |    1 
 arch/arm/mach-u300/mmc.c                                   |    1 
 arch/arm/mach-versatile/core.c                             |    1 
 arch/arm/mach-versatile/pci.c                              |    1 
 arch/arm/mach-w90x900/dev.c                                |    1 
 arch/arm/mm/Kconfig                                        |   13 
 arch/arm/mm/cache-l2x0.c                                   |   10 
 arch/arm/mm/dma-mapping.c                                  |    2 
 arch/arm/mm/fault-armv.c                                   |    1 
 arch/arm/mm/init.c                                         |    1 
 arch/arm/mm/mmu.c                                          |    4 
 arch/arm/mm/pgd.c                                          |    1 
 arch/arm/plat-mxc/audmux-v2.c                              |    1 
 arch/arm/plat-mxc/include/mach/board-mx31_3ds.h            |   59 
 arch/arm/plat-mxc/include/mach/board-mx31pdk.h             |   59 
 arch/arm/plat-mxc/include/mach/mx51.h                      |   33 
 arch/arm/plat-mxc/include/mach/uncompress.h                |    4 
 arch/arm/plat-mxc/pwm.c                                    |    1 
 arch/arm/plat-omap/devices.c                               |    1 
 arch/arm/plat-omap/dma.c                                   |    1 
 arch/arm/plat-omap/iommu-debug.c                           |    1 
 arch/arm/plat-omap/iommu.c                                 |    1 
 arch/arm/plat-omap/iovmm.c                                 |    1 
 arch/arm/plat-omap/mailbox.c                               |    1 
 arch/arm/plat-omap/mcbsp.c                                 |    1 
 arch/arm/plat-omap/omap_device.c                           |    1 
 arch/arm/plat-pxa/dma.c                                    |    1 
 arch/arm/plat-pxa/pwm.c                                    |    1 
 arch/arm/plat-s3c24xx/cpu-freq.c                           |    1 
 arch/arm/plat-s3c24xx/devs.c                               |    1 
 arch/arm/plat-s3c24xx/s3c2410-iotiming.c                   |    1 
 arch/arm/plat-s3c24xx/s3c2412-iotiming.c                   |    1 
 arch/arm/plat-samsung/adc.c                                |    1 
 arch/arm/plat-samsung/dev-fb.c                             |    1 
 arch/arm/plat-samsung/dev-i2c0.c                           |    1 
 arch/arm/plat-samsung/dev-i2c1.c                           |    1 
 arch/arm/plat-samsung/dev-nand.c                           |    1 
 arch/arm/plat-samsung/dev-usb.c                            |    1 
 arch/arm/plat-samsung/pm-check.c                           |    1 
 arch/arm/plat-samsung/pwm.c                                |    1 
 arch/arm/plat-stmp3xxx/dma.c                               |    1 
 arch/arm/vfp/vfpmodule.c                                   |    2 
 arch/avr32/kernel/process.c                                |    1 
 arch/avr32/mach-at32ap/at32ap700x.c                        |    1 
 arch/avr32/mach-at32ap/extint.c                            |    1 
 arch/avr32/mach-at32ap/hsmc.c                              |    1 
 arch/avr32/mm/dma-coherent.c                               |    1 
 arch/avr32/mm/init.c                                       |    1 
 arch/avr32/mm/ioremap.c                                    |    1 
 arch/blackfin/include/asm/mmu_context.h                    |    2 
 arch/blackfin/kernel/ipipe.c                               |    1 
 arch/blackfin/kernel/process.c                             |    1 
 arch/blackfin/mach-common/pm.c                             |    1 
 arch/blackfin/mach-common/smp.c                            |    1 
 arch/blackfin/mm/init.c                                    |    1 
 arch/blackfin/mm/isram-driver.c                            |    1 
 arch/blackfin/mm/sram-alloc.c                              |    1 
 arch/cris/arch-v10/drivers/i2c.c                           |    1 
 arch/cris/arch-v10/drivers/sync_serial.c                   |    1 
 arch/cris/arch-v10/kernel/process.c                        |    2 
 arch/cris/arch-v32/drivers/i2c.c                           |    1 
 arch/cris/arch-v32/drivers/pci/dma.c                       |    1 
 arch/cris/arch-v32/drivers/sync_serial.c                   |    1 
 arch/cris/arch-v32/kernel/process.c                        |    2 
 arch/cris/arch-v32/kernel/signal.c                         |    1 
 arch/cris/kernel/irq.c                                     |    1 
 arch/cris/kernel/module.c                                  |    1 
 arch/cris/kernel/profile.c                                 |    1 
 arch/cris/mm/init.c                                        |    1 
 arch/frv/include/asm/segment.h                             |    6 
 arch/frv/include/asm/uaccess.h                             |    2 
 arch/frv/kernel/irq.c                                      |    1 
 arch/frv/kernel/sysctl.c                                   |    1 
 arch/frv/mb93090-mb00/pci-dma.c                            |    1 
 arch/frv/mb93090-mb00/pci-irq.c                            |    1 
 arch/frv/mb93090-mb00/pci-vdk.c                            |    1 
 arch/frv/mm/dma-alloc.c                                    |    1 
 arch/frv/mm/init.c                                         |    1 
 arch/frv/mm/pgalloc.c                                      |    2 
 arch/h8300/kernel/process.c                                |    2 
 arch/h8300/mm/init.c                                       |    2 
 arch/h8300/mm/kmap.c                                       |    1 
 arch/h8300/mm/memory.c                                     |    1 
 arch/ia64/include/asm/dmi.h                                |    1 
 arch/ia64/kernel/acpi-ext.c                                |    1 
 arch/ia64/kernel/acpi.c                                    |    1 
 arch/ia64/kernel/cpufreq/acpi-cpufreq.c                    |    1 
 arch/ia64/kernel/efi.c                                     |    1 
 arch/ia64/kernel/iosapic.c                                 |    1 
 arch/ia64/kernel/irq_ia64.c                                |    1 
 arch/ia64/kernel/mca.c                                     |    1 
 arch/ia64/kernel/mca_drv.c                                 |    1 
 arch/ia64/kernel/pci-swiotlb.c                             |    1 
 arch/ia64/kernel/perfmon.c                                 |    1 
 arch/ia64/kernel/process.c                                 |    2 
 arch/ia64/kernel/ptrace.c                                  |    1 
 arch/ia64/kernel/topology.c                                |    1 
 arch/ia64/kernel/uncached.c                                |    2 
 arch/ia64/kvm/kvm-ia64.c                                   |    2 
 arch/ia64/mm/discontig.c                                   |    1 
 arch/ia64/mm/hugetlbpage.c                                 |    1 
 arch/ia64/mm/tlb.c                                         |    1 
 arch/ia64/sn/kernel/bte.c                                  |    1 
 arch/ia64/sn/kernel/io_acpi_init.c                         |    1 
 arch/ia64/sn/kernel/io_common.c                            |    1 
 arch/ia64/sn/kernel/io_init.c                              |    1 
 arch/ia64/sn/kernel/irq.c                                  |    1 
 arch/ia64/sn/kernel/msi_sn.c                               |    1 
 arch/ia64/sn/pci/pci_dma.c                                 |    1 
 arch/ia64/sn/pci/pcibr/pcibr_provider.c                    |    1 
 arch/ia64/sn/pci/tioca_provider.c                          |    1 
 arch/ia64/sn/pci/tioce_provider.c                          |    1 
 arch/ia64/xen/grant-table.c                                |    1 
 arch/m32r/kernel/process.c                                 |    2 
 arch/m32r/mm/init.c                                        |    1 
 arch/m68k/bvme6000/rtc.c                                   |    1 
 arch/m68k/kernel/dma.c                                     |    1 
 arch/m68k/kernel/process.c                                 |    2 
 arch/m68k/mac/misc.c                                       |    1 
 arch/m68k/mm/init.c                                        |    1 
 arch/m68k/mm/memory.c                                      |    2 
 arch/m68k/mm/motorola.c                                    |    1 
 arch/m68k/mvme16x/rtc.c                                    |    1 
 arch/m68k/sun3/sun3dvma.c                                  |    1 
 arch/m68k/sun3x/dvma.c                                     |    1 
 arch/m68knommu/kernel/dma.c                                |    1 
 arch/m68knommu/kernel/process.c                            |    2 
 arch/m68knommu/mm/init.c                                   |    2 
 arch/m68knommu/mm/kmap.c                                   |    1 
 arch/m68knommu/mm/memory.c                                 |    1 
 arch/microblaze/Kconfig                                    |    3 
 arch/microblaze/Makefile                                   |    4 
 arch/microblaze/boot/Makefile                              |    6 
 arch/microblaze/include/asm/futex.h                        |    2 
 arch/microblaze/include/asm/io.h                           |    5 
 arch/microblaze/include/asm/processor.h                    |    1 
 arch/microblaze/include/asm/segment.h                      |   49 
 arch/microblaze/include/asm/thread_info.h                  |    5 
 arch/microblaze/include/asm/tlbflush.h                     |    3 
 arch/microblaze/include/asm/uaccess.h                      |  449 -
 arch/microblaze/kernel/cpu/cpuinfo.c                       |    1 
 arch/microblaze/kernel/dma.c                               |    3 
 arch/microblaze/kernel/ftrace.c                            |   12 
 arch/microblaze/kernel/head.S                              |   12 
 arch/microblaze/kernel/hw_exception_handler.S              |  112 
 arch/microblaze/kernel/misc.S                              |   15 
 arch/microblaze/kernel/module.c                            |    1 
 arch/microblaze/kernel/of_platform.c                       |    1 
 arch/microblaze/kernel/process.c                           |   10 
 arch/microblaze/kernel/ptrace.c                            |    1 
 arch/microblaze/kernel/setup.c                             |   24 
 arch/microblaze/kernel/sys_microblaze.c                    |    1 
 arch/microblaze/kernel/traps.c                             |    6 
 arch/microblaze/lib/Makefile                               |    3 
 arch/microblaze/lib/fastcopy.S                             |    6 
 arch/microblaze/lib/memcpy.c                               |    2 
 arch/microblaze/lib/memset.c                               |   15 
 arch/microblaze/lib/uaccess.c                              |   48 
 arch/microblaze/lib/uaccess_old.S                          |   45 
 arch/microblaze/mm/consistent.c                            |    1 
 arch/microblaze/mm/fault.c                                 |   24 
 arch/microblaze/mm/init.c                                  |   10 
 arch/microblaze/mm/pgtable.c                               |    2 
 arch/microblaze/pci/pci-common.c                           |    1 
 arch/microblaze/pci/pci_32.c                               |    1 
 arch/mips/alchemy/devboards/db1200/setup.c                 |   40 
 arch/mips/ar7/platform.c                                   |    3 
 arch/mips/bcm63xx/boards/board_bcm963xx.c                  |  231 
 arch/mips/bcm63xx/cpu.c                                    |    5 
 arch/mips/bcm63xx/dev-uart.c                               |   66 
 arch/mips/bcm63xx/gpio.c                                   |    4 
 arch/mips/cavium-octeon/setup.c                            |   82 
 arch/mips/cavium-octeon/smp.c                              |    8 
 arch/mips/configs/bigsur_defconfig                         |  680 +-
 arch/mips/include/asm/abi.h                                |    6 
 arch/mips/include/asm/elf.h                                |    5 
 arch/mips/include/asm/fpu_emulator.h                       |    6 
 arch/mips/include/asm/mach-bcm63xx/bcm63xx_cpu.h           |   15 
 arch/mips/include/asm/mach-bcm63xx/bcm63xx_dev_uart.h      |    6 
 arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h          |    4 
 arch/mips/include/asm/mach-bcm63xx/board_bcm963xx.h        |    2 
 arch/mips/include/asm/mach-bcm63xx/cpu-feature-overrides.h |    2 
 arch/mips/include/asm/mach-sibyte/war.h                    |    6 
 arch/mips/include/asm/mmu.h                                |    5 
 arch/mips/include/asm/mmu_context.h                        |    2 
 arch/mips/include/asm/page.h                               |    6 
 arch/mips/include/asm/processor.h                          |   11 
 arch/mips/include/asm/stackframe.h                         |   19 
 arch/mips/include/asm/uasm.h                               |    2 
 arch/mips/include/asm/vdso.h                               |   29 
 arch/mips/jazz/jazzdma.c                                   |    1 
 arch/mips/kernel/Makefile                                  |    2 
 arch/mips/kernel/cpufreq/loongson2_clock.c                 |    4 
 arch/mips/kernel/irq.c                                     |    1 
 arch/mips/kernel/linux32.c                                 |    2 
 arch/mips/kernel/process.c                                 |    8 
 arch/mips/kernel/rtlx.c                                    |    1 
 arch/mips/kernel/signal-common.h                           |    5 
 arch/mips/kernel/signal.c                                  |   86 
 arch/mips/kernel/signal32.c                                |   55 
 arch/mips/kernel/signal_n32.c                              |   26 
 arch/mips/kernel/smtc.c                                    |    3 
 arch/mips/kernel/syscall.c                                 |    8 
 arch/mips/kernel/traps.c                                   |    2 
 arch/mips/kernel/vdso.c                                    |  112 
 arch/mips/lib/delay.c                                      |    4 
 arch/mips/lib/libgcc.h                                     |    3 
 arch/mips/mipssim/sim_int.c                                |    1 
 arch/mips/mm/cache.c                                       |    2 
 arch/mips/mm/dma-default.c                                 |    1 
 arch/mips/mm/hugetlbpage.c                                 |    1 
 arch/mips/mm/init.c                                        |    1 
 arch/mips/mm/ioremap.c                                     |    1 
 arch/mips/mm/tlbex.c                                       |   22 
 arch/mips/mm/uasm.c                                        |   23 
 arch/mips/mti-malta/malta-int.c                            |    1 
 arch/mips/nxp/pnx833x/common/reset.c                       |    1 
 arch/mips/nxp/pnx8550/common/int.c                         |    1 
 arch/mips/nxp/pnx8550/common/proc.c                        |    1 
 arch/mips/nxp/pnx8550/common/reset.c                       |    1 
 arch/mips/pci/ops-loongson2.c                              |   10 
 arch/mips/pci/ops-titan-ht.c                               |    1 
 arch/mips/pmc-sierra/msp71xx/msp_prom.c                    |    1 
 arch/mips/pmc-sierra/yosemite/ht.c                         |    1 
 arch/mips/pmc-sierra/yosemite/irq.c                        |    1 
 arch/mips/powertv/asic/asic_devices.c                      |    1 
 arch/mips/powertv/asic/asic_int.c                          |    1 
 arch/mips/rb532/irq.c                                      |    1 
 arch/mips/sgi-ip27/ip27-irq.c                              |    1 
 arch/mips/sgi-ip32/ip32-irq.c                              |    1 
 arch/mips/sibyte/bcm1480/irq.c                             |    1 
 arch/mips/sibyte/common/sb_tbprof.c                        |    1 
 arch/mips/sibyte/sb1250/irq.c                              |    1 
 arch/mips/sibyte/sb1250/setup.c                            |   15 
 arch/mips/txx9/generic/pci.c                               |    1 
 arch/mips/txx9/generic/setup.c                             |    1 
 arch/mips/txx9/generic/spi_eeprom.c                        |    1 
 arch/mips/txx9/rbtx4939/setup.c                            |    1 
 arch/mn10300/kernel/process.c                              |    2 
 arch/mn10300/kernel/setup.c                                |    1 
 arch/mn10300/mm/dma-alloc.c                                |    1 
 arch/mn10300/mm/init.c                                     |    2 
 arch/mn10300/mm/pgtable.c                                  |    2 
 arch/mn10300/unit-asb2305/pci-irq.c                        |    1 
 arch/parisc/hpux/fs.c                                      |    2 
 arch/parisc/kernel/module.c                                |    1 
 arch/parisc/kernel/pci-dma.c                               |    2 
 arch/parisc/kernel/pci.c                                   |    1 
 arch/parisc/kernel/process.c                               |    1 
 arch/parisc/kernel/signal32.c                              |    1 
 arch/parisc/kernel/smp.c                                   |    1 
 arch/parisc/mm/init.c                                      |    1 
 arch/powerpc/kernel/cacheinfo.c                            |    1 
 arch/powerpc/kernel/dma.c                                  |    1 
 arch/powerpc/kernel/ibmebus.c                              |    1 
 arch/powerpc/kernel/kprobes.c                              |    1 
 arch/powerpc/kernel/lparcfg.c                              |    1 
 arch/powerpc/kernel/misc.S                                 |    2 
 arch/powerpc/kernel/of_platform.c                          |    1 
 arch/powerpc/kernel/pci-common.c                           |    1 
 arch/powerpc/kernel/pci_32.c                               |    1 
 arch/powerpc/kernel/pci_dn.c                               |    1 
 arch/powerpc/kernel/proc_powerpc.c                         |    1 
 arch/powerpc/kernel/rtas.c                                 |    1 
 arch/powerpc/kernel/rtas_flash.c                           |    1 
 arch/powerpc/kernel/rtasd.c                                |    1 
 arch/powerpc/kernel/smp-tbsync.c                           |    1 
 arch/powerpc/kernel/softemu8xx.c                           |    1 
 arch/powerpc/kernel/sys_ppc32.c                            |    1 
 arch/powerpc/kernel/traps.c                                |    1 
 arch/powerpc/kernel/vio.c                                  |    1 
 arch/powerpc/kvm/44x.c                                     |    1 
 arch/powerpc/kvm/book3s.c                                  |    1 
 arch/powerpc/kvm/booke.c                                   |    1 
 arch/powerpc/kvm/e500.c                                    |    1 
 arch/powerpc/kvm/e500_tlb.c                                |    1 
 arch/powerpc/kvm/powerpc.c                                 |    1 
 arch/powerpc/lib/devres.c                                  |    1 
 arch/powerpc/mm/dma-noncoherent.c                          |    1 
 arch/powerpc/mm/hugetlbpage.c                              |    1 
 arch/powerpc/mm/init_32.c                                  |    1 
 arch/powerpc/mm/init_64.c                                  |    1 
 arch/powerpc/mm/mem.c                                      |    1 
 arch/powerpc/mm/mmu_context_hash64.c                       |    1 
 arch/powerpc/mm/mmu_context_nohash.c                       |    1 
 arch/powerpc/mm/pgtable.c                                  |    1 
 arch/powerpc/mm/pgtable_32.c                               |    1 
 arch/powerpc/mm/pgtable_64.c                               |    1 
 arch/powerpc/mm/subpage-prot.c                             |    1 
 arch/powerpc/oprofile/cell/spu_task_sync.c                 |    1 
 arch/powerpc/oprofile/cell/vma_map.c                       |    1 
 arch/powerpc/platforms/44x/warp.c                          |    1 
 arch/powerpc/platforms/52xx/mpc52xx_gpio.c                 |    1 
 arch/powerpc/platforms/52xx/mpc52xx_gpt.c                  |    1 
 arch/powerpc/platforms/52xx/mpc52xx_lpbfifo.c              |    2 
 arch/powerpc/platforms/82xx/ep8248e.c                      |    1 
 arch/powerpc/platforms/82xx/pq2ads-pci-pic.c               |    1 
 arch/powerpc/platforms/83xx/mcu_mpc8349emitx.c             |    1 
 arch/powerpc/platforms/86xx/gef_gpio.c                     |    1 
 arch/powerpc/platforms/8xx/m8xx_setup.c                    |    1 
 arch/powerpc/platforms/cell/axon_msi.c                     |    1 
 arch/powerpc/platforms/cell/celleb_pci.c                   |    1 
 arch/powerpc/platforms/cell/celleb_scc_pciex.c             |    1 
 arch/powerpc/platforms/cell/iommu.c                        |    1 
 arch/powerpc/platforms/cell/ras.c                          |    1 
 arch/powerpc/platforms/cell/setup.c                        |    1 
 arch/powerpc/platforms/cell/spider-pci.c                   |    1 
 arch/powerpc/platforms/cell/spu_manage.c                   |    1 
 arch/powerpc/platforms/cell/spu_priv1_mmio.c               |    1 
 arch/powerpc/platforms/cell/spufs/coredump.c               |    1 
 arch/powerpc/platforms/cell/spufs/file.c                   |    1 
 arch/powerpc/platforms/cell/spufs/lscsa_alloc.c            |    1 
 arch/powerpc/platforms/cell/spufs/sched.c                  |    1 
 arch/powerpc/platforms/cell/spufs/syscalls.c               |    1 
 arch/powerpc/platforms/chrp/nvram.c                        |    1 
 arch/powerpc/platforms/chrp/setup.c                        |    1 
 arch/powerpc/platforms/iseries/iommu.c                     |    1 
 arch/powerpc/platforms/iseries/mf.c                        |    1 
 arch/powerpc/platforms/iseries/pci.c                       |    1 
 arch/powerpc/platforms/iseries/vio.c                       |    2 
 arch/powerpc/platforms/iseries/viopath.c                   |    1 
 arch/powerpc/platforms/maple/setup.c                       |    1 
 arch/powerpc/platforms/pasemi/dma_lib.c                    |    1 
 arch/powerpc/platforms/pasemi/gpio_mdio.c                  |    1 
 arch/powerpc/platforms/pasemi/setup.c                      |    1 
 arch/powerpc/platforms/powermac/cpufreq_32.c               |    1 
 arch/powerpc/platforms/powermac/cpufreq_64.c               |    1 
 arch/powerpc/platforms/powermac/low_i2c.c                  |    1 
 arch/powerpc/platforms/powermac/nvram.c                    |    1 
 arch/powerpc/platforms/powermac/pfunc_core.c               |    1 
 arch/powerpc/platforms/powermac/setup.c                    |    1 
 arch/powerpc/platforms/ps3/device-init.c                   |    1 
 arch/powerpc/platforms/ps3/mm.c                            |    1 
 arch/powerpc/platforms/ps3/os-area.c                       |    1 
 arch/powerpc/platforms/ps3/spu.c                           |    1 
 arch/powerpc/platforms/ps3/system-bus.c                    |    1 
 arch/powerpc/platforms/pseries/cmm.c                       |    1 
 arch/powerpc/platforms/pseries/dlpar.c                     |    1 
 arch/powerpc/platforms/pseries/dtl.c                       |    1 
 arch/powerpc/platforms/pseries/eeh_cache.c                 |    1 
 arch/powerpc/platforms/pseries/eeh_event.c                 |    1 
 arch/powerpc/platforms/pseries/nvram.c                     |    1 
 arch/powerpc/platforms/pseries/phyp_dump.c                 |    1 
 arch/powerpc/platforms/pseries/ras.c                       |    1 
 arch/powerpc/platforms/pseries/reconfig.c                  |    1 
 arch/powerpc/platforms/pseries/scanlog.c                   |    1 
 arch/powerpc/platforms/pseries/setup.c                     |    1 
 arch/powerpc/sysdev/cpm1.c                                 |    1 
 arch/powerpc/sysdev/cpm_common.c                           |    1 
 arch/powerpc/sysdev/dart_iommu.c                           |    2 
 arch/powerpc/sysdev/fsl_gtm.c                              |    1 
 arch/powerpc/sysdev/fsl_msi.c                              |    1 
 arch/powerpc/sysdev/fsl_pci.c                              |    1 
 arch/powerpc/sysdev/fsl_rio.c                              |    1 
 arch/powerpc/sysdev/mpc8xxx_gpio.c                         |    1 
 arch/powerpc/sysdev/mpic.c                                 |    1 
 arch/powerpc/sysdev/msi_bitmap.c                           |    1 
 arch/powerpc/sysdev/of_rtc.c                               |    1 
 arch/powerpc/sysdev/pmi.c                                  |    1 
 arch/powerpc/sysdev/ppc4xx_gpio.c                          |    1 
 arch/powerpc/sysdev/ppc4xx_pci.c                           |    1 
 arch/powerpc/sysdev/qe_lib/gpio.c                          |    1 
 arch/powerpc/sysdev/qe_lib/ucc.c                           |    1 
 arch/powerpc/sysdev/simple_gpio.c                          |    1 
 arch/powerpc/sysdev/tsi108_pci.c                           |    1 
 arch/s390/appldata/appldata_mem.c                          |    1 
 arch/s390/appldata/appldata_net_sum.c                      |    1 
 arch/s390/crypto/prng.c                                    |    1 
 arch/s390/defconfig                                        |   40 
 arch/s390/hypfs/hypfs_diag.c                               |    1 
 arch/s390/hypfs/inode.c                                    |    2 
 arch/s390/include/asm/pgtable.h                            |    6 
 arch/s390/kernel/compat_linux.c                            |    2 
 arch/s390/kernel/early.c                                   |    3 
 arch/s390/kernel/entry.S                                   |    8 
 arch/s390/kernel/entry64.S                                 |    8 
 arch/s390/kernel/ipl.c                                     |    1 
 arch/s390/kernel/kprobes.c                                 |    1 
 arch/s390/kernel/process.c                                 |    2 
 arch/s390/kernel/setup.c                                   |    1 
 arch/s390/kernel/smp.c                                     |    1 
 arch/s390/kernel/sysinfo.c                                 |    1 
 arch/s390/kernel/time.c                                    |    1 
 arch/s390/kernel/topology.c                                |    3 
 arch/s390/kvm/interrupt.c                                  |    1 
 arch/s390/kvm/priv.c                                       |    1 
 arch/s390/kvm/sigp.c                                       |    1 
 arch/s390/mm/cmm.c                                         |    1 
 arch/s390/mm/init.c                                        |    1 
 arch/s390/mm/page-states.c                                 |    1 
 arch/s390/mm/pgtable.c                                     |    2 
 arch/s390/mm/vmem.c                                        |   12 
 arch/score/kernel/sys_score.c                              |    1 
 arch/score/mm/init.c                                       |    1 
 arch/sh/configs/ecovec24_defconfig                         |  236 
 arch/sh/drivers/dma/dma-api.c                              |    1 
 arch/sh/drivers/dma/dmabrg.c                               |    1 
 arch/sh/drivers/heartbeat.c                                |    1 
 arch/sh/drivers/pci/pcie-sh7786.c                          |    1 
 arch/sh/drivers/push-switch.c                              |    1 
 arch/sh/include/asm/elf.h                                  |    6 
 arch/sh/include/cpu-sh4/cpu/mmu_context.h                  |    2 
 arch/sh/kernel/cpu/fpu.c                                   |    1 
 arch/sh/kernel/cpu/hwblk.c                                 |    1 
 arch/sh/kernel/cpufreq.c                                   |    4 
 arch/sh/kernel/dwarf.c                                     |    1 
 arch/sh/kernel/kprobes.c                                   |    1 
 arch/sh/kernel/process.c                                   |    1 
 arch/sh/kernel/process_32.c                                |    1 
 arch/sh/kernel/process_64.c                                |    1 
 arch/sh/kernel/ptrace_32.c                                 |    1 
 arch/sh/kernel/return_address.c                            |    3 
 arch/sh/kernel/smp.c                                       |    1 
 arch/sh/kernel/vsyscall/vsyscall.c                         |    1 
 arch/sh/mm/consistent.c                                    |    1 
 arch/sh/mm/hugetlbpage.c                                   |    1 
 arch/sh/mm/init.c                                          |    1 
 arch/sh/mm/ioremap.c                                       |    1 
 arch/sh/mm/ioremap_fixed.c                                 |    1 
 arch/sh/mm/pgtable.c                                       |    1 
 arch/sh/mm/pmb.c                                           |    1 
 arch/sh/mm/tlb-pteaex.c                                    |   28 
 arch/sh/mm/tlb-sh3.c                                       |   19 
 arch/sh/mm/tlb-sh4.c                                       |   28 
 arch/sh/mm/tlb-urb.c                                       |   22 
 arch/sh/mm/tlbflush_32.c                                   |   28 
 arch/sparc/configs/sparc64_defconfig                       |   28 
 arch/sparc/kernel/central.c                                |    1 
 arch/sparc/kernel/cpumap.c                                 |    1 
 arch/sparc/kernel/helpers.S                                |   75 
 arch/sparc/kernel/hvapi.c                                  |    1 
 arch/sparc/kernel/iommu.c                                  |    1 
 arch/sparc/kernel/kprobes.c                                |    1 
 arch/sparc/kernel/led.c                                    |    1 
 arch/sparc/kernel/leon_kernel.c                            |    1 
 arch/sparc/kernel/leon_smp.c                               |    1 
 arch/sparc/kernel/module.c                                 |    2 
 arch/sparc/kernel/of_device_common.c                       |    1 
 arch/sparc/kernel/pci_msi.c                                |    1 
 arch/sparc/kernel/process_32.c                             |    2 
 arch/sparc/kernel/ptrace_32.c                              |    4 
 arch/sparc/kernel/ptrace_64.c                              |    4 
 arch/sparc/kernel/setup_64.c                               |    1 
 arch/sparc/kernel/smp_64.c                                 |    1 
 arch/sparc/kernel/sun4c_irq.c                              |    1 
 arch/sparc/kernel/sun4m_irq.c                              |    1 
 arch/sparc/kernel/sys_sparc32.c                            |    2 
 arch/sparc/kernel/traps_64.c                               |    1 
 arch/sparc/kernel/vio.c                                    |    1 
 arch/sparc/mm/hugetlbpage.c                                |    1 
 arch/sparc/mm/init_32.c                                    |    1 
 arch/sparc/mm/init_64.c                                    |    4 
 arch/sparc/mm/srmmu.c                                      |    2 
 arch/sparc/mm/sun4c.c                                      |    1 
 arch/sparc/mm/tsb.c                                        |    1 
 arch/um/drivers/net_kern.c                                 |    1 
 arch/um/drivers/port_kern.c                                |    1 
 arch/um/drivers/ubd_kern.c                                 |    1 
 arch/um/kernel/exec.c                                      |    1 
 arch/um/kernel/irq.c                                       |    1 
 arch/um/kernel/mem.c                                       |    2 
 arch/um/kernel/process.c                                   |    2 
 arch/um/kernel/reboot.c                                    |    1 
 arch/um/kernel/skas/mmu.c                                  |    1 
 arch/um/os-Linux/helper.c                                  |    1 
 arch/um/sys-i386/ldt.c                                     |    1 
 arch/x86/Kconfig                                           |    4 
 arch/x86/crypto/fpu.c                                      |    1 
 arch/x86/ia32/ia32_aout.c                                  |    1 
 arch/x86/ia32/sys_ia32.c                                   |    1 
 arch/x86/include/asm/pgtable_32.h                          |    1 
 arch/x86/kernel/acpi/boot.c                                |    1 
 arch/x86/kernel/alternative.c                              |    1 
 arch/x86/kernel/amd_iommu.c                                |    2 
 arch/x86/kernel/amd_iommu_init.c                           |    2 
 arch/x86/kernel/apb_timer.c                                |    1 
 arch/x86/kernel/apic/apic.c                                |    2 
 arch/x86/kernel/apic/es7000_32.c                           |    1 
 arch/x86/kernel/apic/io_apic.c                             |    1 
 arch/x86/kernel/apic/nmi.c                                 |    1 
 arch/x86/kernel/apic/x2apic_uv_x.c                         |    1 
 arch/x86/kernel/bootflag.c                                 |    1 
 arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c                 |    1 
 arch/x86/kernel/cpu/cpufreq/elanfreq.c                     |    1 
 arch/x86/kernel/cpu/cpufreq/gx-suspmod.c                   |    1 
 arch/x86/kernel/cpu/cpufreq/longrun.c                      |    1 
 arch/x86/kernel/cpu/cpufreq/p4-clockmod.c                  |    1 
 arch/x86/kernel/cpu/cpufreq/pcc-cpufreq.c                  |    1 
 arch/x86/kernel/cpu/cpufreq/powernow-k6.c                  |    1 
 arch/x86/kernel/cpu/cpufreq/speedstep-centrino.c           |    1 
 arch/x86/kernel/cpu/cpufreq/speedstep-ich.c                |    1 
 arch/x86/kernel/cpu/cpufreq/speedstep-lib.c                |    1 
 arch/x86/kernel/cpu/cpufreq/speedstep-smi.c                |    1 
 arch/x86/kernel/cpu/mcheck/mce-inject.c                    |    1 
 arch/x86/kernel/cpu/mcheck/mce.c                           |    1 
 arch/x86/kernel/cpu/mcheck/mce_amd.c                       |    1 
 arch/x86/kernel/cpu/mcheck/mce_intel.c                     |    1 
 arch/x86/kernel/cpu/mtrr/generic.c                         |    1 
 arch/x86/kernel/cpu/mtrr/if.c                              |    1 
 arch/x86/kernel/cpu/perf_event.c                           |   55 
 arch/x86/kernel/cpu/perf_event_amd.c                       |   80 
 arch/x86/kernel/cpu/perf_event_intel.c                     |    1 
 arch/x86/kernel/cpuid.c                                    |    1 
 arch/x86/kernel/crash_dump_32.c                            |    1 
 arch/x86/kernel/dumpstack.h                                |    5 
 arch/x86/kernel/e820.c                                     |   24 
 arch/x86/kernel/hpet.c                                     |   10 
 arch/x86/kernel/i387.c                                     |    1 
 arch/x86/kernel/i8259.c                                    |    1 
 arch/x86/kernel/irqinit.c                                  |    1 
 arch/x86/kernel/k8.c                                       |    2 
 arch/x86/kernel/kdebugfs.c                                 |    1 
 arch/x86/kernel/kgdb.c                                     |    2 
 arch/x86/kernel/ldt.c                                      |    1 
 arch/x86/kernel/machine_kexec_64.c                         |    1 
 arch/x86/kernel/mca_32.c                                   |    1 
 arch/x86/kernel/module.c                                   |    1 
 arch/x86/kernel/mpparse.c                                  |    4 
 arch/x86/kernel/msr.c                                      |    1 
 arch/x86/kernel/pci-dma.c                                  |    1 
 arch/x86/kernel/pci-gart_64.c                              |    1 
 arch/x86/kernel/pci-nommu.c                                |    1 
 arch/x86/kernel/ptrace.c                                   |    1 
 arch/x86/kernel/setup.c                                    |   15 
 arch/x86/kernel/smp.c                                      |    1 
 arch/x86/kernel/smpboot.c                                  |    5 
 arch/x86/kernel/tlb_uv.c                                   |    1 
 arch/x86/kernel/uv_irq.c                                   |    1 
 arch/x86/kernel/uv_time.c                                  |    1 
 arch/x86/kernel/vmi_32.c                                   |    1 
 arch/x86/kvm/i8254.c                                       |    1 
 arch/x86/kvm/i8259.c                                       |    1 
 arch/x86/kvm/lapic.c                                       |    1 
 arch/x86/kvm/mmu.c                                         |    1 
 arch/x86/kvm/svm.c                                         |    1 
 arch/x86/kvm/vmx.c                                         |    1 
 arch/x86/kvm/x86.c                                         |    1 
 arch/x86/mm/hugetlbpage.c                                  |    1 
 arch/x86/mm/init.c                                         |    1 
 arch/x86/mm/init_32.c                                      |    2 
 arch/x86/mm/init_64.c                                      |    1 
 arch/x86/mm/kmmio.c                                        |    1 
 arch/x86/mm/mmio-mod.c                                     |    1 
 arch/x86/mm/pageattr.c                                     |    2 
 arch/x86/mm/pat.c                                          |    2 
 arch/x86/mm/pgtable.c                                      |    1 
 arch/x86/mm/pgtable_32.c                                   |    1 
 arch/x86/pci/acpi.c                                        |    1 
 arch/x86/pci/common.c                                      |    1 
 arch/x86/pci/irq.c                                         |    1 
 arch/x86/pci/mmconfig-shared.c                             |    1 
 arch/x86/pci/pcbios.c                                      |    1 
 arch/x86/power/hibernate_32.c                              |    1 
 arch/x86/power/hibernate_64.c                              |    1 
 arch/x86/power/hibernate_asm_32.S                          |   15 
 arch/x86/vdso/vma.c                                        |    1 
 arch/x86/xen/debugfs.c                                     |    1 
 arch/x86/xen/enlighten.c                                   |    1 
 arch/x86/xen/mmu.c                                         |    1 
 arch/x86/xen/smp.c                                         |    1 
 arch/x86/xen/spinlock.c                                    |    1 
 arch/x86/xen/time.c                                        |    1 
 arch/xtensa/kernel/pci-dma.c                               |    1 
 arch/xtensa/kernel/process.c                               |    2 
 arch/xtensa/mm/init.c                                      |    2 
 arch/xtensa/platforms/iss/console.c                        |    1 
 block/Kconfig                                              |    3 
 block/blk-barrier.c                                        |    1 
 block/blk-cgroup.c                                         |    1 
 block/blk-integrity.c                                      |    1 
 block/blk-ioc.c                                            |    1 
 block/blk-settings.c                                       |   12 
 block/blk-sysfs.c                                          |   26 
 block/blk-tag.c                                            |    1 
 block/bsg.c                                                |    1 
 block/cfq-iosched.c                                        |   42 
 block/compat_ioctl.c                                       |    1 
 block/elevator.c                                           |    2 
 block/ioctl.c                                              |    1 
 block/noop-iosched.c                                       |    1 
 crypto/algapi.c                                            |    1 
 crypto/algboss.c                                           |    1 
 crypto/async_tx/async_pq.c                                 |    1 
 crypto/async_tx/raid6test.c                                |    1 
 crypto/hmac.c                                              |    1 
 crypto/rng.c                                               |    1 
 crypto/seqiv.c                                             |    1 
 crypto/tcrypt.c                                            |    2 
 crypto/xor.c                                               |    1 
 drivers/acpi/ac.c                                          |    1 
 drivers/acpi/acpi_memhotplug.c                             |    1 
 drivers/acpi/acpi_pad.c                                    |    1 
 drivers/acpi/acpica/evgpe.c                                |   19 
 drivers/acpi/acpica/exprep.c                               |   12 
 drivers/acpi/battery.c                                     |    7 
 drivers/acpi/bus.c                                         |    1 
 drivers/acpi/button.c                                      |    1 
 drivers/acpi/container.c                                   |    1 
 drivers/acpi/debug.c                                       |    1 
 drivers/acpi/dock.c                                        |    8 
 drivers/acpi/ec.c                                          |   36 
 drivers/acpi/event.c                                       |    1 
 drivers/acpi/glue.c                                        |    1 
 drivers/acpi/numa.c                                        |    6 
 drivers/acpi/osl.c                                         |   23 
 drivers/acpi/pci_irq.c                                     |    1 
 drivers/acpi/pci_link.c                                    |    1 
 drivers/acpi/pci_root.c                                    |    1 
 drivers/acpi/pci_slot.c                                    |    1 
 drivers/acpi/power.c                                       |    1 
 drivers/acpi/power_meter.c                                 |    1 
 drivers/acpi/processor_core.c                              |    1 
 drivers/acpi/processor_driver.c                            |    1 
 drivers/acpi/processor_idle.c                              |    1 
 drivers/acpi/processor_perflib.c                           |    1 
 drivers/acpi/processor_throttling.c                        |    1 
 drivers/acpi/sbs.c                                         |    1 
 drivers/acpi/sbshc.c                                       |    1 
 drivers/acpi/scan.c                                        |   13 
 drivers/acpi/system.c                                      |    1 
 drivers/acpi/thermal.c                                     |    1 
 drivers/acpi/utils.c                                       |    1 
 drivers/acpi/video.c                                       |   68 
 drivers/ata/ahci.c                                         |    1 
 drivers/ata/ata_piix.c                                     |    1 
 drivers/ata/libata-acpi.c                                  |    1 
 drivers/ata/libata-core.c                                  |   78 
 drivers/ata/libata-pmp.c                                   |    1 
 drivers/ata/libata-scsi.c                                  |    1 
 drivers/ata/libata-sff.c                                   |    5 
 drivers/ata/pata_acpi.c                                    |    1 
 drivers/ata/pata_at32.c                                    |    1 
 drivers/ata/pata_at91.c                                    |    1 
 drivers/ata/pata_atp867x.c                                 |    1 
 drivers/ata/pata_cmd640.c                                  |    1 
 drivers/ata/pata_icside.c                                  |    1 
 drivers/ata/pata_it821x.c                                  |    1 
 drivers/ata/pata_macio.c                                   |    1 
 drivers/ata/pata_mpc52xx.c                                 |    2 
 drivers/ata/pata_octeon_cf.c                               |    1 
 drivers/ata/pata_pcmcia.c                                  |    1 
 drivers/ata/pata_rb532_cf.c                                |    1 
 drivers/ata/pata_rdc.c                                     |    1 
 drivers/ata/pata_via.c                                     |    1 
 drivers/ata/pdc_adma.c                                     |    1 
 drivers/ata/sata_fsl.c                                     |    1 
 drivers/ata/sata_inic162x.c                                |    1 
 drivers/ata/sata_mv.c                                      |    1 
 drivers/ata/sata_nv.c                                      |    1 
 drivers/ata/sata_promise.c                                 |    1 
 drivers/ata/sata_qstor.c                                   |    1 
 drivers/ata/sata_sil24.c                                   |    1 
 drivers/ata/sata_sx4.c                                     |    1 
 drivers/ata/sata_uli.c                                     |    1 
 drivers/atm/adummy.c                                       |    1 
 drivers/atm/ambassador.c                                   |    1 
 drivers/atm/atmtcp.c                                       |    1 
 drivers/atm/eni.c                                          |    1 
 drivers/atm/firestream.c                                   |    1 
 drivers/atm/he.c                                           |    1 
 drivers/atm/horizon.c                                      |    1 
 drivers/atm/idt77105.c                                     |    1 
 drivers/atm/idt77252.c                                     |    1 
 drivers/atm/iphase.c                                       |    1 
 drivers/atm/lanai.c                                        |    1 
 drivers/atm/nicstar.c                                      |    1 
 drivers/atm/solos-pci.c                                    |    1 
 drivers/atm/suni.c                                         |    1 
 drivers/atm/uPD98402.c                                     |    1 
 drivers/atm/zatm.c                                         |    1 
 drivers/auxdisplay/cfag12864b.c                            |    1 
 drivers/auxdisplay/cfag12864bfb.c                          |    1 
 drivers/base/attribute_container.c                         |    1 
 drivers/base/bus.c                                         |    1 
 drivers/base/cpu.c                                         |    1 
 drivers/base/devres.c                                      |    1 
 drivers/base/devtmpfs.c                                    |    1 
 drivers/base/dma-coherent.c                                |    1 
 drivers/base/dma-mapping.c                                 |    1 
 drivers/base/driver.c                                      |    1 
 drivers/base/firmware_class.c                              |    1 
 drivers/base/memory.c                                      |    3 
 drivers/base/module.c                                      |    1 
 drivers/base/node.c                                        |    1 
 drivers/base/sys.c                                         |    1 
 drivers/block/DAC960.c                                     |    1 
 drivers/block/amiflop.c                                    |    1 
 drivers/block/aoe/aoeblk.c                                 |    1 
 drivers/block/aoe/aoechr.c                                 |    1 
 drivers/block/aoe/aoecmd.c                                 |    1 
 drivers/block/aoe/aoedev.c                                 |    1 
 drivers/block/aoe/aoenet.c                                 |    1 
 drivers/block/brd.c                                        |    2 
 drivers/block/cciss.c                                      |    1 
 drivers/block/drbd/drbd_actlog.c                           |   19 
 drivers/block/drbd/drbd_bitmap.c                           |   11 
 drivers/block/drbd/drbd_int.h                              |   12 
 drivers/block/drbd/drbd_main.c                             |   20 
 drivers/block/drbd/drbd_nl.c                               |   44 
 drivers/block/drbd/drbd_proc.c                             |    1 
 drivers/block/drbd/drbd_receiver.c                         |   34 
 drivers/block/drbd/drbd_worker.c                           |   18 
 drivers/block/hd.c                                         |    1 
 drivers/block/loop.c                                       |    3 
 drivers/block/mg_disk.c                                    |    1 
 drivers/block/nbd.c                                        |    1 
 drivers/block/osdblk.c                                     |    1 
 drivers/block/paride/pcd.c                                 |    4 
 drivers/block/paride/pd.c                                  |    1 
 drivers/block/paride/pf.c                                  |    4 
 drivers/block/paride/pt.c                                  |    4 
 drivers/block/pktcdvd.c                                    |    1 
 drivers/block/ps3disk.c                                    |    1 
 drivers/block/ps3vram.c                                    |    1 
 drivers/block/swim.c                                       |    1 
 drivers/block/ub.c                                         |    1 
 drivers/block/umem.c                                       |    2 
 drivers/block/virtio_blk.c                                 |    6 
 drivers/block/xd.c                                         |    1 
 drivers/block/xen-blkfront.c                               |    1 
 drivers/block/z2ram.c                                      |    1 
 drivers/bluetooth/btmrvl_debugfs.c                         |    1 
 drivers/bluetooth/btmrvl_drv.h                             |    1 
 drivers/bluetooth/btmrvl_sdio.c                            |    1 
 drivers/char/agp/amd-k7-agp.c                              |    2 
 drivers/char/agp/backend.c                                 |    1 
 drivers/char/agp/compat_ioctl.c                            |    1 
 drivers/char/agp/generic.c                                 |    1 
 drivers/char/agp/hp-agp.c                                  |    1 
 drivers/char/agp/intel-agp.c                               |    1 
 drivers/char/agp/nvidia-agp.c                              |    1 
 drivers/char/agp/sgi-agp.c                                 |    1 
 drivers/char/agp/uninorth-agp.c                            |    1 
 drivers/char/amiserial.c                                   |    4 
 drivers/char/bfin_jtag_comm.c                              |    1 
 drivers/char/briq_panel.c                                  |    1 
 drivers/char/bsr.c                                         |    1 
 drivers/char/cyclades.c                                    |    1 
 drivers/char/dsp56k.c                                      |    1 
 drivers/char/epca.c                                        |    1 
 drivers/char/generic_serial.c                              |    1 
 drivers/char/hpet.c                                        |    1 
 drivers/char/hvc_console.c                                 |    5 
 drivers/char/hvc_iucv.c                                    |    1 
 drivers/char/hvcs.c                                        |    1 
 drivers/char/hw_random/intel-rng.c                         |    1 
 drivers/char/hw_random/octeon-rng.c                        |    1 
 drivers/char/hw_random/tx4939-rng.c                        |    1 
 drivers/char/isicom.c                                      |    1 
 drivers/char/mbcs.c                                        |    1 
 drivers/char/mem.c                                         |   10 
 drivers/char/misc.c                                        |    2 
 drivers/char/mmtimer.c                                     |    1 
 drivers/char/moxa.c                                        |    1 
 drivers/char/mxser.c                                       |    8 
 drivers/char/nozomi.c                                      |    1 
 drivers/char/nvram.c                                       |    1 
 drivers/char/pcmcia/ipwireless/network.c                   |    1 
 drivers/char/ppdev.c                                       |    1 
 drivers/char/ps3flash.c                                    |    1 
 drivers/char/pty.c                                         |    1 
 drivers/char/raw.c                                         |    2 
 drivers/char/rio/rioinit.c                                 |    1 
 drivers/char/rio/riointr.c                                 |    1 
 drivers/char/rio/rioparam.c                                |    1 
 drivers/char/rio/rioroute.c                                |    1 
 drivers/char/rio/riotty.c                                  |    1 
 drivers/char/serial167.c                                   |    1 
 drivers/char/snsc_event.c                                  |    1 
 drivers/char/sonypi.c                                      |    1 
 drivers/char/specialix.c                                   |    1 
 drivers/char/sysrq.c                                       |    1 
 drivers/char/tpm/tpm.c                                     |    1 
 drivers/char/tpm/tpm_bios.c                                |    1 
 drivers/char/tpm/tpm_nsc.c                                 |    1 
 drivers/char/tpm/tpm_tis.c                                 |    1 
 drivers/char/tty_audit.c                                   |    1 
 drivers/char/tty_io.c                                      |    2 
 drivers/char/viotape.c                                     |    1 
 drivers/char/virtio_console.c                              |   66 
 drivers/char/vme_scc.c                                     |    1 
 drivers/char/xilinx_hwicap/xilinx_hwicap.c                 |    1 
 drivers/clocksource/sh_cmt.c                               |    1 
 drivers/clocksource/sh_mtu2.c                              |    1 
 drivers/clocksource/sh_tmu.c                               |    1 
 drivers/connector/cn_proc.c                                |    1 
 drivers/connector/connector.c                              |    1 
 drivers/cpufreq/cpufreq_stats.c                            |    1 
 drivers/cpuidle/sysfs.c                                    |    1 
 drivers/crypto/amcc/crypto4xx_core.c                       |    1 
 drivers/crypto/ixp4xx_crypto.c                             |    1 
 drivers/crypto/mv_cesa.c                                   |    1 
 drivers/crypto/padlock-aes.c                               |    1 
 drivers/crypto/talitos.c                                   |    1 
 drivers/dca/dca-core.c                                     |    1 
 drivers/dca/dca-sysfs.c                                    |    1 
 drivers/dma/at_hdmac.c                                     |    1 
 drivers/dma/coh901318_lli.c                                |    1 
 drivers/dma/dmaengine.c                                    |    1 
 drivers/dma/dmatest.c                                      |    1 
 drivers/dma/fsldma.c                                       |    1 
 drivers/dma/ioat/dma.c                                     |    1 
 drivers/dma/ioat/dma_v2.c                                  |    1 
 drivers/dma/ioat/dma_v3.c                                  |    1 
 drivers/dma/ioat/pci.c                                     |    1 
 drivers/dma/iop-adma.c                                     |    1 
 drivers/dma/iovlock.c                                      |    1 
 drivers/dma/mpc512x_dma.c                                  |    1 
 drivers/dma/mv_xor.c                                       |    1 
 drivers/dma/ppc4xx/adma.c                                  |    1 
 drivers/dma/shdma.c                                        |    1 
 drivers/edac/amd76x_edac.c                                 |    1 
 drivers/edac/cpc925_edac.c                                 |    1 
 drivers/edac/e752x_edac.c                                  |    1 
 drivers/edac/e7xxx_edac.c                                  |    1 
 drivers/edac/edac_device_sysfs.c                           |    1 
 drivers/edac/edac_mc_sysfs.c                               |    1 
 drivers/edac/edac_pci_sysfs.c                              |    1 
 drivers/edac/i3000_edac.c                                  |    1 
 drivers/edac/i3200_edac.c                                  |    1 
 drivers/edac/i5100_edac.c                                  |    1 
 drivers/edac/i82443bxgx_edac.c                             |    1 
 drivers/edac/i82860_edac.c                                 |    1 
 drivers/edac/i82875p_edac.c                                |    1 
 drivers/edac/i82975x_edac.c                                |    1 
 drivers/edac/mpc85xx_edac.c                                |    2 
 drivers/edac/mv64x60_edac.c                                |    2 
 drivers/edac/pasemi_edac.c                                 |    1 
 drivers/edac/r82600_edac.c                                 |    1 
 drivers/edac/x38_edac.c                                    |    1 
 drivers/firewire/core-cdev.c                               |    1 
 drivers/firewire/core-device.c                             |    1 
 drivers/firewire/core-iso.c                                |    1 
 drivers/firewire/net.c                                     |    1 
 drivers/firewire/ohci.c                                    |    2 
 drivers/firmware/dcdbas.c                                  |    1 
 drivers/firmware/dell_rbu.c                                |    1 
 drivers/firmware/dmi-id.c                                  |    1 
 drivers/firmware/dmi_scan.c                                |    1 
 drivers/firmware/efivars.c                                 |    1 
 drivers/firmware/iscsi_ibft_find.c                         |   12 
 drivers/firmware/memmap.c                                  |    1 
 drivers/gpio/adp5520-gpio.c                                |    1 
 drivers/gpio/adp5588-gpio.c                                |    1 
 drivers/gpio/bt8xxgpio.c                                   |    1 
 drivers/gpio/gpiolib.c                                     |    1 
 drivers/gpio/langwell_gpio.c                               |    1 
 drivers/gpio/max7300.c                                     |    1 
 drivers/gpio/max7301.c                                     |    1 
 drivers/gpio/max730x.c                                     |    1 
 drivers/gpio/mc33880.c                                     |    1 
 drivers/gpio/mcp23s08.c                                    |    1 
 drivers/gpio/pca953x.c                                     |    1 
 drivers/gpio/pl061.c                                       |    1 
 drivers/gpio/timbgpio.c                                    |   13 
 drivers/gpio/twl4030-gpio.c                                |    1 
 drivers/gpio/wm831x-gpio.c                                 |    1 
 drivers/gpio/wm8350-gpiolib.c                              |    1 
 drivers/gpio/wm8994-gpio.c                                 |    1 
 drivers/gpio/xilinx_gpio.c                                 |    1 
 drivers/gpu/drm/drm_agpsupport.c                           |    1 
 drivers/gpu/drm/drm_bufs.c                                 |    1 
 drivers/gpu/drm/drm_crtc.c                                 |    1 
 drivers/gpu/drm/drm_crtc_helper.c                          |    1 
 drivers/gpu/drm/drm_debugfs.c                              |    1 
 drivers/gpu/drm/drm_dp_i2c_helper.c                        |    1 
 drivers/gpu/drm/drm_drv.c                                  |    1 
 drivers/gpu/drm/drm_edid.c                                 |   12 
 drivers/gpu/drm/drm_fb_helper.c                            |    3 
 drivers/gpu/drm/drm_fops.c                                 |   17 
 drivers/gpu/drm/drm_hashtab.c                              |    1 
 drivers/gpu/drm/drm_irq.c                                  |    1 
 drivers/gpu/drm/drm_pci.c                                  |    1 
 drivers/gpu/drm/drm_proc.c                                 |    1 
 drivers/gpu/drm/drm_scatter.c                              |    1 
 drivers/gpu/drm/drm_stub.c                                 |    1 
 drivers/gpu/drm/drm_sysfs.c                                |    1 
 drivers/gpu/drm/drm_vm.c                                   |    1 
 drivers/gpu/drm/i810/i810_dma.c                            |    1 
 drivers/gpu/drm/i830/i830_dma.c                            |    1 
 drivers/gpu/drm/i915/i915_debugfs.c                        |    1 
 drivers/gpu/drm/i915/i915_dma.c                            |    1 
 drivers/gpu/drm/i915/i915_gem.c                            |    1 
 drivers/gpu/drm/i915/i915_irq.c                            |    1 
 drivers/gpu/drm/i915/intel_crt.c                           |    1 
 drivers/gpu/drm/i915/intel_display.c                       |    1 
 drivers/gpu/drm/i915/intel_dp.c                            |    1 
 drivers/gpu/drm/i915/intel_dvo.c                           |    1 
 drivers/gpu/drm/i915/intel_fb.c                            |    1 
 drivers/gpu/drm/i915/intel_hdmi.c                          |    1 
 drivers/gpu/drm/i915/intel_i2c.c                           |    1 
 drivers/gpu/drm/i915/intel_lvds.c                          |    1 
 drivers/gpu/drm/i915/intel_modes.c                         |    1 
 drivers/gpu/drm/i915/intel_sdvo.c                          |    1 
 drivers/gpu/drm/nouveau/Makefile                           |    4 
 drivers/gpu/drm/nouveau/nouveau_acpi.c                     |    1 
 drivers/gpu/drm/nouveau/nouveau_bios.c                     |  155 
 drivers/gpu/drm/nouveau/nouveau_bios.h                     |    7 
 drivers/gpu/drm/nouveau/nouveau_bo.c                       |   67 
 drivers/gpu/drm/nouveau/nouveau_channel.c                  |    2 
 drivers/gpu/drm/nouveau/nouveau_connector.c                |    2 
 drivers/gpu/drm/nouveau/nouveau_debugfs.c                  |    5 
 drivers/gpu/drm/nouveau/nouveau_dma.c                      |    5 
 drivers/gpu/drm/nouveau/nouveau_dp.c                       |    8 
 drivers/gpu/drm/nouveau/nouveau_drv.c                      |   10 
 drivers/gpu/drm/nouveau/nouveau_drv.h                      |   46 
 drivers/gpu/drm/nouveau/nouveau_encoder.h                  |    1 
 drivers/gpu/drm/nouveau/nouveau_fbcon.c                    |    1 
 drivers/gpu/drm/nouveau/nouveau_gem.c                      |   55 
 drivers/gpu/drm/nouveau/nouveau_grctx.c                    |    1 
 drivers/gpu/drm/nouveau/nouveau_irq.c                      |  610 ++
 drivers/gpu/drm/nouveau/nouveau_mem.c                      |  122 
 drivers/gpu/drm/nouveau/nouveau_sgdma.c                    |   19 
 drivers/gpu/drm/nouveau/nouveau_state.c                    |   20 
 drivers/gpu/drm/nouveau/nv04_crtc.c                        |    6 
 drivers/gpu/drm/nouveau/nv04_fbcon.c                       |    6 
 drivers/gpu/drm/nouveau/nv40_fifo.c                        |    2 
 drivers/gpu/drm/nouveau/nv40_graph.c                       |   21 
 drivers/gpu/drm/nouveau/nv50_display.c                     |   26 
 drivers/gpu/drm/nouveau/nv50_display.h                     |    1 
 drivers/gpu/drm/nouveau/nv50_fb.c                          |   32 
 drivers/gpu/drm/nouveau/nv50_fbcon.c                       |   15 
 drivers/gpu/drm/nouveau/nv50_gpio.c                        |   76 
 drivers/gpu/drm/nouveau/nv50_graph.c                       |   29 
 drivers/gpu/drm/nouveau/nv50_grctx.c                       |   32 
 drivers/gpu/drm/nouveau/nv50_instmem.c                     |   16 
 drivers/gpu/drm/nouveau/nv50_sor.c                         |   25 
 drivers/gpu/drm/r128/r128_cce.c                            |    1 
 drivers/gpu/drm/radeon/Makefile                            |    2 
 drivers/gpu/drm/radeon/atom.c                              |   95 
 drivers/gpu/drm/radeon/atom.h                              |    8 
 drivers/gpu/drm/radeon/atombios_crtc.c                     |   98 
 drivers/gpu/drm/radeon/atombios_dp.c                       |    6 
 drivers/gpu/drm/radeon/evergreen.c                         |   12 
 drivers/gpu/drm/radeon/r100.c                              |   26 
 drivers/gpu/drm/radeon/r200.c                              |    1 
 drivers/gpu/drm/radeon/r300.c                              |   11 
 drivers/gpu/drm/radeon/r420.c                              |    3 
 drivers/gpu/drm/radeon/r520.c                              |    9 
 drivers/gpu/drm/radeon/r600.c                              |   31 
 drivers/gpu/drm/radeon/r600_audio.c                        |   52 
 drivers/gpu/drm/radeon/r600_blit_shaders.c                 |   35 
 drivers/gpu/drm/radeon/r600_cp.c                           |    3 
 drivers/gpu/drm/radeon/r600_cs.c                           |   70 
 drivers/gpu/drm/radeon/r600_hdmi.c                         |  191 
 drivers/gpu/drm/radeon/r600_reg.h                          |   10 
 drivers/gpu/drm/radeon/r600d.h                             |   49 
 drivers/gpu/drm/radeon/radeon.h                            |   66 
 drivers/gpu/drm/radeon/radeon_asic.c                       |  772 ++
 drivers/gpu/drm/radeon/radeon_asic.h                       |  545 --
 drivers/gpu/drm/radeon/radeon_atombios.c                   |  456 -
 drivers/gpu/drm/radeon/radeon_atpx_handler.c               |    1 
 drivers/gpu/drm/radeon/radeon_bios.c                       |    1 
 drivers/gpu/drm/radeon/radeon_combios.c                    |   27 
 drivers/gpu/drm/radeon/radeon_connectors.c                 |    4 
 drivers/gpu/drm/radeon/radeon_cp.c                         |   10 
 drivers/gpu/drm/radeon/radeon_cs.c                         |   11 
 drivers/gpu/drm/radeon/radeon_device.c                     |  238 
 drivers/gpu/drm/radeon/radeon_display.c                    |   68 
 drivers/gpu/drm/radeon/radeon_drv.c                        |   11 
 drivers/gpu/drm/radeon/radeon_drv.h                        |    3 
 drivers/gpu/drm/radeon/radeon_encoders.c                   |  142 
 drivers/gpu/drm/radeon/radeon_fb.c                         |    1 
 drivers/gpu/drm/radeon/radeon_fence.c                      |    1 
 drivers/gpu/drm/radeon/radeon_i2c.c                        |  153 
 drivers/gpu/drm/radeon/radeon_irq_kms.c                    |   20 
 drivers/gpu/drm/radeon/radeon_kms.c                        |    1 
 drivers/gpu/drm/radeon/radeon_legacy_crtc.c                |    8 
 drivers/gpu/drm/radeon/radeon_legacy_encoders.c            |   58 
 drivers/gpu/drm/radeon/radeon_legacy_tv.c                  |   29 
 drivers/gpu/drm/radeon/radeon_mode.h                       |   12 
 drivers/gpu/drm/radeon/radeon_object.c                     |    7 
 drivers/gpu/drm/radeon/radeon_pm.c                         |   46 
 drivers/gpu/drm/radeon/radeon_reg.h                        |    1 
 drivers/gpu/drm/radeon/radeon_ring.c                       |    1 
 drivers/gpu/drm/radeon/radeon_ttm.c                        |    1 
 drivers/gpu/drm/radeon/reg_srcs/r600                       |   75 
 drivers/gpu/drm/radeon/rs400.c                             |    8 
 drivers/gpu/drm/radeon/rs600.c                             |   33 
 drivers/gpu/drm/radeon/rs600d.h                            |   53 
 drivers/gpu/drm/radeon/rs690.c                             |  122 
 drivers/gpu/drm/radeon/rs690d.h                            |    3 
 drivers/gpu/drm/radeon/rv515.c                             |   46 
 drivers/gpu/drm/radeon/rv770.c                             |   32 
 drivers/gpu/drm/ttm/ttm_agp_backend.c                      |    1 
 drivers/gpu/drm/ttm/ttm_bo.c                               |    4 
 drivers/gpu/drm/ttm/ttm_bo_util.c                          |    1 
 drivers/gpu/drm/ttm/ttm_memory.c                           |   19 
 drivers/gpu/drm/ttm/ttm_tt.c                               |   24 
 drivers/gpu/drm/via/via_dmablit.c                          |    1 
 drivers/gpu/drm/vmwgfx/Kconfig                             |    2 
 drivers/gpu/vga/vgaarb.c                                   |    1 
 drivers/hid/hid-3m-pct.c                                   |    1 
 drivers/hid/hid-a4tech.c                                   |    1 
 drivers/hid/hid-apple.c                                    |    1 
 drivers/hid/hid-debug.c                                    |    1 
 drivers/hid/hid-drff.c                                     |    1 
 drivers/hid/hid-gaff.c                                     |    1 
 drivers/hid/hid-gyration.c                                 |    5 
 drivers/hid/hid-lg2ff.c                                    |    1 
 drivers/hid/hid-magicmouse.c                               |    1 
 drivers/hid/hid-mosart.c                                   |    1 
 drivers/hid/hid-ntrig.c                                    |    1 
 drivers/hid/hid-pl.c                                       |    1 
 drivers/hid/hid-quanta.c                                   |    1 
 drivers/hid/hid-sjoy.c                                     |    1 
 drivers/hid/hid-sony.c                                     |    1 
 drivers/hid/hid-stantum.c                                  |    1 
 drivers/hid/hid-tmff.c                                     |    1 
 drivers/hid/hid-wacom.c                                    |    1 
 drivers/hid/hid-zpff.c                                     |    1 
 drivers/hid/hidraw.c                                       |    1 
 drivers/hid/usbhid/hid-pidff.c                             |    1 
 drivers/hid/usbhid/hid-quirks.c                            |    2 
 drivers/hwmon/ad7414.c                                     |    1 
 drivers/hwmon/ad7418.c                                     |    1 
 drivers/hwmon/adcxx.c                                      |    1 
 drivers/hwmon/adt7411.c                                    |    1 
 drivers/hwmon/adt7462.c                                    |    1 
 drivers/hwmon/adt7470.c                                    |    1 
 drivers/hwmon/asus_atk0110.c                               |    1 
 drivers/hwmon/atxp1.c                                      |    1 
 drivers/hwmon/f75375s.c                                    |    1 
 drivers/hwmon/i5k_amb.c                                    |    1 
 drivers/hwmon/ibmaem.c                                     |    1 
 drivers/hwmon/ibmpex.c                                     |    1 
 drivers/hwmon/lm70.c                                       |    1 
 drivers/hwmon/lm73.c                                       |    1 
 drivers/hwmon/max1111.c                                    |    1 
 drivers/hwmon/mc13783-adc.c                                |    1 
 drivers/hwmon/sht15.c                                      |    1 
 drivers/hwmon/wm831x-hwmon.c                               |    1 
 drivers/i2c/algos/i2c-algo-bit.c                           |    1 
 drivers/i2c/algos/i2c-algo-pcf.c                           |    1 
 drivers/i2c/busses/i2c-amd8111.c                           |    1 
 drivers/i2c/busses/i2c-bfin-twi.c                          |    1 
 drivers/i2c/busses/i2c-davinci.c                           |    1 
 drivers/i2c/busses/i2c-designware.c                        |    1 
 drivers/i2c/busses/i2c-elektor.c                           |    1 
 drivers/i2c/busses/i2c-gpio.c                              |    1 
 drivers/i2c/busses/i2c-highlander.c                        |    1 
 drivers/i2c/busses/i2c-imx.c                               |    1 
 drivers/i2c/busses/i2c-ixp2000.c                           |    1 
 drivers/i2c/busses/i2c-mpc.c                               |    1 
 drivers/i2c/busses/i2c-mv64xxx.c                           |    1 
 drivers/i2c/busses/i2c-nforce2.c                           |    1 
 drivers/i2c/busses/i2c-nomadik.c                           |    1 
 drivers/i2c/busses/i2c-ocores.c                            |    1 
 drivers/i2c/busses/i2c-octeon.c                            |    1 
 drivers/i2c/busses/i2c-omap.c                              |    1 
 drivers/i2c/busses/i2c-parport.c                           |    1 
 drivers/i2c/busses/i2c-pasemi.c                            |    1 
 drivers/i2c/busses/i2c-pnx.c                               |    1 
 drivers/i2c/busses/i2c-pxa.c                               |    1 
 drivers/i2c/busses/i2c-s3c2410.c                           |    1 
 drivers/i2c/busses/i2c-sh_mobile.c                         |    1 
 drivers/i2c/busses/i2c-simtec.c                            |    1 
 drivers/i2c/busses/i2c-stu300.c                            |    1 
 drivers/i2c/busses/i2c-tiny-usb.c                          |    1 
 drivers/i2c/busses/i2c-versatile.c                         |    1 
 drivers/i2c/busses/i2c-xiic.c                              |    1 
 drivers/i2c/busses/scx200_acb.c                            |    1 
 drivers/i2c/i2c-boardinfo.c                                |    1 
 drivers/i2c/i2c-smbus.c                                    |    1 
 drivers/ide/hpt366.c                                       |    1 
 drivers/ide/ide-acpi.c                                     |    1 
 drivers/ide/ide-atapi.c                                    |    3 
 drivers/ide/ide-cd_ioctl.c                                 |    1 
 drivers/ide/ide-devsets.c                                  |    1 
 drivers/ide/ide-disk_proc.c                                |    1 
 drivers/ide/ide-dma.c                                      |    2 
 drivers/ide/ide-floppy.c                                   |    1 
 drivers/ide/ide-gd.c                                       |    1 
 drivers/ide/ide-io.c                                       |    2 
 drivers/ide/ide-ioctls.c                                   |    1 
 drivers/ide/ide-park.c                                     |    1 
 drivers/ide/ide-pm.c                                       |    1 
 drivers/ide/ide-proc.c                                     |    1 
 drivers/ide/ide-taskfile.c                                 |    6 
 drivers/ide/ide.c                                          |    1 
 drivers/ide/it821x.c                                       |    1 
 drivers/ide/pmac.c                                         |    1 
 drivers/ide/rapide.c                                       |    1 
 drivers/ide/sc1200.c                                       |    1 
 drivers/ide/via82cxxx.c                                    |    1 
 drivers/idle/i7300_idle.c                                  |    1 
 drivers/ieee1394/dma.c                                     |    1 
 drivers/ieee1394/sbp2.c                                    |    1 
 drivers/infiniband/core/addr.c                             |    1 
 drivers/infiniband/core/cm.c                               |    3 
 drivers/infiniband/core/cma.c                              |    2 
 drivers/infiniband/core/iwcm.c                             |    1 
 drivers/infiniband/core/mad.c                              |    1 
 drivers/infiniband/core/mad_rmpp.c                         |    2 
 drivers/infiniband/core/multicast.c                        |    1 
 drivers/infiniband/core/ucm.c                              |    1 
 drivers/infiniband/core/ucma.c                             |    1 
 drivers/infiniband/core/umem.c                             |    1 
 drivers/infiniband/core/user_mad.c                         |    1 
 drivers/infiniband/core/uverbs_cmd.c                       |    1 
 drivers/infiniband/core/uverbs_main.c                      |    1 
 drivers/infiniband/hw/amso1100/c2.c                        |    1 
 drivers/infiniband/hw/amso1100/c2_alloc.c                  |    1 
 drivers/infiniband/hw/amso1100/c2_cm.c                     |    2 
 drivers/infiniband/hw/amso1100/c2_cq.c                     |    2 
 drivers/infiniband/hw/amso1100/c2_mm.c                     |    2 
 drivers/infiniband/hw/amso1100/c2_pd.c                     |    1 
 drivers/infiniband/hw/amso1100/c2_provider.c               |    1 
 drivers/infiniband/hw/amso1100/c2_qp.c                     |    1 
 drivers/infiniband/hw/amso1100/c2_rnic.c                   |    1 
 drivers/infiniband/hw/cxgb3/cxio_dbg.c                     |    1 
 drivers/infiniband/hw/cxgb3/cxio_hal.c                     |    1 
 drivers/infiniband/hw/cxgb3/iwch_cm.c                      |    1 
 drivers/infiniband/hw/cxgb3/iwch_ev.c                      |    2 
 drivers/infiniband/hw/cxgb3/iwch_mem.c                     |    1 
 drivers/infiniband/hw/cxgb3/iwch_provider.c                |    1 
 drivers/infiniband/hw/cxgb3/iwch_qp.c                      |    1 
 drivers/infiniband/hw/ehca/ehca_av.c                       |    2 
 drivers/infiniband/hw/ehca/ehca_cq.c                       |    2 
 drivers/infiniband/hw/ehca/ehca_hca.c                      |    2 
 drivers/infiniband/hw/ehca/ehca_irq.c                      |    2 
 drivers/infiniband/hw/ehca/ehca_mrmw.c                     |    1 
 drivers/infiniband/hw/ehca/ehca_pd.c                       |    2 
 drivers/infiniband/hw/ehca/ehca_qp.c                       |    2 
 drivers/infiniband/hw/ehca/ehca_uverbs.c                   |    2 
 drivers/infiniband/hw/ehca/ipz_pt_fn.c                     |    2 
 drivers/infiniband/hw/ipath/ipath_cq.c                     |    1 
 drivers/infiniband/hw/ipath/ipath_dma.c                    |    1 
 drivers/infiniband/hw/ipath/ipath_driver.c                 |    1 
 drivers/infiniband/hw/ipath/ipath_file_ops.c               |    1 
 drivers/infiniband/hw/ipath/ipath_fs.c                     |    1 
 drivers/infiniband/hw/ipath/ipath_init_chip.c              |    1 
 drivers/infiniband/hw/ipath/ipath_mmap.c                   |    1 
 drivers/infiniband/hw/ipath/ipath_mr.c                     |    2 
 drivers/infiniband/hw/ipath/ipath_qp.c                     |    1 
 drivers/infiniband/hw/ipath/ipath_sdma.c                   |    1 
 drivers/infiniband/hw/ipath/ipath_srq.c                    |    1 
 drivers/infiniband/hw/ipath/ipath_user_pages.c             |    1 
 drivers/infiniband/hw/ipath/ipath_verbs.c                  |    1 
 drivers/infiniband/hw/ipath/ipath_verbs_mcast.c            |    1 
 drivers/infiniband/hw/mlx4/ah.c                            |    2 
 drivers/infiniband/hw/mlx4/cq.c                            |    1 
 drivers/infiniband/hw/mlx4/mad.c                           |    1 
 drivers/infiniband/hw/mlx4/main.c                          |    1 
 drivers/infiniband/hw/mlx4/mr.c                            |    4 
 drivers/infiniband/hw/mlx4/qp.c                            |    1 
 drivers/infiniband/hw/mlx4/srq.c                           |    1 
 drivers/infiniband/hw/mthca/mthca_cmd.c                    |    1 
 drivers/infiniband/hw/mthca/mthca_cq.c                     |    1 
 drivers/infiniband/hw/mthca/mthca_eq.c                     |    1 
 drivers/infiniband/hw/mthca/mthca_main.c                   |    1 
 drivers/infiniband/hw/mthca/mthca_mcg.c                    |    2 
 drivers/infiniband/hw/mthca/mthca_memfree.c                |    1 
 drivers/infiniband/hw/mthca/mthca_provider.c               |    1 
 drivers/infiniband/hw/nes/nes.c                            |    1 
 drivers/infiniband/hw/nes/nes_cm.c                         |    1 
 drivers/infiniband/hw/nes/nes_hw.c                         |    1 
 drivers/infiniband/hw/nes/nes_nic.c                        |    1 
 drivers/infiniband/hw/nes/nes_utils.c                      |    1 
 drivers/infiniband/hw/nes/nes_verbs.c                      |   10 
 drivers/infiniband/ulp/ipoib/ipoib_cm.c                    |    1 
 drivers/infiniband/ulp/ipoib/ipoib_fs.c                    |    1 
 drivers/infiniband/ulp/ipoib/ipoib_ib.c                    |    1 
 drivers/infiniband/ulp/ipoib/ipoib_multicast.c             |    1 
 drivers/infiniband/ulp/ipoib/ipoib_verbs.c                 |    2 
 drivers/infiniband/ulp/ipoib/ipoib_vlan.c                  |    1 
 drivers/infiniband/ulp/iser/iscsi_iser.c                   |    1 
 drivers/infiniband/ulp/iser/iser_verbs.c                   |    1 
 drivers/input/ff-core.c                                    |    1 
 drivers/input/ff-memless.c                                 |    1 
 drivers/input/gameport/lightning.c                         |    1 
 drivers/input/input-polldev.c                              |    1 
 drivers/input/input.c                                      |    1 
 drivers/input/joystick/db9.c                               |    1 
 drivers/input/joystick/gamecon.c                           |    1 
 drivers/input/joystick/turbografx.c                        |    1 
 drivers/input/keyboard/adp5520-keys.c                      |    1 
 drivers/input/keyboard/adp5588-keys.c                      |    1 
 drivers/input/keyboard/bf54x-keys.c                        |    1 
 drivers/input/keyboard/davinci_keyscan.c                   |    1 
 drivers/input/keyboard/ep93xx_keypad.c                     |    1 
 drivers/input/keyboard/gpio_keys.c                         |    1 
 drivers/input/keyboard/imx_keypad.c                        |    1 
 drivers/input/keyboard/jornada680_kbd.c                    |    1 
 drivers/input/keyboard/jornada720_kbd.c                    |    1 
 drivers/input/keyboard/lm8323.c                            |    1 
 drivers/input/keyboard/matrix_keypad.c                     |    1 
 drivers/input/keyboard/max7359_keypad.c                    |    1 
 drivers/input/keyboard/omap-keypad.c                       |    1 
 drivers/input/keyboard/opencores-kbd.c                     |    1 
 drivers/input/keyboard/pxa27x_keypad.c                     |    1 
 drivers/input/keyboard/pxa930_rotary.c                     |    1 
 drivers/input/keyboard/sh_keysc.c                          |    1 
 drivers/input/keyboard/tosakbd.c                           |    1 
 drivers/input/keyboard/twl4030_keypad.c                    |    1 
 drivers/input/keyboard/w90p910_keypad.c                    |    1 
 drivers/input/misc/88pm860x_onkey.c                        |    1 
 drivers/input/misc/ati_remote2.c                           |    1 
 drivers/input/misc/bfin_rotary.c                           |    1 
 drivers/input/misc/cobalt_btns.c                           |    1 
 drivers/input/misc/dm355evm_keys.c                         |    1 
 drivers/input/misc/pcap_keys.c                             |    1 
 drivers/input/misc/pcf50633-input.c                        |    1 
 drivers/input/misc/rotary_encoder.c                        |    1 
 drivers/input/misc/sgi_btns.c                              |    1 
 drivers/input/misc/sparcspkr.c                             |    1 
 drivers/input/misc/twl4030-vibra.c                         |    1 
 drivers/input/misc/winbond-cir.c                           |    1 
 drivers/input/misc/wistron_btns.c                          |    1 
 drivers/input/misc/wm831x-on.c                             |    1 
 drivers/input/mouse/alps.c                                 |    1 
 drivers/input/mouse/elantech.c                             |    1 
 drivers/input/mouse/hgpk.c                                 |    1 
 drivers/input/mouse/lifebook.c                             |    1 
 drivers/input/mouse/pxa930_trkball.c                       |    1 
 drivers/input/mouse/sentelic.c                             |    1 
 drivers/input/mouse/synaptics.c                            |    1 
 drivers/input/mouse/synaptics_i2c.c                        |    1 
 drivers/input/mouse/touchkit_ps2.c                         |    1 
 drivers/input/mouse/trackpoint.c                           |    1 
 drivers/input/serio/altera_ps2.c                           |    1 
 drivers/input/serio/at32psif.c                             |    1 
 drivers/input/serio/ct82c710.c                             |    1 
 drivers/input/serio/gscps2.c                               |    1 
 drivers/input/serio/hil_mlc.c                              |    1 
 drivers/input/serio/i8042.c                                |    1 
 drivers/input/serio/libps2.c                               |    1 
 drivers/input/serio/parkbd.c                               |    1 
 drivers/input/serio/pcips2.c                               |    1 
 drivers/input/serio/q40kbd.c                               |    1 
 drivers/input/serio/rpckbd.c                               |    1 
 drivers/input/serio/xilinx_ps2.c                           |    1 
 drivers/input/sparse-keymap.c                              |    1 
 drivers/input/touchscreen/88pm860x-ts.c                    |    1 
 drivers/input/touchscreen/atmel-wm97xx.c                   |    1 
 drivers/input/touchscreen/da9034-ts.c                      |    1 
 drivers/input/touchscreen/eeti_ts.c                        |    1 
 drivers/input/touchscreen/jornada720_ts.c                  |    1 
 drivers/input/touchscreen/mc13783_ts.c                     |    1 
 drivers/input/touchscreen/mcs5000_ts.c                     |    1 
 drivers/input/touchscreen/migor_ts.c                       |    1 
 drivers/input/touchscreen/pcap_ts.c                        |    1 
 drivers/input/touchscreen/s3c2410_ts.c                     |    1 
 drivers/input/touchscreen/ucb1400_ts.c                     |    1 
 drivers/input/touchscreen/w90p910_ts.c                     |    1 
 drivers/input/touchscreen/wm97xx-core.c                    |    1 
 drivers/input/xen-kbdfront.c                               |    1 
 drivers/isdn/act2000/module.c                              |    1 
 drivers/isdn/capi/capifs.c                                 |    1 
 drivers/isdn/capi/capilib.c                                |    1 
 drivers/isdn/capi/capiutil.c                               |    1 
 drivers/isdn/capi/kcapi.c                                  |    1 
 drivers/isdn/divert/divert_procfs.c                        |    1 
 drivers/isdn/divert/isdn_divert.c                          |    1 
 drivers/isdn/gigaset/capi.c                                |    1 
 drivers/isdn/gigaset/common.c                              |    1 
 drivers/isdn/gigaset/gigaset.h                             |    1 
 drivers/isdn/gigaset/i4l.c                                 |    1 
 drivers/isdn/gigaset/ser-gigaset.c                         |    1 
 drivers/isdn/hardware/avm/b1.c                             |    1 
 drivers/isdn/hardware/avm/b1dma.c                          |    1 
 drivers/isdn/hardware/avm/c4.c                             |    1 
 drivers/isdn/hardware/avm/t1isa.c                          |    1 
 drivers/isdn/hardware/eicon/capimain.c                     |    1 
 drivers/isdn/hardware/mISDN/avmfritz.c                     |    1 
 drivers/isdn/hardware/mISDN/hfcmulti.c                     |    1 
 drivers/isdn/hardware/mISDN/hfcpci.c                       |    1 
 drivers/isdn/hardware/mISDN/hfcsusb.c                      |    1 
 drivers/isdn/hardware/mISDN/mISDNinfineon.c                |    1 
 drivers/isdn/hardware/mISDN/mISDNipac.c                    |    1 
 drivers/isdn/hardware/mISDN/mISDNisar.c                    |    1 
 drivers/isdn/hardware/mISDN/netjet.c                       |    1 
 drivers/isdn/hardware/mISDN/speedfax.c                     |    1 
 drivers/isdn/hardware/mISDN/w6692.c                        |    1 
 drivers/isdn/hisax/amd7930_fn.c                            |    1 
 drivers/isdn/hisax/avm_pci.c                               |    1 
 drivers/isdn/hisax/callc.c                                 |    1 
 drivers/isdn/hisax/config.c                                |    1 
 drivers/isdn/hisax/elsa.c                                  |    1 
 drivers/isdn/hisax/elsa_ser.c                              |    1 
 drivers/isdn/hisax/fsm.c                                   |    1 
 drivers/isdn/hisax/hfc4s8s_l1.c                            |    1 
 drivers/isdn/hisax/hfc_2bds0.c                             |    1 
 drivers/isdn/hisax/hfc_2bs0.c                              |    1 
 drivers/isdn/hisax/hfc_sx.c                                |    1 
 drivers/isdn/hisax/hfc_usb.c                               |    1 
 drivers/isdn/hisax/hisax_isac.c                            |    1 
 drivers/isdn/hisax/hscx.c                                  |    1 
 drivers/isdn/hisax/icc.c                                   |    1 
 drivers/isdn/hisax/ipacx.c                                 |    1 
 drivers/isdn/hisax/isac.c                                  |    1 
 drivers/isdn/hisax/isar.c                                  |    1 
 drivers/isdn/hisax/isdnl1.c                                |    1 
 drivers/isdn/hisax/isdnl2.c                                |    1 
 drivers/isdn/hisax/isdnl3.c                                |    1 
 drivers/isdn/hisax/jade.c                                  |    1 
 drivers/isdn/hisax/l3dss1.c                                |    1 
 drivers/isdn/hisax/l3ni1.c                                 |    1 
 drivers/isdn/hisax/netjet.c                                |    1 
 drivers/isdn/hisax/st5481_b.c                              |    2 
 drivers/isdn/hisax/st5481_d.c                              |    2 
 drivers/isdn/hisax/tei.c                                   |    1 
 drivers/isdn/hisax/w6692.c                                 |    1 
 drivers/isdn/hysdn/hycapi.c                                |    1 
 drivers/isdn/hysdn/hysdn_procconf.c                        |    1 
 drivers/isdn/hysdn/hysdn_proclog.c                         |    1 
 drivers/isdn/i4l/isdn_audio.c                              |    1 
 drivers/isdn/i4l/isdn_common.c                             |    1 
 drivers/isdn/i4l/isdn_net.c                                |    1 
 drivers/isdn/i4l/isdn_ppp.c                                |    1 
 drivers/isdn/i4l/isdn_tty.c                                |    1 
 drivers/isdn/i4l/isdn_x25iface.c                           |    1 
 drivers/isdn/icn/icn.c                                     |    1 
 drivers/isdn/isdnloop/isdnloop.c                           |    1 
 drivers/isdn/mISDN/clock.c                                 |    1 
 drivers/isdn/mISDN/core.c                                  |    1 
 drivers/isdn/mISDN/dsp_cmx.c                               |    1 
 drivers/isdn/mISDN/dsp_core.c                              |    1 
 drivers/isdn/mISDN/dsp_pipeline.c                          |    1 
 drivers/isdn/mISDN/dsp_tones.c                             |    1 
 drivers/isdn/mISDN/hwchannel.c                             |    1 
 drivers/isdn/mISDN/l1oip_core.c                            |    1 
 drivers/isdn/mISDN/layer1.c                                |    1 
 drivers/isdn/mISDN/layer2.c                                |    1 
 drivers/isdn/mISDN/socket.c                                |    1 
 drivers/isdn/mISDN/stack.c                                 |    1 
 drivers/isdn/mISDN/tei.c                                   |    1 
 drivers/isdn/mISDN/timerdev.c                              |    1 
 drivers/isdn/pcbit/callbacks.c                             |    1 
 drivers/isdn/pcbit/edss1.c                                 |    1 
 drivers/isdn/sc/init.c                                     |    1 
 drivers/leds/dell-led.c                                    |    1 
 drivers/leds/led-triggers.c                                |    1 
 drivers/leds/leds-88pm860x.c                               |    1 
 drivers/leds/leds-adp5520.c                                |    1 
 drivers/leds/leds-atmel-pwm.c                              |    1 
 drivers/leds/leds-bd2802.c                                 |    1 
 drivers/leds/leds-da903x.c                                 |    1 
 drivers/leds/leds-dac124s085.c                             |    1 
 drivers/leds/leds-gpio.c                                   |    1 
 drivers/leds/leds-lp3944.c                                 |    1 
 drivers/leds/leds-lt3593.c                                 |    1 
 drivers/leds/leds-pca9532.c                                |    1 
 drivers/leds/leds-pca955x.c                                |    1 
 drivers/leds/leds-pwm.c                                    |    1 
 drivers/leds/leds-regulator.c                              |    1 
 drivers/leds/leds-s3c24xx.c                                |    1 
 drivers/leds/leds-sunfire.c                                |    1 
 drivers/leds/leds-wm831x-status.c                          |    1 
 drivers/leds/leds-wm8350.c                                 |    1 
 drivers/leds/ledtrig-backlight.c                           |    1 
 drivers/leds/ledtrig-gpio.c                                |    1 
 drivers/leds/ledtrig-heartbeat.c                           |    1 
 drivers/leds/ledtrig-timer.c                               |    1 
 drivers/lguest/core.c                                      |    1 
 drivers/lguest/lg.h                                        |    1 
 drivers/lguest/lguest_device.c                             |    1 
 drivers/lguest/lguest_user.c                               |    1 
 drivers/lguest/page_tables.c                               |    1 
 drivers/macintosh/mac_hid.c                                |    1 
 drivers/macintosh/rack-meter.c                             |    1 
 drivers/macintosh/smu.c                                    |    1 
 drivers/macintosh/therm_pm72.c                             |    1 
 drivers/macintosh/therm_windtunnel.c                       |    1 
 drivers/macintosh/via-pmu68k.c                             |    1 
 drivers/macintosh/windfarm_core.c                          |    2 
 drivers/md/dm-log-userspace-base.c                         |    1 
 drivers/md/dm-log-userspace-transfer.c                     |    1 
 drivers/md/dm-region-hash.c                                |    1 
 drivers/md/dm-service-time.c                               |    2 
 drivers/md/dm-target.c                                     |    1 
 drivers/md/faulty.c                                        |    1 
 drivers/md/linear.c                                        |    1 
 drivers/md/md.c                                            |    1 
 drivers/md/multipath.c                                     |    1 
 drivers/md/raid0.c                                         |    1 
 drivers/md/raid1.c                                         |    1 
 drivers/md/raid10.c                                        |    1 
 drivers/md/raid5.c                                         |    1 
 drivers/md/raid6algos.c                                    |    1 
 drivers/media/IR/ir-keytable.c                             |    1 
 drivers/media/IR/ir-sysfs.c                                |    1 
 drivers/media/common/tuners/max2165.c                      |    1 
 drivers/media/common/tuners/mc44s803.c                     |    1 
 drivers/media/common/tuners/mt2060.c                       |    1 
 drivers/media/common/tuners/mt20xx.c                       |    1 
 drivers/media/common/tuners/mt2131.c                       |    1 
 drivers/media/common/tuners/mt2266.c                       |    1 
 drivers/media/common/tuners/tda827x.c                      |    1 
 drivers/media/common/tuners/tda8290.c                      |    1 
 drivers/media/common/tuners/tda9887.c                      |    1 
 drivers/media/common/tuners/tea5761.c                      |    1 
 drivers/media/common/tuners/tea5767.c                      |    1 
 drivers/media/common/tuners/tuner-i2c.h                    |    1 
 drivers/media/common/tuners/tuner-xc2028.c                 |    1 
 drivers/media/dvb/bt8xx/dst_ca.c                           |    1 
 drivers/media/dvb/dm1105/dm1105.c                          |    1 
 drivers/media/dvb/dvb-core/dmxdev.h                        |    1 
 drivers/media/dvb/dvb-core/dvb_frontend.h                  |    1 
 drivers/media/dvb/dvb-usb/af9015.c                         |    1 
 drivers/media/dvb/dvb-usb/cxusb.c                          |    1 
 drivers/media/dvb/firewire/firedtv-1394.c                  |    1 
 drivers/media/dvb/firewire/firedtv-rc.c                    |    1 
 drivers/media/dvb/frontends/au8522_dig.c                   |    1 
 drivers/media/dvb/frontends/dib0070.c                      |    1 
 drivers/media/dvb/frontends/dib0090.c                      |    1 
 drivers/media/dvb/frontends/dib3000mc.c                    |    1 
 drivers/media/dvb/frontends/dib7000m.c                     |    1 
 drivers/media/dvb/frontends/dib7000p.c                     |    1 
 drivers/media/dvb/frontends/dib8000.c                      |    1 
 drivers/media/dvb/frontends/drx397xD.c                     |    1 
 drivers/media/dvb/frontends/dvb-pll.c                      |    1 
 drivers/media/dvb/frontends/itd1000.c                      |    1 
 drivers/media/dvb/frontends/lgdt3304.c                     |    1 
 drivers/media/dvb/frontends/lgdt3305.c                     |    1 
 drivers/media/dvb/frontends/mb86a16.c                      |    1 
 drivers/media/dvb/frontends/s921_module.c                  |    1 
 drivers/media/dvb/frontends/stb0899_drv.c                  |    1 
 drivers/media/dvb/frontends/stb6000.c                      |    1 
 drivers/media/dvb/frontends/stb6100.c                      |    1 
 drivers/media/dvb/frontends/stv090x.c                      |    1 
 drivers/media/dvb/frontends/stv6110.c                      |    1 
 drivers/media/dvb/frontends/stv6110x.c                     |    1 
 drivers/media/dvb/frontends/tda665x.c                      |    1 
 drivers/media/dvb/frontends/tda8261.c                      |    1 
 drivers/media/dvb/frontends/tda826x.c                      |    1 
 drivers/media/dvb/frontends/tua6100.c                      |    1 
 drivers/media/dvb/frontends/zl10036.c                      |    1 
 drivers/media/dvb/mantis/hopper_cards.c                    |    1 
 drivers/media/dvb/mantis/mantis_ca.c                       |    1 
 drivers/media/dvb/mantis/mantis_cards.c                    |    1 
 drivers/media/dvb/ngene/ngene-core.c                       |    1 
 drivers/media/dvb/pluto2/pluto2.c                          |    1 
 drivers/media/dvb/pt1/pt1.c                                |    1 
 drivers/media/dvb/siano/smscoreapi.c                       |    1 
 drivers/media/dvb/siano/smsdvb.c                           |    1 
 drivers/media/dvb/siano/smssdio.c                          |    1 
 drivers/media/dvb/siano/smsusb.c                           |    1 
 drivers/media/dvb/ttpci/av7110.c                           |    1 
 drivers/media/dvb/ttpci/av7110_ca.c                        |    1 
 drivers/media/radio/radio-gemtek-pci.c                     |    1 
 drivers/media/radio/radio-maestro.c                        |    1 
 drivers/media/radio/radio-maxiradio.c                      |    1 
 drivers/media/radio/radio-si4713.c                         |    1 
 drivers/media/radio/radio-tea5764.c                        |    1 
 drivers/media/radio/radio-timb.c                           |    1 
 drivers/media/radio/saa7706h.c                             |    1 
 drivers/media/radio/si470x/radio-si470x-i2c.c              |    1 
 drivers/media/radio/si470x/radio-si470x-usb.c              |    1 
 drivers/media/radio/si4713-i2c.c                           |    1 
 drivers/media/radio/tef6862.c                              |    1 
 drivers/media/video/adv7170.c                              |    1 
 drivers/media/video/adv7175.c                              |    1 
 drivers/media/video/adv7180.c                              |    1 
 drivers/media/video/adv7343.c                              |    1 
 drivers/media/video/au0828/au0828-core.c                   |    1 
 drivers/media/video/au0828/au0828-dvb.c                    |    1 
 drivers/media/video/au0828/au0828-video.c                  |    1 
 drivers/media/video/bt819.c                                |    1 
 drivers/media/video/bt856.c                                |    1 
 drivers/media/video/bt866.c                                |    1 
 drivers/media/video/bt8xx/bttv-driver.c                    |    1 
 drivers/media/video/bt8xx/bttv-gpio.c                      |    1 
 drivers/media/video/bt8xx/bttv-input.c                     |    1 
 drivers/media/video/bt8xx/bttv-risc.c                      |    1 
 drivers/media/video/cafe_ccic.c                            |    1 
 drivers/media/video/cpia_pp.c                              |    1 
 drivers/media/video/cs5345.c                               |    1 
 drivers/media/video/cs53l32a.c                             |    1 
 drivers/media/video/cx18/cx18-alsa-main.c                  |    1 
 drivers/media/video/cx18/cx18-controls.c                   |    1 
 drivers/media/video/cx18/cx18-driver.h                     |    1 
 drivers/media/video/cx231xx/cx231xx-cards.c                |    1 
 drivers/media/video/cx231xx/cx231xx-core.c                 |    1 
 drivers/media/video/cx231xx/cx231xx-dvb.c                  |    1 
 drivers/media/video/cx231xx/cx231xx-input.c                |    1 
 drivers/media/video/cx231xx/cx231xx-vbi.c                  |    1 
 drivers/media/video/cx231xx/cx231xx-video.c                |    1 
 drivers/media/video/cx23885/cx23885-417.c                  |    1 
 drivers/media/video/cx23885/cx23885-input.c                |    1 
 drivers/media/video/cx23885/cx23885-vbi.c                  |    1 
 drivers/media/video/cx23885/cx23885.h                      |    1 
 drivers/media/video/cx23885/cx23888-ir.c                   |    1 
 drivers/media/video/cx88/cx88-alsa.c                       |    1 
 drivers/media/video/cx88/cx88-blackbird.c                  |    1 
 drivers/media/video/cx88/cx88-cards.c                      |    1 
 drivers/media/video/cx88/cx88-dsp.c                        |    1 
 drivers/media/video/cx88/cx88-input.c                      |    1 
 drivers/media/video/cx88/cx88-mpeg.c                       |    1 
 drivers/media/video/cx88/cx88-tvaudio.c                    |    1 
 drivers/media/video/cx88/cx88-vbi.c                        |    1 
 drivers/media/video/cx88/cx88-vp3054-i2c.c                 |    1 
 drivers/media/video/davinci/dm644x_ccdc.c                  |    1 
 drivers/media/video/davinci/vpfe_capture.c                 |    1 
 drivers/media/video/davinci/vpif_capture.c                 |    1 
 drivers/media/video/davinci/vpif_display.c                 |    1 
 drivers/media/video/em28xx/em28xx-cards.c                  |    1 
 drivers/media/video/em28xx/em28xx-core.c                   |    1 
 drivers/media/video/em28xx/em28xx-dvb.c                    |    1 
 drivers/media/video/em28xx/em28xx-input.c                  |    1 
 drivers/media/video/em28xx/em28xx-vbi.c                    |    1 
 drivers/media/video/em28xx/em28xx-video.c                  |    1 
 drivers/media/video/gspca/gspca.h                          |    1 
 drivers/media/video/gspca/jeilinj.c                        |    1 
 drivers/media/video/gspca/m5602/m5602_s5k83a.c             |    1 
 drivers/media/video/gspca/sn9c20x.c                        |    1 
 drivers/media/video/gspca/sonixj.c                         |    1 
 drivers/media/video/gspca/sq905.c                          |    1 
 drivers/media/video/gspca/sq905c.c                         |    1 
 drivers/media/video/gspca/zc3xx.c                          |    1 
 drivers/media/video/hdpvr/hdpvr-i2c.c                      |    1 
 drivers/media/video/ivtv/ivtv-controls.c                   |    1 
 drivers/media/video/ivtv/ivtv-driver.h                     |    1 
 drivers/media/video/ivtv/ivtvfb.c                          |    1 
 drivers/media/video/ks0127.c                               |    1 
 drivers/media/video/m52790.c                               |    1 
 drivers/media/video/meye.c                                 |    1 
 drivers/media/video/msp3400-kthreads.c                     |    1 
 drivers/media/video/mt9v011.c                              |    1 
 drivers/media/video/mx1_camera.c                           |    1 
 drivers/media/video/omap24xxcam.c                          |    1 
 drivers/media/video/ov7670.c                               |    1 
 drivers/media/video/pms.c                                  |    1 
 drivers/media/video/pvrusb2/pvrusb2-cs53l32a.c             |    1 
 drivers/media/video/pvrusb2/pvrusb2-cx2584x-v4l.c          |    1 
 drivers/media/video/pvrusb2/pvrusb2-debugifc.c             |    1 
 drivers/media/video/pvrusb2/pvrusb2-dvb.c                  |    1 
 drivers/media/video/pvrusb2/pvrusb2-eeprom.c               |    1 
 drivers/media/video/pvrusb2/pvrusb2-main.c                 |    1 
 drivers/media/video/pvrusb2/pvrusb2-sysfs.c                |    8 
 drivers/media/video/pvrusb2/pvrusb2-v4l2.c                 |    1 
 drivers/media/video/pvrusb2/pvrusb2-video-v4l.c            |    1 
 drivers/media/video/pvrusb2/pvrusb2-wm8775.c               |    1 
 drivers/media/video/pwc/pwc-dec23.c                        |    1 
 drivers/media/video/pwc/pwc-v4l.c                          |    1 
 drivers/media/video/pwc/pwc.h                              |    1 
 drivers/media/video/pxa_camera.c                           |    1 
 drivers/media/video/s2255drv.c                             |    1 
 drivers/media/video/saa5246a.c                             |    1 
 drivers/media/video/saa5249.c                              |    1 
 drivers/media/video/saa7134/saa7134-dvb.c                  |    1 
 drivers/media/video/saa7134/saa7134-empress.c              |    1 
 drivers/media/video/saa7134/saa7134-i2c.c                  |    1 
 drivers/media/video/saa7134/saa7134-input.c                |    1 
 drivers/media/video/saa7134/saa7134-ts.c                   |    1 
 drivers/media/video/saa7134/saa7134-tvaudio.c              |    1 
 drivers/media/video/saa7134/saa7134-vbi.c                  |    1 
 drivers/media/video/saa7164/saa7164-api.c                  |    1 
 drivers/media/video/saa7164/saa7164-buffer.c               |    2 
 drivers/media/video/saa7164/saa7164-fw.c                   |    1 
 drivers/media/video/saa717x.c                              |    1 
 drivers/media/video/saa7185.c                              |    1 
 drivers/media/video/sh_mobile_ceu_camera.c                 |    1 
 drivers/media/video/soc_camera.c                           |    1 
 drivers/media/video/tda9840.c                              |    1 
 drivers/media/video/tea6415c.c                             |    1 
 drivers/media/video/tea6420.c                              |    1 
 drivers/media/video/ths7303.c                              |    1 
 drivers/media/video/tlg2300/pd-alsa.c                      |    2 
 drivers/media/video/tlg2300/pd-dvb.c                       |    1 
 drivers/media/video/tlg2300/pd-video.c                     |    1 
 drivers/media/video/tlv320aic23b.c                         |    1 
 drivers/media/video/tvp514x.c                              |    1 
 drivers/media/video/tvp5150.c                              |    1 
 drivers/media/video/tvp7002.c                              |    1 
 drivers/media/video/upd64031a.c                            |    1 
 drivers/media/video/upd64083.c                             |    1 
 drivers/media/video/usbvideo/konicawc.c                    |    1 
 drivers/media/video/usbvideo/quickcam_messenger.c          |    1 
 drivers/media/video/usbvision/usbvision-core.c             |    2 
 drivers/media/video/usbvision/usbvision-i2c.c              |    1 
 drivers/media/video/uvc/uvc_ctrl.c                         |    1 
 drivers/media/video/uvc/uvc_driver.c                       |    1 
 drivers/media/video/uvc/uvc_status.c                       |    1 
 drivers/media/video/uvc/uvc_v4l2.c                         |    1 
 drivers/media/video/uvc/uvc_video.c                        |    1 
 drivers/media/video/v4l2-ioctl.c                           |    1 
 drivers/media/video/videobuf-dma-contig.c                  |    1 
 drivers/media/video/videobuf-dvb.c                         |    1 
 drivers/media/video/vino.c                                 |    1 
 drivers/media/video/vp27smpx.c                             |    1 
 drivers/media/video/vpx3220.c                              |    1 
 drivers/media/video/w9966.c                                |    1 
 drivers/media/video/wm8739.c                               |    1 
 drivers/media/video/wm8775.c                               |    1 
 drivers/media/video/zoran/zoran_card.c                     |    1 
 drivers/memstick/core/memstick.c                           |    1 
 drivers/memstick/core/mspro_block.c                        |    1 
 drivers/memstick/host/jmb38x_ms.c                          |    1 
 drivers/message/fusion/mptfc.c                             |    1 
 drivers/message/fusion/mptlan.c                            |    1 
 drivers/message/fusion/mptsas.c                            |    1 
 drivers/message/fusion/mptscsih.c                          |    1 
 drivers/message/fusion/mptspi.c                            |    1 
 drivers/message/i2o/i2o_block.c                            |    1 
 drivers/message/i2o/i2o_config.c                           |    1 
 drivers/message/i2o/i2o_proc.c                             |    1 
 drivers/message/i2o/iop.c                                  |    1 
 drivers/message/i2o/pci.c                                  |    1 
 drivers/mfd/88pm860x-i2c.c                                 |    1 
 drivers/mfd/ab3100-core.c                                  |    1 
 drivers/mfd/ab3100-otp.c                                   |    1 
 drivers/mfd/ab4500-core.c                                  |    1 
 drivers/mfd/adp5520.c                                      |    1 
 drivers/mfd/asic3.c                                        |    1 
 drivers/mfd/da903x.c                                       |    1 
 drivers/mfd/ezx-pcap.c                                     |    1 
 drivers/mfd/htc-egpio.c                                    |    1 
 drivers/mfd/htc-i2cpld.c                                   |    1 
 drivers/mfd/htc-pasic3.c                                   |    1 
 drivers/mfd/max8925-i2c.c                                  |    1 
 drivers/mfd/mc13783-core.c                                 |    1 
 drivers/mfd/mcp-sa11x0.c                                   |    1 
 drivers/mfd/menelaus.c                                     |    1 
 drivers/mfd/mfd-core.c                                     |    1 
 drivers/mfd/pcf50633-adc.c                                 |    1 
 drivers/mfd/pcf50633-core.c                                |    1 
 drivers/mfd/sh_mobile_sdhi.c                               |    1 
 drivers/mfd/sm501.c                                        |    1 
 drivers/mfd/t7l66xb.c                                      |    1 
 drivers/mfd/tc6387xb.c                                     |    1 
 drivers/mfd/tc6393xb.c                                     |    1 
 drivers/mfd/timberdale.c                                   |    1 
 drivers/mfd/twl4030-codec.c                                |    1 
 drivers/mfd/twl4030-irq.c                                  |    1 
 drivers/mfd/ucb1400_core.c                                 |    1 
 drivers/mfd/wm831x-core.c                                  |    1 
 drivers/mfd/wm8350-core.c                                  |    1 
 drivers/mfd/wm8350-i2c.c                                   |    1 
 drivers/mfd/wm8400-core.c                                  |    1 
 drivers/mfd/wm8994-core.c                                  |    1 
 drivers/misc/atmel-ssc.c                                   |    1 
 drivers/misc/atmel_pwm.c                                   |    1 
 drivers/misc/atmel_tclib.c                                 |    1 
 drivers/misc/c2port/core.c                                 |    1 
 drivers/misc/cb710/core.c                                  |    2 
 drivers/misc/cb710/debug.c                                 |    1 
 drivers/misc/cs5535-mfgpt.c                                |    1 
 drivers/misc/ds1682.c                                      |    1 
 drivers/misc/enclosure.c                                   |    1 
 drivers/misc/ep93xx_pwm.c                                  |    1 
 drivers/misc/hpilo.c                                       |    1 
 drivers/misc/ibmasm/command.c                              |    1 
 drivers/misc/ibmasm/event.c                                |    1 
 drivers/misc/ibmasm/ibmasmfs.c                             |    1 
 drivers/misc/ibmasm/module.c                               |    1 
 drivers/misc/ics932s401.c                                  |    1 
 drivers/misc/ioc4.c                                        |    1 
 drivers/misc/iwmc3200top/debugfs.c                         |    1 
 drivers/misc/iwmc3200top/fw-download.c                     |    1 
 drivers/misc/iwmc3200top/log.c                             |    1 
 drivers/misc/iwmc3200top/main.c                            |    1 
 drivers/misc/kgdbts.c                                      |    6 
 drivers/misc/lkdtm.c                                       |    1 
 drivers/misc/phantom.c                                     |    1 
 drivers/misc/sgi-xp/xpc_main.c                             |    1 
 drivers/misc/sgi-xp/xpc_partition.c                        |    1 
 drivers/misc/sgi-xp/xpc_sn2.c                              |    1 
 drivers/misc/sgi-xp/xpc_uv.c                               |    1 
 drivers/misc/sgi-xp/xpnet.c                                |    1 
 drivers/misc/tifm_core.c                                   |    1 
 drivers/mmc/card/block.c                                   |    1 
 drivers/mmc/card/mmc_test.c                                |    1 
 drivers/mmc/card/queue.c                                   |    1 
 drivers/mmc/card/sdio_uart.c                               |    2 
 drivers/mmc/core/bus.c                                     |    1 
 drivers/mmc/core/debugfs.c                                 |    1 
 drivers/mmc/core/host.c                                    |    1 
 drivers/mmc/core/mmc.c                                     |    1 
 drivers/mmc/core/mmc_ops.c                                 |    1 
 drivers/mmc/core/sd.c                                      |    1 
 drivers/mmc/core/sdio_bus.c                                |    1 
 drivers/mmc/core/sdio_cis.c                                |    1 
 drivers/mmc/host/at91_mci.c                                |    1 
 drivers/mmc/host/atmel-mci.c                               |    1 
 drivers/mmc/host/au1xmmc.c                                 |    1 
 drivers/mmc/host/bfin_sdh.c                                |    1 
 drivers/mmc/host/cb710-mmc.c                               |    1 
 drivers/mmc/host/mmc_spi.c                                 |    1 
 drivers/mmc/host/msm_sdcc.c                                |    1 
 drivers/mmc/host/of_mmc_spi.c                              |    1 
 drivers/mmc/host/omap.c                                    |    1 
 drivers/mmc/host/omap_hsmmc.c                              |    9 
 drivers/mmc/host/pxamci.c                                  |    1 
 drivers/mmc/host/sdhci-pci.c                               |    1 
 drivers/mmc/host/sdhci-s3c.c                               |    1 
 drivers/mmc/host/sdhci.c                                   |    1 
 drivers/mmc/host/wbsd.c                                    |    1 
 drivers/mtd/devices/block2mtd.c                            |    1 
 drivers/mtd/devices/m25p80.c                               |    1 
 drivers/mtd/devices/sst25l.c                               |    1 
 drivers/mtd/lpddr/lpddr_cmds.c                             |    1 
 drivers/mtd/maps/amd76xrom.c                               |    1 
 drivers/mtd/maps/bfin-async-flash.c                        |    1 
 drivers/mtd/maps/ck804xrom.c                               |    1 
 drivers/mtd/maps/esb2rom.c                                 |    1 
 drivers/mtd/maps/gpio-addr-flash.c                         |    1 
 drivers/mtd/maps/ichxrom.c                                 |    1 
 drivers/mtd/maps/intel_vr_nor.c                            |    1 
 drivers/mtd/maps/octagon-5066.c                            |    1 
 drivers/mtd/maps/physmap_of.c                              |    1 
 drivers/mtd/maps/pismo.c                                   |    1 
 drivers/mtd/maps/pmcmsp-flash.c                            |    1 
 drivers/mtd/maps/pxa2xx-flash.c                            |    1 
 drivers/mtd/maps/sbc_gxx.c                                 |    1 
 drivers/mtd/maps/sun_uflash.c                              |    1 
 drivers/mtd/maps/vmax301.c                                 |    1 
 drivers/mtd/maps/vmu-flash.c                               |    1 
 drivers/mtd/mtdcore.c                                      |    1 
 drivers/mtd/nand/bcm_umi_nand.c                            |    1 
 drivers/mtd/nand/cafe_nand.c                               |    1 
 drivers/mtd/nand/cmx270_nand.c                             |    1 
 drivers/mtd/nand/davinci_nand.c                            |    1 
 drivers/mtd/nand/diskonchip.c                              |    1 
 drivers/mtd/nand/fsl_upm.c                                 |    1 
 drivers/mtd/nand/ndfc.c                                    |    1 
 drivers/mtd/nand/nomadik_nand.c                            |    1 
 drivers/mtd/nand/omap2.c                                   |    1 
 drivers/mtd/nand/pxa3xx_nand.c                             |    1 
 drivers/mtd/nand/sh_flctl.c                                |    1 
 drivers/mtd/nand/tmio_nand.c                               |    1 
 drivers/mtd/ofpart.c                                       |    1 
 drivers/mtd/onenand/omap2.c                                |    1 
 drivers/mtd/onenand/onenand_base.c                         |    1 
 drivers/mtd/onenand/onenand_sim.c                          |    1 
 drivers/mtd/tests/mtd_nandecctest.c                        |    1 
 drivers/mtd/tests/mtd_oobtest.c                            |    1 
 drivers/mtd/tests/mtd_pagetest.c                           |    1 
 drivers/mtd/tests/mtd_readtest.c                           |    1 
 drivers/mtd/tests/mtd_speedtest.c                          |    1 
 drivers/mtd/tests/mtd_stresstest.c                         |    1 
 drivers/mtd/tests/mtd_subpagetest.c                        |    1 
 drivers/mtd/tests/mtd_torturetest.c                        |    1 
 drivers/mtd/ubi/build.c                                    |    1 
 drivers/mtd/ubi/cdev.c                                     |    1 
 drivers/mtd/ubi/gluebi.c                                   |    1 
 drivers/mtd/ubi/io.c                                       |    1 
 drivers/mtd/ubi/kapi.c                                     |    1 
 drivers/mtd/ubi/scan.c                                     |    1 
 drivers/mtd/ubi/ubi.h                                      |    1 
 drivers/mtd/ubi/vmt.c                                      |    1 
 drivers/mtd/ubi/vtbl.c                                     |    1 
 drivers/net/3c501.c                                        |    1 
 drivers/net/3c505.c                                        |    2 
 drivers/net/3c507.c                                        |    1 
 drivers/net/3c509.c                                        |    1 
 drivers/net/3c515.c                                        |    1 
 drivers/net/3c523.c                                        |    1 
 drivers/net/3c59x.c                                        |    2 
 drivers/net/7990.c                                         |    1 
 drivers/net/8139cp.c                                       |    1 
 drivers/net/8139too.c                                      |    1 
 drivers/net/82596.c                                        |    2 
 drivers/net/Kconfig                                        |   25 
 drivers/net/Makefile                                       |    1 
 drivers/net/a2065.c                                        |    1 
 drivers/net/acenic.c                                       |    1 
 drivers/net/amd8111e.c                                     |    1 
 drivers/net/appletalk/cops.c                               |    1 
 drivers/net/appletalk/ipddp.c                              |    1 
 drivers/net/appletalk/ltpc.c                               |    2 
 drivers/net/arcnet/arc-rawmode.c                           |    1 
 drivers/net/arcnet/arc-rimi.c                              |    1 
 drivers/net/arcnet/capmode.c                               |    1 
 drivers/net/arcnet/com20020-isa.c                          |    1 
 drivers/net/arcnet/com20020-pci.c                          |    1 
 drivers/net/arcnet/com20020.c                              |    1 
 drivers/net/arcnet/com90io.c                               |    1 
 drivers/net/arcnet/com90xx.c                               |    1 
 drivers/net/arcnet/rfc1051.c                               |    1 
 drivers/net/arcnet/rfc1201.c                               |    1 
 drivers/net/ariadne.c                                      |    1 
 drivers/net/arm/at91_ether.c                               |    1 
 drivers/net/arm/ep93xx_eth.c                               |    1 
 drivers/net/arm/etherh.c                                   |    1 
 drivers/net/arm/ixp4xx_eth.c                               |    1 
 drivers/net/arm/ks8695net.c                                |    1 
 drivers/net/arm/w90p910_ether.c                            |    1 
 drivers/net/at1700.c                                       |    1 
 drivers/net/atarilance.c                                   |    1 
 drivers/net/atl1c/atl1c_ethtool.c                          |    1 
 drivers/net/atl1e/atl1e_ethtool.c                          |    1 
 drivers/net/atlx/atl2.c                                    |    1 
 drivers/net/atp.c                                          |    1 
 drivers/net/ax88796.c                                      |    1 
 drivers/net/b44.c                                          |    1 
 drivers/net/bcm63xx_enet.c                                 |    1 
 drivers/net/benet/be.h                                     |    1 
 drivers/net/benet/be_cmds.c                                |    4 
 drivers/net/benet/be_main.c                                |   21 
 drivers/net/bmac.c                                         |    1 
 drivers/net/bonding/bond_main.c                            |   28 
 drivers/net/can/dev.c                                      |    1 
 drivers/net/can/mcp251x.c                                  |    1 
 drivers/net/can/sja1000/ems_pci.c                          |    1 
 drivers/net/can/sja1000/plx_pci.c                          |    1 
 drivers/net/can/vcan.c                                     |    1 
 drivers/net/chelsio/common.h                               |    1 
 drivers/net/chelsio/pm3393.c                               |    1 
 drivers/net/chelsio/sge.c                                  |    1 
 drivers/net/cris/eth_v10.c                                 |    1 
 drivers/net/cs89x0.c                                       |    2 
 drivers/net/cxgb3/cxgb3_main.c                             |    1 
 drivers/net/cxgb3/cxgb3_offload.c                          |    1 
 drivers/net/cxgb3/l2t.c                                    |    1 
 drivers/net/cxgb3/sge.c                                    |    1 
 drivers/net/cxgb4/Makefile                                 |    7 
 drivers/net/cxgb4/cxgb4.h                                  |  741 ++
 drivers/net/cxgb4/cxgb4_main.c                             | 3388 +++++++++++++
 drivers/net/cxgb4/cxgb4_uld.h                              |  239 
 drivers/net/cxgb4/l2t.c                                    |  624 ++
 drivers/net/cxgb4/l2t.h                                    |  110 
 drivers/net/cxgb4/sge.c                                    | 2431 +++++++++
 drivers/net/cxgb4/t4_hw.c                                  | 3131 ++++++++++++
 drivers/net/cxgb4/t4_hw.h                                  |  100 
 drivers/net/cxgb4/t4_msg.h                                 |  664 ++
 drivers/net/cxgb4/t4_regs.h                                |  878 +++
 drivers/net/cxgb4/t4fw_api.h                               | 1580 ++++++
 drivers/net/dm9000.c                                       |    1 
 drivers/net/e1000e/ethtool.c                               |    1 
 drivers/net/e1000e/netdev.c                                |    1 
 drivers/net/eepro.c                                        |    1 
 drivers/net/eexpress.c                                     |    1 
 drivers/net/ehea/ehea_main.c                               |    1 
 drivers/net/ehea/ehea_qmr.c                                |    1 
 drivers/net/enc28j60.c                                     |    1 
 drivers/net/enic/vnic_dev.c                                |    1 
 drivers/net/enic/vnic_rq.c                                 |    1 
 drivers/net/enic/vnic_wq.c                                 |    1 
 drivers/net/epic100.c                                      |    1 
 drivers/net/eql.c                                          |    1 
 drivers/net/eth16i.c                                       |    1 
 drivers/net/ethoc.c                                        |    1 
 drivers/net/fealnx.c                                       |    1 
 drivers/net/fec_mpc52xx.c                                  |    1 
 drivers/net/fec_mpc52xx_phy.c                              |    1 
 drivers/net/forcedeth.c                                    |    1 
 drivers/net/fs_enet/mac-fcc.c                              |    2 
 drivers/net/fs_enet/mac-fec.c                              |    2 
 drivers/net/fs_enet/mac-scc.c                              |    1 
 drivers/net/gianfar.c                                      |   12 
 drivers/net/gianfar_ethtool.c                              |    1 
 drivers/net/gianfar_sysfs.c                                |    1 
 drivers/net/greth.c                                        |    1 
 drivers/net/hamachi.c                                      |    1 
 drivers/net/hamradio/6pack.c                               |    1 
 drivers/net/hamradio/bpqether.c                            |    1 
 drivers/net/hamradio/dmascc.c                              |    1 
 drivers/net/hamradio/hdlcdrv.c                             |    1 
 drivers/net/hamradio/mkiss.c                               |    1 
 drivers/net/hamradio/scc.c                                 |    1 
 drivers/net/hp100.c                                        |    1 
 drivers/net/hplance.c                                      |    1 
 drivers/net/hydra.c                                        |    1 
 drivers/net/ibm_newemac/core.c                             |    1 
 drivers/net/ibm_newemac/core.h                             |    1 
 drivers/net/ibm_newemac/mal.c                              |    1 
 drivers/net/ibm_newemac/rgmii.c                            |    1 
 drivers/net/ibm_newemac/zmii.c                             |    1 
 drivers/net/ibmlana.c                                      |    1 
 drivers/net/ibmveth.c                                      |    1 
 drivers/net/igb/e1000_82575.c                              |    1 
 drivers/net/igb/igb_ethtool.c                              |    1 
 drivers/net/igb/igb_main.c                                 |    1 
 drivers/net/igbvf/netdev.c                                 |    1 
 drivers/net/ioc3-eth.c                                     |    1 
 drivers/net/ipg.c                                          |    1 
 drivers/net/irda/ali-ircc.c                                |    2 
 drivers/net/irda/bfin_sir.h                                |    1 
 drivers/net/irda/irtty-sir.c                               |    1 
 drivers/net/irda/nsc-ircc.c                                |    2 
 drivers/net/irda/pxaficp_ir.c                              |    1 
 drivers/net/irda/sh_sir.c                                  |    1 
 drivers/net/irda/sir_dev.c                                 |    1 
 drivers/net/irda/smsc-ircc2.c                              |    2 
 drivers/net/irda/via-ircc.c                                |    2 
 drivers/net/irda/w83977af_ir.c                             |    2 
 drivers/net/iseries_veth.c                                 |    1 
 drivers/net/ixgbe/ixgbe_ethtool.c                          |    1 
 drivers/net/ixgbe/ixgbe_fcoe.c                             |    1 
 drivers/net/ixgbe/ixgbe_main.c                             |    1 
 drivers/net/ixgbevf/ethtool.c                              |    1 
 drivers/net/ixgbevf/ixgbevf_main.c                         |    1 
 drivers/net/ixp2000/ixpdev.c                               |    1 
 drivers/net/jazzsonic.c                                    |    3 
 drivers/net/jme.c                                          |    1 
 drivers/net/ks8851_mll.c                                   |    1 
 drivers/net/ksz884x.c                                      |    1 
 drivers/net/lasi_82596.c                                   |    1 
 drivers/net/lib82596.c                                     |    2 
 drivers/net/ll_temac_main.c                                |    1 
 drivers/net/ll_temac_mdio.c                                |    1 
 drivers/net/mac8390.c                                      |    1 
 drivers/net/mac89x0.c                                      |    2 
 drivers/net/mace.c                                         |    1 
 drivers/net/macmace.c                                      |    1 
 drivers/net/macsonic.c                                     |    3 
 drivers/net/macvtap.c                                      |    1 
 drivers/net/mlx4/cmd.c                                     |    1 
 drivers/net/mlx4/cq.c                                      |    1 
 drivers/net/mlx4/en_main.c                                 |    1 
 drivers/net/mlx4/en_netdev.c                               |    1 
 drivers/net/mlx4/en_resources.c                            |    1 
 drivers/net/mlx4/en_rx.c                                   |    1 
 drivers/net/mlx4/en_tx.c                                   |    1 
 drivers/net/mlx4/eq.c                                      |    1 
 drivers/net/mlx4/icm.c                                     |    1 
 drivers/net/mlx4/intf.c                                    |    2 
 drivers/net/mlx4/main.c                                    |    1 
 drivers/net/mlx4/mcg.c                                     |    1 
 drivers/net/mlx4/mr.c                                      |    1 
 drivers/net/mlx4/profile.c                                 |    2 
 drivers/net/mlx4/qp.c                                      |    1 
 drivers/net/mlx4/srq.c                                     |    1 
 drivers/net/mv643xx_eth.c                                  |    1 
 drivers/net/mvme147.c                                      |    2 
 drivers/net/myri10ge/myri10ge.c                            |    1 
 drivers/net/myri_sbus.c                                    |    2 
 drivers/net/ne2.c                                          |    1 
 drivers/net/netconsole.c                                   |    1 
 drivers/net/netxen/netxen_nic_hw.c                         |    1 
 drivers/net/netxen/netxen_nic_init.c                       |    1 
 drivers/net/netxen/netxen_nic_main.c                       |    1 
 drivers/net/ni5010.c                                       |    1 
 drivers/net/ni52.c                                         |    1 
 drivers/net/niu.c                                          |    1 
 drivers/net/ns83820.c                                      |    1 
 drivers/net/octeon/octeon_mgmt.c                           |    1 
 drivers/net/pasemi_mac.c                                   |    1 
 drivers/net/pcmcia/axnet_cs.c                              |    1 
 drivers/net/pcmcia/pcnet_cs.c                              |    1 
 drivers/net/pcmcia/smc91c92_cs.c                           |   12 
 drivers/net/phy/cicada.c                                   |    1 
 drivers/net/phy/davicom.c                                  |    1 
 drivers/net/phy/et1011c.c                                  |    1 
 drivers/net/phy/fixed.c                                    |    1 
 drivers/net/phy/icplus.c                                   |    1 
 drivers/net/phy/lxt.c                                      |    1 
 drivers/net/phy/marvell.c                                  |    1 
 drivers/net/phy/mdio-bitbang.c                             |    1 
 drivers/net/phy/mdio-octeon.c                              |    1 
 drivers/net/phy/phy.c                                      |    1 
 drivers/net/phy/qsemi.c                                    |    1 
 drivers/net/plip.c                                         |    1 
 drivers/net/ppp_async.c                                    |    1 
 drivers/net/ppp_generic.c                                  |    1 
 drivers/net/ppp_synctty.c                                  |    1 
 drivers/net/pppox.c                                        |    1 
 drivers/net/ps3_gelic_net.c                                |    1 
 drivers/net/ps3_gelic_wireless.c                           |    1 
 drivers/net/qlcnic/qlcnic_hw.c                             |    1 
 drivers/net/qlcnic/qlcnic_init.c                           |    1 
 drivers/net/qlcnic/qlcnic_main.c                           |    1 
 drivers/net/qlge/qlge_dbg.c                                |    2 
 drivers/net/qlge/qlge_ethtool.c                            |    1 
 drivers/net/r6040.c                                        |    1 
 drivers/net/r8169.c                                        |    4 
 drivers/net/rionet.c                                       |    1 
 drivers/net/rrunner.c                                      |    1 
 drivers/net/s2io.c                                         |    1 
 drivers/net/sb1000.c                                       |    2 
 drivers/net/seeq8005.c                                     |    1 
 drivers/net/sfc/efx.c                                      |    1 
 drivers/net/sfc/falcon.c                                   |    1 
 drivers/net/sfc/mcdi_phy.c                                 |    1 
 drivers/net/sfc/mtd.c                                      |    1 
 drivers/net/sfc/qt202x_phy.c                               |    1 
 drivers/net/sfc/rx.c                                       |    1 
 drivers/net/sfc/selftest.c                                 |    1 
 drivers/net/sfc/siena.c                                    |    1 
 drivers/net/sfc/tenxpress.c                                |    1 
 drivers/net/sfc/tx.c                                       |    1 
 drivers/net/sgiseeq.c                                      |    5 
 drivers/net/sh_eth.c                                       |    1 
 drivers/net/sis190.c                                       |    1 
 drivers/net/skfp/skfddi.c                                  |    2 
 drivers/net/skge.c                                         |    1 
 drivers/net/sky2.c                                         |    1 
 drivers/net/slhc.c                                         |    1 
 drivers/net/slip.c                                         |    1 
 drivers/net/smc911x.c                                      |    1 
 drivers/net/smc9194.c                                      |    1 
 drivers/net/smc91x.c                                       |    1 
 drivers/net/smsc911x.c                                     |    1 
 drivers/net/smsc9420.c                                     |    1 
 drivers/net/sni_82596.c                                    |    1 
 drivers/net/spider_net.c                                   |    2 
 drivers/net/stmmac/Kconfig                                 |    1 
 drivers/net/stmmac/dwmac100.c                              |    1 
 drivers/net/stmmac/dwmac1000_core.c                        |    1 
 drivers/net/stmmac/stmmac_main.c                           |    1 
 drivers/net/stmmac/stmmac_mdio.c                           |    1 
 drivers/net/sun3_82586.c                                   |    1 
 drivers/net/sun3lance.c                                    |    1 
 drivers/net/sunbmac.c                                      |    2 
 drivers/net/sundance.c                                     |    1 
 drivers/net/sungem.c                                       |    2 
 drivers/net/sunlance.c                                     |    2 
 drivers/net/tehuti.h                                       |    1 
 drivers/net/tokenring/3c359.c                              |    1 
 drivers/net/tokenring/lanstreamer.c                        |    1 
 drivers/net/tokenring/madgemc.c                            |    1 
 drivers/net/tokenring/smctr.c                              |    1 
 drivers/net/tokenring/tms380tr.c                           |    1 
 drivers/net/tsi108_eth.c                                   |    2 
 drivers/net/tulip/de2104x.c                                |    1 
 drivers/net/tulip/de4x5.c                                  |    2 
 drivers/net/tulip/dmfe.c                                   |    1 
 drivers/net/tulip/eeprom.c                                 |    1 
 drivers/net/tulip/tulip_core.c                             |    1 
 drivers/net/tulip/uli526x.c                                |    1 
 drivers/net/tulip/winbond-840.c                            |    1 
 drivers/net/typhoon.c                                      |    1 
 drivers/net/ucc_geth_ethtool.c                             |    1 
 drivers/net/usb/asix.c                                     |    1 
 drivers/net/usb/catc.c                                     |    2 
 drivers/net/usb/cdc-phonet.c                               |    1 
 drivers/net/usb/cdc_eem.c                                  |    1 
 drivers/net/usb/dm9601.c                                   |    1 
 drivers/net/usb/gl620a.c                                   |    1 
 drivers/net/usb/int51x1.c                                  |    1 
 drivers/net/usb/mcs7830.c                                  |    1 
 drivers/net/usb/net1080.c                                  |    1 
 drivers/net/usb/rndis_host.c                               |    1 
 drivers/net/usb/smsc75xx.c                                 |    1 
 drivers/net/usb/smsc95xx.c                                 |    1 
 drivers/net/usb/usbnet.c                                   |    1 
 drivers/net/veth.c                                         |    1 
 drivers/net/via-rhine.c                                    |    1 
 drivers/net/virtio_net.c                                   |    1 
 drivers/net/vxge/vxge-config.c                             |    1 
 drivers/net/vxge/vxge-config.h                             |    1 
 drivers/net/vxge/vxge-ethtool.c                            |    1 
 drivers/net/vxge/vxge-main.c                               |    1 
 drivers/net/wan/dscc4.c                                    |    1 
 drivers/net/wan/farsync.c                                  |    1 
 drivers/net/wan/hd64570.c                                  |    1 
 drivers/net/wan/hd64572.c                                  |    1 
 drivers/net/wan/hdlc_cisco.c                               |    1 
 drivers/net/wan/hdlc_raw.c                                 |    1 
 drivers/net/wan/hdlc_raw_eth.c                             |    2 
 drivers/net/wan/hdlc_x25.c                                 |    2 
 drivers/net/wan/hostess_sv11.c                             |    1 
 drivers/net/wan/ixp4xx_hss.c                               |    1 
 drivers/net/wan/lapbether.c                                |    1 
 drivers/net/wan/lmc/lmc_media.c                            |    1 
 drivers/net/wan/lmc/lmc_proto.c                            |    1 
 drivers/net/wan/pc300_drv.c                                |    1 
 drivers/net/wan/sbni.c                                     |    1 
 drivers/net/wan/sealevel.c                                 |    1 
 drivers/net/wan/x25_asy.c                                  |    1 
 drivers/net/wan/z85230.c                                   |    1 
 drivers/net/wimax/i2400m/control.c                         |    1 
 drivers/net/wimax/i2400m/driver.c                          |    1 
 drivers/net/wimax/i2400m/fw.c                              |    1 
 drivers/net/wimax/i2400m/netdev.c                          |    1 
 drivers/net/wimax/i2400m/op-rfkill.c                       |    1 
 drivers/net/wimax/i2400m/rx.c                              |    1 
 drivers/net/wimax/i2400m/sdio-rx.c                         |    1 
 drivers/net/wimax/i2400m/sdio.c                            |    1 
 drivers/net/wimax/i2400m/tx.c                              |    1 
 drivers/net/wimax/i2400m/usb-fw.c                          |    1 
 drivers/net/wimax/i2400m/usb-notif.c                       |    1 
 drivers/net/wimax/i2400m/usb-rx.c                          |    1 
 drivers/net/wimax/i2400m/usb.c                             |    1 
 drivers/net/wireless/adm8211.c                             |    1 
 drivers/net/wireless/ath/ar9170/main.c                     |    1 
 drivers/net/wireless/ath/ar9170/usb.c                      |    5 
 drivers/net/wireless/ath/ath5k/attach.c                    |    1 
 drivers/net/wireless/ath/ath5k/base.c                      |    1 
 drivers/net/wireless/ath/ath5k/eeprom.c                    |    2 
 drivers/net/wireless/ath/ath5k/phy.c                       |    1 
 drivers/net/wireless/ath/ath9k/debug.c                     |    1 
 drivers/net/wireless/ath/ath9k/hw.c                        |    1 
 drivers/net/wireless/ath/ath9k/init.c                      |    2 
 drivers/net/wireless/ath/ath9k/phy.c                       |    2 
 drivers/net/wireless/ath/ath9k/rc.c                        |    2 
 drivers/net/wireless/ath/ath9k/virtual.c                   |    2 
 drivers/net/wireless/ath/regd.c                            |    1 
 drivers/net/wireless/b43/dma.c                             |    1 
 drivers/net/wireless/b43/lo.c                              |    1 
 drivers/net/wireless/b43/main.c                            |    1 
 drivers/net/wireless/b43/pcmcia.c                          |    1 
 drivers/net/wireless/b43/phy_a.c                           |    2 
 drivers/net/wireless/b43/phy_g.c                           |    1 
 drivers/net/wireless/b43/phy_lp.c                          |    2 
 drivers/net/wireless/b43/phy_n.c                           |    1 
 drivers/net/wireless/b43/pio.c                             |    1 
 drivers/net/wireless/b43/sdio.c                            |    1 
 drivers/net/wireless/b43legacy/dma.c                       |    1 
 drivers/net/wireless/b43legacy/main.c                      |    1 
 drivers/net/wireless/b43legacy/phy.c                       |    1 
 drivers/net/wireless/b43legacy/pio.c                       |    1 
 drivers/net/wireless/hostap/hostap_80211_rx.c              |    1 
 drivers/net/wireless/hostap/hostap_80211_tx.c              |    2 
 drivers/net/wireless/hostap/hostap_ap.c                    |    1 
 drivers/net/wireless/hostap/hostap_cs.c                    |    1 
 drivers/net/wireless/hostap/hostap_info.c                  |    1 
 drivers/net/wireless/hostap/hostap_ioctl.c                 |    1 
 drivers/net/wireless/hostap/hostap_pci.c                   |    1 
 drivers/net/wireless/hostap/hostap_plx.c                   |    1 
 drivers/net/wireless/ipw2x00/ipw2200.c                     |    1 
 drivers/net/wireless/ipw2x00/libipw_geo.c                  |    1 
 drivers/net/wireless/ipw2x00/libipw_rx.c                   |    2 
 drivers/net/wireless/ipw2x00/libipw_wx.c                   |    1 
 drivers/net/wireless/iwlwifi/iwl-3945-rs.c                 |    1 
 drivers/net/wireless/iwlwifi/iwl-3945.c                    |    1 
 drivers/net/wireless/iwlwifi/iwl-4965.c                    |    6 
 drivers/net/wireless/iwlwifi/iwl-agn-rs.c                  |    1 
 drivers/net/wireless/iwlwifi/iwl-agn.c                     |   13 
 drivers/net/wireless/iwlwifi/iwl-calib.c                   |    1 
 drivers/net/wireless/iwlwifi/iwl-core.c                    |    1 
 drivers/net/wireless/iwlwifi/iwl-debugfs.c                 |    1 
 drivers/net/wireless/iwlwifi/iwl-devtrace.c                |    2 
 drivers/net/wireless/iwlwifi/iwl-devtrace.h                |    1 
 drivers/net/wireless/iwlwifi/iwl-eeprom.c                  |    1 
 drivers/net/wireless/iwlwifi/iwl-io.h                      |    1 
 drivers/net/wireless/iwlwifi/iwl-power.c                   |    1 
 drivers/net/wireless/iwlwifi/iwl-rx.c                      |    1 
 drivers/net/wireless/iwlwifi/iwl-scan.c                    |    1 
 drivers/net/wireless/iwlwifi/iwl-tx.c                      |    1 
 drivers/net/wireless/iwlwifi/iwl3945-base.c                |    5 
 drivers/net/wireless/iwmc3200wifi/cfg80211.c               |    1 
 drivers/net/wireless/iwmc3200wifi/commands.c               |    1 
 drivers/net/wireless/iwmc3200wifi/debugfs.c                |    1 
 drivers/net/wireless/iwmc3200wifi/eeprom.c                 |    1 
 drivers/net/wireless/iwmc3200wifi/hal.c                    |    1 
 drivers/net/wireless/iwmc3200wifi/main.c                   |    1 
 drivers/net/wireless/iwmc3200wifi/netdev.c                 |    1 
 drivers/net/wireless/iwmc3200wifi/rx.c                     |    1 
 drivers/net/wireless/iwmc3200wifi/sdio.c                   |    1 
 drivers/net/wireless/iwmc3200wifi/tx.c                     |    1 
 drivers/net/wireless/libertas/assoc.c                      |    1 
 drivers/net/wireless/libertas/cfg.c                        |    9 
 drivers/net/wireless/libertas/cmd.c                        |    1 
 drivers/net/wireless/libertas/cmdresp.c                    |    1 
 drivers/net/wireless/libertas/debugfs.c                    |    1 
 drivers/net/wireless/libertas/dev.h                        |    1 
 drivers/net/wireless/libertas/if_cs.c                      |    1 
 drivers/net/wireless/libertas/if_sdio.c                    |    1 
 drivers/net/wireless/libertas/if_spi.c                     |    1 
 drivers/net/wireless/libertas/if_usb.c                     |    1 
 drivers/net/wireless/libertas/main.c                       |    1 
 drivers/net/wireless/libertas/rx.c                         |    1 
 drivers/net/wireless/libertas/scan.c                       |    1 
 drivers/net/wireless/libertas/wext.c                       |    1 
 drivers/net/wireless/libertas_tf/cmd.c                     |    2 
 drivers/net/wireless/libertas_tf/if_usb.c                  |    1 
 drivers/net/wireless/libertas_tf/main.c                    |    2 
 drivers/net/wireless/mac80211_hwsim.c                      |    1 
 drivers/net/wireless/mwl8k.c                               |    2 
 drivers/net/wireless/orinoco/fw.c                          |    1 
 drivers/net/wireless/orinoco/main.c                        |    1 
 drivers/net/wireless/orinoco/scan.c                        |    1 
 drivers/net/wireless/orinoco/wext.c                        |    1 
 drivers/net/wireless/p54/eeprom.c                          |    1 
 drivers/net/wireless/p54/fwio.c                            |    1 
 drivers/net/wireless/p54/main.c                            |    1 
 drivers/net/wireless/p54/p54pci.c                          |    1 
 drivers/net/wireless/p54/p54spi.c                          |    1 
 drivers/net/wireless/p54/p54usb.c                          |    2 
 drivers/net/wireless/prism54/isl_ioctl.c                   |    1 
 drivers/net/wireless/prism54/islpci_dev.c                  |    1 
 drivers/net/wireless/prism54/islpci_eth.c                  |    1 
 drivers/net/wireless/prism54/islpci_mgt.c                  |    1 
 drivers/net/wireless/prism54/islpci_mgt.h                  |    1 
 drivers/net/wireless/prism54/oid_mgt.c                     |    1 
 drivers/net/wireless/ray_cs.c                              |    1 
 drivers/net/wireless/rndis_wlan.c                          |    1 
 drivers/net/wireless/rt2x00/rt2400pci.c                    |    1 
 drivers/net/wireless/rt2x00/rt2500pci.c                    |    1 
 drivers/net/wireless/rt2x00/rt2500usb.c                    |    6 
 drivers/net/wireless/rt2x00/rt2800lib.c                    |    5 
 drivers/net/wireless/rt2x00/rt2x00debug.c                  |    1 
 drivers/net/wireless/rt2x00/rt2x00dev.c                    |    1 
 drivers/net/wireless/rt2x00/rt2x00pci.c                    |    1 
 drivers/net/wireless/rt2x00/rt2x00queue.c                  |    1 
 drivers/net/wireless/rt2x00/rt2x00soc.c                    |    1 
 drivers/net/wireless/rt2x00/rt2x00usb.c                    |    1 
 drivers/net/wireless/rt2x00/rt61pci.c                      |    1 
 drivers/net/wireless/rt2x00/rt73usb.c                      |    1 
 drivers/net/wireless/rtl818x/rtl8180_dev.c                 |    1 
 drivers/net/wireless/rtl818x/rtl8187_dev.c                 |    1 
 drivers/net/wireless/wl12xx/wl1251_acx.c                   |    1 
 drivers/net/wireless/wl12xx/wl1251_boot.c                  |    1 
 drivers/net/wireless/wl12xx/wl1251_cmd.c                   |    1 
 drivers/net/wireless/wl12xx/wl1251_debugfs.c               |    1 
 drivers/net/wireless/wl12xx/wl1251_init.c                  |    1 
 drivers/net/wireless/wl12xx/wl1251_main.c                  |    1 
 drivers/net/wireless/wl12xx/wl1251_rx.c                    |    1 
 drivers/net/wireless/wl12xx/wl1251_spi.c                   |    1 
 drivers/net/wireless/wl12xx/wl1271_acx.c                   |    1 
 drivers/net/wireless/wl12xx/wl1271_boot.c                  |    1 
 drivers/net/wireless/wl12xx/wl1271_cmd.c                   |    1 
 drivers/net/wireless/wl12xx/wl1271_debugfs.c               |    1 
 drivers/net/wireless/wl12xx/wl1271_init.c                  |    1 
 drivers/net/wireless/wl12xx/wl1271_main.c                  |    1 
 drivers/net/wireless/wl12xx/wl1271_rx.c                    |    2 
 drivers/net/wireless/wl12xx/wl1271_spi.c                   |    1 
 drivers/net/wireless/wl12xx/wl1271_testmode.c              |    1 
 drivers/net/wireless/zd1201.c                              |    1 
 drivers/net/wireless/zd1211rw/zd_chip.c                    |    1 
 drivers/net/wireless/zd1211rw/zd_mac.c                     |    1 
 drivers/net/wireless/zd1211rw/zd_rf_uw2453.c               |    1 
 drivers/net/wireless/zd1211rw/zd_usb.c                     |    1 
 drivers/net/xen-netfront.c                                 |    1 
 drivers/net/xilinx_emaclite.c                              |    1 
 drivers/net/xtsonic.c                                      |    3 
 drivers/net/yellowfin.c                                    |    1 
 drivers/net/znet.c                                         |    1 
 drivers/nubus/nubus.c                                      |    1 
 drivers/of/base.c                                          |    1 
 drivers/of/fdt.c                                           |    7 
 drivers/of/gpio.c                                          |    1 
 drivers/oprofile/buffer_sync.c                             |    1 
 drivers/parisc/asp.c                                       |    1 
 drivers/parisc/ccio-rm-dma.c                               |    1 
 drivers/parisc/gsc.c                                       |    1 
 drivers/parport/daisy.c                                    |    1 
 drivers/parport/parport_ax88796.c                          |    1 
 drivers/parport/parport_ip32.c                             |    1 
 drivers/parport/parport_serial.c                           |    1 
 drivers/parport/probe.c                                    |    1 
 drivers/pci/access.c                                       |    1 
 drivers/pci/bus.c                                          |    1 
 drivers/pci/dmar.c                                         |    1 
 drivers/pci/hotplug/acpi_pcihp.c                           |    1 
 drivers/pci/hotplug/acpiphp_glue.c                         |    1 
 drivers/pci/hotplug/acpiphp_ibm.c                          |    1 
 drivers/pci/hotplug/cpqphp_sysfs.c                         |    1 
 drivers/pci/hotplug/fakephp.c                              |    1 
 drivers/pci/hotplug/pci_hotplug_core.c                     |    1 
 drivers/pci/hotplug/pciehp_acpi.c                          |    1 
 drivers/pci/hotplug/pciehp_core.c                          |    1 
 drivers/pci/hotplug/pciehp_ctrl.c                          |    1 
 drivers/pci/hotplug/pciehp_hpc.c                           |    1 
 drivers/pci/hotplug/rpaphp_core.c                          |    1 
 drivers/pci/hotplug/sgi_hotplug.c                          |    1 
 drivers/pci/hotplug/shpchp_core.c                          |    1 
 drivers/pci/hotplug/shpchp_ctrl.c                          |    1 
 drivers/pci/htirq.c                                        |    1 
 drivers/pci/intr_remapping.c                               |    1 
 drivers/pci/ioapic.c                                       |    1 
 drivers/pci/iov.c                                          |    1 
 drivers/pci/msi.c                                          |    1 
 drivers/pci/pci-sysfs.c                                    |    1 
 drivers/pci/pci.c                                          |    1 
 drivers/pci/pcie/aer/aer_inject.c                          |    1 
 drivers/pci/pcie/aer/aerdrv.c                              |    1 
 drivers/pci/pcie/aer/aerdrv_core.c                         |    1 
 drivers/pci/pcie/pme/pcie_pme.c                            |    1 
 drivers/pci/pcie/portdrv_pci.c                             |    1 
 drivers/pci/proc.c                                         |    1 
 drivers/pci/quirks.c                                       |   36 
 drivers/pci/search.c                                       |    1 
 drivers/pci/slot.c                                         |    1 
 drivers/pcmcia/at91_cf.c                                   |    1 
 drivers/pcmcia/au1000_generic.c                            |    1 
 drivers/pcmcia/bcm63xx_pcmcia.c                            |    1 
 drivers/pcmcia/bfin_cf_pcmcia.c                            |    1 
 drivers/pcmcia/db1xxx_ss.c                                 |    1 
 drivers/pcmcia/ds.c                                        |    1 
 drivers/pcmcia/electra_cf.c                                |    1 
 drivers/pcmcia/i82365.c                                    |    1 
 drivers/pcmcia/m32r_cfc.c                                  |    1 
 drivers/pcmcia/m32r_pcc.c                                  |    1 
 drivers/pcmcia/m8xx_pcmcia.c                               |    1 
 drivers/pcmcia/omap_cf.c                                   |    1 
 drivers/pcmcia/pcmcia_ioctl.c                              |    1 
 drivers/pcmcia/pcmcia_resource.c                           |    1 
 drivers/pcmcia/pd6729.c                                    |    1 
 drivers/pcmcia/pxa2xx_base.c                               |    1 
 drivers/pcmcia/rsrc_mgr.c                                  |    1 
 drivers/pcmcia/rsrc_nonstatic.c                            |   31 
 drivers/pcmcia/sa1100_generic.c                            |    1 
 drivers/pcmcia/sa1111_generic.c                            |    1 
 drivers/pcmcia/sa11xx_base.c                               |    1 
 drivers/pcmcia/socket_sysfs.c                              |    1 
 drivers/pcmcia/tcic.c                                      |    1 
 drivers/pcmcia/xxs1500_ss.c                                |    1 
 drivers/pcmcia/yenta_socket.c                              |    1 
 drivers/platform/x86/Kconfig                               |   10 
 drivers/platform/x86/Makefile                              |    1 
 drivers/platform/x86/acer-wmi.c                            |    1 
 drivers/platform/x86/asus-laptop.c                         |    5 
 drivers/platform/x86/asus_acpi.c                           |    1 
 drivers/platform/x86/classmate-laptop.c                    |    1 
 drivers/platform/x86/dell-laptop.c                         |    1 
 drivers/platform/x86/dell-wmi.c                            |    1 
 drivers/platform/x86/eeepc-laptop.c                        |    1 
 drivers/platform/x86/eeepc-wmi.c                           |  158 
 drivers/platform/x86/fujitsu-laptop.c                      |    1 
 drivers/platform/x86/hp-wmi.c                              |    1 
 drivers/platform/x86/intel_menlow.c                        |    2 
 drivers/platform/x86/msi-wmi.c                             |    1 
 drivers/platform/x86/panasonic-laptop.c                    |    1 
 drivers/platform/x86/sony-laptop.c                         |    1 
 drivers/platform/x86/tc1100-wmi.c                          |    1 
 drivers/platform/x86/thinkpad_acpi.c                       |    1 
 drivers/platform/x86/topstar-laptop.c                      |    1 
 drivers/platform/x86/toshiba_acpi.c                        |    1 
 drivers/platform/x86/wmi.c                                 |    1 
 drivers/pnp/isapnp/core.c                                  |    1 
 drivers/pnp/manager.c                                      |    1 
 drivers/pnp/pnpacpi/core.c                                 |    1 
 drivers/pnp/pnpacpi/rsparser.c                             |   43 
 drivers/pnp/pnpbios/bioscalls.c                            |    1 
 drivers/pnp/pnpbios/rsparser.c                             |    1 
 drivers/pnp/resource.c                                     |    1 
 drivers/power/bq27x00_battery.c                            |    1 
 drivers/power/da9030_battery.c                             |    1 
 drivers/power/ds2760_battery.c                             |    1 
 drivers/power/ds2782_battery.c                             |    1 
 drivers/power/max17040_battery.c                           |    1 
 drivers/power/max8925_power.c                              |    1 
 drivers/power/pcf50633-charger.c                           |    1 
 drivers/power/pmu_battery.c                                |    1 
 drivers/power/power_supply_leds.c                          |    1 
 drivers/power/power_supply_sysfs.c                         |    1 
 drivers/power/wm831x_backup.c                              |    1 
 drivers/power/wm831x_power.c                               |    1 
 drivers/power/wm97xx_battery.c                             |    1 
 drivers/pps/kapi.c                                         |    1 
 drivers/ps3/ps3-lpm.c                                      |    1 
 drivers/ps3/ps3-vuart.c                                    |    1 
 drivers/ps3/ps3av.c                                        |    1 
 drivers/regulator/core.c                                   |    1 
 drivers/regulator/fixed.c                                  |    1 
 drivers/regulator/lp3971.c                                 |    1 
 drivers/regulator/max1586.c                                |    1 
 drivers/regulator/max8649.c                                |    1 
 drivers/regulator/max8660.c                                |    1 
 drivers/regulator/mc13783-regulator.c                      |    1 
 drivers/regulator/tps65023-regulator.c                     |    1 
 drivers/regulator/tps6507x-regulator.c                     |    1 
 drivers/regulator/userspace-consumer.c                     |    1 
 drivers/regulator/virtual.c                                |    1 
 drivers/regulator/wm831x-dcdc.c                            |    1 
 drivers/regulator/wm831x-isink.c                           |    1 
 drivers/regulator/wm831x-ldo.c                             |    1 
 drivers/regulator/wm8994-regulator.c                       |    1 
 drivers/rtc/class.c                                        |    1 
 drivers/rtc/rtc-at32ap700x.c                               |    1 
 drivers/rtc/rtc-at91sam9.c                                 |    1 
 drivers/rtc/rtc-bfin.c                                     |    1 
 drivers/rtc/rtc-bq4802.c                                   |    1 
 drivers/rtc/rtc-coh901331.c                                |    1 
 drivers/rtc/rtc-ds1216.c                                   |    1 
 drivers/rtc/rtc-ds1286.c                                   |    1 
 drivers/rtc/rtc-ds1305.c                                   |    1 
 drivers/rtc/rtc-ds1374.c                                   |    1 
 drivers/rtc/rtc-ds1390.c                                   |    1 
 drivers/rtc/rtc-ds1511.c                                   |    1 
 drivers/rtc/rtc-ds1553.c                                   |    1 
 drivers/rtc/rtc-ds1742.c                                   |    1 
 drivers/rtc/rtc-ep93xx.c                                   |    1 
 drivers/rtc/rtc-fm3130.c                                   |    1 
 drivers/rtc/rtc-m48t35.c                                   |    1 
 drivers/rtc/rtc-m48t59.c                                   |    1 
 drivers/rtc/rtc-max8925.c                                  |    1 
 drivers/rtc/rtc-mc13783.c                                  |    1 
 drivers/rtc/rtc-mpc5121.c                                  |    1 
 drivers/rtc/rtc-msm6242.c                                  |    1 
 drivers/rtc/rtc-mv.c                                       |    1 
 drivers/rtc/rtc-mxc.c                                      |   27 
 drivers/rtc/rtc-nuc900.c                                   |    1 
 drivers/rtc/rtc-pcap.c                                     |    1 
 drivers/rtc/rtc-pcf2123.c                                  |    1 
 drivers/rtc/rtc-pcf50633.c                                 |    1 
 drivers/rtc/rtc-pcf8563.c                                  |    1 
 drivers/rtc/rtc-pl030.c                                    |    1 
 drivers/rtc/rtc-pl031.c                                    |    1 
 drivers/rtc/rtc-pxa.c                                      |    1 
 drivers/rtc/rtc-rp5c01.c                                   |    1 
 drivers/rtc/rtc-rs5c348.c                                  |    1 
 drivers/rtc/rtc-rs5c372.c                                  |    1 
 drivers/rtc/rtc-rx8025.c                                   |    1 
 drivers/rtc/rtc-s3c.c                                      |    1 
 drivers/rtc/rtc-sh.c                                       |    1 
 drivers/rtc/rtc-stk17ta8.c                                 |    1 
 drivers/rtc/rtc-stmp3xxx.c                                 |    1 
 drivers/rtc/rtc-tx4939.c                                   |    1 
 drivers/rtc/rtc-v3020.c                                    |    1 
 drivers/rtc/rtc-wm831x.c                                   |    1 
 drivers/s390/block/dasd_3990_erp.c                         |    1 
 drivers/s390/block/dasd_alias.c                            |    1 
 drivers/s390/block/dasd_devmap.c                           |    1 
 drivers/s390/block/dasd_eer.c                              |    1 
 drivers/s390/block/dasd_ioctl.c                            |    1 
 drivers/s390/block/dasd_proc.c                             |    1 
 drivers/s390/block/xpram.c                                 |    2 
 drivers/s390/char/con3270.c                                |    1 
 drivers/s390/char/fs3270.c                                 |    1 
 drivers/s390/char/keyboard.c                               |    1 
 drivers/s390/char/monreader.c                              |    1 
 drivers/s390/char/monwriter.c                              |    1 
 drivers/s390/char/sclp_async.c                             |    3 
 drivers/s390/char/sclp_con.c                               |    1 
 drivers/s390/char/sclp_tty.c                               |    2 
 drivers/s390/char/sclp_vt220.c                             |    1 
 drivers/s390/char/tape_34xx.c                              |    1 
 drivers/s390/char/tape_3590.c                              |    1 
 drivers/s390/char/tape_class.c                             |    2 
 drivers/s390/char/tape_core.c                              |    1 
 drivers/s390/char/vmcp.c                                   |    1 
 drivers/s390/char/vmlogrdr.c                               |    1 
 drivers/s390/char/vmur.c                                   |    1 
 drivers/s390/char/vmwatchdog.c                             |    1 
 drivers/s390/char/zcore.c                                  |    1 
 drivers/s390/cio/blacklist.c                               |    1 
 drivers/s390/cio/chp.c                                     |    1 
 drivers/s390/cio/chsc_sch.c                                |    1 
 drivers/s390/cio/qdio_main.c                               |    1 
 drivers/s390/cio/qdio_thinint.c                            |    1 
 drivers/s390/crypto/ap_bus.c                               |    1 
 drivers/s390/crypto/zcrypt_api.c                           |    1 
 drivers/s390/crypto/zcrypt_cex2a.c                         |    1 
 drivers/s390/crypto/zcrypt_pcica.c                         |    1 
 drivers/s390/crypto/zcrypt_pcicc.c                         |    1 
 drivers/s390/crypto/zcrypt_pcixcc.c                        |    1 
 drivers/s390/kvm/kvm_virtio.c                              |    1 
 drivers/s390/net/ctcm_dbug.c                               |    1 
 drivers/s390/net/ctcm_sysfs.c                              |    1 
 drivers/s390/net/fsm.c                                     |    1 
 drivers/s390/net/lcs.c                                     |    1 
 drivers/s390/net/qeth_core_main.c                          |    1 
 drivers/s390/net/qeth_l2_main.c                            |    1 
 drivers/s390/net/qeth_l3_main.c                            |    1 
 drivers/s390/net/qeth_l3_sys.c                             |    2 
 drivers/s390/net/smsgiucv.c                                |    1 
 drivers/s390/net/smsgiucv_app.c                            |    1 
 drivers/s390/scsi/zfcp_aux.c                               |    1 
 drivers/s390/scsi/zfcp_cfdc.c                              |    1 
 drivers/s390/scsi/zfcp_dbf.c                               |    1 
 drivers/s390/scsi/zfcp_fc.c                                |    1 
 drivers/s390/scsi/zfcp_fsf.c                               |    1 
 drivers/s390/scsi/zfcp_qdio.c                              |    1 
 drivers/s390/scsi/zfcp_scsi.c                              |    1 
 drivers/s390/scsi/zfcp_sysfs.c                             |    1 
 drivers/sbus/char/bbc_envctrl.c                            |    1 
 drivers/sbus/char/display7seg.c                            |    1 
 drivers/sbus/char/envctrl.c                                |    1 
 drivers/sbus/char/flash.c                                  |    1 
 drivers/sbus/char/jsflash.c                                |    1 
 drivers/scsi/3w-9xxx.c                                     |    1 
 drivers/scsi/3w-sas.c                                      |    1 
 drivers/scsi/3w-xxxx.c                                     |    1 
 drivers/scsi/53c700.c                                      |    1 
 drivers/scsi/BusLogic.c                                    |    1 
 drivers/scsi/NCR_D700.c                                    |    1 
 drivers/scsi/NCR_Q720.c                                    |    1 
 drivers/scsi/a100u2w.c                                     |    1 
 drivers/scsi/a2091.c                                       |    1 
 drivers/scsi/a3000.c                                       |    1 
 drivers/scsi/a4000t.c                                      |    1 
 drivers/scsi/aacraid/rx.c                                  |    1 
 drivers/scsi/aacraid/sa.c                                  |    1 
 drivers/scsi/advansys.c                                    |    8 
 drivers/scsi/aha152x.c                                     |    1 
 drivers/scsi/aha1542.c                                     |    1 
 drivers/scsi/aha1740.c                                     |    1 
 drivers/scsi/aic7xxx/aic79xx_osm.c                         |    1 
 drivers/scsi/aic7xxx/aic7xxx_osm.c                         |    1 
 drivers/scsi/aic94xx/aic94xx_hwi.c                         |    1 
 drivers/scsi/aic94xx/aic94xx_init.c                        |    1 
 drivers/scsi/aic94xx/aic94xx_scb.c                         |    1 
 drivers/scsi/aic94xx/aic94xx_sds.c                         |    1 
 drivers/scsi/aic94xx/aic94xx_seq.c                         |    1 
 drivers/scsi/aic94xx/aic94xx_tmf.c                         |    1 
 drivers/scsi/arcmsr/arcmsr_hba.c                           |    1 
 drivers/scsi/atari_NCR5380.c                               |    1 
 drivers/scsi/atp870u.c                                     |    1 
 drivers/scsi/be2iscsi/be_main.c                            |    1 
 drivers/scsi/bfa/bfad.c                                    |    1 
 drivers/scsi/bfa/bfad_attr.c                               |    1 
 drivers/scsi/bfa/bfad_im.c                                 |    1 
 drivers/scsi/bfa/rport.c                                   |    1 
 drivers/scsi/bnx2i/bnx2i_hwi.c                             |    1 
 drivers/scsi/bnx2i/bnx2i_iscsi.c                           |    1 
 drivers/scsi/bvme6000_scsi.c                               |    1 
 drivers/scsi/ch.c                                          |    1 
 drivers/scsi/cxgb3i/cxgb3i_ddp.c                           |    1 
 drivers/scsi/cxgb3i/cxgb3i_ddp.h                           |    1 
 drivers/scsi/cxgb3i/cxgb3i_iscsi.c                         |    1 
 drivers/scsi/cxgb3i/cxgb3i_offload.c                       |    1 
 drivers/scsi/cxgb3i/cxgb3i_pdu.c                           |    1 
 drivers/scsi/dc395x.c                                      |    1 
 drivers/scsi/device_handler/scsi_dh.c                      |    1 
 drivers/scsi/device_handler/scsi_dh_alua.c                 |    1 
 drivers/scsi/device_handler/scsi_dh_emc.c                  |    1 
 drivers/scsi/device_handler/scsi_dh_hp_sw.c                |    1 
 drivers/scsi/device_handler/scsi_dh_rdac.c                 |    1 
 drivers/scsi/eata.c                                        |    1 
 drivers/scsi/eata_pio.c                                    |    1 
 drivers/scsi/fcoe/fcoe.c                                   |    1 
 drivers/scsi/fcoe/libfcoe.c                                |    1 
 drivers/scsi/fd_mcs.c                                      |    1 
 drivers/scsi/fdomain.c                                     |    1 
 drivers/scsi/fnic/fnic_fcs.c                               |    1 
 drivers/scsi/fnic/fnic_main.c                              |    1 
 drivers/scsi/fnic/fnic_scsi.c                              |    1 
 drivers/scsi/fnic/vnic_dev.c                               |    1 
 drivers/scsi/fnic/vnic_rq.c                                |    1 
 drivers/scsi/fnic/vnic_wq.c                                |    1 
 drivers/scsi/gdth.c                                        |    1 
 drivers/scsi/gdth_proc.c                                   |    1 
 drivers/scsi/gvp11.c                                       |    1 
 drivers/scsi/hosts.c                                       |    1 
 drivers/scsi/hptiop.c                                      |    1 
 drivers/scsi/ibmvscsi/ibmvfc.c                             |    1 
 drivers/scsi/ibmvscsi/ibmvscsi.c                           |    1 
 drivers/scsi/ibmvscsi/ibmvstgt.c                           |    1 
 drivers/scsi/ibmvscsi/rpa_vscsi.c                          |    1 
 drivers/scsi/imm.c                                         |    1 
 drivers/scsi/ipr.c                                         |    1 
 drivers/scsi/iscsi_tcp.c                                   |    1 
 drivers/scsi/jazz_esp.c                                    |    1 
 drivers/scsi/lasi700.c                                     |    1 
 drivers/scsi/libfc/fc_disc.c                               |    1 
 drivers/scsi/libfc/fc_exch.c                               |    2 
 drivers/scsi/libfc/fc_fcp.c                                |    1 
 drivers/scsi/libfc/fc_frame.c                              |    1 
 drivers/scsi/libfc/fc_lport.c                              |    1 
 drivers/scsi/libfc/fc_rport.c                              |    1 
 drivers/scsi/libiscsi.c                                    |    6 
 drivers/scsi/libiscsi_tcp.c                                |    1 
 drivers/scsi/libsas/sas_ata.c                              |    1 
 drivers/scsi/libsas/sas_discover.c                         |    1 
 drivers/scsi/libsas/sas_expander.c                         |    1 
 drivers/scsi/libsas/sas_host_smp.c                         |    1 
 drivers/scsi/libsas/sas_init.c                             |    1 
 drivers/scsi/libsas/sas_scsi_host.c                        |    1 
 drivers/scsi/libsrp.c                                      |    1 
 drivers/scsi/lpfc/lpfc_attr.c                              |    1 
 drivers/scsi/lpfc/lpfc_bsg.c                               |    1 
 drivers/scsi/lpfc/lpfc_ct.c                                |    1 
 drivers/scsi/lpfc/lpfc_debugfs.c                           |    1 
 drivers/scsi/lpfc/lpfc_els.c                               |    1 
 drivers/scsi/lpfc/lpfc_hbadisc.c                           |    1 
 drivers/scsi/lpfc/lpfc_init.c                              |    1 
 drivers/scsi/lpfc/lpfc_mbox.c                              |    1 
 drivers/scsi/lpfc/lpfc_mem.c                               |    1 
 drivers/scsi/lpfc/lpfc_nportdisc.c                         |    1 
 drivers/scsi/lpfc/lpfc_scsi.c                              |    1 
 drivers/scsi/lpfc/lpfc_sli.c                               |    1 
 drivers/scsi/lpfc/lpfc_vport.c                             |    1 
 drivers/scsi/mac_esp.c                                     |    1 
 drivers/scsi/megaraid.c                                    |    1 
 drivers/scsi/megaraid/megaraid_mbox.c                      |    1 
 drivers/scsi/megaraid/megaraid_mm.c                        |    1 
 drivers/scsi/megaraid/megaraid_sas.c                       |    1 
 drivers/scsi/mesh.c                                        |    1 
 drivers/scsi/mpt2sas/mpt2sas_config.c                      |    1 
 drivers/scsi/mpt2sas/mpt2sas_scsih.c                       |    1 
 drivers/scsi/mpt2sas/mpt2sas_transport.c                   |    1 
 drivers/scsi/mvme16x_scsi.c                                |    1 
 drivers/scsi/mvsas/mv_sas.h                                |    1 
 drivers/scsi/ncr53c8xx.c                                   |    1 
 drivers/scsi/nsp32.c                                       |    1 
 drivers/scsi/osd/osd_initiator.c                           |    2 
 drivers/scsi/osd/osd_uld.c                                 |    1 
 drivers/scsi/osst.c                                        |    1 
 drivers/scsi/pm8001/pm8001_ctl.c                           |    1 
 drivers/scsi/pm8001/pm8001_hwi.c                           |    1 
 drivers/scsi/pm8001/pm8001_init.c                          |    1 
 drivers/scsi/pm8001/pm8001_sas.c                           |    1 
 drivers/scsi/pmcraid.c                                     |    1 
 drivers/scsi/ppa.c                                         |    1 
 drivers/scsi/ps3rom.c                                      |    1 
 drivers/scsi/qla1280.c                                     |  162 
 drivers/scsi/qla2xxx/qla_attr.c                            |    7 
 drivers/scsi/qla2xxx/qla_fw.h                              |   18 
 drivers/scsi/qla2xxx/qla_init.c                            |    1 
 drivers/scsi/qla2xxx/qla_isr.c                             |   38 
 drivers/scsi/qla2xxx/qla_mbx.c                             |    9 
 drivers/scsi/qla2xxx/qla_mid.c                             |    1 
 drivers/scsi/qla2xxx/qla_os.c                              |    5 
 drivers/scsi/qla2xxx/qla_sup.c                             |    1 
 drivers/scsi/qla2xxx/qla_version.h                         |    4 
 drivers/scsi/qla4xxx/ql4_os.c                              |    1 
 drivers/scsi/qlogicpti.c                                   |    2 
 drivers/scsi/scsi_debug.c                                  |    1 
 drivers/scsi/scsi_devinfo.c                                |    1 
 drivers/scsi/scsi_error.c                                  |    1 
 drivers/scsi/scsi_netlink.c                                |    1 
 drivers/scsi/scsi_proc.c                                   |    2 
 drivers/scsi/scsi_scan.c                                   |    1 
 drivers/scsi/scsi_sysfs.c                                  |    1 
 drivers/scsi/scsi_tgt_if.c                                 |    1 
 drivers/scsi/scsi_tgt_lib.c                                |    1 
 drivers/scsi/scsi_transport_fc.c                           |    5 
 drivers/scsi/scsi_transport_iscsi.c                        |    1 
 drivers/scsi/scsi_transport_spi.c                          |    1 
 drivers/scsi/scsicam.c                                     |    1 
 drivers/scsi/sd.c                                          |    3 
 drivers/scsi/ses.c                                         |    1 
 drivers/scsi/sg.c                                          |    1 
 drivers/scsi/sim710.c                                      |    1 
 drivers/scsi/sni_53c710.c                                  |    1 
 drivers/scsi/sr.c                                          |    1 
 drivers/scsi/sr_ioctl.c                                    |    1 
 drivers/scsi/sr_vendor.c                                   |    1 
 drivers/scsi/st.c                                          |    1 
 drivers/scsi/stex.c                                        |    1 
 drivers/scsi/sun3_NCR5380.c                                |    1 
 drivers/scsi/sun3x_esp.c                                   |    1 
 drivers/scsi/sun_esp.c                                     |    1 
 drivers/scsi/tmscsim.c                                     |    1 
 drivers/scsi/u14-34f.c                                     |    1 
 drivers/scsi/vmw_pvscsi.c                                  |    1 
 drivers/scsi/wd7000.c                                      |    1 
 drivers/scsi/zorro7xx.c                                    |    1 
 drivers/serial/68328serial.c                               |    1 
 drivers/serial/8250.c                                      |    1 
 drivers/serial/8250_gsc.c                                  |    1 
 drivers/serial/8250_hp300.c                                |    1 
 drivers/serial/amba-pl010.c                                |    1 
 drivers/serial/amba-pl011.c                                |    1 
 drivers/serial/bfin_5xx.c                                  |    1 
 drivers/serial/bfin_sport_uart.c                           |    1 
 drivers/serial/cpm_uart/cpm_uart_cpm1.c                    |    1 
 drivers/serial/cpm_uart/cpm_uart_cpm2.c                    |    1 
 drivers/serial/imx.c                                       |    1 
 drivers/serial/ioc3_serial.c                               |    1 
 drivers/serial/ioc4_serial.c                               |    1 
 drivers/serial/jsm/jsm_driver.c                            |    1 
 drivers/serial/jsm/jsm_tty.c                               |    1 
 drivers/serial/max3100.c                                   |    1 
 drivers/serial/mpsc.c                                      |    1 
 drivers/serial/mux.c                                       |    1 
 drivers/serial/of_serial.c                                 |    1 
 drivers/serial/pmac_zilog.c                                |    1 
 drivers/serial/pxa.c                                       |    1 
 drivers/serial/sh-sci.c                                    |    1 
 drivers/serial/sunsu.c                                     |    5 
 drivers/serial/timbuart.c                                  |    1 
 drivers/serial/ucc_uart.c                                  |    1 
 drivers/sh/intc.c                                          |    1 
 drivers/sn/ioc3.c                                          |    1 
 drivers/spi/amba-pl022.c                                   |    1 
 drivers/spi/atmel_spi.c                                    |    1 
 drivers/spi/au1550_spi.c                                   |    1 
 drivers/spi/davinci_spi.c                                  |    1 
 drivers/spi/dw_spi.c                                       |    1 
 drivers/spi/dw_spi_mmio.c                                  |    1 
 drivers/spi/dw_spi_pci.c                                   |    1 
 drivers/spi/mpc52xx_psc_spi.c                              |    1 
 drivers/spi/mpc52xx_spi.c                                  |    1 
 drivers/spi/omap2_mcspi.c                                  |    1 
 drivers/spi/omap_spi_100k.c                                |    1 
 drivers/spi/omap_uwire.c                                   |    1 
 drivers/spi/pxa2xx_spi.c                                   |    1 
 drivers/spi/spi.c                                          |    1 
 drivers/spi/spi_bfin5xx.c                                  |    1 
 drivers/spi/spi_bitbang.c                                  |    1 
 drivers/spi/spi_imx.c                                      |    1 
 drivers/spi/spi_mpc8xxx.c                                  |    1 
 drivers/spi/spi_nuc900.c                                   |    1 
 drivers/spi/spi_ppc4xx.c                                   |    1 
 drivers/spi/spi_s3c24xx.c                                  |    1 
 drivers/spi/tle62x0.c                                      |    1 
 drivers/spi/xilinx_spi_of.c                                |    1 
 drivers/ssb/driver_gige.c                                  |    1 
 drivers/ssb/driver_pcicore.c                               |   29 
 drivers/ssb/main.c                                         |    1 
 drivers/ssb/pci.c                                          |    1 
 drivers/ssb/pcihost_wrapper.c                              |    1 
 drivers/ssb/sprom.c                                        |    1 
 drivers/staging/batman-adv/device.c                        |    1 
 drivers/staging/batman-adv/main.h                          |    1 
 drivers/staging/batman-adv/soft-interface.c                |    1 
 drivers/staging/comedi/drivers/8255.c                      |    1 
 drivers/staging/comedi/drivers/addi-data/addi_common.c     |    2 
 drivers/staging/comedi/drivers/adl_pci9118.c               |    1 
 drivers/staging/comedi/drivers/amplc_dio200.c              |    1 
 drivers/staging/comedi/drivers/amplc_pci224.c              |    1 
 drivers/staging/comedi/drivers/cb_das16_cs.c               |    1 
 drivers/staging/comedi/drivers/comedi_bond.c               |    1 
 drivers/staging/comedi/drivers/das08_cs.c                  |    1 
 drivers/staging/comedi/drivers/das16.c                     |    1 
 drivers/staging/comedi/drivers/das1800.c                   |    1 
 drivers/staging/comedi/drivers/dt282x.c                    |    1 
 drivers/staging/comedi/drivers/jr3_pci.c                   |    1 
 drivers/staging/comedi/drivers/ni_65xx.c                   |    1 
 drivers/staging/comedi/drivers/ni_670x.c                   |    1 
 drivers/staging/comedi/drivers/ni_at_a2150.c               |    1 
 drivers/staging/comedi/drivers/ni_daq_700.c                |    1 
 drivers/staging/comedi/drivers/ni_daq_dio24.c              |    1 
 drivers/staging/comedi/drivers/ni_labpc.c                  |    1 
 drivers/staging/comedi/drivers/ni_labpc_cs.c               |    1 
 drivers/staging/comedi/drivers/pcl812.c                    |    1 
 drivers/staging/comedi/drivers/pcl816.c                    |    1 
 drivers/staging/comedi/drivers/pcl818.c                    |    1 
 drivers/staging/comedi/drivers/pcmmio.c                    |    1 
 drivers/staging/comedi/drivers/pcmuio.c                    |    1 
 drivers/staging/comedi/drivers/serial2002.c                |    1 
 drivers/staging/comedi/drivers/unioxx5.c                   |    1 
 drivers/staging/comedi/kcomedilib/kcomedilib_main.c        |    1 
 drivers/staging/comedi/kcomedilib/ksyms.c                  |    1 
 drivers/staging/crystalhd/crystalhd_hw.c                   |    1 
 drivers/staging/crystalhd/crystalhd_lnx.c                  |    1 
 drivers/staging/crystalhd/crystalhd_misc.c                 |    2 
 drivers/staging/cx25821/cx25821-alsa.c                     |    1 
 drivers/staging/cx25821/cx25821-audio-upstream.c           |    1 
 drivers/staging/cx25821/cx25821-audups11.c                 |    2 
 drivers/staging/cx25821/cx25821-core.c                     |    1 
 drivers/staging/cx25821/cx25821-video-upstream-ch2.c       |    1 
 drivers/staging/cx25821/cx25821-video-upstream.c           |    1 
 drivers/staging/dream/camera/msm_camera.c                  |    1 
 drivers/staging/dream/camera/msm_v4l2.c                    |    1 
 drivers/staging/dream/camera/msm_vfe7x.c                   |    1 
 drivers/staging/dream/camera/msm_vfe8x.c                   |    1 
 drivers/staging/dream/camera/mt9d112.c                     |    1 
 drivers/staging/dream/camera/mt9p012_fox.c                 |    1 
 drivers/staging/dream/camera/mt9t013.c                     |    1 
 drivers/staging/dream/camera/s5k3e2fx.c                    |    1 
 drivers/staging/dream/gpio_axis.c                          |    1 
 drivers/staging/dream/gpio_event.c                         |    1 
 drivers/staging/dream/gpio_input.c                         |    1 
 drivers/staging/dream/gpio_matrix.c                        |    1 
 drivers/staging/dream/pmem.c                               |    1 
 drivers/staging/dream/qdsp5/adsp.c                         |    1 
 drivers/staging/dream/qdsp5/adsp_driver.c                  |    1 
 drivers/staging/dream/qdsp5/audio_aac.c                    |    1 
 drivers/staging/dream/qdsp5/audio_amrnb.c                  |    1 
 drivers/staging/dream/qdsp5/audio_evrc.c                   |    1 
 drivers/staging/dream/qdsp5/audio_in.c                     |    1 
 drivers/staging/dream/qdsp5/audio_mp3.c                    |    1 
 drivers/staging/dream/qdsp5/audio_out.c                    |    1 
 drivers/staging/dream/qdsp5/audio_qcelp.c                  |    1 
 drivers/staging/dream/qdsp5/audmgr.c                       |    1 
 drivers/staging/dream/smd/smd_rpcrouter.c                  |    1 
 drivers/staging/dream/smd/smd_rpcrouter_device.c           |    1 
 drivers/staging/dream/smd/smd_rpcrouter_servers.c          |    1 
 drivers/staging/dream/synaptics_i2c_rmi.c                  |    1 
 drivers/staging/dt3155/allocator.c                         |    1 
 drivers/staging/dt3155/dt3155_isr.c                        |    2 
 drivers/staging/et131x/et1310_eeprom.c                     |    1 
 drivers/staging/et131x/et1310_mac.c                        |    1 
 drivers/staging/et131x/et1310_phy.c                        |    1 
 drivers/staging/et131x/et1310_pm.c                         |    1 
 drivers/staging/et131x/et131x_initpci.c                    |    1 
 drivers/staging/et131x/et131x_isr.c                        |    1 
 drivers/staging/et131x/et131x_netdev.c                     |    1 
 drivers/staging/go7007/go7007-driver.c                     |    1 
 drivers/staging/go7007/go7007-fw.c                         |    1 
 drivers/staging/go7007/go7007-v4l2.c                       |    1 
 drivers/staging/go7007/s2250-board.c                       |    1 
 drivers/staging/go7007/s2250-loader.c                      |    1 
 drivers/staging/go7007/snd-go7007.c                        |    1 
 drivers/staging/go7007/wis-saa7113.c                       |    1 
 drivers/staging/go7007/wis-saa7115.c                       |    1 
 drivers/staging/go7007/wis-sony-tuner.c                    |    1 
 drivers/staging/go7007/wis-tw2804.c                        |    1 
 drivers/staging/go7007/wis-tw9903.c                        |    1 
 drivers/staging/hv/Channel.c                               |    1 
 drivers/staging/hv/ChannelMgmt.c                           |    1 
 drivers/staging/hv/Connection.c                            |    1 
 drivers/staging/hv/Hv.c                                    |    1 
 drivers/staging/hv/NetVsc.c                                |    1 
 drivers/staging/hv/RndisFilter.c                           |    1 
 drivers/staging/hv/StorVsc.c                               |    1 
 drivers/staging/hv/Vmbus.c                                 |    1 
 drivers/staging/hv/blkvsc_drv.c                            |    1 
 drivers/staging/hv/netvsc_drv.c                            |    1 
 drivers/staging/hv/osd.c                                   |    1 
 drivers/staging/hv/storvsc_drv.c                           |    1 
 drivers/staging/hv/vmbus_drv.c                             |    1 
 drivers/staging/iio/accel/kxsd9.c                          |    1 
 drivers/staging/iio/accel/lis3l02dq_core.c                 |    1 
 drivers/staging/iio/accel/lis3l02dq_ring.c                 |    1 
 drivers/staging/iio/accel/sca3000_core.c                   |    1 
 drivers/staging/iio/accel/sca3000_ring.c                   |    1 
 drivers/staging/iio/adc/max1363_core.c                     |    1 
 drivers/staging/iio/adc/max1363_ring.c                     |    1 
 drivers/staging/iio/industrialio-core.c                    |    1 
 drivers/staging/iio/industrialio-ring.c                    |    1 
 drivers/staging/iio/industrialio-trigger.c                 |    1 
 drivers/staging/iio/light/tsl2563.c                        |    1 
 drivers/staging/iio/ring_sw.c                              |    1 
 drivers/staging/iio/trigger/iio-trig-gpio.c                |    1 
 drivers/staging/iio/trigger/iio-trig-periodic-rtc.c        |    1 
 drivers/staging/line6/capture.c                            |    2 
 drivers/staging/line6/driver.c                             |    1 
 drivers/staging/line6/dumprequest.c                        |    3 
 drivers/staging/line6/midi.c                               |    1 
 drivers/staging/line6/pcm.c                                |    2 
 drivers/staging/line6/playback.c                           |    2 
 drivers/staging/line6/pod.c                                |    2 
 drivers/staging/line6/variax.c                             |    2 
 drivers/staging/netwave/netwave_cs.c                       |    1 
 drivers/staging/octeon/ethernet-mem.c                      |    1 
 drivers/staging/octeon/ethernet.c                          |    1 
 drivers/staging/otus/ioctl.c                               |    1 
 drivers/staging/otus/usbdrv.c                              |    1 
 drivers/staging/otus/usbdrv.h                              |    1 
 drivers/staging/otus/wrap_mem.c                            |    1 
 drivers/staging/otus/wrap_pkt.c                            |    1 
 drivers/staging/otus/wrap_usb.c                            |    1 
 drivers/staging/otus/wwrap.c                               |    1 
 drivers/staging/otus/zdusb.c                               |    1 
 drivers/staging/poch/poch.c                                |    1 
 drivers/staging/pohmelfs/config.c                          |    1 
 drivers/staging/pohmelfs/dir.c                             |    1 
 drivers/staging/pohmelfs/lock.c                            |    1 
 drivers/staging/pohmelfs/net.c                             |    1 
 drivers/staging/pohmelfs/path_entry.c                      |    1 
 drivers/staging/ramzswap/ramzswap_drv.c                    |    1 
 drivers/staging/rt2860/pci_main_dev.c                      |    1 
 drivers/staging/rt2860/rt_linux.c                          |    1 
 drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c    |    1 
 drivers/staging/rtl8187se/ieee80211/ieee80211_wx.c         |    1 
 drivers/staging/rtl8187se/r8180_core.c                     |    1 
 drivers/staging/rtl8192e/ieee80211/ieee80211_softmac.c     |    1 
 drivers/staging/rtl8192e/ieee80211/ieee80211_wx.c          |    1 
 drivers/staging/rtl8192e/ieee80211/rtl819x_TSProc.c        |    1 
 drivers/staging/rtl8192e/r8192E_core.c                     |    1 
 drivers/staging/rtl8192su/ieee80211/ieee80211_softmac.c    |    1 
 drivers/staging/rtl8192su/ieee80211/ieee80211_wx.c         |    1 
 drivers/staging/rtl8192su/ieee80211/rtl819x_TSProc.c       |    1 
 drivers/staging/rtl8192su/r8192U_core.c                    |    1 
 drivers/staging/rtl8192u/ieee80211/ieee80211_softmac.c     |    1 
 drivers/staging/rtl8192u/ieee80211/ieee80211_wx.c          |    1 
 drivers/staging/rtl8192u/ieee80211/rtl819x_TSProc.c        |    1 
 drivers/staging/rtl8192u/r8192U_core.c                     |    1 
 drivers/staging/sep/sep_driver.c                           |    1 
 drivers/staging/sm7xx/smtcfb.c                             |    1 
 drivers/staging/strip/strip.c                              |    1 
 drivers/staging/udlfb/udlfb.c                              |    1 
 drivers/staging/usbip/stub_dev.c                           |    2 
 drivers/staging/usbip/stub_main.c                          |    1 
 drivers/staging/usbip/stub_rx.c                            |    2 
 drivers/staging/usbip/stub_tx.c                            |    2 
 drivers/staging/usbip/usbip_common.c                       |    1 
 drivers/staging/usbip/vhci_hcd.c                           |    1 
 drivers/staging/usbip/vhci_rx.c                            |    2 
 drivers/staging/usbip/vhci_tx.c                            |    2 
 drivers/staging/vme/bridges/vme_ca91cx42.c                 |    1 
 drivers/staging/vme/bridges/vme_tsi148.c                   |    1 
 drivers/staging/vme/devices/vme_user.c                     |    1 
 drivers/staging/vme/vme.c                                  |    1 
 drivers/staging/vt6655/device_main.c                       |    1 
 drivers/staging/winbond/wb35reg.c                          |    1 
 drivers/staging/winbond/wb35rx.c                           |    1 
 drivers/staging/winbond/wb35tx.c                           |    1 
 drivers/staging/wlags49_h2/wl_cs.c                         |    1 
 drivers/staging/wlags49_h2/wl_netdev.c                     |    1 
 drivers/staging/wlags49_h2/wl_pci.c                        |    1 
 drivers/staging/wlags49_h2/wl_priv.c                       |    1 
 drivers/staging/wlan-ng/p80211req.c                        |    1 
 drivers/staging/wlan-ng/p80211wep.c                        |    1 
 drivers/staging/wlan-ng/p80211wext.c                       |    1 
 drivers/staging/wlan-ng/prism2fw.c                         |    1 
 drivers/staging/wlan-ng/prism2mgmt.c                       |    1 
 drivers/staging/wlan-ng/prism2mib.c                        |    1 
 drivers/tc/tc.c                                            |    1 
 drivers/thermal/thermal_sys.c                              |    4 
 drivers/uio/uio.c                                          |    1 
 drivers/uio/uio_aec.c                                      |    1 
 drivers/uio/uio_cif.c                                      |    1 
 drivers/uio/uio_netx.c                                     |    1 
 drivers/uio/uio_pci_generic.c                              |    1 
 drivers/uio/uio_pdrv.c                                     |    1 
 drivers/uio/uio_pdrv_genirq.c                              |    1 
 drivers/uio/uio_sercos3.c                                  |    1 
 drivers/usb/atm/speedtch.c                                 |    1 
 drivers/usb/atm/ueagle-atm.c                               |    1 
 drivers/usb/c67x00/c67x00-drv.c                            |    1 
 drivers/usb/c67x00/c67x00-sched.c                          |    1 
 drivers/usb/class/usbtmc.c                                 |    1 
 drivers/usb/core/devices.c                                 |    2 
 drivers/usb/core/driver.c                                  |    1 
 drivers/usb/core/endpoint.c                                |    1 
 drivers/usb/core/file.c                                    |    1 
 drivers/usb/gadget/at91_udc.c                              |    9 
 drivers/usb/gadget/atmel_usba_udc.c                        |    1 
 drivers/usb/gadget/ci13xxx_udc.c                           |    1 
 drivers/usb/gadget/config.c                                |    1 
 drivers/usb/gadget/f_acm.c                                 |    1 
 drivers/usb/gadget/f_audio.c                               |    1 
 drivers/usb/gadget/f_ecm.c                                 |    1 
 drivers/usb/gadget/f_eem.c                                 |    1 
 drivers/usb/gadget/f_loopback.c                            |    1 
 drivers/usb/gadget/f_obex.c                                |    1 
 drivers/usb/gadget/f_phonet.c                              |    1 
 drivers/usb/gadget/f_rndis.c                               |    1 
 drivers/usb/gadget/f_serial.c                              |    1 
 drivers/usb/gadget/f_sourcesink.c                          |    1 
 drivers/usb/gadget/f_subset.c                              |    1 
 drivers/usb/gadget/gmidi.c                                 |    1 
 drivers/usb/gadget/imx_udc.c                               |    1 
 drivers/usb/gadget/lh7a40x_udc.c                           |    1 
 drivers/usb/gadget/m66592-udc.c                            |    1 
 drivers/usb/gadget/pxa27x_udc.c                            |    1 
 drivers/usb/gadget/r8a66597-udc.c                          |    2 
 drivers/usb/gadget/rndis.c                                 |    1 
 drivers/usb/gadget/s3c-hsotg.c                             |    1 
 drivers/usb/gadget/u_audio.c                               |    1 
 drivers/usb/gadget/u_ether.c                               |    1 
 drivers/usb/gadget/u_serial.c                              |    1 
 drivers/usb/gadget/zero.c                                  |    1 
 drivers/usb/host/ehci-hcd.c                                |    2 
 drivers/usb/host/ehci-mxc.c                                |    1 
 drivers/usb/host/ehci-omap.c                               |    1 
 drivers/usb/host/fhci-hcd.c                                |    1 
 drivers/usb/host/fhci-mem.c                                |    1 
 drivers/usb/host/fhci-q.c                                  |    1 
 drivers/usb/host/fhci-tds.c                                |    1 
 drivers/usb/host/hwa-hc.c                                  |    1 
 drivers/usb/host/imx21-hcd.c                               |    1 
 drivers/usb/host/isp116x-hcd.c                             |    1 
 drivers/usb/host/ohci-q.c                                  |    1 
 drivers/usb/host/r8a66597-hcd.c                            |    1 
 drivers/usb/host/uhci-debug.c                              |    1 
 drivers/usb/host/whci/asl.c                                |    1 
 drivers/usb/host/whci/debug.c                              |    1 
 drivers/usb/host/whci/init.c                               |    1 
 drivers/usb/host/whci/pzl.c                                |    1 
 drivers/usb/host/whci/qset.c                               |    1 
 drivers/usb/host/xhci-mem.c                                |    1 
 drivers/usb/host/xhci-ring.c                               |    1 
 drivers/usb/host/xhci.c                                    |    1 
 drivers/usb/misc/appledisplay.c                            |    1 
 drivers/usb/misc/cypress_cy7c63.c                          |    1 
 drivers/usb/misc/cytherm.c                                 |    1 
 drivers/usb/misc/isight_firmware.c                         |    1 
 drivers/usb/misc/sisusbvga/sisusb_con.c                    |    1 
 drivers/usb/misc/sisusbvga/sisusb_init.c                   |    1 
 drivers/usb/misc/trancevibrator.c                          |    1 
 drivers/usb/misc/uss720.c                                  |    1 
 drivers/usb/mon/mon_bin.c                                  |    1 
 drivers/usb/mon/mon_main.c                                 |    1 
 drivers/usb/mon/mon_stat.c                                 |    1 
 drivers/usb/mon/mon_text.c                                 |    1 
 drivers/usb/musb/blackfin.c                                |    1 
 drivers/usb/musb/cppi_dma.c                                |    1 
 drivers/usb/musb/davinci.c                                 |    1 
 drivers/usb/musb/musb_gadget.c                             |    1 
 drivers/usb/musb/musb_virthub.c                            |    1 
 drivers/usb/musb/musbhsdma.c                               |    1 
 drivers/usb/musb/omap2430.c                                |    1 
 drivers/usb/musb/tusb6010_omap.c                           |    1 
 drivers/usb/otg/gpio_vbus.c                                |    1 
 drivers/usb/otg/nop-usb-xceiv.c                            |    1 
 drivers/usb/otg/twl4030-usb.c                              |    1 
 drivers/usb/otg/ulpi.c                                     |    1 
 drivers/usb/serial/aircable.c                              |    1 
 drivers/usb/serial/ark3116.c                               |    1 
 drivers/usb/serial/bus.c                                   |    1 
 drivers/usb/serial/ch341.c                                 |    1 
 drivers/usb/serial/navman.c                                |    1 
 drivers/usb/serial/opticon.c                               |    1 
 drivers/usb/serial/option.c                                |    1 
 drivers/usb/serial/safe_serial.c                           |    2 
 drivers/usb/serial/sierra.c                                |    1 
 drivers/usb/serial/symbolserial.c                          |    1 
 drivers/usb/serial/usb_debug.c                             |    1 
 drivers/usb/storage/alauda.c                               |    1 
 drivers/usb/storage/karma.c                                |    1 
 drivers/usb/storage/option_ms.c                            |    1 
 drivers/usb/storage/scsiglue.c                             |    1 
 drivers/usb/storage/sierra_ms.c                            |    1 
 drivers/usb/storage/transport.c                            |    2 
 drivers/usb/wusbcore/cbaf.c                                |    1 
 drivers/usb/wusbcore/crypto.c                              |    1 
 drivers/usb/wusbcore/devconnect.c                          |    1 
 drivers/usb/wusbcore/mmc.c                                 |    1 
 drivers/usb/wusbcore/rh.c                                  |    1 
 drivers/usb/wusbcore/security.c                            |    1 
 drivers/usb/wusbcore/wa-hc.c                               |    1 
 drivers/usb/wusbcore/wa-nep.c                              |    1 
 drivers/usb/wusbcore/wa-rpipe.c                            |    1 
 drivers/usb/wusbcore/wa-xfer.c                             |    1 
 drivers/uwb/address.c                                      |    1 
 drivers/uwb/allocator.c                                    |    1 
 drivers/uwb/beacon.c                                       |    1 
 drivers/uwb/drp-ie.c                                       |    1 
 drivers/uwb/drp.c                                          |    1 
 drivers/uwb/est.c                                          |    1 
 drivers/uwb/hwa-rc.c                                       |    1 
 drivers/uwb/i1480/dfu/mac.c                                |    1 
 drivers/uwb/i1480/dfu/usb.c                                |    1 
 drivers/uwb/i1480/i1480u-wlp/lc.c                          |    1 
 drivers/uwb/i1480/i1480u-wlp/netdev.c                      |    1 
 drivers/uwb/i1480/i1480u-wlp/rx.c                          |    1 
 drivers/uwb/i1480/i1480u-wlp/tx.c                          |    1 
 drivers/uwb/ie.c                                           |    1 
 drivers/uwb/lc-dev.c                                       |    1 
 drivers/uwb/lc-rc.c                                        |    1 
 drivers/uwb/neh.c                                          |    1 
 drivers/uwb/reset.c                                        |    1 
 drivers/uwb/rsv.c                                          |    1 
 drivers/uwb/scan.c                                         |    1 
 drivers/uwb/umc-dev.c                                      |    1 
 drivers/uwb/uwbd.c                                         |    1 
 drivers/uwb/whc-rc.c                                       |    1 
 drivers/uwb/whci.c                                         |    1 
 drivers/uwb/wlp/eda.c                                      |    1 
 drivers/uwb/wlp/messages.c                                 |    1 
 drivers/uwb/wlp/txrx.c                                     |    1 
 drivers/uwb/wlp/wlp-lc.c                                   |    1 
 drivers/uwb/wlp/wss-lc.c                                   |    1 
 drivers/vhost/net.c                                        |    1 
 drivers/vhost/vhost.c                                      |    1 
 drivers/video/68328fb.c                                    |    1 
 drivers/video/acornfb.c                                    |    2 
 drivers/video/amifb.c                                      |    1 
 drivers/video/arcfb.c                                      |    1 
 drivers/video/asiliantfb.c                                 |    1 
 drivers/video/atafb.c                                      |    1 
 drivers/video/atmel_lcdfb.c                                |    1 
 drivers/video/aty/aty128fb.c                               |    1 
 drivers/video/aty/mach64_cursor.c                          |    1 
 drivers/video/aty/radeon_backlight.c                       |    1 
 drivers/video/aty/radeon_monitor.c                         |    3 
 drivers/video/au1100fb.c                                   |    1 
 drivers/video/au1200fb.c                                   |    1 
 drivers/video/backlight/88pm860x_bl.c                      |    1 
 drivers/video/backlight/adp5520_bl.c                       |    1 
 drivers/video/backlight/adx_bl.c                           |    1 
 drivers/video/backlight/atmel-pwm-bl.c                     |    1 
 drivers/video/backlight/backlight.c                        |    1 
 drivers/video/backlight/corgi_lcd.c                        |    1 
 drivers/video/backlight/cr_bllcd.c                         |    1 
 drivers/video/backlight/da903x_bl.c                        |    1 
 drivers/video/backlight/ili9320.c                          |    1 
 drivers/video/backlight/l4f00242t03.c                      |    1 
 drivers/video/backlight/lcd.c                              |    1 
 drivers/video/backlight/lms283gf05.c                       |    1 
 drivers/video/backlight/ltv350qv.c                         |    1 
 drivers/video/backlight/max8925_bl.c                       |    1 
 drivers/video/backlight/omap1_bl.c                         |    1 
 drivers/video/backlight/platform_lcd.c                     |    1 
 drivers/video/backlight/pwm_bl.c                           |    1 
 drivers/video/backlight/tdo24m.c                           |    1 
 drivers/video/backlight/tosa_bl.c                          |    1 
 drivers/video/backlight/tosa_lcd.c                         |    1 
 drivers/video/backlight/wm831x_bl.c                        |    1 
 drivers/video/bfin-lq035q1-fb.c                            |    1 
 drivers/video/bfin-t350mcqb-fb.c                           |    1 
 drivers/video/bw2.c                                        |    1 
 drivers/video/carminefb.c                                  |    1 
 drivers/video/cfbcopyarea.c                                |    1 
 drivers/video/cg14.c                                       |    1 
 drivers/video/cg3.c                                        |    1 
 drivers/video/cg6.c                                        |    1 
 drivers/video/chipsfb.c                                    |    1 
 drivers/video/cirrusfb.c                                   |    1 
 drivers/video/console/bitblit.c                            |    1 
 drivers/video/console/fbcon_ccw.c                          |    1 
 drivers/video/console/fbcon_cw.c                           |    1 
 drivers/video/console/fbcon_rotate.c                       |    1 
 drivers/video/console/fbcon_ud.c                           |    1 
 drivers/video/console/mdacon.c                             |    1 
 drivers/video/da8xx-fb.c                                   |    1 
 drivers/video/display/display-sysfs.c                      |    1 
 drivers/video/dnfb.c                                       |    1 
 drivers/video/ep93xx-fb.c                                  |    1 
 drivers/video/epson1355fb.c                                |    1 
 drivers/video/fb_ddc.c                                     |    1 
 drivers/video/fb_defio.c                                   |    1 
 drivers/video/fbcvt.c                                      |    1 
 drivers/video/fbmon.c                                      |    1 
 drivers/video/fbsysfs.c                                    |    1 
 drivers/video/ffb.c                                        |    1 
 drivers/video/fsl-diu-fb.c                                 |    1 
 drivers/video/g364fb.c                                     |    1 
 drivers/video/gbefb.c                                      |    1 
 drivers/video/geode/gx1fb_core.c                           |    1 
 drivers/video/geode/gxfb_core.c                            |    1 
 drivers/video/geode/lxfb_core.c                            |    1 
 drivers/video/hecubafb.c                                   |    1 
 drivers/video/hgafb.c                                      |    1 
 drivers/video/hitfb.c                                      |    1 
 drivers/video/hpfb.c                                       |    1 
 drivers/video/i810/i810-i2c.c                              |    1 
 drivers/video/imsttfb.c                                    |    1 
 drivers/video/intelfb/intelfbhw.c                          |    1 
 drivers/video/leo.c                                        |    1 
 drivers/video/matrox/i2c-matroxfb.c                        |    1 
 drivers/video/matrox/matroxfb_base.c                       |    1 
 drivers/video/matrox/matroxfb_crtc2.c                      |    1 
 drivers/video/matrox/matroxfb_maven.c                      |    1 
 drivers/video/maxinefb.c                                   |    1 
 drivers/video/mb862xx/mb862xxfb_accel.c                    |    6 
 drivers/video/mbx/mbxdebugfs.c                             |    1 
 drivers/video/metronomefb.c                                |    1 
 drivers/video/modedb.c                                     |    1 
 drivers/video/msm/mddi.c                                   |    1 
 drivers/video/msm/mddi_client_dummy.c                      |    1 
 drivers/video/msm/mddi_client_nt35399.c                    |    1 
 drivers/video/msm/mddi_client_toshiba.c                    |    1 
 drivers/video/msm/mdp.c                                    |    1 
 drivers/video/msm/msm_fb.c                                 |    1 
 drivers/video/nvidia/nv_i2c.c                              |    1 
 drivers/video/nvidia/nv_of.c                               |    1 
 drivers/video/nvidia/nv_setup.c                            |    1 
 drivers/video/offb.c                                       |    1 
 drivers/video/omap/dispc.c                                 |    1 
 drivers/video/omap/lcd_mipid.c                             |    1 
 drivers/video/omap/lcdc.c                                  |    1 
 drivers/video/omap/omapfb_main.c                           |    1 
 drivers/video/omap2/displays/panel-taal.c                  |    1 
 drivers/video/omap2/displays/panel-tpo-td043mtea1.c        |    1 
 drivers/video/omap2/dss/manager.c                          |    1 
 drivers/video/omap2/dss/overlay.c                          |    1 
 drivers/video/omap2/omapfb/omapfb-main.c                   |    1 
 drivers/video/omap2/vram.c                                 |    1 
 drivers/video/output.c                                     |    1 
 drivers/video/p9100.c                                      |    1 
 drivers/video/platinumfb.c                                 |    1 
 drivers/video/pmag-aa-fb.c                                 |    1 
 drivers/video/pnx4008/pnxrgbfb.c                           |    1 
 drivers/video/pnx4008/sdum.c                               |    2 
 drivers/video/q40fb.c                                      |    1 
 drivers/video/s1d13xxxfb.c                                 |    1 
 drivers/video/s3c-fb.c                                     |    2 
 drivers/video/s3fb.c                                       |    1 
 drivers/video/savage/savagefb-i2c.c                        |    1 
 drivers/video/sh7760fb.c                                   |    1 
 drivers/video/sh_mobile_lcdcfb.c                           |    1 
 drivers/video/sstfb.c                                      |    1 
 drivers/video/sunxvr1000.c                                 |    1 
 drivers/video/sunxvr2500.c                                 |    1 
 drivers/video/sunxvr500.c                                  |   25 
 drivers/video/svgalib.c                                    |    1 
 drivers/video/syscopyarea.c                                |    1 
 drivers/video/tcx.c                                        |    1 
 drivers/video/tgafb.c                                      |    1 
 drivers/video/tridentfb.c                                  |    1 
 drivers/video/uvesafb.c                                    |    1 
 drivers/video/vermilion/vermilion.c                        |    1 
 drivers/video/vesafb.c                                     |   27 
 drivers/video/vfb.c                                        |    1 
 drivers/video/vga16fb.c                                    |    1 
 drivers/video/via/viafbdev.c                               |    1 
 drivers/video/vt8623fb.c                                   |    1 
 drivers/video/w100fb.c                                     |    1 
 drivers/video/xen-fbfront.c                                |    1 
 drivers/video/xilinxfb.c                                   |    1 
 drivers/virtio/virtio_balloon.c                            |    1 
 drivers/virtio/virtio_pci.c                                |    1 
 drivers/virtio/virtio_ring.c                               |    1 
 drivers/vlynq/vlynq.c                                      |    1 
 drivers/w1/masters/ds1wm.c                                 |    1 
 drivers/w1/masters/ds2490.c                                |    1 
 drivers/w1/masters/mxc_w1.c                                |    1 
 drivers/w1/masters/omap_hdq.c                              |    1 
 drivers/w1/masters/w1-gpio.c                               |    1 
 drivers/w1/slaves/w1_ds2433.c                              |    1 
 drivers/w1/slaves/w1_ds2760.c                              |    1 
 drivers/w1/w1_int.c                                        |    1 
 drivers/w1/w1_netlink.c                                    |    1 
 drivers/watchdog/Kconfig                                   |   11 
 drivers/watchdog/adx_wdt.c                                 |    1 
 drivers/watchdog/at32ap700x_wdt.c                          |    1 
 drivers/watchdog/cpwd.c                                    |    1 
 drivers/watchdog/davinci_wdt.c                             |    1 
 drivers/watchdog/hpwdt.c                                   |    3 
 drivers/watchdog/iTCO_wdt.c                                |   99 
 drivers/watchdog/ibmasr.c                                  |    1 
 drivers/watchdog/max63xx_wdt.c                             |    1 
 drivers/watchdog/mpcore_wdt.c                              |    1 
 drivers/watchdog/nuc900_wdt.c                              |    1 
 drivers/watchdog/omap_wdt.c                                |    1 
 drivers/watchdog/pika_wdt.c                                |    2 
 drivers/watchdog/pnx4008_wdt.c                             |    1 
 drivers/watchdog/riowd.c                                   |    1 
 drivers/watchdog/s3c2410_wdt.c                             |    1 
 drivers/watchdog/ts72xx_wdt.c                              |    1 
 drivers/watchdog/twl4030_wdt.c                             |    1 
 drivers/xen/balloon.c                                      |    1 
 drivers/xen/events.c                                       |    1 
 drivers/xen/evtchn.c                                       |    1 
 drivers/xen/grant-table.c                                  |    1 
 drivers/xen/manage.c                                       |    1 
 drivers/xen/sys-hypervisor.c                               |    1 
 drivers/xen/xenbus/xenbus_client.c                         |    1 
 drivers/xen/xenbus/xenbus_probe.c                          |    1 
 drivers/xen/xencomm.c                                      |    2 
 drivers/xen/xenfs/xenbus.c                                 |    1 
 fs/9p/cache.c                                              |    1 
 fs/9p/fid.c                                                |   13 
 fs/9p/v9fs.c                                               |   22 
 fs/9p/v9fs.h                                               |    1 
 fs/9p/vfs_dentry.c                                         |    1 
 fs/9p/vfs_dir.c                                            |    3 
 fs/9p/vfs_inode.c                                          |   10 
 fs/9p/vfs_super.c                                          |    4 
 fs/adfs/super.c                                            |    1 
 fs/affs/bitmap.c                                           |    1 
 fs/affs/inode.c                                            |    1 
 fs/affs/super.c                                            |    1 
 fs/afs/cache.c                                             |    1 
 fs/afs/cmservice.c                                         |    1 
 fs/afs/dir.c                                               |    1 
 fs/afs/file.c                                              |    2 
 fs/afs/fsclient.c                                          |    1 
 fs/afs/inode.c                                             |    1 
 fs/afs/mntpt.c                                             |    2 
 fs/afs/rxrpc.c                                             |    1 
 fs/afs/vlclient.c                                          |    1 
 fs/afs/vlocation.c                                         |    1 
 fs/afs/vnode.c                                             |    1 
 fs/anon_inodes.c                                           |    1 
 fs/autofs/root.c                                           |    1 
 fs/autofs4/dev-ioctl.c                                     |    1 
 fs/autofs4/root.c                                          |    1 
 fs/befs/datastream.c                                       |    1 
 fs/binfmt_aout.c                                           |    2 
 fs/binfmt_em86.c                                           |    1 
 fs/binfmt_script.c                                         |    1 
 fs/bio-integrity.c                                         |    1 
 fs/bio.c                                                   |    4 
 fs/block_dev.c                                             |    5 
 fs/btrfs/acl.c                                             |    1 
 fs/btrfs/async-thread.c                                    |    1 
 fs/btrfs/compression.c                                     |   23 
 fs/btrfs/ctree.c                                           |    5 
 fs/btrfs/ctree.h                                           |    2 
 fs/btrfs/delayed-ref.c                                     |    1 
 fs/btrfs/disk-io.c                                         |   13 
 fs/btrfs/extent-tree.c                                     |   44 
 fs/btrfs/extent_io.c                                       |   16 
 fs/btrfs/extent_map.c                                      |    1 
 fs/btrfs/file-item.c                                       |    1 
 fs/btrfs/file.c                                            |    1 
 fs/btrfs/free-space-cache.c                                |    1 
 fs/btrfs/inode.c                                           |   60 
 fs/btrfs/ioctl.c                                           |    8 
 fs/btrfs/locking.c                                         |    1 
 fs/btrfs/ordered-data.c                                    |    7 
 fs/btrfs/ref-cache.c                                       |    1 
 fs/btrfs/relocation.c                                      |    1 
 fs/btrfs/super.c                                           |   24 
 fs/btrfs/transaction.c                                     |  113 
 fs/btrfs/tree-log.c                                        |    1 
 fs/btrfs/volumes.c                                         |   17 
 fs/cachefiles/interface.c                                  |    1 
 fs/cachefiles/namei.c                                      |    1 
 fs/cachefiles/rdwr.c                                       |    1 
 fs/cachefiles/xattr.c                                      |    1 
 fs/ceph/addr.c                                             |    1 
 fs/ceph/auth.c                                             |    1 
 fs/ceph/auth_none.c                                        |    1 
 fs/ceph/auth_x.c                                           |    1 
 fs/ceph/buffer.c                                           |    3 
 fs/ceph/caps.c                                             |    1 
 fs/ceph/crypto.c                                           |    1 
 fs/ceph/debugfs.c                                          |    1 
 fs/ceph/dir.c                                              |    1 
 fs/ceph/export.c                                           |    1 
 fs/ceph/file.c                                             |    1 
 fs/ceph/mds_client.c                                       |    1 
 fs/ceph/messenger.c                                        |    1 
 fs/ceph/mon_client.c                                       |    1 
 fs/ceph/osdmap.c                                           |    4 
 fs/ceph/pagelist.c                                         |    1 
 fs/ceph/snap.c                                             |    1 
 fs/ceph/super.c                                            |    1 
 fs/ceph/super.h                                            |    1 
 fs/ceph/xattr.c                                            |    1 
 fs/cifs/cifs_dfs_ref.c                                     |    1 
 fs/cifs/cifs_spnego.c                                      |    1 
 fs/cifs/cifs_unicode.c                                     |    1 
 fs/cifs/cifsacl.c                                          |    1 
 fs/cifs/cifsencrypt.c                                      |    1 
 fs/cifs/cifsfs.c                                           |    1 
 fs/cifs/cifsglob.h                                         |    1 
 fs/cifs/cifssmb.c                                          |   35 
 fs/cifs/connect.c                                          |    1 
 fs/cifs/dns_resolve.c                                      |    1 
 fs/cifs/file.c                                             |   29 
 fs/cifs/inode.c                                            |    1 
 fs/cifs/link.c                                             |    1 
 fs/cifs/readdir.c                                          |    1 
 fs/cifs/sess.c                                             |    1 
 fs/cifs/smbencrypt.c                                       |    1 
 fs/cifs/transport.c                                        |    1 
 fs/cifs/xattr.c                                            |    1 
 fs/coda/dir.c                                              |    1 
 fs/coda/file.c                                             |    1 
 fs/coda/inode.c                                            |    1 
 fs/coda/upcall.c                                           |    1 
 fs/compat.c                                                |    1 
 fs/compat_ioctl.c                                          |    2 
 fs/configfs/inode.c                                        |    1 
 fs/configfs/mount.c                                        |    1 
 fs/configfs/symlink.c                                      |    1 
 fs/debugfs/inode.c                                         |    1 
 fs/devpts/inode.c                                          |    1 
 fs/dlm/config.c                                            |    1 
 fs/dlm/debug_fs.c                                          |    1 
 fs/dlm/lock.c                                              |    1 
 fs/dlm/lowcomms.c                                          |    1 
 fs/dlm/netlink.c                                           |    1 
 fs/dlm/plock.c                                             |    1 
 fs/dlm/user.c                                              |    1 
 fs/ecryptfs/crypto.c                                       |    1 
 fs/ecryptfs/dentry.c                                       |    1 
 fs/ecryptfs/file.c                                         |    1 
 fs/ecryptfs/inode.c                                        |    1 
 fs/ecryptfs/keystore.c                                     |    1 
 fs/ecryptfs/kthread.c                                      |    1 
 fs/ecryptfs/main.c                                         |    1 
 fs/ecryptfs/messaging.c                                    |    1 
 fs/ecryptfs/miscdev.c                                      |    1 
 fs/ecryptfs/mmap.c                                         |    1 
 fs/ecryptfs/super.c                                        |    1 
 fs/eventfd.c                                               |    1 
 fs/exofs/inode.c                                           |    1 
 fs/exofs/ios.c                                             |    1 
 fs/exofs/super.c                                           |    1 
 fs/ext2/balloc.c                                           |    1 
 fs/ext2/symlink.c                                          |    2 
 fs/ext2/xattr_security.c                                   |    1 
 fs/ext3/balloc.c                                           |    1 
 fs/ext3/symlink.c                                          |    2 
 fs/ext3/xattr_security.c                                   |    1 
 fs/ext4/block_validity.c                                   |    1 
 fs/ext4/inode.c                                            |    1 
 fs/ext4/mballoc.c                                          |    1 
 fs/ext4/migrate.c                                          |    1 
 fs/ext4/move_extent.c                                      |    1 
 fs/ext4/xattr_security.c                                   |    1 
 fs/fat/cache.c                                             |    1 
 fs/fat/namei_vfat.c                                        |    6 
 fs/fifo.c                                                  |    1 
 fs/filesystems.c                                           |    2 
 fs/freevxfs/vxfs_subr.c                                    |    1 
 fs/fs-writeback.c                                          |  134 
 fs/fscache/object-list.c                                   |    1 
 fs/fscache/operation.c                                     |    1 
 fs/fscache/page.c                                          |    1 
 fs/fscache/stats.c                                         |    4 
 fs/fuse/cuse.c                                             |    1 
 fs/generic_acl.c                                           |    1 
 fs/gfs2/bmap.c                                             |    1 
 fs/gfs2/dentry.c                                           |    1 
 fs/gfs2/export.c                                           |    1 
 fs/gfs2/glops.c                                            |    1 
 fs/gfs2/lock_dlm.c                                         |    1 
 fs/gfs2/rgrp.h                                             |    2 
 fs/gfs2/sys.c                                              |    1 
 fs/gfs2/util.c                                             |    1 
 fs/hfs/bnode.c                                             |    1 
 fs/hfs/btree.c                                             |    1 
 fs/hfs/mdb.c                                               |    1 
 fs/hfs/super.c                                             |    1 
 fs/hfsplus/options.c                                       |    1 
 fs/hostfs/hostfs_kern.c                                    |    1 
 fs/hpfs/buffer.c                                           |    1 
 fs/hpfs/dir.c                                              |    1 
 fs/hpfs/inode.c                                            |    1 
 fs/hpfs/super.c                                            |    1 
 fs/ioprio.c                                                |    1 
 fs/isofs/dir.c                                             |    1 
 fs/isofs/namei.c                                           |    1 
 fs/jbd/commit.c                                            |    1 
 fs/jbd/recovery.c                                          |    1 
 fs/jbd2/recovery.c                                         |    1 
 fs/jffs2/compr_lzo.c                                       |    1 
 fs/jffs2/compr_zlib.c                                      |    1 
 fs/jffs2/debug.c                                           |    1 
 fs/jffs2/file.c                                            |    1 
 fs/jffs2/nodelist.c                                        |    1 
 fs/jffs2/nodemgmt.c                                        |    1 
 fs/jffs2/symlink.c                                         |    1 
 fs/jffs2/write.c                                           |    1 
 fs/jfs/acl.c                                               |    1 
 fs/jfs/jfs_dmap.c                                          |    1 
 fs/jfs/jfs_dtree.c                                         |    1 
 fs/jfs/jfs_imap.c                                          |    1 
 fs/jfs/jfs_logmgr.c                                        |    1 
 fs/jfs/jfs_metapage.c                                      |    1 
 fs/jfs/jfs_unicode.h                                       |    1 
 fs/jfs/super.c                                             |    1 
 fs/jfs/xattr.c                                             |    1 
 fs/libfs.c                                                 |    1 
 fs/lockd/clntlock.c                                        |    1 
 fs/lockd/clntproc.c                                        |    1 
 fs/lockd/mon.c                                             |    1 
 fs/lockd/svc.c                                             |    1 
 fs/lockd/svc4proc.c                                        |    1 
 fs/lockd/svclock.c                                         |    1 
 fs/lockd/svcproc.c                                         |    1 
 fs/lockd/svcsubs.c                                         |    1 
 fs/logfs/dev_bdev.c                                        |    1 
 fs/logfs/dir.c                                             |    2 
 fs/logfs/gc.c                                              |    1 
 fs/logfs/inode.c                                           |    1 
 fs/logfs/journal.c                                         |    1 
 fs/logfs/readwrite.c                                       |    1 
 fs/logfs/segment.c                                         |    1 
 fs/logfs/super.c                                           |    1 
 fs/minix/itree_v1.c                                        |    1 
 fs/mpage.c                                                 |    1 
 fs/ncpfs/dir.c                                             |    1 
 fs/ncpfs/file.c                                            |    1 
 fs/ncpfs/ioctl.c                                           |    1 
 fs/ncpfs/mmap.c                                            |    2 
 fs/ncpfs/sock.c                                            |    1 
 fs/ncpfs/symlink.c                                         |    1 
 fs/nfs/cache_lib.c                                         |    1 
 fs/nfs/callback_proc.c                                     |    1 
 fs/nfs/callback_xdr.c                                      |    1 
 fs/nfs/client.c                                            |    1 
 fs/nfs/delegation.c                                        |    1 
 fs/nfs/direct.c                                            |    1 
 fs/nfs/dns_resolve.c                                       |    1 
 fs/nfs/file.c                                              |    2 
 fs/nfs/fscache.c                                           |    1 
 fs/nfs/inode.c                                             |    1 
 fs/nfs/namespace.c                                         |    1 
 fs/nfs/nfs2xdr.c                                           |    1 
 fs/nfs/nfs3acl.c                                           |    1 
 fs/nfs/nfs3proc.c                                          |    1 
 fs/nfs/nfs3xdr.c                                           |    1 
 fs/nfs/nfs4namespace.c                                     |    1 
 fs/nfs/nfs4proc.c                                          |    4 
 fs/nfs/nfs4xdr.c                                           |    1 
 fs/nfs/proc.c                                              |    1 
 fs/nfs/super.c                                             |    1 
 fs/nfs/symlink.c                                           |    1 
 fs/nfs_common/nfsacl.c                                     |    1 
 fs/nfsd/export.c                                           |    1 
 fs/nfsd/nfs2acl.c                                          |    1 
 fs/nfsd/nfs3acl.c                                          |    1 
 fs/nfsd/nfs4acl.c                                          |    1 
 fs/nfsd/nfs4callback.c                                     |    1 
 fs/nfsd/nfs4idmap.c                                        |    1 
 fs/nfsd/nfs4proc.c                                         |    1 
 fs/nfsd/nfs4recover.c                                      |    1 
 fs/nfsd/nfs4state.c                                        |    1 
 fs/nfsd/nfs4xdr.c                                          |    1 
 fs/nfsd/nfscache.c                                         |    2 
 fs/nfsd/nfsctl.c                                           |    1 
 fs/nfsd/vfs.c                                              |    1 
 fs/nilfs2/alloc.c                                          |    3 
 fs/nilfs2/btnode.c                                         |    1 
 fs/nilfs2/btree.c                                          |    2 
 fs/nilfs2/gcinode.c                                        |    1 
 fs/nilfs2/inode.c                                          |    1 
 fs/nilfs2/ioctl.c                                          |    3 
 fs/nilfs2/mdt.c                                            |    1 
 fs/nilfs2/page.c                                           |    1 
 fs/nilfs2/recovery.c                                       |    1 
 fs/nilfs2/segbuf.c                                         |    1 
 fs/nilfs2/segment.c                                        |    1 
 fs/nilfs2/the_nilfs.h                                      |    1 
 fs/notify/fsnotify.c                                       |    1 
 fs/notify/inode_mark.c                                     |    1 
 fs/ntfs/aops.c                                             |    1 
 fs/ntfs/attrib.c                                           |    1 
 fs/ntfs/compress.c                                         |    1 
 fs/ntfs/dir.c                                              |    1 
 fs/ntfs/file.c                                             |    1 
 fs/ntfs/index.c                                            |    2 
 fs/ntfs/mft.c                                              |    1 
 fs/ntfs/namei.c                                            |    1 
 fs/ocfs2/acl.c                                             |    1 
 fs/ocfs2/buffer_head_io.c                                  |    1 
 fs/ocfs2/cluster/heartbeat.c                               |    1 
 fs/ocfs2/cluster/nodemanager.c                             |    1 
 fs/ocfs2/cluster/quorum.c                                  |    1 
 fs/ocfs2/dlm/dlmast.c                                      |    1 
 fs/ocfs2/dlm/dlmconvert.c                                  |    1 
 fs/ocfs2/dlm/dlmthread.c                                   |    1 
 fs/ocfs2/dlm/dlmunlock.c                                   |    1 
 fs/ocfs2/extent_map.c                                      |    1 
 fs/ocfs2/heartbeat.c                                       |    1 
 fs/ocfs2/inode.c                                           |    1 
 fs/ocfs2/mmap.c                                            |    1 
 fs/ocfs2/quota_global.c                                    |    1 
 fs/ocfs2/quota_local.c                                     |    1 
 fs/ocfs2/refcounttree.c                                    |    1 
 fs/ocfs2/stack_o2cb.c                                      |    1 
 fs/ocfs2/stack_user.c                                      |    1 
 fs/ocfs2/sysfile.c                                         |    1 
 fs/omfs/inode.c                                            |    1 
 fs/open.c                                                  |    2 
 fs/partitions/check.c                                      |    1 
 fs/partitions/efi.c                                        |    1 
 fs/proc/array.c                                            |    1 
 fs/proc/base.c                                             |    6 
 fs/proc/generic.c                                          |    1 
 fs/proc/inode.c                                            |    1 
 fs/proc/kcore.c                                            |    1 
 fs/proc/nommu.c                                            |    1 
 fs/proc/proc_devtree.c                                     |    1 
 fs/proc/proc_net.c                                         |    1 
 fs/proc/stat.c                                             |    1 
 fs/proc/task_mmu.c                                         |  117 
 fs/proc/task_nommu.c                                       |    1 
 fs/proc/vmcore.c                                           |    1 
 fs/quota/dquot.c                                           |   18 
 fs/quota/netlink.c                                         |    1 
 fs/ramfs/file-nommu.c                                      |    1 
 fs/ramfs/inode.c                                           |    1 
 fs/reiserfs/dir.c                                          |    1 
 fs/reiserfs/fix_node.c                                     |    1 
 fs/reiserfs/inode.c                                        |    1 
 fs/reiserfs/journal.c                                      |    1 
 fs/reiserfs/namei.c                                        |    1 
 fs/reiserfs/super.c                                        |   11 
 fs/reiserfs/xattr.c                                        |    1 
 fs/reiserfs/xattr_acl.c                                    |    1 
 fs/reiserfs/xattr_security.c                               |    1 
 fs/signalfd.c                                              |    1 
 fs/smbfs/file.c                                            |    1 
 fs/smbfs/smbiod.c                                          |    1 
 fs/smbfs/symlink.c                                         |    1 
 fs/splice.c                                                |    1 
 fs/squashfs/symlink.c                                      |    1 
 fs/squashfs/zlib_wrapper.c                                 |    1 
 fs/sync.c                                                  |    1 
 fs/sysfs/inode.c                                           |    1 
 fs/sysfs/mount.c                                           |    1 
 fs/sysfs/symlink.c                                         |    1 
 fs/timerfd.c                                               |    1 
 fs/ubifs/commit.c                                          |    1 
 fs/ubifs/debug.c                                           |    1 
 fs/ubifs/file.c                                            |    1 
 fs/ubifs/gc.c                                              |    1 
 fs/ubifs/io.c                                              |    1 
 fs/ubifs/lpt.c                                             |    1 
 fs/ubifs/lpt_commit.c                                      |    1 
 fs/ubifs/recovery.c                                        |    1 
 fs/ubifs/sb.c                                              |    1 
 fs/ubifs/tnc.c                                             |    1 
 fs/ubifs/ubifs.h                                           |    1 
 fs/ubifs/xattr.c                                           |    1 
 fs/udf/balloc.c                                            |   10 
 fs/udf/file.c                                              |    2 
 fs/udf/inode.c                                             |    2 
 fs/udf/namei.c                                             |    9 
 fs/udf/partition.c                                         |    1 
 fs/udf/symlink.c                                           |    1 
 fs/udf/udfdecl.h                                           |    3 
 fs/udf/unicode.c                                           |    1 
 fs/xattr_acl.c                                             |    2 
 fs/xfs/linux-2.6/kmem.c                                    |    1 
 fs/xfs/linux-2.6/xfs_acl.c                                 |    1 
 fs/xfs/linux-2.6/xfs_aops.c                                |    1 
 fs/xfs/linux-2.6/xfs_buf.c                                 |    2 
 fs/xfs/linux-2.6/xfs_ioctl.c                               |    1 
 fs/xfs/linux-2.6/xfs_ioctl32.c                             |    1 
 fs/xfs/linux-2.6/xfs_iops.c                                |    1 
 fs/xfs/linux-2.6/xfs_super.c                               |    1 
 include/drm/drmP.h                                         |   35 
 include/drm/drm_mem_util.h                                 |   65 
 include/drm/drm_pciids.h                                   |    1 
 include/drm/ttm/ttm_bo_driver.h                            |    1 
 include/linux/amba/bus.h                                   |    3 
 include/linux/amba/pl061.h                                 |    2 
 include/linux/ata.h                                        |    4 
 include/linux/bitops.h                                     |    3 
 include/linux/blkdev.h                                     |   35 
 include/linux/delayacct.h                                  |    1 
 include/linux/drbd.h                                       |    2 
 include/linux/drbd_nl.h                                    |    3 
 include/linux/freezer.h                                    |    7 
 include/linux/fs.h                                         |    1 
 include/linux/fsnotify.h                                   |    1 
 include/linux/gameport.h                                   |    1 
 include/linux/genhd.h                                      |    2 
 include/linux/i2o.h                                        |    1 
 include/linux/ide.h                                        |    1 
 include/linux/io-mapping.h                                 |    1 
 include/linux/iscsi_ibft.h                                 |    8 
 include/linux/jbd.h                                        |    1 
 include/linux/jbd2.h                                       |    1 
 include/linux/kernel.h                                     |    2 
 include/linux/kfifo.h                                      |    3 
 include/linux/lcm.h                                        |    8 
 include/linux/libata.h                                     |    1 
 include/linux/mm.h                                         |    4 
 include/linux/module.h                                     |   25 
 include/linux/page_cgroup.h                                |    6 
 include/linux/percpu.h                                     |   31 
 include/linux/perf_event.h                                 |   21 
 include/linux/radix-tree.h                                 |    7 
 include/linux/security.h                                   |    2 
 include/linux/slab.h                                       |    1 
 include/linux/spi/spi.h                                    |    1 
 include/linux/taskstats_kern.h                             |    1 
 include/linux/usb/gadget.h                                 |    2 
 include/linux/virtio_console.h                             |   23 
 include/linux/wimax/debug.h                                |    1 
 include/linux/writeback.h                                  |    3 
 include/net/9p/client.h                                    |    2 
 include/net/ax25.h                                         |    1 
 include/net/fib_rules.h                                    |    1 
 include/net/ipx.h                                          |    1 
 include/net/iucv/iucv.h                                    |    1 
 include/net/netfilter/nf_conntrack_extend.h                |    2 
 include/net/netlabel.h                                     |    1 
 include/net/netrom.h                                       |    1 
 include/net/sock.h                                         |    1 
 include/net/x25.h                                          |    1 
 include/net/xfrm.h                                         |    1 
 include/scsi/libsas.h                                      |    1 
 include/sound/ak4113.h                                     |    2 
 include/sound/soc-dai.h                                    |   18 
 include/sound/soc.h                                        |    1 
 include/trace/events/block.h                               |  164 
 include/xen/xenbus.h                                       |    1 
 init/do_mounts.c                                           |    1 
 init/do_mounts_rd.c                                        |    1 
 init/main.c                                                |    2 
 ipc/compat.c                                               |    1 
 ipc/mqueue.c                                               |    1 
 ipc/msg.c                                                  |    1 
 kernel/async.c                                             |    1 
 kernel/audit.c                                             |    1 
 kernel/audit_tree.c                                        |    1 
 kernel/audit_watch.c                                       |    1 
 kernel/auditfilter.c                                       |    1 
 kernel/auditsc.c                                           |    3 
 kernel/cgroup_freezer.c                                    |   10 
 kernel/compat.c                                            |    1 
 kernel/cpu.c                                               |    1 
 kernel/cred.c                                              |    1 
 kernel/exit.c                                              |    3 
 kernel/fork.c                                              |    3 
 kernel/irq/manage.c                                        |   10 
 kernel/irq/numa_migrate.c                                  |    1 
 kernel/irq/proc.c                                          |    1 
 kernel/kallsyms.c                                          |    1 
 kernel/kgdb.c                                              |  205 
 kernel/latencytop.c                                        |    1 
 kernel/lockdep.c                                           |   22 
 kernel/module.c                                            |  139 
 kernel/nsproxy.c                                           |    1 
 kernel/padata.c                                            |    1 
 kernel/perf_event.c                                        |   23 
 kernel/pid_namespace.c                                     |    1 
 kernel/power/hibernate.c                                   |    1 
 kernel/power/hibernate_nvs.c                               |    1 
 kernel/power/process.c                                     |    5 
 kernel/power/snapshot.c                                    |    1 
 kernel/power/suspend.c                                     |    1 
 kernel/power/swap.c                                        |    1 
 kernel/res_counter.c                                       |    1 
 kernel/sched.c                                             |    5 
 kernel/sched_cpupri.c                                      |    1 
 kernel/sched_debug.c                                       |    4 
 kernel/smp.c                                               |    1 
 kernel/srcu.c                                              |    1 
 kernel/sys.c                                               |    1 
 kernel/sysctl_binary.c                                     |    1 
 kernel/taskstats.c                                         |    1 
 kernel/time.c                                              |    1 
 kernel/time/timecompare.c                                  |    1 
 kernel/timer.c                                             |    1 
 kernel/trace/blktrace.c                                    |    1 
 kernel/trace/ftrace.c                                      |    1 
 kernel/trace/power-traces.c                                |    1 
 kernel/trace/ring_buffer.c                                 |    9 
 kernel/trace/trace.c                                       |    2 
 kernel/trace/trace_clock.c                                 |    4 
 kernel/trace/trace_event_perf.c                            |   11 
 kernel/trace/trace_events.c                                |    1 
 kernel/trace/trace_events_filter.c                         |    1 
 kernel/trace/trace_functions_graph.c                       |    1 
 kernel/trace/trace_ksym.c                                  |    1 
 kernel/trace/trace_mmiotrace.c                             |    1 
 kernel/trace/trace_selftest.c                              |    1 
 kernel/trace/trace_stat.c                                  |    1 
 kernel/trace/trace_syscalls.c                              |    1 
 kernel/trace/trace_workqueue.c                             |    1 
 lib/Kconfig.debug                                          |    2 
 lib/Makefile                                               |    2 
 lib/cpumask.c                                              |    1 
 lib/crc32.c                                                |    1 
 lib/debugobjects.c                                         |    1 
 lib/devres.c                                               |    1 
 lib/dynamic_debug.c                                        |    1 
 lib/genalloc.c                                             |    1 
 lib/inflate.c                                              |    1 
 lib/kasprintf.c                                            |    1 
 lib/kobject_uevent.c                                       |    1 
 lib/kref.c                                                 |    1 
 lib/lcm.c                                                  |   15 
 lib/radix-tree.c                                           |   13 
 lib/ratelimit.c                                            |   11 
 lib/rwsem-spinlock.c                                       |   14 
 lib/scatterlist.c                                          |    1 
 lib/swiotlb.c                                              |    1 
 lib/textsearch.c                                           |    1 
 mm/Makefile                                                |    6 
 mm/backing-dev.c                                           |    3 
 mm/bootmem.c                                               |   18 
 mm/bounce.c                                                |    1 
 mm/failslab.c                                              |    1 
 mm/filemap.c                                               |    2 
 mm/filemap_xip.c                                           |    1 
 mm/hugetlb.c                                               |    2 
 mm/kmemleak.c                                              |    1 
 mm/memcontrol.c                                            |   18 
 mm/memory-failure.c                                        |    1 
 mm/memory.c                                                |    4 
 mm/mempolicy.c                                             |    1 
 mm/migrate.c                                               |    1 
 mm/mincore.c                                               |    2 
 mm/mmap.c                                                  |  110 
 mm/mmu_notifier.c                                          |    1 
 mm/mprotect.c                                              |    1 
 mm/mremap.c                                                |    1 
 mm/oom_kill.c                                              |    1 
 mm/page_io.c                                               |    1 
 mm/pagewalk.c                                              |   47 
 mm/percpu.c                                                |   26 
 mm/percpu_up.c                                             |   30 
 mm/quicklist.c                                             |    1 
 mm/readahead.c                                             |    3 
 mm/rmap.c                                                  |   18 
 mm/slab.c                                                  |   13 
 mm/slub.c                                                  |    3 
 mm/sparse-vmemmap.c                                        |    1 
 mm/sparse.c                                                |    1 
 mm/swap.c                                                  |    1 
 mm/swap_state.c                                            |    1 
 mm/truncate.c                                              |    1 
 mm/util.c                                                  |   21 
 mm/vmscan.c                                                |   25 
 mm/vmstat.c                                                |    1 
 net/802/garp.c                                             |    1 
 net/802/p8022.c                                            |    1 
 net/802/p8023.c                                            |    1 
 net/802/psnap.c                                            |    1 
 net/802/stp.c                                              |    1 
 net/802/tr.c                                               |    1 
 net/8021q/vlan.c                                           |    1 
 net/8021q/vlan_dev.c                                       |    1 
 net/9p/client.c                                            |   24 
 net/9p/protocol.c                                          |    1 
 net/9p/trans_fd.c                                          |    1 
 net/9p/trans_rdma.c                                        |    1 
 net/9p/trans_virtio.c                                      |    1 
 net/9p/util.c                                              |    1 
 net/appletalk/aarp.c                                       |    1 
 net/appletalk/ddp.c                                        |    1 
 net/atm/addr.c                                             |    1 
 net/atm/atm_sysfs.c                                        |    1 
 net/atm/br2684.c                                           |    1 
 net/atm/clip.c                                             |    1 
 net/atm/common.c                                           |    1 
 net/atm/lec.c                                              |    1 
 net/atm/mpc.c                                              |    1 
 net/atm/mpoa_caches.c                                      |    1 
 net/atm/mpoa_proc.c                                        |    1 
 net/atm/pppoatm.c                                          |    1 
 net/atm/proc.c                                             |    1 
 net/atm/raw.c                                              |    1 
 net/atm/resources.c                                        |    1 
 net/atm/signaling.c                                        |    1 
 net/ax25/af_ax25.c                                         |    1 
 net/ax25/ax25_dev.c                                        |    1 
 net/ax25/ax25_ds_subr.c                                    |    1 
 net/ax25/ax25_iface.c                                      |    1 
 net/ax25/ax25_in.c                                         |    1 
 net/ax25/ax25_ip.c                                         |    1 
 net/ax25/ax25_out.c                                        |    1 
 net/ax25/ax25_route.c                                      |    1 
 net/ax25/ax25_subr.c                                       |    1 
 net/ax25/ax25_uid.c                                        |    1 
 net/ax25/sysctl_net_ax25.c                                 |    1 
 net/bluetooth/af_bluetooth.c                               |    1 
 net/bluetooth/bnep/core.c                                  |    1 
 net/bluetooth/bnep/netdev.c                                |    1 
 net/bluetooth/bnep/sock.c                                  |    2 
 net/bluetooth/cmtp/sock.c                                  |    2 
 net/bluetooth/hci_sysfs.c                                  |    1 
 net/bluetooth/hidp/sock.c                                  |    2 
 net/bluetooth/l2cap.c                                      |    3 
 net/bluetooth/rfcomm/core.c                                |    1 
 net/bluetooth/rfcomm/sock.c                                |    3 
 net/bluetooth/sco.c                                        |    3 
 net/bridge/br_fdb.c                                        |    1 
 net/bridge/br_forward.c                                    |    1 
 net/bridge/br_if.c                                         |    1 
 net/bridge/br_input.c                                      |    1 
 net/bridge/br_ioctl.c                                      |    1 
 net/bridge/br_netfilter.c                                  |    1 
 net/bridge/br_netlink.c                                    |    1 
 net/bridge/br_stp_bpdu.c                                   |    1 
 net/bridge/netfilter/ebt_ulog.c                            |    1 
 net/bridge/netfilter/ebtables.c                            |    1 
 net/can/bcm.c                                              |    4 
 net/can/raw.c                                              |    1 
 net/compat.c                                               |    1 
 net/core/datagram.c                                        |    1 
 net/core/dev.c                                             |    1 
 net/core/drop_monitor.c                                    |    1 
 net/core/dst.c                                             |    1 
 net/core/ethtool.c                                         |    1 
 net/core/fib_rules.c                                       |    1 
 net/core/filter.c                                          |    1 
 net/core/gen_estimator.c                                   |    1 
 net/core/iovec.c                                           |    1 
 net/core/link_watch.c                                      |    1 
 net/core/neighbour.c                                       |    1 
 net/core/net-sysfs.c                                       |    1 
 net/core/net-traces.c                                      |    1 
 net/core/netpoll.c                                         |    1 
 net/core/scm.c                                             |    1 
 net/core/sysctl_net_core.c                                 |    1 
 net/dcb/dcbnl.c                                            |    1 
 net/dccp/ccid.c                                            |    2 
 net/dccp/ccids/ccid2.c                                     |    1 
 net/dccp/feat.c                                            |    1 
 net/dccp/input.c                                           |    1 
 net/dccp/ipv4.c                                            |    1 
 net/dccp/ipv6.c                                            |    1 
 net/dccp/minisocks.c                                       |    1 
 net/dccp/output.c                                          |    1 
 net/dccp/probe.c                                           |    1 
 net/dccp/proto.c                                           |    1 
 net/decnet/dn_dev.c                                        |    1 
 net/decnet/dn_fib.c                                        |    1 
 net/decnet/dn_neigh.c                                      |    1 
 net/decnet/dn_nsp_in.c                                     |    1 
 net/decnet/dn_nsp_out.c                                    |    1 
 net/decnet/dn_route.c                                      |    1 
 net/decnet/dn_table.c                                      |    1 
 net/decnet/netfilter/dn_rtmsg.c                            |    1 
 net/dsa/dsa.c                                              |    1 
 net/dsa/tag_dsa.c                                          |    1 
 net/dsa/tag_edsa.c                                         |    1 
 net/dsa/tag_trailer.c                                      |    1 
 net/econet/af_econet.c                                     |    1 
 net/ethernet/pe2.c                                         |    1 
 net/ieee802154/af_ieee802154.c                             |    4 
 net/ieee802154/dgram.c                                     |    1 
 net/ieee802154/netlink.c                                   |    1 
 net/ieee802154/nl-mac.c                                    |    1 
 net/ieee802154/nl-phy.c                                    |    1 
 net/ieee802154/raw.c                                       |    1 
 net/ieee802154/wpan-class.c                                |    1 
 net/ipv4/af_inet.c                                         |    6 
 net/ipv4/ah4.c                                             |    1 
 net/ipv4/arp.c                                             |    1 
 net/ipv4/cipso_ipv4.c                                      |    1 
 net/ipv4/devinet.c                                         |    1 
 net/ipv4/fib_frontend.c                                    |    1 
 net/ipv4/fib_hash.c                                        |    1 
 net/ipv4/fib_semantics.c                                   |    1 
 net/ipv4/fib_trie.c                                        |    1 
 net/ipv4/icmp.c                                            |    1 
 net/ipv4/igmp.c                                            |    1 
 net/ipv4/inet_diag.c                                       |    1 
 net/ipv4/inet_fragment.c                                   |    1 
 net/ipv4/inet_timewait_sock.c                              |    1 
 net/ipv4/ip_forward.c                                      |    1 
 net/ipv4/ip_fragment.c                                     |    1 
 net/ipv4/ip_gre.c                                          |    1 
 net/ipv4/ip_input.c                                        |    1 
 net/ipv4/ip_options.c                                      |    1 
 net/ipv4/ip_output.c                                       |    1 
 net/ipv4/ip_sockglue.c                                     |    1 
 net/ipv4/ipconfig.c                                        |    1 
 net/ipv4/ipip.c                                            |    1 
 net/ipv4/ipmr.c                                            |    1 
 net/ipv4/netfilter.c                                       |    1 
 net/ipv4/netfilter/arptable_filter.c                       |    1 
 net/ipv4/netfilter/ip_queue.c                              |    1 
 net/ipv4/netfilter/ipt_CLUSTERIP.c                         |    1 
 net/ipv4/netfilter/ipt_REJECT.c                            |    1 
 net/ipv4/netfilter/ipt_ULOG.c                              |    1 
 net/ipv4/netfilter/iptable_filter.c                        |    1 
 net/ipv4/netfilter/iptable_mangle.c                        |    1 
 net/ipv4/netfilter/iptable_raw.c                           |    1 
 net/ipv4/netfilter/iptable_security.c                      |    1 
 net/ipv4/netfilter/nf_nat_core.c                           |    1 
 net/ipv4/netfilter/nf_nat_helper.c                         |    1 
 net/ipv4/netfilter/nf_nat_rule.c                           |    1 
 net/ipv4/netfilter/nf_nat_snmp_basic.c                     |    1 
 net/ipv4/netfilter/nf_nat_standalone.c                     |    1 
 net/ipv4/raw.c                                             |    1 
 net/ipv4/route.c                                           |    1 
 net/ipv4/sysctl_net_ipv4.c                                 |    1 
 net/ipv4/tcp.c                                             |    2 
 net/ipv4/tcp_cong.c                                        |    1 
 net/ipv4/tcp_input.c                                       |    1 
 net/ipv4/tcp_ipv4.c                                        |    1 
 net/ipv4/tcp_minisocks.c                                   |    1 
 net/ipv4/tcp_output.c                                      |    1 
 net/ipv4/tcp_probe.c                                       |    1 
 net/ipv4/tcp_timer.c                                       |    1 
 net/ipv4/tunnel4.c                                         |    1 
 net/ipv4/udp.c                                             |    1 
 net/ipv4/xfrm4_input.c                                     |    1 
 net/ipv4/xfrm4_mode_tunnel.c                               |    1 
 net/ipv6/addrconf.c                                        |    1 
 net/ipv6/addrlabel.c                                       |    1 
 net/ipv6/af_inet6.c                                        |    1 
 net/ipv6/ah6.c                                             |    1 
 net/ipv6/anycast.c                                         |    1 
 net/ipv6/datagram.c                                        |    1 
 net/ipv6/exthdrs.c                                         |    1 
 net/ipv6/icmp.c                                            |    1 
 net/ipv6/inet6_connection_sock.c                           |    1 
 net/ipv6/ip6_fib.c                                         |    1 
 net/ipv6/ip6_flowlabel.c                                   |    1 
 net/ipv6/ip6_input.c                                       |    1 
 net/ipv6/ip6_output.c                                      |    1 
 net/ipv6/ip6_tunnel.c                                      |    1 
 net/ipv6/ip6mr.c                                           |    1 
 net/ipv6/ipv6_sockglue.c                                   |    1 
 net/ipv6/mcast.c                                           |    1 
 net/ipv6/ndisc.c                                           |    1 
 net/ipv6/netfilter/ip6_queue.c                             |    1 
 net/ipv6/netfilter/ip6t_REJECT.c                           |    1 
 net/ipv6/netfilter/ip6table_filter.c                       |    1 
 net/ipv6/netfilter/ip6table_mangle.c                       |    1 
 net/ipv6/netfilter/ip6table_raw.c                          |    1 
 net/ipv6/netfilter/ip6table_security.c                     |    1 
 net/ipv6/netfilter/nf_conntrack_reasm.c                    |    1 
 net/ipv6/raw.c                                             |    1 
 net/ipv6/reassembly.c                                      |    1 
 net/ipv6/route.c                                           |    1 
 net/ipv6/sit.c                                             |    1 
 net/ipv6/sysctl_net_ipv6.c                                 |    1 
 net/ipv6/tcp_ipv6.c                                        |    1 
 net/ipv6/tunnel6.c                                         |    1 
 net/ipv6/udp.c                                             |    1 
 net/ipv6/xfrm6_mode_tunnel.c                               |    1 
 net/ipv6/xfrm6_tunnel.c                                    |    1 
 net/ipx/af_ipx.c                                           |    1 
 net/ipx/ipx_route.c                                        |    1 
 net/irda/af_irda.c                                         |    1 
 net/irda/discovery.c                                       |    1 
 net/irda/ircomm/ircomm_core.c                              |    1 
 net/irda/ircomm/ircomm_lmp.c                               |    1 
 net/irda/ircomm/ircomm_param.c                             |    1 
 net/irda/ircomm/ircomm_tty.c                               |    1 
 net/irda/irda_device.c                                     |    1 
 net/irda/iriap.c                                           |    1 
 net/irda/iriap_event.c                                     |    2 
 net/irda/irias_object.c                                    |    1 
 net/irda/irlan/irlan_client.c                              |    1 
 net/irda/irlan/irlan_common.c                              |    1 
 net/irda/irlan/irlan_provider.c                            |    1 
 net/irda/irlap_event.c                                     |    1 
 net/irda/irlap_frame.c                                     |    1 
 net/irda/irnet/irnet_irda.c                                |    1 
 net/irda/irnet/irnet_ppp.c                                 |    1 
 net/irda/irnetlink.c                                       |    1 
 net/irda/irqueue.c                                         |    1 
 net/irda/irttp.c                                           |    1 
 net/key/af_key.c                                           |    1 
 net/lapb/lapb_iface.c                                      |    1 
 net/lapb/lapb_in.c                                         |    1 
 net/lapb/lapb_out.c                                        |    1 
 net/lapb/lapb_subr.c                                       |    1 
 net/llc/af_llc.c                                           |    1 
 net/llc/llc_c_ac.c                                         |    1 
 net/llc/llc_conn.c                                         |    1 
 net/llc/llc_if.c                                           |    1 
 net/llc/llc_input.c                                        |    1 
 net/llc/llc_sap.c                                          |    1 
 net/llc/llc_station.c                                      |    1 
 net/mac80211/agg-rx.c                                      |    1 
 net/mac80211/agg-tx.c                                      |    1 
 net/mac80211/cfg.c                                         |    1 
 net/mac80211/debugfs_key.c                                 |    1 
 net/mac80211/debugfs_netdev.c                              |    1 
 net/mac80211/ibss.c                                        |    1 
 net/mac80211/iface.c                                       |    1 
 net/mac80211/key.c                                         |    1 
 net/mac80211/led.c                                         |    1 
 net/mac80211/mesh.c                                        |    1 
 net/mac80211/mesh_hwmp.c                                   |    5 
 net/mac80211/mesh_pathtbl.c                                |    1 
 net/mac80211/mesh_plink.c                                  |    1 
 net/mac80211/mlme.c                                        |    1 
 net/mac80211/rate.c                                        |    1 
 net/mac80211/rc80211_minstrel.c                            |    1 
 net/mac80211/rc80211_minstrel_debugfs.c                    |    1 
 net/mac80211/rc80211_pid_algo.c                            |    1 
 net/mac80211/rc80211_pid_debugfs.c                         |    1 
 net/mac80211/rx.c                                          |    1 
 net/mac80211/scan.c                                        |    1 
 net/mac80211/tx.c                                          |    6 
 net/mac80211/util.c                                        |   18 
 net/mac80211/wep.c                                         |    1 
 net/mac80211/work.c                                        |    1 
 net/mac80211/wpa.c                                         |    2 
 net/netfilter/core.c                                       |    1 
 net/netfilter/ipvs/ip_vs_app.c                             |    1 
 net/netfilter/ipvs/ip_vs_conn.c                            |    1 
 net/netfilter/ipvs/ip_vs_core.c                            |    1 
 net/netfilter/ipvs/ip_vs_ctl.c                             |    1 
 net/netfilter/ipvs/ip_vs_dh.c                              |    1 
 net/netfilter/ipvs/ip_vs_est.c                             |    1 
 net/netfilter/ipvs/ip_vs_ftp.c                             |    1 
 net/netfilter/ipvs/ip_vs_lblc.c                            |    1 
 net/netfilter/ipvs/ip_vs_lblcr.c                           |    1 
 net/netfilter/ipvs/ip_vs_proto.c                           |    1 
 net/netfilter/ipvs/ip_vs_sh.c                              |    1 
 net/netfilter/ipvs/ip_vs_wrr.c                             |    1 
 net/netfilter/ipvs/ip_vs_xmit.c                            |    1 
 net/netfilter/nf_conntrack_acct.c                          |    1 
 net/netfilter/nf_conntrack_amanda.c                        |    1 
 net/netfilter/nf_conntrack_ecache.c                        |    1 
 net/netfilter/nf_conntrack_ftp.c                           |    1 
 net/netfilter/nf_conntrack_h323_main.c                     |    1 
 net/netfilter/nf_conntrack_helper.c                        |    1 
 net/netfilter/nf_conntrack_irc.c                           |    1 
 net/netfilter/nf_conntrack_netlink.c                       |    1 
 net/netfilter/nf_conntrack_proto.c                         |    1 
 net/netfilter/nf_conntrack_proto_dccp.c                    |    1 
 net/netfilter/nf_conntrack_proto_gre.c                     |    1 
 net/netfilter/nf_conntrack_sane.c                          |    1 
 net/netfilter/nf_conntrack_standalone.c                    |    1 
 net/netfilter/nf_queue.c                                   |    1 
 net/netfilter/nfnetlink_log.c                              |    1 
 net/netfilter/nfnetlink_queue.c                            |    1 
 net/netfilter/x_tables.c                                   |    1 
 net/netfilter/xt_CT.c                                      |    1 
 net/netfilter/xt_LED.c                                     |    1 
 net/netfilter/xt_RATEEST.c                                 |    1 
 net/netfilter/xt_TCPMSS.c                                  |    1 
 net/netfilter/xt_connlimit.c                               |    1 
 net/netfilter/xt_dccp.c                                    |    1 
 net/netfilter/xt_limit.c                                   |    1 
 net/netfilter/xt_quota.c                                   |    1 
 net/netfilter/xt_recent.c                                  |    1 
 net/netfilter/xt_statistic.c                               |    1 
 net/netfilter/xt_string.c                                  |    1 
 net/netlabel/netlabel_cipso_v4.c                           |    1 
 net/netlabel/netlabel_domainhash.c                         |   29 
 net/netlabel/netlabel_kapi.c                               |    1 
 net/netlabel/netlabel_mgmt.c                               |    1 
 net/netlabel/netlabel_unlabeled.c                          |   67 
 net/netlabel/netlabel_user.c                               |    1 
 net/netlink/af_netlink.c                                   |    3 
 net/netlink/genetlink.c                                    |    1 
 net/netrom/af_netrom.c                                     |    1 
 net/netrom/nr_dev.c                                        |    1 
 net/netrom/nr_in.c                                         |    1 
 net/netrom/nr_loopback.c                                   |    1 
 net/netrom/nr_out.c                                        |    1 
 net/netrom/nr_route.c                                      |    1 
 net/netrom/nr_subr.c                                       |    1 
 net/packet/af_packet.c                                     |    1 
 net/phonet/af_phonet.c                                     |    1 
 net/phonet/datagram.c                                      |    1 
 net/phonet/pep.c                                           |    1 
 net/phonet/pn_dev.c                                        |    1 
 net/phonet/pn_netlink.c                                    |    1 
 net/phonet/socket.c                                        |    1 
 net/rds/af_rds.c                                           |    1 
 net/rds/cong.c                                             |    1 
 net/rds/connection.c                                       |    1 
 net/rds/ib.c                                               |    1 
 net/rds/ib_cm.c                                            |    1 
 net/rds/ib_rdma.c                                          |    1 
 net/rds/ib_recv.c                                          |    1 
 net/rds/info.c                                             |    1 
 net/rds/iw.c                                               |    1 
 net/rds/iw_cm.c                                            |    1 
 net/rds/iw_rdma.c                                          |    1 
 net/rds/iw_recv.c                                          |    1 
 net/rds/loop.c                                             |    1 
 net/rds/message.c                                          |    1 
 net/rds/page.c                                             |    1 
 net/rds/rdma.c                                             |    1 
 net/rds/recv.c                                             |    1 
 net/rds/send.c                                             |    1 
 net/rds/tcp.c                                              |    1 
 net/rds/tcp_listen.c                                       |    1 
 net/rds/tcp_recv.c                                         |    1 
 net/rfkill/core.c                                          |    1 
 net/rose/af_rose.c                                         |    1 
 net/rose/rose_dev.c                                        |    1 
 net/rose/rose_link.c                                       |    1 
 net/rose/rose_loopback.c                                   |    1 
 net/rose/rose_out.c                                        |    1 
 net/rose/rose_route.c                                      |    1 
 net/rose/rose_subr.c                                       |    1 
 net/rxrpc/af_rxrpc.c                                       |    1 
 net/rxrpc/ar-accept.c                                      |    1 
 net/rxrpc/ar-ack.c                                         |    1 
 net/rxrpc/ar-call.c                                        |    1 
 net/rxrpc/ar-connection.c                                  |    1 
 net/rxrpc/ar-input.c                                       |    1 
 net/rxrpc/ar-key.c                                         |    1 
 net/rxrpc/ar-local.c                                       |    1 
 net/rxrpc/ar-output.c                                      |    1 
 net/rxrpc/ar-peer.c                                        |    1 
 net/rxrpc/ar-transport.c                                   |    1 
 net/rxrpc/rxkad.c                                          |    1 
 net/sched/act_api.c                                        |    1 
 net/sched/act_ipt.c                                        |    1 
 net/sched/act_mirred.c                                     |    1 
 net/sched/act_pedit.c                                      |    1 
 net/sched/act_police.c                                     |    1 
 net/sched/act_simple.c                                     |    1 
 net/sched/cls_api.c                                        |    1 
 net/sched/cls_basic.c                                      |    1 
 net/sched/cls_cgroup.c                                     |    1 
 net/sched/cls_flow.c                                       |    1 
 net/sched/cls_fw.c                                         |    1 
 net/sched/cls_route.c                                      |    1 
 net/sched/cls_tcindex.c                                    |    1 
 net/sched/cls_u32.c                                        |    1 
 net/sched/em_meta.c                                        |    1 
 net/sched/em_nbyte.c                                       |    1 
 net/sched/em_text.c                                        |    1 
 net/sched/ematch.c                                         |    1 
 net/sched/sch_api.c                                        |    1 
 net/sched/sch_atm.c                                        |    1 
 net/sched/sch_cbq.c                                        |    1 
 net/sched/sch_drr.c                                        |    1 
 net/sched/sch_dsmark.c                                     |    1 
 net/sched/sch_fifo.c                                       |    1 
 net/sched/sch_generic.c                                    |    1 
 net/sched/sch_gred.c                                       |    1 
 net/sched/sch_htb.c                                        |    1 
 net/sched/sch_mq.c                                         |    1 
 net/sched/sch_multiq.c                                     |    1 
 net/sched/sch_netem.c                                      |    1 
 net/sched/sch_prio.c                                       |    1 
 net/sched/sch_sfq.c                                        |    1 
 net/sched/sch_teql.c                                       |    1 
 net/sctp/auth.c                                            |    1 
 net/sctp/bind_addr.c                                       |    1 
 net/sctp/chunk.c                                           |    1 
 net/sctp/input.c                                           |    1 
 net/sctp/inqueue.c                                         |    1 
 net/sctp/ipv6.c                                            |    1 
 net/sctp/output.c                                          |    1 
 net/sctp/outqueue.c                                        |    1 
 net/sctp/primitive.c                                       |    1 
 net/sctp/protocol.c                                        |    1 
 net/sctp/sm_make_chunk.c                                   |    1 
 net/sctp/sm_sideeffect.c                                   |    1 
 net/sctp/sm_statefuns.c                                    |    1 
 net/sctp/socket.c                                          |    1 
 net/sctp/ssnmap.c                                          |    1 
 net/sctp/transport.c                                       |    1 
 net/sctp/tsnmap.c                                          |    1 
 net/sctp/ulpevent.c                                        |    1 
 net/sctp/ulpqueue.c                                        |    1 
 net/socket.c                                               |    1 
 net/sunrpc/addr.c                                          |    1 
 net/sunrpc/auth_generic.c                                  |    1 
 net/sunrpc/auth_gss/gss_generic_token.c                    |    1 
 net/sunrpc/auth_gss/gss_krb5_crypto.c                      |    1 
 net/sunrpc/auth_gss/gss_krb5_seal.c                        |    1 
 net/sunrpc/auth_gss/gss_krb5_seqnum.c                      |    1 
 net/sunrpc/auth_gss/gss_krb5_unseal.c                      |    1 
 net/sunrpc/auth_gss/gss_krb5_wrap.c                        |    1 
 net/sunrpc/auth_gss/gss_spkm3_seal.c                       |    1 
 net/sunrpc/auth_gss/svcauth_gss.c                          |    1 
 net/sunrpc/auth_unix.c                                     |    1 
 net/sunrpc/backchannel_rqst.c                              |    1 
 net/sunrpc/rpcb_clnt.c                                     |    1 
 net/sunrpc/socklib.c                                       |    1 
 net/sunrpc/stats.c                                         |    1 
 net/sunrpc/svc.c                                           |    1 
 net/sunrpc/svc_xprt.c                                      |    1 
 net/sunrpc/svcauth_unix.c                                  |    1 
 net/sunrpc/xdr.c                                           |    1 
 net/sunrpc/xprtrdma/svc_rdma.c                             |    1 
 net/sunrpc/xprtrdma/svc_rdma_transport.c                   |    6 
 net/sunrpc/xprtrdma/transport.c                            |    1 
 net/sunrpc/xprtrdma/verbs.c                                |    1 
 net/tipc/core.h                                            |    1 
 net/tipc/eth_media.c                                       |    1 
 net/tipc/socket.c                                          |    2 
 net/unix/garbage.c                                         |    1 
 net/unix/sysctl_net_unix.c                                 |    1 
 net/wimax/op-msg.c                                         |    1 
 net/wimax/stack.c                                          |    1 
 net/wireless/core.c                                        |    1 
 net/wireless/debugfs.c                                     |    1 
 net/wireless/ibss.c                                        |    1 
 net/wireless/mlme.c                                        |    1 
 net/wireless/nl80211.c                                     |    1 
 net/wireless/reg.c                                         |   13 
 net/wireless/scan.c                                        |    1 
 net/wireless/sme.c                                         |    1 
 net/wireless/util.c                                        |    1 
 net/wireless/wext-compat.c                                 |    1 
 net/wireless/wext-core.c                                   |    1 
 net/wireless/wext-priv.c                                   |    1 
 net/wireless/wext-sme.c                                    |    1 
 net/x25/af_x25.c                                           |    1 
 net/x25/x25_dev.c                                          |    1 
 net/x25/x25_forward.c                                      |    1 
 net/x25/x25_in.c                                           |    1 
 net/x25/x25_link.c                                         |    1 
 net/x25/x25_out.c                                          |    1 
 net/x25/x25_route.c                                        |    1 
 net/x25/x25_subr.c                                         |    1 
 net/xfrm/xfrm_ipcomp.c                                     |    2 
 net/xfrm/xfrm_output.c                                     |    1 
 net/xfrm/xfrm_state.c                                      |    1 
 net/xfrm/xfrm_sysctl.c                                     |    1 
 samples/kobject/kset-example.c                             |    1 
 security/device_cgroup.c                                   |    1 
 security/integrity/ima/ima_api.c                           |    1 
 security/integrity/ima/ima_audit.c                         |    1 
 security/integrity/ima/ima_crypto.c                        |    1 
 security/integrity/ima/ima_fs.c                            |    1 
 security/integrity/ima/ima_iint.c                          |    1 
 security/integrity/ima/ima_init.c                          |    1 
 security/integrity/ima/ima_main.c                          |    1 
 security/integrity/ima/ima_policy.c                        |    1 
 security/integrity/ima/ima_queue.c                         |    1 
 security/keys/proc.c                                       |    1 
 security/keys/process_keys.c                               |    1 
 security/lsm_audit.c                                       |    1 
 security/selinux/netif.c                                   |    1 
 security/selinux/netlabel.c                                |    1 
 security/selinux/netlink.c                                 |    1 
 security/selinux/netnode.c                                 |    1 
 security/selinux/netport.c                                 |    1 
 security/selinux/ss/symtab.c                               |    1 
 security/selinux/xfrm.c                                    |    1 
 security/smack/smack_access.c                              |    1 
 security/smack/smack_lsm.c                                 |    1 
 security/smack/smackfs.c                                   |    1 
 security/tomoyo/common.c                                   |    1 
 security/tomoyo/domain.c                                   |    1 
 security/tomoyo/file.c                                     |    1 
 security/tomoyo/gc.c                                       |    1 
 security/tomoyo/realpath.c                                 |    1 
 sound/aoa/codecs/onyx.c                                    |    1 
 sound/aoa/codecs/tas.c                                     |    1 
 sound/aoa/codecs/toonie.c                                  |    1 
 sound/aoa/core/gpio-pmf.c                                  |    1 
 sound/aoa/fabrics/layout.c                                 |    1 
 sound/aoa/soundbus/i2sbus/control.c                        |    1 
 sound/aoa/soundbus/i2sbus/core.c                           |    1 
 sound/aoa/soundbus/i2sbus/pcm.c                            |    1 
 sound/arm/pxa2xx-pcm-lib.c                                 |    1 
 sound/core/control_compat.c                                |    1 
 sound/core/hrtimer.c                                       |    1 
 sound/core/info.c                                          |    1 
 sound/core/jack.c                                          |    1 
 sound/core/misc.c                                          |    1 
 sound/core/oss/route.c                                     |    1 
 sound/core/pcm_compat.c                                    |    1 
 sound/core/pcm_memory.c                                    |    1 
 sound/core/seq/oss/seq_oss_init.c                          |    1 
 sound/core/seq/oss/seq_oss_midi.c                          |    1 
 sound/core/seq/oss/seq_oss_readq.c                         |    1 
 sound/core/seq/oss/seq_oss_synth.c                         |    1 
 sound/core/seq/oss/seq_oss_timer.c                         |    1 
 sound/core/seq/oss/seq_oss_writeq.c                        |    1 
 sound/core/seq/seq_compat.c                                |    1 
 sound/core/seq/seq_system.c                                |    1 
 sound/drivers/ml403-ac97cr.c                               |    1 
 sound/drivers/mtpav.c                                      |    1 
 sound/drivers/mts64.c                                      |    1 
 sound/drivers/opl3/opl3_oss.c                              |    1 
 sound/drivers/opl3/opl3_synth.c                            |    1 
 sound/drivers/opl4/opl4_lib.c                              |    1 
 sound/drivers/pcsp/pcsp_lib.c                              |    1 
 sound/drivers/portman2x4.c                                 |    1 
 sound/drivers/vx/vx_hwdep.c                                |    1 
 sound/i2c/other/ak4113.c                                   |    2 
 sound/i2c/other/tea575x-tuner.c                            |    1 
 sound/isa/cmi8330.c                                        |    1 
 sound/isa/cs423x/cs4236.c                                  |    1 
 sound/isa/es18xx.c                                         |    1 
 sound/isa/gus/interwave.c                                  |    1 
 sound/isa/msnd/msnd_midi.c                                 |    1 
 sound/isa/opl3sa2.c                                        |    1 
 sound/isa/opti9xx/miro.c                                   |    1 
 sound/isa/opti9xx/opti92x-ad1848.c                         |    1 
 sound/isa/sb/emu8000_pcm.c                                 |    1 
 sound/isa/sb/sb16.c                                        |    1 
 sound/isa/sb/sb8.c                                         |    1 
 sound/isa/wavefront/wavefront.c                            |    1 
 sound/isa/wavefront/wavefront_fx.c                         |    1 
 sound/isa/wavefront/wavefront_synth.c                      |    1 
 sound/mips/hal2.c                                          |    1 
 sound/mips/sgio2audio.c                                    |    2 
 sound/oss/ad1848.c                                         |    1 
 sound/oss/dmabuf.c                                         |    1 
 sound/oss/kahlua.c                                         |    1 
 sound/oss/mpu401.c                                         |    1 
 sound/oss/msnd.c                                           |    1 
 sound/oss/msnd_pinnacle.c                                  |    2 
 sound/oss/opl3.c                                           |    1 
 sound/oss/sb_card.c                                        |    1 
 sound/oss/sb_common.c                                      |    1 
 sound/oss/sb_midi.c                                        |    1 
 sound/oss/sb_mixer.c                                       |    2 
 sound/oss/soundcard.c                                      |    1 
 sound/oss/uart401.c                                        |    1 
 sound/oss/v_midi.c                                         |    1 
 sound/oss/vidc.c                                           |    1 
 sound/oss/vwsnd.c                                          |    1 
 sound/oss/waveartist.c                                     |    1 
 sound/pci/ac97/ac97_proc.c                                 |    1 
 sound/pci/als4000.c                                        |    1 
 sound/pci/aw2/aw2-saa7146.c                                |    1 
 sound/pci/ca0106/ca0106_mixer.c                            |    1 
 sound/pci/ca0106/ca0106_proc.c                             |    1 
 sound/pci/cs5530.c                                         |    1 
 sound/pci/cs5535audio/cs5535audio_pcm.c                    |    1 
 sound/pci/cs5535audio/cs5535audio_pm.c                     |    1 
 sound/pci/ctxfi/ctatc.c                                    |    1 
 sound/pci/ctxfi/ctpcm.c                                    |    1 
 sound/pci/echoaudio/darla20.c                              |    2 
 sound/pci/echoaudio/darla24.c                              |    2 
 sound/pci/echoaudio/echo3g.c                               |    2 
 sound/pci/echoaudio/echoaudio.c                            |    5 
 sound/pci/echoaudio/gina20.c                               |    2 
 sound/pci/echoaudio/gina24.c                               |    2 
 sound/pci/echoaudio/indigo.c                               |    2 
 sound/pci/echoaudio/indigodj.c                             |    2 
 sound/pci/echoaudio/indigodjx.c                            |    2 
 sound/pci/echoaudio/indigoio.c                             |    2 
 sound/pci/echoaudio/indigoiox.c                            |    2 
 sound/pci/echoaudio/layla20.c                              |    2 
 sound/pci/echoaudio/layla24.c                              |    2 
 sound/pci/echoaudio/mia.c                                  |    2 
 sound/pci/echoaudio/mona.c                                 |    2 
 sound/pci/emu10k1/memory.c                                 |    1 
 sound/pci/hda/hda_beep.c                                   |    1 
 sound/pci/hda/hda_eld.c                                    |    1 
 sound/pci/hda/hda_intel.c                                  |    1 
 sound/pci/hda/patch_analog.c                               |    8 
 sound/pci/hda/patch_realtek.c                              |  164 
 sound/pci/ice1712/ak4xxx.c                                 |    1 
 sound/pci/ice1712/amp.c                                    |    1 
 sound/pci/ice1712/vt1720_mobo.c                            |    1 
 sound/pci/ice1712/wtm.c                                    |    1 
 sound/pci/lx6464es/lx6464es.c                              |    1 
 sound/pci/mixart/mixart.c                                  |   25 
 sound/pci/mixart/mixart_hwdep.c                            |    1 
 sound/pci/oxygen/oxygen_lib.c                              |    1 
 sound/pci/rme32.c                                          |    2 
 sound/pci/rme96.c                                          |    1 
 sound/pci/rme9652/hdsp.c                                   |    1 
 sound/pci/rme9652/rme9652.c                                |    1 
 sound/pci/sis7019.c                                        |    1 
 sound/pcmcia/pdaudiocf/pdaudiocf_core.c                    |    1 
 sound/pcmcia/pdaudiocf/pdaudiocf_pcm.c                     |    1 
 sound/pcmcia/vx/vxpocket.c                                 |    1 
 sound/ppc/burgundy.c                                       |    1 
 sound/ppc/keywest.c                                        |    1 
 sound/ppc/snd_ps3.c                                        |    2 
 sound/sh/sh_dac_audio.c                                    |    1 
 sound/soc/atmel/atmel-pcm.c                                |    2 
 sound/soc/atmel/atmel_ssc_dai.c                            |    6 
 sound/soc/au1x/psc-ac97.c                                  |    1 
 sound/soc/au1x/psc-i2s.c                                   |    1 
 sound/soc/blackfin/bf5xx-ac97-pcm.c                        |    2 
 sound/soc/blackfin/bf5xx-ac97.c                            |    1 
 sound/soc/blackfin/bf5xx-i2s-pcm.c                         |    2 
 sound/soc/blackfin/bf5xx-tdm-pcm.c                         |    2 
 sound/soc/codecs/ac97.c                                    |   16 
 sound/soc/codecs/ad1836.c                                  |    1 
 sound/soc/codecs/ad1938.c                                  |    1 
 sound/soc/codecs/ad1980.c                                  |    1 
 sound/soc/codecs/ad73311.c                                 |    1 
 sound/soc/codecs/ads117x.c                                 |    1 
 sound/soc/codecs/ak4104.c                                  |    1 
 sound/soc/codecs/ak4535.c                                  |    1 
 sound/soc/codecs/ak4642.c                                  |    1 
 sound/soc/codecs/ak4671.c                                  |    1 
 sound/soc/codecs/cs4270.c                                  |    1 
 sound/soc/codecs/cx20442.c                                 |    1 
 sound/soc/codecs/da7210.c                                  |    1 
 sound/soc/codecs/pcm3008.c                                 |    1 
 sound/soc/codecs/ssm2602.c                                 |    1 
 sound/soc/codecs/stac9766.c                                |    1 
 sound/soc/codecs/tlv320aic23.c                             |    1 
 sound/soc/codecs/tlv320aic26.c                             |    1 
 sound/soc/codecs/tlv320aic3x.c                             |    1 
 sound/soc/codecs/tlv320dac33.c                             |    1 
 sound/soc/codecs/tpa6130a2.c                               |    1 
 sound/soc/codecs/twl4030.c                                 |    1 
 sound/soc/codecs/uda134x.c                                 |    1 
 sound/soc/codecs/wm2000.c                                  |    1 
 sound/soc/codecs/wm8350.c                                  |    1 
 sound/soc/codecs/wm8400.c                                  |    1 
 sound/soc/codecs/wm8510.c                                  |    1 
 sound/soc/codecs/wm8523.c                                  |    1 
 sound/soc/codecs/wm8580.c                                  |    1 
 sound/soc/codecs/wm8711.c                                  |    1 
 sound/soc/codecs/wm8727.c                                  |    1 
 sound/soc/codecs/wm8728.c                                  |    1 
 sound/soc/codecs/wm8731.c                                  |    1 
 sound/soc/codecs/wm8750.c                                  |    1 
 sound/soc/codecs/wm8753.c                                  |    1 
 sound/soc/codecs/wm8776.c                                  |    1 
 sound/soc/codecs/wm8900.c                                  |    1 
 sound/soc/codecs/wm8903.c                                  |    1 
 sound/soc/codecs/wm8904.c                                  |    1 
 sound/soc/codecs/wm8940.c                                  |    1 
 sound/soc/codecs/wm8955.c                                  |    1 
 sound/soc/codecs/wm8960.c                                  |    1 
 sound/soc/codecs/wm8961.c                                  |    1 
 sound/soc/codecs/wm8971.c                                  |    1 
 sound/soc/codecs/wm8974.c                                  |    1 
 sound/soc/codecs/wm8978.c                                  |    1 
 sound/soc/codecs/wm8988.c                                  |    1 
 sound/soc/codecs/wm8990.c                                  |    1 
 sound/soc/codecs/wm8993.c                                  |    1 
 sound/soc/codecs/wm8994.c                                  |   61 
 sound/soc/codecs/wm9081.c                                  |    1 
 sound/soc/codecs/wm9705.c                                  |    1 
 sound/soc/codecs/wm9712.c                                  |    1 
 sound/soc/codecs/wm9713.c                                  |    1 
 sound/soc/codecs/wm_hubs.c                                 |   83 
 sound/soc/codecs/wm_hubs.h                                 |    1 
 sound/soc/davinci/davinci-i2s.c                            |    4 
 sound/soc/davinci/davinci-mcasp.c                          |    4 
 sound/soc/davinci/davinci-pcm.c                            |    4 
 sound/soc/fsl/fsl_dma.c                                    |    1 
 sound/soc/fsl/fsl_ssi.c                                    |    1 
 sound/soc/fsl/mpc5200_dma.c                                |    1 
 sound/soc/fsl/mpc8610_hpcd.c                               |    1 
 sound/soc/fsl/soc-of-simple.c                              |    1 
 sound/soc/imx/imx-pcm-dma-mx2.c                            |    9 
 sound/soc/imx/imx-pcm-fiq.c                                |    1 
 sound/soc/imx/imx-ssi.c                                    |    8 
 sound/soc/omap/mcpdm.c                                     |    1 
 sound/soc/omap/omap-mcbsp.c                                |    4 
 sound/soc/omap/omap-mcpdm.c                                |    3 
 sound/soc/omap/omap-pcm.c                                  |   22 
 sound/soc/pxa/pxa-ssp.c                                    |   24 
 sound/soc/pxa/pxa2xx-ac97.c                                |   17 
 sound/soc/pxa/pxa2xx-i2s.c                                 |    7 
 sound/soc/pxa/pxa2xx-pcm.c                                 |    4 
 sound/soc/s3c24xx/s3c-ac97.c                               |   21 
 sound/soc/s3c24xx/s3c-dma.c                                |    4 
 sound/soc/s3c24xx/s3c-i2s-v2.c                             |   13 
 sound/soc/s3c24xx/s3c-pcm.c                                |    7 
 sound/soc/s3c24xx/s3c24xx-i2s.c                            |   19 
 sound/soc/s6000/s6000-i2s.c                                |    4 
 sound/soc/s6000/s6000-pcm.c                                |   40 
 sound/soc/sh/dma-sh7760.c                                  |    1 
 sound/soc/sh/fsi.c                                         |    1 
 sound/soc/sh/siu_dai.c                                     |    1 
 sound/soc/sh/siu_pcm.c                                     |    1 
 sound/soc/soc-core.c                                       |    4 
 sound/soc/soc-dapm.c                                       |    1 
 sound/soc/txx9/txx9aclc-ac97.c                             |    1 
 sound/soc/txx9/txx9aclc.c                                  |    1 
 sound/sound_firmware.c                                     |    1 
 sound/sparc/cs4231.c                                       |    1 
 sound/sparc/dbri.c                                         |    1 
 sound/synth/emux/emux_proc.c                               |    1 
 sound/usb/caiaq/audio.c                                    |    1 
 sound/usb/caiaq/device.c                                   |    1 
 sound/usb/caiaq/midi.c                                     |    1 
 sound/usb/usx2y/us122l.c                                   |    1 
 sound/usb/usx2y/usX2Yhwdep.c                               |    1 
 sound/usb/usx2y/usb_stream.c                               |    1 
 sound/usb/usx2y/usbusx2y.c                                 |    1 
 sound/usb/usx2y/usbusx2yaudio.c                            |    1 
 sound/usb/usx2y/usx2yhwdeppcm.c                            |    1 
 tools/perf/Makefile                                        |   10 
 tools/perf/util/scripting-engines/trace-event-python.c     |   17 
 virt/kvm/assigned-dev.c                                    |    1 
 virt/kvm/coalesced_mmio.c                                  |    1 
 virt/kvm/eventfd.c                                         |    1 
 virt/kvm/ioapic.c                                          |    1 
 virt/kvm/irq_comm.c                                        |    1 
 virt/kvm/kvm_main.c                                        |    2 
 4590 files changed, 26806 insertions(+), 5789 deletions(-)

diff -urN linux-2.6.34-rc3/Documentation/DocBook/tracepoint.tmpl linux-2.6.34-rc4/Documentation/DocBook/tracepoint.tmpl
--- linux-2.6.34-rc3/Documentation/DocBook/tracepoint.tmpl	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/DocBook/tracepoint.tmpl	2010-04-13 02:19:00.111633078 +0000
@@ -16,6 +16,15 @@
      </address>
     </affiliation>
    </author>
+   <author>
+    <firstname>William</firstname>
+    <surname>Cohen</surname>
+    <affiliation>
+     <address>
+      <email>wcohen@redhat.com</email>
+     </address>
+    </affiliation>
+   </author>
   </authorgroup>
 
   <legalnotice>
@@ -91,4 +100,8 @@
 !Iinclude/trace/events/signal.h
   </chapter>
 
+  <chapter id="block">
+   <title>Block IO</title>
+!Iinclude/trace/events/block.h
+  </chapter>
 </book>
diff -urN linux-2.6.34-rc3/Documentation/block/biodoc.txt linux-2.6.34-rc4/Documentation/block/biodoc.txt
--- linux-2.6.34-rc3/Documentation/block/biodoc.txt	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/block/biodoc.txt	2010-04-13 02:19:00.117633115 +0000
@@ -1162,8 +1162,8 @@
 
 As mentioned, there is no virtual mapping of a bio. For DMA, this is
 not a problem as the driver probably never will need a virtual mapping.
-Instead it needs a bus mapping (pci_map_page for a single segment or
-use blk_rq_map_sg for scatter gather) to be able to ship it to the driver. For
+Instead it needs a bus mapping (dma_map_page for a single segment or
+use dma_map_sg for scatter gather) to be able to ship it to the driver. For
 PIO drivers (or drivers that need to revert to PIO transfer once in a
 while (IDE for example)), where the CPU is doing the actual data
 transfer a virtual mapping is needed. If the driver supports highmem I/O,
diff -urN linux-2.6.34-rc3/Documentation/connector/cn_test.c linux-2.6.34-rc4/Documentation/connector/cn_test.c
--- linux-2.6.34-rc3/Documentation/connector/cn_test.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/connector/cn_test.c	2010-04-13 02:19:00.120633126 +0000
@@ -25,6 +25,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 
 #include <linux/connector.h>
diff -urN linux-2.6.34-rc3/Documentation/fb/efifb.txt linux-2.6.34-rc4/Documentation/fb/efifb.txt
--- linux-2.6.34-rc3/Documentation/fb/efifb.txt	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/fb/efifb.txt	2010-04-13 02:19:00.121633114 +0000
@@ -0,0 +1,31 @@
+
+What is efifb?
+===============
+
+This is a generic EFI platform driver for Intel based Apple computers.
+efifb is only for EFI booted Intel Macs.
+
+Supported Hardware
+==================
+
+iMac 17"/20"
+Macbook
+Macbook Pro 15"/17"
+MacMini
+
+How to use it?
+==============
+
+efifb does not have any kind of autodetection of your machine.
+You have to add the following kernel parameters in your elilo.conf:
+	Macbook :
+		video=efifb:macbook
+	MacMini :
+		video=efifb:mini
+	Macbook Pro 15", iMac 17" :
+		video=efifb:i17
+	Macbook Pro 17", iMac 20" :
+		video=efifb:i20
+
+--
+Edgar Hucek <gimli@dark-green.com>
diff -urN linux-2.6.34-rc3/Documentation/fb/imacfb.txt linux-2.6.34-rc4/Documentation/fb/imacfb.txt
--- linux-2.6.34-rc3/Documentation/fb/imacfb.txt	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/fb/imacfb.txt	1970-01-01 00:00:00.000000000 +0000
@@ -1,31 +0,0 @@
-
-What is imacfb?
-===============
-
-This is a generic EFI platform driver for Intel based Apple computers.
-Imacfb is only for EFI booted Intel Macs.
-
-Supported Hardware
-==================
-
-iMac 17"/20"
-Macbook
-Macbook Pro 15"/17"
-MacMini
-
-How to use it?
-==============
-
-Imacfb does not have any kind of autodetection of your machine.
-You have to add the following kernel parameters in your elilo.conf:
-	Macbook :
-		video=imacfb:macbook
-	MacMini :
-		video=imacfb:mini
-	Macbook Pro 15", iMac 17" :
-		video=imacfb:i17
-	Macbook Pro 17", iMac 20" :
-		video=imacfb:i20
-
---
-Edgar Hucek <gimli@dark-green.com>
diff -urN linux-2.6.34-rc3/Documentation/filesystems/9p.txt linux-2.6.34-rc4/Documentation/filesystems/9p.txt
--- linux-2.6.34-rc3/Documentation/filesystems/9p.txt	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/filesystems/9p.txt	2010-04-13 02:19:00.122633102 +0000
@@ -37,6 +37,15 @@
 
 	mount -t 9p `namespace`/acme /mnt/9 -o trans=unix,uname=$USER
 
+For server running on QEMU host with virtio transport:
+
+	mount -t 9p -o trans=virtio <mount_tag> /mnt/9
+
+where mount_tag is the tag associated by the server to each of the exported
+mount points. Each 9P export is seen by the client as a virtio device with an
+associated "mount_tag" property. Available mount tags can be
+seen by reading /sys/bus/virtio/drivers/9pnet_virtio/virtio<n>/mount_tag files.
+
 OPTIONS
 =======
 
@@ -47,7 +56,7 @@
 			fd   	- used passed file descriptors for connection
                                 (see rfdno and wfdno)
 			virtio	- connect to the next virtio channel available
-				(from lguest or KVM with trans_virtio module)
+				(from QEMU with trans_virtio module)
 			rdma	- connect to a specified RDMA channel
 
   uname=name	user name to attempt mount as on the remote server.  The
@@ -85,7 +94,12 @@
 
   port=n	port to connect to on the remote server
 
-  noextend	force legacy mode (no 9p2000.u semantics)
+  noextend	force legacy mode (no 9p2000.u or 9p2000.L semantics)
+
+  version=name	Select 9P protocol version. Valid options are:
+			9p2000          - Legacy mode (same as noextend)
+			9p2000.u        - Use 9P2000.u protocol
+			9p2000.L        - Use 9P2000.L protocol
 
   dfltuid	attempt to mount as a particular uid
 
diff -urN linux-2.6.34-rc3/Documentation/networking/stmmac.txt linux-2.6.34-rc4/Documentation/networking/stmmac.txt
--- linux-2.6.34-rc3/Documentation/networking/stmmac.txt	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/networking/stmmac.txt	2010-04-13 02:19:00.133633045 +0000
@@ -0,0 +1,143 @@
+       STMicroelectronics 10/100/1000 Synopsys Ethernet driver
+
+Copyright (C) 2007-2010  STMicroelectronics Ltd
+Author: Giuseppe Cavallaro <peppe.cavallaro@st.com>
+
+This is the driver for the MAC 10/100/1000 on-chip Ethernet controllers
+(Synopsys IP blocks); it has been fully tested on STLinux platforms.
+
+Currently this network device driver is for all STM embedded MAC/GMAC
+(7xxx SoCs).
+
+DWC Ether MAC 10/100/1000 Universal version 3.41a and DWC Ether MAC 10/100
+Universal version 4.0 have been used for developing the first code
+implementation.
+
+Please, for more information also visit: www.stlinux.com
+
+1) Kernel Configuration
+The kernel configuration option is STMMAC_ETH:
+ Device Drivers ---> Network device support ---> Ethernet (1000 Mbit) --->
+ STMicroelectronics 10/100/1000 Ethernet driver (STMMAC_ETH)
+
+2) Driver parameters list:
+	debug: message level (0: no output, 16: all);
+	phyaddr: to manually provide the physical address to the PHY device;
+	dma_rxsize: DMA rx ring size;
+	dma_txsize: DMA tx ring size;
+	buf_sz: DMA buffer size;
+	tc: control the HW FIFO threshold;
+	tx_coe: Enable/Disable Tx Checksum Offload engine;
+	watchdog: transmit timeout (in milliseconds);
+	flow_ctrl: Flow control ability [on/off];
+	pause: Flow Control Pause Time;
+	tmrate: timer period (only if timer optimisation is configured).
+
+3) Command line options
+Driver parameters can be also passed in command line by using:
+	stmmaceth=dma_rxsize:128,dma_txsize:512
+
+4) Driver information and notes
+
+4.1) Transmit process
+The xmit method is invoked when the kernel needs to transmit a packet; it sets
+the descriptors in the ring and informs the DMA engine that there is a packet
+ready to be transmitted.
+Once the controller has finished transmitting the packet, an interrupt is
+triggered; So the driver will be able to release the socket buffers.
+By default, the driver sets the NETIF_F_SG bit in the features field of the
+net_device structure enabling the scatter/gather feature.
+
+4.2) Receive process
+When one or more packets are received, an interrupt happens. The interrupts
+are not queued so the driver has to scan all the descriptors in the ring during
+the receive process.
+This is based on NAPI so the interrupt handler signals only if there is work to be
+done, and it exits.
+Then the poll method will be scheduled at some future point.
+The incoming packets are stored, by the DMA, in a list of pre-allocated socket
+buffers in order to avoid the memcpy (Zero-copy).
+
+4.3) Timer-Driver Interrupt
+Instead of having the device that asynchronously notifies the frame receptions, the
+driver configures a timer to generate an interrupt at regular intervals.
+Based on the granularity of the timer, the frames that are received by the device
+will experience different levels of latency. Some NICs have dedicated timer
+device to perform this task. STMMAC can use either the RTC device or the TMU
+channel 2  on STLinux platforms.
+The timers frequency can be passed to the driver as parameter; when change it,
+take care of both hardware capability and network stability/performance impact.
+Several performance tests on STM platforms showed this optimisation allows to spare
+the CPU while having the maximum throughput.
+
+4.4) WOL
+Wake up on Lan feature through Magic Frame is only supported for the GMAC
+core.
+
+4.5) DMA descriptors
+Driver handles both normal and enhanced descriptors. The latter has been only
+tested on DWC Ether MAC 10/100/1000 Universal version 3.41a.
+
+4.6) Ethtool support
+Ethtool is supported. Driver statistics and internal errors can be taken using:
+ethtool -S ethX command. It is possible to dump registers etc.
+
+4.7) Jumbo and Segmentation Offloading
+Jumbo frames are supported and tested for the GMAC.
+The GSO has been also added but it's performed in software.
+LRO is not supported.
+
+4.8) Physical
+The driver is compatible with PAL to work with PHY and GPHY devices.
+
+4.9) Platform information
+Several information came from the platform; please refer to the
+driver's Header file in include/linux directory.
+
+struct plat_stmmacenet_data {
+        int bus_id;
+        int pbl;
+        int has_gmac;
+        void (*fix_mac_speed)(void *priv, unsigned int speed);
+        void (*bus_setup)(unsigned long ioaddr);
+#ifdef CONFIG_STM_DRIVERS
+        struct stm_pad_config *pad_config;
+#endif
+        void *bsp_priv;
+};
+
+Where:
+- pbl (Programmable Burst Length) is maximum number of
+  beats to be transferred in one DMA transaction.
+  GMAC also enables the 4xPBL by default.
+- fix_mac_speed and bus_setup are used to configure internal target
+  registers (on STM platforms);
+- has_gmac: GMAC core is on board (get it at run-time in the next step);
+- bus_id: bus identifier.
+
+struct plat_stmmacphy_data {
+        int bus_id;
+        int phy_addr;
+        unsigned int phy_mask;
+        int interface;
+        int (*phy_reset)(void *priv);
+        void *priv;
+};
+
+Where:
+- bus_id: bus identifier;
+- phy_addr: physical address used for the attached phy device;
+            set it to -1 to get it at run-time;
+- interface: physical MII interface mode;
+- phy_reset: hook to reset HW function.
+
+TODO:
+- Continue to make the driver more generic and suitable for other Synopsys
+  Ethernet controllers used on other architectures (i.e. ARM).
+- 10G controllers are not supported.
+- MAC uses Normal descriptors and GMAC uses enhanced ones.
+  This is a limit that should be reviewed. MAC could want to
+  use the enhanced structure.
+- Checksumming: Rx/Tx csum is done in HW in case of GMAC only.
+- Review the timer optimisation code to use an embedded device that seems to be
+  available in new chip generations.
diff -urN linux-2.6.34-rc3/Documentation/powerpc/dts-bindings/fsl/cpm_qe/qe.txt linux-2.6.34-rc4/Documentation/powerpc/dts-bindings/fsl/cpm_qe/qe.txt
--- linux-2.6.34-rc3/Documentation/powerpc/dts-bindings/fsl/cpm_qe/qe.txt	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/powerpc/dts-bindings/fsl/cpm_qe/qe.txt	2010-04-13 02:19:00.134633021 +0000
@@ -21,6 +21,15 @@
 - fsl,qe-num-snums: define how many serial number(SNUM) the QE can use for the
   threads.
 
+Optional properties:
+- fsl,firmware-phandle:
+    Usage: required only if there is no fsl,qe-firmware child node
+    Value type: <phandle>
+    Definition: Points to a firmware node (see "QE Firmware Node" below)
+        that contains the firmware that should be uploaded for this QE.
+        The compatible property for the firmware node should say,
+        "fsl,qe-firmware".
+
 Recommended properties
 - brg-frequency : the internal clock source frequency for baud-rate
   generators in Hz.
@@ -59,3 +68,48 @@
 		reg = <0 c000>;
 	};
      };
+
+* QE Firmware Node
+
+This node defines a firmware binary that is embedded in the device tree, for
+the purpose of passing the firmware from bootloader to the kernel, or from
+the hypervisor to the guest.
+
+The firmware node itself contains the firmware binary contents, a compatible
+property, and any firmware-specific properties.  The node should be placed
+inside a QE node that needs it.  Doing so eliminates the need for a
+fsl,firmware-phandle property.  Other QE nodes that need the same firmware
+should define an fsl,firmware-phandle property that points to the firmware node
+in the first QE node.
+
+The fsl,firmware property can be specified in the DTS (possibly using incbin)
+or can be inserted by the boot loader at boot time.
+
+Required properties:
+  - compatible
+      Usage: required
+      Value type: <string>
+      Definition: A standard property.  Specify a string that indicates what
+          kind of firmware it is.  For QE, this should be "fsl,qe-firmware".
+
+   - fsl,firmware
+      Usage: required
+      Value type: <prop-encoded-array>, encoded as an array of bytes
+      Definition: A standard property.  This property contains the firmware
+          binary "blob".
+
+Example:
+	qe1@e0080000 {
+		compatible = "fsl,qe";
+		qe_firmware:qe-firmware {
+			compatible = "fsl,qe-firmware";
+			fsl,firmware = [0x70 0xcd 0x00 0x00 0x01 0x46 0x45 ...];
+		};
+		...
+	};
+
+	qe2@e0090000 {
+		compatible = "fsl,qe";
+		fsl,firmware-phandle = <&qe_firmware>;
+		...
+	};
diff -urN linux-2.6.34-rc3/Documentation/sound/alsa/HD-Audio.txt linux-2.6.34-rc4/Documentation/sound/alsa/HD-Audio.txt
--- linux-2.6.34-rc3/Documentation/sound/alsa/HD-Audio.txt	2010-04-13 02:18:55.059572028 +0000
+++ linux-2.6.34-rc4/Documentation/sound/alsa/HD-Audio.txt	2010-04-13 02:19:00.137633032 +0000
@@ -119,10 +119,18 @@
 
 Interrupt Handling
 ~~~~~~~~~~~~~~~~~~
-In rare but some cases, the interrupt isn't properly handled as
-default.  You would notice this by the DMA transfer error reported by
-ALSA PCM core, for example.  Using MSI might help in such a case.
-Pass `enable_msi=1` option for enabling MSI.
+HD-audio driver uses MSI as default (if available) since 2.6.33
+kernel as MSI works better on some machines, and in general, it's
+better for performance.  However, Nvidia controllers showed bad
+regressions with MSI (especially in a combination with AMD chipset),
+thus we disabled MSI for them.
+
+There seem also still other devices that don't work with MSI.  If you
+see a regression wrt the sound quality (stuttering, etc) or a lock-up
+in the recent kernel, try to pass `enable_msi=0` option to disable
+MSI.  If it works, you can add the known bad device to the blacklist
+defined in hda_intel.c.  In such a case, please report and give the
+patch back to the upstream developer. 
 
 
 HD-AUDIO CODEC
diff -urN linux-2.6.34-rc3/Documentation/watchdog/src/watchdog-simple.c linux-2.6.34-rc4/Documentation/watchdog/src/watchdog-simple.c
--- linux-2.6.34-rc3/Documentation/watchdog/src/watchdog-simple.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/watchdog/src/watchdog-simple.c	2010-04-13 02:19:00.142633043 +0000
@@ -17,9 +17,6 @@
 			ret = -1;
 			break;
 		}
-		ret = fsync(fd);
-		if (ret)
-			break;
 		sleep(10);
 	}
 	close(fd);
diff -urN linux-2.6.34-rc3/Documentation/watchdog/src/watchdog-test.c linux-2.6.34-rc4/Documentation/watchdog/src/watchdog-test.c
--- linux-2.6.34-rc3/Documentation/watchdog/src/watchdog-test.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/watchdog/src/watchdog-test.c	2010-04-13 02:19:00.142633043 +0000
@@ -31,6 +31,8 @@
  */
 int main(int argc, char *argv[])
 {
+    int flags;
+
     fd = open("/dev/watchdog", O_WRONLY);
 
     if (fd == -1) {
@@ -41,12 +43,14 @@
 
     if (argc > 1) {
 	if (!strncasecmp(argv[1], "-d", 2)) {
-	    ioctl(fd, WDIOC_SETOPTIONS, WDIOS_DISABLECARD);
+	    flags = WDIOS_DISABLECARD;
+	    ioctl(fd, WDIOC_SETOPTIONS, &flags);
 	    fprintf(stderr, "Watchdog card disabled.\n");
 	    fflush(stderr);
 	    exit(0);
 	} else if (!strncasecmp(argv[1], "-e", 2)) {
-	    ioctl(fd, WDIOC_SETOPTIONS, WDIOS_ENABLECARD);
+	    flags = WDIOS_ENABLECARD;
+	    ioctl(fd, WDIOC_SETOPTIONS, &flags);
 	    fprintf(stderr, "Watchdog card enabled.\n");
 	    fflush(stderr);
 	    exit(0);
diff -urN linux-2.6.34-rc3/Documentation/watchdog/watchdog-api.txt linux-2.6.34-rc4/Documentation/watchdog/watchdog-api.txt
--- linux-2.6.34-rc3/Documentation/watchdog/watchdog-api.txt	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/Documentation/watchdog/watchdog-api.txt	2010-04-13 02:19:00.142633043 +0000
@@ -222,11 +222,10 @@
     ioctl(fd, WDIOC_GETTEMP, &temperature);
 
 Finally the SETOPTIONS ioctl can be used to control some aspects of
-the cards operation; right now the pcwd driver is the only one
-supporting this ioctl.
+the cards operation.
 
     int options = 0;
-    ioctl(fd, WDIOC_SETOPTIONS, options);
+    ioctl(fd, WDIOC_SETOPTIONS, &options);
 
 The following options are available:
 
diff -urN linux-2.6.34-rc3/MAINTAINERS linux-2.6.34-rc4/MAINTAINERS
--- linux-2.6.34-rc3/MAINTAINERS	2010-04-13 02:18:55.066633037 +0000
+++ linux-2.6.34-rc4/MAINTAINERS	2010-04-13 02:19:00.144633072 +0000
@@ -971,6 +971,16 @@
 W:	http://www.mcuos.com
 S:	Maintained
 
+ARM/U300 MACHINE SUPPORT
+M:	Linus Walleij <linus.walleij@stericsson.com>
+L:	linux-arm-kernel@lists.infradead.org (moderated for non-subscribers)
+S:	Supported
+F:	arch/arm/mach-u300/
+F:	drivers/i2c/busses/i2c-stu300.c
+F:	drivers/rtc/rtc-coh901331.c
+F:	drivers/watchdog/coh901327_wdt.c
+F:	drivers/dma/coh901318*
+
 ARM/U8500 ARM ARCHITECTURE
 M:	Srinidhi Kasagar <srinidhi.kasagar@stericsson.com>
 L:	linux-arm-kernel@lists.infradead.org (moderated for non-subscribers)
@@ -2474,12 +2484,6 @@
 S:	Odd Fixes
 F:	drivers/char/hvc_*
 
-VIRTIO CONSOLE DRIVER
-M:	Amit Shah <amit.shah@redhat.com>
-L:	virtualization@lists.linux-foundation.org
-S:	Maintained
-F:	drivers/char/virtio_console.c
-
 iSCSI BOOT FIRMWARE TABLE (iBFT) DRIVER
 M:	Peter Jones <pjones@redhat.com>
 M:	Konrad Rzeszutek Wilk <konrad@kernel.org>
@@ -5971,6 +5975,13 @@
 F:	Documentation/filesystems/vfat.txt
 F:	fs/fat/
 
+VIRTIO CONSOLE DRIVER
+M:	Amit Shah <amit.shah@redhat.com>
+L:	virtualization@lists.linux-foundation.org
+S:	Maintained
+F:	drivers/char/virtio_console.c
+F:	include/linux/virtio_console.h
+
 VIRTIO HOST (VHOST)
 M:	"Michael S. Tsirkin" <mst@redhat.com>
 L:	kvm@vger.kernel.org
diff -urN linux-2.6.34-rc3/Makefile linux-2.6.34-rc4/Makefile
--- linux-2.6.34-rc3/Makefile	2010-04-13 02:18:55.066633037 +0000
+++ linux-2.6.34-rc4/Makefile	2010-04-13 02:19:00.145571606 +0000
@@ -1,7 +1,7 @@
 VERSION = 2
 PATCHLEVEL = 6
 SUBLEVEL = 34
-EXTRAVERSION = -rc3
+EXTRAVERSION = -rc4
 NAME = Man-Eating Seals of Antiquity
 
 # *DOCUMENTATION*
diff -urN linux-2.6.34-rc3/arch/alpha/boot/bootp.c linux-2.6.34-rc4/arch/alpha/boot/bootp.c
--- linux-2.6.34-rc3/arch/alpha/boot/bootp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/boot/bootp.c	2010-04-13 02:19:00.145571606 +0000
@@ -8,6 +8,7 @@
  * based significantly on the arch/alpha/boot/main.c of Linus Torvalds
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <generated/utsrelease.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/alpha/boot/bootpz.c linux-2.6.34-rc4/arch/alpha/boot/bootpz.c
--- linux-2.6.34-rc3/arch/alpha/boot/bootpz.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/boot/bootpz.c	2010-04-13 02:19:00.145571606 +0000
@@ -10,6 +10,7 @@
  * and the decompression code from MILO.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <generated/utsrelease.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/alpha/boot/main.c linux-2.6.34-rc4/arch/alpha/boot/main.c
--- linux-2.6.34-rc3/arch/alpha/boot/main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/boot/main.c	2010-04-13 02:19:00.146570613 +0000
@@ -6,6 +6,7 @@
  * This file is the bootloader for the Linux/AXP kernel
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <generated/utsrelease.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/alpha/boot/misc.c linux-2.6.34-rc4/arch/alpha/boot/misc.c
--- linux-2.6.34-rc3/arch/alpha/boot/misc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/boot/misc.c	2010-04-13 02:19:00.146570613 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/irq.c linux-2.6.34-rc4/arch/alpha/kernel/irq.c
--- linux-2.6.34-rc3/arch/alpha/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/irq.c	2010-04-13 02:19:00.147633035 +0000
@@ -18,7 +18,6 @@
 #include <linux/sched.h>
 #include <linux/ptrace.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/init.h>
 #include <linux/irq.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/osf_sys.c linux-2.6.34-rc4/arch/alpha/kernel/osf_sys.c
--- linux-2.6.34-rc3/arch/alpha/kernel/osf_sys.c	2010-04-13 02:18:55.068633072 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/osf_sys.c	2010-04-13 02:19:00.147633035 +0000
@@ -20,7 +20,6 @@
 #include <linux/syscalls.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/utsname.h>
 #include <linux/time.h>
@@ -37,6 +36,7 @@
 #include <linux/uio.h>
 #include <linux/vfs.h>
 #include <linux/rcupdate.h>
+#include <linux/slab.h>
 
 #include <asm/fpu.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/pci-noop.c linux-2.6.34-rc4/arch/alpha/kernel/pci-noop.c
--- linux-2.6.34-rc3/arch/alpha/kernel/pci-noop.c	2010-04-13 02:18:55.069571642 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/pci-noop.c	2010-04-13 02:19:00.148633038 +0000
@@ -7,6 +7,7 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 #include <linux/capability.h>
 #include <linux/mm.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/pci-sysfs.c linux-2.6.34-rc4/arch/alpha/kernel/pci-sysfs.c
--- linux-2.6.34-rc3/arch/alpha/kernel/pci-sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/pci-sysfs.c	2010-04-13 02:19:00.148633038 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 
 static int hose_mmap_page_range(struct pci_controller *hose,
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/pci_iommu.c linux-2.6.34-rc4/arch/alpha/kernel/pci_iommu.c
--- linux-2.6.34-rc3/arch/alpha/kernel/pci_iommu.c	2010-04-13 02:18:55.069571642 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/pci_iommu.c	2010-04-13 02:19:00.148633038 +0000
@@ -5,7 +5,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/bootmem.h>
 #include <linux/scatterlist.h>
 #include <linux/log2.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/process.c linux-2.6.34-rc4/arch/alpha/kernel/process.c
--- linux-2.6.34-rc3/arch/alpha/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/process.c	2010-04-13 02:19:00.149633032 +0000
@@ -17,7 +17,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/time.h>
 #include <linux/major.h>
@@ -28,6 +27,7 @@
 #include <linux/reboot.h>
 #include <linux/tty.h>
 #include <linux/console.h>
+#include <linux/slab.h>
 
 #include <asm/reg.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/ptrace.c linux-2.6.34-rc4/arch/alpha/kernel/ptrace.c
--- linux-2.6.34-rc3/arch/alpha/kernel/ptrace.c	2010-04-13 02:18:55.069571642 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/ptrace.c	2010-04-13 02:19:00.149633032 +0000
@@ -11,7 +11,6 @@
 #include <linux/errno.h>
 #include <linux/ptrace.h>
 #include <linux/user.h>
-#include <linux/slab.h>
 #include <linux/security.h>
 #include <linux/signal.h>
 
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/smc37c669.c linux-2.6.34-rc4/arch/alpha/kernel/smc37c669.c
--- linux-2.6.34-rc3/arch/alpha/kernel/smc37c669.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/smc37c669.c	2010-04-13 02:19:00.149633032 +0000
@@ -3,7 +3,6 @@
  */
 #include <linux/kernel.h>
 
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/smc37c93x.c linux-2.6.34-rc4/arch/alpha/kernel/smc37c93x.c
--- linux-2.6.34-rc3/arch/alpha/kernel/smc37c93x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/smc37c93x.c	2010-04-13 02:19:00.149633032 +0000
@@ -4,7 +4,6 @@
 
 #include <linux/kernel.h>
 
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/arch/alpha/kernel/srm_env.c linux-2.6.34-rc4/arch/alpha/kernel/srm_env.c
--- linux-2.6.34-rc3/arch/alpha/kernel/srm_env.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/kernel/srm_env.c	2010-04-13 02:19:00.150633050 +0000
@@ -30,6 +30,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/arch/alpha/mm/init.c linux-2.6.34-rc4/arch/alpha/mm/init.c
--- linux-2.6.34-rc3/arch/alpha/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/alpha/mm/init.c	2010-04-13 02:19:00.150633050 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/bootmem.h> /* max_low_pfn */
 #include <linux/vmalloc.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/arm/boot/compressed/head.S linux-2.6.34-rc4/arch/arm/boot/compressed/head.S
--- linux-2.6.34-rc3/arch/arm/boot/compressed/head.S	2010-04-13 02:18:55.072633047 +0000
+++ linux-2.6.34-rc4/arch/arm/boot/compressed/head.S	2010-04-13 02:19:00.152633049 +0000
@@ -172,7 +172,7 @@
 		adr	r0, LC0
  ARM(		ldmia	r0, {r1, r2, r3, r4, r5, r6, r11, ip, sp})
  THUMB(		ldmia	r0, {r1, r2, r3, r4, r5, r6, r11, ip}	)
- THUMB(		ldr	sp, [r0, #28]				)
+ THUMB(		ldr	sp, [r0, #32]				)
 		subs	r0, r0, r1		@ calculate the delta offset
 
 						@ if delta is zero, we are
diff -urN linux-2.6.34-rc3/arch/arm/common/clkdev.c linux-2.6.34-rc4/arch/arm/common/clkdev.c
--- linux-2.6.34-rc3/arch/arm/common/clkdev.c	2010-04-13 02:18:55.072633047 +0000
+++ linux-2.6.34-rc4/arch/arm/common/clkdev.c	2010-04-13 02:19:00.152633049 +0000
@@ -18,6 +18,7 @@
 #include <linux/string.h>
 #include <linux/mutex.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <asm/clkdev.h>
 #include <mach/clkdev.h>
diff -urN linux-2.6.34-rc3/arch/arm/common/it8152.c linux-2.6.34-rc4/arch/arm/common/it8152.c
--- linux-2.6.34-rc3/arch/arm/common/it8152.c	2010-04-13 02:18:55.073633041 +0000
+++ linux-2.6.34-rc4/arch/arm/common/it8152.c	2010-04-13 02:19:00.153633079 +0000
@@ -21,7 +21,6 @@
 #include <linux/ptrace.h>
 #include <linux/interrupt.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/irq.h>
diff -urN linux-2.6.34-rc3/arch/arm/include/asm/cacheflush.h linux-2.6.34-rc4/arch/arm/include/asm/cacheflush.h
--- linux-2.6.34-rc3/arch/arm/include/asm/cacheflush.h	2010-04-13 02:18:55.099571748 +0000
+++ linux-2.6.34-rc4/arch/arm/include/asm/cacheflush.h	2010-04-13 02:19:00.179633076 +0000
@@ -15,6 +15,7 @@
 #include <asm/glue.h>
 #include <asm/shmparam.h>
 #include <asm/cachetype.h>
+#include <asm/outercache.h>
 
 #define CACHE_COLOUR(vaddr)	((vaddr & (SHMLBA - 1)) >> PAGE_SHIFT)
 
@@ -219,12 +220,6 @@
 	void (*dma_flush_range)(const void *, const void *);
 };
 
-struct outer_cache_fns {
-	void (*inv_range)(unsigned long, unsigned long);
-	void (*clean_range)(unsigned long, unsigned long);
-	void (*flush_range)(unsigned long, unsigned long);
-};
-
 /*
  * Select the calling method
  */
@@ -281,37 +276,6 @@
 
 #endif
 
-#ifdef CONFIG_OUTER_CACHE
-
-extern struct outer_cache_fns outer_cache;
-
-static inline void outer_inv_range(unsigned long start, unsigned long end)
-{
-	if (outer_cache.inv_range)
-		outer_cache.inv_range(start, end);
-}
-static inline void outer_clean_range(unsigned long start, unsigned long end)
-{
-	if (outer_cache.clean_range)
-		outer_cache.clean_range(start, end);
-}
-static inline void outer_flush_range(unsigned long start, unsigned long end)
-{
-	if (outer_cache.flush_range)
-		outer_cache.flush_range(start, end);
-}
-
-#else
-
-static inline void outer_inv_range(unsigned long start, unsigned long end)
-{ }
-static inline void outer_clean_range(unsigned long start, unsigned long end)
-{ }
-static inline void outer_flush_range(unsigned long start, unsigned long end)
-{ }
-
-#endif
-
 /*
  * Copy user data from/to a page which is mapped into a different
  * processes address space.  Really, we want to allow our "user
diff -urN linux-2.6.34-rc3/arch/arm/include/asm/clkdev.h linux-2.6.34-rc4/arch/arm/include/asm/clkdev.h
--- linux-2.6.34-rc3/arch/arm/include/asm/clkdev.h	2010-04-13 02:18:55.099571748 +0000
+++ linux-2.6.34-rc4/arch/arm/include/asm/clkdev.h	2010-04-13 02:19:00.179633076 +0000
@@ -13,6 +13,7 @@
 #define __ASM_CLKDEV_H
 
 struct clk;
+struct device;
 
 struct clk_lookup {
 	struct list_head	node;
diff -urN linux-2.6.34-rc3/arch/arm/include/asm/irq.h linux-2.6.34-rc4/arch/arm/include/asm/irq.h
--- linux-2.6.34-rc3/arch/arm/include/asm/irq.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/include/asm/irq.h	2010-04-13 02:19:00.181633071 +0000
@@ -17,6 +17,7 @@
 
 #ifndef __ASSEMBLY__
 struct irqaction;
+struct pt_regs;
 extern void migrate_irqs(void);
 
 extern void asm_do_IRQ(unsigned int, struct pt_regs *);
diff -urN linux-2.6.34-rc3/arch/arm/include/asm/outercache.h linux-2.6.34-rc4/arch/arm/include/asm/outercache.h
--- linux-2.6.34-rc3/arch/arm/include/asm/outercache.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/include/asm/outercache.h	2010-04-13 02:19:00.181633071 +0000
@@ -0,0 +1,75 @@
+/*
+ * arch/arm/include/asm/outercache.h
+ *
+ * Copyright (C) 2010 ARM Ltd.
+ * Written by Catalin Marinas <catalin.marinas@arm.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+ */
+
+#ifndef __ASM_OUTERCACHE_H
+#define __ASM_OUTERCACHE_H
+
+struct outer_cache_fns {
+	void (*inv_range)(unsigned long, unsigned long);
+	void (*clean_range)(unsigned long, unsigned long);
+	void (*flush_range)(unsigned long, unsigned long);
+#ifdef CONFIG_OUTER_CACHE_SYNC
+	void (*sync)(void);
+#endif
+};
+
+#ifdef CONFIG_OUTER_CACHE
+
+extern struct outer_cache_fns outer_cache;
+
+static inline void outer_inv_range(unsigned long start, unsigned long end)
+{
+	if (outer_cache.inv_range)
+		outer_cache.inv_range(start, end);
+}
+static inline void outer_clean_range(unsigned long start, unsigned long end)
+{
+	if (outer_cache.clean_range)
+		outer_cache.clean_range(start, end);
+}
+static inline void outer_flush_range(unsigned long start, unsigned long end)
+{
+	if (outer_cache.flush_range)
+		outer_cache.flush_range(start, end);
+}
+
+#else
+
+static inline void outer_inv_range(unsigned long start, unsigned long end)
+{ }
+static inline void outer_clean_range(unsigned long start, unsigned long end)
+{ }
+static inline void outer_flush_range(unsigned long start, unsigned long end)
+{ }
+
+#endif
+
+#ifdef CONFIG_OUTER_CACHE_SYNC
+static inline void outer_sync(void)
+{
+	if (outer_cache.sync)
+		outer_cache.sync();
+}
+#else
+static inline void outer_sync(void)
+{ }
+#endif
+
+#endif	/* __ASM_OUTERCACHE_H */
diff -urN linux-2.6.34-rc3/arch/arm/include/asm/system.h linux-2.6.34-rc4/arch/arm/include/asm/system.h
--- linux-2.6.34-rc3/arch/arm/include/asm/system.h	2010-04-13 02:18:55.103633069 +0000
+++ linux-2.6.34-rc4/arch/arm/include/asm/system.h	2010-04-13 02:19:00.183633036 +0000
@@ -60,6 +60,8 @@
 #include <linux/linkage.h>
 #include <linux/irqflags.h>
 
+#include <asm/outercache.h>
+
 #define __exception	__attribute__((section(".exception.text")))
 
 struct thread_info;
@@ -137,10 +139,12 @@
 #define dmb() __asm__ __volatile__ ("" : : : "memory")
 #endif
 
-#if __LINUX_ARM_ARCH__ >= 7 || defined(CONFIG_SMP)
-#define mb()		dmb()
+#ifdef CONFIG_ARCH_HAS_BARRIERS
+#include <mach/barriers.h>
+#elif __LINUX_ARM_ARCH__ >= 7 || defined(CONFIG_SMP)
+#define mb()		do { dsb(); outer_sync(); } while (0)
 #define rmb()		dmb()
-#define wmb()		dmb()
+#define wmb()		mb()
 #else
 #define mb()	do { if (arch_is_coherent()) dmb(); else barrier(); } while (0)
 #define rmb()	do { if (arch_is_coherent()) dmb(); else barrier(); } while (0)
@@ -152,9 +156,9 @@
 #define smp_rmb()	barrier()
 #define smp_wmb()	barrier()
 #else
-#define smp_mb()	mb()
-#define smp_rmb()	rmb()
-#define smp_wmb()	wmb()
+#define smp_mb()	dmb()
+#define smp_rmb()	dmb()
+#define smp_wmb()	dmb()
 #endif
 
 #define read_barrier_depends()		do { } while(0)
diff -urN linux-2.6.34-rc3/arch/arm/kernel/irq.c linux-2.6.34-rc4/arch/arm/kernel/irq.c
--- linux-2.6.34-rc3/arch/arm/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/kernel/irq.c	2010-04-13 02:19:00.184633026 +0000
@@ -27,7 +27,6 @@
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/smp.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/arm/kernel/kprobes.c linux-2.6.34-rc4/arch/arm/kernel/kprobes.c
--- linux-2.6.34-rc3/arch/arm/kernel/kprobes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/kernel/kprobes.c	2010-04-13 02:19:00.185571307 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/kprobes.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/stop_machine.h>
 #include <linux/stringify.h>
 #include <asm/traps.h>
@@ -393,6 +394,14 @@
 		/*
 		 * Setup an empty pt_regs. Fill SP and PC fields as
 		 * they're needed by longjmp_break_handler.
+		 *
+		 * We allocate some slack between the original SP and start of
+		 * our fabricated regs. To be precise we want to have worst case
+		 * covered which is STMFD with all 16 regs so we allocate 2 *
+		 * sizeof(struct_pt_regs)).
+		 *
+		 * This is to prevent any simulated instruction from writing
+		 * over the regs when they are accessing the stack.
 		 */
 		"sub    sp, %0, %1		\n\t"
 		"ldr    r0, ="__stringify(JPROBE_MAGIC_ADDR)"\n\t"
@@ -410,7 +419,7 @@
 		"ldmia	sp, {r0 - pc}		\n\t"
 		:
 		: "r" (kcb->jprobe_saved_regs.ARM_sp),
-		  "I" (sizeof(struct pt_regs)),
+		  "I" (sizeof(struct pt_regs) * 2),
 		  "J" (offsetof(struct pt_regs, ARM_sp)),
 		  "J" (offsetof(struct pt_regs, ARM_pc)),
 		  "J" (offsetof(struct pt_regs, ARM_cpsr))
diff -urN linux-2.6.34-rc3/arch/arm/kernel/module.c linux-2.6.34-rc4/arch/arm/kernel/module.c
--- linux-2.6.34-rc3/arch/arm/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/kernel/module.c	2010-04-13 02:19:00.185571307 +0000
@@ -16,9 +16,9 @@
 #include <linux/mm.h>
 #include <linux/elf.h>
 #include <linux/vmalloc.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 
 #include <asm/pgtable.h>
 #include <asm/sections.h>
diff -urN linux-2.6.34-rc3/arch/arm/kernel/process.c linux-2.6.34-rc4/arch/arm/kernel/process.c
--- linux-2.6.34-rc3/arch/arm/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/kernel/process.c	2010-04-13 02:19:00.187633005 +0000
@@ -16,7 +16,6 @@
 #include <linux/mm.h>
 #include <linux/stddef.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/delay.h>
 #include <linux/reboot.h>
diff -urN linux-2.6.34-rc3/arch/arm/kernel/sys_arm.c linux-2.6.34-rc4/arch/arm/kernel/sys_arm.c
--- linux-2.6.34-rc3/arch/arm/kernel/sys_arm.c	2010-04-13 02:18:55.107570567 +0000
+++ linux-2.6.34-rc4/arch/arm/kernel/sys_arm.c	2010-04-13 02:19:00.188633091 +0000
@@ -15,7 +15,6 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/sem.h>
 #include <linux/msg.h>
@@ -27,6 +26,7 @@
 #include <linux/file.h>
 #include <linux/ipc.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 /* Fork a new task - this creates a new program thread.
  * This is called indirectly via a small wrapper
diff -urN linux-2.6.34-rc3/arch/arm/lib/memmove.S linux-2.6.34-rc4/arch/arm/lib/memmove.S
--- linux-2.6.34-rc3/arch/arm/lib/memmove.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/lib/memmove.S	2010-04-13 02:19:00.189633087 +0000
@@ -74,7 +74,7 @@
 		rsb	ip, ip, #32
 		addne	pc, pc, ip		@ C is always clear here
 		b	7f
-6:		nop
+6:		W(nop)
 		W(ldr)	r3, [r1, #-4]!
 		W(ldr)	r4, [r1, #-4]!
 		W(ldr)	r5, [r1, #-4]!
@@ -85,7 +85,7 @@
 
 		add	pc, pc, ip
 		nop
-		nop
+		W(nop)
 		W(str)	r3, [r0, #-4]!
 		W(str)	r4, [r0, #-4]!
 		W(str)	r5, [r0, #-4]!
diff -urN linux-2.6.34-rc3/arch/arm/lib/uaccess_with_memcpy.c linux-2.6.34-rc4/arch/arm/lib/uaccess_with_memcpy.c
--- linux-2.6.34-rc3/arch/arm/lib/uaccess_with_memcpy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/lib/uaccess_with_memcpy.c	2010-04-13 02:19:00.189633087 +0000
@@ -16,6 +16,7 @@
 #include <linux/mm.h>
 #include <linux/sched.h>
 #include <linux/hardirq.h> /* for in_atomic() */
+#include <linux/gfp.h>
 #include <asm/current.h>
 #include <asm/page.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-aaec2000/core.c linux-2.6.34-rc4/arch/arm/mach-aaec2000/core.c
--- linux-2.6.34-rc3/arch/arm/mach-aaec2000/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-aaec2000/core.c	2010-04-13 02:19:00.189633087 +0000
@@ -20,6 +20,7 @@
 #include <linux/timex.h>
 #include <linux/signal.h>
 #include <linux/clk.h>
+#include <linux/gfp.h>
 
 #include <mach/hardware.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-at91/pm_slowclock.S linux-2.6.34-rc4/arch/arm/mach-at91/pm_slowclock.S
--- linux-2.6.34-rc3/arch/arm/mach-at91/pm_slowclock.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-at91/pm_slowclock.S	2010-04-13 02:19:00.193633449 +0000
@@ -205,13 +205,25 @@
 	ldr	r3, .saved_pllbr
 	str	r3, [r1, #(AT91_CKGR_PLLBR - AT91_PMC)]
 
+	tst	r3, #(AT91_PMC_MUL &  0xff0000)
+	bne	1f
+	tst	r3, #(AT91_PMC_MUL & ~0xff0000)
+	beq	2f
+1:
 	wait_pllblock
+2:
 
 	/* Restore PLLA setting */
 	ldr	r3, .saved_pllar
 	str	r3, [r1, #(AT91_CKGR_PLLAR - AT91_PMC)]
 
+	tst	r3, #(AT91_PMC_MUL &  0xff0000)
+	bne	3f
+	tst	r3, #(AT91_PMC_MUL & ~0xff0000)
+	beq	4f
+3:
 	wait_pllalock
+4:
 
 #ifdef SLOWDOWN_MASTER_CLOCK
 	/*
diff -urN linux-2.6.34-rc3/arch/arm/mach-bcmring/dma.c linux-2.6.34-rc4/arch/arm/mach-bcmring/dma.c
--- linux-2.6.34-rc3/arch/arm/mach-bcmring/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-bcmring/dma.c	2010-04-13 02:19:00.194633076 +0000
@@ -28,6 +28,7 @@
 #include <linux/interrupt.h>
 #include <linux/irqreturn.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 
 #include <mach/timer.h>
 
@@ -2220,11 +2221,15 @@
 int dma_unmap(DMA_MemMap_t *memMap,	/* Stores state information about the map */
 	      int dirtied	/* non-zero if any of the pages were modified */
     ) {
+
+	int rc = 0;
 	int regionIdx;
 	int segmentIdx;
 	DMA_Region_t *region;
 	DMA_Segment_t *segment;
 
+	down(&memMap->lock);
+
 	for (regionIdx = 0; regionIdx < memMap->numRegionsUsed; regionIdx++) {
 		region = &memMap->region[regionIdx];
 
@@ -2238,7 +2243,8 @@
 					printk(KERN_ERR
 					       "%s: vmalloc'd pages are not yet supported\n",
 					       __func__);
-					return -EINVAL;
+					rc = -EINVAL;
+					goto out;
 				}
 
 			case DMA_MEM_TYPE_KMALLOC:
@@ -2275,7 +2281,8 @@
 					printk(KERN_ERR
 					       "%s: Unsupported memory type: %d\n",
 					       __func__, region->memType);
-					return -EINVAL;
+					rc = -EINVAL;
+					goto out;
 				}
 			}
 
@@ -2313,9 +2320,10 @@
 	memMap->numRegionsUsed = 0;
 	memMap->inUse = 0;
 
+out:
 	up(&memMap->lock);
 
-	return 0;
+	return rc;
 }
 
 EXPORT_SYMBOL(dma_unmap);
diff -urN linux-2.6.34-rc3/arch/arm/mach-davinci/board-dm365-evm.c linux-2.6.34-rc4/arch/arm/mach-davinci/board-dm365-evm.c
--- linux-2.6.34-rc3/arch/arm/mach-davinci/board-dm365-evm.c	2010-04-13 02:18:55.113633060 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-davinci/board-dm365-evm.c	2010-04-13 02:19:00.195633042 +0000
@@ -22,6 +22,7 @@
 #include <linux/leds.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/partitions.h>
+#include <linux/slab.h>
 #include <linux/mtd/nand.h>
 #include <linux/input.h>
 #include <linux/spi/spi.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-davinci/dm365.c linux-2.6.34-rc4/arch/arm/mach-davinci/dm365.c
--- linux-2.6.34-rc3/arch/arm/mach-davinci/dm365.c	2010-04-13 02:18:55.117633074 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-davinci/dm365.c	2010-04-13 02:19:00.198633075 +0000
@@ -758,7 +758,6 @@
 	[IRQ_MMCINT]			= 7,
 	[IRQ_DM365_MMCINT1]		= 7,
 	[IRQ_DM365_PWMINT3]		= 7,
-	[IRQ_DDRINT]			= 4,
 	[IRQ_AEMIFINT]			= 2,
 	[IRQ_DM365_SDIOINT1]		= 2,
 	[IRQ_TINT0_TINT12]		= 7,
diff -urN linux-2.6.34-rc3/arch/arm/mach-davinci/dma.c linux-2.6.34-rc4/arch/arm/mach-davinci/dma.c
--- linux-2.6.34-rc3/arch/arm/mach-davinci/dma.c	2010-04-13 02:18:55.118633032 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-davinci/dma.c	2010-04-13 02:19:00.200571319 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/edma.h>
 
@@ -1266,7 +1267,8 @@
 		/* EDMA channel with event association */
 		pr_debug("EDMA: ER%d %08x\n", j,
 			edma_shadow0_read_array(ctlr, SH_ER, j));
-		/* Clear any pending error */
+		/* Clear any pending event or error */
+		edma_write_array(ctlr, EDMA_ECR, j, mask);
 		edma_write_array(ctlr, EDMA_EMCR, j, mask);
 		/* Clear any SER */
 		edma_shadow0_write_array(ctlr, SH_SECR, j, mask);
diff -urN linux-2.6.34-rc3/arch/arm/mach-davinci/include/mach/da8xx.h linux-2.6.34-rc4/arch/arm/mach-davinci/include/mach/da8xx.h
--- linux-2.6.34-rc3/arch/arm/mach-davinci/include/mach/da8xx.h	2010-04-13 02:18:55.118633032 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-davinci/include/mach/da8xx.h	2010-04-13 02:19:00.200571319 +0000
@@ -3,7 +3,7 @@
  *
  * Author: Mark A. Greer <mgreer@mvista.com>
  *
- * 2007, 2009 (c) MontaVista Software, Inc. This file is licensed under
+ * 2007, 2009-2010 (c) MontaVista Software, Inc. This file is licensed under
  * the terms of the GNU General Public License version 2. This program
  * is licensed "as is" without any warranty of any kind, whether express
  * or implied.
@@ -13,7 +13,9 @@
 
 #include <video/da8xx-fb.h>
 
+#include <linux/platform_device.h>
 #include <linux/davinci_emac.h>
+
 #include <mach/serial.h>
 #include <mach/edma.h>
 #include <mach/i2c.h>
@@ -144,6 +146,10 @@
 extern const short da850_nand_pins[];
 extern const short da850_nor_pins[];
 
+#ifdef CONFIG_DAVINCI_MUX
 int da8xx_pinmux_setup(const short pins[]);
+#else
+static inline int da8xx_pinmux_setup(const short pins[]) { return 0; }
+#endif
 
 #endif /* __ASM_ARCH_DAVINCI_DA8XX_H */
diff -urN linux-2.6.34-rc3/arch/arm/mach-davinci/time.c linux-2.6.34-rc4/arch/arm/mach-davinci/time.c
--- linux-2.6.34-rc3/arch/arm/mach-davinci/time.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-davinci/time.c	2010-04-13 02:19:00.203570356 +0000
@@ -253,8 +253,6 @@
 			irq = USING_COMPARE(t) ? dtip[i].cmp_irq : irq;
 			setup_irq(irq, &t->irqaction);
 		}
-
-		timer32_config(&timers[i]);
 	}
 }
 
@@ -331,6 +329,7 @@
 	unsigned int clocksource_id;
 	static char err[] __initdata = KERN_ERR
 		"%s: can't register clocksource!\n";
+	int i;
 
 	clockevent_id = soc_info->timer_info->clockevent_id;
 	clocksource_id = soc_info->timer_info->clocksource_id;
@@ -389,6 +388,9 @@
 
 	clockevent_davinci.cpumask = cpumask_of(0);
 	clockevents_register_device(&clockevent_davinci);
+
+	for (i=0; i< ARRAY_SIZE(timers); i++)
+		timer32_config(&timers[i]);
 }
 
 struct sys_timer davinci_timer = {
diff -urN linux-2.6.34-rc3/arch/arm/mach-ep93xx/gpio.c linux-2.6.34-rc4/arch/arm/mach-ep93xx/gpio.c
--- linux-2.6.34-rc3/arch/arm/mach-ep93xx/gpio.c	2010-04-13 02:18:55.124633082 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ep93xx/gpio.c	2010-04-13 02:19:00.205633038 +0000
@@ -25,7 +25,7 @@
 #include <mach/hardware.h>
 
 /*************************************************************************
- * GPIO handling for EP93xx
+ * Interrupt handling for EP93xx on-chip GPIOs
  *************************************************************************/
 static unsigned char gpio_int_unmasked[3];
 static unsigned char gpio_int_enabled[3];
@@ -40,7 +40,7 @@
 static const u8 int_en_register_offset[3]	= { 0x9c, 0xb8, 0x58 };
 static const u8 int_debounce_register_offset[3]	= { 0xa8, 0xc4, 0x64 };
 
-void ep93xx_gpio_update_int_params(unsigned port)
+static void ep93xx_gpio_update_int_params(unsigned port)
 {
 	BUG_ON(port > 2);
 
@@ -56,7 +56,7 @@
 		EP93XX_GPIO_REG(int_en_register_offset[port]));
 }
 
-void ep93xx_gpio_int_mask(unsigned line)
+static inline void ep93xx_gpio_int_mask(unsigned line)
 {
 	gpio_int_unmasked[line >> 3] &= ~(1 << (line & 7));
 }
diff -urN linux-2.6.34-rc3/arch/arm/mach-h720x/common.c linux-2.6.34-rc4/arch/arm/mach-h720x/common.c
--- linux-2.6.34-rc3/arch/arm/mach-h720x/common.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-h720x/common.c	2010-04-13 02:19:00.207633060 +0000
@@ -14,7 +14,6 @@
  */
 
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/mman.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-integrator/cpu.c linux-2.6.34-rc4/arch/arm/mach-integrator/cpu.c
--- linux-2.6.34-rc3/arch/arm/mach-integrator/cpu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-integrator/cpu.c	2010-04-13 02:19:00.207633060 +0000
@@ -13,7 +13,6 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/cpufreq.h>
-#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/smp.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-integrator/impd1.c linux-2.6.34-rc4/arch/arm/mach-integrator/impd1.c
--- linux-2.6.34-rc3/arch/arm/mach-integrator/impd1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-integrator/impd1.c	2010-04-13 02:19:00.208633089 +0000
@@ -21,6 +21,7 @@
 #include <linux/amba/bus.h>
 #include <linux/amba/clcd.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/clkdev.h>
 #include <mach/clkdev.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-integrator/integrator_cp.c linux-2.6.34-rc4/arch/arm/mach-integrator/integrator_cp.c
--- linux-2.6.34-rc3/arch/arm/mach-integrator/integrator_cp.c	2010-04-13 02:18:55.126633054 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-integrator/integrator_cp.c	2010-04-13 02:19:00.208633089 +0000
@@ -13,7 +13,6 @@
 #include <linux/list.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/sysdev.h>
 #include <linux/amba/bus.h>
@@ -21,6 +20,7 @@
 #include <linux/amba/clcd.h>
 #include <linux/amba/mmci.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <asm/clkdev.h>
 #include <mach/clkdev.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-integrator/pci_v3.c linux-2.6.34-rc4/arch/arm/mach-integrator/pci_v3.c
--- linux-2.6.34-rc3/arch/arm/mach-integrator/pci_v3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-integrator/pci_v3.c	2010-04-13 02:19:00.208633089 +0000
@@ -22,7 +22,6 @@
  */
 #include <linux/kernel.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop13xx/pci.c linux-2.6.34-rc4/arch/arm/mach-iop13xx/pci.c
--- linux-2.6.34-rc3/arch/arm/mach-iop13xx/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop13xx/pci.c	2010-04-13 02:19:00.209633067 +0000
@@ -18,6 +18,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/jiffies.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop32x/glantank.c linux-2.6.34-rc4/arch/arm/mach-iop32x/glantank.c
--- linux-2.6.34-rc3/arch/arm/mach-iop32x/glantank.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop32x/glantank.c	2010-04-13 02:19:00.209633067 +0000
@@ -19,7 +19,6 @@
 #include <linux/pci.h>
 #include <linux/pm.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop32x/iq31244.c linux-2.6.34-rc4/arch/arm/mach-iop32x/iq31244.c
--- linux-2.6.34-rc3/arch/arm/mach-iop32x/iq31244.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop32x/iq31244.c	2010-04-13 02:19:00.209633067 +0000
@@ -21,7 +21,6 @@
 #include <linux/pci.h>
 #include <linux/pm.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop32x/iq80321.c linux-2.6.34-rc4/arch/arm/mach-iop32x/iq80321.c
--- linux-2.6.34-rc3/arch/arm/mach-iop32x/iq80321.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop32x/iq80321.c	2010-04-13 02:19:00.209633067 +0000
@@ -18,7 +18,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop32x/n2100.c linux-2.6.34-rc4/arch/arm/mach-iop32x/n2100.c
--- linux-2.6.34-rc3/arch/arm/mach-iop32x/n2100.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop32x/n2100.c	2010-04-13 02:19:00.209633067 +0000
@@ -23,7 +23,6 @@
 #include <linux/pci.h>
 #include <linux/pm.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop33x/iq80331.c linux-2.6.34-rc4/arch/arm/mach-iop33x/iq80331.c
--- linux-2.6.34-rc3/arch/arm/mach-iop33x/iq80331.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop33x/iq80331.c	2010-04-13 02:19:00.210633042 +0000
@@ -17,7 +17,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-iop33x/iq80332.c linux-2.6.34-rc4/arch/arm/mach-iop33x/iq80332.c
--- linux-2.6.34-rc3/arch/arm/mach-iop33x/iq80332.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-iop33x/iq80332.c	2010-04-13 02:19:00.210633042 +0000
@@ -17,7 +17,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/mtd/physmap.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/enp2611.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/enp2611.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/enp2611.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/enp2611.c	2010-04-13 02:19:00.210633042 +0000
@@ -26,7 +26,6 @@
 #include <linux/bitops.h>
 #include <linux/pci.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/serial.h>
 #include <linux/tty.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2400.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2400.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2400.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2400.c	2010-04-13 02:19:00.210633042 +0000
@@ -23,7 +23,6 @@
 #include <linux/bitops.h>
 #include <linux/pci.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2800.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2800.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2800.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2800.c	2010-04-13 02:19:00.210633042 +0000
@@ -23,7 +23,6 @@
 #include <linux/bitops.h>
 #include <linux/pci.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2x00.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2x00.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2x00.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2x00.c	2010-04-13 02:19:00.210633042 +0000
@@ -23,7 +23,6 @@
 #include <linux/bitops.h>
 #include <linux/pci.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2x01.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2x01.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/ixdp2x01.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/ixdp2x01.c	2010-04-13 02:19:00.210633042 +0000
@@ -23,7 +23,6 @@
 #include <linux/bitops.h>
 #include <linux/pci.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/serial.h>
 #include <linux/tty.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp2000/pci.c linux-2.6.34-rc4/arch/arm/mach-ixp2000/pci.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp2000/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp2000/pci.c	2010-04-13 02:19:00.211633059 +0000
@@ -22,7 +22,6 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp23xx/pci.c linux-2.6.34-rc4/arch/arm/mach-ixp23xx/pci.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp23xx/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp23xx/pci.c	2010-04-13 02:19:00.211633059 +0000
@@ -23,7 +23,6 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/avila-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/avila-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/avila-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/avila-setup.c	2010-04-13 02:19:00.211633059 +0000
@@ -17,7 +17,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 #include <linux/i2c-gpio.h>
 #include <asm/types.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/coyote-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/coyote-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/coyote-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/coyote-setup.c	2010-04-13 02:19:00.212633047 +0000
@@ -14,7 +14,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 
 #include <asm/types.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/gateway7001-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/gateway7001-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/gateway7001-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/gateway7001-setup.c	2010-04-13 02:19:00.212633047 +0000
@@ -17,7 +17,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 
 #include <asm/types.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/gtwx5715-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/gtwx5715-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/gtwx5715-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/gtwx5715-setup.c	2010-04-13 02:19:00.212633047 +0000
@@ -27,7 +27,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 #include <asm/types.h>
 #include <asm/setup.h>
 #include <asm/memory.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/ixdp425-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/ixdp425-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/ixdp425-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/ixdp425-setup.c	2010-04-13 02:19:00.212633047 +0000
@@ -14,7 +14,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 #include <linux/i2c-gpio.h>
 #include <linux/io.h>
 #include <linux/mtd/mtd.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/ixp4xx_npe.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/ixp4xx_npe.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/ixp4xx_npe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/ixp4xx_npe.c	2010-04-13 02:19:00.212633047 +0000
@@ -20,7 +20,6 @@
 #include <linux/io.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <mach/npe.h>
 
 #define DEBUG_MSG			0
diff -urN linux-2.6.34-rc3/arch/arm/mach-ixp4xx/wg302v2-setup.c linux-2.6.34-rc4/arch/arm/mach-ixp4xx/wg302v2-setup.c
--- linux-2.6.34-rc3/arch/arm/mach-ixp4xx/wg302v2-setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ixp4xx/wg302v2-setup.c	2010-04-13 02:19:00.213633037 +0000
@@ -18,7 +18,6 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_8250.h>
-#include <linux/slab.h>
 
 #include <asm/types.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-kirkwood/pcie.c linux-2.6.34-rc4/arch/arm/mach-kirkwood/pcie.c
--- linux-2.6.34-rc3/arch/arm/mach-kirkwood/pcie.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-kirkwood/pcie.c	2010-04-13 02:19:00.214633075 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/mbus.h>
 #include <asm/irq.h>
 #include <asm/mach/pci.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-lh7a40x/clcd.c linux-2.6.34-rc4/arch/arm/mach-lh7a40x/clcd.c
--- linux-2.6.34-rc3/arch/arm/mach-lh7a40x/clcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-lh7a40x/clcd.c	2010-04-13 02:19:00.215633032 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
 #include <linux/sysdev.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/Kconfig linux-2.6.34-rc4/arch/arm/mach-mx3/Kconfig
--- linux-2.6.34-rc3/arch/arm/mach-mx3/Kconfig	2010-04-13 02:18:55.147633052 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/Kconfig	2010-04-13 02:19:00.232570742 +0000
@@ -62,6 +62,15 @@
 	  Include support for MX31PDK (3DS) platform. This includes specific
 	  configurations for the board and its peripherals.
 
+config MACH_MX31_3DS_MXC_NAND_USE_BBT
+	bool "Make the MXC NAND driver use the in flash Bad Block Table"
+	depends on MACH_MX31_3DS
+	depends on MTD_NAND_MXC
+	help
+	  Enable this if you want that the MXC NAND driver uses the in flash
+	  Bad Block Table to know what blocks are bad instead of scanning the
+	  entire flash looking for bad block markers.
+
 config MACH_MX31MOBOARD
 	bool "Support mx31moboard platforms (EPFL Mobots group)"
 	select ARCH_MX31
@@ -95,6 +104,7 @@
 config MACH_ARMADILLO5X0
 	bool "Support Atmark Armadillo-500 Development Base Board"
 	select ARCH_MX31
+	select MXC_ULPI if USB_ULPI
 	help
 	  Include support for Atmark Armadillo-500 platform. This includes
 	  specific configurations for the board and its peripherals.
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/clock-imx31.c linux-2.6.34-rc4/arch/arm/mach-mx3/clock-imx31.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/clock-imx31.c	2010-04-13 02:18:55.148633057 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/clock-imx31.c	2010-04-13 02:19:00.233633038 +0000
@@ -468,6 +468,7 @@
 	}
 
 DEFINE_CLOCK(perclk_clk,  0, NULL,          0, NULL, NULL, &ipg_clk);
+DEFINE_CLOCK(ckil_clk,    0, NULL,          0, clk_ckil_get_rate, NULL, NULL);
 
 DEFINE_CLOCK(sdhc1_clk,   0, MXC_CCM_CGR0,  0, NULL, NULL, &perclk_clk);
 DEFINE_CLOCK(sdhc2_clk,   1, MXC_CCM_CGR0,  2, NULL, NULL, &perclk_clk);
@@ -490,7 +491,7 @@
 DEFINE_CLOCK(mstick1_clk, 0, MXC_CCM_CGR1,  2, mstick1_get_rate, NULL, &usb_pll_clk);
 DEFINE_CLOCK(mstick2_clk, 1, MXC_CCM_CGR1,  4, mstick2_get_rate, NULL, &usb_pll_clk);
 DEFINE_CLOCK1(csi_clk,    0, MXC_CCM_CGR1,  6, csi, NULL, &serial_pll_clk);
-DEFINE_CLOCK(rtc_clk,     0, MXC_CCM_CGR1,  8, NULL, NULL, &ipg_clk);
+DEFINE_CLOCK(rtc_clk,     0, MXC_CCM_CGR1,  8, NULL, NULL, &ckil_clk);
 DEFINE_CLOCK(wdog_clk,    0, MXC_CCM_CGR1, 10, NULL, NULL, &ipg_clk);
 DEFINE_CLOCK(pwm_clk,     0, MXC_CCM_CGR1, 12, NULL, NULL, &perclk_clk);
 DEFINE_CLOCK(usb_clk2,    0, MXC_CCM_CGR1, 18, usb_get_rate, NULL, &ahb_clk);
@@ -514,7 +515,6 @@
 DEFINE_CLOCK(nfc_clk,     0, NULL,          0, nfc_get_rate, NULL, &ahb_clk);
 DEFINE_CLOCK(scc_clk,     0, NULL,          0, NULL, NULL, &ipg_clk);
 DEFINE_CLOCK(ipg_clk,     0, NULL,          0, ipg_get_rate, NULL, &ahb_clk);
-DEFINE_CLOCK(ckil_clk,    0, NULL,          0, clk_ckil_get_rate, NULL, NULL);
 
 #define _REGISTER_CLOCK(d, n, c) \
 	{ \
@@ -572,7 +572,6 @@
 	_REGISTER_CLOCK(NULL, "iim", iim_clk)
 	_REGISTER_CLOCK(NULL, "mpeg4", mpeg4_clk)
 	_REGISTER_CLOCK(NULL, "mbx", mbx_clk)
-	_REGISTER_CLOCK("mxc_rtc", NULL, ckil_clk)
 };
 
 int __init mx31_clocks_init(unsigned long fref)
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/devices.c linux-2.6.34-rc4/arch/arm/mach-mx3/devices.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/devices.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/devices.c	2010-04-13 02:19:00.234633046 +0000
@@ -575,11 +575,26 @@
 	.resource = imx_ssi_resources1,
 };
 
-static int mx3_devices_init(void)
+static struct resource imx_wdt_resources[] = {
+	{
+		.flags = IORESOURCE_MEM,
+	},
+};
+
+struct platform_device imx_wdt_device0 = {
+	.name           = "imx-wdt",
+	.id             = 0,
+	.num_resources  = ARRAY_SIZE(imx_wdt_resources),
+	.resource       = imx_wdt_resources,
+};
+
+static int __init mx3_devices_init(void)
 {
 	if (cpu_is_mx31()) {
 		mxc_nand_resources[0].start = MX31_NFC_BASE_ADDR;
 		mxc_nand_resources[0].end = MX31_NFC_BASE_ADDR + 0xfff;
+		imx_wdt_resources[0].start = MX31_WDOG_BASE_ADDR;
+		imx_wdt_resources[0].end = MX31_WDOG_BASE_ADDR + 0x3fff;
 		mxc_register_device(&mxc_rnga_device, NULL);
 	}
 	if (cpu_is_mx35()) {
@@ -597,6 +612,8 @@
 		imx_ssi_resources0[1].end = MX35_INT_SSI1;
 		imx_ssi_resources1[1].start = MX35_INT_SSI2;
 		imx_ssi_resources1[1].end = MX35_INT_SSI2;
+		imx_wdt_resources[0].start = MX35_WDOG_BASE_ADDR;
+		imx_wdt_resources[0].end = MX35_WDOG_BASE_ADDR + 0x3fff;
 	}
 
 	return 0;
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/devices.h linux-2.6.34-rc4/arch/arm/mach-mx3/devices.h
--- linux-2.6.34-rc3/arch/arm/mach-mx3/devices.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/devices.h	2010-04-13 02:19:00.234633046 +0000
@@ -25,4 +25,5 @@
 extern struct platform_device mxc_spi_device2;
 extern struct platform_device imx_ssi_device0;
 extern struct platform_device imx_ssi_device1;
-
+extern struct platform_device imx_ssi_device1;
+extern struct platform_device imx_wdt_device0;
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mach-armadillo5x0.c linux-2.6.34-rc4/arch/arm/mach-mx3/mach-armadillo5x0.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mach-armadillo5x0.c	2010-04-13 02:18:55.150570478 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mach-armadillo5x0.c	2010-04-13 02:19:00.236633038 +0000
@@ -36,6 +36,9 @@
 #include <linux/input.h>
 #include <linux/gpio_keys.h>
 #include <linux/i2c.h>
+#include <linux/usb/otg.h>
+#include <linux/usb/ulpi.h>
+#include <linux/delay.h>
 
 #include <mach/hardware.h>
 #include <asm/mach-types.h>
@@ -52,6 +55,8 @@
 #include <mach/ipu.h>
 #include <mach/mx3fb.h>
 #include <mach/mxc_nand.h>
+#include <mach/mxc_ehci.h>
+#include <mach/ulpi.h>
 
 #include "devices.h"
 #include "crm_regs.h"
@@ -103,8 +108,158 @@
 	/* I2C2 */
 	MX31_PIN_CSPI2_MOSI__SCL,
 	MX31_PIN_CSPI2_MISO__SDA,
+	/* OTG */
+	MX31_PIN_USBOTG_DATA0__USBOTG_DATA0,
+	MX31_PIN_USBOTG_DATA1__USBOTG_DATA1,
+	MX31_PIN_USBOTG_DATA2__USBOTG_DATA2,
+	MX31_PIN_USBOTG_DATA3__USBOTG_DATA3,
+	MX31_PIN_USBOTG_DATA4__USBOTG_DATA4,
+	MX31_PIN_USBOTG_DATA5__USBOTG_DATA5,
+	MX31_PIN_USBOTG_DATA6__USBOTG_DATA6,
+	MX31_PIN_USBOTG_DATA7__USBOTG_DATA7,
+	MX31_PIN_USBOTG_CLK__USBOTG_CLK,
+	MX31_PIN_USBOTG_DIR__USBOTG_DIR,
+	MX31_PIN_USBOTG_NXT__USBOTG_NXT,
+	MX31_PIN_USBOTG_STP__USBOTG_STP,
+	/* USB host 2 */
+	IOMUX_MODE(MX31_PIN_USBH2_CLK, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_USBH2_DIR, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_USBH2_NXT, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_USBH2_STP, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_USBH2_DATA0, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_USBH2_DATA1, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_STXD3, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_SRXD3, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_SCK3, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_SFS3, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_STXD6, IOMUX_CONFIG_FUNC),
+	IOMUX_MODE(MX31_PIN_SRXD6, IOMUX_CONFIG_FUNC),
+};
+
+/* USB */
+#if defined(CONFIG_USB_ULPI)
+
+#define OTG_RESET IOMUX_TO_GPIO(MX31_PIN_STXD4)
+#define USBH2_RESET IOMUX_TO_GPIO(MX31_PIN_SCK6)
+#define USBH2_CS IOMUX_TO_GPIO(MX31_PIN_GPIO1_3)
+
+#define USB_PAD_CFG (PAD_CTL_DRV_MAX | PAD_CTL_SRE_FAST | PAD_CTL_HYS_CMOS | \
+			PAD_CTL_ODE_CMOS | PAD_CTL_100K_PU)
+
+static int usbotg_init(struct platform_device *pdev)
+{
+	int err;
+
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA0, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA1, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA2, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA3, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA4, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA5, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA6, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DATA7, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_CLK, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_DIR, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_NXT, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBOTG_STP, USB_PAD_CFG);
+
+	/* Chip already enabled by hardware */
+	/* OTG phy reset*/
+	err = gpio_request(OTG_RESET, "USB-OTG-RESET");
+	if (err) {
+		pr_err("Failed to request the usb otg reset gpio\n");
+		return err;
+	}
+
+	err = gpio_direction_output(OTG_RESET, 1/*HIGH*/);
+	if (err) {
+		pr_err("Failed to reset the usb otg phy\n");
+		goto otg_free_reset;
+	}
+
+	gpio_set_value(OTG_RESET, 0/*LOW*/);
+	mdelay(5);
+	gpio_set_value(OTG_RESET, 1/*HIGH*/);
+
+	return 0;
+
+otg_free_reset:
+	gpio_free(OTG_RESET);
+	return err;
+}
+
+static int usbh2_init(struct platform_device *pdev)
+{
+	int err;
+
+	mxc_iomux_set_pad(MX31_PIN_USBH2_CLK, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBH2_DIR, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBH2_NXT, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBH2_STP, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBH2_DATA0, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_USBH2_DATA1, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_SRXD6, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_STXD6, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_SFS3, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_SCK3, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_SRXD3, USB_PAD_CFG);
+	mxc_iomux_set_pad(MX31_PIN_STXD3, USB_PAD_CFG);
+
+	mxc_iomux_set_gpr(MUX_PGP_UH2, true);
+
+
+	/* Enable the chip */
+	err = gpio_request(USBH2_CS, "USB-H2-CS");
+	if (err) {
+		pr_err("Failed to request the usb host 2 CS gpio\n");
+		return err;
+	}
+
+	err = gpio_direction_output(USBH2_CS, 0/*Enabled*/);
+	if (err) {
+		pr_err("Failed to drive the usb host 2 CS gpio\n");
+		goto h2_free_cs;
+	}
+
+	/* H2 phy reset*/
+	err = gpio_request(USBH2_RESET, "USB-H2-RESET");
+	if (err) {
+		pr_err("Failed to request the usb host 2 reset gpio\n");
+		goto h2_free_cs;
+	}
+
+	err = gpio_direction_output(USBH2_RESET, 1/*HIGH*/);
+	if (err) {
+		pr_err("Failed to reset the usb host 2 phy\n");
+		goto h2_free_reset;
+	}
+
+	gpio_set_value(USBH2_RESET, 0/*LOW*/);
+	mdelay(5);
+	gpio_set_value(USBH2_RESET, 1/*HIGH*/);
+
+	return 0;
+
+h2_free_reset:
+	gpio_free(USBH2_RESET);
+h2_free_cs:
+	gpio_free(USBH2_CS);
+	return err;
+}
+
+static struct mxc_usbh_platform_data usbotg_pdata = {
+	.init	= usbotg_init,
+	.portsc	= MXC_EHCI_MODE_ULPI | MXC_EHCI_UTMI_8BIT,
+	.flags	= MXC_EHCI_POWER_PINS_ENABLED | MXC_EHCI_INTERFACE_DIFF_UNI,
 };
 
+static struct mxc_usbh_platform_data usbh2_pdata = {
+	.init	= usbh2_init,
+	.portsc	= MXC_EHCI_MODE_ULPI | MXC_EHCI_UTMI_8BIT,
+	.flags	= MXC_EHCI_POWER_PINS_ENABLED | MXC_EHCI_INTERFACE_DIFF_UNI,
+};
+#endif /* CONFIG_USB_ULPI */
+
 /* RTC over I2C*/
 #define ARMADILLO5X0_RTC_GPIO	IOMUX_TO_GPIO(MX31_PIN_SRXD4)
 
@@ -393,6 +548,17 @@
 	if (armadillo5x0_i2c_rtc.irq == 0)
 		pr_warning("armadillo5x0_init: failed to get RTC IRQ\n");
 	i2c_register_board_info(1, &armadillo5x0_i2c_rtc, 1);
+
+	/* USB */
+#if defined(CONFIG_USB_ULPI)
+	usbotg_pdata.otg = otg_ulpi_create(&mxc_ulpi_access_ops,
+			USB_OTG_DRV_VBUS | USB_OTG_DRV_VBUS_EXT);
+	usbh2_pdata.otg = otg_ulpi_create(&mxc_ulpi_access_ops,
+			USB_OTG_DRV_VBUS | USB_OTG_DRV_VBUS_EXT);
+
+	mxc_register_device(&mxc_otg_host, &usbotg_pdata);
+	mxc_register_device(&mxc_usbh2, &usbh2_pdata);
+#endif
 }
 
 static void __init armadillo5x0_timer_init(void)
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mach-mx31_3ds.c linux-2.6.34-rc4/arch/arm/mach-mx3/mach-mx31_3ds.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mach-mx31_3ds.c	2010-04-13 02:18:55.151633030 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mach-mx31_3ds.c	2010-04-13 02:19:00.236633038 +0000
@@ -23,6 +23,9 @@
 #include <linux/gpio.h>
 #include <linux/smsc911x.h>
 #include <linux/platform_device.h>
+#include <linux/mfd/mc13783.h>
+#include <linux/spi/spi.h>
+#include <linux/regulator/machine.h>
 
 #include <mach/hardware.h>
 #include <asm/mach-types.h>
@@ -31,26 +34,96 @@
 #include <asm/memory.h>
 #include <asm/mach/map.h>
 #include <mach/common.h>
-#include <mach/board-mx31pdk.h>
+#include <mach/board-mx31_3ds.h>
 #include <mach/imx-uart.h>
 #include <mach/iomux-mx3.h>
+#include <mach/mxc_nand.h>
+#include <mach/spi.h>
 #include "devices.h"
 
 /*!
- * @file mx31pdk.c
+ * @file mx31_3ds.c
  *
  * @brief This file contains the board-specific initialization routines.
  *
  * @ingroup System
  */
 
-static int mx31pdk_pins[] = {
+static int mx31_3ds_pins[] = {
 	/* UART1 */
 	MX31_PIN_CTS1__CTS1,
 	MX31_PIN_RTS1__RTS1,
 	MX31_PIN_TXD1__TXD1,
 	MX31_PIN_RXD1__RXD1,
 	IOMUX_MODE(MX31_PIN_GPIO1_1, IOMUX_CONFIG_GPIO),
+	/* SPI 1 */
+	MX31_PIN_CSPI2_SCLK__SCLK,
+	MX31_PIN_CSPI2_MOSI__MOSI,
+	MX31_PIN_CSPI2_MISO__MISO,
+	MX31_PIN_CSPI2_SPI_RDY__SPI_RDY,
+	MX31_PIN_CSPI2_SS0__SS0,
+	MX31_PIN_CSPI2_SS2__SS2, /*CS for MC13783 */
+	/* MC13783 IRQ */
+	IOMUX_MODE(MX31_PIN_GPIO1_3, IOMUX_CONFIG_GPIO),
+};
+
+/* Regulators */
+static struct regulator_init_data pwgtx_init = {
+	.constraints = {
+		.boot_on	= 1,
+		.always_on	= 1,
+	},
+};
+
+static struct mc13783_regulator_init_data mx31_3ds_regulators[] = {
+	{
+		.id = MC13783_REGU_PWGT1SPI, /* Power Gate for ARM core. */
+		.init_data = &pwgtx_init,
+	}, {
+		.id = MC13783_REGU_PWGT2SPI, /* Power Gate for L2 Cache. */
+		.init_data = &pwgtx_init,
+	},
+};
+
+/* MC13783 */
+static struct mc13783_platform_data mc13783_pdata __initdata = {
+	.regulators = mx31_3ds_regulators,
+	.num_regulators = ARRAY_SIZE(mx31_3ds_regulators),
+	.flags  = MC13783_USE_REGULATOR,
+};
+
+/* SPI */
+static int spi1_internal_chipselect[] = {
+	MXC_SPI_CS(0),
+	MXC_SPI_CS(2),
+};
+
+static struct spi_imx_master spi1_pdata = {
+	.chipselect	= spi1_internal_chipselect,
+	.num_chipselect	= ARRAY_SIZE(spi1_internal_chipselect),
+};
+
+static struct spi_board_info mx31_3ds_spi_devs[] __initdata = {
+	{
+		.modalias	= "mc13783",
+		.max_speed_hz	= 1000000,
+		.bus_num	= 1,
+		.chip_select	= 1, /* SS2 */
+		.platform_data	= &mc13783_pdata,
+		.irq		= IOMUX_TO_IRQ(MX31_PIN_GPIO1_3),
+		.mode = SPI_CS_HIGH,
+	},
+};
+
+/*
+ * NAND Flash
+ */
+static struct mxc_nand_platform_data imx31_3ds_nand_flash_pdata = {
+	.width		= 1,
+	.hw_ecc		= 1,
+#ifdef MACH_MX31_3DS_MXC_NAND_USE_BBT
+	.flash_bbt	= 1,
+#endif
 };
 
 static struct imxuart_platform_data uart_pdata = {
@@ -95,7 +168,7 @@
  * LEDs, switches, interrupts for Ethernet.
  */
 
-static void mx31pdk_expio_irq_handler(uint32_t irq, struct irq_desc *desc)
+static void mx31_3ds_expio_irq_handler(uint32_t irq, struct irq_desc *desc)
 {
 	uint32_t imr_val;
 	uint32_t int_valid;
@@ -163,7 +236,7 @@
 	.unmask = expio_unmask_irq,
 };
 
-static int __init mx31pdk_init_expio(void)
+static int __init mx31_3ds_init_expio(void)
 {
 	int i;
 	int ret;
@@ -176,7 +249,7 @@
 		return -ENODEV;
 	}
 
-	pr_info("i.MX31PDK Debug board detected, rev = 0x%04X\n",
+	pr_info("i.MX31 3DS Debug board detected, rev = 0x%04X\n",
 		__raw_readw(CPLD_CODE_VER_REG));
 
 	/*
@@ -201,7 +274,7 @@
 		set_irq_flags(i, IRQF_VALID);
 	}
 	set_irq_type(EXPIO_PARENT_INT, IRQ_TYPE_LEVEL_LOW);
-	set_irq_chained_handler(EXPIO_PARENT_INT, mx31pdk_expio_irq_handler);
+	set_irq_chained_handler(EXPIO_PARENT_INT, mx31_3ds_expio_irq_handler);
 
 	return 0;
 }
@@ -209,7 +282,7 @@
 /*
  * This structure defines the MX31 memory map.
  */
-static struct map_desc mx31pdk_io_desc[] __initdata = {
+static struct map_desc mx31_3ds_io_desc[] __initdata = {
 	{
 		.virtual = MX31_CS5_BASE_ADDR_VIRT,
 		.pfn = __phys_to_pfn(MX31_CS5_BASE_ADDR),
@@ -221,10 +294,10 @@
 /*
  * Set up static virtual mappings.
  */
-static void __init mx31pdk_map_io(void)
+static void __init mx31_3ds_map_io(void)
 {
 	mx31_map_io();
-	iotable_init(mx31pdk_io_desc, ARRAY_SIZE(mx31pdk_io_desc));
+	iotable_init(mx31_3ds_io_desc, ARRAY_SIZE(mx31_3ds_io_desc));
 }
 
 /*!
@@ -232,35 +305,40 @@
  */
 static void __init mxc_board_init(void)
 {
-	mxc_iomux_setup_multiple_pins(mx31pdk_pins, ARRAY_SIZE(mx31pdk_pins),
-				      "mx31pdk");
+	mxc_iomux_setup_multiple_pins(mx31_3ds_pins, ARRAY_SIZE(mx31_3ds_pins),
+				      "mx31_3ds");
 
 	mxc_register_device(&mxc_uart_device0, &uart_pdata);
+	mxc_register_device(&mxc_nand_device, &imx31_3ds_nand_flash_pdata);
+
+	mxc_register_device(&mxc_spi_device1, &spi1_pdata);
+	spi_register_board_info(mx31_3ds_spi_devs,
+						ARRAY_SIZE(mx31_3ds_spi_devs));
 
-	if (!mx31pdk_init_expio())
+	if (!mx31_3ds_init_expio())
 		platform_device_register(&smsc911x_device);
 }
 
-static void __init mx31pdk_timer_init(void)
+static void __init mx31_3ds_timer_init(void)
 {
 	mx31_clocks_init(26000000);
 }
 
-static struct sys_timer mx31pdk_timer = {
-	.init	= mx31pdk_timer_init,
+static struct sys_timer mx31_3ds_timer = {
+	.init	= mx31_3ds_timer_init,
 };
 
 /*
  * The following uses standard kernel macros defined in arch.h in order to
- * initialize __mach_desc_MX31PDK data structure.
+ * initialize __mach_desc_MX31_3DS data structure.
  */
 MACHINE_START(MX31_3DS, "Freescale MX31PDK (3DS)")
 	/* Maintainer: Freescale Semiconductor, Inc. */
 	.phys_io	= MX31_AIPS1_BASE_ADDR,
 	.io_pg_offst	= (MX31_AIPS1_BASE_ADDR_VIRT >> 18) & 0xfffc,
 	.boot_params    = MX3x_PHYS_OFFSET + 0x100,
-	.map_io         = mx31pdk_map_io,
+	.map_io         = mx31_3ds_map_io,
 	.init_irq       = mx31_init_irq,
 	.init_machine   = mxc_board_init,
-	.timer          = &mx31pdk_timer,
+	.timer          = &mx31_3ds_timer,
 MACHINE_END
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mach-mx31moboard.c linux-2.6.34-rc4/arch/arm/mach-mx3/mach-mx31moboard.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mach-mx31moboard.c	2010-04-13 02:18:55.152633158 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mach-mx31moboard.c	2010-04-13 02:19:00.238633057 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
 #include <linux/fsl_devices.h>
+#include <linux/gfp.h>
 #include <linux/gpio.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mach-pcm037.c linux-2.6.34-rc4/arch/arm/mach-mx3/mach-pcm037.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mach-pcm037.c	2010-04-13 02:18:55.153633035 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mach-pcm037.c	2010-04-13 02:19:00.238633057 +0000
@@ -35,7 +35,7 @@
 #include <linux/can/platform/sja1000.h>
 #include <linux/usb/otg.h>
 #include <linux/usb/ulpi.h>
-#include <linux/fsl_devices.h>
+#include <linux/gfp.h>
 
 #include <media/soc_camera.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mx31lite-db.c linux-2.6.34-rc4/arch/arm/mach-mx3/mx31lite-db.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mx31lite-db.c	2010-04-13 02:18:55.155633053 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mx31lite-db.c	2010-04-13 02:19:00.240633064 +0000
@@ -28,7 +28,6 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/gpio.h>
-#include <linux/platform_device.h>
 #include <linux/leds.h>
 #include <linux/platform_device.h>
 
@@ -206,5 +205,6 @@
 	mxc_register_device(&mxcsdhc_device0, &mmc_pdata);
 	mxc_register_device(&mxc_spi_device0, &spi0_pdata);
 	platform_device_register(&litekit_led_device);
+	mxc_register_device(&imx_wdt_device0, NULL);
 }
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mx31moboard-devboard.c linux-2.6.34-rc4/arch/arm/mach-mx3/mx31moboard-devboard.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mx31moboard-devboard.c	2010-04-13 02:18:55.156633043 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mx31moboard-devboard.c	2010-04-13 02:19:00.240633064 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include <linux/usb/otg.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx3/mx31moboard-marxbot.c linux-2.6.34-rc4/arch/arm/mach-mx3/mx31moboard-marxbot.c
--- linux-2.6.34-rc3/arch/arm/mach-mx3/mx31moboard-marxbot.c	2010-04-13 02:18:55.156633043 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx3/mx31moboard-marxbot.c	2010-04-13 02:19:00.240633064 +0000
@@ -22,6 +22,7 @@
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/types.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx5/clock-mx51.c linux-2.6.34-rc4/arch/arm/mach-mx5/clock-mx51.c
--- linux-2.6.34-rc3/arch/arm/mach-mx5/clock-mx51.c	2010-04-13 02:18:55.161570463 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx5/clock-mx51.c	2010-04-13 02:19:00.244570454 +0000
@@ -757,7 +757,7 @@
 
 /* GPT */
 DEFINE_CLOCK(gpt_clk, 0, MXC_CCM_CCGR2, MXC_CCM_CCGRx_CG9_OFFSET,
-	NULL,  NULL, &ipg_perclk, NULL);
+	NULL,  NULL, &ipg_clk, NULL);
 DEFINE_CLOCK(gpt_ipg_clk, 0, MXC_CCM_CCGR2, MXC_CCM_CCGRx_CG10_OFFSET,
 	NULL,  NULL, &ipg_clk, NULL);
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx5/cpu.c linux-2.6.34-rc4/arch/arm/mach-mx5/cpu.c
--- linux-2.6.34-rc3/arch/arm/mach-mx5/cpu.c	2010-04-13 02:18:55.161570463 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx5/cpu.c	2010-04-13 02:19:00.244570454 +0000
@@ -14,9 +14,62 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/module.h>
 #include <mach/hardware.h>
 #include <asm/io.h>
 
+static int cpu_silicon_rev = -1;
+
+#define SI_REV 0x48
+
+static void query_silicon_parameter(void)
+{
+	void __iomem *rom = ioremap(MX51_IROM_BASE_ADDR, MX51_IROM_SIZE);
+	u32 rev;
+
+	if (!rom) {
+		cpu_silicon_rev = -EINVAL;
+		return;
+	}
+
+	rev = readl(rom + SI_REV);
+	switch (rev) {
+	case 0x1:
+		cpu_silicon_rev = MX51_CHIP_REV_1_0;
+		break;
+	case 0x2:
+		cpu_silicon_rev = MX51_CHIP_REV_1_1;
+		break;
+	case 0x10:
+		cpu_silicon_rev = MX51_CHIP_REV_2_0;
+		break;
+	case 0x20:
+		cpu_silicon_rev = MX51_CHIP_REV_3_0;
+		break;
+	default:
+		cpu_silicon_rev = 0;
+	}
+
+	iounmap(rom);
+}
+
+/*
+ * Returns:
+ *	the silicon revision of the cpu
+ *	-EINVAL - not a mx51
+ */
+int mx51_revision(void)
+{
+	if (!cpu_is_mx51())
+		return -EINVAL;
+
+	if (cpu_silicon_rev == -1)
+		query_silicon_parameter();
+
+	return cpu_silicon_rev;
+}
+EXPORT_SYMBOL(mx51_revision);
+
 static int __init post_cpu_init(void)
 {
 	unsigned int reg;
diff -urN linux-2.6.34-rc3/arch/arm/mach-mx5/mm.c linux-2.6.34-rc4/arch/arm/mach-mx5/mm.c
--- linux-2.6.34-rc3/arch/arm/mach-mx5/mm.c	2010-04-13 02:18:55.162633051 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-mx5/mm.c	2010-04-13 02:19:00.244570454 +0000
@@ -35,11 +35,6 @@
 		.length = MX51_DEBUG_SIZE,
 		.type = MT_DEVICE
 	}, {
-		.virtual = MX51_TZIC_BASE_ADDR_VIRT,
-		.pfn = __phys_to_pfn(MX51_TZIC_BASE_ADDR),
-		.length = MX51_TZIC_SIZE,
-		.type = MT_DEVICE
-	}, {
 		.virtual = MX51_AIPS1_BASE_ADDR_VIRT,
 		.pfn = __phys_to_pfn(MX51_AIPS1_BASE_ADDR),
 		.length = MX51_AIPS1_SIZE,
@@ -54,11 +49,6 @@
 		.pfn = __phys_to_pfn(MX51_AIPS2_BASE_ADDR),
 		.length = MX51_AIPS2_SIZE,
 		.type = MT_DEVICE
-	}, {
-		.virtual = MX51_NFC_AXI_BASE_ADDR_VIRT,
-		.pfn = __phys_to_pfn(MX51_NFC_AXI_BASE_ADDR),
-		.length = MX51_NFC_AXI_SIZE,
-		.type = MT_DEVICE
 	},
 };
 
@@ -69,14 +59,6 @@
  */
 void __init mx51_map_io(void)
 {
-	u32 tzic_addr;
-
-	if (mx51_revision() < MX51_CHIP_REV_2_0)
-		tzic_addr = 0x8FFFC000;
-	else
-		tzic_addr = 0xE0003000;
-	mxc_io_desc[2].pfn =  __phys_to_pfn(tzic_addr);
-
 	mxc_set_cpu_type(MXC_CPU_MX51);
 	mxc_iomux_v3_init(MX51_IO_ADDRESS(MX51_IOMUXC_BASE_ADDR));
 	mxc_arch_reset_init(MX51_IO_ADDRESS(MX51_WDOG_BASE_ADDR));
@@ -85,5 +67,17 @@
 
 void __init mx51_init_irq(void)
 {
-	tzic_init_irq(MX51_IO_ADDRESS(MX51_TZIC_BASE_ADDR));
+	unsigned long tzic_addr;
+	void __iomem *tzic_virt;
+
+	if (mx51_revision() < MX51_CHIP_REV_2_0)
+		tzic_addr = MX51_TZIC_BASE_ADDR_TO1;
+	else
+		tzic_addr = MX51_TZIC_BASE_ADDR;
+
+	tzic_virt = ioremap(tzic_addr, SZ_16K);
+	if (!tzic_virt)
+		panic("unable to map TZIC interrupt controller\n");
+
+	tzic_init_irq(tzic_virt);
 }
diff -urN linux-2.6.34-rc3/arch/arm/mach-netx/fb.c linux-2.6.34-rc4/arch/arm/mach-netx/fb.c
--- linux-2.6.34-rc3/arch/arm/mach-netx/fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-netx/fb.c	2010-04-13 02:19:00.244570454 +0000
@@ -23,6 +23,7 @@
 #include <linux/amba/bus.h>
 #include <linux/amba/clcd.h>
 #include <linux/err.h>
+#include <linux/gfp.h>
 
 #include <asm/irq.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-netx/xc.c linux-2.6.34-rc4/arch/arm/mach-netx/xc.c
--- linux-2.6.34-rc3/arch/arm/mach-netx/xc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-netx/xc.c	2010-04-13 02:19:00.245633077 +0000
@@ -21,6 +21,7 @@
 #include <linux/device.h>
 #include <linux/firmware.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-nomadik/gpio.c linux-2.6.34-rc4/arch/arm/mach-nomadik/gpio.c
--- linux-2.6.34-rc3/arch/arm/mach-nomadik/gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-nomadik/gpio.c	2010-04-13 02:19:00.245633077 +0000
@@ -19,6 +19,7 @@
 #include <linux/spinlock.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/gpio.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ns9xxx/plat-serial8250.c linux-2.6.34-rc4/arch/arm/mach-ns9xxx/plat-serial8250.c
--- linux-2.6.34-rc3/arch/arm/mach-ns9xxx/plat-serial8250.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ns9xxx/plat-serial8250.c	2010-04-13 02:19:00.245633077 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/platform_device.h>
 #include <linux/serial_8250.h>
+#include <linux/slab.h>
 
 #include <mach/regs-board-a9m9750dev.h>
 #include <mach/board.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-ns9xxx/processor-ns9360.c linux-2.6.34-rc4/arch/arm/mach-ns9xxx/processor-ns9360.c
--- linux-2.6.34-rc3/arch/arm/mach-ns9xxx/processor-ns9360.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-ns9xxx/processor-ns9360.c	2010-04-13 02:19:00.245633077 +0000
@@ -10,7 +10,6 @@
  */
 #include <linux/io.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 
 #include <asm/page.h>
 #include <asm/mach/map.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap1/mcbsp.c linux-2.6.34-rc4/arch/arm/mach-omap1/mcbsp.c
--- linux-2.6.34-rc3/arch/arm/mach-omap1/mcbsp.c	2010-04-13 02:18:55.169571889 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap1/mcbsp.c	2010-04-13 02:19:00.250570437 +0000
@@ -16,6 +16,7 @@
 #include <linux/err.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <mach/irqs.h>
 #include <plat/dma.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/clkt2xxx_virt_prcm_set.c linux-2.6.34-rc4/arch/arm/mach-omap2/clkt2xxx_virt_prcm_set.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/clkt2xxx_virt_prcm_set.c	2010-04-13 02:18:55.177633075 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/clkt2xxx_virt_prcm_set.c	2010-04-13 02:19:00.255633017 +0000
@@ -31,6 +31,7 @@
 #include <linux/clk.h>
 #include <linux/io.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 
 #include <plat/clock.h>
 #include <plat/sram.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/iommu2.c linux-2.6.34-rc4/arch/arm/mach-omap2/iommu2.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/iommu2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/iommu2.c	2010-04-13 02:19:00.273633179 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/jiffies.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/stringify.h>
 
 #include <plat/iommu.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/mcbsp.c linux-2.6.34-rc4/arch/arm/mach-omap2/mcbsp.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/mcbsp.c	2010-04-13 02:18:55.204570464 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/mcbsp.c	2010-04-13 02:19:00.273633179 +0000
@@ -16,6 +16,7 @@
 #include <linux/err.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <mach/irqs.h>
 #include <plat/dma.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/mux.c linux-2.6.34-rc4/arch/arm/mach-omap2/mux.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/mux.c	2010-04-13 02:18:55.205633075 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/mux.c	2010-04-13 02:19:00.274590345 +0000
@@ -26,6 +26,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/list.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/pm-debug.c linux-2.6.34-rc4/arch/arm/mach-omap2/pm-debug.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/pm-debug.c	2010-04-13 02:18:55.208633042 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/pm-debug.c	2010-04-13 02:19:00.276633038 +0000
@@ -25,6 +25,7 @@
 #include <linux/err.h>
 #include <linux/io.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <plat/clock.h>
 #include <plat/board.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-omap2/pm34xx.c linux-2.6.34-rc4/arch/arm/mach-omap2/pm34xx.c
--- linux-2.6.34-rc3/arch/arm/mach-omap2/pm34xx.c	2010-04-13 02:18:55.209571758 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-omap2/pm34xx.c	2010-04-13 02:19:00.277633058 +0000
@@ -27,6 +27,7 @@
 #include <linux/gpio.h>
 #include <linux/clk.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <plat/sram.h>
 #include <plat/clockdomain.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-orion5x/pci.c linux-2.6.34-rc4/arch/arm/mach-orion5x/pci.c
--- linux-2.6.34-rc3/arch/arm/mach-orion5x/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-orion5x/pci.c	2010-04-13 02:19:00.283633037 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/mbus.h>
 #include <asm/irq.h>
 #include <asm/mach/pci.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-pnx4008/dma.c linux-2.6.34-rc4/arch/arm/mach-pnx4008/dma.c
--- linux-2.6.34-rc3/arch/arm/mach-pnx4008/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pnx4008/dma.c	2010-04-13 02:19:00.283633037 +0000
@@ -22,6 +22,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-pnx4008/pm.c linux-2.6.34-rc4/arch/arm/mach-pnx4008/pm.c
--- linux-2.6.34-rc3/arch/arm/mach-pnx4008/pm.c	2010-04-13 02:18:55.219571799 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pnx4008/pm.c	2010-04-13 02:19:00.284633021 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/cacheflush.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-pxa/corgi_ssp.c linux-2.6.34-rc4/arch/arm/mach-pxa/corgi_ssp.c
--- linux-2.6.34-rc3/arch/arm/mach-pxa/corgi_ssp.c	2010-04-13 02:18:55.221633158 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pxa/corgi_ssp.c	2010-04-13 02:19:00.285633080 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-pxa/cpufreq-pxa3xx.c linux-2.6.34-rc4/arch/arm/mach-pxa/cpufreq-pxa3xx.c
--- linux-2.6.34-rc3/arch/arm/mach-pxa/cpufreq-pxa3xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pxa/cpufreq-pxa3xx.c	2010-04-13 02:19:00.285633080 +0000
@@ -14,6 +14,7 @@
 #include <linux/sched.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 
 #include <mach/pxa3xx-regs.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-pxa/mioa701.c linux-2.6.34-rc4/arch/arm/mach-pxa/mioa701.c
--- linux-2.6.34-rc3/arch/arm/mach-pxa/mioa701.c	2010-04-13 02:18:55.225633046 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pxa/mioa701.c	2010-04-13 02:19:00.288633041 +0000
@@ -38,6 +38,7 @@
 #include <linux/mtd/physmap.h>
 #include <linux/usb/gpio_vbus.h>
 #include <linux/regulator/max1586.h>
+#include <linux/slab.h>
 
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-pxa/pm.c linux-2.6.34-rc4/arch/arm/mach-pxa/pm.c
--- linux-2.6.34-rc3/arch/arm/mach-pxa/pm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pxa/pm.c	2010-04-13 02:19:00.289633050 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/suspend.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include <mach/pm.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/mach-pxa/viper.c linux-2.6.34-rc4/arch/arm/mach-pxa/viper.c
--- linux-2.6.34-rc3/arch/arm/mach-pxa/viper.c	2010-04-13 02:18:55.231570543 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-pxa/viper.c	2010-04-13 02:19:00.292633113 +0000
@@ -27,6 +27,7 @@
 #include <linux/delay.h>
 #include <linux/fs.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/major.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-realview/core.c linux-2.6.34-rc4/arch/arm/mach-realview/core.c
--- linux-2.6.34-rc3/arch/arm/mach-realview/core.c	2010-04-13 02:18:55.231570543 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-realview/core.c	2010-04-13 02:19:00.292633113 +0000
@@ -31,6 +31,7 @@
 #include <linux/smsc911x.h>
 #include <linux/ata_platform.h>
 #include <linux/amba/mmci.h>
+#include <linux/gfp.h>
 
 #include <asm/clkdev.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-rpc/dma.c linux-2.6.34-rc4/arch/arm/mach-rpc/dma.c
--- linux-2.6.34-rc3/arch/arm/mach-rpc/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-rpc/dma.c	2010-04-13 02:19:00.292633113 +0000
@@ -9,7 +9,6 @@
  *
  *  DMA functions specific to RiscPC architecture
  */
-#include <linux/slab.h>
 #include <linux/mman.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-s3c64xx/dma.c linux-2.6.34-rc4/arch/arm/mach-s3c64xx/dma.c
--- linux-2.6.34-rc3/arch/arm/mach-s3c64xx/dma.c	2010-04-13 02:18:55.253633052 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-s3c64xx/dma.c	2010-04-13 02:19:00.309633054 +0000
@@ -18,6 +18,7 @@
 #include <linux/dmapool.h>
 #include <linux/sysdev.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/clk.h>
 #include <linux/err.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-sa1100/jornada720_ssp.c linux-2.6.34-rc4/arch/arm/mach-sa1100/jornada720_ssp.c
--- linux-2.6.34-rc3/arch/arm/mach-sa1100/jornada720_ssp.c	2010-04-13 02:18:55.266633064 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-sa1100/jornada720_ssp.c	2010-04-13 02:19:00.322633092 +0000
@@ -18,7 +18,6 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/jornada720.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-sa1100/neponset.c linux-2.6.34-rc4/arch/arm/mach-sa1100/neponset.c
--- linux-2.6.34-rc3/arch/arm/mach-sa1100/neponset.c	2010-04-13 02:18:55.266633064 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-sa1100/neponset.c	2010-04-13 02:19:00.323633031 +0000
@@ -8,7 +8,6 @@
 #include <linux/ioport.h>
 #include <linux/serial_core.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <asm/mach-types.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-u300/dummyspichip.c linux-2.6.34-rc4/arch/arm/mach-u300/dummyspichip.c
--- linux-2.6.34-rc3/arch/arm/mach-u300/dummyspichip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-u300/dummyspichip.c	2010-04-13 02:19:00.330633070 +0000
@@ -15,6 +15,7 @@
 #include <linux/mutex.h>
 #include <linux/spi/spi.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 /*
  * WARNING! Do not include this pl022-specific controller header
  * for any generic driver. It is only done in this dummy chip
diff -urN linux-2.6.34-rc3/arch/arm/mach-u300/mmc.c linux-2.6.34-rc4/arch/arm/mach-u300/mmc.c
--- linux-2.6.34-rc3/arch/arm/mach-u300/mmc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-u300/mmc.c	2010-04-13 02:19:00.331633051 +0000
@@ -20,6 +20,7 @@
 #include <linux/regulator/machine.h>
 #include <linux/gpio.h>
 #include <linux/amba/mmci.h>
+#include <linux/slab.h>
 
 #include "mmc.h"
 #include "padmux.h"
diff -urN linux-2.6.34-rc3/arch/arm/mach-versatile/core.c linux-2.6.34-rc4/arch/arm/mach-versatile/core.c
--- linux-2.6.34-rc3/arch/arm/mach-versatile/core.c	2010-04-13 02:18:55.276570118 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-versatile/core.c	2010-04-13 02:19:00.331633051 +0000
@@ -32,6 +32,7 @@
 #include <linux/clockchips.h>
 #include <linux/cnt32_to_63.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <asm/clkdev.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-versatile/pci.c linux-2.6.34-rc4/arch/arm/mach-versatile/pci.c
--- linux-2.6.34-rc3/arch/arm/mach-versatile/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-versatile/pci.c	2010-04-13 02:19:00.332633101 +0000
@@ -16,7 +16,6 @@
  */
 #include <linux/kernel.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/arch/arm/mach-w90x900/dev.c linux-2.6.34-rc4/arch/arm/mach-w90x900/dev.c
--- linux-2.6.34-rc3/arch/arm/mach-w90x900/dev.c	2010-04-13 02:18:55.276570118 +0000
+++ linux-2.6.34-rc4/arch/arm/mach-w90x900/dev.c	2010-04-13 02:19:00.332633101 +0000
@@ -18,6 +18,7 @@
 #include <linux/timer.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <linux/mtd/physmap.h>
 #include <linux/mtd/mtd.h>
diff -urN linux-2.6.34-rc3/arch/arm/mm/Kconfig linux-2.6.34-rc4/arch/arm/mm/Kconfig
--- linux-2.6.34-rc3/arch/arm/mm/Kconfig	2010-04-13 02:18:55.277570198 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/Kconfig	2010-04-13 02:19:00.333633040 +0000
@@ -736,6 +736,12 @@
 config OUTER_CACHE
 	bool
 
+config OUTER_CACHE_SYNC
+	bool
+	help
+	  The outer cache has a outer_cache_fns.sync function pointer
+	  that can be used to drain the write buffer of the outer cache.
+
 config CACHE_FEROCEON_L2
 	bool "Enable the Feroceon L2 cache controller"
 	depends on ARCH_KIRKWOOD || ARCH_MV78XX0
@@ -757,6 +763,7 @@
 		   REALVIEW_EB_A9MP || ARCH_MX35 || ARCH_MX31 || MACH_REALVIEW_PBX || ARCH_NOMADIK || ARCH_OMAP4
 	default y
 	select OUTER_CACHE
+	select OUTER_CACHE_SYNC
 	help
 	  This option enables the L2x0 PrimeCell.
 
@@ -781,3 +788,9 @@
 	int
 	default 6 if ARM_L1_CACHE_SHIFT_6
 	default 5
+
+config ARCH_HAS_BARRIERS
+	bool
+	help
+	  This option allows the use of custom mandatory barriers
+	  included via the mach/barriers.h file.
diff -urN linux-2.6.34-rc3/arch/arm/mm/cache-l2x0.c linux-2.6.34-rc4/arch/arm/mm/cache-l2x0.c
--- linux-2.6.34-rc3/arch/arm/mm/cache-l2x0.c	2010-04-13 02:18:55.277570198 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/cache-l2x0.c	2010-04-13 02:19:00.333633040 +0000
@@ -93,6 +93,15 @@
 }
 #endif
 
+static void l2x0_cache_sync(void)
+{
+	unsigned long flags;
+
+	spin_lock_irqsave(&l2x0_lock, flags);
+	cache_sync();
+	spin_unlock_irqrestore(&l2x0_lock, flags);
+}
+
 static inline void l2x0_inv_all(void)
 {
 	unsigned long flags;
@@ -225,6 +234,7 @@
 	outer_cache.inv_range = l2x0_inv_range;
 	outer_cache.clean_range = l2x0_clean_range;
 	outer_cache.flush_range = l2x0_flush_range;
+	outer_cache.sync = l2x0_cache_sync;
 
 	printk(KERN_INFO "L2X0 cache controller enabled\n");
 }
diff -urN linux-2.6.34-rc3/arch/arm/mm/dma-mapping.c linux-2.6.34-rc4/arch/arm/mm/dma-mapping.c
--- linux-2.6.34-rc3/arch/arm/mm/dma-mapping.c	2010-04-13 02:18:55.279571648 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/dma-mapping.c	2010-04-13 02:19:00.335633053 +0000
@@ -11,7 +11,7 @@
  */
 #include <linux/module.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/errno.h>
 #include <linux/list.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/arm/mm/fault-armv.c linux-2.6.34-rc4/arch/arm/mm/fault-armv.c
--- linux-2.6.34-rc3/arch/arm/mm/fault-armv.c	2010-04-13 02:18:55.279571648 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/fault-armv.c	2010-04-13 02:19:00.335633053 +0000
@@ -16,6 +16,7 @@
 #include <linux/vmalloc.h>
 #include <linux/init.h>
 #include <linux/pagemap.h>
+#include <linux/gfp.h>
 
 #include <asm/bugs.h>
 #include <asm/cacheflush.h>
diff -urN linux-2.6.34-rc3/arch/arm/mm/init.c linux-2.6.34-rc4/arch/arm/mm/init.c
--- linux-2.6.34-rc3/arch/arm/mm/init.c	2010-04-13 02:18:55.279571648 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/init.c	2010-04-13 02:19:00.335633053 +0000
@@ -17,6 +17,7 @@
 #include <linux/initrd.h>
 #include <linux/sort.h>
 #include <linux/highmem.h>
+#include <linux/gfp.h>
 
 #include <asm/mach-types.h>
 #include <asm/sections.h>
diff -urN linux-2.6.34-rc3/arch/arm/mm/mmu.c linux-2.6.34-rc4/arch/arm/mm/mmu.c
--- linux-2.6.34-rc3/arch/arm/mm/mmu.c	2010-04-13 02:18:55.280570651 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/mmu.c	2010-04-13 02:19:00.336633001 +0000
@@ -420,6 +420,10 @@
 		user_pgprot |= L_PTE_SHARED;
 		kern_pgprot |= L_PTE_SHARED;
 		vecs_pgprot |= L_PTE_SHARED;
+		mem_types[MT_DEVICE_WC].prot_sect |= PMD_SECT_S;
+		mem_types[MT_DEVICE_WC].prot_pte |= L_PTE_SHARED;
+		mem_types[MT_DEVICE_CACHED].prot_sect |= PMD_SECT_S;
+		mem_types[MT_DEVICE_CACHED].prot_pte |= L_PTE_SHARED;
 		mem_types[MT_MEMORY].prot_sect |= PMD_SECT_S;
 		mem_types[MT_MEMORY_NONCACHED].prot_sect |= PMD_SECT_S;
 #endif
diff -urN linux-2.6.34-rc3/arch/arm/mm/pgd.c linux-2.6.34-rc4/arch/arm/mm/pgd.c
--- linux-2.6.34-rc3/arch/arm/mm/pgd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/mm/pgd.c	2010-04-13 02:19:00.336633001 +0000
@@ -8,6 +8,7 @@
  * published by the Free Software Foundation.
  */
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include <linux/highmem.h>
 
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/audmux-v2.c linux-2.6.34-rc4/arch/arm/plat-mxc/audmux-v2.c
--- linux-2.6.34-rc3/arch/arm/plat-mxc/audmux-v2.c	2010-04-13 02:18:55.283633059 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/audmux-v2.c	2010-04-13 02:19:00.339633040 +0000
@@ -24,6 +24,7 @@
 #include <linux/io.h>
 #include <linux/clk.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <mach/audmux.h>
 #include <mach/hardware.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/board-mx31_3ds.h linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/board-mx31_3ds.h
--- linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/board-mx31_3ds.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/board-mx31_3ds.h	2010-04-13 02:19:00.340633102 +0000
@@ -0,0 +1,59 @@
+/*
+ * Copyright 2008 Freescale Semiconductor, Inc. All Rights Reserved.
+ */
+
+/*
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#ifndef __ASM_ARCH_MXC_BOARD_MX31_3DS_H__
+#define __ASM_ARCH_MXC_BOARD_MX31_3DS_H__
+
+/* Definitions for components on the Debug board */
+
+/* Base address of CPLD controller on the Debug board */
+#define DEBUG_BASE_ADDRESS		CS5_IO_ADDRESS(CS5_BASE_ADDR)
+
+/* LAN9217 ethernet base address */
+#define LAN9217_BASE_ADDR		CS5_BASE_ADDR
+
+/* CPLD config and interrupt base address */
+#define CPLD_ADDR			(DEBUG_BASE_ADDRESS + 0x20000)
+
+/* LED switchs */
+#define CPLD_LED_REG			(CPLD_ADDR + 0x00)
+/* buttons */
+#define CPLD_SWITCH_BUTTONS_REG	(EXPIO_ADDR + 0x08)
+/* status, interrupt */
+#define CPLD_INT_STATUS_REG		(CPLD_ADDR + 0x10)
+#define CPLD_INT_MASK_REG		(CPLD_ADDR + 0x38)
+#define CPLD_INT_RESET_REG		(CPLD_ADDR + 0x20)
+/* magic word for debug CPLD */
+#define CPLD_MAGIC_NUMBER1_REG		(CPLD_ADDR + 0x40)
+#define CPLD_MAGIC_NUMBER2_REG		(CPLD_ADDR + 0x48)
+/* CPLD code version */
+#define CPLD_CODE_VER_REG		(CPLD_ADDR + 0x50)
+/* magic word for debug CPLD */
+#define CPLD_MAGIC_NUMBER3_REG		(CPLD_ADDR + 0x58)
+/* module reset register */
+#define CPLD_MODULE_RESET_REG		(CPLD_ADDR + 0x60)
+/* CPU ID and Personality ID */
+#define CPLD_MCU_BOARD_ID_REG		(CPLD_ADDR + 0x68)
+
+/* CPLD IRQ line for external uart, external ethernet etc */
+#define EXPIO_PARENT_INT	IOMUX_TO_IRQ(MX31_PIN_GPIO1_1)
+
+#define MXC_EXP_IO_BASE		(MXC_BOARD_IRQ_START)
+#define MXC_IRQ_TO_EXPIO(irq)	((irq) - MXC_EXP_IO_BASE)
+
+#define EXPIO_INT_ENET		(MXC_EXP_IO_BASE + 0)
+#define EXPIO_INT_XUART_A	(MXC_EXP_IO_BASE + 1)
+#define EXPIO_INT_XUART_B	(MXC_EXP_IO_BASE + 2)
+#define EXPIO_INT_BUTTON_A	(MXC_EXP_IO_BASE + 3)
+#define EXPIO_INT_BUTTON_B	(MXC_EXP_IO_BASE + 4)
+
+#define MXC_MAX_EXP_IO_LINES	16
+
+#endif /* __ASM_ARCH_MXC_BOARD_MX31_3DS_H__ */
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/board-mx31pdk.h linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/board-mx31pdk.h
--- linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/board-mx31pdk.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/board-mx31pdk.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,59 +0,0 @@
-/*
- * Copyright 2008 Freescale Semiconductor, Inc. All Rights Reserved.
- */
-
-/*
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- */
-
-#ifndef __ASM_ARCH_MXC_BOARD_MX31PDK_H__
-#define __ASM_ARCH_MXC_BOARD_MX31PDK_H__
-
-/* Definitions for components on the Debug board */
-
-/* Base address of CPLD controller on the Debug board */
-#define DEBUG_BASE_ADDRESS		CS5_IO_ADDRESS(CS5_BASE_ADDR)
-
-/* LAN9217 ethernet base address */
-#define LAN9217_BASE_ADDR		CS5_BASE_ADDR
-
-/* CPLD config and interrupt base address */
-#define CPLD_ADDR			(DEBUG_BASE_ADDRESS + 0x20000)
-
-/* LED switchs */
-#define CPLD_LED_REG			(CPLD_ADDR + 0x00)
-/* buttons */
-#define CPLD_SWITCH_BUTTONS_REG	(EXPIO_ADDR + 0x08)
-/* status, interrupt */
-#define CPLD_INT_STATUS_REG		(CPLD_ADDR + 0x10)
-#define CPLD_INT_MASK_REG		(CPLD_ADDR + 0x38)
-#define CPLD_INT_RESET_REG		(CPLD_ADDR + 0x20)
-/* magic word for debug CPLD */
-#define CPLD_MAGIC_NUMBER1_REG		(CPLD_ADDR + 0x40)
-#define CPLD_MAGIC_NUMBER2_REG		(CPLD_ADDR + 0x48)
-/* CPLD code version */
-#define CPLD_CODE_VER_REG		(CPLD_ADDR + 0x50)
-/* magic word for debug CPLD */
-#define CPLD_MAGIC_NUMBER3_REG		(CPLD_ADDR + 0x58)
-/* module reset register */
-#define CPLD_MODULE_RESET_REG		(CPLD_ADDR + 0x60)
-/* CPU ID and Personality ID */
-#define CPLD_MCU_BOARD_ID_REG		(CPLD_ADDR + 0x68)
-
-/* CPLD IRQ line for external uart, external ethernet etc */
-#define EXPIO_PARENT_INT	IOMUX_TO_IRQ(MX31_PIN_GPIO1_1)
-
-#define MXC_EXP_IO_BASE		(MXC_BOARD_IRQ_START)
-#define MXC_IRQ_TO_EXPIO(irq)	((irq) - MXC_EXP_IO_BASE)
-
-#define EXPIO_INT_ENET		(MXC_EXP_IO_BASE + 0)
-#define EXPIO_INT_XUART_A	(MXC_EXP_IO_BASE + 1)
-#define EXPIO_INT_XUART_B	(MXC_EXP_IO_BASE + 2)
-#define EXPIO_INT_BUTTON_A	(MXC_EXP_IO_BASE + 3)
-#define EXPIO_INT_BUTTON_B	(MXC_EXP_IO_BASE + 4)
-
-#define MXC_MAX_EXP_IO_LINES	16
-
-#endif /* __ASM_ARCH_MXC_BOARD_MX31PDK_H__ */
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/mx51.h linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/mx51.h
--- linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/mx51.h	2010-04-13 02:18:55.290570455 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/mx51.h	2010-04-13 02:19:00.346633028 +0000
@@ -14,7 +14,7 @@
  * FB100000	70000000	1M	SPBA 0
  * FB000000	73F00000	1M	AIPS 1
  * FB200000	83F00000	1M	AIPS 2
- * FA100000	8FFFC000	16K	TZIC (interrupt controller)
+ *		8FFFC000	16K	TZIC (interrupt controller)
  *         	90000000	256M	CSD0 SDRAM/DDR
  *         	A0000000	256M	CSD1 SDRAM/DDR
  *         	B0000000	128M	CS0 Flash
@@ -23,11 +23,17 @@
  *         	C8000000	64M	CS3 Flash
  *         	CC000000	32M	CS4 SRAM
  *         	CE000000	32M	CS5 SRAM
- * F9000000	CFFF0000	64K	NFC (NAND Flash AXI)
+ *		CFFF0000	64K	NFC (NAND Flash AXI)
  *
  */
 
 /*
+ * IROM
+ */
+#define MX51_IROM_BASE_ADDR		0x0
+#define MX51_IROM_SIZE			SZ_64K
+
+/*
  * IRAM
  */
 #define MX51_IRAM_BASE_ADDR		0x1FFE0000	/* internal ram */
@@ -40,7 +46,6 @@
  * NFC
  */
 #define MX51_NFC_AXI_BASE_ADDR		0xCFFF0000	/* NAND flash AXI */
-#define MX51_NFC_AXI_BASE_ADDR_VIRT	0xF9000000
 #define MX51_NFC_AXI_SIZE		SZ_64K
 
 /*
@@ -49,9 +54,8 @@
 #define MX51_GPU_BASE_ADDR		0x20000000
 #define MX51_GPU2D_BASE_ADDR		0xD0000000
 
-#define MX51_TZIC_BASE_ADDR		0x8FFFC000
-#define MX51_TZIC_BASE_ADDR_VIRT	0xFA100000
-#define MX51_TZIC_SIZE			SZ_16K
+#define MX51_TZIC_BASE_ADDR_TO1		0x8FFFC000
+#define MX51_TZIC_BASE_ADDR		0xE0000000
 
 #define MX51_DEBUG_BASE_ADDR		0x60000000
 #define MX51_DEBUG_BASE_ADDR_VIRT	0xFA200000
@@ -232,12 +236,10 @@
 #define MX51_IO_ADDRESS(x)					\
 	(void __iomem *)					\
 	(MX51_IS_MODULE(x, IRAM) ? MX51_IRAM_IO_ADDRESS(x) :	\
-	MX51_IS_MODULE(x, TZIC) ? MX51_TZIC_IO_ADDRESS(x) :	\
 	MX51_IS_MODULE(x, DEBUG) ? MX51_DEBUG_IO_ADDRESS(x) :	\
 	MX51_IS_MODULE(x, SPBA0) ? MX51_SPBA0_IO_ADDRESS(x) :	\
 	MX51_IS_MODULE(x, AIPS1) ? MX51_AIPS1_IO_ADDRESS(x) :	\
-	MX51_IS_MODULE(x, AIPS2) ? MX51_AIPS2_IO_ADDRESS(x) :	\
-	MX51_IS_MODULE(x, NFC_AXI) ? MX51_NFC_AXI_IO_ADDRESS(x) : \
+	MX51_IS_MODULE(x, AIPS2) ? MX51_AIPS2_IO_ADDRESS(x) : \
 	0xDEADBEEF)
 
 /*
@@ -246,9 +248,6 @@
 #define MX51_IRAM_IO_ADDRESS(x)  \
 	(((x) - MX51_IRAM_BASE_ADDR) + MX51_IRAM_BASE_ADDR_VIRT)
 
-#define MX51_TZIC_IO_ADDRESS(x)  \
-	(((x) - MX51_TZIC_BASE_ADDR) + MX51_TZIC_BASE_ADDR_VIRT)
-
 #define MX51_DEBUG_IO_ADDRESS(x)  \
 	(((x) - MX51_DEBUG_BASE_ADDR) + MX51_DEBUG_BASE_ADDR_VIRT)
 
@@ -261,9 +260,6 @@
 #define MX51_AIPS2_IO_ADDRESS(x)  \
 	(((x) - MX51_AIPS2_BASE_ADDR) + MX51_AIPS2_BASE_ADDR_VIRT)
 
-#define MX51_NFC_AXI_IO_ADDRESS(x) \
-	(((x) - MX51_NFC_AXI_BASE_ADDR) + MX51_NFC_AXI_BASE_ADDR_VIRT)
-
 #define MX51_IS_MEM_DEVICE_NONSHARED(x)		0
 
 /*
@@ -443,12 +439,7 @@
 
 #if !defined(__ASSEMBLY__) && !defined(__MXC_BOOT_UNCOMPRESS)
 
-extern unsigned int system_rev;
-
-static inline unsigned int mx51_revision(void)
-{
-	return system_rev;
-}
+extern int mx51_revision(void);
 #endif
 
 #endif	/*  __ASM_ARCH_MXC_MX51_H__ */
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/uncompress.h linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/uncompress.h
--- linux-2.6.34-rc3/arch/arm/plat-mxc/include/mach/uncompress.h	2010-04-13 02:18:55.290570455 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/include/mach/uncompress.h	2010-04-13 02:19:00.346633028 +0000
@@ -66,6 +66,7 @@
 #define MX2X_UART1_BASE_ADDR	0x1000a000
 #define MX3X_UART1_BASE_ADDR	0x43F90000
 #define MX3X_UART2_BASE_ADDR	0x43F94000
+#define MX51_UART1_BASE_ADDR	0x73fbc000
 
 static __inline__ void __arch_decomp_setup(unsigned long arch_id)
 {
@@ -101,6 +102,9 @@
 	case MACH_TYPE_MAGX_ZN5:
 		uart_base = MX3X_UART2_BASE_ADDR;
 		break;
+	case MACH_TYPE_MX51_BABBAGE:
+		uart_base = MX51_UART1_BASE_ADDR;
+		break;
 	default:
 		break;
 	}
diff -urN linux-2.6.34-rc3/arch/arm/plat-mxc/pwm.c linux-2.6.34-rc4/arch/arm/plat-mxc/pwm.c
--- linux-2.6.34-rc3/arch/arm/plat-mxc/pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-mxc/pwm.c	2010-04-13 02:19:00.347633182 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/devices.c linux-2.6.34-rc4/arch/arm/plat-omap/devices.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/devices.c	2010-04-13 02:18:55.292595974 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/devices.c	2010-04-13 02:19:00.348633052 +0000
@@ -14,6 +14,7 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <asm/mach-types.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/dma.c linux-2.6.34-rc4/arch/arm/plat-omap/dma.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/dma.c	2010-04-13 02:18:55.292595974 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/dma.c	2010-04-13 02:19:00.349633110 +0000
@@ -29,6 +29,7 @@
 #include <linux/interrupt.h>
 #include <linux/irq.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/iommu-debug.c linux-2.6.34-rc4/arch/arm/plat-omap/iommu-debug.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/iommu-debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/iommu-debug.c	2010-04-13 02:19:00.354633045 +0000
@@ -13,6 +13,7 @@
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/platform_device.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/iommu.c linux-2.6.34-rc4/arch/arm/plat-omap/iommu.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/iommu.c	2010-04-13 02:18:55.298633077 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/iommu.c	2010-04-13 02:19:00.354633045 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/err.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/clk.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/iovmm.c linux-2.6.34-rc4/arch/arm/plat-omap/iovmm.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/iovmm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/iovmm.c	2010-04-13 02:19:00.355633037 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/device.h>
 #include <linux/scatterlist.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/mailbox.c linux-2.6.34-rc4/arch/arm/plat-omap/mailbox.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/mailbox.c	2010-04-13 02:18:55.298633077 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/mailbox.c	2010-04-13 02:19:00.355633037 +0000
@@ -25,6 +25,7 @@
 #include <linux/interrupt.h>
 #include <linux/device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <plat/mailbox.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/mcbsp.c linux-2.6.34-rc4/arch/arm/plat-omap/mcbsp.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/mcbsp.c	2010-04-13 02:18:55.299571655 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/mcbsp.c	2010-04-13 02:19:00.356633020 +0000
@@ -23,6 +23,7 @@
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <plat/dma.h>
 #include <plat/mcbsp.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-omap/omap_device.c linux-2.6.34-rc4/arch/arm/plat-omap/omap_device.c
--- linux-2.6.34-rc3/arch/arm/plat-omap/omap_device.c	2010-04-13 02:18:55.299571655 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-omap/omap_device.c	2010-04-13 02:19:00.356633020 +0000
@@ -79,6 +79,7 @@
 
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-pxa/dma.c linux-2.6.34-rc4/arch/arm/plat-pxa/dma.c
--- linux-2.6.34-rc3/arch/arm/plat-pxa/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-pxa/dma.c	2010-04-13 02:19:00.356633020 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/interrupt.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-pxa/pwm.c linux-2.6.34-rc4/arch/arm/plat-pxa/pwm.c
--- linux-2.6.34-rc3/arch/arm/plat-pxa/pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-pxa/pwm.c	2010-04-13 02:19:00.356633020 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-s3c24xx/cpu-freq.c linux-2.6.34-rc4/arch/arm/plat-s3c24xx/cpu-freq.c
--- linux-2.6.34-rc3/arch/arm/plat-s3c24xx/cpu-freq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-s3c24xx/cpu-freq.c	2010-04-13 02:19:00.374633425 +0000
@@ -23,6 +23,7 @@
 #include <linux/sysdev.h>
 #include <linux/kobject.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 
 #include <asm/mach/arch.h>
 #include <asm/mach/map.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-s3c24xx/devs.c linux-2.6.34-rc4/arch/arm/plat-s3c24xx/devs.c
--- linux-2.6.34-rc3/arch/arm/plat-s3c24xx/devs.c	2010-04-13 02:18:55.319571813 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-s3c24xx/devs.c	2010-04-13 02:19:00.375633165 +0000
@@ -20,6 +20,7 @@
 #include <linux/serial_core.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/mach/arch.h>
 #include <asm/mach/map.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-s3c24xx/s3c2410-iotiming.c linux-2.6.34-rc4/arch/arm/plat-s3c24xx/s3c2410-iotiming.c
--- linux-2.6.34-rc3/arch/arm/plat-s3c24xx/s3c2410-iotiming.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-s3c24xx/s3c2410-iotiming.c	2010-04-13 02:19:00.376633052 +0000
@@ -17,6 +17,7 @@
 #include <linux/cpufreq.h>
 #include <linux/seq_file.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/map.h>
 #include <mach/regs-mem.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-s3c24xx/s3c2412-iotiming.c linux-2.6.34-rc4/arch/arm/plat-s3c24xx/s3c2412-iotiming.c
--- linux-2.6.34-rc3/arch/arm/plat-s3c24xx/s3c2412-iotiming.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-s3c24xx/s3c2412-iotiming.c	2010-04-13 02:19:00.376633052 +0000
@@ -21,6 +21,7 @@
 #include <linux/delay.h>
 #include <linux/clk.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/amba/pl093.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/adc.c linux-2.6.34-rc4/arch/arm/plat-samsung/adc.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/adc.c	2010-04-13 02:18:55.338633074 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/adc.c	2010-04-13 02:19:00.393633075 +0000
@@ -16,6 +16,7 @@
 #include <linux/platform_device.h>
 #include <linux/sched.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/dev-fb.c linux-2.6.34-rc4/arch/arm/plat-samsung/dev-fb.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/dev-fb.c	2010-04-13 02:18:55.338633074 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/dev-fb.c	2010-04-13 02:19:00.393633075 +0000
@@ -15,6 +15,7 @@
 #include <linux/string.h>
 #include <linux/platform_device.h>
 #include <linux/fb.h>
+#include <linux/gfp.h>
 
 #include <mach/irqs.h>
 #include <mach/map.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/dev-i2c0.c linux-2.6.34-rc4/arch/arm/plat-samsung/dev-i2c0.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/dev-i2c0.c	2010-04-13 02:18:55.339571445 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/dev-i2c0.c	2010-04-13 02:19:00.394633184 +0000
@@ -11,6 +11,7 @@
  * published by the Free Software Foundation.
 */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/dev-i2c1.c linux-2.6.34-rc4/arch/arm/plat-samsung/dev-i2c1.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/dev-i2c1.c	2010-04-13 02:18:55.339571445 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/dev-i2c1.c	2010-04-13 02:19:00.394633184 +0000
@@ -11,6 +11,7 @@
  * published by the Free Software Foundation.
 */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/dev-nand.c linux-2.6.34-rc4/arch/arm/plat-samsung/dev-nand.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/dev-nand.c	2010-04-13 02:18:55.339571445 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/dev-nand.c	2010-04-13 02:19:00.394633184 +0000
@@ -6,6 +6,7 @@
  * published by the Free Software Foundation.
 */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/dev-usb.c linux-2.6.34-rc4/arch/arm/plat-samsung/dev-usb.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/dev-usb.c	2010-04-13 02:18:55.339571445 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/dev-usb.c	2010-04-13 02:19:00.394633184 +0000
@@ -11,6 +11,7 @@
  * published by the Free Software Foundation.
 */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/pm-check.c linux-2.6.34-rc4/arch/arm/plat-samsung/pm-check.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/pm-check.c	2010-04-13 02:18:55.344633063 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/pm-check.c	2010-04-13 02:19:00.399633025 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/crc32.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 
 #include <plat/pm.h>
 
diff -urN linux-2.6.34-rc3/arch/arm/plat-samsung/pwm.c linux-2.6.34-rc4/arch/arm/plat-samsung/pwm.c
--- linux-2.6.34-rc3/arch/arm/plat-samsung/pwm.c	2010-04-13 02:18:55.345633050 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-samsung/pwm.c	2010-04-13 02:19:00.400570483 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/arm/plat-stmp3xxx/dma.c linux-2.6.34-rc4/arch/arm/plat-stmp3xxx/dma.c
--- linux-2.6.34-rc3/arch/arm/plat-stmp3xxx/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/arm/plat-stmp3xxx/dma.c	2010-04-13 02:19:00.401570285 +0000
@@ -15,6 +15,7 @@
  * http://www.opensource.org/licenses/gpl-license.html
  * http://www.gnu.org/copyleft/gpl.html
  */
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <linux/dmapool.h>
diff -urN linux-2.6.34-rc3/arch/arm/vfp/vfpmodule.c linux-2.6.34-rc4/arch/arm/vfp/vfpmodule.c
--- linux-2.6.34-rc3/arch/arm/vfp/vfpmodule.c	2010-04-13 02:18:55.346633075 +0000
+++ linux-2.6.34-rc4/arch/arm/vfp/vfpmodule.c	2010-04-13 02:19:00.401570285 +0000
@@ -545,7 +545,7 @@
 		 */
 		elf_hwcap |= HWCAP_VFP;
 #ifdef CONFIG_VFPv3
-		if (VFP_arch >= 3) {
+		if (VFP_arch >= 2) {
 			elf_hwcap |= HWCAP_VFPv3;
 
 			/*
diff -urN linux-2.6.34-rc3/arch/avr32/kernel/process.c linux-2.6.34-rc4/arch/avr32/kernel/process.c
--- linux-2.6.34-rc3/arch/avr32/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/kernel/process.c	2010-04-13 02:19:00.402570295 +0000
@@ -11,6 +11,7 @@
 #include <linux/fs.h>
 #include <linux/pm.h>
 #include <linux/ptrace.h>
+#include <linux/slab.h>
 #include <linux/reboot.h>
 #include <linux/tick.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/avr32/mach-at32ap/at32ap700x.c linux-2.6.34-rc4/arch/avr32/mach-at32ap/at32ap700x.c
--- linux-2.6.34-rc3/arch/avr32/mach-at32ap/at32ap700x.c	2010-04-13 02:18:55.347633034 +0000
+++ linux-2.6.34-rc4/arch/avr32/mach-at32ap/at32ap700x.c	2010-04-13 02:19:00.402570295 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/spi/spi.h>
 #include <linux/usb/atmel_usba_udc.h>
diff -urN linux-2.6.34-rc3/arch/avr32/mach-at32ap/extint.c linux-2.6.34-rc4/arch/avr32/mach-at32ap/extint.c
--- linux-2.6.34-rc3/arch/avr32/mach-at32ap/extint.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/mach-at32ap/extint.c	2010-04-13 02:19:00.402570295 +0000
@@ -14,6 +14,7 @@
 #include <linux/irq.h>
 #include <linux/platform_device.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/arch/avr32/mach-at32ap/hsmc.c linux-2.6.34-rc4/arch/avr32/mach-at32ap/hsmc.c
--- linux-2.6.34-rc3/arch/avr32/mach-at32ap/hsmc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/mach-at32ap/hsmc.c	2010-04-13 02:19:00.402570295 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <mach/smc.h>
diff -urN linux-2.6.34-rc3/arch/avr32/mm/dma-coherent.c linux-2.6.34-rc4/arch/avr32/mm/dma-coherent.c
--- linux-2.6.34-rc3/arch/avr32/mm/dma-coherent.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/mm/dma-coherent.c	2010-04-13 02:19:00.402570295 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <asm/addrspace.h>
 #include <asm/cacheflush.h>
diff -urN linux-2.6.34-rc3/arch/avr32/mm/init.c linux-2.6.34-rc4/arch/avr32/mm/init.c
--- linux-2.6.34-rc3/arch/avr32/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/mm/init.c	2010-04-13 02:19:00.402570295 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/avr32/mm/ioremap.c linux-2.6.34-rc4/arch/avr32/mm/ioremap.c
--- linux-2.6.34-rc3/arch/avr32/mm/ioremap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/avr32/mm/ioremap.c	2010-04-13 02:19:00.402570295 +0000
@@ -9,6 +9,7 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/pgtable.h>
 #include <asm/addrspace.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/include/asm/mmu_context.h linux-2.6.34-rc4/arch/blackfin/include/asm/mmu_context.h
--- linux-2.6.34-rc3/arch/blackfin/include/asm/mmu_context.h	2010-04-13 02:18:55.357570424 +0000
+++ linux-2.6.34-rc4/arch/blackfin/include/asm/mmu_context.h	2010-04-13 02:19:00.413570552 +0000
@@ -7,7 +7,7 @@
 #ifndef __BLACKFIN_MMU_CONTEXT_H__
 #define __BLACKFIN_MMU_CONTEXT_H__
 
-#include <linux/gfp.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <asm/setup.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/kernel/ipipe.c linux-2.6.34-rc4/arch/blackfin/kernel/ipipe.c
--- linux-2.6.34-rc3/arch/blackfin/kernel/ipipe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/blackfin/kernel/ipipe.c	2010-04-13 02:19:00.415633038 +0000
@@ -27,7 +27,6 @@
 #include <linux/interrupt.h>
 #include <linux/percpu.h>
 #include <linux/bitops.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kthread.h>
 #include <linux/unistd.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/kernel/process.c linux-2.6.34-rc4/arch/blackfin/kernel/process.c
--- linux-2.6.34-rc3/arch/blackfin/kernel/process.c	2010-04-13 02:18:55.360570478 +0000
+++ linux-2.6.34-rc4/arch/blackfin/kernel/process.c	2010-04-13 02:19:00.415633038 +0000
@@ -11,6 +11,7 @@
 #include <linux/unistd.h>
 #include <linux/user.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/tick.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/mach-common/pm.c linux-2.6.34-rc4/arch/blackfin/mach-common/pm.c
--- linux-2.6.34-rc3/arch/blackfin/mach-common/pm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/blackfin/mach-common/pm.c	2010-04-13 02:19:00.425633053 +0000
@@ -11,6 +11,7 @@
 #include <linux/suspend.h>
 #include <linux/sched.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/irq.h>
 
diff -urN linux-2.6.34-rc3/arch/blackfin/mach-common/smp.c linux-2.6.34-rc4/arch/blackfin/mach-common/smp.c
--- linux-2.6.34-rc3/arch/blackfin/mach-common/smp.c	2010-04-13 02:18:55.370570441 +0000
+++ linux-2.6.34-rc4/arch/blackfin/mach-common/smp.c	2010-04-13 02:19:00.426633137 +0000
@@ -21,6 +21,7 @@
 #include <linux/smp.h>
 #include <linux/seq_file.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/cacheflush.h>
 #include <asm/mmu_context.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/mm/init.c linux-2.6.34-rc4/arch/blackfin/mm/init.c
--- linux-2.6.34-rc3/arch/blackfin/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/blackfin/mm/init.c	2010-04-13 02:19:00.426633137 +0000
@@ -4,6 +4,7 @@
  * Licensed under the GPL-2 or later.
  */
 
+#include <linux/gfp.h>
 #include <linux/swap.h>
 #include <linux/bootmem.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/blackfin/mm/isram-driver.c linux-2.6.34-rc4/arch/blackfin/mm/isram-driver.c
--- linux-2.6.34-rc3/arch/blackfin/mm/isram-driver.c	2010-04-13 02:18:55.370570441 +0000
+++ linux-2.6.34-rc4/arch/blackfin/mm/isram-driver.c	2010-04-13 02:19:00.426633137 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/sched.h>
 
diff -urN linux-2.6.34-rc3/arch/blackfin/mm/sram-alloc.c linux-2.6.34-rc4/arch/blackfin/mm/sram-alloc.c
--- linux-2.6.34-rc3/arch/blackfin/mm/sram-alloc.c	2010-04-13 02:18:55.370570441 +0000
+++ linux-2.6.34-rc4/arch/blackfin/mm/sram-alloc.c	2010-04-13 02:19:00.426633137 +0000
@@ -17,6 +17,7 @@
 #include <linux/proc_fs.h>
 #include <linux/spinlock.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 #include <asm/blackfin.h>
 #include <asm/mem_map.h>
 #include "blackfin_sram.h"
diff -urN linux-2.6.34-rc3/arch/cris/arch-v10/drivers/i2c.c linux-2.6.34-rc4/arch/cris/arch-v10/drivers/i2c.c
--- linux-2.6.34-rc3/arch/cris/arch-v10/drivers/i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v10/drivers/i2c.c	2010-04-13 02:19:00.426633137 +0000
@@ -14,7 +14,6 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/arch/cris/arch-v10/drivers/sync_serial.c linux-2.6.34-rc4/arch/cris/arch-v10/drivers/sync_serial.c
--- linux-2.6.34-rc3/arch/cris/arch-v10/drivers/sync_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v10/drivers/sync_serial.c	2010-04-13 02:19:00.426633137 +0000
@@ -17,7 +17,6 @@
 #include <linux/errno.h>
 #include <linux/major.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/poll.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/cris/arch-v10/kernel/process.c linux-2.6.34-rc4/arch/cris/arch-v10/kernel/process.c
--- linux-2.6.34-rc3/arch/cris/arch-v10/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v10/kernel/process.c	2010-04-13 02:19:00.427633017 +0000
@@ -11,9 +11,9 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/fs.h>
-#include <linux/slab.h>
 #include <arch/svinto.h>
 #include <linux/init.h>
 
diff -urN linux-2.6.34-rc3/arch/cris/arch-v32/drivers/i2c.c linux-2.6.34-rc4/arch/cris/arch-v32/drivers/i2c.c
--- linux-2.6.34-rc3/arch/cris/arch-v32/drivers/i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v32/drivers/i2c.c	2010-04-13 02:19:00.428633043 +0000
@@ -27,7 +27,6 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/cris/arch-v32/drivers/pci/dma.c linux-2.6.34-rc4/arch/cris/arch-v32/drivers/pci/dma.c
--- linux-2.6.34-rc3/arch/cris/arch-v32/drivers/pci/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v32/drivers/pci/dma.c	2010-04-13 02:19:00.428633043 +0000
@@ -13,6 +13,7 @@
 #include <linux/mm.h>
 #include <linux/string.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 
 void *dma_alloc_coherent(struct device *dev, size_t size,
diff -urN linux-2.6.34-rc3/arch/cris/arch-v32/drivers/sync_serial.c linux-2.6.34-rc4/arch/cris/arch-v32/drivers/sync_serial.c
--- linux-2.6.34-rc3/arch/cris/arch-v32/drivers/sync_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v32/drivers/sync_serial.c	2010-04-13 02:19:00.428633043 +0000
@@ -13,7 +13,6 @@
 #include <linux/errno.h>
 #include <linux/major.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/interrupt.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/arch/cris/arch-v32/kernel/process.c linux-2.6.34-rc4/arch/cris/arch-v32/kernel/process.c
--- linux-2.6.34-rc3/arch/cris/arch-v32/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v32/kernel/process.c	2010-04-13 02:19:00.428633043 +0000
@@ -9,9 +9,9 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/fs.h>
-#include <linux/slab.h>
 #include <hwregs/reg_rdwr.h>
 #include <hwregs/reg_map.h>
 #include <hwregs/timer_defs.h>
diff -urN linux-2.6.34-rc3/arch/cris/arch-v32/kernel/signal.c linux-2.6.34-rc4/arch/cris/arch-v32/kernel/signal.c
--- linux-2.6.34-rc3/arch/cris/arch-v32/kernel/signal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/arch-v32/kernel/signal.c	2010-04-13 02:19:00.429633040 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/sched.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/signal.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/arch/cris/kernel/irq.c linux-2.6.34-rc4/arch/cris/kernel/irq.c
--- linux-2.6.34-rc3/arch/cris/kernel/irq.c	2010-04-13 02:18:55.373633092 +0000
+++ linux-2.6.34-rc4/arch/cris/kernel/irq.c	2010-04-13 02:19:00.430633061 +0000
@@ -29,7 +29,6 @@
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/init.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/arch/cris/kernel/module.c linux-2.6.34-rc4/arch/cris/kernel/module.c
--- linux-2.6.34-rc3/arch/cris/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/kernel/module.c	2010-04-13 02:19:00.430633061 +0000
@@ -21,6 +21,7 @@
 #include <linux/fs.h>
 #include <linux/string.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #if 0
 #define DEBUGP printk
diff -urN linux-2.6.34-rc3/arch/cris/kernel/profile.c linux-2.6.34-rc4/arch/cris/kernel/profile.c
--- linux-2.6.34-rc3/arch/cris/kernel/profile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/kernel/profile.c	2010-04-13 02:19:00.430633061 +0000
@@ -2,6 +2,7 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <asm/ptrace.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/cris/mm/init.c linux-2.6.34-rc4/arch/cris/mm/init.c
--- linux-2.6.34-rc3/arch/cris/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/cris/mm/init.c	2010-04-13 02:19:00.430633061 +0000
@@ -8,6 +8,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
 #include <asm/tlb.h>
diff -urN linux-2.6.34-rc3/arch/frv/include/asm/segment.h linux-2.6.34-rc4/arch/frv/include/asm/segment.h
--- linux-2.6.34-rc3/arch/frv/include/asm/segment.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/include/asm/segment.h	2010-04-13 02:19:00.430633061 +0000
@@ -21,12 +21,12 @@
 
 #define MAKE_MM_SEG(s)	((mm_segment_t) { (s) })
 
-#define KERNEL_DS		MAKE_MM_SEG(0xdfffffffUL)
-
 #ifdef CONFIG_MMU
 #define USER_DS			MAKE_MM_SEG(TASK_SIZE - 1)
+#define KERNEL_DS		MAKE_MM_SEG(0xdfffffffUL)
 #else
-#define USER_DS			KERNEL_DS
+#define USER_DS			MAKE_MM_SEG(memory_end)
+#define KERNEL_DS		MAKE_MM_SEG(0xe0000000UL)
 #endif
 
 #define get_ds()		(KERNEL_DS)
diff -urN linux-2.6.34-rc3/arch/frv/include/asm/uaccess.h linux-2.6.34-rc4/arch/frv/include/asm/uaccess.h
--- linux-2.6.34-rc3/arch/frv/include/asm/uaccess.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/include/asm/uaccess.h	2010-04-13 02:19:00.431633049 +0000
@@ -27,8 +27,6 @@
 #define VERIFY_READ	0
 #define VERIFY_WRITE	1
 
-#define __addr_ok(addr) ((unsigned long)(addr) < get_addr_limit())
-
 /*
  * check that a range of addresses falls within the current address limit
  */
diff -urN linux-2.6.34-rc3/arch/frv/kernel/irq.c linux-2.6.34-rc4/arch/frv/kernel/irq.c
--- linux-2.6.34-rc3/arch/frv/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/kernel/irq.c	2010-04-13 02:19:00.431633049 +0000
@@ -16,7 +16,6 @@
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/init.h>
 #include <linux/kernel_stat.h>
diff -urN linux-2.6.34-rc3/arch/frv/kernel/sysctl.c linux-2.6.34-rc4/arch/frv/kernel/sysctl.c
--- linux-2.6.34-rc3/arch/frv/kernel/sysctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/kernel/sysctl.c	2010-04-13 02:19:00.431633049 +0000
@@ -9,7 +9,6 @@
  * 2 of the License, or (at your option) any later version.
  */
 
-#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/proc_fs.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-dma.c linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-dma.c
--- linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-dma.c	2010-04-13 02:18:55.374633073 +0000
+++ linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-dma.c	2010-04-13 02:19:00.431633049 +0000
@@ -10,7 +10,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 #include <linux/list.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-irq.c linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-irq.c
--- linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-irq.c	2010-04-13 02:19:00.431633049 +0000
@@ -9,7 +9,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
 
diff -urN linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-vdk.c linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-vdk.c
--- linux-2.6.34-rc3/arch/frv/mb93090-mb00/pci-vdk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/mb93090-mb00/pci-vdk.c	2010-04-13 02:19:00.431633049 +0000
@@ -16,7 +16,6 @@
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 
 #include <asm/segment.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/frv/mm/dma-alloc.c linux-2.6.34-rc4/arch/frv/mm/dma-alloc.c
--- linux-2.6.34-rc3/arch/frv/mm/dma-alloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/mm/dma-alloc.c	2010-04-13 02:19:00.432633054 +0000
@@ -37,6 +37,7 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/hardirq.h>
+#include <linux/gfp.h>
 
 #include <asm/pgalloc.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/frv/mm/init.c linux-2.6.34-rc4/arch/frv/mm/init.c
--- linux-2.6.34-rc3/arch/frv/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/mm/init.c	2010-04-13 02:19:00.432633054 +0000
@@ -19,6 +19,7 @@
 #include <linux/signal.h>
 #include <linux/sched.h>
 #include <linux/pagemap.h>
+#include <linux/gfp.h>
 #include <linux/swap.h>
 #include <linux/mm.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/arch/frv/mm/pgalloc.c linux-2.6.34-rc4/arch/frv/mm/pgalloc.c
--- linux-2.6.34-rc3/arch/frv/mm/pgalloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/frv/mm/pgalloc.c	2010-04-13 02:19:00.432633054 +0000
@@ -10,7 +10,7 @@
  */
 
 #include <linux/sched.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/highmem.h>
 #include <linux/quicklist.h>
diff -urN linux-2.6.34-rc3/arch/h8300/kernel/process.c linux-2.6.34-rc4/arch/h8300/kernel/process.c
--- linux-2.6.34-rc3/arch/h8300/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/h8300/kernel/process.c	2010-04-13 02:19:00.432633054 +0000
@@ -32,11 +32,11 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
 #include <linux/reboot.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/h8300/mm/init.c linux-2.6.34-rc4/arch/h8300/mm/init.c
--- linux-2.6.34-rc3/arch/h8300/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/h8300/mm/init.c	2010-04-13 02:19:00.433633048 +0000
@@ -30,7 +30,7 @@
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 
 #include <asm/setup.h>
 #include <asm/segment.h>
diff -urN linux-2.6.34-rc3/arch/h8300/mm/kmap.c linux-2.6.34-rc4/arch/h8300/mm/kmap.c
--- linux-2.6.34-rc3/arch/h8300/mm/kmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/h8300/mm/kmap.c	2010-04-13 02:19:00.433633048 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/h8300/mm/memory.c linux-2.6.34-rc4/arch/h8300/mm/memory.c
--- linux-2.6.34-rc3/arch/h8300/mm/memory.c	2010-04-13 02:18:55.375633086 +0000
+++ linux-2.6.34-rc4/arch/h8300/mm/memory.c	2010-04-13 02:19:00.433633048 +0000
@@ -21,7 +21,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 
 #include <asm/setup.h>
 #include <asm/segment.h>
diff -urN linux-2.6.34-rc3/arch/ia64/include/asm/dmi.h linux-2.6.34-rc4/arch/ia64/include/asm/dmi.h
--- linux-2.6.34-rc3/arch/ia64/include/asm/dmi.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/include/asm/dmi.h	2010-04-13 02:19:00.441633070 +0000
@@ -1,6 +1,7 @@
 #ifndef _ASM_DMI_H
 #define _ASM_DMI_H 1
 
+#include <linux/slab.h>
 #include <asm/io.h>
 
 /* Use normal IO mappings for DMI */
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/acpi-ext.c linux-2.6.34-rc4/arch/ia64/kernel/acpi-ext.c
--- linux-2.6.34-rc3/arch/ia64/kernel/acpi-ext.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/acpi-ext.c	2010-04-13 02:19:00.442633019 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/acpi.h>
 
 #include <asm/acpi-ext.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/acpi.c linux-2.6.34-rc4/arch/ia64/kernel/acpi.c
--- linux-2.6.34-rc3/arch/ia64/kernel/acpi.c	2010-04-13 02:18:55.385633063 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/acpi.c	2010-04-13 02:19:00.442633019 +0000
@@ -44,6 +44,7 @@
 #include <linux/efi.h>
 #include <linux/mmzone.h>
 #include <linux/nodemask.h>
+#include <linux/slab.h>
 #include <acpi/processor.h>
 #include <asm/io.h>
 #include <asm/iosapic.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/cpufreq/acpi-cpufreq.c linux-2.6.34-rc4/arch/ia64/kernel/cpufreq/acpi-cpufreq.c
--- linux-2.6.34-rc3/arch/ia64/kernel/cpufreq/acpi-cpufreq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/cpufreq/acpi-cpufreq.c	2010-04-13 02:19:00.443633049 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/efi.c linux-2.6.34-rc4/arch/ia64/kernel/efi.c
--- linux-2.6.34-rc3/arch/ia64/kernel/efi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/efi.c	2010-04-13 02:19:00.443633049 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/efi.h>
 #include <linux/kexec.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/iosapic.c linux-2.6.34-rc4/arch/ia64/kernel/iosapic.c
--- linux-2.6.34-rc3/arch/ia64/kernel/iosapic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/iosapic.c	2010-04-13 02:19:00.444633075 +0000
@@ -86,6 +86,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/string.h>
 #include <linux/bootmem.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/irq_ia64.c linux-2.6.34-rc4/arch/ia64/kernel/irq_ia64.c
--- linux-2.6.34-rc3/arch/ia64/kernel/irq_ia64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/irq_ia64.c	2010-04-13 02:19:00.444633075 +0000
@@ -22,7 +22,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/kernel_stat.h>
-#include <linux/slab.h>
 #include <linux/ptrace.h>
 #include <linux/random.h>	/* for rand_initialize_irq() */
 #include <linux/signal.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/mca.c linux-2.6.34-rc4/arch/ia64/kernel/mca.c
--- linux-2.6.34-rc3/arch/ia64/kernel/mca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/mca.c	2010-04-13 02:19:00.445571426 +0000
@@ -85,6 +85,7 @@
 #include <linux/cpumask.h>
 #include <linux/kdebug.h>
 #include <linux/cpu.h>
+#include <linux/gfp.h>
 
 #include <asm/delay.h>
 #include <asm/machvec.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/mca_drv.c linux-2.6.34-rc4/arch/ia64/kernel/mca_drv.c
--- linux-2.6.34-rc3/arch/ia64/kernel/mca_drv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/mca_drv.c	2010-04-13 02:19:00.445571426 +0000
@@ -22,6 +22,7 @@
 #include <linux/smp.h>
 #include <linux/workqueue.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <asm/machvec.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/pci-swiotlb.c linux-2.6.34-rc4/arch/ia64/kernel/pci-swiotlb.c
--- linux-2.6.34-rc3/arch/ia64/kernel/pci-swiotlb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/pci-swiotlb.c	2010-04-13 02:19:00.445571426 +0000
@@ -1,6 +1,7 @@
 /* Glue code to lib/swiotlb.c */
 
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <linux/cache.h>
 #include <linux/module.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/perfmon.c linux-2.6.34-rc4/arch/ia64/kernel/perfmon.c
--- linux-2.6.34-rc3/arch/ia64/kernel/perfmon.c	2010-04-13 02:18:55.387633075 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/perfmon.c	2010-04-13 02:19:00.446633027 +0000
@@ -41,6 +41,7 @@
 #include <linux/rcupdate.h>
 #include <linux/completion.h>
 #include <linux/tracehook.h>
+#include <linux/slab.h>
 
 #include <asm/errno.h>
 #include <asm/intrinsics.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/process.c linux-2.6.34-rc4/arch/ia64/kernel/process.c
--- linux-2.6.34-rc3/arch/ia64/kernel/process.c	2010-04-13 02:18:55.387633075 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/process.c	2010-04-13 02:19:00.446633027 +0000
@@ -15,11 +15,11 @@
 #include <linux/kallsyms.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/notifier.h>
 #include <linux/personality.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/thread_info.h>
 #include <linux/unistd.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/ptrace.c linux-2.6.34-rc4/arch/ia64/kernel/ptrace.c
--- linux-2.6.34-rc3/arch/ia64/kernel/ptrace.c	2010-04-13 02:18:55.387633075 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/ptrace.c	2010-04-13 02:19:00.446633027 +0000
@@ -11,7 +11,6 @@
  */
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/errno.h>
 #include <linux/ptrace.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/topology.c linux-2.6.34-rc4/arch/ia64/kernel/topology.c
--- linux-2.6.34-rc3/arch/ia64/kernel/topology.c	2010-04-13 02:18:55.388633013 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/topology.c	2010-04-13 02:19:00.447633024 +0000
@@ -17,6 +17,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/node.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
 #include <linux/nodemask.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kernel/uncached.c linux-2.6.34-rc4/arch/ia64/kernel/uncached.c
--- linux-2.6.34-rc3/arch/ia64/kernel/uncached.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/kernel/uncached.c	2010-04-13 02:19:00.447633024 +0000
@@ -18,9 +18,9 @@
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/efi.h>
 #include <linux/genalloc.h>
+#include <linux/gfp.h>
 #include <asm/page.h>
 #include <asm/pal.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/ia64/kvm/kvm-ia64.c linux-2.6.34-rc4/arch/ia64/kvm/kvm-ia64.c
--- linux-2.6.34-rc3/arch/ia64/kvm/kvm-ia64.c	2010-04-13 02:18:55.389571773 +0000
+++ linux-2.6.34-rc4/arch/ia64/kvm/kvm-ia64.c	2010-04-13 02:19:00.448633056 +0000
@@ -23,8 +23,8 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/percpu.h>
-#include <linux/gfp.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/kvm_host.h>
 #include <linux/kvm.h>
diff -urN linux-2.6.34-rc3/arch/ia64/mm/discontig.c linux-2.6.34-rc4/arch/ia64/mm/discontig.c
--- linux-2.6.34-rc3/arch/ia64/mm/discontig.c	2010-04-13 02:18:55.389571773 +0000
+++ linux-2.6.34-rc4/arch/ia64/mm/discontig.c	2010-04-13 02:19:00.448633056 +0000
@@ -22,6 +22,7 @@
 #include <linux/acpi.h>
 #include <linux/efi.h>
 #include <linux/nodemask.h>
+#include <linux/slab.h>
 #include <asm/pgalloc.h>
 #include <asm/tlb.h>
 #include <asm/meminit.h>
diff -urN linux-2.6.34-rc3/arch/ia64/mm/hugetlbpage.c linux-2.6.34-rc4/arch/ia64/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/ia64/mm/hugetlbpage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/mm/hugetlbpage.c	2010-04-13 02:19:00.448633056 +0000
@@ -14,7 +14,6 @@
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/log2.h>
 #include <asm/mman.h>
diff -urN linux-2.6.34-rc3/arch/ia64/mm/tlb.c linux-2.6.34-rc4/arch/ia64/mm/tlb.c
--- linux-2.6.34-rc3/arch/ia64/mm/tlb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/mm/tlb.c	2010-04-13 02:19:00.449633143 +0000
@@ -22,6 +22,7 @@
 #include <linux/smp.h>
 #include <linux/mm.h>
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <asm/mmu_context.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/bte.c linux-2.6.34-rc4/arch/ia64/sn/kernel/bte.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/bte.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/bte.c	2010-04-13 02:19:00.449633143 +0000
@@ -19,6 +19,7 @@
 #include <linux/bootmem.h>
 #include <linux/string.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/sn/bte.h>
 
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/io_acpi_init.c linux-2.6.34-rc4/arch/ia64/sn/kernel/io_acpi_init.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/io_acpi_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/io_acpi_init.c	2010-04-13 02:19:00.449633143 +0000
@@ -13,6 +13,7 @@
 #include <asm/sn/sn_sal.h>
 #include "xtalk/hubdev.h"
 #include <linux/acpi.h>
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/io_common.c linux-2.6.34-rc4/arch/ia64/sn/kernel/io_common.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/io_common.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/io_common.c	2010-04-13 02:19:00.449633143 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 #include <asm/sn/types.h>
 #include <asm/sn/addrs.h>
 #include <asm/sn/sn_feature_sets.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/io_init.c linux-2.6.34-rc4/arch/ia64/sn/kernel/io_init.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/io_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/io_init.c	2010-04-13 02:19:00.449633143 +0000
@@ -6,6 +6,7 @@
  * Copyright (C) 1992 - 1997, 2000-2006 Silicon Graphics, Inc. All rights reserved.
  */
 
+#include <linux/slab.h>
 #include <asm/sn/types.h>
 #include <asm/sn/addrs.h>
 #include <asm/sn/io.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/irq.c linux-2.6.34-rc4/arch/ia64/sn/kernel/irq.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/irq.c	2010-04-13 02:19:00.449633143 +0000
@@ -12,6 +12,7 @@
 #include <linux/spinlock.h>
 #include <linux/init.h>
 #include <linux/rculist.h>
+#include <linux/slab.h>
 #include <asm/sn/addrs.h>
 #include <asm/sn/arch.h>
 #include <asm/sn/intr.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/kernel/msi_sn.c linux-2.6.34-rc4/arch/ia64/sn/kernel/msi_sn.c
--- linux-2.6.34-rc3/arch/ia64/sn/kernel/msi_sn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/kernel/msi_sn.c	2010-04-13 02:19:00.450633032 +0000
@@ -11,6 +11,7 @@
 #include <linux/pci.h>
 #include <linux/cpumask.h>
 #include <linux/msi.h>
+#include <linux/slab.h>
 
 #include <asm/sn/addrs.h>
 #include <asm/sn/intr.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/pci/pci_dma.c linux-2.6.34-rc4/arch/ia64/sn/pci/pci_dma.c
--- linux-2.6.34-rc3/arch/ia64/sn/pci/pci_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/pci/pci_dma.c	2010-04-13 02:19:00.450633032 +0000
@@ -9,6 +9,7 @@
  * a description of how these routines should be used.
  */
 
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/dma-mapping.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/pci/pcibr/pcibr_provider.c linux-2.6.34-rc4/arch/ia64/sn/pci/pcibr/pcibr_provider.c
--- linux-2.6.34-rc3/arch/ia64/sn/pci/pcibr/pcibr_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/pci/pcibr/pcibr_provider.c	2010-04-13 02:19:00.450633032 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/interrupt.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <asm/sn/addrs.h>
 #include <asm/sn/geo.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/pci/tioca_provider.c linux-2.6.34-rc4/arch/ia64/sn/pci/tioca_provider.c
--- linux-2.6.34-rc3/arch/ia64/sn/pci/tioca_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/pci/tioca_provider.c	2010-04-13 02:19:00.450633032 +0000
@@ -10,6 +10,7 @@
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/bitmap.h>
+#include <linux/slab.h>
 #include <asm/sn/sn_sal.h>
 #include <asm/sn/addrs.h>
 #include <asm/sn/io.h>
diff -urN linux-2.6.34-rc3/arch/ia64/sn/pci/tioce_provider.c linux-2.6.34-rc4/arch/ia64/sn/pci/tioce_provider.c
--- linux-2.6.34-rc3/arch/ia64/sn/pci/tioce_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/sn/pci/tioce_provider.c	2010-04-13 02:19:00.450633032 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/types.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <asm/sn/sn_sal.h>
 #include <asm/sn/addrs.h>
diff -urN linux-2.6.34-rc3/arch/ia64/xen/grant-table.c linux-2.6.34-rc4/arch/ia64/xen/grant-table.c
--- linux-2.6.34-rc3/arch/ia64/xen/grant-table.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/ia64/xen/grant-table.c	2010-04-13 02:19:00.450633032 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 
 #include <xen/interface/xen.h>
diff -urN linux-2.6.34-rc3/arch/m32r/kernel/process.c linux-2.6.34-rc4/arch/m32r/kernel/process.c
--- linux-2.6.34-rc3/arch/m32r/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m32r/kernel/process.c	2010-04-13 02:19:00.451633044 +0000
@@ -21,10 +21,10 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/ptrace.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/hardirq.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/m32r/mm/init.c linux-2.6.34-rc4/arch/m32r/mm/init.c
--- linux-2.6.34-rc3/arch/m32r/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m32r/mm/init.c	2010-04-13 02:19:00.452633043 +0000
@@ -19,6 +19,7 @@
 #include <linux/bitops.h>
 #include <linux/nodemask.h>
 #include <linux/pfn.h>
+#include <linux/gfp.h>
 #include <asm/types.h>
 #include <asm/processor.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/m68k/bvme6000/rtc.c linux-2.6.34-rc4/arch/m68k/bvme6000/rtc.c
--- linux-2.6.34-rc3/arch/m68k/bvme6000/rtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/bvme6000/rtc.c	2010-04-13 02:19:00.452633043 +0000
@@ -9,7 +9,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/miscdevice.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/ioport.h>
 #include <linux/capability.h>
diff -urN linux-2.6.34-rc3/arch/m68k/kernel/dma.c linux-2.6.34-rc4/arch/m68k/kernel/dma.c
--- linux-2.6.34-rc3/arch/m68k/kernel/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/kernel/dma.c	2010-04-13 02:19:00.454633025 +0000
@@ -10,6 +10,7 @@
 #include <linux/device.h>
 #include <linux/kernel.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/arch/m68k/kernel/process.c linux-2.6.34-rc4/arch/m68k/kernel/process.c
--- linux-2.6.34-rc3/arch/m68k/kernel/process.c	2010-04-13 02:18:55.393575139 +0000
+++ linux-2.6.34-rc4/arch/m68k/kernel/process.c	2010-04-13 02:19:00.454633025 +0000
@@ -15,13 +15,13 @@
 #include <linux/sched.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/smp.h>
 #include <linux/smp_lock.h>
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/reboot.h>
 #include <linux/init_task.h>
diff -urN linux-2.6.34-rc3/arch/m68k/mac/misc.c linux-2.6.34-rc4/arch/m68k/mac/misc.c
--- linux-2.6.34-rc3/arch/m68k/mac/misc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/mac/misc.c	2010-04-13 02:19:00.457633120 +0000
@@ -8,7 +8,6 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/rtc.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/m68k/mm/init.c linux-2.6.34-rc4/arch/m68k/mm/init.c
--- linux-2.6.34-rc3/arch/m68k/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/mm/init.c	2010-04-13 02:19:00.457633120 +0000
@@ -17,6 +17,7 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 
 #include <asm/setup.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/m68k/mm/memory.c linux-2.6.34-rc4/arch/m68k/mm/memory.c
--- linux-2.6.34-rc3/arch/m68k/mm/memory.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/mm/memory.c	2010-04-13 02:19:00.457633120 +0000
@@ -9,9 +9,9 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/pagemap.h>
+#include <linux/gfp.h>
 
 #include <asm/setup.h>
 #include <asm/segment.h>
diff -urN linux-2.6.34-rc3/arch/m68k/mm/motorola.c linux-2.6.34-rc4/arch/m68k/mm/motorola.c
--- linux-2.6.34-rc3/arch/m68k/mm/motorola.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/mm/motorola.c	2010-04-13 02:19:00.457633120 +0000
@@ -18,6 +18,7 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 
 #include <asm/setup.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/m68k/mvme16x/rtc.c linux-2.6.34-rc4/arch/m68k/mvme16x/rtc.c
--- linux-2.6.34-rc3/arch/m68k/mvme16x/rtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/mvme16x/rtc.c	2010-04-13 02:19:00.457633120 +0000
@@ -9,7 +9,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/miscdevice.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/ioport.h>
 #include <linux/capability.h>
diff -urN linux-2.6.34-rc3/arch/m68k/sun3/sun3dvma.c linux-2.6.34-rc4/arch/m68k/sun3/sun3dvma.c
--- linux-2.6.34-rc3/arch/m68k/sun3/sun3dvma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/sun3/sun3dvma.c	2010-04-13 02:19:00.457633120 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/list.h>
 
diff -urN linux-2.6.34-rc3/arch/m68k/sun3x/dvma.c linux-2.6.34-rc4/arch/m68k/sun3x/dvma.c
--- linux-2.6.34-rc3/arch/m68k/sun3x/dvma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68k/sun3x/dvma.c	2010-04-13 02:19:00.458633045 +0000
@@ -15,7 +15,6 @@
 #include <linux/bitops.h>
 #include <linux/mm.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <asm/sun3x.h>
diff -urN linux-2.6.34-rc3/arch/m68knommu/kernel/dma.c linux-2.6.34-rc4/arch/m68knommu/kernel/dma.c
--- linux-2.6.34-rc3/arch/m68knommu/kernel/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68knommu/kernel/dma.c	2010-04-13 02:19:00.458633045 +0000
@@ -6,6 +6,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/arch/m68knommu/kernel/process.c linux-2.6.34-rc4/arch/m68knommu/kernel/process.c
--- linux-2.6.34-rc3/arch/m68knommu/kernel/process.c	2010-04-13 02:18:55.396633015 +0000
+++ linux-2.6.34-rc4/arch/m68knommu/kernel/process.c	2010-04-13 02:19:00.458633045 +0000
@@ -23,11 +23,11 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
 #include <linux/reboot.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/m68knommu/mm/init.c linux-2.6.34-rc4/arch/m68knommu/mm/init.c
--- linux-2.6.34-rc3/arch/m68knommu/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68knommu/mm/init.c	2010-04-13 02:19:00.458633045 +0000
@@ -29,7 +29,7 @@
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 
 #include <asm/setup.h>
 #include <asm/segment.h>
diff -urN linux-2.6.34-rc3/arch/m68knommu/mm/kmap.c linux-2.6.34-rc4/arch/m68knommu/mm/kmap.c
--- linux-2.6.34-rc3/arch/m68knommu/mm/kmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/m68knommu/mm/kmap.c	2010-04-13 02:19:00.458633045 +0000
@@ -9,7 +9,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/m68knommu/mm/memory.c linux-2.6.34-rc4/arch/m68knommu/mm/memory.c
--- linux-2.6.34-rc3/arch/m68knommu/mm/memory.c	2010-04-13 02:18:55.396633015 +0000
+++ linux-2.6.34-rc4/arch/m68knommu/mm/memory.c	2010-04-13 02:19:00.458633045 +0000
@@ -15,7 +15,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 
 #include <asm/segment.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/microblaze/Kconfig linux-2.6.34-rc4/arch/microblaze/Kconfig
--- linux-2.6.34-rc3/arch/microblaze/Kconfig	2010-04-13 02:18:55.396633015 +0000
+++ linux-2.6.34-rc4/arch/microblaze/Kconfig	2010-04-13 02:19:00.458633045 +0000
@@ -75,9 +75,6 @@
 config HAVE_LATENCYTOP_SUPPORT
 	def_bool y
 
-config PCI
-	def_bool n
-
 config DTC
 	def_bool y
 
diff -urN linux-2.6.34-rc3/arch/microblaze/Makefile linux-2.6.34-rc4/arch/microblaze/Makefile
--- linux-2.6.34-rc3/arch/microblaze/Makefile	2010-04-13 02:18:55.397633070 +0000
+++ linux-2.6.34-rc4/arch/microblaze/Makefile	2010-04-13 02:19:00.459633038 +0000
@@ -84,7 +84,7 @@
   echo '* linux.bin    - Create raw binary'
   echo '  linux.bin.gz - Create compressed raw binary'
   echo '  simpleImage.<dt> - ELF image with $(arch)/boot/dts/<dt>.dts linked in'
-  echo '                   - stripped elf with fdt blob
+  echo '                   - stripped elf with fdt blob'
   echo '  simpleImage.<dt>.unstrip - full ELF image with fdt blob'
   echo '  *_defconfig      - Select default config from arch/microblaze/configs'
   echo ''
@@ -94,3 +94,5 @@
   echo '  name of a dts file from the arch/microblaze/boot/dts/ directory'
   echo '  (minus the .dts extension).'
 endef
+
+MRPROPER_FILES += $(boot)/simpleImage.*
diff -urN linux-2.6.34-rc3/arch/microblaze/boot/Makefile linux-2.6.34-rc4/arch/microblaze/boot/Makefile
--- linux-2.6.34-rc3/arch/microblaze/boot/Makefile	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/boot/Makefile	2010-04-13 02:19:00.459633038 +0000
@@ -23,8 +23,6 @@
 endif
 
 $(obj)/linux.bin: vmlinux FORCE
-	[ -n $(CONFIG_INITRAMFS_SOURCE) ] && [ ! -e $(CONFIG_INITRAMFS_SOURCE) ] && \
-	touch $(CONFIG_INITRAMFS_SOURCE) || echo "No CPIO image"
 	$(call if_changed,objcopy)
 	$(call if_changed,uimage)
 	@echo 'Kernel: $@ is ready' ' (#'`cat .version`')'
@@ -62,6 +60,4 @@
 $(obj)/%.dtb: $(dtstree)/%.dts FORCE
 	$(call if_changed,dtc)
 
-clean-kernel += linux.bin linux.bin.gz simpleImage.*
-
-clean-files += *.dtb simpleImage.*.unstrip
+clean-files += *.dtb simpleImage.*.unstrip linux.bin.ub
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/futex.h linux-2.6.34-rc4/arch/microblaze/include/asm/futex.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/futex.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/futex.h	2010-04-13 02:19:00.459633038 +0000
@@ -55,7 +55,7 @@
 		__futex_atomic_op("or %1,%0,%4;", ret, oldval, uaddr, oparg);
 		break;
 	case FUTEX_OP_ANDN:
-		__futex_atomic_op("and %1,%0,%4;", ret, oldval, uaddr, oparg);
+		__futex_atomic_op("andn %1,%0,%4;", ret, oldval, uaddr, oparg);
 		break;
 	case FUTEX_OP_XOR:
 		__futex_atomic_op("xor %1,%0,%4;", ret, oldval, uaddr, oparg);
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/io.h linux-2.6.34-rc4/arch/microblaze/include/asm/io.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/io.h	2010-04-13 02:18:55.397633070 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/io.h	2010-04-13 02:19:00.459633038 +0000
@@ -108,6 +108,11 @@
 #define iowrite16(v, addr)	__raw_writew((u16)(v), (u16 *)(addr))
 #define iowrite32(v, addr)	__raw_writel((u32)(v), (u32 *)(addr))
 
+#define ioread16be(addr)	__raw_readw((u16 *)(addr))
+#define ioread32be(addr)	__raw_readl((u32 *)(addr))
+#define iowrite16be(v, addr)	__raw_writew((u16)(v), (u16 *)(addr))
+#define iowrite32be(v, addr)	__raw_writel((u32)(v), (u32 *)(addr))
+
 /* These are the definitions for the x86 IO instructions
  * inb/inw/inl/outb/outw/outl, the "string" versions
  * insb/insw/insl/outsb/outsw/outsl, and the "pausing" versions
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/processor.h linux-2.6.34-rc4/arch/microblaze/include/asm/processor.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/processor.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/processor.h	2010-04-13 02:19:00.460633095 +0000
@@ -14,7 +14,6 @@
 #include <asm/ptrace.h>
 #include <asm/setup.h>
 #include <asm/registers.h>
-#include <asm/segment.h>
 #include <asm/entry.h>
 #include <asm/current.h>
 
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/segment.h linux-2.6.34-rc4/arch/microblaze/include/asm/segment.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/segment.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/segment.h	1970-01-01 00:00:00.000000000 +0000
@@ -1,49 +0,0 @@
-/*
- * Copyright (C) 2008-2009 Michal Simek <monstr@monstr.eu>
- * Copyright (C) 2008-2009 PetaLogix
- * Copyright (C) 2006 Atmark Techno, Inc.
- *
- * This file is subject to the terms and conditions of the GNU General Public
- * License. See the file "COPYING" in the main directory of this archive
- * for more details.
- */
-
-#ifndef _ASM_MICROBLAZE_SEGMENT_H
-#define _ASM_MICROBLAZE_SEGMENT_H
-
-# ifndef __ASSEMBLY__
-
-typedef struct {
-	unsigned long seg;
-} mm_segment_t;
-
-/*
- * On Microblaze the fs value is actually the top of the corresponding
- * address space.
- *
- * The fs value determines whether argument validity checking should be
- * performed or not. If get_fs() == USER_DS, checking is performed, with
- * get_fs() == KERNEL_DS, checking is bypassed.
- *
- * For historical reasons, these macros are grossly misnamed.
- *
- * For non-MMU arch like Microblaze, KERNEL_DS and USER_DS is equal.
- */
-# define MAKE_MM_SEG(s)       ((mm_segment_t) { (s) })
-
-#  ifndef CONFIG_MMU
-#  define KERNEL_DS	MAKE_MM_SEG(0)
-#  define USER_DS	KERNEL_DS
-#  else
-#  define KERNEL_DS	MAKE_MM_SEG(0xFFFFFFFF)
-#  define USER_DS	MAKE_MM_SEG(TASK_SIZE - 1)
-#  endif
-
-# define get_ds()	(KERNEL_DS)
-# define get_fs()	(current_thread_info()->addr_limit)
-# define set_fs(val)	(current_thread_info()->addr_limit = (val))
-
-# define segment_eq(a, b)	((a).seg == (b).seg)
-
-# endif /* __ASSEMBLY__ */
-#endif /* _ASM_MICROBLAZE_SEGMENT_H */
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/thread_info.h linux-2.6.34-rc4/arch/microblaze/include/asm/thread_info.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/thread_info.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/thread_info.h	2010-04-13 02:19:00.461633074 +0000
@@ -19,7 +19,6 @@
 #ifndef __ASSEMBLY__
 # include <linux/types.h>
 # include <asm/processor.h>
-# include <asm/segment.h>
 
 /*
  * low level task data that entry.S needs immediate access to
@@ -60,6 +59,10 @@
 	__u32	fsr;
 };
 
+typedef struct {
+	unsigned long seg;
+} mm_segment_t;
+
 struct thread_info {
 	struct task_struct	*task; /* main task structure */
 	struct exec_domain	*exec_domain; /* execution domain */
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/tlbflush.h linux-2.6.34-rc4/arch/microblaze/include/asm/tlbflush.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/tlbflush.h	2010-04-13 02:18:55.398633074 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/tlbflush.h	2010-04-13 02:19:00.461633074 +0000
@@ -24,6 +24,7 @@
 extern void _tlbia(void);
 
 #define __tlbia()	{ preempt_disable(); _tlbia(); preempt_enable(); }
+#define __tlbie(x)	{ _tlbie(x); }
 
 static inline void local_flush_tlb_all(void)
 	{ __tlbia(); }
@@ -31,7 +32,7 @@
 	{ __tlbia(); }
 static inline void local_flush_tlb_page(struct vm_area_struct *vma,
 				unsigned long vmaddr)
-	{ _tlbie(vmaddr); }
+	{ __tlbie(vmaddr); }
 static inline void local_flush_tlb_range(struct vm_area_struct *vma,
 		unsigned long start, unsigned long end)
 	{ __tlbia(); }
diff -urN linux-2.6.34-rc3/arch/microblaze/include/asm/uaccess.h linux-2.6.34-rc4/arch/microblaze/include/asm/uaccess.h
--- linux-2.6.34-rc3/arch/microblaze/include/asm/uaccess.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/include/asm/uaccess.h	2010-04-13 02:19:00.461633074 +0000
@@ -22,101 +22,73 @@
 #include <asm/mmu.h>
 #include <asm/page.h>
 #include <asm/pgtable.h>
-#include <asm/segment.h>
 #include <linux/string.h>
 
 #define VERIFY_READ	0
 #define VERIFY_WRITE	1
 
-#define __clear_user(addr, n)	(memset((void *)(addr), 0, (n)), 0)
-
-#ifndef CONFIG_MMU
-
-extern int ___range_ok(unsigned long addr, unsigned long size);
-
-#define __range_ok(addr, size) \
-		___range_ok((unsigned long)(addr), (unsigned long)(size))
-
-#define access_ok(type, addr, size) (__range_ok((addr), (size)) == 0)
-#define __access_ok(add, size) (__range_ok((addr), (size)) == 0)
-
-/* Undefined function to trigger linker error */
-extern int bad_user_access_length(void);
-
-/* FIXME this is function for optimalization -> memcpy */
-#define __get_user(var, ptr)				\
-({							\
-	int __gu_err = 0;				\
-	switch (sizeof(*(ptr))) {			\
-	case 1:						\
-	case 2:						\
-	case 4:						\
-		(var) = *(ptr);				\
-		break;					\
-	case 8:						\
-		memcpy((void *) &(var), (ptr), 8);	\
-		break;					\
-	default:					\
-		(var) = 0;				\
-		__gu_err = __get_user_bad();		\
-		break;					\
-	}						\
-	__gu_err;					\
-})
-
-#define __get_user_bad()	(bad_user_access_length(), (-EFAULT))
+/*
+ * On Microblaze the fs value is actually the top of the corresponding
+ * address space.
+ *
+ * The fs value determines whether argument validity checking should be
+ * performed or not. If get_fs() == USER_DS, checking is performed, with
+ * get_fs() == KERNEL_DS, checking is bypassed.
+ *
+ * For historical reasons, these macros are grossly misnamed.
+ *
+ * For non-MMU arch like Microblaze, KERNEL_DS and USER_DS is equal.
+ */
+# define MAKE_MM_SEG(s)       ((mm_segment_t) { (s) })
 
-/* FIXME is not there defined __pu_val */
-#define __put_user(var, ptr)					\
-({								\
-	int __pu_err = 0;					\
-	switch (sizeof(*(ptr))) {				\
-	case 1:							\
-	case 2:							\
-	case 4:							\
-		*(ptr) = (var);					\
-		break;						\
-	case 8: {						\
-		typeof(*(ptr)) __pu_val = (var);		\
-		memcpy(ptr, &__pu_val, sizeof(__pu_val));	\
-		}						\
-		break;						\
-	default:						\
-		__pu_err = __put_user_bad();			\
-		break;						\
-	}							\
-	__pu_err;						\
-})
+#  ifndef CONFIG_MMU
+#  define KERNEL_DS	MAKE_MM_SEG(0)
+#  define USER_DS	KERNEL_DS
+#  else
+#  define KERNEL_DS	MAKE_MM_SEG(0xFFFFFFFF)
+#  define USER_DS	MAKE_MM_SEG(TASK_SIZE - 1)
+#  endif
+
+# define get_ds()	(KERNEL_DS)
+# define get_fs()	(current_thread_info()->addr_limit)
+# define set_fs(val)	(current_thread_info()->addr_limit = (val))
 
-#define __put_user_bad()	(bad_user_access_length(), (-EFAULT))
+# define segment_eq(a, b)	((a).seg == (b).seg)
 
-#define put_user(x, ptr)	__put_user((x), (ptr))
-#define get_user(x, ptr)	__get_user((x), (ptr))
+/*
+ * The exception table consists of pairs of addresses: the first is the
+ * address of an instruction that is allowed to fault, and the second is
+ * the address at which the program should continue. No registers are
+ * modified, so it is entirely up to the continuation code to figure out
+ * what to do.
+ *
+ * All the routines below use bits of fixup code that are out of line
+ * with the main instruction path. This means when everything is well,
+ * we don't even have to jump over them. Further, they do not intrude
+ * on our cache or tlb entries.
+ */
+struct exception_table_entry {
+	unsigned long insn, fixup;
+};
 
-#define copy_to_user(to, from, n)	(memcpy((to), (from), (n)), 0)
-#define copy_from_user(to, from, n)	(memcpy((to), (from), (n)), 0)
+/* Returns 0 if exception not found and fixup otherwise.  */
+extern unsigned long search_exception_table(unsigned long);
 
-#define __copy_to_user(to, from, n)	(copy_to_user((to), (from), (n)))
-#define __copy_from_user(to, from, n)	(copy_from_user((to), (from), (n)))
-#define __copy_to_user_inatomic(to, from, n) \
-			(__copy_to_user((to), (from), (n)))
-#define __copy_from_user_inatomic(to, from, n) \
-			(__copy_from_user((to), (from), (n)))
+#ifndef CONFIG_MMU
 
-static inline unsigned long clear_user(void *addr, unsigned long size)
+/* Check against bounds of physical memory */
+static inline int ___range_ok(unsigned long addr, unsigned long size)
 {
-	if (access_ok(VERIFY_WRITE, addr, size))
-		size = __clear_user(addr, size);
-	return size;
+	return ((addr < memory_start) ||
+		((addr + size) > memory_end));
 }
 
-/* Returns 0 if exception not found and fixup otherwise.  */
-extern unsigned long search_exception_table(unsigned long);
+#define __range_ok(addr, size) \
+		___range_ok((unsigned long)(addr), (unsigned long)(size))
 
-extern long strncpy_from_user(char *dst, const char *src, long count);
-extern long strnlen_user(const char *src, long count);
+#define access_ok(type, addr, size) (__range_ok((addr), (size)) == 0)
 
-#else /* CONFIG_MMU */
+#else
 
 /*
  * Address is valid if:
@@ -129,24 +101,88 @@
 /* || printk("access_ok failed for %s at 0x%08lx (size %d), seg 0x%08x\n",
  type?"WRITE":"READ",addr,size,get_fs().seg)) */
 
-/*
- * All the __XXX versions macros/functions below do not perform
- * access checking. It is assumed that the necessary checks have been
- * already performed before the finction (macro) is called.
- */
+#endif
 
-#define get_user(x, ptr)						\
-({									\
-	access_ok(VERIFY_READ, (ptr), sizeof(*(ptr)))			\
-		? __get_user((x), (ptr)) : -EFAULT;			\
-})
+#ifdef CONFIG_MMU
+# define __FIXUP_SECTION	".section .fixup,\"ax\"\n"
+# define __EX_TABLE_SECTION	".section __ex_table,\"a\"\n"
+#else
+# define __FIXUP_SECTION	".section .discard,\"ax\"\n"
+# define __EX_TABLE_SECTION	".section .discard,\"a\"\n"
+#endif
 
-#define put_user(x, ptr)						\
-({									\
-	access_ok(VERIFY_WRITE, (ptr), sizeof(*(ptr)))			\
-		? __put_user((x), (ptr)) : -EFAULT;			\
+extern unsigned long __copy_tofrom_user(void __user *to,
+		const void __user *from, unsigned long size);
+
+/* Return: number of not copied bytes, i.e. 0 if OK or non-zero if fail. */
+static inline unsigned long __must_check __clear_user(void __user *to,
+							unsigned long n)
+{
+	/* normal memset with two words to __ex_table */
+	__asm__ __volatile__ (				\
+			"1:	sb	r0, %2, r0;"	\
+			"	addik	%0, %0, -1;"	\
+			"	bneid	%0, 1b;"	\
+			"	addik	%2, %2, 1;"	\
+			"2:			"	\
+			__EX_TABLE_SECTION		\
+			".word	1b,2b;"			\
+			".previous;"			\
+		: "=r"(n)				\
+		: "0"(n), "r"(to)
+	);
+	return n;
+}
+
+static inline unsigned long __must_check clear_user(void __user *to,
+							unsigned long n)
+{
+	might_sleep();
+	if (unlikely(!access_ok(VERIFY_WRITE, to, n)))
+		return n;
+
+	return __clear_user(to, n);
+}
+
+/* put_user and get_user macros */
+extern long __user_bad(void);
+
+#define __get_user_asm(insn, __gu_ptr, __gu_val, __gu_err)	\
+({								\
+	__asm__ __volatile__ (					\
+			"1:"	insn	" %1, %2, r0;"		\
+			"	addk	%0, r0, r0;"		\
+			"2:			"		\
+			__FIXUP_SECTION				\
+			"3:	brid	2b;"			\
+			"	addik	%0, r0, %3;"		\
+			".previous;"				\
+			__EX_TABLE_SECTION			\
+			".word	1b,3b;"				\
+			".previous;"				\
+		: "=&r"(__gu_err), "=r"(__gu_val)		\
+		: "r"(__gu_ptr), "i"(-EFAULT)			\
+	);							\
 })
 
+/**
+ * get_user: - Get a simple variable from user space.
+ * @x:   Variable to store result.
+ * @ptr: Source address, in user space.
+ *
+ * Context: User context only.  This function may sleep.
+ *
+ * This macro copies a single simple variable from user space to kernel
+ * space.  It supports simple types like char and int, but not larger
+ * data types like structures or arrays.
+ *
+ * @ptr must have pointer-to-simple-variable type, and the result of
+ * dereferencing @ptr must be assignable to @x without a cast.
+ *
+ * Returns zero on success, or -EFAULT on error.
+ * On error, the variable @x is set to zero.
+ */
+
 #define __get_user(x, ptr)						\
 ({									\
 	unsigned long __gu_val;						\
@@ -163,30 +199,74 @@
 		__get_user_asm("lw", (ptr), __gu_val, __gu_err);	\
 		break;							\
 	default:							\
-		__gu_val = 0; __gu_err = -EINVAL;			\
+		/* __gu_val = 0; __gu_err = -EINVAL;*/ __gu_err = __user_bad();\
 	}								\
 	x = (__typeof__(*(ptr))) __gu_val;				\
 	__gu_err;							\
 })
 
-#define __get_user_asm(insn, __gu_ptr, __gu_val, __gu_err)		\
+
+#define get_user(x, ptr)						\
 ({									\
-	__asm__ __volatile__ (						\
-			"1:"	insn	" %1, %2, r0;			\
-				addk	%0, r0, r0;			\
-			2:						\
-			.section .fixup,\"ax\";				\
-			3:	brid	2b;				\
-				addik	%0, r0, %3;			\
-			.previous;					\
-			.section __ex_table,\"a\";			\
-			.word	1b,3b;					\
-			.previous;"					\
-		: "=r"(__gu_err), "=r"(__gu_val)			\
-		: "r"(__gu_ptr), "i"(-EFAULT)				\
-	);								\
+	access_ok(VERIFY_READ, (ptr), sizeof(*(ptr)))			\
+		? __get_user((x), (ptr)) : -EFAULT;			\
 })
 
+#define __put_user_asm(insn, __gu_ptr, __gu_val, __gu_err)	\
+({								\
+	__asm__ __volatile__ (					\
+			"1:"	insn	" %1, %2, r0;"		\
+			"	addk	%0, r0, r0;"		\
+			"2:			"		\
+			__FIXUP_SECTION				\
+			"3:	brid	2b;"			\
+			"	addik	%0, r0, %3;"		\
+			".previous;"				\
+			__EX_TABLE_SECTION			\
+			".word	1b,3b;"				\
+			".previous;"				\
+		: "=&r"(__gu_err)				\
+		: "r"(__gu_val), "r"(__gu_ptr), "i"(-EFAULT)	\
+	);							\
+})
+
+#define __put_user_asm_8(__gu_ptr, __gu_val, __gu_err)		\
+({								\
+	__asm__ __volatile__ ("	lwi	%0, %1, 0;"		\
+			"1:	swi	%0, %2, 0;"		\
+			"	lwi	%0, %1, 4;"		\
+			"2:	swi	%0, %2, 4;"		\
+			"	addk	%0, r0, r0;"		\
+			"3:			"		\
+			__FIXUP_SECTION				\
+			"4:	brid	3b;"			\
+			"	addik	%0, r0, %3;"		\
+			".previous;"				\
+			__EX_TABLE_SECTION			\
+			".word	1b,4b,2b,4b;"			\
+			".previous;"				\
+		: "=&r"(__gu_err)				\
+		: "r"(&__gu_val), "r"(__gu_ptr), "i"(-EFAULT)	\
+		);						\
+})
+
+/**
+ * put_user: - Write a simple value into user space.
+ * @x:   Value to copy to user space.
+ * @ptr: Destination address, in user space.
+ *
+ * Context: User context only.  This function may sleep.
+ *
+ * This macro copies a single simple value from kernel space to user
+ * space.  It supports simple types like char and int, but not larger
+ * data types like structures or arrays.
+ *
+ * @ptr must have pointer-to-simple-variable type, and @x must be assignable
+ * to the result of dereferencing @ptr.
+ *
+ * Returns zero on success, or -EFAULT on error.
+ */
+
 #define __put_user(x, ptr)						\
 ({									\
 	__typeof__(*(ptr)) volatile __gu_val = (x);			\
@@ -195,7 +275,7 @@
 	case 1:								\
 		__put_user_asm("sb", (ptr), __gu_val, __gu_err);	\
 		break;							\
-	case 2: 							\
+	case 2:								\
 		__put_user_asm("sh", (ptr), __gu_val, __gu_err);	\
 		break;							\
 	case 4:								\
@@ -205,121 +285,82 @@
 		__put_user_asm_8((ptr), __gu_val, __gu_err);		\
 		break;							\
 	default:							\
-		__gu_err = -EINVAL;					\
+		/*__gu_err = -EINVAL;*/	__gu_err = __user_bad();	\
 	}								\
 	__gu_err;							\
 })
 
-#define __put_user_asm_8(__gu_ptr, __gu_val, __gu_err)	\
-({							\
-__asm__ __volatile__ ("	lwi	%0, %1, 0;		\
-		1:	swi	%0, %2, 0;		\
-			lwi	%0, %1, 4;		\
-		2:	swi	%0, %2, 4;		\
-			addk	%0,r0,r0;		\
-		3:					\
-		.section .fixup,\"ax\";			\
-		4:	brid	3b;			\
-			addik	%0, r0, %3;		\
-		.previous;				\
-		.section __ex_table,\"a\";		\
-		.word	1b,4b,2b,4b;			\
-		.previous;"				\
-	: "=&r"(__gu_err)				\
-	: "r"(&__gu_val),				\
-	"r"(__gu_ptr), "i"(-EFAULT)			\
-	);						\
-})
+#ifndef CONFIG_MMU
 
-#define __put_user_asm(insn, __gu_ptr, __gu_val, __gu_err)	\
-({								\
-	__asm__ __volatile__ (					\
-			"1:"	insn	" %1, %2, r0;		\
-				addk	%0, r0, r0;		\
-			2:					\
-			.section .fixup,\"ax\";			\
-			3:	brid	2b;			\
-				addik	%0, r0, %3;		\
-			.previous;				\
-			.section __ex_table,\"a\";		\
-			.word	1b,3b;				\
-			.previous;"				\
-		: "=r"(__gu_err)				\
-		: "r"(__gu_val), "r"(__gu_ptr), "i"(-EFAULT)	\
-	);							\
-})
+#define put_user(x, ptr)	__put_user((x), (ptr))
 
-/*
- * Return: number of not copied bytes, i.e. 0 if OK or non-zero if fail.
- */
-static inline int clear_user(char *to, int size)
-{
-	if (size && access_ok(VERIFY_WRITE, to, size)) {
-		__asm__ __volatile__ ("				\
-				1:				\
-					sb	r0, %2, r0;	\
-					addik	%0, %0, -1;	\
-					bneid	%0, 1b;		\
-					addik	%2, %2, 1;	\
-				2:				\
-				.section __ex_table,\"a\";	\
-				.word	1b,2b;			\
-				.section .text;"		\
-			: "=r"(size)				\
-			: "0"(size), "r"(to)
-		);
-	}
-	return size;
-}
+#else /* CONFIG_MMU */
 
-#define __copy_from_user(to, from, n)	copy_from_user((to), (from), (n))
+#define put_user(x, ptr)						\
+({									\
+	access_ok(VERIFY_WRITE, (ptr), sizeof(*(ptr)))			\
+		? __put_user((x), (ptr)) : -EFAULT;			\
+})
+#endif /* CONFIG_MMU */
+
+/* copy_to_from_user */
+#define __copy_from_user(to, from, n)	\
+	__copy_tofrom_user((__force void __user *)(to), \
+				(void __user *)(from), (n))
 #define __copy_from_user_inatomic(to, from, n) \
 		copy_from_user((to), (from), (n))
 
-#define copy_to_user(to, from, n)					\
-	(access_ok(VERIFY_WRITE, (to), (n)) ?				\
-		__copy_tofrom_user((void __user *)(to),			\
-			(__force const void __user *)(from), (n))	\
-		: -EFAULT)
+static inline long copy_from_user(void *to,
+		const void __user *from, unsigned long n)
+{
+	might_sleep();
+	if (access_ok(VERIFY_READ, from, n))
+		return __copy_from_user(to, from, n);
+	return n;
+}
 
-#define __copy_to_user(to, from, n)	copy_to_user((to), (from), (n))
+#define __copy_to_user(to, from, n)	\
+		__copy_tofrom_user((void __user *)(to), \
+			(__force const void __user *)(from), (n))
 #define __copy_to_user_inatomic(to, from, n)	copy_to_user((to), (from), (n))
 
-#define copy_from_user(to, from, n)					\
-	(access_ok(VERIFY_READ, (from), (n)) ?				\
-		__copy_tofrom_user((__force void __user *)(to),		\
-			(void __user *)(from), (n))			\
-		: -EFAULT)
+static inline long copy_to_user(void __user *to,
+		const void *from, unsigned long n)
+{
+	might_sleep();
+	if (access_ok(VERIFY_WRITE, to, n))
+		return __copy_to_user(to, from, n);
+	return n;
+}
 
+/*
+ * Copy a null terminated string from userspace.
+ */
 extern int __strncpy_user(char *to, const char __user *from, int len);
-extern int __strnlen_user(const char __user *sstr, int len);
 
-#define strncpy_from_user(to, from, len)	\
-		(access_ok(VERIFY_READ, from, 1) ?	\
-			__strncpy_user(to, from, len) : -EFAULT)
-#define strnlen_user(str, len)	\
-		(access_ok(VERIFY_READ, str, 1) ? __strnlen_user(str, len) : 0)
+#define __strncpy_from_user	__strncpy_user
 
-#endif /* CONFIG_MMU */
-
-extern unsigned long __copy_tofrom_user(void __user *to,
-		const void __user *from, unsigned long size);
+static inline long
+strncpy_from_user(char *dst, const char __user *src, long count)
+{
+	if (!access_ok(VERIFY_READ, src, 1))
+		return -EFAULT;
+	return __strncpy_from_user(dst, src, count);
+}
 
 /*
- * The exception table consists of pairs of addresses: the first is the
- * address of an instruction that is allowed to fault, and the second is
- * the address at which the program should continue. No registers are
- * modified, so it is entirely up to the continuation code to figure out
- * what to do.
+ * Return the size of a string (including the ending 0)
  *
- * All the routines below use bits of fixup code that are out of line
- * with the main instruction path. This means when everything is well,
- * we don't even have to jump over them. Further, they do not intrude
- * on our cache or tlb entries.
+ * Return 0 on exception, a value greater than N if too long
  */
-struct exception_table_entry {
-	unsigned long insn, fixup;
-};
+extern int __strnlen_user(const char __user *sstr, int len);
+
+static inline long strnlen_user(const char __user *src, long n)
+{
+	if (!access_ok(VERIFY_READ, src, 1))
+		return 0;
+	return __strnlen_user(src, n);
+}
 
 #endif  /* __ASSEMBLY__ */
 #endif /* __KERNEL__ */
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/cpu/cpuinfo.c linux-2.6.34-rc4/arch/microblaze/kernel/cpu/cpuinfo.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/cpu/cpuinfo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/cpu/cpuinfo.c	2010-04-13 02:19:00.462633056 +0000
@@ -9,7 +9,6 @@
  */
 
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <asm/cpuinfo.h>
 #include <asm/pvr.h>
 
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/dma.c linux-2.6.34-rc4/arch/microblaze/kernel/dma.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/dma.c	2010-04-13 02:18:55.399571662 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/dma.c	2010-04-13 02:19:00.462633056 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 #include <linux/dma-debug.h>
 #include <asm/bug.h>
 #include <asm/cacheflush.h>
@@ -37,7 +38,7 @@
 
 static unsigned long get_dma_direct_offset(struct device *dev)
 {
-	if (dev)
+	if (likely(dev))
 		return (unsigned long)dev->archdata.dma_data;
 
 	return PCI_DRAM_OFFSET; /* FIXME Not sure if is correct */
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/ftrace.c linux-2.6.34-rc4/arch/microblaze/kernel/ftrace.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/ftrace.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/ftrace.c	2010-04-13 02:19:00.462633056 +0000
@@ -151,13 +151,10 @@
 	return ret;
 }
 
-static int ret_addr; /* initialized as 0 by default */
-
 /* I believe that first is called ftrace_make_nop before this function */
 int ftrace_make_call(struct dyn_ftrace *rec, unsigned long addr)
 {
 	int ret;
-	ret_addr = addr; /* saving where the barrier jump is */
 	pr_debug("%s: addr:0x%x, rec->ip: 0x%x, imm:0x%x\n",
 		__func__, (unsigned int)addr, (unsigned int)rec->ip, imm);
 	ret = ftrace_modify_code(rec->ip, imm);
@@ -194,12 +191,9 @@
 	ret = ftrace_modify_code(ip, upper);
 	ret += ftrace_modify_code(ip + 4, lower);
 
-	/* We just need to remove the rtsd r15, 8 by NOP */
-	BUG_ON(!ret_addr);
-	if (ret_addr)
-		ret += ftrace_modify_code(ret_addr, MICROBLAZE_NOP);
-	else
-		ret = 1; /* fault */
+	/* We just need to replace the rtsd r15, 8 with NOP */
+	ret += ftrace_modify_code((unsigned long)&ftrace_caller,
+				  MICROBLAZE_NOP);
 
 	/* All changes are done - lets do caches consistent */
 	flush_icache();
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/head.S linux-2.6.34-rc4/arch/microblaze/kernel/head.S
--- linux-2.6.34-rc3/arch/microblaze/kernel/head.S	2010-04-13 02:18:55.399571662 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/head.S	2010-04-13 02:19:00.462633056 +0000
@@ -51,6 +51,12 @@
 
 	.text
 ENTRY(_start)
+#if CONFIG_KERNEL_BASE_ADDR == 0
+	brai	TOPHYS(real_start)
+	.org	0x100
+real_start:
+#endif
+
 	mfs	r1, rmsr
 	andi	r1, r1, ~2
 	mts	rmsr, r1
@@ -99,8 +105,8 @@
 	tophys(r4,r4)			/* convert to phys address */
 	ori	r3, r0, COMMAND_LINE_SIZE - 1 /* number of loops */
 _copy_command_line:
-	lbu	r2, r5, r6 /* r7=r5+r6 - r5 contain pointer to command line */
-	sb	r2, r4, r6		/* addr[r4+r6]= r7*/
+	lbu	r2, r5, r6 /* r2=r5+r6 - r5 contain pointer to command line */
+	sb	r2, r4, r6		/* addr[r4+r6]= r2*/
 	addik	r6, r6, 1		/* increment counting */
 	bgtid	r3, _copy_command_line	/* loop for all entries       */
 	addik	r3, r3, -1		/* descrement loop */
@@ -128,7 +134,7 @@
 	 * virtual to physical.
 	 */
 	nop
-	addik	r3, r0, 63		/* Invalidate all TLB entries */
+	addik	r3, r0, MICROBLAZE_TLB_SIZE -1	/* Invalidate all TLB entries */
 _invalidate:
 	mts	rtlbx, r3
 	mts	rtlbhi, r0			/* flush: ensure V is clear   */
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/hw_exception_handler.S linux-2.6.34-rc4/arch/microblaze/kernel/hw_exception_handler.S
--- linux-2.6.34-rc3/arch/microblaze/kernel/hw_exception_handler.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/hw_exception_handler.S	2010-04-13 02:19:00.463633046 +0000
@@ -313,13 +313,13 @@
 	mfs	r5, rmsr;
 	nop
 	swi	r5, r1, 0;
-	mfs	r3, resr
+	mfs	r4, resr
 	nop
-	mfs	r4, rear;
+	mfs	r3, rear;
 	nop
 
 #ifndef CONFIG_MMU
-	andi	r5, r3, 0x1000;		/* Check ESR[DS] */
+	andi	r5, r4, 0x1000;		/* Check ESR[DS] */
 	beqi	r5, not_in_delay_slot;	/* Branch if ESR[DS] not set */
 	mfs	r17, rbtr;	/* ESR[DS] set - return address in BTR */
 	nop
@@ -327,13 +327,14 @@
 	swi	r17, r1, PT_R17
 #endif
 
-	andi	r5, r3, 0x1F;		/* Extract ESR[EXC] */
+	andi	r5, r4, 0x1F;		/* Extract ESR[EXC] */
 
 #ifdef CONFIG_MMU
 	/* Calculate exception vector offset = r5 << 2 */
 	addk	r6, r5, r5; /* << 1 */
 	addk	r6, r6, r6; /* << 2 */
 
+#ifdef DEBUG
 /* counting which exception happen */
 	lwi	r5, r0, 0x200 + TOPHYS(r0_ram)
 	addi	r5, r5, 1
@@ -341,6 +342,7 @@
 	lwi	r5, r6, 0x200 + TOPHYS(r0_ram)
 	addi	r5, r5, 1
 	swi	r5, r6, 0x200 + TOPHYS(r0_ram)
+#endif
 /* end */
 	/* Load the HW Exception vector */
 	lwi	r6, r6, TOPHYS(_MB_HW_ExceptionVectorTable)
@@ -376,7 +378,7 @@
 	swi	r18, r1, PT_R18
 
 	or	r5, r1, r0
-	andi	r6, r3, 0x1F; /* Load ESR[EC] */
+	andi	r6, r4, 0x1F; /* Load ESR[EC] */
 	lwi	r7, r0, PER_CPU(KM) /* MS: saving current kernel mode to regs */
 	swi	r7, r1, PT_MODE
 	mfs	r7, rfsr
@@ -426,11 +428,11 @@
  */
 handle_unaligned_ex:
 	/* Working registers already saved: R3, R4, R5, R6
-	 *  R3 = ESR
-	 *  R4 = EAR
+	 *  R4 = ESR
+	 *  R3 = EAR
 	 */
 #ifdef CONFIG_MMU
-	andi	r6, r3, 0x1000			/* Check ESR[DS] */
+	andi	r6, r4, 0x1000			/* Check ESR[DS] */
 	beqi	r6, _no_delayslot		/* Branch if ESR[DS] not set */
 	mfs	r17, rbtr;	/* ESR[DS] set - return address in BTR */
 	nop
@@ -439,7 +441,7 @@
 	RESTORE_STATE;
 	bri	unaligned_data_trap
 #endif
-	andi	r6, r3, 0x3E0; /* Mask and extract the register operand */
+	andi	r6, r4, 0x3E0; /* Mask and extract the register operand */
 	srl	r6, r6; /* r6 >> 5 */
 	srl	r6, r6;
 	srl	r6, r6;
@@ -448,33 +450,33 @@
 	/* Store the register operand in a temporary location */
 	sbi	r6, r0, TOPHYS(ex_reg_op);
 
-	andi	r6, r3, 0x400; /* Extract ESR[S] */
+	andi	r6, r4, 0x400; /* Extract ESR[S] */
 	bnei	r6, ex_sw;
 ex_lw:
-	andi	r6, r3, 0x800; /* Extract ESR[W] */
+	andi	r6, r4, 0x800; /* Extract ESR[W] */
 	beqi	r6, ex_lhw;
-	lbui	r5, r4, 0; /* Exception address in r4 */
+	lbui	r5, r3, 0; /* Exception address in r3 */
 	/* Load a word, byte-by-byte from destination address
 		and save it in tmp space */
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_0);
-	lbui	r5, r4, 1;
+	lbui	r5, r3, 1;
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_1);
-	lbui	r5, r4, 2;
+	lbui	r5, r3, 2;
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_2);
-	lbui	r5, r4, 3;
+	lbui	r5, r3, 3;
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_3);
-	/* Get the destination register value into r3 */
-	lwi	r3, r0, TOPHYS(ex_tmp_data_loc_0);
+	/* Get the destination register value into r4 */
+	lwi	r4, r0, TOPHYS(ex_tmp_data_loc_0);
 	bri	ex_lw_tail;
 ex_lhw:
-	lbui	r5, r4, 0; /* Exception address in r4 */
+	lbui	r5, r3, 0; /* Exception address in r3 */
 	/* Load a half-word, byte-by-byte from destination
 		address and save it in tmp space */
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_0);
-	lbui	r5, r4, 1;
+	lbui	r5, r3, 1;
 	sbi	r5, r0, TOPHYS(ex_tmp_data_loc_1);
-	/* Get the destination register value into r3 */
-	lhui	r3, r0, TOPHYS(ex_tmp_data_loc_0);
+	/* Get the destination register value into r4 */
+	lhui	r4, r0, TOPHYS(ex_tmp_data_loc_0);
 ex_lw_tail:
 	/* Get the destination register number into r5 */
 	lbui	r5, r0, TOPHYS(ex_reg_op);
@@ -502,25 +504,25 @@
 	andi	r6, r6, 0x800; /* Extract ESR[W] */
 	beqi	r6, ex_shw;
 	/* Get the word - delay slot */
-	swi	r3, r0, TOPHYS(ex_tmp_data_loc_0);
+	swi	r4, r0, TOPHYS(ex_tmp_data_loc_0);
 	/* Store the word, byte-by-byte into destination address */
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_0);
-	sbi	r3, r4, 0;
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_1);
-	sbi	r3, r4, 1;
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_2);
-	sbi	r3, r4, 2;
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_3);
-	sbi	r3, r4, 3;
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_0);
+	sbi	r4, r3, 0;
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_1);
+	sbi	r4, r3, 1;
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_2);
+	sbi	r4, r3, 2;
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_3);
+	sbi	r4, r3, 3;
 	bri	ex_handler_done;
 
 ex_shw:
 	/* Store the lower half-word, byte-by-byte into destination address */
-	swi	r3, r0, TOPHYS(ex_tmp_data_loc_0);
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_2);
-	sbi	r3, r4, 0;
-	lbui	r3, r0, TOPHYS(ex_tmp_data_loc_3);
-	sbi	r3, r4, 1;
+	swi	r4, r0, TOPHYS(ex_tmp_data_loc_0);
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_2);
+	sbi	r4, r3, 0;
+	lbui	r4, r0, TOPHYS(ex_tmp_data_loc_3);
+	sbi	r4, r3, 1;
 ex_sw_end: /* Exception handling of store word, ends. */
 
 ex_handler_done:
@@ -560,21 +562,16 @@
 		 */
 		mfs	r11, rpid
 		nop
-		bri	4
-		mfs	r3, rear		/* Get faulting address */
-		nop
 		/* If we are faulting a kernel address, we have to use the
 		 * kernel page tables.
 		 */
-		ori	r4, r0, CONFIG_KERNEL_START
-		cmpu	r4, r3, r4
-		bgti	r4, ex3
+		ori	r5, r0, CONFIG_KERNEL_START
+		cmpu	r5, r3, r5
+		bgti	r5, ex3
 		/* First, check if it was a zone fault (which means a user
 		 * tried to access a kernel or read-protected page - always
 		 * a SEGV). All other faults here must be stores, so no
 		 * need to check ESR_S as well. */
-		mfs	r4, resr
-		nop
 		andi	r4, r4, 0x800		/* ESR_Z - zone protection */
 		bnei	r4, ex2
 
@@ -589,8 +586,6 @@
 		 * tried to access a kernel or read-protected page - always
 		 * a SEGV). All other faults here must be stores, so no
 		 * need to check ESR_S as well. */
-		mfs	r4, resr
-		nop
 		andi	r4, r4, 0x800		/* ESR_Z */
 		bnei	r4, ex2
 		/* get current task address */
@@ -665,8 +660,6 @@
 		 * R3 = ESR
 		 */
 
-		mfs	r3, rear		/* Get faulting address */
-		nop
 		RESTORE_STATE;
 		bri	page_fault_instr_trap
 
@@ -677,18 +670,15 @@
 	 */
 	handle_data_tlb_miss_exception:
 		/* Working registers already saved: R3, R4, R5, R6
-		 * R3 = ESR
+		 * R3 = EAR, R4 = ESR
 		 */
 		mfs	r11, rpid
 		nop
-		bri	4
-		mfs	r3, rear		/* Get faulting address */
-		nop
 
 		/* If we are faulting a kernel address, we have to use the
 		 * kernel page tables. */
-		ori	r4, r0, CONFIG_KERNEL_START
-		cmpu	r4, r3, r4
+		ori	r6, r0, CONFIG_KERNEL_START
+		cmpu	r4, r3, r6
 		bgti	r4, ex5
 		ori	r4, r0, swapper_pg_dir
 		mts	rpid, r0		/* TLB will have 0 TID */
@@ -731,9 +721,8 @@
 		 * Many of these bits are software only. Bits we don't set
 		 * here we (properly should) assume have the appropriate value.
 		 */
+		brid	finish_tlb_load
 		andni	r4, r4, 0x0ce2		/* Make sure 20, 21 are zero */
-
-		bri	finish_tlb_load
 	ex7:
 		/* The bailout. Restore registers to pre-exception conditions
 		 * and call the heavyweights to help us out.
@@ -754,9 +743,6 @@
 		 */
 		mfs	r11, rpid
 		nop
-		bri	4
-		mfs	r3, rear		/* Get faulting address */
-		nop
 
 		/* If we are faulting a kernel address, we have to use the
 		 * kernel page tables.
@@ -792,7 +778,7 @@
 		lwi	r4, r5, 0		/* Get Linux PTE */
 
 		andi	r6, r4, _PAGE_PRESENT
-		beqi	r6, ex7
+		beqi	r6, ex10
 
 		ori	r4, r4, _PAGE_ACCESSED
 		swi	r4, r5, 0
@@ -805,9 +791,8 @@
 		 * Many of these bits are software only. Bits we don't set
 		 * here we (properly should) assume have the appropriate value.
 		 */
+		brid	finish_tlb_load
 		andni	r4, r4, 0x0ce2		/* Make sure 20, 21 are zero */
-
-		bri	finish_tlb_load
 	ex10:
 		/* The bailout. Restore registers to pre-exception conditions
 		 * and call the heavyweights to help us out.
@@ -837,9 +822,9 @@
 		andi	r5, r5, (MICROBLAZE_TLB_SIZE-1)
 		ori	r6, r0, 1
 		cmp	r31, r5, r6
-		blti	r31, sem
+		blti	r31, ex12
 		addik	r5, r6, 1
-	sem:
+	ex12:
 		/* MS: save back current TLB index */
 		swi	r5, r0, TOPHYS(tlb_index)
 
@@ -859,7 +844,6 @@
 		nop
 
 		/* Done...restore registers and get out of here. */
-	ex12:
 		mts	rpid, r11
 		nop
 		bri 4
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/misc.S linux-2.6.34-rc4/arch/microblaze/kernel/misc.S
--- linux-2.6.34-rc3/arch/microblaze/kernel/misc.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/misc.S	2010-04-13 02:19:00.463633046 +0000
@@ -26,9 +26,10 @@
  * We avoid flushing the pinned 0, 1 and possibly 2 entries.
  */
 .globl _tlbia;
+.type  _tlbia, @function
 .align 4;
 _tlbia:
-	addik	r12, r0, 63 /* flush all entries (63 - 3) */
+	addik	r12, r0, MICROBLAZE_TLB_SIZE - 1 /* flush all entries (63 - 3) */
 	/* isync */
 _tlbia_1:
 	mts	rtlbx, r12
@@ -41,11 +42,13 @@
 	/* sync */
 	rtsd	r15, 8
 	nop
+	.size  _tlbia, . - _tlbia
 
 /*
  * Flush MMU TLB for a particular address (in r5)
  */
 .globl _tlbie;
+.type  _tlbie, @function
 .align 4;
 _tlbie:
 	mts	rtlbsx, r5 /* look up the address in TLB */
@@ -59,17 +62,20 @@
 	rtsd	r15, 8
 	nop
 
+	.size  _tlbie, . - _tlbie
+
 /*
  * Allocate TLB entry for early console
  */
 .globl early_console_reg_tlb_alloc;
+.type  early_console_reg_tlb_alloc, @function
 .align 4;
 early_console_reg_tlb_alloc:
 	/*
 	 * Load a TLB entry for the UART, so that microblaze_progress() can use
 	 * the UARTs nice and early.  We use a 4k real==virtual mapping.
 	 */
-	ori	r4, r0, 63
+	ori	r4, r0, MICROBLAZE_TLB_SIZE - 1
 	mts	rtlbx, r4 /* TLB slot 2 */
 
 	or	r4,r5,r0
@@ -86,6 +92,8 @@
 	rtsd	r15, 8
 	nop
 
+	.size  early_console_reg_tlb_alloc, . - early_console_reg_tlb_alloc
+
 /*
  * Copy a whole page (4096 bytes).
  */
@@ -104,6 +112,7 @@
 #define DCACHE_LINE_BYTES (4 * 4)
 
 .globl copy_page;
+.type  copy_page, @function
 .align 4;
 copy_page:
 	ori	r11, r0, (PAGE_SIZE/DCACHE_LINE_BYTES) - 1
@@ -118,3 +127,5 @@
 	addik	r11, r11, -1
 	rtsd	r15, 8
 	nop
+
+	.size  copy_page, . - copy_page
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/module.c linux-2.6.34-rc4/arch/microblaze/kernel/module.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/module.c	2010-04-13 02:19:00.463633046 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/elf.h>
 #include <linux/vmalloc.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/string.h>
 
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/of_platform.c linux-2.6.34-rc4/arch/microblaze/kernel/of_platform.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/of_platform.c	2010-04-13 02:18:55.399571662 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/of_platform.c	2010-04-13 02:19:00.463633046 +0000
@@ -17,7 +17,6 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/mod_devicetable.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/process.c linux-2.6.34-rc4/arch/microblaze/kernel/process.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/process.c	2010-04-13 02:19:00.463633046 +0000
@@ -15,6 +15,7 @@
 #include <linux/bitops.h>
 #include <asm/system.h>
 #include <asm/pgalloc.h>
+#include <asm/uaccess.h> /* for USER_DS macros */
 #include <asm/cacheflush.h>
 
 void show_regs(struct pt_regs *regs)
@@ -74,7 +75,10 @@
 
 void default_idle(void)
 {
-	if (!hlt_counter) {
+	if (likely(hlt_counter)) {
+		while (!need_resched())
+			cpu_relax();
+	} else {
 		clear_thread_flag(TIF_POLLING_NRFLAG);
 		smp_mb__after_clear_bit();
 		local_irq_disable();
@@ -82,9 +86,7 @@
 			cpu_sleep();
 		local_irq_enable();
 		set_thread_flag(TIF_POLLING_NRFLAG);
-	} else
-		while (!need_resched())
-			cpu_relax();
+	}
 }
 
 void cpu_idle(void)
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/ptrace.c linux-2.6.34-rc4/arch/microblaze/kernel/ptrace.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/ptrace.c	2010-04-13 02:18:55.400570526 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/ptrace.c	2010-04-13 02:19:00.464633079 +0000
@@ -75,7 +75,6 @@
 {
 	int rval;
 	unsigned long val = 0;
-	unsigned long copied;
 
 	switch (request) {
 	/* Read/write the word at location ADDR in the registers. */
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/setup.c linux-2.6.34-rc4/arch/microblaze/kernel/setup.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/setup.c	2010-04-13 02:18:55.400570526 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/setup.c	2010-04-13 02:19:00.464633079 +0000
@@ -92,6 +92,12 @@
 }
 #endif	/* CONFIG_MTD_UCLINUX_EBSS */
 
+#if defined(CONFIG_EARLY_PRINTK) && defined(CONFIG_SERIAL_UARTLITE_CONSOLE)
+#define eprintk early_printk
+#else
+#define eprintk printk
+#endif
+
 void __init machine_early_init(const char *cmdline, unsigned int ram,
 		unsigned int fdt, unsigned int msr)
 {
@@ -139,32 +145,32 @@
 	setup_early_printk(NULL);
 #endif
 
-	early_printk("Ramdisk addr 0x%08x, ", ram);
+	eprintk("Ramdisk addr 0x%08x, ", ram);
 	if (fdt)
-		early_printk("FDT at 0x%08x\n", fdt);
+		eprintk("FDT at 0x%08x\n", fdt);
 	else
-		early_printk("Compiled-in FDT at 0x%08x\n",
+		eprintk("Compiled-in FDT at 0x%08x\n",
 					(unsigned int)_fdt_start);
 
 #ifdef CONFIG_MTD_UCLINUX
-	early_printk("Found romfs @ 0x%08x (0x%08x)\n",
+	eprintk("Found romfs @ 0x%08x (0x%08x)\n",
 			romfs_base, romfs_size);
-	early_printk("#### klimit %p ####\n", old_klimit);
+	eprintk("#### klimit %p ####\n", old_klimit);
 	BUG_ON(romfs_size < 0); /* What else can we do? */
 
-	early_printk("Moved 0x%08x bytes from 0x%08x to 0x%08x\n",
+	eprintk("Moved 0x%08x bytes from 0x%08x to 0x%08x\n",
 			romfs_size, romfs_base, (unsigned)&_ebss);
 
-	early_printk("New klimit: 0x%08x\n", (unsigned)klimit);
+	eprintk("New klimit: 0x%08x\n", (unsigned)klimit);
 #endif
 
 #if CONFIG_XILINX_MICROBLAZE0_USE_MSR_INSTR
 	if (msr)
-		early_printk("!!!Your kernel has setup MSR instruction but "
+		eprintk("!!!Your kernel has setup MSR instruction but "
 				"CPU don't have it %d\n", msr);
 #else
 	if (!msr)
-		early_printk("!!!Your kernel not setup MSR instruction but "
+		eprintk("!!!Your kernel not setup MSR instruction but "
 				"CPU have it %d\n", msr);
 #endif
 
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/sys_microblaze.c linux-2.6.34-rc4/arch/microblaze/kernel/sys_microblaze.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/sys_microblaze.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/sys_microblaze.c	2010-04-13 02:19:00.464633079 +0000
@@ -30,6 +30,7 @@
 #include <linux/semaphore.h>
 #include <linux/uaccess.h>
 #include <linux/unistd.h>
+#include <linux/slab.h>
 
 #include <asm/syscalls.h>
 
diff -urN linux-2.6.34-rc3/arch/microblaze/kernel/traps.c linux-2.6.34-rc4/arch/microblaze/kernel/traps.c
--- linux-2.6.34-rc3/arch/microblaze/kernel/traps.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/kernel/traps.c	2010-04-13 02:19:00.464633079 +0000
@@ -22,13 +22,11 @@
 	__enable_hw_exceptions();
 }
 
-static int kstack_depth_to_print = 24;
+static unsigned long kstack_depth_to_print = 24;
 
 static int __init kstack_setup(char *s)
 {
-	kstack_depth_to_print = strict_strtoul(s, 0, NULL);
-
-	return 1;
+	return !strict_strtoul(s, 0, &kstack_depth_to_print);
 }
 __setup("kstack=", kstack_setup);
 
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/Makefile linux-2.6.34-rc4/arch/microblaze/lib/Makefile
--- linux-2.6.34-rc3/arch/microblaze/lib/Makefile	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/Makefile	2010-04-13 02:19:00.464633079 +0000
@@ -10,5 +10,4 @@
 lib-y += memcpy.o memmove.o
 endif
 
-lib-$(CONFIG_NO_MMU) += uaccess.o
-lib-$(CONFIG_MMU) += uaccess_old.o
+lib-y += uaccess_old.o
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/fastcopy.S linux-2.6.34-rc4/arch/microblaze/lib/fastcopy.S
--- linux-2.6.34-rc3/arch/microblaze/lib/fastcopy.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/fastcopy.S	2010-04-13 02:19:00.464633079 +0000
@@ -30,8 +30,9 @@
  */
 
 #include <linux/linkage.h>
-
+	.text
 	.globl	memcpy
+	.type  memcpy, @function
 	.ent	memcpy
 
 memcpy:
@@ -345,9 +346,11 @@
 	rtsd	r15, 8
 	nop
 
+.size  memcpy, . - memcpy
 .end memcpy
 /*----------------------------------------------------------------------------*/
 	.globl	memmove
+	.type  memmove, @function
 	.ent	memmove
 
 memmove:
@@ -659,4 +662,5 @@
 	rtsd	r15, 8
 	nop
 
+.size  memmove, . - memmove
 .end memmove
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/memcpy.c linux-2.6.34-rc4/arch/microblaze/lib/memcpy.c
--- linux-2.6.34-rc3/arch/microblaze/lib/memcpy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/memcpy.c	2010-04-13 02:19:00.464633079 +0000
@@ -53,7 +53,7 @@
 	const uint32_t *i_src;
 	uint32_t *i_dst;
 
-	if (c >= 4) {
+	if (likely(c >= 4)) {
 		unsigned  value, buf_hold;
 
 		/* Align the dstination to a word boundry. */
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/memset.c linux-2.6.34-rc4/arch/microblaze/lib/memset.c
--- linux-2.6.34-rc3/arch/microblaze/lib/memset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/memset.c	2010-04-13 02:19:00.464633079 +0000
@@ -33,22 +33,23 @@
 #ifdef __HAVE_ARCH_MEMSET
 void *memset(void *v_src, int c, __kernel_size_t n)
 {
-
 	char *src = v_src;
 #ifdef CONFIG_OPT_LIB_FUNCTION
 	uint32_t *i_src;
-	uint32_t w32;
+	uint32_t w32 = 0;
 #endif
 	/* Truncate c to 8 bits */
 	c = (c & 0xFF);
 
 #ifdef CONFIG_OPT_LIB_FUNCTION
-	/* Make a repeating word out of it */
-	w32 = c;
-	w32 |= w32 << 8;
-	w32 |= w32 << 16;
+	if (unlikely(c)) {
+		/* Make a repeating word out of it */
+		w32 = c;
+		w32 |= w32 << 8;
+		w32 |= w32 << 16;
+	}
 
-	if (n >= 4) {
+	if (likely(n >= 4)) {
 		/* Align the destination to a word boundary */
 		/* This is done in an endian independant manner */
 		switch ((unsigned) src & 3) {
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/uaccess.c linux-2.6.34-rc4/arch/microblaze/lib/uaccess.c
--- linux-2.6.34-rc3/arch/microblaze/lib/uaccess.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/uaccess.c	1970-01-01 00:00:00.000000000 +0000
@@ -1,48 +0,0 @@
-/*
- * Copyright (C) 2006 Atmark Techno, Inc.
- *
- * This file is subject to the terms and conditions of the GNU General Public
- * License.  See the file "COPYING" in the main directory of this archive
- * for more details.
- */
-
-#include <linux/string.h>
-#include <asm/uaccess.h>
-
-#include <asm/bug.h>
-
-long strnlen_user(const char __user *src, long count)
-{
-	return strlen(src) + 1;
-}
-
-#define __do_strncpy_from_user(dst, src, count, res)			\
-	do {								\
-		char *tmp;						\
-		strncpy(dst, src, count);				\
-		for (tmp = dst; *tmp && count > 0; tmp++, count--)	\
-			;						\
-		res = (tmp - dst);					\
-	} while (0)
-
-long __strncpy_from_user(char *dst, const char __user *src, long count)
-{
-	long res;
-	__do_strncpy_from_user(dst, src, count, res);
-	return res;
-}
-
-long strncpy_from_user(char *dst, const char __user *src, long count)
-{
-	long res = -EFAULT;
-	if (access_ok(VERIFY_READ, src, 1))
-		__do_strncpy_from_user(dst, src, count, res);
-	return res;
-}
-
-unsigned long __copy_tofrom_user(void __user *to,
-		const void __user *from, unsigned long size)
-{
-	memcpy(to, from, size);
-	return 0;
-}
diff -urN linux-2.6.34-rc3/arch/microblaze/lib/uaccess_old.S linux-2.6.34-rc4/arch/microblaze/lib/uaccess_old.S
--- linux-2.6.34-rc3/arch/microblaze/lib/uaccess_old.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/lib/uaccess_old.S	2010-04-13 02:19:00.465633046 +0000
@@ -22,6 +22,7 @@
 
 	.text
 .globl __strncpy_user;
+.type  __strncpy_user, @function
 .align 4;
 __strncpy_user:
 
@@ -50,7 +51,7 @@
 3:
 	rtsd	r15,8
 	nop
-
+	.size   __strncpy_user, . - __strncpy_user
 
 	.section	.fixup, "ax"
 	.align	2
@@ -72,6 +73,7 @@
 
 	.text
 .globl __strnlen_user;
+.type  __strnlen_user, @function
 .align 4;
 __strnlen_user:
 	addik	r3,r6,0
@@ -90,7 +92,7 @@
 3:
 	rtsd	r15,8
 	nop
-
+	.size   __strnlen_user, . - __strnlen_user
 
 	.section	.fixup,"ax"
 4:
@@ -108,6 +110,7 @@
  */
 	.text
 .globl __copy_tofrom_user;
+.type  __copy_tofrom_user, @function
 .align 4;
 __copy_tofrom_user:
 	/*
@@ -116,20 +119,34 @@
 	 * r7, r3 - count
 	 * r4 - tempval
 	 */
-	addik	r3,r7,0
-	beqi	r3,3f
-1:
-	lbu	r4,r6,r0
-	addik	r6,r6,1
-2:
-	sb	r4,r5,r0
-	addik	r3,r3,-1
-	bneid	r3,1b
-	addik	r5,r5,1		/* delay slot */
+	beqid	r7, 3f /* zero size is not likely */
+	andi	r3, r7, 0x3 /* filter add count */
+	bneid	r3, 4f /* if is odd value then byte copying */
+	or	r3, r5, r6 /* find if is any to/from unaligned */
+	andi	r3, r3, 0x3 /* mask unaligned */
+	bneid	r3, 1f /* it is unaligned -> then jump */
+	or	r3, r0, r0
+
+/* at least one 4 byte copy */
+5:	lw	r4, r6, r3
+6:	sw	r4, r5, r3
+	addik	r7, r7, -4
+	bneid	r7, 5b
+	addik	r3, r3, 4
+	addik	r3, r7, 0
+	rtsd	r15, 8
+	nop
+4:	or	r3, r0, r0
+1:	lbu	r4,r6,r3
+2:	sb	r4,r5,r3
+	addik	r7,r7,-1
+	bneid	r7,1b
+	addik	r3,r3,1		/* delay slot */
 3:
+	addik	r3,r7,0
 	rtsd	r15,8
 	nop
-
+	.size   __copy_tofrom_user, . - __copy_tofrom_user
 
 	.section	__ex_table,"a"
-	.word	1b,3b,2b,3b
+	.word	1b,3b,2b,3b,5b,3b,6b,3b
diff -urN linux-2.6.34-rc3/arch/microblaze/mm/consistent.c linux-2.6.34-rc4/arch/microblaze/mm/consistent.c
--- linux-2.6.34-rc3/arch/microblaze/mm/consistent.c	2010-04-13 02:18:55.400570526 +0000
+++ linux-2.6.34-rc4/arch/microblaze/mm/consistent.c	2010-04-13 02:19:00.465633046 +0000
@@ -32,6 +32,7 @@
 #include <linux/highmem.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
+#include <linux/gfp.h>
 
 #include <asm/pgalloc.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/microblaze/mm/fault.c linux-2.6.34-rc4/arch/microblaze/mm/fault.c
--- linux-2.6.34-rc3/arch/microblaze/mm/fault.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/microblaze/mm/fault.c	2010-04-13 02:19:00.465633046 +0000
@@ -106,7 +106,7 @@
 	regs->esr = error_code;
 
 	/* On a kernel SLB miss we can only check for a valid exception entry */
-	if (kernel_mode(regs) && (address >= TASK_SIZE)) {
+	if (unlikely(kernel_mode(regs) && (address >= TASK_SIZE))) {
 		printk(KERN_WARNING "kernel task_size exceed");
 		_exception(SIGSEGV, regs, code, address);
 	}
@@ -122,7 +122,7 @@
 	}
 #endif /* CONFIG_KGDB */
 
-	if (in_atomic() || !mm) {
+	if (unlikely(in_atomic() || !mm)) {
 		if (kernel_mode(regs))
 			goto bad_area_nosemaphore;
 
@@ -150,7 +150,7 @@
 	 * source.  If this is invalid we can skip the address space check,
 	 * thus avoiding the deadlock.
 	 */
-	if (!down_read_trylock(&mm->mmap_sem)) {
+	if (unlikely(!down_read_trylock(&mm->mmap_sem))) {
 		if (kernel_mode(regs) && !search_exception_tables(regs->pc))
 			goto bad_area_nosemaphore;
 
@@ -158,16 +158,16 @@
 	}
 
 	vma = find_vma(mm, address);
-	if (!vma)
+	if (unlikely(!vma))
 		goto bad_area;
 
 	if (vma->vm_start <= address)
 		goto good_area;
 
-	if (!(vma->vm_flags & VM_GROWSDOWN))
+	if (unlikely(!(vma->vm_flags & VM_GROWSDOWN)))
 		goto bad_area;
 
-	if (!is_write)
+	if (unlikely(!is_write))
 		goto bad_area;
 
 	/*
@@ -179,7 +179,7 @@
 	 * before setting the user r1.  Thus we allow the stack to
 	 * expand to 1MB without further checks.
 	 */
-	if (address + 0x100000 < vma->vm_end) {
+	if (unlikely(address + 0x100000 < vma->vm_end)) {
 
 		/* get user regs even if this fault is in kernel mode */
 		struct pt_regs *uregs = current->thread.regs;
@@ -209,15 +209,15 @@
 	code = SEGV_ACCERR;
 
 	/* a write */
-	if (is_write) {
-		if (!(vma->vm_flags & VM_WRITE))
+	if (unlikely(is_write)) {
+		if (unlikely(!(vma->vm_flags & VM_WRITE)))
 			goto bad_area;
 	/* a read */
 	} else {
 		/* protection fault */
-		if (error_code & 0x08000000)
+		if (unlikely(error_code & 0x08000000))
 			goto bad_area;
-		if (!(vma->vm_flags & (VM_READ | VM_EXEC)))
+		if (unlikely(!(vma->vm_flags & (VM_READ | VM_EXEC))))
 			goto bad_area;
 	}
 
@@ -235,7 +235,7 @@
 			goto do_sigbus;
 		BUG();
 	}
-	if (fault & VM_FAULT_MAJOR)
+	if (unlikely(fault & VM_FAULT_MAJOR))
 		current->maj_flt++;
 	else
 		current->min_flt++;
diff -urN linux-2.6.34-rc3/arch/microblaze/mm/init.c linux-2.6.34-rc4/arch/microblaze/mm/init.c
--- linux-2.6.34-rc3/arch/microblaze/mm/init.c	2010-04-13 02:18:55.400570526 +0000
+++ linux-2.6.34-rc4/arch/microblaze/mm/init.c	2010-04-13 02:19:00.465633046 +0000
@@ -15,6 +15,7 @@
 #include <linux/initrd.h>
 #include <linux/pagemap.h>
 #include <linux/pfn.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 
 #include <asm/page.h>
@@ -165,7 +166,6 @@
 	for (addr = begin; addr < end; addr += PAGE_SIZE) {
 		ClearPageReserved(virt_to_page(addr));
 		init_page_count(virt_to_page(addr));
-		memset((void *)addr, 0xcc, PAGE_SIZE);
 		free_page(addr);
 		totalram_pages++;
 	}
@@ -208,14 +208,6 @@
 }
 
 #ifndef CONFIG_MMU
-/* Check against bounds of physical memory */
-int ___range_ok(unsigned long addr, unsigned long size)
-{
-	return ((addr < memory_start) ||
-		((addr + size) > memory_end));
-}
-EXPORT_SYMBOL(___range_ok);
-
 int page_is_ram(unsigned long pfn)
 {
 	return __range_ok(pfn, 0);
diff -urN linux-2.6.34-rc3/arch/microblaze/mm/pgtable.c linux-2.6.34-rc4/arch/microblaze/mm/pgtable.c
--- linux-2.6.34-rc3/arch/microblaze/mm/pgtable.c	2010-04-13 02:18:55.400570526 +0000
+++ linux-2.6.34-rc4/arch/microblaze/mm/pgtable.c	2010-04-13 02:19:00.466633052 +0000
@@ -154,7 +154,7 @@
 		err = 0;
 		set_pte_at(&init_mm, va, pg, pfn_pte(pa >> PAGE_SHIFT,
 				__pgprot(flags)));
-		if (mem_init_done)
+		if (unlikely(mem_init_done))
 			flush_HPTE(0, va, pmd_val(*pd));
 			/* flush_HPTE(0, va, pg); */
 	}
diff -urN linux-2.6.34-rc3/arch/microblaze/pci/pci-common.c linux-2.6.34-rc4/arch/microblaze/pci/pci-common.c
--- linux-2.6.34-rc3/arch/microblaze/pci/pci-common.c	2010-04-13 02:18:55.401570241 +0000
+++ linux-2.6.34-rc4/arch/microblaze/pci/pci-common.c	2010-04-13 02:19:00.467633084 +0000
@@ -26,6 +26,7 @@
 #include <linux/syscalls.h>
 #include <linux/irq.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/microblaze/pci/pci_32.c linux-2.6.34-rc4/arch/microblaze/pci/pci_32.c
--- linux-2.6.34-rc3/arch/microblaze/pci/pci_32.c	2010-04-13 02:18:55.402570227 +0000
+++ linux-2.6.34-rc4/arch/microblaze/pci/pci_32.c	2010-04-13 02:19:00.467633084 +0000
@@ -14,6 +14,7 @@
 #include <linux/irq.h>
 #include <linux/list.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/mips/alchemy/devboards/db1200/setup.c linux-2.6.34-rc4/arch/mips/alchemy/devboards/db1200/setup.c
--- linux-2.6.34-rc3/arch/mips/alchemy/devboards/db1200/setup.c	2010-04-13 02:18:55.406633040 +0000
+++ linux-2.6.34-rc4/arch/mips/alchemy/devboards/db1200/setup.c	2010-04-13 02:19:00.471633038 +0000
@@ -60,43 +60,6 @@
 	wmb();
 }
 
-/* use the hexleds to count the number of times the cpu has entered
- * wait, the dots to indicate whether the CPU is currently idle or
- * active (dots off = sleeping, dots on = working) for cases where
- * the number doesn't change for a long(er) period of time.
- */
-static void db1200_wait(void)
-{
-	__asm__("	.set	push			\n"
-		"	.set	mips3			\n"
-		"	.set	noreorder		\n"
-		"	cache	0x14, 0(%0)		\n"
-		"	cache	0x14, 32(%0)		\n"
-		"	cache	0x14, 64(%0)		\n"
-		/* dots off: we're about to call wait */
-		"	lui	$26, 0xb980		\n"
-		"	ori	$27, $0, 3		\n"
-		"	sb	$27, 0x18($26)		\n"
-		"	sync				\n"
-		"	nop				\n"
-		"	wait				\n"
-		"	nop				\n"
-		"	nop				\n"
-		"	nop				\n"
-		"	nop				\n"
-		"	nop				\n"
-		/* dots on: there's work to do, increment cntr */
-		"	lui	$26, 0xb980		\n"
-		"	sb	$0, 0x18($26)		\n"
-		"	lui	$26, 0xb9c0		\n"
-		"	lb	$27, 0($26)		\n"
-		"	addiu	$27, $27, 1		\n"
-		"	sb	$27, 0($26)		\n"
-		"	sync				\n"
-		"	.set	pop			\n"
-		: : "r" (db1200_wait));
-}
-
 static int __init db1200_arch_init(void)
 {
 	/* GPIO7 is low-level triggered CPLD cascade */
@@ -110,9 +73,6 @@
 	irq_to_desc(DB1200_SD0_INSERT_INT)->status |= IRQ_NOAUTOEN;
 	irq_to_desc(DB1200_SD0_EJECT_INT)->status |= IRQ_NOAUTOEN;
 
-	if (cpu_wait)
-		cpu_wait = db1200_wait;
-
 	return 0;
 }
 arch_initcall(db1200_arch_init);
diff -urN linux-2.6.34-rc3/arch/mips/ar7/platform.c linux-2.6.34-rc4/arch/mips/ar7/platform.c
--- linux-2.6.34-rc3/arch/mips/ar7/platform.c	2010-04-13 02:18:55.411633049 +0000
+++ linux-2.6.34-rc4/arch/mips/ar7/platform.c	2010-04-13 02:19:00.475633757 +0000
@@ -168,7 +168,7 @@
 		.on	= vlynq_on,
 		.off	= vlynq_off,
 	},
-	.reset_bit	= 26,
+	.reset_bit	= 16,
 	.gpio_bit	= 19,
 };
 
@@ -600,6 +600,7 @@
 	}
 
 	if (ar7_has_high_cpmac()) {
+		res = fixed_phy_add(PHY_POLL, cpmac_high.id, &fixed_phy_status);
 		if (!res) {
 			cpmac_get_mac(1, cpmac_high_data.dev_addr);
 
diff -urN linux-2.6.34-rc3/arch/mips/bcm63xx/boards/board_bcm963xx.c linux-2.6.34-rc4/arch/mips/bcm63xx/boards/board_bcm963xx.c
--- linux-2.6.34-rc3/arch/mips/bcm63xx/boards/board_bcm963xx.c	2010-04-13 02:18:55.411633049 +0000
+++ linux-2.6.34-rc4/arch/mips/bcm63xx/boards/board_bcm963xx.c	2010-04-13 02:19:00.476633262 +0000
@@ -18,6 +18,7 @@
 #include <asm/addrspace.h>
 #include <bcm63xx_board.h>
 #include <bcm63xx_cpu.h>
+#include <bcm63xx_dev_uart.h>
 #include <bcm63xx_regs.h>
 #include <bcm63xx_io.h>
 #include <bcm63xx_dev_pci.h>
@@ -40,6 +41,7 @@
 	.name				= "96338GW",
 	.expected_cpu_id		= 0x6338,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.enet0 = {
 		.force_speed_100	= 1,
@@ -82,6 +84,7 @@
 	.name				= "96338W",
 	.expected_cpu_id		= 0x6338,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.enet0 = {
 		.force_speed_100	= 1,
@@ -126,6 +129,8 @@
 static struct board_info __initdata board_96345gw2 = {
 	.name				= "96345GW2",
 	.expected_cpu_id		= 0x6345,
+
+	.has_uart0			= 1,
 };
 #endif
 
@@ -137,6 +142,7 @@
 	.name				= "96348R",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_pci			= 1,
 
@@ -180,6 +186,7 @@
 	.name				= "96348GW-10",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -239,6 +246,7 @@
 	.name				= "96348GW-11",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -292,6 +300,7 @@
 	.name				= "96348GW",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -349,9 +358,10 @@
 	.name				= "F@ST2404",
 	.expected_cpu_id		= 0x6348,
 
-	.has_enet0			= 1,
-	.has_enet1			= 1,
-	.has_pci			= 1,
+	.has_uart0			= 1,
+        .has_enet0			= 1,
+        .has_enet1			= 1,
+        .has_pci			= 1,
 
 	.enet0 = {
 		.has_phy		= 1,
@@ -368,10 +378,30 @@
 	.has_ehci0			= 1,
 };
 
+static struct board_info __initdata board_rta1025w_16 = {
+	.name				= "RTA1025W_16",
+	.expected_cpu_id		= 0x6348,
+
+	.has_enet0			= 1,
+	.has_enet1			= 1,
+	.has_pci			= 1,
+
+	.enet0 = {
+		.has_phy		= 1,
+		.use_internal_phy	= 1,
+	},
+	.enet1 = {
+		.force_speed_100	= 1,
+		.force_duplex_full	= 1,
+	},
+};
+
+
 static struct board_info __initdata board_DV201AMR = {
 	.name				= "DV201AMR",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_pci			= 1,
 	.has_ohci0			= 1,
 
@@ -391,6 +421,7 @@
 	.name				= "96348GW-A",
 	.expected_cpu_id		= 0x6348,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -416,6 +447,7 @@
 	.name				= "96358VW",
 	.expected_cpu_id		= 0x6358,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -467,6 +499,7 @@
 	.name				= "96358VW2",
 	.expected_cpu_id		= 0x6358,
 
+	.has_uart0			= 1,
 	.has_enet0			= 1,
 	.has_enet1			= 1,
 	.has_pci			= 1,
@@ -514,6 +547,7 @@
 	.name                           = "AGPF-S0",
 	.expected_cpu_id                = 0x6358,
 
+	.has_uart0			= 1,
 	.has_enet0                      = 1,
 	.has_enet1                      = 1,
 	.has_pci                        = 1,
@@ -531,6 +565,27 @@
 	.has_ohci0 = 1,
 	.has_ehci0 = 1,
 };
+
+static struct board_info __initdata board_DWVS0 = {
+	.name				= "DWV-S0",
+	.expected_cpu_id		= 0x6358,
+
+	.has_enet0			= 1,
+	.has_enet1			= 1,
+	.has_pci			= 1,
+
+	.enet0 = {
+		.has_phy		= 1,
+		.use_internal_phy	= 1,
+	},
+
+	.enet1 = {
+		.force_speed_100	= 1,
+		.force_duplex_full	= 1,
+	},
+
+	.has_ohci0			= 1,
+};
 #endif
 
 /*
@@ -552,16 +607,88 @@
 	&board_FAST2404,
 	&board_DV201AMR,
 	&board_96348gw_a,
+	&board_rta1025w_16,
 #endif
 
 #ifdef CONFIG_BCM63XX_CPU_6358
 	&board_96358vw,
 	&board_96358vw2,
 	&board_AGPFS0,
+	&board_DWVS0,
 #endif
 };
 
 /*
+ * Register a sane SPROMv2 to make the on-board
+ * bcm4318 WLAN work
+ */
+#ifdef CONFIG_SSB_PCIHOST
+static struct ssb_sprom bcm63xx_sprom = {
+	.revision		= 0x02,
+	.board_rev		= 0x17,
+	.country_code		= 0x0,
+	.ant_available_bg 	= 0x3,
+	.pa0b0			= 0x15ae,
+	.pa0b1			= 0xfa85,
+	.pa0b2			= 0xfe8d,
+	.pa1b0			= 0xffff,
+	.pa1b1			= 0xffff,
+	.pa1b2			= 0xffff,
+	.gpio0			= 0xff,
+	.gpio1			= 0xff,
+	.gpio2			= 0xff,
+	.gpio3			= 0xff,
+	.maxpwr_bg		= 0x004c,
+	.itssi_bg		= 0x00,
+	.boardflags_lo		= 0x2848,
+	.boardflags_hi		= 0x0000,
+};
+#endif
+
+/*
+ * return board name for /proc/cpuinfo
+ */
+const char *board_get_name(void)
+{
+	return board.name;
+}
+
+/*
+ * register & return a new board mac address
+ */
+static int board_get_mac_address(u8 *mac)
+{
+	u8 *p;
+	int count;
+
+	if (mac_addr_used >= nvram.mac_addr_count) {
+		printk(KERN_ERR PFX "not enough mac address\n");
+		return -ENODEV;
+	}
+
+	memcpy(mac, nvram.mac_addr_base, ETH_ALEN);
+	p = mac + ETH_ALEN - 1;
+	count = mac_addr_used;
+
+	while (count--) {
+		do {
+			(*p)++;
+			if (*p != 0)
+				break;
+			p--;
+		} while (p != mac);
+	}
+
+	if (p == mac) {
+		printk(KERN_ERR PFX "unable to fetch mac address\n");
+		return -ENODEV;
+	}
+
+	mac_addr_used++;
+	return 0;
+}
+
+/*
  * early init callback, read nvram data from flash and checksum it
  */
 void __init board_prom_init(void)
@@ -659,6 +786,17 @@
 	}
 
 	bcm_gpio_writel(val, GPIO_MODE_REG);
+
+	/* Generate MAC address for WLAN and
+	 * register our SPROM */
+#ifdef CONFIG_SSB_PCIHOST
+	if (!board_get_mac_address(bcm63xx_sprom.il0mac)) {
+		memcpy(bcm63xx_sprom.et0mac, bcm63xx_sprom.il0mac, ETH_ALEN);
+		memcpy(bcm63xx_sprom.et1mac, bcm63xx_sprom.il0mac, ETH_ALEN);
+		if (ssb_arch_set_fallback_sprom(&bcm63xx_sprom) < 0)
+			printk(KERN_ERR "failed to register fallback SPROM\n");
+	}
+#endif
 }
 
 /*
@@ -676,49 +814,6 @@
 		panic("unexpected CPU for bcm963xx board");
 }
 
-/*
- * return board name for /proc/cpuinfo
- */
-const char *board_get_name(void)
-{
-	return board.name;
-}
-
-/*
- * register & return a new board mac address
- */
-static int board_get_mac_address(u8 *mac)
-{
-	u8 *p;
-	int count;
-
-	if (mac_addr_used >= nvram.mac_addr_count) {
-		printk(KERN_ERR PFX "not enough mac address\n");
-		return -ENODEV;
-	}
-
-	memcpy(mac, nvram.mac_addr_base, ETH_ALEN);
-	p = mac + ETH_ALEN - 1;
-	count = mac_addr_used;
-
-	while (count--) {
-		do {
-			(*p)++;
-			if (*p != 0)
-				break;
-			p--;
-		} while (p != mac);
-	}
-
-	if (p == mac) {
-		printk(KERN_ERR PFX "unable to fetch mac address\n");
-		return -ENODEV;
-	}
-
-	mac_addr_used++;
-	return 0;
-}
-
 static struct mtd_partition mtd_partitions[] = {
 	{
 		.name		= "cfe",
@@ -750,33 +845,6 @@
 	},
 };
 
-/*
- * Register a sane SPROMv2 to make the on-board
- * bcm4318 WLAN work
- */
-#ifdef CONFIG_SSB_PCIHOST
-static struct ssb_sprom bcm63xx_sprom = {
-	.revision		= 0x02,
-	.board_rev		= 0x17,
-	.country_code		= 0x0,
-	.ant_available_bg 	= 0x3,
-	.pa0b0			= 0x15ae,
-	.pa0b1			= 0xfa85,
-	.pa0b2			= 0xfe8d,
-	.pa1b0			= 0xffff,
-	.pa1b1			= 0xffff,
-	.pa1b2			= 0xffff,
-	.gpio0			= 0xff,
-	.gpio1			= 0xff,
-	.gpio2			= 0xff,
-	.gpio3			= 0xff,
-	.maxpwr_bg		= 0x004c,
-	.itssi_bg		= 0x00,
-	.boardflags_lo		= 0x2848,
-	.boardflags_hi		= 0x0000,
-};
-#endif
-
 static struct gpio_led_platform_data bcm63xx_led_data;
 
 static struct platform_device bcm63xx_gpio_leds = {
@@ -792,6 +860,12 @@
 {
 	u32 val;
 
+	if (board.has_uart0)
+		bcm63xx_uart_register(0);
+
+	if (board.has_uart1)
+		bcm63xx_uart_register(1);
+
 	if (board.has_pccard)
 		bcm63xx_pcmcia_register();
 
@@ -806,17 +880,6 @@
 	if (board.has_dsp)
 		bcm63xx_dsp_register(&board.dsp);
 
-	/* Generate MAC address for WLAN and
-	 * register our SPROM */
-#ifdef CONFIG_SSB_PCIHOST
-	if (!board_get_mac_address(bcm63xx_sprom.il0mac)) {
-		memcpy(bcm63xx_sprom.et0mac, bcm63xx_sprom.il0mac, ETH_ALEN);
-		memcpy(bcm63xx_sprom.et1mac, bcm63xx_sprom.il0mac, ETH_ALEN);
-		if (ssb_arch_set_fallback_sprom(&bcm63xx_sprom) < 0)
-			printk(KERN_ERR "failed to register fallback SPROM\n");
-	}
-#endif
-
 	/* read base address of boot chip select (0) */
 	if (BCMCPU_IS_6345())
 		val = 0x1fc00000;
diff -urN linux-2.6.34-rc3/arch/mips/bcm63xx/cpu.c linux-2.6.34-rc4/arch/mips/bcm63xx/cpu.c
--- linux-2.6.34-rc3/arch/mips/bcm63xx/cpu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/bcm63xx/cpu.c	2010-04-13 02:19:00.476633262 +0000
@@ -36,6 +36,7 @@
 	[RSET_TIMER]		= BCM_6338_TIMER_BASE,
 	[RSET_WDT]		= BCM_6338_WDT_BASE,
 	[RSET_UART0]		= BCM_6338_UART0_BASE,
+	[RSET_UART1]		= BCM_6338_UART1_BASE,
 	[RSET_GPIO]		= BCM_6338_GPIO_BASE,
 	[RSET_SPI]		= BCM_6338_SPI_BASE,
 	[RSET_OHCI0]		= BCM_6338_OHCI0_BASE,
@@ -72,6 +73,7 @@
 	[RSET_TIMER]		= BCM_6345_TIMER_BASE,
 	[RSET_WDT]		= BCM_6345_WDT_BASE,
 	[RSET_UART0]		= BCM_6345_UART0_BASE,
+	[RSET_UART1]		= BCM_6345_UART1_BASE,
 	[RSET_GPIO]		= BCM_6345_GPIO_BASE,
 	[RSET_SPI]		= BCM_6345_SPI_BASE,
 	[RSET_UDC0]		= BCM_6345_UDC0_BASE,
@@ -109,6 +111,7 @@
 	[RSET_TIMER]		= BCM_6348_TIMER_BASE,
 	[RSET_WDT]		= BCM_6348_WDT_BASE,
 	[RSET_UART0]		= BCM_6348_UART0_BASE,
+	[RSET_UART1]		= BCM_6348_UART1_BASE,
 	[RSET_GPIO]		= BCM_6348_GPIO_BASE,
 	[RSET_SPI]		= BCM_6348_SPI_BASE,
 	[RSET_OHCI0]		= BCM_6348_OHCI0_BASE,
@@ -150,6 +153,7 @@
 	[RSET_TIMER]		= BCM_6358_TIMER_BASE,
 	[RSET_WDT]		= BCM_6358_WDT_BASE,
 	[RSET_UART0]		= BCM_6358_UART0_BASE,
+	[RSET_UART1]		= BCM_6358_UART1_BASE,
 	[RSET_GPIO]		= BCM_6358_GPIO_BASE,
 	[RSET_SPI]		= BCM_6358_SPI_BASE,
 	[RSET_OHCI0]		= BCM_6358_OHCI0_BASE,
@@ -170,6 +174,7 @@
 static const int bcm96358_irqs[] = {
 	[IRQ_TIMER]		= BCM_6358_TIMER_IRQ,
 	[IRQ_UART0]		= BCM_6358_UART0_IRQ,
+	[IRQ_UART1]		= BCM_6358_UART1_IRQ,
 	[IRQ_DSL]		= BCM_6358_DSL_IRQ,
 	[IRQ_ENET0]		= BCM_6358_ENET0_IRQ,
 	[IRQ_ENET1]		= BCM_6358_ENET1_IRQ,
diff -urN linux-2.6.34-rc3/arch/mips/bcm63xx/dev-uart.c linux-2.6.34-rc4/arch/mips/bcm63xx/dev-uart.c
--- linux-2.6.34-rc3/arch/mips/bcm63xx/dev-uart.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/bcm63xx/dev-uart.c	2010-04-13 02:19:00.476633262 +0000
@@ -11,31 +11,65 @@
 #include <linux/platform_device.h>
 #include <bcm63xx_cpu.h>
 
-static struct resource uart_resources[] = {
+static struct resource uart0_resources[] = {
 	{
-		.start		= -1, /* filled at runtime */
-		.end		= -1, /* filled at runtime */
+		/* start & end filled at runtime */
 		.flags		= IORESOURCE_MEM,
 	},
 	{
-		.start		= -1, /* filled at runtime */
+		/* start filled at runtime */
 		.flags		= IORESOURCE_IRQ,
 	},
 };
 
-static struct platform_device bcm63xx_uart_device = {
-	.name		= "bcm63xx_uart",
-	.id		= 0,
-	.num_resources	= ARRAY_SIZE(uart_resources),
-	.resource	= uart_resources,
+static struct resource uart1_resources[] = {
+	{
+		/* start & end filled at runtime */
+		.flags		= IORESOURCE_MEM,
+	},
+	{
+		/* start filled at runtime */
+		.flags		= IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device bcm63xx_uart_devices[] = {
+	{
+		.name		= "bcm63xx_uart",
+		.id		= 0,
+		.num_resources	= ARRAY_SIZE(uart0_resources),
+		.resource	= uart0_resources,
+	},
+
+	{
+		.name		= "bcm63xx_uart",
+		.id		= 1,
+		.num_resources	= ARRAY_SIZE(uart1_resources),
+		.resource	= uart1_resources,
+	}
 };
 
-int __init bcm63xx_uart_register(void)
+int __init bcm63xx_uart_register(unsigned int id)
 {
-	uart_resources[0].start = bcm63xx_regset_address(RSET_UART0);
-	uart_resources[0].end = uart_resources[0].start;
-	uart_resources[0].end += RSET_UART_SIZE - 1;
-	uart_resources[1].start = bcm63xx_get_irq_number(IRQ_UART0);
-	return platform_device_register(&bcm63xx_uart_device);
+	if (id >= ARRAY_SIZE(bcm63xx_uart_devices))
+		return -ENODEV;
+
+	if (id == 1 && !BCMCPU_IS_6358())
+		return -ENODEV;
+
+	if (id == 0) {
+		uart0_resources[0].start = bcm63xx_regset_address(RSET_UART0);
+		uart0_resources[0].end = uart0_resources[0].start +
+			RSET_UART_SIZE - 1;
+		uart0_resources[1].start = bcm63xx_get_irq_number(IRQ_UART0);
+	}
+
+	if (id == 1) {
+		uart1_resources[0].start = bcm63xx_regset_address(RSET_UART1);
+		uart1_resources[0].end = uart1_resources[0].start +
+			RSET_UART_SIZE - 1;
+		uart1_resources[1].start = bcm63xx_get_irq_number(IRQ_UART1);
+	}
+
+	return platform_device_register(&bcm63xx_uart_devices[id]);
 }
-arch_initcall(bcm63xx_uart_register);
diff -urN linux-2.6.34-rc3/arch/mips/bcm63xx/gpio.c linux-2.6.34-rc4/arch/mips/bcm63xx/gpio.c
--- linux-2.6.34-rc3/arch/mips/bcm63xx/gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/bcm63xx/gpio.c	2010-04-13 02:19:00.477633178 +0000
@@ -125,10 +125,10 @@
 
 int __init bcm63xx_gpio_init(void)
 {
+	gpio_out_low = bcm_gpio_readl(GPIO_DATA_LO_REG);
+	gpio_out_high = bcm_gpio_readl(GPIO_DATA_HI_REG);
 	bcm63xx_gpio_chip.ngpio = bcm63xx_gpio_count();
 	pr_info("registering %d GPIOs\n", bcm63xx_gpio_chip.ngpio);
 
 	return gpiochip_add(&bcm63xx_gpio_chip);
 }
-
-arch_initcall(bcm63xx_gpio_init);
diff -urN linux-2.6.34-rc3/arch/mips/cavium-octeon/setup.c linux-2.6.34-rc4/arch/mips/cavium-octeon/setup.c
--- linux-2.6.34-rc3/arch/mips/cavium-octeon/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/cavium-octeon/setup.c	2010-04-13 02:19:00.478633100 +0000
@@ -45,9 +45,6 @@
 extern void pci_console_init(const char *arg);
 #endif
 
-#ifdef CONFIG_CAVIUM_RESERVE32
-extern uint64_t octeon_reserve32_memory;
-#endif
 static unsigned long long MAX_MEMORY = 512ull << 20;
 
 struct octeon_boot_descriptor *octeon_boot_desc_ptr;
@@ -186,54 +183,6 @@
 	write_octeon_c0_dcacheerr(0);
 }
 
-#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
-/**
- * Called on every core to setup the wired tlb entry needed
- * if CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB is set.
- *
- */
-static void octeon_hal_setup_per_cpu_reserved32(void *unused)
-{
-	/*
-	 * The config has selected to wire the reserve32 memory for all
-	 * userspace applications. We need to put a wired TLB entry in for each
-	 * 512MB of reserve32 memory. We only handle double 256MB pages here,
-	 * so reserve32 must be multiple of 512MB.
-	 */
-	uint32_t size = CONFIG_CAVIUM_RESERVE32;
-	uint32_t entrylo0 =
-		0x7 | ((octeon_reserve32_memory & ((1ul << 40) - 1)) >> 6);
-	uint32_t entrylo1 = entrylo0 + (256 << 14);
-	uint32_t entryhi = (0x80000000UL - (CONFIG_CAVIUM_RESERVE32 << 20));
-	while (size >= 512) {
-#if 0
-		pr_info("CPU%d: Adding double wired TLB entry for 0x%lx\n",
-			smp_processor_id(), entryhi);
-#endif
-		add_wired_entry(entrylo0, entrylo1, entryhi, PM_256M);
-		entrylo0 += 512 << 14;
-		entrylo1 += 512 << 14;
-		entryhi += 512 << 20;
-		size -= 512;
-	}
-}
-#endif /* CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB */
-
-/**
- * Called to release the named block which was used to made sure
- * that nobody used the memory for something else during
- * init. Now we'll free it so userspace apps can use this
- * memory region with bootmem_alloc.
- *
- * This function is called only once from prom_free_prom_memory().
- */
-void octeon_hal_setup_reserved32(void)
-{
-#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
-	on_each_cpu(octeon_hal_setup_per_cpu_reserved32, NULL, 0, 1);
-#endif
-}
-
 /**
  * Reboot Octeon
  *
@@ -294,18 +243,6 @@
 	octeon_kill_core(NULL);
 }
 
-#if 0
-/**
- * Platform time init specifics.
- * Returns
- */
-void __init plat_time_init(void)
-{
-	/* Nothing special here, but we are required to have one */
-}
-
-#endif
-
 /**
  * Handle all the error condition interrupts that might occur.
  *
@@ -502,25 +439,13 @@
 	 * memory when it is getting memory from the
 	 * bootloader. Later, after the memory allocations are
 	 * complete, the reserve32 will be freed.
-	 */
-#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
-	if (CONFIG_CAVIUM_RESERVE32 & 0x1ff)
-		pr_err("CAVIUM_RESERVE32 isn't a multiple of 512MB. "
-		       "This is required if CAVIUM_RESERVE32_USE_WIRED_TLB "
-		       "is set\n");
-	else
-		addr = cvmx_bootmem_phy_named_block_alloc(CONFIG_CAVIUM_RESERVE32 << 20,
-							0, 0, 512 << 20,
-							"CAVIUM_RESERVE32", 0);
-#else
-	/*
+	 *
 	 * Allocate memory for RESERVED32 aligned on 2MB boundary. This
 	 * is in case we later use hugetlb entries with it.
 	 */
 	addr = cvmx_bootmem_phy_named_block_alloc(CONFIG_CAVIUM_RESERVE32 << 20,
 						0, 0, 2 << 20,
 						"CAVIUM_RESERVE32", 0);
-#endif
 	if (addr < 0)
 		pr_err("Failed to allocate CAVIUM_RESERVE32 memory area\n");
 	else
@@ -817,9 +742,4 @@
 		panic("Unable to request_irq(OCTEON_IRQ_RML)\n");
 	}
 #endif
-
-	/* This call is here so that it is performed after any TLB
-	   initializations. It needs to be after these in case the
-	   CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB option is set */
-	octeon_hal_setup_reserved32();
 }
diff -urN linux-2.6.34-rc3/arch/mips/cavium-octeon/smp.c linux-2.6.34-rc4/arch/mips/cavium-octeon/smp.c
--- linux-2.6.34-rc3/arch/mips/cavium-octeon/smp.c	2010-04-13 02:18:55.413570752 +0000
+++ linux-2.6.34-rc4/arch/mips/cavium-octeon/smp.c	2010-04-13 02:19:00.478633100 +0000
@@ -279,14 +279,6 @@
 	uint32_t avail_coremask;
 	struct cvmx_bootmem_named_block_desc *block_desc;
 
-#ifdef CONFIG_CAVIUM_OCTEON_WATCHDOG
-	/* Disable the watchdog */
-	cvmx_ciu_wdogx_t ciu_wdog;
-	ciu_wdog.u64 = cvmx_read_csr(CVMX_CIU_WDOGX(cpu));
-	ciu_wdog.s.mode = 0;
-	cvmx_write_csr(CVMX_CIU_WDOGX(cpu), ciu_wdog.u64);
-#endif
-
 	while (per_cpu(cpu_state, cpu) != CPU_DEAD)
 		cpu_relax();
 
diff -urN linux-2.6.34-rc3/arch/mips/configs/bigsur_defconfig linux-2.6.34-rc4/arch/mips/configs/bigsur_defconfig
--- linux-2.6.34-rc3/arch/mips/configs/bigsur_defconfig	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/configs/bigsur_defconfig	2010-04-13 02:19:00.479633024 +0000
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don't edit
-# Linux kernel version: 2.6.26-rc8
-# Wed Jul  2 17:02:55 2008
+# Linux kernel version: 2.6.34-rc3
+# Sat Apr  3 16:32:11 2010
 #
 CONFIG_MIPS=y
 
@@ -9,20 +9,25 @@
 # Machine selection
 #
 # CONFIG_MACH_ALCHEMY is not set
+# CONFIG_AR7 is not set
 # CONFIG_BCM47XX is not set
+# CONFIG_BCM63XX is not set
 # CONFIG_MIPS_COBALT is not set
 # CONFIG_MACH_DECSTATION is not set
 # CONFIG_MACH_JAZZ is not set
 # CONFIG_LASAT is not set
-# CONFIG_LEMOTE_FULONG is not set
+# CONFIG_MACH_LOONGSON is not set
 # CONFIG_MIPS_MALTA is not set
 # CONFIG_MIPS_SIM is not set
-# CONFIG_MARKEINS is not set
+# CONFIG_NEC_MARKEINS is not set
 # CONFIG_MACH_VR41XX is not set
+# CONFIG_NXP_STB220 is not set
+# CONFIG_NXP_STB225 is not set
 # CONFIG_PNX8550_JBS is not set
 # CONFIG_PNX8550_STB810 is not set
 # CONFIG_PMC_MSP is not set
 # CONFIG_PMC_YOSEMITE is not set
+# CONFIG_POWERTV is not set
 # CONFIG_SGI_IP22 is not set
 # CONFIG_SGI_IP27 is not set
 # CONFIG_SGI_IP28 is not set
@@ -36,10 +41,13 @@
 # CONFIG_SIBYTE_SENTOSA is not set
 CONFIG_SIBYTE_BIGSUR=y
 # CONFIG_SNI_RM is not set
-# CONFIG_TOSHIBA_JMR3927 is not set
-# CONFIG_TOSHIBA_RBTX4927 is not set
-# CONFIG_TOSHIBA_RBTX4938 is not set
+# CONFIG_MACH_TX39XX is not set
+# CONFIG_MACH_TX49XX is not set
+# CONFIG_MIKROTIK_RB532 is not set
 # CONFIG_WR_PPMC is not set
+# CONFIG_CAVIUM_OCTEON_SIMULATOR is not set
+# CONFIG_CAVIUM_OCTEON_REFERENCE_BOARD is not set
+# CONFIG_ALCHEMY_GPIO_INDIRECT is not set
 CONFIG_SIBYTE_BCM1x80=y
 CONFIG_SIBYTE_SB1xxx_SOC=y
 # CONFIG_CPU_SB1_PASS_1 is not set
@@ -48,14 +56,13 @@
 # CONFIG_CPU_SB1_PASS_4 is not set
 # CONFIG_CPU_SB1_PASS_2_112x is not set
 # CONFIG_CPU_SB1_PASS_3 is not set
-# CONFIG_SIMULATION is not set
 # CONFIG_SB1_CEX_ALWAYS_FATAL is not set
 # CONFIG_SB1_CERR_STALL is not set
-CONFIG_SIBYTE_CFE=y
 # CONFIG_SIBYTE_CFE_CONSOLE is not set
 # CONFIG_SIBYTE_BUS_WATCHER is not set
 # CONFIG_SIBYTE_TBPROF is not set
 CONFIG_SIBYTE_HAS_ZBUS_PROFILING=y
+CONFIG_LOONGSON_UART_BASE=y
 CONFIG_RWSEM_GENERIC_SPINLOCK=y
 # CONFIG_ARCH_HAS_ILOG2_U32 is not set
 # CONFIG_ARCH_HAS_ILOG2_U64 is not set
@@ -66,15 +73,13 @@
 CONFIG_GENERIC_CLOCKEVENTS=y
 CONFIG_GENERIC_TIME=y
 CONFIG_GENERIC_CMOS_UPDATE=y
-CONFIG_SCHED_NO_NO_OMIT_FRAME_POINTER=y
-# CONFIG_GENERIC_HARDIRQS_NO__DO_IRQ is not set
+CONFIG_SCHED_OMIT_FRAME_POINTER=y
+CONFIG_GENERIC_HARDIRQS_NO__DO_IRQ=y
 CONFIG_CEVT_BCM1480=y
 CONFIG_CSRC_BCM1480=y
 CONFIG_CFE=y
 CONFIG_DMA_COHERENT=y
-CONFIG_EARLY_PRINTK=y
 CONFIG_SYS_HAS_EARLY_PRINTK=y
-# CONFIG_HOTPLUG_CPU is not set
 # CONFIG_NO_IOPORT is not set
 CONFIG_CPU_BIG_ENDIAN=y
 # CONFIG_CPU_LITTLE_ENDIAN is not set
@@ -88,7 +93,8 @@
 #
 # CPU selection
 #
-# CONFIG_CPU_LOONGSON2 is not set
+# CONFIG_CPU_LOONGSON2E is not set
+# CONFIG_CPU_LOONGSON2F is not set
 # CONFIG_CPU_MIPS32_R1 is not set
 # CONFIG_CPU_MIPS32_R2 is not set
 # CONFIG_CPU_MIPS64_R1 is not set
@@ -101,6 +107,7 @@
 # CONFIG_CPU_TX49XX is not set
 # CONFIG_CPU_R5000 is not set
 # CONFIG_CPU_R5432 is not set
+# CONFIG_CPU_R5500 is not set
 # CONFIG_CPU_R6000 is not set
 # CONFIG_CPU_NEVADA is not set
 # CONFIG_CPU_R8000 is not set
@@ -108,6 +115,7 @@
 # CONFIG_CPU_RM7000 is not set
 # CONFIG_CPU_RM9000 is not set
 CONFIG_CPU_SB1=y
+# CONFIG_CPU_CAVIUM_OCTEON is not set
 CONFIG_SYS_HAS_CPU_SB1=y
 CONFIG_WEAK_ORDERING=y
 CONFIG_SYS_SUPPORTS_32BIT_KERNEL=y
@@ -123,11 +131,13 @@
 CONFIG_PAGE_SIZE_4KB=y
 # CONFIG_PAGE_SIZE_8KB is not set
 # CONFIG_PAGE_SIZE_16KB is not set
+# CONFIG_PAGE_SIZE_32KB is not set
 # CONFIG_PAGE_SIZE_64KB is not set
 # CONFIG_SIBYTE_DMA_PAGEOPS is not set
 CONFIG_MIPS_MT_DISABLED=y
 # CONFIG_MIPS_MT_SMP is not set
 # CONFIG_MIPS_MT_SMTC is not set
+# CONFIG_ARCH_PHYS_ADDR_T_64BIT is not set
 CONFIG_CPU_HAS_SYNC=y
 CONFIG_GENERIC_HARDIRQS=y
 CONFIG_GENERIC_IRQ_PROBE=y
@@ -142,18 +152,17 @@
 # CONFIG_SPARSEMEM_MANUAL is not set
 CONFIG_FLATMEM=y
 CONFIG_FLAT_NODE_MEM_MAP=y
-# CONFIG_SPARSEMEM_STATIC is not set
-# CONFIG_SPARSEMEM_VMEMMAP_ENABLE is not set
 CONFIG_PAGEFLAGS_EXTENDED=y
 CONFIG_SPLIT_PTLOCK_CPUS=4
-CONFIG_RESOURCES_64BIT=y
+CONFIG_PHYS_ADDR_T_64BIT=y
 CONFIG_ZONE_DMA_FLAG=0
 CONFIG_VIRT_TO_BUS=y
+# CONFIG_KSM is not set
+CONFIG_DEFAULT_MMAP_MIN_ADDR=4096
 CONFIG_SMP=y
 CONFIG_SYS_SUPPORTS_SMP=y
 CONFIG_NR_CPUS_DEFAULT_4=y
 CONFIG_NR_CPUS=4
-# CONFIG_MIPS_CMP is not set
 CONFIG_TICK_ONESHOT=y
 CONFIG_NO_HZ=y
 CONFIG_HIGH_RES_TIMERS=y
@@ -175,6 +184,7 @@
 CONFIG_LOCKDEP_SUPPORT=y
 CONFIG_STACKTRACE_SUPPORT=y
 CONFIG_DEFCONFIG_LIST="/lib/modules/$UNAME_RELEASE/.config"
+CONFIG_CONSTRUCTORS=y
 
 #
 # General setup
@@ -188,6 +198,7 @@
 CONFIG_SYSVIPC=y
 CONFIG_SYSVIPC_SYSCTL=y
 CONFIG_POSIX_MQUEUE=y
+CONFIG_POSIX_MQUEUE_SYSCTL=y
 CONFIG_BSD_PROCESS_ACCT=y
 CONFIG_BSD_PROCESS_ACCT_V3=y
 CONFIG_TASKSTATS=y
@@ -195,23 +206,39 @@
 CONFIG_TASK_XACCT=y
 CONFIG_TASK_IO_ACCOUNTING=y
 CONFIG_AUDIT=y
+
+#
+# RCU Subsystem
+#
+CONFIG_TREE_RCU=y
+# CONFIG_TREE_PREEMPT_RCU is not set
+# CONFIG_TINY_RCU is not set
+# CONFIG_RCU_TRACE is not set
+CONFIG_RCU_FANOUT=64
+# CONFIG_RCU_FANOUT_EXACT is not set
+# CONFIG_RCU_FAST_NO_HZ is not set
+# CONFIG_TREE_RCU_TRACE is not set
 CONFIG_IKCONFIG=y
 CONFIG_IKCONFIG_PROC=y
 CONFIG_LOG_BUF_SHIFT=16
 # CONFIG_CGROUPS is not set
-CONFIG_GROUP_SCHED=y
-CONFIG_FAIR_GROUP_SCHED=y
-# CONFIG_RT_GROUP_SCHED is not set
-CONFIG_USER_SCHED=y
-# CONFIG_CGROUP_SCHED is not set
-CONFIG_SYSFS_DEPRECATED=y
-CONFIG_SYSFS_DEPRECATED_V2=y
+# CONFIG_SYSFS_DEPRECATED_V2 is not set
 CONFIG_RELAY=y
-# CONFIG_NAMESPACES is not set
+CONFIG_NAMESPACES=y
+CONFIG_UTS_NS=y
+CONFIG_IPC_NS=y
+CONFIG_USER_NS=y
+CONFIG_PID_NS=y
+CONFIG_NET_NS=y
 CONFIG_BLK_DEV_INITRD=y
 CONFIG_INITRAMFS_SOURCE=""
+CONFIG_RD_GZIP=y
+# CONFIG_RD_BZIP2 is not set
+# CONFIG_RD_LZMA is not set
+# CONFIG_RD_LZO is not set
 # CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
 CONFIG_SYSCTL=y
+CONFIG_ANON_INODES=y
 CONFIG_EMBEDDED=y
 # CONFIG_SYSCTL_SYSCALL is not set
 CONFIG_KALLSYMS=y
@@ -222,29 +249,36 @@
 CONFIG_BUG=y
 CONFIG_ELF_CORE=y
 # CONFIG_PCSPKR_PLATFORM is not set
-CONFIG_COMPAT_BRK=y
 CONFIG_BASE_FULL=y
 CONFIG_FUTEX=y
-CONFIG_ANON_INODES=y
 CONFIG_EPOLL=y
 CONFIG_SIGNALFD=y
 CONFIG_TIMERFD=y
 CONFIG_EVENTFD=y
 CONFIG_SHMEM=y
+CONFIG_AIO=y
+
+#
+# Kernel Performance Events And Counters
+#
 CONFIG_VM_EVENT_COUNTERS=y
+CONFIG_PCI_QUIRKS=y
+CONFIG_COMPAT_BRK=y
 CONFIG_SLAB=y
 # CONFIG_SLUB is not set
 # CONFIG_SLOB is not set
 # CONFIG_PROFILING is not set
-# CONFIG_MARKERS is not set
 CONFIG_HAVE_OPROFILE=y
-# CONFIG_HAVE_KPROBES is not set
-# CONFIG_HAVE_KRETPROBES is not set
-# CONFIG_HAVE_DMA_ATTRS is not set
-CONFIG_PROC_PAGE_MONITOR=y
+CONFIG_HAVE_SYSCALL_WRAPPERS=y
+CONFIG_USE_GENERIC_SMP_HELPERS=y
+
+#
+# GCOV-based kernel profiling
+#
+# CONFIG_SLOW_WORK is not set
+CONFIG_HAVE_GENERIC_DMA_COHERENT=y
 CONFIG_SLABINFO=y
 CONFIG_RT_MUTEXES=y
-# CONFIG_TINY_SHMEM is not set
 CONFIG_BASE_SMALL=0
 CONFIG_MODULES=y
 # CONFIG_MODULE_FORCE_LOAD is not set
@@ -252,26 +286,52 @@
 # CONFIG_MODULE_FORCE_UNLOAD is not set
 CONFIG_MODVERSIONS=y
 CONFIG_MODULE_SRCVERSION_ALL=y
-CONFIG_KMOD=y
 CONFIG_STOP_MACHINE=y
 CONFIG_BLOCK=y
-# CONFIG_BLK_DEV_IO_TRACE is not set
 # CONFIG_BLK_DEV_BSG is not set
+# CONFIG_BLK_DEV_INTEGRITY is not set
 CONFIG_BLOCK_COMPAT=y
 
 #
 # IO Schedulers
 #
 CONFIG_IOSCHED_NOOP=y
-CONFIG_IOSCHED_AS=y
 CONFIG_IOSCHED_DEADLINE=y
 CONFIG_IOSCHED_CFQ=y
-CONFIG_DEFAULT_AS=y
 # CONFIG_DEFAULT_DEADLINE is not set
-# CONFIG_DEFAULT_CFQ is not set
+CONFIG_DEFAULT_CFQ=y
 # CONFIG_DEFAULT_NOOP is not set
-CONFIG_DEFAULT_IOSCHED="anticipatory"
-CONFIG_CLASSIC_RCU=y
+CONFIG_DEFAULT_IOSCHED="cfq"
+# CONFIG_INLINE_SPIN_TRYLOCK is not set
+# CONFIG_INLINE_SPIN_TRYLOCK_BH is not set
+# CONFIG_INLINE_SPIN_LOCK is not set
+# CONFIG_INLINE_SPIN_LOCK_BH is not set
+# CONFIG_INLINE_SPIN_LOCK_IRQ is not set
+# CONFIG_INLINE_SPIN_LOCK_IRQSAVE is not set
+CONFIG_INLINE_SPIN_UNLOCK=y
+# CONFIG_INLINE_SPIN_UNLOCK_BH is not set
+CONFIG_INLINE_SPIN_UNLOCK_IRQ=y
+# CONFIG_INLINE_SPIN_UNLOCK_IRQRESTORE is not set
+# CONFIG_INLINE_READ_TRYLOCK is not set
+# CONFIG_INLINE_READ_LOCK is not set
+# CONFIG_INLINE_READ_LOCK_BH is not set
+# CONFIG_INLINE_READ_LOCK_IRQ is not set
+# CONFIG_INLINE_READ_LOCK_IRQSAVE is not set
+CONFIG_INLINE_READ_UNLOCK=y
+# CONFIG_INLINE_READ_UNLOCK_BH is not set
+CONFIG_INLINE_READ_UNLOCK_IRQ=y
+# CONFIG_INLINE_READ_UNLOCK_IRQRESTORE is not set
+# CONFIG_INLINE_WRITE_TRYLOCK is not set
+# CONFIG_INLINE_WRITE_LOCK is not set
+# CONFIG_INLINE_WRITE_LOCK_BH is not set
+# CONFIG_INLINE_WRITE_LOCK_IRQ is not set
+# CONFIG_INLINE_WRITE_LOCK_IRQSAVE is not set
+CONFIG_INLINE_WRITE_UNLOCK=y
+# CONFIG_INLINE_WRITE_UNLOCK_BH is not set
+CONFIG_INLINE_WRITE_UNLOCK_IRQ=y
+# CONFIG_INLINE_WRITE_UNLOCK_IRQRESTORE is not set
+CONFIG_MUTEX_SPIN_ON_OWNER=y
+# CONFIG_FREEZER is not set
 
 #
 # Bus options (PCI, PCMCIA, EISA, ISA, TC)
@@ -280,8 +340,9 @@
 CONFIG_PCI=y
 CONFIG_PCI_DOMAINS=y
 # CONFIG_ARCH_SUPPORTS_MSI is not set
-CONFIG_PCI_LEGACY=y
 CONFIG_PCI_DEBUG=y
+# CONFIG_PCI_STUB is not set
+# CONFIG_PCI_IOV is not set
 CONFIG_MMU=y
 CONFIG_ZONE_DMA32=y
 # CONFIG_PCCARD is not set
@@ -291,6 +352,8 @@
 # Executable file formats
 #
 CONFIG_BINFMT_ELF=y
+# CONFIG_CORE_DUMP_DEFAULT_ELF_HEADERS is not set
+# CONFIG_HAVE_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 CONFIG_MIPS32_COMPAT=y
 CONFIG_COMPAT=y
@@ -304,23 +367,20 @@
 #
 CONFIG_PM=y
 # CONFIG_PM_DEBUG is not set
-
-#
-# Networking
-#
+# CONFIG_PM_RUNTIME is not set
 CONFIG_NET=y
 
 #
 # Networking options
 #
 CONFIG_PACKET=y
-CONFIG_PACKET_MMAP=y
 CONFIG_UNIX=y
 CONFIG_XFRM=y
 CONFIG_XFRM_USER=m
 # CONFIG_XFRM_SUB_POLICY is not set
 CONFIG_XFRM_MIGRATE=y
 # CONFIG_XFRM_STATISTICS is not set
+CONFIG_XFRM_IPCOMP=m
 CONFIG_NET_KEY=y
 CONFIG_NET_KEY_MIGRATE=y
 CONFIG_INET=y
@@ -353,36 +413,6 @@
 CONFIG_TCP_CONG_CUBIC=y
 CONFIG_DEFAULT_TCP_CONG="cubic"
 CONFIG_TCP_MD5SIG=y
-CONFIG_IP_VS=m
-# CONFIG_IP_VS_DEBUG is not set
-CONFIG_IP_VS_TAB_BITS=12
-
-#
-# IPVS transport protocol load balancing support
-#
-CONFIG_IP_VS_PROTO_TCP=y
-CONFIG_IP_VS_PROTO_UDP=y
-CONFIG_IP_VS_PROTO_ESP=y
-CONFIG_IP_VS_PROTO_AH=y
-
-#
-# IPVS scheduler
-#
-CONFIG_IP_VS_RR=m
-CONFIG_IP_VS_WRR=m
-CONFIG_IP_VS_LC=m
-CONFIG_IP_VS_WLC=m
-CONFIG_IP_VS_LBLC=m
-CONFIG_IP_VS_LBLCR=m
-CONFIG_IP_VS_DH=m
-CONFIG_IP_VS_SH=m
-CONFIG_IP_VS_SED=m
-CONFIG_IP_VS_NQ=m
-
-#
-# IPVS application helper
-#
-CONFIG_IP_VS_FTP=m
 CONFIG_IPV6=m
 CONFIG_IPV6_PRIVACY=y
 CONFIG_IPV6_ROUTER_PREF=y
@@ -399,11 +429,13 @@
 CONFIG_INET6_XFRM_MODE_BEET=m
 CONFIG_INET6_XFRM_MODE_ROUTEOPTIMIZATION=m
 CONFIG_IPV6_SIT=m
+CONFIG_IPV6_SIT_6RD=y
 CONFIG_IPV6_NDISC_NODETYPE=y
 CONFIG_IPV6_TUNNEL=m
 CONFIG_IPV6_MULTIPLE_TABLES=y
 CONFIG_IPV6_SUBTREES=y
 # CONFIG_IPV6_MROUTE is not set
+CONFIG_NETLABEL=y
 CONFIG_NETWORK_SECMARK=y
 CONFIG_NETFILTER=y
 # CONFIG_NETFILTER_DEBUG is not set
@@ -421,19 +453,53 @@
 CONFIG_NF_CONNTRACK_SIP=m
 CONFIG_NF_CT_NETLINK=m
 CONFIG_NETFILTER_XTABLES=m
+CONFIG_NETFILTER_XT_TARGET_CONNSECMARK=m
 CONFIG_NETFILTER_XT_TARGET_MARK=m
 CONFIG_NETFILTER_XT_TARGET_NFLOG=m
 CONFIG_NETFILTER_XT_TARGET_SECMARK=m
-CONFIG_NETFILTER_XT_TARGET_CONNSECMARK=m
 CONFIG_NETFILTER_XT_TARGET_TCPMSS=m
 CONFIG_NETFILTER_XT_MATCH_CONNTRACK=m
 CONFIG_NETFILTER_XT_MATCH_MARK=m
 CONFIG_NETFILTER_XT_MATCH_POLICY=m
 CONFIG_NETFILTER_XT_MATCH_STATE=m
+CONFIG_IP_VS=m
+CONFIG_IP_VS_IPV6=y
+# CONFIG_IP_VS_DEBUG is not set
+CONFIG_IP_VS_TAB_BITS=12
+
+#
+# IPVS transport protocol load balancing support
+#
+CONFIG_IP_VS_PROTO_TCP=y
+CONFIG_IP_VS_PROTO_UDP=y
+CONFIG_IP_VS_PROTO_AH_ESP=y
+CONFIG_IP_VS_PROTO_ESP=y
+CONFIG_IP_VS_PROTO_AH=y
+CONFIG_IP_VS_PROTO_SCTP=y
+
+#
+# IPVS scheduler
+#
+CONFIG_IP_VS_RR=m
+CONFIG_IP_VS_WRR=m
+CONFIG_IP_VS_LC=m
+CONFIG_IP_VS_WLC=m
+CONFIG_IP_VS_LBLC=m
+CONFIG_IP_VS_LBLCR=m
+CONFIG_IP_VS_DH=m
+CONFIG_IP_VS_SH=m
+CONFIG_IP_VS_SED=m
+CONFIG_IP_VS_NQ=m
+
+#
+# IPVS application helper
+#
+CONFIG_IP_VS_FTP=m
 
 #
 # IP: Netfilter Configuration
 #
+CONFIG_NF_DEFRAG_IPV4=m
 CONFIG_NF_CONNTRACK_IPV4=m
 CONFIG_NF_CONNTRACK_PROC_COMPAT=y
 CONFIG_IP_NF_IPTABLES=m
@@ -459,22 +525,44 @@
 CONFIG_NF_CONNTRACK_IPV6=m
 CONFIG_IP6_NF_IPTABLES=m
 CONFIG_IP6_NF_MATCH_IPV6HEADER=m
-CONFIG_IP6_NF_FILTER=m
 CONFIG_IP6_NF_TARGET_LOG=m
+CONFIG_IP6_NF_FILTER=m
 CONFIG_IP6_NF_TARGET_REJECT=m
 CONFIG_IP6_NF_MANGLE=m
-# CONFIG_IP_DCCP is not set
+CONFIG_IP_DCCP=m
+CONFIG_INET_DCCP_DIAG=m
+
+#
+# DCCP CCIDs Configuration (EXPERIMENTAL)
+#
+# CONFIG_IP_DCCP_CCID2_DEBUG is not set
+CONFIG_IP_DCCP_CCID3=y
+# CONFIG_IP_DCCP_CCID3_DEBUG is not set
+CONFIG_IP_DCCP_CCID3_RTO=100
+CONFIG_IP_DCCP_TFRC_LIB=y
+
+#
+# DCCP Kernel Hacking
+#
+# CONFIG_IP_DCCP_DEBUG is not set
 CONFIG_IP_SCTP=m
 # CONFIG_SCTP_DBG_MSG is not set
 # CONFIG_SCTP_DBG_OBJCNT is not set
 # CONFIG_SCTP_HMAC_NONE is not set
-# CONFIG_SCTP_HMAC_SHA1 is not set
-CONFIG_SCTP_HMAC_MD5=y
+CONFIG_SCTP_HMAC_SHA1=y
+# CONFIG_SCTP_HMAC_MD5 is not set
+# CONFIG_RDS is not set
 # CONFIG_TIPC is not set
 # CONFIG_ATM is not set
-# CONFIG_BRIDGE is not set
-# CONFIG_VLAN_8021Q is not set
+CONFIG_STP=m
+CONFIG_GARP=m
+CONFIG_BRIDGE=m
+CONFIG_BRIDGE_IGMP_SNOOPING=y
+# CONFIG_NET_DSA is not set
+CONFIG_VLAN_8021Q=m
+CONFIG_VLAN_8021Q_GVRP=y
 # CONFIG_DECNET is not set
+CONFIG_LLC=m
 # CONFIG_LLC2 is not set
 # CONFIG_IPX is not set
 # CONFIG_ATALK is not set
@@ -482,26 +570,47 @@
 # CONFIG_LAPB is not set
 # CONFIG_ECONET is not set
 # CONFIG_WAN_ROUTER is not set
+# CONFIG_PHONET is not set
+# CONFIG_IEEE802154 is not set
 # CONFIG_NET_SCHED is not set
+# CONFIG_DCB is not set
 
 #
 # Network testing
 #
 # CONFIG_NET_PKTGEN is not set
-# CONFIG_HAMRADIO is not set
+CONFIG_HAMRADIO=y
+
+#
+# Packet Radio protocols
+#
+CONFIG_AX25=m
+CONFIG_AX25_DAMA_SLAVE=y
+CONFIG_NETROM=m
+CONFIG_ROSE=m
+
+#
+# AX.25 network device drivers
+#
+CONFIG_MKISS=m
+CONFIG_6PACK=m
+CONFIG_BPQETHER=m
+CONFIG_BAYCOM_SER_FDX=m
+CONFIG_BAYCOM_SER_HDX=m
+CONFIG_YAM=m
 # CONFIG_CAN is not set
 # CONFIG_IRDA is not set
 # CONFIG_BT is not set
 # CONFIG_AF_RXRPC is not set
 CONFIG_FIB_RULES=y
+CONFIG_WIRELESS=y
+# CONFIG_CFG80211 is not set
+# CONFIG_LIB80211 is not set
 
 #
-# Wireless
+# CFG80211 needs to be enabled for MAC80211
 #
-# CONFIG_CFG80211 is not set
-# CONFIG_WIRELESS_EXT is not set
-# CONFIG_MAC80211 is not set
-# CONFIG_IEEE80211 is not set
+# CONFIG_WIMAX is not set
 # CONFIG_RFKILL is not set
 # CONFIG_NET_9P is not set
 
@@ -513,9 +622,12 @@
 # Generic Driver Options
 #
 CONFIG_UEVENT_HELPER_PATH="/sbin/hotplug"
+# CONFIG_DEVTMPFS is not set
 CONFIG_STANDALONE=y
 CONFIG_PREVENT_FIRMWARE_BUILD=y
 CONFIG_FW_LOADER=m
+CONFIG_FIRMWARE_IN_KERNEL=y
+CONFIG_EXTRA_FIRMWARE=""
 # CONFIG_DEBUG_DRIVER is not set
 # CONFIG_DEBUG_DEVRES is not set
 # CONFIG_SYS_HYPERVISOR is not set
@@ -530,33 +642,53 @@
 # CONFIG_BLK_DEV_COW_COMMON is not set
 CONFIG_BLK_DEV_LOOP=m
 CONFIG_BLK_DEV_CRYPTOLOOP=m
+
+#
+# DRBD disabled because PROC_FS, INET or CONNECTOR not selected
+#
 CONFIG_BLK_DEV_NBD=m
 # CONFIG_BLK_DEV_SX8 is not set
 # CONFIG_BLK_DEV_RAM is not set
 # CONFIG_CDROM_PKTCDVD is not set
 # CONFIG_ATA_OVER_ETH is not set
+# CONFIG_BLK_DEV_HD is not set
 CONFIG_MISC_DEVICES=y
+# CONFIG_AD525X_DPOT is not set
 # CONFIG_PHANTOM is not set
-# CONFIG_EEPROM_93CX6 is not set
 CONFIG_SGI_IOC4=m
 # CONFIG_TIFM_CORE is not set
+# CONFIG_ICS932S401 is not set
 # CONFIG_ENCLOSURE_SERVICES is not set
+# CONFIG_HP_ILO is not set
+# CONFIG_ISL29003 is not set
+# CONFIG_SENSORS_TSL2550 is not set
+# CONFIG_DS1682 is not set
+# CONFIG_C2PORT is not set
+
+#
+# EEPROM support
+#
+# CONFIG_EEPROM_AT24 is not set
+CONFIG_EEPROM_LEGACY=y
+CONFIG_EEPROM_MAX6875=y
+# CONFIG_EEPROM_93CX6 is not set
+# CONFIG_CB710_CORE is not set
 CONFIG_HAVE_IDE=y
 CONFIG_IDE=y
-CONFIG_IDE_MAX_HWIFS=4
-CONFIG_BLK_DEV_IDE=y
 
 #
 # Please see Documentation/ide/ide.txt for help/info on IDE drives
 #
+CONFIG_IDE_XFER_MODE=y
+CONFIG_IDE_TIMINGS=y
+CONFIG_IDE_ATAPI=y
 # CONFIG_BLK_DEV_IDE_SATA is not set
-CONFIG_BLK_DEV_IDEDISK=y
-# CONFIG_IDEDISK_MULTI_MODE is not set
+CONFIG_IDE_GD=y
+CONFIG_IDE_GD_ATA=y
+# CONFIG_IDE_GD_ATAPI is not set
 CONFIG_BLK_DEV_IDECD=y
 CONFIG_BLK_DEV_IDECD_VERBOSE_ERRORS=y
 CONFIG_BLK_DEV_IDETAPE=y
-CONFIG_BLK_DEV_IDEFLOPPY=y
-# CONFIG_BLK_DEV_IDESCSI is not set
 # CONFIG_IDE_TASK_IOCTL is not set
 CONFIG_IDE_PROC_FS=y
 
@@ -581,14 +713,13 @@
 # CONFIG_BLK_DEV_AMD74XX is not set
 CONFIG_BLK_DEV_CMD64X=y
 # CONFIG_BLK_DEV_TRIFLEX is not set
-# CONFIG_BLK_DEV_CY82C693 is not set
 # CONFIG_BLK_DEV_CS5520 is not set
 # CONFIG_BLK_DEV_CS5530 is not set
-# CONFIG_BLK_DEV_HPT34X is not set
 # CONFIG_BLK_DEV_HPT366 is not set
 # CONFIG_BLK_DEV_JMICRON is not set
 # CONFIG_BLK_DEV_SC1200 is not set
 # CONFIG_BLK_DEV_PIIX is not set
+# CONFIG_BLK_DEV_IT8172 is not set
 CONFIG_BLK_DEV_IT8213=m
 # CONFIG_BLK_DEV_IT821X is not set
 # CONFIG_BLK_DEV_NS87415 is not set
@@ -600,14 +731,12 @@
 # CONFIG_BLK_DEV_TRM290 is not set
 # CONFIG_BLK_DEV_VIA82CXXX is not set
 CONFIG_BLK_DEV_TC86C001=m
-# CONFIG_BLK_DEV_IDE_SWARM is not set
 CONFIG_BLK_DEV_IDEDMA=y
-# CONFIG_BLK_DEV_HD_ONLY is not set
-# CONFIG_BLK_DEV_HD is not set
 
 #
 # SCSI device support
 #
+CONFIG_SCSI_MOD=y
 # CONFIG_RAID_ATTRS is not set
 CONFIG_SCSI=y
 CONFIG_SCSI_DMA=y
@@ -625,10 +754,6 @@
 CONFIG_BLK_DEV_SR_VENDOR=y
 CONFIG_CHR_DEV_SG=m
 CONFIG_CHR_DEV_SCH=m
-
-#
-# Some SCSI devices (e.g. CD jukebox) support multiple LUNs
-#
 # CONFIG_SCSI_MULTI_LUN is not set
 # CONFIG_SCSI_CONSTANTS is not set
 # CONFIG_SCSI_LOGGING is not set
@@ -645,27 +770,36 @@
 # CONFIG_SCSI_SRP_ATTRS is not set
 CONFIG_SCSI_LOWLEVEL=y
 # CONFIG_ISCSI_TCP is not set
+# CONFIG_SCSI_CXGB3_ISCSI is not set
+# CONFIG_SCSI_BNX2_ISCSI is not set
+# CONFIG_BE2ISCSI is not set
 # CONFIG_BLK_DEV_3W_XXXX_RAID is not set
+# CONFIG_SCSI_HPSA is not set
 # CONFIG_SCSI_3W_9XXX is not set
+# CONFIG_SCSI_3W_SAS is not set
 # CONFIG_SCSI_ACARD is not set
 # CONFIG_SCSI_AACRAID is not set
 # CONFIG_SCSI_AIC7XXX is not set
 # CONFIG_SCSI_AIC7XXX_OLD is not set
 # CONFIG_SCSI_AIC79XX is not set
 # CONFIG_SCSI_AIC94XX is not set
+# CONFIG_SCSI_MVSAS is not set
 # CONFIG_SCSI_DPT_I2O is not set
 # CONFIG_SCSI_ADVANSYS is not set
 # CONFIG_SCSI_ARCMSR is not set
 # CONFIG_MEGARAID_NEWGEN is not set
 # CONFIG_MEGARAID_LEGACY is not set
 # CONFIG_MEGARAID_SAS is not set
+# CONFIG_SCSI_MPT2SAS is not set
 # CONFIG_SCSI_HPTIOP is not set
+# CONFIG_LIBFC is not set
+# CONFIG_LIBFCOE is not set
+# CONFIG_FCOE is not set
 # CONFIG_SCSI_DMX3191D is not set
 # CONFIG_SCSI_FUTURE_DOMAIN is not set
 # CONFIG_SCSI_IPS is not set
 # CONFIG_SCSI_INITIO is not set
 # CONFIG_SCSI_INIA100 is not set
-# CONFIG_SCSI_MVSAS is not set
 # CONFIG_SCSI_STEX is not set
 # CONFIG_SCSI_SYM53C8XX_2 is not set
 # CONFIG_SCSI_IPR is not set
@@ -676,9 +810,15 @@
 # CONFIG_SCSI_DC395x is not set
 # CONFIG_SCSI_DC390T is not set
 # CONFIG_SCSI_DEBUG is not set
+# CONFIG_SCSI_PMCRAID is not set
+# CONFIG_SCSI_PM8001 is not set
 # CONFIG_SCSI_SRP is not set
+# CONFIG_SCSI_BFA_FC is not set
+# CONFIG_SCSI_DH is not set
+# CONFIG_SCSI_OSD_INITIATOR is not set
 CONFIG_ATA=y
 # CONFIG_ATA_NONSTANDARD is not set
+CONFIG_ATA_VERBOSE_ERROR=y
 CONFIG_SATA_PMP=y
 # CONFIG_SATA_AHCI is not set
 CONFIG_SATA_SIL24=y
@@ -700,6 +840,7 @@
 # CONFIG_PATA_ALI is not set
 # CONFIG_PATA_AMD is not set
 # CONFIG_PATA_ARTOP is not set
+# CONFIG_PATA_ATP867X is not set
 # CONFIG_PATA_ATIIXP is not set
 # CONFIG_PATA_CMD640_PCI is not set
 # CONFIG_PATA_CMD64X is not set
@@ -715,6 +856,7 @@
 # CONFIG_PATA_IT821X is not set
 # CONFIG_PATA_IT8213 is not set
 # CONFIG_PATA_JMICRON is not set
+# CONFIG_PATA_LEGACY is not set
 # CONFIG_PATA_TRIFLEX is not set
 # CONFIG_PATA_MARVELL is not set
 # CONFIG_PATA_MPIIX is not set
@@ -725,14 +867,16 @@
 # CONFIG_PATA_NS87415 is not set
 # CONFIG_PATA_OPTI is not set
 # CONFIG_PATA_OPTIDMA is not set
+# CONFIG_PATA_PDC2027X is not set
 # CONFIG_PATA_PDC_OLD is not set
 # CONFIG_PATA_RADISYS is not set
+# CONFIG_PATA_RDC is not set
 # CONFIG_PATA_RZ1000 is not set
 # CONFIG_PATA_SC1200 is not set
 # CONFIG_PATA_SERVERWORKS is not set
-# CONFIG_PATA_PDC2027X is not set
 CONFIG_PATA_SIL680=y
 # CONFIG_PATA_SIS is not set
+# CONFIG_PATA_TOSHIBA is not set
 # CONFIG_PATA_VIA is not set
 # CONFIG_PATA_WINBOND is not set
 # CONFIG_PATA_PLATFORM is not set
@@ -745,13 +889,16 @@
 #
 
 #
-# Enable only one of the two stacks, unless you know what you are doing
+# You can enable one or both FireWire driver stacks.
+#
+
+#
+# The newer stack is recommended.
 #
 # CONFIG_FIREWIRE is not set
 # CONFIG_IEEE1394 is not set
 # CONFIG_I2O is not set
 CONFIG_NETDEVICES=y
-# CONFIG_NETDEVICES_MULTIQUEUE is not set
 # CONFIG_DUMMY is not set
 # CONFIG_BONDING is not set
 # CONFIG_MACVLAN is not set
@@ -774,6 +921,9 @@
 # CONFIG_BROADCOM_PHY is not set
 # CONFIG_ICPLUS_PHY is not set
 # CONFIG_REALTEK_PHY is not set
+# CONFIG_NATIONAL_PHY is not set
+# CONFIG_STE10XP is not set
+# CONFIG_LSI_ET1011C_PHY is not set
 # CONFIG_FIXED_PHY is not set
 # CONFIG_MDIO_BITBANG is not set
 CONFIG_NET_ETHERNET=y
@@ -783,23 +933,33 @@
 # CONFIG_SUNGEM is not set
 # CONFIG_CASSINI is not set
 # CONFIG_NET_VENDOR_3COM is not set
+# CONFIG_SMC91X is not set
 # CONFIG_DM9000 is not set
+# CONFIG_ETHOC is not set
+# CONFIG_SMSC911X is not set
+# CONFIG_DNET is not set
 # CONFIG_NET_TULIP is not set
 # CONFIG_HP100 is not set
 # CONFIG_IBM_NEW_EMAC_ZMII is not set
 # CONFIG_IBM_NEW_EMAC_RGMII is not set
 # CONFIG_IBM_NEW_EMAC_TAH is not set
 # CONFIG_IBM_NEW_EMAC_EMAC4 is not set
+# CONFIG_IBM_NEW_EMAC_NO_FLOW_CTRL is not set
+# CONFIG_IBM_NEW_EMAC_MAL_CLR_ICINTSTAT is not set
+# CONFIG_IBM_NEW_EMAC_MAL_COMMON_ERR is not set
 # CONFIG_NET_PCI is not set
 # CONFIG_B44 is not set
+# CONFIG_KS8842 is not set
+# CONFIG_KS8851_MLL is not set
+# CONFIG_ATL2 is not set
 CONFIG_NETDEV_1000=y
 # CONFIG_ACENIC is not set
 # CONFIG_DL2K is not set
 # CONFIG_E1000 is not set
 # CONFIG_E1000E is not set
-# CONFIG_E1000E_ENABLED is not set
 # CONFIG_IP1000 is not set
 # CONFIG_IGB is not set
+# CONFIG_IGBVF is not set
 # CONFIG_NS83820 is not set
 # CONFIG_HAMACHI is not set
 # CONFIG_YELLOWFIN is not set
@@ -811,29 +971,42 @@
 # CONFIG_VIA_VELOCITY is not set
 # CONFIG_TIGON3 is not set
 # CONFIG_BNX2 is not set
+# CONFIG_CNIC is not set
 # CONFIG_QLA3XXX is not set
 # CONFIG_ATL1 is not set
+# CONFIG_ATL1E is not set
+# CONFIG_ATL1C is not set
+# CONFIG_JME is not set
 CONFIG_NETDEV_10000=y
+CONFIG_MDIO=m
 # CONFIG_CHELSIO_T1 is not set
+CONFIG_CHELSIO_T3_DEPENDS=y
 CONFIG_CHELSIO_T3=m
+# CONFIG_ENIC is not set
 # CONFIG_IXGBE is not set
 # CONFIG_IXGB is not set
 # CONFIG_S2IO is not set
+# CONFIG_VXGE is not set
 # CONFIG_MYRI10GE is not set
 CONFIG_NETXEN_NIC=m
 # CONFIG_NIU is not set
+# CONFIG_MLX4_EN is not set
 # CONFIG_MLX4_CORE is not set
 # CONFIG_TEHUTI is not set
 # CONFIG_BNX2X is not set
+# CONFIG_QLCNIC is not set
+# CONFIG_QLGE is not set
 # CONFIG_SFC is not set
+# CONFIG_BE2NET is not set
 # CONFIG_TR is not set
+CONFIG_WLAN=y
+# CONFIG_ATMEL is not set
+# CONFIG_PRISM54 is not set
+# CONFIG_HOSTAP is not set
 
 #
-# Wireless LAN
+# Enable WiMAX (Networking options) to see the WiMAX drivers
 #
-# CONFIG_WLAN_PRE80211 is not set
-# CONFIG_WLAN_80211 is not set
-# CONFIG_IWLWIFI_LEDS is not set
 # CONFIG_WAN is not set
 # CONFIG_FDDI is not set
 # CONFIG_HIPPI is not set
@@ -856,6 +1029,7 @@
 # CONFIG_NETCONSOLE is not set
 # CONFIG_NETPOLL is not set
 # CONFIG_NET_POLL_CONTROLLER is not set
+# CONFIG_VMXNET3 is not set
 # CONFIG_ISDN is not set
 # CONFIG_PHONE is not set
 
@@ -873,6 +1047,7 @@
 # CONFIG_SERIO_PCIPS2 is not set
 # CONFIG_SERIO_LIBPS2 is not set
 CONFIG_SERIO_RAW=m
+# CONFIG_SERIO_ALTERA_PS2 is not set
 # CONFIG_GAMEPORT is not set
 
 #
@@ -893,8 +1068,6 @@
 # CONFIG_N_HDLC is not set
 # CONFIG_RISCOM8 is not set
 # CONFIG_SPECIALIX is not set
-# CONFIG_SX is not set
-# CONFIG_RIO is not set
 # CONFIG_STALDRV is not set
 # CONFIG_NOZOMI is not set
 
@@ -911,7 +1084,9 @@
 CONFIG_SERIAL_CORE=y
 CONFIG_SERIAL_CORE_CONSOLE=y
 # CONFIG_SERIAL_JSM is not set
+# CONFIG_SERIAL_TIMBERDALE is not set
 CONFIG_UNIX98_PTYS=y
+# CONFIG_DEVPTS_MULTIPLE_INSTANCES is not set
 CONFIG_LEGACY_PTYS=y
 CONFIG_LEGACY_PTY_COUNT=256
 # CONFIG_IPMI_HANDLER is not set
@@ -923,89 +1098,99 @@
 CONFIG_DEVPORT=y
 CONFIG_I2C=y
 CONFIG_I2C_BOARDINFO=y
+CONFIG_I2C_COMPAT=y
 CONFIG_I2C_CHARDEV=y
+CONFIG_I2C_HELPER_AUTO=y
 
 #
 # I2C Hardware Bus support
 #
+
+#
+# PC SMBus host controller drivers
+#
 # CONFIG_I2C_ALI1535 is not set
 # CONFIG_I2C_ALI1563 is not set
 # CONFIG_I2C_ALI15X3 is not set
 # CONFIG_I2C_AMD756 is not set
 # CONFIG_I2C_AMD8111 is not set
 # CONFIG_I2C_I801 is not set
-# CONFIG_I2C_I810 is not set
+# CONFIG_I2C_ISCH is not set
 # CONFIG_I2C_PIIX4 is not set
 # CONFIG_I2C_NFORCE2 is not set
-# CONFIG_I2C_OCORES is not set
-# CONFIG_I2C_PARPORT_LIGHT is not set
-# CONFIG_I2C_PROSAVAGE is not set
-# CONFIG_I2C_SAVAGE4 is not set
-CONFIG_I2C_SIBYTE=y
-# CONFIG_I2C_SIMTEC is not set
 # CONFIG_I2C_SIS5595 is not set
 # CONFIG_I2C_SIS630 is not set
 # CONFIG_I2C_SIS96X is not set
-# CONFIG_I2C_TAOS_EVM is not set
-# CONFIG_I2C_STUB is not set
 # CONFIG_I2C_VIA is not set
 # CONFIG_I2C_VIAPRO is not set
-# CONFIG_I2C_VOODOO3 is not set
-# CONFIG_I2C_PCA_PLATFORM is not set
 
 #
-# Miscellaneous I2C Chip support
+# I2C system bus drivers (mostly embedded / system-on-chip)
 #
-# CONFIG_DS1682 is not set
-CONFIG_EEPROM_LEGACY=y
-CONFIG_SENSORS_PCF8574=y
-# CONFIG_PCF8575 is not set
-CONFIG_SENSORS_PCF8591=y
-CONFIG_EEPROM_MAX6875=y
-# CONFIG_SENSORS_TSL2550 is not set
+# CONFIG_I2C_OCORES is not set
+# CONFIG_I2C_SIMTEC is not set
+# CONFIG_I2C_XILINX is not set
+
+#
+# External I2C/SMBus adapter drivers
+#
+# CONFIG_I2C_PARPORT_LIGHT is not set
+# CONFIG_I2C_TAOS_EVM is not set
+
+#
+# Other I2C/SMBus bus drivers
+#
+# CONFIG_I2C_PCA_PLATFORM is not set
+CONFIG_I2C_SIBYTE=y
+# CONFIG_I2C_STUB is not set
 CONFIG_I2C_DEBUG_CORE=y
 CONFIG_I2C_DEBUG_ALGO=y
 CONFIG_I2C_DEBUG_BUS=y
-CONFIG_I2C_DEBUG_CHIP=y
 # CONFIG_SPI is not set
+
+#
+# PPS support
+#
+# CONFIG_PPS is not set
 # CONFIG_W1 is not set
 # CONFIG_POWER_SUPPLY is not set
 # CONFIG_HWMON is not set
 # CONFIG_THERMAL is not set
-# CONFIG_THERMAL_HWMON is not set
 # CONFIG_WATCHDOG is not set
+CONFIG_SSB_POSSIBLE=y
 
 #
 # Sonics Silicon Backplane
 #
-CONFIG_SSB_POSSIBLE=y
 # CONFIG_SSB is not set
 
 #
 # Multifunction device drivers
 #
+# CONFIG_MFD_CORE is not set
+# CONFIG_MFD_88PM860X is not set
 # CONFIG_MFD_SM501 is not set
 # CONFIG_HTC_PASIC3 is not set
-
-#
-# Multimedia devices
-#
-
-#
-# Multimedia core support
-#
-# CONFIG_VIDEO_DEV is not set
-# CONFIG_DVB_CORE is not set
-# CONFIG_VIDEO_MEDIA is not set
-
-#
-# Multimedia drivers
-#
-# CONFIG_DAB is not set
+# CONFIG_TWL4030_CORE is not set
+# CONFIG_MFD_TMIO is not set
+# CONFIG_PMIC_DA903X is not set
+# CONFIG_PMIC_ADP5520 is not set
+# CONFIG_MFD_MAX8925 is not set
+# CONFIG_MFD_WM8400 is not set
+# CONFIG_MFD_WM831X is not set
+# CONFIG_MFD_WM8350_I2C is not set
+# CONFIG_MFD_WM8994 is not set
+# CONFIG_MFD_PCF50633 is not set
+# CONFIG_AB3100_CORE is not set
+# CONFIG_LPC_SCH is not set
+# CONFIG_REGULATOR is not set
+# CONFIG_MEDIA_SUPPORT is not set
 
 #
 # Graphics support
 #
+CONFIG_VGA_ARB=y
+CONFIG_VGA_ARB_MAX_GPUS=16
 # CONFIG_DRM is not set
 # CONFIG_VGASTATE is not set
 # CONFIG_VIDEO_OUTPUT_CONTROL is not set
@@ -1016,10 +1201,6 @@
 # Display device support
 #
 # CONFIG_DISPLAY_SUPPORT is not set
-
-#
-# Sound
-#
 # CONFIG_SOUND is not set
 CONFIG_USB_SUPPORT=y
 CONFIG_USB_ARCH_HAS_HCD=y
@@ -1030,9 +1211,18 @@
 # CONFIG_USB_OTG_BLACKLIST_HUB is not set
 
 #
-# NOTE: USB_STORAGE enables SCSI, and 'SCSI disk support'
+# Enable Host or Gadget support to see Inventra options
+#
+
+#
+# NOTE: USB_STORAGE depends on SCSI but BLK_DEV_SD may
 #
 # CONFIG_USB_GADGET is not set
+
+#
+# OTG and related infrastructure
+#
+# CONFIG_UWB is not set
 # CONFIG_MMC is not set
 # CONFIG_MEMSTICK is not set
 # CONFIG_NEW_LEDS is not set
@@ -1040,41 +1230,66 @@
 # CONFIG_INFINIBAND is not set
 CONFIG_RTC_LIB=y
 # CONFIG_RTC_CLASS is not set
+# CONFIG_DMADEVICES is not set
+# CONFIG_AUXDISPLAY is not set
 # CONFIG_UIO is not set
 
 #
+# TI VLYNQ
+#
+# CONFIG_STAGING is not set
+
+#
 # File systems
 #
 CONFIG_EXT2_FS=m
 CONFIG_EXT2_FS_XATTR=y
-# CONFIG_EXT2_FS_POSIX_ACL is not set
-# CONFIG_EXT2_FS_SECURITY is not set
-# CONFIG_EXT2_FS_XIP is not set
-CONFIG_EXT3_FS=y
+CONFIG_EXT2_FS_POSIX_ACL=y
+CONFIG_EXT2_FS_SECURITY=y
+CONFIG_EXT2_FS_XIP=y
+CONFIG_EXT3_FS=m
+CONFIG_EXT3_DEFAULTS_TO_ORDERED=y
 CONFIG_EXT3_FS_XATTR=y
-# CONFIG_EXT3_FS_POSIX_ACL is not set
-# CONFIG_EXT3_FS_SECURITY is not set
-# CONFIG_EXT4DEV_FS is not set
-CONFIG_JBD=y
+CONFIG_EXT3_FS_POSIX_ACL=y
+CONFIG_EXT3_FS_SECURITY=y
+CONFIG_EXT4_FS=y
+CONFIG_EXT4_FS_XATTR=y
+CONFIG_EXT4_FS_POSIX_ACL=y
+CONFIG_EXT4_FS_SECURITY=y
+# CONFIG_EXT4_DEBUG is not set
+CONFIG_FS_XIP=y
+CONFIG_JBD=m
+CONFIG_JBD2=y
 CONFIG_FS_MBCACHE=y
 # CONFIG_REISERFS_FS is not set
 # CONFIG_JFS_FS is not set
-# CONFIG_FS_POSIX_ACL is not set
+CONFIG_FS_POSIX_ACL=y
 # CONFIG_XFS_FS is not set
 # CONFIG_GFS2_FS is not set
 # CONFIG_OCFS2_FS is not set
+# CONFIG_BTRFS_FS is not set
+# CONFIG_NILFS2_FS is not set
+CONFIG_FILE_LOCKING=y
+CONFIG_FSNOTIFY=y
 CONFIG_DNOTIFY=y
 CONFIG_INOTIFY=y
 CONFIG_INOTIFY_USER=y
 CONFIG_QUOTA=y
 CONFIG_QUOTA_NETLINK_INTERFACE=y
 # CONFIG_PRINT_QUOTA_WARNING is not set
+CONFIG_QUOTA_TREE=m
 # CONFIG_QFMT_V1 is not set
 CONFIG_QFMT_V2=m
 CONFIG_QUOTACTL=y
 CONFIG_AUTOFS_FS=m
 CONFIG_AUTOFS4_FS=m
 CONFIG_FUSE_FS=m
+# CONFIG_CUSE is not set
+
+#
+# Caches
+#
+# CONFIG_FSCACHE is not set
 
 #
 # CD-ROM/DVD Filesystems
@@ -1103,15 +1318,13 @@
 CONFIG_PROC_FS=y
 CONFIG_PROC_KCORE=y
 CONFIG_PROC_SYSCTL=y
+CONFIG_PROC_PAGE_MONITOR=y
 CONFIG_SYSFS=y
 CONFIG_TMPFS=y
 # CONFIG_TMPFS_POSIX_ACL is not set
 # CONFIG_HUGETLB_PAGE is not set
 CONFIG_CONFIGFS_FS=m
-
-#
-# Miscellaneous filesystems
-#
+CONFIG_MISC_FILESYSTEMS=y
 # CONFIG_ADFS_FS is not set
 # CONFIG_AFFS_FS is not set
 # CONFIG_ECRYPT_FS is not set
@@ -1120,9 +1333,12 @@
 # CONFIG_BEFS_FS is not set
 # CONFIG_BFS_FS is not set
 # CONFIG_EFS_FS is not set
+# CONFIG_LOGFS is not set
 # CONFIG_CRAMFS is not set
+# CONFIG_SQUASHFS is not set
 # CONFIG_VXFS_FS is not set
 # CONFIG_MINIX_FS is not set
+# CONFIG_OMFS_FS is not set
 # CONFIG_HPFS_FS is not set
 # CONFIG_QNX4FS_FS is not set
 # CONFIG_ROMFS_FS is not set
@@ -1133,16 +1349,17 @@
 CONFIG_NFS_V3=y
 # CONFIG_NFS_V3_ACL is not set
 # CONFIG_NFS_V4 is not set
-# CONFIG_NFSD is not set
 CONFIG_ROOT_NFS=y
+# CONFIG_NFSD is not set
 CONFIG_LOCKD=y
 CONFIG_LOCKD_V4=y
 CONFIG_NFS_COMMON=y
 CONFIG_SUNRPC=y
-# CONFIG_SUNRPC_BIND34 is not set
-# CONFIG_RPCSEC_GSS_KRB5 is not set
-# CONFIG_RPCSEC_GSS_SPKM3 is not set
+CONFIG_SUNRPC_GSS=m
+CONFIG_RPCSEC_GSS_KRB5=m
+CONFIG_RPCSEC_GSS_SPKM3=m
 # CONFIG_SMB_FS is not set
+# CONFIG_CEPH_FS is not set
 # CONFIG_CIFS is not set
 # CONFIG_NCP_FS is not set
 # CONFIG_CODA_FS is not set
@@ -1205,12 +1422,18 @@
 CONFIG_ENABLE_MUST_CHECK=y
 CONFIG_FRAME_WARN=2048
 CONFIG_MAGIC_SYSRQ=y
+# CONFIG_STRIP_ASM_SYMS is not set
 # CONFIG_UNUSED_SYMBOLS is not set
 # CONFIG_DEBUG_FS is not set
 # CONFIG_HEADERS_CHECK is not set
 CONFIG_DEBUG_KERNEL=y
 # CONFIG_DEBUG_SHIRQ is not set
 CONFIG_DETECT_SOFTLOCKUP=y
+# CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC is not set
+CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC_VALUE=0
+CONFIG_DETECT_HUNG_TASK=y
+# CONFIG_BOOTPARAM_HUNG_TASK_PANIC is not set
+CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE=0
 CONFIG_SCHED_DEBUG=y
 # CONFIG_SCHEDSTATS is not set
 # CONFIG_TIMER_STATS is not set
@@ -1219,23 +1442,53 @@
 # CONFIG_DEBUG_RT_MUTEXES is not set
 # CONFIG_RT_MUTEX_TESTER is not set
 # CONFIG_DEBUG_SPINLOCK is not set
-CONFIG_DEBUG_MUTEXES=y
+# CONFIG_DEBUG_MUTEXES is not set
 # CONFIG_DEBUG_LOCK_ALLOC is not set
 # CONFIG_PROVE_LOCKING is not set
 # CONFIG_LOCK_STAT is not set
-# CONFIG_DEBUG_SPINLOCK_SLEEP is not set
+CONFIG_DEBUG_SPINLOCK_SLEEP=y
 # CONFIG_DEBUG_LOCKING_API_SELFTESTS is not set
 # CONFIG_DEBUG_KOBJECT is not set
 # CONFIG_DEBUG_INFO is not set
 # CONFIG_DEBUG_VM is not set
 # CONFIG_DEBUG_WRITECOUNT is not set
-# CONFIG_DEBUG_LIST is not set
+CONFIG_DEBUG_MEMORY_INIT=y
+CONFIG_DEBUG_LIST=y
 # CONFIG_DEBUG_SG is not set
+# CONFIG_DEBUG_NOTIFIERS is not set
+# CONFIG_DEBUG_CREDENTIALS is not set
 # CONFIG_BOOT_PRINTK_DELAY is not set
 # CONFIG_RCU_TORTURE_TEST is not set
+CONFIG_RCU_CPU_STALL_DETECTOR=y
 # CONFIG_BACKTRACE_SELF_TEST is not set
+# CONFIG_DEBUG_BLOCK_EXT_DEVT is not set
+# CONFIG_DEBUG_FORCE_WEAK_PER_CPU is not set
 # CONFIG_FAULT_INJECTION is not set
+# CONFIG_SYSCTL_SYSCALL_CHECK is not set
+# CONFIG_PAGE_POISONING is not set
+CONFIG_HAVE_FUNCTION_TRACER=y
+CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y
+CONFIG_HAVE_FUNCTION_TRACE_MCOUNT_TEST=y
+CONFIG_HAVE_DYNAMIC_FTRACE=y
+CONFIG_HAVE_FTRACE_MCOUNT_RECORD=y
+CONFIG_TRACING_SUPPORT=y
+CONFIG_FTRACE=y
+# CONFIG_FUNCTION_TRACER is not set
+# CONFIG_IRQSOFF_TRACER is not set
+# CONFIG_SCHED_TRACER is not set
+# CONFIG_ENABLE_DEFAULT_TRACERS is not set
+# CONFIG_BOOT_TRACER is not set
+CONFIG_BRANCH_PROFILE_NONE=y
+# CONFIG_PROFILE_ANNOTATED_BRANCHES is not set
+# CONFIG_PROFILE_ALL_BRANCHES is not set
+# CONFIG_STACK_TRACER is not set
+# CONFIG_KMEMTRACE is not set
+# CONFIG_WORKQUEUE_TRACER is not set
+# CONFIG_BLK_DEV_IO_TRACE is not set
 # CONFIG_SAMPLES is not set
+CONFIG_HAVE_ARCH_KGDB=y
+# CONFIG_KGDB is not set
+CONFIG_EARLY_PRINTK=y
 # CONFIG_CMDLINE_BOOL is not set
 # CONFIG_DEBUG_STACK_USAGE is not set
 # CONFIG_SB1XXX_CORELIS is not set
@@ -1246,20 +1499,50 @@
 #
 CONFIG_KEYS=y
 CONFIG_KEYS_DEBUG_PROC_KEYS=y
-# CONFIG_SECURITY is not set
-# CONFIG_SECURITY_FILE_CAPABILITIES is not set
+CONFIG_SECURITY=y
+# CONFIG_SECURITYFS is not set
+CONFIG_SECURITY_NETWORK=y
+CONFIG_SECURITY_NETWORK_XFRM=y
+# CONFIG_SECURITY_PATH is not set
+CONFIG_LSM_MMAP_MIN_ADDR=65536
+CONFIG_SECURITY_SELINUX=y
+CONFIG_SECURITY_SELINUX_BOOTPARAM=y
+CONFIG_SECURITY_SELINUX_BOOTPARAM_VALUE=1
+CONFIG_SECURITY_SELINUX_DISABLE=y
+CONFIG_SECURITY_SELINUX_DEVELOP=y
+CONFIG_SECURITY_SELINUX_AVC_STATS=y
+CONFIG_SECURITY_SELINUX_CHECKREQPROT_VALUE=1
+# CONFIG_SECURITY_SELINUX_POLICYDB_VERSION_MAX is not set
+# CONFIG_SECURITY_SMACK is not set
+# CONFIG_SECURITY_TOMOYO is not set
+# CONFIG_DEFAULT_SECURITY_SELINUX is not set
+# CONFIG_DEFAULT_SECURITY_SMACK is not set
+# CONFIG_DEFAULT_SECURITY_TOMOYO is not set
+CONFIG_DEFAULT_SECURITY_DAC=y
+CONFIG_DEFAULT_SECURITY=""
 CONFIG_CRYPTO=y
 
 #
 # Crypto core or helper
 #
+# CONFIG_CRYPTO_FIPS is not set
 CONFIG_CRYPTO_ALGAPI=y
+CONFIG_CRYPTO_ALGAPI2=y
 CONFIG_CRYPTO_AEAD=m
+CONFIG_CRYPTO_AEAD2=y
 CONFIG_CRYPTO_BLKCIPHER=y
+CONFIG_CRYPTO_BLKCIPHER2=y
 CONFIG_CRYPTO_HASH=y
+CONFIG_CRYPTO_HASH2=y
+CONFIG_CRYPTO_RNG=m
+CONFIG_CRYPTO_RNG2=y
+CONFIG_CRYPTO_PCOMP=y
 CONFIG_CRYPTO_MANAGER=y
+CONFIG_CRYPTO_MANAGER2=y
 CONFIG_CRYPTO_GF128MUL=m
 CONFIG_CRYPTO_NULL=y
+# CONFIG_CRYPTO_PCRYPT is not set
+CONFIG_CRYPTO_WORKQUEUE=y
 # CONFIG_CRYPTO_CRYPTD is not set
 CONFIG_CRYPTO_AUTHENC=m
 # CONFIG_CRYPTO_TEST is not set
@@ -1276,7 +1559,7 @@
 #
 CONFIG_CRYPTO_CBC=m
 CONFIG_CRYPTO_CTR=m
-# CONFIG_CRYPTO_CTS is not set
+CONFIG_CRYPTO_CTS=m
 CONFIG_CRYPTO_ECB=m
 CONFIG_CRYPTO_LRW=m
 CONFIG_CRYPTO_PCBC=m
@@ -1287,14 +1570,20 @@
 #
 CONFIG_CRYPTO_HMAC=y
 CONFIG_CRYPTO_XCBC=m
+CONFIG_CRYPTO_VMAC=m
 
 #
 # Digest
 #
-# CONFIG_CRYPTO_CRC32C is not set
+CONFIG_CRYPTO_CRC32C=m
+CONFIG_CRYPTO_GHASH=m
 CONFIG_CRYPTO_MD4=m
 CONFIG_CRYPTO_MD5=y
 CONFIG_CRYPTO_MICHAEL_MIC=m
+CONFIG_CRYPTO_RMD128=m
+CONFIG_CRYPTO_RMD160=m
+CONFIG_CRYPTO_RMD256=m
+CONFIG_CRYPTO_RMD320=m
 CONFIG_CRYPTO_SHA1=m
 CONFIG_CRYPTO_SHA256=m
 CONFIG_CRYPTO_SHA512=m
@@ -1325,25 +1614,36 @@
 # Compression
 #
 CONFIG_CRYPTO_DEFLATE=m
-# CONFIG_CRYPTO_LZO is not set
+CONFIG_CRYPTO_ZLIB=m
+CONFIG_CRYPTO_LZO=m
+
+#
+# Random Number Generation
+#
+CONFIG_CRYPTO_ANSI_CPRNG=m
 CONFIG_CRYPTO_HW=y
 # CONFIG_CRYPTO_DEV_HIFN_795X is not set
+# CONFIG_BINARY_PRINTF is not set
 
 #
 # Library routines
 #
 CONFIG_BITREVERSE=y
-# CONFIG_GENERIC_FIND_FIRST_BIT is not set
+CONFIG_GENERIC_FIND_LAST_BIT=y
 CONFIG_CRC_CCITT=m
-# CONFIG_CRC16 is not set
+CONFIG_CRC16=y
+CONFIG_CRC_T10DIF=m
 CONFIG_CRC_ITU_T=m
 CONFIG_CRC32=y
-# CONFIG_CRC7 is not set
+CONFIG_CRC7=m
 CONFIG_LIBCRC32C=m
 CONFIG_AUDIT_GENERIC=y
-CONFIG_ZLIB_INFLATE=m
+CONFIG_ZLIB_INFLATE=y
 CONFIG_ZLIB_DEFLATE=m
-CONFIG_PLIST=y
+CONFIG_LZO_COMPRESS=m
+CONFIG_LZO_DECOMPRESS=m
+CONFIG_DECOMPRESS_GZIP=y
 CONFIG_HAS_IOMEM=y
 CONFIG_HAS_IOPORT=y
 CONFIG_HAS_DMA=y
+CONFIG_NLATTR=y
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/abi.h linux-2.6.34-rc4/arch/mips/include/asm/abi.h
--- linux-2.6.34-rc3/arch/mips/include/asm/abi.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/abi.h	2010-04-13 02:19:00.488633103 +0000
@@ -13,12 +13,14 @@
 #include <asm/siginfo.h>
 
 struct mips_abi {
-	int (* const setup_frame)(struct k_sigaction * ka,
+	int (* const setup_frame)(void *sig_return, struct k_sigaction *ka,
 	                          struct pt_regs *regs, int signr,
 	                          sigset_t *set);
-	int (* const setup_rt_frame)(struct k_sigaction * ka,
+	const unsigned long	signal_return_offset;
+	int (* const setup_rt_frame)(void *sig_return, struct k_sigaction *ka,
 	                       struct pt_regs *regs, int signr,
 	                       sigset_t *set, siginfo_t *info);
+	const unsigned long	rt_signal_return_offset;
 	const unsigned long	restart;
 };
 
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/elf.h linux-2.6.34-rc4/arch/mips/include/asm/elf.h
--- linux-2.6.34-rc3/arch/mips/include/asm/elf.h	2010-04-13 02:18:55.423633040 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/elf.h	2010-04-13 02:19:00.490633051 +0000
@@ -310,6 +310,7 @@
 
 #endif /* CONFIG_64BIT */
 
+struct pt_regs;
 struct task_struct;
 
 extern void elf_dump_regs(elf_greg_t *, struct pt_regs *regs);
@@ -367,4 +368,8 @@
 #define ELF_ET_DYN_BASE         (TASK_SIZE / 3 * 2)
 #endif
 
+#define ARCH_HAS_SETUP_ADDITIONAL_PAGES 1
+struct linux_binprm;
+extern int arch_setup_additional_pages(struct linux_binprm *bprm,
+				       int uses_interp);
 #endif /* _ASM_ELF_H */
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/fpu_emulator.h linux-2.6.34-rc4/arch/mips/include/asm/fpu_emulator.h
--- linux-2.6.34-rc3/arch/mips/include/asm/fpu_emulator.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/fpu_emulator.h	2010-04-13 02:19:00.490633051 +0000
@@ -41,7 +41,11 @@
 DECLARE_PER_CPU(struct mips_fpu_emulator_stats, fpuemustats);
 
 #define MIPS_FPU_EMU_INC_STATS(M)					\
-	cpu_local_wrap(__local_inc(&__get_cpu_var(fpuemustats).M))
+do {									\
+	preempt_disable();						\
+	__local_inc(&__get_cpu_var(fpuemustats).M);			\
+	preempt_enable();						\
+} while (0)
 
 #else
 #define MIPS_FPU_EMU_INC_STATS(M) do { } while (0)
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_cpu.h linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_cpu.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_cpu.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_cpu.h	2010-04-13 02:19:00.492633036 +0000
@@ -85,6 +85,7 @@
 	RSET_TIMER,
 	RSET_WDT,
 	RSET_UART0,
+	RSET_UART1,
 	RSET_GPIO,
 	RSET_SPI,
 	RSET_UDC0,
@@ -123,6 +124,7 @@
 #define BCM_6338_TIMER_BASE		(0xfffe0200)
 #define BCM_6338_WDT_BASE		(0xfffe021c)
 #define BCM_6338_UART0_BASE		(0xfffe0300)
+#define BCM_6338_UART1_BASE		(0xdeadbeef)
 #define BCM_6338_GPIO_BASE		(0xfffe0400)
 #define BCM_6338_SPI_BASE		(0xfffe0c00)
 #define BCM_6338_UDC0_BASE		(0xdeadbeef)
@@ -153,6 +155,7 @@
 #define BCM_6345_TIMER_BASE		(0xfffe0200)
 #define BCM_6345_WDT_BASE		(0xfffe021c)
 #define BCM_6345_UART0_BASE		(0xfffe0300)
+#define BCM_6345_UART1_BASE		(0xdeadbeef)
 #define BCM_6345_GPIO_BASE		(0xfffe0400)
 #define BCM_6345_SPI_BASE		(0xdeadbeef)
 #define BCM_6345_UDC0_BASE		(0xdeadbeef)
@@ -182,6 +185,7 @@
 #define BCM_6348_TIMER_BASE		(0xfffe0200)
 #define BCM_6348_WDT_BASE		(0xfffe021c)
 #define BCM_6348_UART0_BASE		(0xfffe0300)
+#define BCM_6348_UART1_BASE		(0xdeadbeef)
 #define BCM_6348_GPIO_BASE		(0xfffe0400)
 #define BCM_6348_SPI_BASE		(0xfffe0c00)
 #define BCM_6348_UDC0_BASE		(0xfffe1000)
@@ -208,6 +212,7 @@
 #define BCM_6358_TIMER_BASE		(0xfffe0040)
 #define BCM_6358_WDT_BASE		(0xfffe005c)
 #define BCM_6358_UART0_BASE		(0xfffe0100)
+#define BCM_6358_UART1_BASE		(0xfffe0120)
 #define BCM_6358_GPIO_BASE		(0xfffe0080)
 #define BCM_6358_SPI_BASE		(0xdeadbeef)
 #define BCM_6358_UDC0_BASE		(0xfffe0800)
@@ -246,6 +251,8 @@
 		return BCM_6338_WDT_BASE;
 	case RSET_UART0:
 		return BCM_6338_UART0_BASE;
+	case RSET_UART1:
+		return BCM_6338_UART1_BASE;
 	case RSET_GPIO:
 		return BCM_6338_GPIO_BASE;
 	case RSET_SPI:
@@ -292,6 +299,8 @@
 		return BCM_6345_WDT_BASE;
 	case RSET_UART0:
 		return BCM_6345_UART0_BASE;
+	case RSET_UART1:
+		return BCM_6345_UART1_BASE;
 	case RSET_GPIO:
 		return BCM_6345_GPIO_BASE;
 	case RSET_SPI:
@@ -338,6 +347,8 @@
 		return BCM_6348_WDT_BASE;
 	case RSET_UART0:
 		return BCM_6348_UART0_BASE;
+	case RSET_UART1:
+		return BCM_6348_UART1_BASE;
 	case RSET_GPIO:
 		return BCM_6348_GPIO_BASE;
 	case RSET_SPI:
@@ -384,6 +395,8 @@
 		return BCM_6358_WDT_BASE;
 	case RSET_UART0:
 		return BCM_6358_UART0_BASE;
+	case RSET_UART1:
+		return BCM_6358_UART1_BASE;
 	case RSET_GPIO:
 		return BCM_6358_GPIO_BASE;
 	case RSET_SPI:
@@ -429,6 +442,7 @@
 enum bcm63xx_irq {
 	IRQ_TIMER = 0,
 	IRQ_UART0,
+	IRQ_UART1,
 	IRQ_DSL,
 	IRQ_ENET0,
 	IRQ_ENET1,
@@ -510,6 +524,7 @@
  */
 #define BCM_6358_TIMER_IRQ		(IRQ_INTERNAL_BASE + 0)
 #define BCM_6358_UART0_IRQ		(IRQ_INTERNAL_BASE + 2)
+#define BCM_6358_UART1_IRQ		(IRQ_INTERNAL_BASE + 3)
 #define BCM_6358_OHCI0_IRQ		(IRQ_INTERNAL_BASE + 5)
 #define BCM_6358_ENET1_IRQ		(IRQ_INTERNAL_BASE + 6)
 #define BCM_6358_ENET0_IRQ		(IRQ_INTERNAL_BASE + 8)
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_dev_uart.h linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_dev_uart.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_dev_uart.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_dev_uart.h	2010-04-13 02:19:00.492633036 +0000
@@ -0,0 +1,6 @@
+#ifndef BCM63XX_DEV_UART_H_
+#define BCM63XX_DEV_UART_H_
+
+int bcm63xx_uart_register(unsigned int id);
+
+#endif /* BCM63XX_DEV_UART_H_ */
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h	2010-04-13 02:19:00.492633036 +0000
@@ -10,6 +10,10 @@
 	switch (bcm63xx_get_cpu_id()) {
 	case BCM6358_CPU_ID:
 		return 40;
+	case BCM6338_CPU_ID:
+		return 8;
+	case BCM6345_CPU_ID:
+		return 16;
 	case BCM6348_CPU_ID:
 	default:
 		return 37;
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/board_bcm963xx.h linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/board_bcm963xx.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/board_bcm963xx.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/board_bcm963xx.h	2010-04-13 02:19:00.492633036 +0000
@@ -45,6 +45,8 @@
 	unsigned int	has_ohci0:1;
 	unsigned int	has_ehci0:1;
 	unsigned int	has_dsp:1;
+	unsigned int	has_uart0:1;
+	unsigned int	has_uart1:1;
 
 	/* ethernet config */
 	struct bcm63xx_enet_platform_data enet0;
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/cpu-feature-overrides.h linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/cpu-feature-overrides.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-bcm63xx/cpu-feature-overrides.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-bcm63xx/cpu-feature-overrides.h	2010-04-13 02:19:00.492633036 +0000
@@ -24,7 +24,7 @@
 #define cpu_has_smartmips		0
 #define cpu_has_vtag_icache		0
 
-#if !defined(BCMCPU_RUNTIME_DETECT) && (defined(CONFIG_BCMCPU_IS_6348) || defined(CONFIG_CPU_IS_6338) || defined(CONFIG_CPU_IS_BCM6345))
+#if !defined(BCMCPU_RUNTIME_DETECT) && (defined(CONFIG_BCM63XX_CPU_6348) || defined(CONFIG_BCM63XX_CPU_6345) || defined(CONFIG_BCM63XX_CPU_6338))
 #define cpu_has_dc_aliases		0
 #endif
 
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mach-sibyte/war.h linux-2.6.34-rc4/arch/mips/include/asm/mach-sibyte/war.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mach-sibyte/war.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mach-sibyte/war.h	2010-04-13 02:19:00.495633083 +0000
@@ -16,7 +16,11 @@
 #if defined(CONFIG_SB1_PASS_1_WORKAROUNDS) || \
     defined(CONFIG_SB1_PASS_2_WORKAROUNDS)
 
-#define BCM1250_M3_WAR	1
+#ifndef __ASSEMBLY__
+extern int sb1250_m3_workaround_needed(void);
+#endif
+
+#define BCM1250_M3_WAR	sb1250_m3_workaround_needed()
 #define SIBYTE_1956_WAR	1
 
 #else
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mmu.h linux-2.6.34-rc4/arch/mips/include/asm/mmu.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mmu.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mmu.h	2010-04-13 02:19:00.495633083 +0000
@@ -1,6 +1,9 @@
 #ifndef __ASM_MMU_H
 #define __ASM_MMU_H
 
-typedef unsigned long mm_context_t[NR_CPUS];
+typedef struct {
+	unsigned long asid[NR_CPUS];
+	void *vdso;
+} mm_context_t;
 
 #endif /* __ASM_MMU_H */
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/mmu_context.h linux-2.6.34-rc4/arch/mips/include/asm/mmu_context.h
--- linux-2.6.34-rc3/arch/mips/include/asm/mmu_context.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/mmu_context.h	2010-04-13 02:19:00.496633101 +0000
@@ -104,7 +104,7 @@
 
 #endif
 
-#define cpu_context(cpu, mm)	((mm)->context[cpu])
+#define cpu_context(cpu, mm)	((mm)->context.asid[cpu])
 #define cpu_asid(cpu, mm)	(cpu_context((cpu), (mm)) & ASID_MASK)
 #define asid_cache(cpu)		(cpu_data[cpu].asid_cache)
 
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/page.h linux-2.6.34-rc4/arch/mips/include/asm/page.h
--- linux-2.6.34-rc3/arch/mips/include/asm/page.h	2010-04-13 02:18:55.429571644 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/page.h	2010-04-13 02:19:00.496633101 +0000
@@ -188,8 +188,10 @@
 #define VM_DATA_DEFAULT_FLAGS	(VM_READ | VM_WRITE | VM_EXEC | \
 				 VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC)
 
-#define UNCAC_ADDR(addr)	((addr) - PAGE_OFFSET + UNCAC_BASE)
-#define CAC_ADDR(addr)		((addr) - UNCAC_BASE + PAGE_OFFSET)
+#define UNCAC_ADDR(addr)	((addr) - PAGE_OFFSET + UNCAC_BASE + 	\
+								PHYS_OFFSET)
+#define CAC_ADDR(addr)		((addr) - UNCAC_BASE + PAGE_OFFSET -	\
+								PHYS_OFFSET)
 
 #include <asm-generic/memory_model.h>
 #include <asm-generic/getorder.h>
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/processor.h linux-2.6.34-rc4/arch/mips/include/asm/processor.h
--- linux-2.6.34-rc3/arch/mips/include/asm/processor.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/processor.h	2010-04-13 02:19:00.497633074 +0000
@@ -33,13 +33,19 @@
 
 extern unsigned int vced_count, vcei_count;
 
+/*
+ * A special page (the vdso) is mapped into all processes at the very
+ * top of the virtual memory space.
+ */
+#define SPECIAL_PAGES_SIZE PAGE_SIZE
+
 #ifdef CONFIG_32BIT
 /*
  * User space process size: 2GB. This is hardcoded into a few places,
  * so don't change it unless you know what you are doing.
  */
 #define TASK_SIZE	0x7fff8000UL
-#define STACK_TOP	TASK_SIZE
+#define STACK_TOP	((TASK_SIZE & PAGE_MASK) - SPECIAL_PAGES_SIZE)
 
 /*
  * This decides where the kernel will search for a free chunk of vm
@@ -59,7 +65,8 @@
 #define TASK_SIZE32	0x7fff8000UL
 #define TASK_SIZE	0x10000000000UL
 #define STACK_TOP	\
-      (test_thread_flag(TIF_32BIT_ADDR) ? TASK_SIZE32 : TASK_SIZE)
+	(((test_thread_flag(TIF_32BIT_ADDR) ?				\
+	   TASK_SIZE32 : TASK_SIZE) & PAGE_MASK) - SPECIAL_PAGES_SIZE)
 
 /*
  * This decides where the kernel will search for a free chunk of vm
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/stackframe.h linux-2.6.34-rc4/arch/mips/include/asm/stackframe.h
--- linux-2.6.34-rc3/arch/mips/include/asm/stackframe.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/stackframe.h	2010-04-13 02:19:00.498633061 +0000
@@ -121,6 +121,25 @@
 		.endm
 #else
 		.macro	get_saved_sp	/* Uniprocessor variation */
+#ifdef CONFIG_CPU_LOONGSON2F
+		/*
+		 * Clear BTB (branch target buffer), forbid RAS (return address
+		 * stack) to workaround the Out-of-order Issue in Loongson2F
+		 * via its diagnostic register.
+		 */
+		move	k0, ra
+		jal	1f
+		 nop
+1:		jal	1f
+		 nop
+1:		jal	1f
+		 nop
+1:		jal	1f
+		 nop
+1:		move	ra, k0
+		li	k0, 3
+		mtc0	k0, $22
+#endif /* CONFIG_CPU_LOONGSON2F */
 #if defined(CONFIG_32BIT) || defined(KBUILD_64BIT_SYM32)
 		lui	k1, %hi(kernelsp)
 #else
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/uasm.h linux-2.6.34-rc4/arch/mips/include/asm/uasm.h
--- linux-2.6.34-rc3/arch/mips/include/asm/uasm.h	2010-04-13 02:18:55.431633038 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/uasm.h	2010-04-13 02:19:00.498633061 +0000
@@ -84,6 +84,7 @@
 Ip_u1u2u3(_mfc0);
 Ip_u1u2u3(_mtc0);
 Ip_u2u1u3(_ori);
+Ip_u3u1u2(_or);
 Ip_u2s3u1(_pref);
 Ip_0(_rfe);
 Ip_u2s3u1(_sc);
@@ -102,6 +103,7 @@
 Ip_u3u1u2(_xor);
 Ip_u2u1u3(_xori);
 Ip_u2u1msbu3(_dins);
+Ip_u1(_syscall);
 
 /* Handle labels. */
 struct uasm_label {
diff -urN linux-2.6.34-rc3/arch/mips/include/asm/vdso.h linux-2.6.34-rc4/arch/mips/include/asm/vdso.h
--- linux-2.6.34-rc3/arch/mips/include/asm/vdso.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/include/asm/vdso.h	2010-04-13 02:19:00.499633079 +0000
@@ -0,0 +1,29 @@
+/*
+ * This file is subject to the terms and conditions of the GNU General Public
+ * License.  See the file "COPYING" in the main directory of this archive
+ * for more details.
+ *
+ * Copyright (C) 2009 Cavium Networks
+ */
+
+#ifndef __ASM_VDSO_H
+#define __ASM_VDSO_H
+
+#include <linux/types.h>
+
+
+#ifdef CONFIG_32BIT
+struct mips_vdso {
+	u32 signal_trampoline[2];
+	u32 rt_signal_trampoline[2];
+};
+#else  /* !CONFIG_32BIT */
+struct mips_vdso {
+	u32 o32_signal_trampoline[2];
+	u32 o32_rt_signal_trampoline[2];
+	u32 rt_signal_trampoline[2];
+	u32 n32_rt_signal_trampoline[2];
+};
+#endif /* CONFIG_32BIT */
+
+#endif /* __ASM_VDSO_H */
diff -urN linux-2.6.34-rc3/arch/mips/jazz/jazzdma.c linux-2.6.34-rc4/arch/mips/jazz/jazzdma.c
--- linux-2.6.34-rc3/arch/mips/jazz/jazzdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/jazz/jazzdma.c	2010-04-13 02:19:00.499633079 +0000
@@ -14,6 +14,7 @@
 #include <linux/mm.h>
 #include <linux/bootmem.h>
 #include <linux/spinlock.h>
+#include <linux/gfp.h>
 #include <asm/mipsregs.h>
 #include <asm/jazz.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/mips/kernel/Makefile linux-2.6.34-rc4/arch/mips/kernel/Makefile
--- linux-2.6.34-rc3/arch/mips/kernel/Makefile	2010-04-13 02:18:55.431633038 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/Makefile	2010-04-13 02:19:00.499633079 +0000
@@ -6,7 +6,7 @@
 
 obj-y		+= cpu-probe.o branch.o entry.o genex.o irq.o process.o \
 		   ptrace.o reset.o setup.o signal.o syscall.o \
-		   time.o topology.o traps.o unaligned.o watch.o
+		   time.o topology.o traps.o unaligned.o watch.o vdso.o
 
 ifdef CONFIG_FUNCTION_TRACER
 CFLAGS_REMOVE_ftrace.o = -pg
diff -urN linux-2.6.34-rc3/arch/mips/kernel/cpufreq/loongson2_clock.c linux-2.6.34-rc4/arch/mips/kernel/cpufreq/loongson2_clock.c
--- linux-2.6.34-rc3/arch/mips/kernel/cpufreq/loongson2_clock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/cpufreq/loongson2_clock.c	2010-04-13 02:19:00.500570707 +0000
@@ -164,3 +164,7 @@
 	spin_unlock_irqrestore(&loongson2_wait_lock, flags);
 }
 EXPORT_SYMBOL_GPL(loongson2_cpu_wait);
+
+MODULE_AUTHOR("Yanhua <yanh@lemote.com>");
+MODULE_DESCRIPTION("cpufreq driver for Loongson 2F");
+MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/arch/mips/kernel/irq.c linux-2.6.34-rc4/arch/mips/kernel/irq.c
--- linux-2.6.34-rc3/arch/mips/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/irq.c	2010-04-13 02:19:00.500570707 +0000
@@ -15,7 +15,6 @@
 #include <linux/kernel_stat.h>
 #include <linux/module.h>
 #include <linux/proc_fs.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/random.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/arch/mips/kernel/linux32.c linux-2.6.34-rc4/arch/mips/kernel/linux32.c
--- linux-2.6.34-rc3/arch/mips/kernel/linux32.c	2010-04-13 02:18:55.432633080 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/linux32.c	2010-04-13 02:19:00.500570707 +0000
@@ -15,7 +15,6 @@
 #include <linux/time.h>
 #include <linux/times.h>
 #include <linux/poll.h>
-#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/filter.h>
 #include <linux/shm.h>
@@ -34,6 +33,7 @@
 #include <linux/compat.h>
 #include <linux/vfs.h>
 #include <linux/ipc.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <net/scm.h>
diff -urN linux-2.6.34-rc3/arch/mips/kernel/process.c linux-2.6.34-rc4/arch/mips/kernel/process.c
--- linux-2.6.34-rc3/arch/mips/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/process.c	2010-04-13 02:19:00.500570707 +0000
@@ -17,7 +17,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/mman.h>
 #include <linux/personality.h>
 #include <linux/sys.h>
@@ -64,8 +63,13 @@
 
 			smtc_idle_loop_hook();
 #endif
-			if (cpu_wait)
+
+			if (cpu_wait) {
+				/* Don't trace irqs off for idle */
+				stop_critical_timings();
 				(*cpu_wait)();
+				start_critical_timings();
+			}
 		}
 #ifdef CONFIG_HOTPLUG_CPU
 		if (!cpu_online(cpu) && !cpu_isset(cpu, cpu_callin_map) &&
diff -urN linux-2.6.34-rc3/arch/mips/kernel/rtlx.c linux-2.6.34-rc4/arch/mips/kernel/rtlx.c
--- linux-2.6.34-rc3/arch/mips/kernel/rtlx.c	2010-04-13 02:18:55.433633046 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/rtlx.c	2010-04-13 02:19:00.501633139 +0000
@@ -23,7 +23,6 @@
 #include <linux/fs.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
-#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/vmalloc.h>
 #include <linux/elf.h>
diff -urN linux-2.6.34-rc3/arch/mips/kernel/signal-common.h linux-2.6.34-rc4/arch/mips/kernel/signal-common.h
--- linux-2.6.34-rc3/arch/mips/kernel/signal-common.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/signal-common.h	2010-04-13 02:19:00.501633139 +0000
@@ -26,11 +26,6 @@
  */
 extern void __user *get_sigframe(struct k_sigaction *ka, struct pt_regs *regs,
 				 size_t frame_size);
-/*
- * install trampoline code to get back from the sig handler
- */
-extern int install_sigtramp(unsigned int __user *tramp, unsigned int syscall);
-
 /* Check and clear pending FPU exceptions in saved CSR */
 extern int fpcsr_pending(unsigned int __user *fpcsr);
 
diff -urN linux-2.6.34-rc3/arch/mips/kernel/signal.c linux-2.6.34-rc4/arch/mips/kernel/signal.c
--- linux-2.6.34-rc3/arch/mips/kernel/signal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/signal.c	2010-04-13 02:19:00.501633139 +0000
@@ -32,6 +32,7 @@
 #include <asm/ucontext.h>
 #include <asm/cpu-features.h>
 #include <asm/war.h>
+#include <asm/vdso.h>
 
 #include "signal-common.h"
 
@@ -44,47 +45,20 @@
 extern asmlinkage int fpu_emulator_save_context(struct sigcontext __user *sc);
 extern asmlinkage int fpu_emulator_restore_context(struct sigcontext __user *sc);
 
-/*
- * Horribly complicated - with the bloody RM9000 workarounds enabled
- * the signal trampolines is moving to the end of the structure so we can
- * increase the alignment without breaking software compatibility.
- */
-#if ICACHE_REFILLS_WORKAROUND_WAR == 0
-
 struct sigframe {
 	u32 sf_ass[4];		/* argument save space for o32 */
-	u32 sf_code[2];		/* signal trampoline */
+	u32 sf_pad[2];		/* Was: signal trampoline */
 	struct sigcontext sf_sc;
 	sigset_t sf_mask;
 };
 
 struct rt_sigframe {
 	u32 rs_ass[4];		/* argument save space for o32 */
-	u32 rs_code[2];		/* signal trampoline */
+	u32 rs_pad[2];		/* Was: signal trampoline */
 	struct siginfo rs_info;
 	struct ucontext rs_uc;
 };
 
-#else
-
-struct sigframe {
-	u32 sf_ass[4];			/* argument save space for o32 */
-	u32 sf_pad[2];
-	struct sigcontext sf_sc;	/* hw context */
-	sigset_t sf_mask;
-	u32 sf_code[8] ____cacheline_aligned;	/* signal trampoline */
-};
-
-struct rt_sigframe {
-	u32 rs_ass[4];			/* argument save space for o32 */
-	u32 rs_pad[2];
-	struct siginfo rs_info;
-	struct ucontext rs_uc;
-	u32 rs_code[8] ____cacheline_aligned;	/* signal trampoline */
-};
-
-#endif
-
 /*
  * Helper routines
  */
@@ -266,32 +240,6 @@
 	return (void __user *)((sp - frame_size) & (ICACHE_REFILLS_WORKAROUND_WAR ? ~(cpu_icache_line_size()-1) : ALMASK));
 }
 
-int install_sigtramp(unsigned int __user *tramp, unsigned int syscall)
-{
-	int err;
-
-	/*
-	 * Set up the return code ...
-	 *
-	 *         li      v0, __NR__foo_sigreturn
-	 *         syscall
-	 */
-
-	err = __put_user(0x24020000 + syscall, tramp + 0);
-	err |= __put_user(0x0000000c         , tramp + 1);
-	if (ICACHE_REFILLS_WORKAROUND_WAR) {
-		err |= __put_user(0, tramp + 2);
-		err |= __put_user(0, tramp + 3);
-		err |= __put_user(0, tramp + 4);
-		err |= __put_user(0, tramp + 5);
-		err |= __put_user(0, tramp + 6);
-		err |= __put_user(0, tramp + 7);
-	}
-	flush_cache_sigtramp((unsigned long) tramp);
-
-	return err;
-}
-
 /*
  * Atomically swap in the new signal mask, and wait for a signal.
  */
@@ -484,8 +432,8 @@
 }
 
 #ifdef CONFIG_TRAD_SIGNALS
-static int setup_frame(struct k_sigaction * ka, struct pt_regs *regs,
-	int signr, sigset_t *set)
+static int setup_frame(void *sig_return, struct k_sigaction *ka,
+		       struct pt_regs *regs, int signr, sigset_t *set)
 {
 	struct sigframe __user *frame;
 	int err = 0;
@@ -494,8 +442,6 @@
 	if (!access_ok(VERIFY_WRITE, frame, sizeof (*frame)))
 		goto give_sigsegv;
 
-	err |= install_sigtramp(frame->sf_code, __NR_sigreturn);
-
 	err |= setup_sigcontext(regs, &frame->sf_sc);
 	err |= __copy_to_user(&frame->sf_mask, set, sizeof(*set));
 	if (err)
@@ -515,7 +461,7 @@
 	regs->regs[ 5] = 0;
 	regs->regs[ 6] = (unsigned long) &frame->sf_sc;
 	regs->regs[29] = (unsigned long) frame;
-	regs->regs[31] = (unsigned long) frame->sf_code;
+	regs->regs[31] = (unsigned long) sig_return;
 	regs->cp0_epc = regs->regs[25] = (unsigned long) ka->sa.sa_handler;
 
 	DEBUGP("SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%lx\n",
@@ -529,8 +475,9 @@
 }
 #endif
 
-static int setup_rt_frame(struct k_sigaction * ka, struct pt_regs *regs,
-	int signr, sigset_t *set, siginfo_t *info)
+static int setup_rt_frame(void *sig_return, struct k_sigaction *ka,
+			  struct pt_regs *regs,	int signr, sigset_t *set,
+			  siginfo_t *info)
 {
 	struct rt_sigframe __user *frame;
 	int err = 0;
@@ -539,8 +486,6 @@
 	if (!access_ok(VERIFY_WRITE, frame, sizeof (*frame)))
 		goto give_sigsegv;
 
-	err |= install_sigtramp(frame->rs_code, __NR_rt_sigreturn);
-
 	/* Create siginfo.  */
 	err |= copy_siginfo_to_user(&frame->rs_info, info);
 
@@ -573,7 +518,7 @@
 	regs->regs[ 5] = (unsigned long) &frame->rs_info;
 	regs->regs[ 6] = (unsigned long) &frame->rs_uc;
 	regs->regs[29] = (unsigned long) frame;
-	regs->regs[31] = (unsigned long) frame->rs_code;
+	regs->regs[31] = (unsigned long) sig_return;
 	regs->cp0_epc = regs->regs[25] = (unsigned long) ka->sa.sa_handler;
 
 	DEBUGP("SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%lx\n",
@@ -590,8 +535,11 @@
 struct mips_abi mips_abi = {
 #ifdef CONFIG_TRAD_SIGNALS
 	.setup_frame	= setup_frame,
+	.signal_return_offset = offsetof(struct mips_vdso, signal_trampoline),
 #endif
 	.setup_rt_frame	= setup_rt_frame,
+	.rt_signal_return_offset =
+		offsetof(struct mips_vdso, rt_signal_trampoline),
 	.restart	= __NR_restart_syscall
 };
 
@@ -599,6 +547,8 @@
 	struct k_sigaction *ka, sigset_t *oldset, struct pt_regs *regs)
 {
 	int ret;
+	struct mips_abi *abi = current->thread.abi;
+	void *vdso = current->mm->context.vdso;
 
 	switch(regs->regs[0]) {
 	case ERESTART_RESTARTBLOCK:
@@ -619,9 +569,11 @@
 	regs->regs[0] = 0;		/* Don't deal with this again.  */
 
 	if (sig_uses_siginfo(ka))
-		ret = current->thread.abi->setup_rt_frame(ka, regs, sig, oldset, info);
+		ret = abi->setup_rt_frame(vdso + abi->rt_signal_return_offset,
+					  ka, regs, sig, oldset, info);
 	else
-		ret = current->thread.abi->setup_frame(ka, regs, sig, oldset);
+		ret = abi->setup_frame(vdso + abi->signal_return_offset,
+				       ka, regs, sig, oldset);
 
 	spin_lock_irq(&current->sighand->siglock);
 	sigorsets(&current->blocked, &current->blocked, &ka->sa.sa_mask);
diff -urN linux-2.6.34-rc3/arch/mips/kernel/signal32.c linux-2.6.34-rc4/arch/mips/kernel/signal32.c
--- linux-2.6.34-rc3/arch/mips/kernel/signal32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/signal32.c	2010-04-13 02:19:00.501633139 +0000
@@ -32,6 +32,7 @@
 #include <asm/system.h>
 #include <asm/fpu.h>
 #include <asm/war.h>
+#include <asm/vdso.h>
 
 #include "signal-common.h"
 
@@ -47,8 +48,6 @@
 /*
  * Including <asm/unistd.h> would give use the 64-bit syscall numbers ...
  */
-#define __NR_O32_sigreturn		4119
-#define __NR_O32_rt_sigreturn		4193
 #define __NR_O32_restart_syscall        4253
 
 /* 32-bit compatibility types */
@@ -77,47 +76,20 @@
 	compat_sigset_t     uc_sigmask;   /* mask last for extensibility */
 };
 
-/*
- * Horribly complicated - with the bloody RM9000 workarounds enabled
- * the signal trampolines is moving to the end of the structure so we can
- * increase the alignment without breaking software compatibility.
- */
-#if ICACHE_REFILLS_WORKAROUND_WAR == 0
-
 struct sigframe32 {
 	u32 sf_ass[4];		/* argument save space for o32 */
-	u32 sf_code[2];		/* signal trampoline */
+	u32 sf_pad[2];		/* Was: signal trampoline */
 	struct sigcontext32 sf_sc;
 	compat_sigset_t sf_mask;
 };
 
 struct rt_sigframe32 {
 	u32 rs_ass[4];			/* argument save space for o32 */
-	u32 rs_code[2];			/* signal trampoline */
+	u32 rs_pad[2];			/* Was: signal trampoline */
 	compat_siginfo_t rs_info;
 	struct ucontext32 rs_uc;
 };
 
-#else  /* ICACHE_REFILLS_WORKAROUND_WAR */
-
-struct sigframe32 {
-	u32 sf_ass[4];			/* argument save space for o32 */
-	u32 sf_pad[2];
-	struct sigcontext32 sf_sc;	/* hw context */
-	compat_sigset_t sf_mask;
-	u32 sf_code[8] ____cacheline_aligned;	/* signal trampoline */
-};
-
-struct rt_sigframe32 {
-	u32 rs_ass[4];			/* argument save space for o32 */
-	u32 rs_pad[2];
-	compat_siginfo_t rs_info;
-	struct ucontext32 rs_uc;
-	u32 rs_code[8] __attribute__((aligned(32)));	/* signal trampoline */
-};
-
-#endif	/* !ICACHE_REFILLS_WORKAROUND_WAR */
-
 /*
  * sigcontext handlers
  */
@@ -598,8 +570,8 @@
 	force_sig(SIGSEGV, current);
 }
 
-static int setup_frame_32(struct k_sigaction * ka, struct pt_regs *regs,
-	int signr, sigset_t *set)
+static int setup_frame_32(void *sig_return, struct k_sigaction *ka,
+			  struct pt_regs *regs, int signr, sigset_t *set)
 {
 	struct sigframe32 __user *frame;
 	int err = 0;
@@ -608,8 +580,6 @@
 	if (!access_ok(VERIFY_WRITE, frame, sizeof (*frame)))
 		goto give_sigsegv;
 
-	err |= install_sigtramp(frame->sf_code, __NR_O32_sigreturn);
-
 	err |= setup_sigcontext32(regs, &frame->sf_sc);
 	err |= __copy_conv_sigset_to_user(&frame->sf_mask, set);
 
@@ -630,7 +600,7 @@
 	regs->regs[ 5] = 0;
 	regs->regs[ 6] = (unsigned long) &frame->sf_sc;
 	regs->regs[29] = (unsigned long) frame;
-	regs->regs[31] = (unsigned long) frame->sf_code;
+	regs->regs[31] = (unsigned long) sig_return;
 	regs->cp0_epc = regs->regs[25] = (unsigned long) ka->sa.sa_handler;
 
 	DEBUGP("SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%lx\n",
@@ -644,8 +614,9 @@
 	return -EFAULT;
 }
 
-static int setup_rt_frame_32(struct k_sigaction * ka, struct pt_regs *regs,
-	int signr, sigset_t *set, siginfo_t *info)
+static int setup_rt_frame_32(void *sig_return, struct k_sigaction *ka,
+			     struct pt_regs *regs, int signr, sigset_t *set,
+			     siginfo_t *info)
 {
 	struct rt_sigframe32 __user *frame;
 	int err = 0;
@@ -655,8 +626,6 @@
 	if (!access_ok(VERIFY_WRITE, frame, sizeof (*frame)))
 		goto give_sigsegv;
 
-	err |= install_sigtramp(frame->rs_code, __NR_O32_rt_sigreturn);
-
 	/* Convert (siginfo_t -> compat_siginfo_t) and copy to user. */
 	err |= copy_siginfo_to_user32(&frame->rs_info, info);
 
@@ -690,7 +659,7 @@
 	regs->regs[ 5] = (unsigned long) &frame->rs_info;
 	regs->regs[ 6] = (unsigned long) &frame->rs_uc;
 	regs->regs[29] = (unsigned long) frame;
-	regs->regs[31] = (unsigned long) frame->rs_code;
+	regs->regs[31] = (unsigned long) sig_return;
 	regs->cp0_epc = regs->regs[25] = (unsigned long) ka->sa.sa_handler;
 
 	DEBUGP("SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%lx\n",
@@ -709,7 +678,11 @@
  */
 struct mips_abi mips_abi_32 = {
 	.setup_frame	= setup_frame_32,
+	.signal_return_offset =
+		offsetof(struct mips_vdso, o32_signal_trampoline),
 	.setup_rt_frame	= setup_rt_frame_32,
+	.rt_signal_return_offset =
+		offsetof(struct mips_vdso, o32_rt_signal_trampoline),
 	.restart	= __NR_O32_restart_syscall
 };
 
diff -urN linux-2.6.34-rc3/arch/mips/kernel/signal_n32.c linux-2.6.34-rc4/arch/mips/kernel/signal_n32.c
--- linux-2.6.34-rc3/arch/mips/kernel/signal_n32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/signal_n32.c	2010-04-13 02:19:00.502571096 +0000
@@ -39,13 +39,13 @@
 #include <asm/fpu.h>
 #include <asm/cpu-features.h>
 #include <asm/war.h>
+#include <asm/vdso.h>
 
 #include "signal-common.h"
 
 /*
  * Including <asm/unistd.h> would give use the 64-bit syscall numbers ...
  */
-#define __NR_N32_rt_sigreturn		6211
 #define __NR_N32_restart_syscall	6214
 
 extern int setup_sigcontext(struct pt_regs *, struct sigcontext __user *);
@@ -67,27 +67,13 @@
 	compat_sigset_t     uc_sigmask;   /* mask last for extensibility */
 };
 
-#if ICACHE_REFILLS_WORKAROUND_WAR == 0
-
-struct rt_sigframe_n32 {
-	u32 rs_ass[4];			/* argument save space for o32 */
-	u32 rs_code[2];			/* signal trampoline */
-	struct compat_siginfo rs_info;
-	struct ucontextn32 rs_uc;
-};
-
-#else  /* ICACHE_REFILLS_WORKAROUND_WAR */
-
 struct rt_sigframe_n32 {
 	u32 rs_ass[4];			/* argument save space for o32 */
-	u32 rs_pad[2];
+	u32 rs_pad[2];			/* Was: signal trampoline */
 	struct compat_siginfo rs_info;
 	struct ucontextn32 rs_uc;
-	u32 rs_code[8] ____cacheline_aligned;		/* signal trampoline */
 };
 
-#endif	/* !ICACHE_REFILLS_WORKAROUND_WAR */
-
 extern void sigset_from_compat(sigset_t *set, compat_sigset_t *compat);
 
 asmlinkage int sysn32_rt_sigsuspend(nabi_no_regargs struct pt_regs regs)
@@ -173,7 +159,7 @@
 	force_sig(SIGSEGV, current);
 }
 
-static int setup_rt_frame_n32(struct k_sigaction * ka,
+static int setup_rt_frame_n32(void *sig_return, struct k_sigaction *ka,
 	struct pt_regs *regs, int signr, sigset_t *set, siginfo_t *info)
 {
 	struct rt_sigframe_n32 __user *frame;
@@ -184,8 +170,6 @@
 	if (!access_ok(VERIFY_WRITE, frame, sizeof (*frame)))
 		goto give_sigsegv;
 
-	install_sigtramp(frame->rs_code, __NR_N32_rt_sigreturn);
-
 	/* Create siginfo.  */
 	err |= copy_siginfo_to_user32(&frame->rs_info, info);
 
@@ -219,7 +203,7 @@
 	regs->regs[ 5] = (unsigned long) &frame->rs_info;
 	regs->regs[ 6] = (unsigned long) &frame->rs_uc;
 	regs->regs[29] = (unsigned long) frame;
-	regs->regs[31] = (unsigned long) frame->rs_code;
+	regs->regs[31] = (unsigned long) sig_return;
 	regs->cp0_epc = regs->regs[25] = (unsigned long) ka->sa.sa_handler;
 
 	DEBUGP("SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%lx\n",
@@ -235,5 +219,7 @@
 
 struct mips_abi mips_abi_n32 = {
 	.setup_rt_frame	= setup_rt_frame_n32,
+	.rt_signal_return_offset =
+		offsetof(struct mips_vdso, n32_rt_signal_trampoline),
 	.restart	= __NR_N32_restart_syscall
 };
diff -urN linux-2.6.34-rc3/arch/mips/kernel/smtc.c linux-2.6.34-rc4/arch/mips/kernel/smtc.c
--- linux-2.6.34-rc3/arch/mips/kernel/smtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/smtc.c	2010-04-13 02:19:00.502571096 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel_stat.h>
 #include <linux/module.h>
 #include <linux/ftrace.h>
+#include <linux/slab.h>
 
 #include <asm/cpu.h>
 #include <asm/processor.h>
@@ -181,7 +182,7 @@
 	{0, 0, 0, 0, 0, 0, 0, 1}
 };
 int tcnoprog[NR_CPUS];
-static atomic_t idle_hook_initialized = {0};
+static atomic_t idle_hook_initialized = ATOMIC_INIT(0);
 static int clock_hang_reported[NR_CPUS];
 
 #endif /* CONFIG_SMTC_IDLE_HOOK_DEBUG */
diff -urN linux-2.6.34-rc3/arch/mips/kernel/syscall.c linux-2.6.34-rc4/arch/mips/kernel/syscall.c
--- linux-2.6.34-rc3/arch/mips/kernel/syscall.c	2010-04-13 02:18:55.433633046 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/syscall.c	2010-04-13 02:19:00.502571096 +0000
@@ -19,7 +19,6 @@
 #include <linux/string.h>
 #include <linux/syscalls.h>
 #include <linux/file.h>
-#include <linux/slab.h>
 #include <linux/utsname.h>
 #include <linux/unistd.h>
 #include <linux/sem.h>
@@ -29,6 +28,7 @@
 #include <linux/module.h>
 #include <linux/ipc.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 #include <asm/asm.h>
 #include <asm/branch.h>
@@ -79,7 +79,11 @@
 	int do_color_align;
 	unsigned long task_size;
 
-	task_size = STACK_TOP;
+#ifdef CONFIG_32BIT
+	task_size = TASK_SIZE;
+#else /* Must be CONFIG_64BIT*/
+	task_size = test_thread_flag(TIF_32BIT_ADDR) ? TASK_SIZE32 : TASK_SIZE;
+#endif
 
 	if (len > task_size)
 		return -ENOMEM;
diff -urN linux-2.6.34-rc3/arch/mips/kernel/traps.c linux-2.6.34-rc4/arch/mips/kernel/traps.c
--- linux-2.6.34-rc3/arch/mips/kernel/traps.c	2010-04-13 02:18:55.434633094 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/traps.c	2010-04-13 02:19:00.502571096 +0000
@@ -1599,7 +1599,7 @@
 		ebase = (unsigned long)
 			__alloc_bootmem(size, 1 << fls(size), 0);
 	} else {
-		ebase = CAC_BASE;
+		ebase = CKSEG0;
 		if (cpu_has_mips_r2)
 			ebase += (read_c0_ebase() & 0x3ffff000);
 	}
diff -urN linux-2.6.34-rc3/arch/mips/kernel/vdso.c linux-2.6.34-rc4/arch/mips/kernel/vdso.c
--- linux-2.6.34-rc3/arch/mips/kernel/vdso.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/kernel/vdso.c	2010-04-13 02:19:00.502571096 +0000
@@ -0,0 +1,112 @@
+/*
+ * This file is subject to the terms and conditions of the GNU General Public
+ * License.  See the file "COPYING" in the main directory of this archive
+ * for more details.
+ *
+ * Copyright (C) 2009, 2010 Cavium Networks, Inc.
+ */
+
+
+#include <linux/kernel.h>
+#include <linux/err.h>
+#include <linux/sched.h>
+#include <linux/mm.h>
+#include <linux/init.h>
+#include <linux/binfmts.h>
+#include <linux/elf.h>
+#include <linux/vmalloc.h>
+#include <linux/unistd.h>
+
+#include <asm/vdso.h>
+#include <asm/uasm.h>
+
+/*
+ * Including <asm/unistd.h> would give use the 64-bit syscall numbers ...
+ */
+#define __NR_O32_sigreturn		4119
+#define __NR_O32_rt_sigreturn		4193
+#define __NR_N32_rt_sigreturn		6211
+
+static struct page *vdso_page;
+
+static void __init install_trampoline(u32 *tramp, unsigned int sigreturn)
+{
+	uasm_i_addiu(&tramp, 2, 0, sigreturn);	/* li v0, sigreturn */
+	uasm_i_syscall(&tramp, 0);
+}
+
+static int __init init_vdso(void)
+{
+	struct mips_vdso *vdso;
+
+	vdso_page = alloc_page(GFP_KERNEL);
+	if (!vdso_page)
+		panic("Cannot allocate vdso");
+
+	vdso = vmap(&vdso_page, 1, 0, PAGE_KERNEL);
+	if (!vdso)
+		panic("Cannot map vdso");
+	clear_page(vdso);
+
+	install_trampoline(vdso->rt_signal_trampoline, __NR_rt_sigreturn);
+#ifdef CONFIG_32BIT
+	install_trampoline(vdso->signal_trampoline, __NR_sigreturn);
+#else
+	install_trampoline(vdso->n32_rt_signal_trampoline,
+			   __NR_N32_rt_sigreturn);
+	install_trampoline(vdso->o32_signal_trampoline, __NR_O32_sigreturn);
+	install_trampoline(vdso->o32_rt_signal_trampoline,
+			   __NR_O32_rt_sigreturn);
+#endif
+
+	vunmap(vdso);
+
+	pr_notice("init_vdso successfull\n");
+
+	return 0;
+}
+device_initcall(init_vdso);
+
+static unsigned long vdso_addr(unsigned long start)
+{
+	return STACK_TOP;
+}
+
+int arch_setup_additional_pages(struct linux_binprm *bprm, int uses_interp)
+{
+	int ret;
+	unsigned long addr;
+	struct mm_struct *mm = current->mm;
+
+	down_write(&mm->mmap_sem);
+
+	addr = vdso_addr(mm->start_stack);
+
+	addr = get_unmapped_area(NULL, addr, PAGE_SIZE, 0, 0);
+	if (IS_ERR_VALUE(addr)) {
+		ret = addr;
+		goto up_fail;
+	}
+
+	ret = install_special_mapping(mm, addr, PAGE_SIZE,
+				      VM_READ|VM_EXEC|
+				      VM_MAYREAD|VM_MAYWRITE|VM_MAYEXEC|
+				      VM_ALWAYSDUMP,
+				      &vdso_page);
+
+	if (ret)
+		goto up_fail;
+
+	mm->context.vdso = (void *)addr;
+
+up_fail:
+	up_write(&mm->mmap_sem);
+	return ret;
+}
+
+const char *arch_vma_name(struct vm_area_struct *vma)
+{
+	if (vma->vm_mm && vma->vm_start == (long)vma->vm_mm->context.vdso)
+		return "[vdso]";
+	return NULL;
+}
diff -urN linux-2.6.34-rc3/arch/mips/lib/delay.c linux-2.6.34-rc4/arch/mips/lib/delay.c
--- linux-2.6.34-rc3/arch/mips/lib/delay.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/lib/delay.c	2010-04-13 02:19:00.503570349 +0000
@@ -41,7 +41,7 @@
 
 void __udelay(unsigned long us)
 {
-	unsigned int lpj = current_cpu_data.udelay_val;
+	unsigned int lpj = raw_current_cpu_data.udelay_val;
 
 	__delay((us * 0x000010c7ull * HZ * lpj) >> 32);
 }
@@ -49,7 +49,7 @@
 
 void __ndelay(unsigned long ns)
 {
-	unsigned int lpj = current_cpu_data.udelay_val;
+	unsigned int lpj = raw_current_cpu_data.udelay_val;
 
 	__delay((ns * 0x00000005ull * HZ * lpj) >> 32);
 }
diff -urN linux-2.6.34-rc3/arch/mips/lib/libgcc.h linux-2.6.34-rc4/arch/mips/lib/libgcc.h
--- linux-2.6.34-rc3/arch/mips/lib/libgcc.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/lib/libgcc.h	2010-04-13 02:19:00.503570349 +0000
@@ -17,8 +17,7 @@
 #error I feel sick.
 #endif
 
-typedef union
-{
+typedef union {
 	struct DWstruct s;
 	long long ll;
 } DWunion;
diff -urN linux-2.6.34-rc3/arch/mips/mipssim/sim_int.c linux-2.6.34-rc4/arch/mips/mipssim/sim_int.c
--- linux-2.6.34-rc3/arch/mips/mipssim/sim_int.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/mipssim/sim_int.c	2010-04-13 02:19:00.505633066 +0000
@@ -17,7 +17,6 @@
  */
 #include <linux/init.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/kernel_stat.h>
 #include <asm/mips-boards/simint.h>
diff -urN linux-2.6.34-rc3/arch/mips/mm/cache.c linux-2.6.34-rc4/arch/mips/mm/cache.c
--- linux-2.6.34-rc3/arch/mips/mm/cache.c	2010-04-13 02:18:55.436633058 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/cache.c	2010-04-13 02:19:00.505633066 +0000
@@ -133,7 +133,7 @@
 }
 
 unsigned long _page_cachable_default;
-EXPORT_SYMBOL_GPL(_page_cachable_default);
+EXPORT_SYMBOL(_page_cachable_default);
 
 static inline void setup_protection_map(void)
 {
diff -urN linux-2.6.34-rc3/arch/mips/mm/dma-default.c linux-2.6.34-rc4/arch/mips/mm/dma-default.c
--- linux-2.6.34-rc3/arch/mips/mm/dma-default.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/dma-default.c	2010-04-13 02:19:00.506633029 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/scatterlist.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 
 #include <asm/cache.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/mips/mm/hugetlbpage.c linux-2.6.34-rc4/arch/mips/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/mips/mm/hugetlbpage.c	2010-04-13 02:18:55.437633048 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/hugetlbpage.c	2010-04-13 02:19:00.506633029 +0000
@@ -16,7 +16,6 @@
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
-#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/sysctl.h>
 #include <asm/mman.h>
diff -urN linux-2.6.34-rc3/arch/mips/mm/init.c linux-2.6.34-rc4/arch/mips/mm/init.c
--- linux-2.6.34-rc3/arch/mips/mm/init.c	2010-04-13 02:18:55.437633048 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/init.c	2010-04-13 02:19:00.506633029 +0000
@@ -28,6 +28,7 @@
 #include <linux/proc_fs.h>
 #include <linux/pfn.h>
 #include <linux/hardirq.h>
+#include <linux/gfp.h>
 
 #include <asm/asm-offsets.h>
 #include <asm/bootinfo.h>
diff -urN linux-2.6.34-rc3/arch/mips/mm/ioremap.c linux-2.6.34-rc4/arch/mips/mm/ioremap.c
--- linux-2.6.34-rc3/arch/mips/mm/ioremap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/ioremap.c	2010-04-13 02:19:00.506633029 +0000
@@ -10,6 +10,7 @@
 #include <asm/addrspace.h>
 #include <asm/byteorder.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <asm/cacheflush.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/mips/mm/tlbex.c linux-2.6.34-rc4/arch/mips/mm/tlbex.c
--- linux-2.6.34-rc3/arch/mips/mm/tlbex.c	2010-04-13 02:18:55.438633066 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/tlbex.c	2010-04-13 02:19:00.507633080 +0000
@@ -788,10 +788,15 @@
 	 * create the plain linear handler
 	 */
 	if (bcm1250_m3_war()) {
-		UASM_i_MFC0(&p, K0, C0_BADVADDR);
-		UASM_i_MFC0(&p, K1, C0_ENTRYHI);
+		unsigned int segbits = 44;
+
+		uasm_i_dmfc0(&p, K0, C0_BADVADDR);
+		uasm_i_dmfc0(&p, K1, C0_ENTRYHI);
 		uasm_i_xor(&p, K0, K0, K1);
-		UASM_i_SRL(&p, K0, K0, PAGE_SHIFT + 1);
+		uasm_i_dsrl32(&p, K1, K0, 62 - 32);
+		uasm_i_dsrl(&p, K0, K0, 12 + 1);
+		uasm_i_dsll32(&p, K0, K0, 64 + 12 + 1 - segbits - 32);
+		uasm_i_or(&p, K0, K0, K1);
 		uasm_il_bnez(&p, &r, K0, label_leave);
 		/* No need for uasm_i_nop */
 	}
@@ -1312,10 +1317,15 @@
 	memset(relocs, 0, sizeof(relocs));
 
 	if (bcm1250_m3_war()) {
-		UASM_i_MFC0(&p, K0, C0_BADVADDR);
-		UASM_i_MFC0(&p, K1, C0_ENTRYHI);
+		unsigned int segbits = 44;
+
+		uasm_i_dmfc0(&p, K0, C0_BADVADDR);
+		uasm_i_dmfc0(&p, K1, C0_ENTRYHI);
 		uasm_i_xor(&p, K0, K0, K1);
-		UASM_i_SRL(&p, K0, K0, PAGE_SHIFT + 1);
+		uasm_i_dsrl32(&p, K1, K0, 62 - 32);
+		uasm_i_dsrl(&p, K0, K0, 12 + 1);
+		uasm_i_dsll32(&p, K0, K0, 64 + 12 + 1 - segbits - 32);
+		uasm_i_or(&p, K0, K0, K1);
 		uasm_il_bnez(&p, &r, K0, label_leave);
 		/* No need for uasm_i_nop */
 	}
diff -urN linux-2.6.34-rc3/arch/mips/mm/uasm.c linux-2.6.34-rc4/arch/mips/mm/uasm.c
--- linux-2.6.34-rc3/arch/mips/mm/uasm.c	2010-04-13 02:18:55.438633066 +0000
+++ linux-2.6.34-rc4/arch/mips/mm/uasm.c	2010-04-13 02:19:00.507633080 +0000
@@ -31,7 +31,8 @@
 	BIMM = 0x040,
 	JIMM = 0x080,
 	FUNC = 0x100,
-	SET = 0x200
+	SET = 0x200,
+	SCIMM = 0x400
 };
 
 #define OP_MASK		0x3f
@@ -52,6 +53,8 @@
 #define FUNC_SH		0
 #define SET_MASK	0x7
 #define SET_SH		0
+#define SCIMM_MASK	0xfffff
+#define SCIMM_SH	6
 
 enum opcode {
 	insn_invalid,
@@ -61,10 +64,10 @@
 	insn_dmtc0, insn_dsll, insn_dsll32, insn_dsra, insn_dsrl,
 	insn_dsrl32, insn_drotr, insn_dsubu, insn_eret, insn_j, insn_jal,
 	insn_jr, insn_ld, insn_ll, insn_lld, insn_lui, insn_lw, insn_mfc0,
-	insn_mtc0, insn_ori, insn_pref, insn_rfe, insn_sc, insn_scd,
+	insn_mtc0, insn_or, insn_ori, insn_pref, insn_rfe, insn_sc, insn_scd,
 	insn_sd, insn_sll, insn_sra, insn_srl, insn_rotr, insn_subu, insn_sw,
 	insn_tlbp, insn_tlbr, insn_tlbwi, insn_tlbwr, insn_xor, insn_xori,
-	insn_dins
+	insn_dins, insn_syscall
 };
 
 struct insn {
@@ -117,6 +120,7 @@
 	{ insn_lw,  M(lw_op, 0, 0, 0, 0, 0),  RS | RT | SIMM },
 	{ insn_mfc0,  M(cop0_op, mfc_op, 0, 0, 0, 0),  RT | RD | SET},
 	{ insn_mtc0,  M(cop0_op, mtc_op, 0, 0, 0, 0),  RT | RD | SET},
+	{ insn_or,  M(spec_op, 0, 0, 0, 0, or_op),  RS | RT | RD },
 	{ insn_ori,  M(ori_op, 0, 0, 0, 0, 0),  RS | RT | UIMM },
 	{ insn_pref,  M(pref_op, 0, 0, 0, 0, 0),  RS | RT | SIMM },
 	{ insn_rfe,  M(cop0_op, cop_op, 0, 0, 0, rfe_op),  0 },
@@ -136,6 +140,7 @@
 	{ insn_xor,  M(spec_op, 0, 0, 0, 0, xor_op),  RS | RT | RD },
 	{ insn_xori,  M(xori_op, 0, 0, 0, 0, 0),  RS | RT | UIMM },
 	{ insn_dins, M(spec3_op, 0, 0, 0, 0, dins_op), RS | RT | RD | RE },
+	{ insn_syscall, M(spec_op, 0, 0, 0, 0, syscall_op), SCIMM},
 	{ insn_invalid, 0, 0 }
 };
 
@@ -208,6 +213,14 @@
 	return (arg >> 2) & JIMM_MASK;
 }
 
+static inline __cpuinit u32 build_scimm(u32 arg)
+{
+	if (arg & ~SCIMM_MASK)
+		printk(KERN_WARNING "Micro-assembler field overflow\n");
+
+	return (arg & SCIMM_MASK) << SCIMM_SH;
+}
+
 static inline __cpuinit u32 build_func(u32 arg)
 {
 	if (arg & ~FUNC_MASK)
@@ -266,6 +279,8 @@
 		op |= build_func(va_arg(ap, u32));
 	if (ip->fields & SET)
 		op |= build_set(va_arg(ap, u32));
+	if (ip->fields & SCIMM)
+		op |= build_scimm(va_arg(ap, u32));
 	va_end(ap);
 
 	**buf = op;
@@ -373,6 +388,7 @@
 I_u1u2u3(_mfc0)
 I_u1u2u3(_mtc0)
 I_u2u1u3(_ori)
+I_u3u1u2(_or)
 I_u2s3u1(_pref)
 I_0(_rfe)
 I_u2s3u1(_sc)
@@ -391,6 +407,7 @@
 I_u3u1u2(_xor)
 I_u2u1u3(_xori)
 I_u2u1msbu3(_dins);
+I_u1(_syscall);
 
 /* Handle labels. */
 void __cpuinit uasm_build_label(struct uasm_label **lab, u32 *addr, int lid)
diff -urN linux-2.6.34-rc3/arch/mips/mti-malta/malta-int.c linux-2.6.34-rc4/arch/mips/mti-malta/malta-int.c
--- linux-2.6.34-rc3/arch/mips/mti-malta/malta-int.c	2010-04-13 02:18:55.439571957 +0000
+++ linux-2.6.34-rc4/arch/mips/mti-malta/malta-int.c	2010-04-13 02:19:00.508633089 +0000
@@ -25,7 +25,6 @@
 #include <linux/irq.h>
 #include <linux/sched.h>
 #include <linux/smp.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
 #include <linux/kernel_stat.h>
diff -urN linux-2.6.34-rc3/arch/mips/nxp/pnx833x/common/reset.c linux-2.6.34-rc4/arch/mips/nxp/pnx833x/common/reset.c
--- linux-2.6.34-rc3/arch/mips/nxp/pnx833x/common/reset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/nxp/pnx833x/common/reset.c	2010-04-13 02:19:00.509633470 +0000
@@ -22,7 +22,6 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
-#include <linux/slab.h>
 #include <linux/reboot.h>
 #include <pnx833x.h>
 
diff -urN linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/int.c linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/int.c
--- linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/int.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/int.c	2010-04-13 02:19:00.509633470 +0000
@@ -27,7 +27,6 @@
 #include <linux/init.h>
 #include <linux/irq.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/kernel_stat.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/proc.c linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/proc.c
--- linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/proc.c	2010-04-13 02:19:00.509633470 +0000
@@ -16,7 +16,6 @@
 #include <linux/proc_fs.h>
 #include <linux/irq.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/kernel_stat.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/reset.c linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/reset.c
--- linux-2.6.34-rc3/arch/mips/nxp/pnx8550/common/reset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/nxp/pnx8550/common/reset.c	2010-04-13 02:19:00.509633470 +0000
@@ -20,7 +20,6 @@
  * Reset the PNX8550 board.
  *
  */
-#include <linux/slab.h>
 #include <asm/reboot.h>
 #include <glb.h>
 
diff -urN linux-2.6.34-rc3/arch/mips/pci/ops-loongson2.c linux-2.6.34-rc4/arch/mips/pci/ops-loongson2.c
--- linux-2.6.34-rc3/arch/mips/pci/ops-loongson2.c	2010-04-13 02:18:55.440570466 +0000
+++ linux-2.6.34-rc4/arch/mips/pci/ops-loongson2.c	2010-04-13 02:19:00.510633103 +0000
@@ -180,15 +180,21 @@
 };
 
 #ifdef CONFIG_CS5536
+DEFINE_RAW_SPINLOCK(msr_lock);
+
 void _rdmsr(u32 msr, u32 *hi, u32 *lo)
 {
 	struct pci_bus bus = {
 		.number = PCI_BUS_CS5536
 	};
 	u32 devfn = PCI_DEVFN(PCI_IDSEL_CS5536, 0);
+	unsigned long flags;
+
+	raw_spin_lock_irqsave(&msr_lock, flags);
 	loongson_pcibios_write(&bus, devfn, PCI_MSR_ADDR, 4, msr);
 	loongson_pcibios_read(&bus, devfn, PCI_MSR_DATA_LO, 4, lo);
 	loongson_pcibios_read(&bus, devfn, PCI_MSR_DATA_HI, 4, hi);
+	raw_spin_unlock_irqrestore(&msr_lock, flags);
 }
 EXPORT_SYMBOL(_rdmsr);
 
@@ -198,9 +204,13 @@
 		.number = PCI_BUS_CS5536
 	};
 	u32 devfn = PCI_DEVFN(PCI_IDSEL_CS5536, 0);
+	unsigned long flags;
+
+	raw_spin_lock_irqsave(&msr_lock, flags);
 	loongson_pcibios_write(&bus, devfn, PCI_MSR_ADDR, 4, msr);
 	loongson_pcibios_write(&bus, devfn, PCI_MSR_DATA_LO, 4, lo);
 	loongson_pcibios_write(&bus, devfn, PCI_MSR_DATA_HI, 4, hi);
+	raw_spin_unlock_irqrestore(&msr_lock, flags);
 }
 EXPORT_SYMBOL(_wrmsr);
 #endif
diff -urN linux-2.6.34-rc3/arch/mips/pci/ops-titan-ht.c linux-2.6.34-rc4/arch/mips/pci/ops-titan-ht.c
--- linux-2.6.34-rc3/arch/mips/pci/ops-titan-ht.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/pci/ops-titan-ht.c	2010-04-13 02:19:00.510633103 +0000
@@ -26,7 +26,6 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/arch/mips/pmc-sierra/msp71xx/msp_prom.c linux-2.6.34-rc4/arch/mips/pmc-sierra/msp71xx/msp_prom.c
--- linux-2.6.34-rc3/arch/mips/pmc-sierra/msp71xx/msp_prom.c	2010-04-13 02:18:55.441633065 +0000
+++ linux-2.6.34-rc4/arch/mips/pmc-sierra/msp71xx/msp_prom.c	2010-04-13 02:19:00.510633103 +0000
@@ -40,6 +40,7 @@
 #include <linux/string.h>
 #include <linux/interrupt.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 
 #include <asm/addrspace.h>
 #include <asm/bootinfo.h>
diff -urN linux-2.6.34-rc3/arch/mips/pmc-sierra/yosemite/ht.c linux-2.6.34-rc4/arch/mips/pmc-sierra/yosemite/ht.c
--- linux-2.6.34-rc3/arch/mips/pmc-sierra/yosemite/ht.c	2010-04-13 02:18:55.441633065 +0000
+++ linux-2.6.34-rc4/arch/mips/pmc-sierra/yosemite/ht.c	2010-04-13 02:19:00.511633073 +0000
@@ -26,7 +26,6 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <asm/pci.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/arch/mips/pmc-sierra/yosemite/irq.c linux-2.6.34-rc4/arch/mips/pmc-sierra/yosemite/irq.c
--- linux-2.6.34-rc3/arch/mips/pmc-sierra/yosemite/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/pmc-sierra/yosemite/irq.c	2010-04-13 02:19:00.511633073 +0000
@@ -37,7 +37,6 @@
 #include <linux/ioport.h>
 #include <linux/irq.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/bitops.h>
 #include <asm/bootinfo.h>
diff -urN linux-2.6.34-rc3/arch/mips/powertv/asic/asic_devices.c linux-2.6.34-rc4/arch/mips/powertv/asic/asic_devices.c
--- linux-2.6.34-rc3/arch/mips/powertv/asic/asic_devices.c	2010-04-13 02:18:55.441633065 +0000
+++ linux-2.6.34-rc4/arch/mips/powertv/asic/asic_devices.c	2010-04-13 02:19:00.511633073 +0000
@@ -39,6 +39,7 @@
 #include <linux/mm.h>
 #include <linux/platform_device.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <asm/page.h>
 #include <linux/swap.h>
 #include <linux/highmem.h>
diff -urN linux-2.6.34-rc3/arch/mips/powertv/asic/asic_int.c linux-2.6.34-rc4/arch/mips/powertv/asic/asic_int.c
--- linux-2.6.34-rc3/arch/mips/powertv/asic/asic_int.c	2010-04-13 02:18:55.441633065 +0000
+++ linux-2.6.34-rc4/arch/mips/powertv/asic/asic_int.c	2010-04-13 02:19:00.511633073 +0000
@@ -26,7 +26,6 @@
 #include <linux/init.h>
 #include <linux/irq.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/kernel_stat.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/arch/mips/rb532/irq.c linux-2.6.34-rc4/arch/mips/rb532/irq.c
--- linux-2.6.34-rc3/arch/mips/rb532/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/rb532/irq.c	2010-04-13 02:19:00.511633073 +0000
@@ -36,7 +36,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/arch/mips/sgi-ip27/ip27-irq.c linux-2.6.34-rc4/arch/mips/sgi-ip27/ip27-irq.c
--- linux-2.6.34-rc3/arch/mips/sgi-ip27/ip27-irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/sgi-ip27/ip27-irq.c	2010-04-13 02:19:00.512633064 +0000
@@ -17,7 +17,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/random.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/arch/mips/sgi-ip32/ip32-irq.c linux-2.6.34-rc4/arch/mips/sgi-ip32/ip32-irq.c
--- linux-2.6.34-rc3/arch/mips/sgi-ip32/ip32-irq.c	2010-04-13 02:18:55.442633020 +0000
+++ linux-2.6.34-rc4/arch/mips/sgi-ip32/ip32-irq.c	2010-04-13 02:19:00.512633064 +0000
@@ -15,7 +15,6 @@
 #include <linux/irq.h>
 #include <linux/bitops.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/random.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/arch/mips/sibyte/bcm1480/irq.c linux-2.6.34-rc4/arch/mips/sibyte/bcm1480/irq.c
--- linux-2.6.34-rc3/arch/mips/sibyte/bcm1480/irq.c	2010-04-13 02:18:55.442633020 +0000
+++ linux-2.6.34-rc4/arch/mips/sibyte/bcm1480/irq.c	2010-04-13 02:19:00.512633064 +0000
@@ -22,7 +22,6 @@
 #include <linux/smp.h>
 #include <linux/spinlock.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/kernel_stat.h>
 
 #include <asm/errno.h>
diff -urN linux-2.6.34-rc3/arch/mips/sibyte/common/sb_tbprof.c linux-2.6.34-rc4/arch/mips/sibyte/common/sb_tbprof.c
--- linux-2.6.34-rc3/arch/mips/sibyte/common/sb_tbprof.c	2010-04-13 02:18:55.442633020 +0000
+++ linux-2.6.34-rc4/arch/mips/sibyte/common/sb_tbprof.c	2010-04-13 02:19:00.512633064 +0000
@@ -27,7 +27,6 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/fs.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/arch/mips/sibyte/sb1250/irq.c linux-2.6.34-rc4/arch/mips/sibyte/sb1250/irq.c
--- linux-2.6.34-rc3/arch/mips/sibyte/sb1250/irq.c	2010-04-13 02:18:55.442633020 +0000
+++ linux-2.6.34-rc4/arch/mips/sibyte/sb1250/irq.c	2010-04-13 02:19:00.512633064 +0000
@@ -22,7 +22,6 @@
 #include <linux/spinlock.h>
 #include <linux/smp.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/kernel_stat.h>
 
 #include <asm/errno.h>
diff -urN linux-2.6.34-rc3/arch/mips/sibyte/sb1250/setup.c linux-2.6.34-rc4/arch/mips/sibyte/sb1250/setup.c
--- linux-2.6.34-rc3/arch/mips/sibyte/sb1250/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/sibyte/sb1250/setup.c	2010-04-13 02:19:00.512633064 +0000
@@ -87,6 +87,21 @@
 	return ret;
 }
 
+int sb1250_m3_workaround_needed(void)
+{
+	switch (soc_type) {
+	case K_SYS_SOC_TYPE_BCM1250:
+	case K_SYS_SOC_TYPE_BCM1250_ALT:
+	case K_SYS_SOC_TYPE_BCM1250_ALT2:
+	case K_SYS_SOC_TYPE_BCM1125:
+	case K_SYS_SOC_TYPE_BCM1125H:
+		return soc_pass < K_SYS_REVISION_BCM1250_C0;
+
+	default:
+		return 0;
+	}
+}
+
 static int __init setup_bcm112x(void)
 {
 	int ret = 0;
diff -urN linux-2.6.34-rc3/arch/mips/txx9/generic/pci.c linux-2.6.34-rc4/arch/mips/txx9/generic/pci.c
--- linux-2.6.34-rc3/arch/mips/txx9/generic/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/txx9/generic/pci.c	2010-04-13 02:19:00.513633099 +0000
@@ -20,6 +20,7 @@
 #include <asm/txx9/pci.h>
 #ifdef CONFIG_TOSHIBA_FPCIB0
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/i8259.h>
 #include <asm/txx9/smsc_fdc37m81x.h>
 #endif
diff -urN linux-2.6.34-rc3/arch/mips/txx9/generic/setup.c linux-2.6.34-rc4/arch/mips/txx9/generic/setup.c
--- linux-2.6.34-rc3/arch/mips/txx9/generic/setup.c	2010-04-13 02:18:55.443633047 +0000
+++ linux-2.6.34-rc4/arch/mips/txx9/generic/setup.c	2010-04-13 02:19:00.513633099 +0000
@@ -23,6 +23,7 @@
 #include <linux/mtd/physmap.h>
 #include <linux/leds.h>
 #include <linux/sysdev.h>
+#include <linux/slab.h>
 #include <asm/bootinfo.h>
 #include <asm/time.h>
 #include <asm/reboot.h>
diff -urN linux-2.6.34-rc3/arch/mips/txx9/generic/spi_eeprom.c linux-2.6.34-rc4/arch/mips/txx9/generic/spi_eeprom.c
--- linux-2.6.34-rc3/arch/mips/txx9/generic/spi_eeprom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/txx9/generic/spi_eeprom.c	2010-04-13 02:19:00.513633099 +0000
@@ -10,6 +10,7 @@
  * Support for TX4938 in 2.6 - Manish Lachwani (mlachwani@mvista.com)
  */
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/eeprom.h>
diff -urN linux-2.6.34-rc3/arch/mips/txx9/rbtx4939/setup.c linux-2.6.34-rc4/arch/mips/txx9/rbtx4939/setup.c
--- linux-2.6.34-rc3/arch/mips/txx9/rbtx4939/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mips/txx9/rbtx4939/setup.c	2010-04-13 02:19:00.514633054 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/leds.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/mn10300/kernel/process.c linux-2.6.34-rc4/arch/mn10300/kernel/process.c
--- linux-2.6.34-rc3/arch/mn10300/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/kernel/process.c	2010-04-13 02:19:00.514633054 +0000
@@ -18,7 +18,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
@@ -26,6 +25,7 @@
 #include <linux/percpu.h>
 #include <linux/err.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/pgtable.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/mn10300/kernel/setup.c linux-2.6.34-rc4/arch/mn10300/kernel/setup.c
--- linux-2.6.34-rc3/arch/mn10300/kernel/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/kernel/setup.c	2010-04-13 02:19:00.514633054 +0000
@@ -15,7 +15,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/arch/mn10300/mm/dma-alloc.c linux-2.6.34-rc4/arch/mn10300/mm/dma-alloc.c
--- linux-2.6.34-rc3/arch/mn10300/mm/dma-alloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/mm/dma-alloc.c	2010-04-13 02:19:00.514633054 +0000
@@ -14,6 +14,7 @@
 #include <linux/mm.h>
 #include <linux/string.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 
 static unsigned long pci_sram_allocated = 0xbc000000;
diff -urN linux-2.6.34-rc3/arch/mn10300/mm/init.c linux-2.6.34-rc4/arch/mn10300/mm/init.c
--- linux-2.6.34-rc3/arch/mn10300/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/mm/init.c	2010-04-13 02:19:00.515633075 +0000
@@ -17,7 +17,6 @@
 #include <linux/types.h>
 #include <linux/ptrace.h>
 #include <linux/mman.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
@@ -27,6 +26,7 @@
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 
 #include <asm/processor.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/mn10300/mm/pgtable.c linux-2.6.34-rc4/arch/mn10300/mm/pgtable.c
--- linux-2.6.34-rc3/arch/mn10300/mm/pgtable.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/mm/pgtable.c	2010-04-13 02:19:00.515633075 +0000
@@ -12,11 +12,11 @@
 #include <linux/sched.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/smp.h>
 #include <linux/highmem.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/spinlock.h>
 #include <linux/quicklist.h>
diff -urN linux-2.6.34-rc3/arch/mn10300/unit-asb2305/pci-irq.c linux-2.6.34-rc4/arch/mn10300/unit-asb2305/pci-irq.c
--- linux-2.6.34-rc3/arch/mn10300/unit-asb2305/pci-irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/mn10300/unit-asb2305/pci-irq.c	2010-04-13 02:19:00.515633075 +0000
@@ -14,7 +14,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/parisc/hpux/fs.c linux-2.6.34-rc4/arch/parisc/hpux/fs.c
--- linux-2.6.34-rc3/arch/parisc/hpux/fs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/hpux/fs.c	2010-04-13 02:19:00.515633075 +0000
@@ -26,8 +26,8 @@
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/file.h>
-#include <linux/slab.h>
 #include <linux/ptrace.h>
+#include <linux/slab.h>
 #include <asm/errno.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/module.c linux-2.6.34-rc4/arch/parisc/kernel/module.c
--- linux-2.6.34-rc3/arch/parisc/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/module.c	2010-04-13 02:19:00.516633105 +0000
@@ -61,6 +61,7 @@
 #include <linux/string.h>
 #include <linux/kernel.h>
 #include <linux/bug.h>
+#include <linux/slab.h>
 
 #include <asm/unwind.h>
 
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/pci-dma.c linux-2.6.34-rc4/arch/parisc/kernel/pci-dma.c
--- linux-2.6.34-rc3/arch/parisc/kernel/pci-dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/pci-dma.c	2010-04-13 02:19:00.517633077 +0000
@@ -18,11 +18,11 @@
 */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/pci.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/types.h>
 #include <linux/scatterlist.h>
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/pci.c linux-2.6.34-rc4/arch/parisc/kernel/pci.c
--- linux-2.6.34-rc3/arch/parisc/kernel/pci.c	2010-04-13 02:18:55.445633073 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/pci.c	2010-04-13 02:19:00.517633077 +0000
@@ -13,7 +13,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/process.c linux-2.6.34-rc4/arch/parisc/kernel/process.c
--- linux-2.6.34-rc3/arch/parisc/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/process.c	2010-04-13 02:19:00.517633077 +0000
@@ -43,6 +43,7 @@
 #include <linux/personality.h>
 #include <linux/ptrace.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/kallsyms.h>
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/signal32.c linux-2.6.34-rc4/arch/parisc/kernel/signal32.c
--- linux-2.6.34-rc3/arch/parisc/kernel/signal32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/signal32.c	2010-04-13 02:19:00.517633077 +0000
@@ -23,7 +23,6 @@
  */
 
 #include <linux/compat.h>
-#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/unistd.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/parisc/kernel/smp.c linux-2.6.34-rc4/arch/parisc/kernel/smp.c
--- linux-2.6.34-rc3/arch/parisc/kernel/smp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/kernel/smp.c	2010-04-13 02:19:00.517633077 +0000
@@ -18,7 +18,6 @@
 */
 #include <linux/types.h>
 #include <linux/spinlock.h>
-#include <linux/slab.h>
 
 #include <linux/kernel.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/parisc/mm/init.c linux-2.6.34-rc4/arch/parisc/mm/init.c
--- linux-2.6.34-rc3/arch/parisc/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/parisc/mm/init.c	2010-04-13 02:19:00.518633062 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/mm.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/pci.h>		/* for hppa_dma_ops and pcxl_dma_ops */
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/cacheinfo.c linux-2.6.34-rc4/arch/powerpc/kernel/cacheinfo.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/cacheinfo.c	2010-04-13 02:18:55.457633070 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/cacheinfo.c	2010-04-13 02:19:00.529633065 +0000
@@ -19,6 +19,7 @@
 #include <linux/notifier.h>
 #include <linux/of.h>
 #include <linux/percpu.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 
 #include "cacheinfo.h"
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/dma.c linux-2.6.34-rc4/arch/powerpc/kernel/dma.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/dma.c	2010-04-13 02:19:00.530633050 +0000
@@ -8,6 +8,7 @@
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
 #include <linux/dma-debug.h>
+#include <linux/gfp.h>
 #include <linux/lmb.h>
 #include <asm/bug.h>
 #include <asm/abs_addr.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/ibmebus.c linux-2.6.34-rc4/arch/powerpc/kernel/ibmebus.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/ibmebus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/ibmebus.c	2010-04-13 02:19:00.531633017 +0000
@@ -42,6 +42,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/interrupt.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 #include <linux/of_platform.h>
 #include <asm/ibmebus.h>
 #include <asm/abs_addr.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/kprobes.c linux-2.6.34-rc4/arch/powerpc/kernel/kprobes.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/kprobes.c	2010-04-13 02:18:55.459571607 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/kprobes.c	2010-04-13 02:19:00.531633017 +0000
@@ -31,6 +31,7 @@
 #include <linux/preempt.h>
 #include <linux/module.h>
 #include <linux/kdebug.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 #include <asm/sstep.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/lparcfg.c linux-2.6.34-rc4/arch/powerpc/kernel/lparcfg.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/lparcfg.c	2010-04-13 02:18:55.460570451 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/lparcfg.c	2010-04-13 02:19:00.532633095 +0000
@@ -24,6 +24,7 @@
 #include <linux/proc_fs.h>
 #include <linux/init.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/iseries/hv_lp_config.h>
 #include <asm/lppaca.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/misc.S linux-2.6.34-rc4/arch/powerpc/kernel/misc.S
--- linux-2.6.34-rc3/arch/powerpc/kernel/misc.S	2010-04-13 02:18:55.460570451 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/misc.S	2010-04-13 02:19:00.532633095 +0000
@@ -128,7 +128,6 @@
 	/* place holder */
 	blr
 
-#ifdef CONFIG_EVENT_TRACING
 /*
  * Get a minimal set of registers for our caller's nth caller.
  * r3 = regs pointer, r5 = n.
@@ -154,4 +153,3 @@
 	PPC_STL	r4,_NIP-STACK_FRAME_OVERHEAD(r3)
 	PPC_STL	r7,_LINK-STACK_FRAME_OVERHEAD(r3)
 	blr
-#endif /* CONFIG_EVENT_TRACING */
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/of_platform.c linux-2.6.34-rc4/arch/powerpc/kernel/of_platform.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/of_platform.c	2010-04-13 02:18:55.460570451 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/of_platform.c	2010-04-13 02:19:00.532633095 +0000
@@ -17,7 +17,6 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/mod_devicetable.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/pci-common.c linux-2.6.34-rc4/arch/powerpc/kernel/pci-common.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/pci-common.c	2010-04-13 02:18:55.460570451 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/pci-common.c	2010-04-13 02:19:00.532633095 +0000
@@ -26,6 +26,7 @@
 #include <linux/syscalls.h>
 #include <linux/irq.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/pci_32.c linux-2.6.34-rc4/arch/powerpc/kernel/pci_32.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/pci_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/pci_32.c	2010-04-13 02:19:00.533570872 +0000
@@ -14,6 +14,7 @@
 #include <linux/irq.h>
 #include <linux/list.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/pci_dn.c linux-2.6.34-rc4/arch/powerpc/kernel/pci_dn.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/pci_dn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/pci_dn.c	2010-04-13 02:19:00.533570872 +0000
@@ -23,6 +23,7 @@
 #include <linux/pci.h>
 #include <linux/string.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/proc_powerpc.c linux-2.6.34-rc4/arch/powerpc/kernel/proc_powerpc.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/proc_powerpc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/proc_powerpc.c	2010-04-13 02:19:00.534570419 +0000
@@ -19,7 +19,6 @@
 #include <linux/init.h>
 #include <linux/mm.h>
 #include <linux/proc_fs.h>
-#include <linux/slab.h>
 #include <linux/kernel.h>
 
 #include <asm/machdep.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/rtas.c linux-2.6.34-rc4/arch/powerpc/kernel/rtas.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/rtas.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/rtas.c	2010-04-13 02:19:00.536633112 +0000
@@ -23,6 +23,7 @@
 #include <linux/completion.h>
 #include <linux/cpumask.h>
 #include <linux/lmb.h>
+#include <linux/slab.h>
 
 #include <asm/prom.h>
 #include <asm/rtas.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/rtas_flash.c linux-2.6.34-rc4/arch/powerpc/kernel/rtas_flash.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/rtas_flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/rtas_flash.c	2010-04-13 02:19:00.536633112 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <asm/delay.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/rtasd.c linux-2.6.34-rc4/arch/powerpc/kernel/rtasd.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/rtasd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/rtasd.c	2010-04-13 02:19:00.536633112 +0000
@@ -20,6 +20,7 @@
 #include <linux/spinlock.h>
 #include <linux/cpu.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/smp-tbsync.c linux-2.6.34-rc4/arch/powerpc/kernel/smp-tbsync.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/smp-tbsync.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/smp-tbsync.c	2010-04-13 02:19:00.537633111 +0000
@@ -10,6 +10,7 @@
 #include <linux/smp.h>
 #include <linux/unistd.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/smp.h>
 #include <asm/time.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/softemu8xx.c linux-2.6.34-rc4/arch/powerpc/kernel/softemu8xx.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/softemu8xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/softemu8xx.c	2010-04-13 02:19:00.537633111 +0000
@@ -21,7 +21,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/sys_ppc32.c linux-2.6.34-rc4/arch/powerpc/kernel/sys_ppc32.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/sys_ppc32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/sys_ppc32.c	2010-04-13 02:19:00.537633111 +0000
@@ -41,6 +41,7 @@
 #include <linux/ptrace.h>
 #include <linux/elf.h>
 #include <linux/ipc.h>
+#include <linux/slab.h>
 
 #include <asm/ptrace.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/traps.c linux-2.6.34-rc4/arch/powerpc/kernel/traps.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/traps.c	2010-04-13 02:18:55.465633071 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/traps.c	2010-04-13 02:19:00.538633033 +0000
@@ -21,7 +21,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kernel/vio.c linux-2.6.34-rc4/arch/powerpc/kernel/vio.c
--- linux-2.6.34-rc3/arch/powerpc/kernel/vio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kernel/vio.c	2010-04-13 02:19:00.538633033 +0000
@@ -17,6 +17,7 @@
 #include <linux/types.h>
 #include <linux/device.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/console.h>
 #include <linux/module.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/44x.c linux-2.6.34-rc4/arch/powerpc/kvm/44x.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/44x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/44x.c	2010-04-13 02:19:00.538633033 +0000
@@ -18,6 +18,7 @@
  */
 
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 
 #include <asm/reg.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/book3s.c linux-2.6.34-rc4/arch/powerpc/kvm/book3s.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/book3s.c	2010-04-13 02:18:55.466633014 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/book3s.c	2010-04-13 02:19:00.539633039 +0000
@@ -26,6 +26,7 @@
 #include <asm/kvm_ppc.h>
 #include <asm/kvm_book3s.h>
 #include <asm/mmu_context.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/vmalloc.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/booke.c linux-2.6.34-rc4/arch/powerpc/kvm/booke.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/booke.c	2010-04-13 02:18:55.467633095 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/booke.c	2010-04-13 02:19:00.540633041 +0000
@@ -21,6 +21,7 @@
 #include <linux/errno.h>
 #include <linux/err.h>
 #include <linux/kvm_host.h>
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/vmalloc.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/e500.c linux-2.6.34-rc4/arch/powerpc/kvm/e500.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/e500.c	2010-04-13 02:18:55.467633095 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/e500.c	2010-04-13 02:19:00.540633041 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 
 #include <asm/reg.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/e500_tlb.c linux-2.6.34-rc4/arch/powerpc/kvm/e500_tlb.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/e500_tlb.c	2010-04-13 02:18:55.467633095 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/e500_tlb.c	2010-04-13 02:19:00.541633113 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/kvm.h>
 #include <linux/kvm_host.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/kvm/powerpc.c linux-2.6.34-rc4/arch/powerpc/kvm/powerpc.c
--- linux-2.6.34-rc3/arch/powerpc/kvm/powerpc.c	2010-04-13 02:18:55.468633034 +0000
+++ linux-2.6.34-rc4/arch/powerpc/kvm/powerpc.c	2010-04-13 02:19:00.541633113 +0000
@@ -25,6 +25,7 @@
 #include <linux/vmalloc.h>
 #include <linux/hrtimer.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <asm/cputable.h>
 #include <asm/uaccess.h>
 #include <asm/kvm_ppc.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/lib/devres.c linux-2.6.34-rc4/arch/powerpc/lib/devres.c
--- linux-2.6.34-rc3/arch/powerpc/lib/devres.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/lib/devres.c	2010-04-13 02:19:00.541633113 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/device.h>	/* devres_*(), devm_ioremap_release() */
+#include <linux/gfp.h>
 #include <linux/io.h>		/* ioremap_flags() */
 #include <linux/module.h>	/* EXPORT_SYMBOL() */
 
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/dma-noncoherent.c linux-2.6.34-rc4/arch/powerpc/mm/dma-noncoherent.c
--- linux-2.6.34-rc3/arch/powerpc/mm/dma-noncoherent.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/dma-noncoherent.c	2010-04-13 02:19:00.542633062 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/hugetlbpage.c linux-2.6.34-rc4/arch/powerpc/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/powerpc/mm/hugetlbpage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/hugetlbpage.c	2010-04-13 02:19:00.542633062 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/mm.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/hugetlb.h>
 #include <asm/pgtable.h>
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/init_32.c linux-2.6.34-rc4/arch/powerpc/mm/init_32.c
--- linux-2.6.34-rc3/arch/powerpc/mm/init_32.c	2010-04-13 02:18:55.469571682 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/init_32.c	2010-04-13 02:19:00.542633062 +0000
@@ -31,6 +31,7 @@
 #include <linux/initrd.h>
 #include <linux/pagemap.h>
 #include <linux/lmb.h>
+#include <linux/gfp.h>
 
 #include <asm/pgalloc.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/init_64.c linux-2.6.34-rc4/arch/powerpc/mm/init_64.c
--- linux-2.6.34-rc3/arch/powerpc/mm/init_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/init_64.c	2010-04-13 02:19:00.542633062 +0000
@@ -42,6 +42,7 @@
 #include <linux/poison.h>
 #include <linux/lmb.h>
 #include <linux/hugetlb.h>
+#include <linux/slab.h>
 
 #include <asm/pgalloc.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/mem.c linux-2.6.34-rc4/arch/powerpc/mm/mem.c
--- linux-2.6.34-rc3/arch/powerpc/mm/mem.c	2010-04-13 02:18:55.469571682 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/mem.c	2010-04-13 02:19:00.542633062 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 #include <linux/types.h>
 #include <linux/mm.h>
 #include <linux/stddef.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/mmu_context_hash64.c linux-2.6.34-rc4/arch/powerpc/mm/mmu_context_hash64.c
--- linux-2.6.34-rc3/arch/powerpc/mm/mmu_context_hash64.c	2010-04-13 02:18:55.469571682 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/mmu_context_hash64.c	2010-04-13 02:19:00.542633062 +0000
@@ -19,6 +19,7 @@
 #include <linux/spinlock.h>
 #include <linux/idr.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 
 #include <asm/mmu_context.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/mmu_context_nohash.c linux-2.6.34-rc4/arch/powerpc/mm/mmu_context_nohash.c
--- linux-2.6.34-rc3/arch/powerpc/mm/mmu_context_nohash.c	2010-04-13 02:18:55.469571682 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/mmu_context_nohash.c	2010-04-13 02:19:00.543633071 +0000
@@ -47,6 +47,7 @@
 #include <linux/bootmem.h>
 #include <linux/notifier.h>
 #include <linux/cpu.h>
+#include <linux/slab.h>
 
 #include <asm/mmu_context.h>
 #include <asm/tlbflush.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/pgtable.c linux-2.6.34-rc4/arch/powerpc/mm/pgtable.c
--- linux-2.6.34-rc3/arch/powerpc/mm/pgtable.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/pgtable.c	2010-04-13 02:19:00.543633071 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/percpu.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/pgtable_32.c linux-2.6.34-rc4/arch/powerpc/mm/pgtable_32.c
--- linux-2.6.34-rc3/arch/powerpc/mm/pgtable_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/pgtable_32.c	2010-04-13 02:19:00.543633071 +0000
@@ -27,6 +27,7 @@
 #include <linux/init.h>
 #include <linux/highmem.h>
 #include <linux/lmb.h>
+#include <linux/slab.h>
 
 #include <asm/pgtable.h>
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/pgtable_64.c linux-2.6.34-rc4/arch/powerpc/mm/pgtable_64.c
--- linux-2.6.34-rc3/arch/powerpc/mm/pgtable_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/pgtable_64.c	2010-04-13 02:19:00.543633071 +0000
@@ -35,6 +35,7 @@
 #include <linux/init.h>
 #include <linux/bootmem.h>
 #include <linux/lmb.h>
+#include <linux/slab.h>
 
 #include <asm/pgalloc.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/mm/subpage-prot.c linux-2.6.34-rc4/arch/powerpc/mm/subpage-prot.c
--- linux-2.6.34-rc3/arch/powerpc/mm/subpage-prot.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/mm/subpage-prot.c	2010-04-13 02:19:00.543633071 +0000
@@ -10,7 +10,6 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/gfp.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/oprofile/cell/spu_task_sync.c linux-2.6.34-rc4/arch/powerpc/oprofile/cell/spu_task_sync.c
--- linux-2.6.34-rc3/arch/powerpc/oprofile/cell/spu_task_sync.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/oprofile/cell/spu_task_sync.c	2010-04-13 02:19:00.544633070 +0000
@@ -26,6 +26,7 @@
 #include <linux/notifier.h>
 #include <linux/numa.h>
 #include <linux/oprofile.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include "pr_util.h"
 
diff -urN linux-2.6.34-rc3/arch/powerpc/oprofile/cell/vma_map.c linux-2.6.34-rc4/arch/powerpc/oprofile/cell/vma_map.c
--- linux-2.6.34-rc3/arch/powerpc/oprofile/cell/vma_map.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/oprofile/cell/vma_map.c	2010-04-13 02:19:00.544633070 +0000
@@ -20,6 +20,7 @@
 #include <linux/string.h>
 #include <linux/uaccess.h>
 #include <linux/elf.h>
+#include <linux/slab.h>
 #include "pr_util.h"
 
 
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/44x/warp.c linux-2.6.34-rc4/arch/powerpc/platforms/44x/warp.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/44x/warp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/44x/warp.c	2010-04-13 02:19:00.544633070 +0000
@@ -17,6 +17,7 @@
 #include <linux/delay.h>
 #include <linux/of_gpio.h>
 #include <linux/of_i2c.h>
+#include <linux/slab.h>
 
 #include <asm/machdep.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_gpio.c linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_gpio.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_gpio.c	2010-04-13 02:19:00.544633070 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/of.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/of_gpio.h>
 #include <linux/io.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_gpt.c linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_gpt.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_gpt.c	2010-04-13 02:18:55.470570560 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_gpt.c	2010-04-13 02:19:00.545633070 +0000
@@ -62,6 +62,7 @@
 #include <linux/of_platform.h>
 #include <linux/of_gpio.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/watchdog.h>
 #include <linux/miscdevice.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_lpbfifo.c linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_lpbfifo.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/52xx/mpc52xx_lpbfifo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/52xx/mpc52xx_lpbfifo.c	2010-04-13 02:19:00.545633070 +0000
@@ -481,6 +481,8 @@
 	if (rc)
 		goto err_bcom_rx_irq;
 
+	lpbfifo.dma_irqs_enabled = 1;
+
 	/* Request the Bestcomm transmit (memory --> fifo) task and IRQ */
 	lpbfifo.bcom_tx_task =
 		bcom_gen_bd_tx_init(2, res.start + LPBFIFO_REG_FIFO_DATA,
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/82xx/ep8248e.c linux-2.6.34-rc4/arch/powerpc/platforms/82xx/ep8248e.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/82xx/ep8248e.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/82xx/ep8248e.c	2010-04-13 02:19:00.545633070 +0000
@@ -15,6 +15,7 @@
 #include <linux/fsl_devices.h>
 #include <linux/mdio-bitbang.h>
 #include <linux/of_mdio.h>
+#include <linux/slab.h>
 #include <linux/of_platform.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/82xx/pq2ads-pci-pic.c linux-2.6.34-rc4/arch/powerpc/platforms/82xx/pq2ads-pci-pic.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/82xx/pq2ads-pci-pic.c	2010-04-13 02:18:55.470570560 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/82xx/pq2ads-pci-pic.c	2010-04-13 02:19:00.545633070 +0000
@@ -17,6 +17,7 @@
 #include <linux/irq.h>
 #include <linux/types.h>
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/83xx/mcu_mpc8349emitx.c linux-2.6.34-rc4/arch/powerpc/platforms/83xx/mcu_mpc8349emitx.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/83xx/mcu_mpc8349emitx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/83xx/mcu_mpc8349emitx.c	2010-04-13 02:19:00.545633070 +0000
@@ -20,6 +20,7 @@
 #include <linux/gpio.h>
 #include <linux/of.h>
 #include <linux/of_gpio.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include <asm/machdep.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/86xx/gef_gpio.c linux-2.6.34-rc4/arch/powerpc/platforms/86xx/gef_gpio.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/86xx/gef_gpio.c	2010-04-13 02:18:55.471633043 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/86xx/gef_gpio.c	2010-04-13 02:19:00.546633043 +0000
@@ -26,6 +26,7 @@
 #include <linux/of_platform.h>
 #include <linux/of_gpio.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #define GEF_GPIO_DIRECT		0x00
 #define GEF_GPIO_IN		0x04
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/8xx/m8xx_setup.c linux-2.6.34-rc4/arch/powerpc/platforms/8xx/m8xx_setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/8xx/m8xx_setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/8xx/m8xx_setup.c	2010-04-13 02:19:00.546633043 +0000
@@ -11,7 +11,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/axon_msi.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/axon_msi.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/axon_msi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/axon_msi.c	2010-04-13 02:19:00.546633043 +0000
@@ -15,6 +15,7 @@
 #include <linux/msi.h>
 #include <linux/of_platform.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include <asm/dcr.h>
 #include <asm/machdep.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/celleb_pci.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/celleb_pci.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/celleb_pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/celleb_pci.c	2010-04-13 02:19:00.547633097 +0000
@@ -33,6 +33,7 @@
 #include <linux/pci_regs.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/celleb_scc_pciex.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/celleb_scc_pciex.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/celleb_scc_pciex.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/celleb_scc_pciex.c	2010-04-13 02:19:00.547633097 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/bootmem.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/iommu.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/iommu.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/iommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/iommu.c	2010-04-13 02:19:00.547633097 +0000
@@ -28,6 +28,7 @@
 #include <linux/notifier.h>
 #include <linux/of.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 #include <linux/lmb.h>
 
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/ras.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/ras.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/ras.c	2010-04-13 02:18:55.472633084 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/ras.c	2010-04-13 02:19:00.547633097 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/reboot.h>
 #include <linux/kexec.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/setup.c	2010-04-13 02:19:00.547633097 +0000
@@ -19,7 +19,6 @@
 #include <linux/mm.h>
 #include <linux/stddef.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/reboot.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spider-pci.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spider-pci.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spider-pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spider-pci.c	2010-04-13 02:19:00.548633075 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 
 #include <asm/ppc-pci.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spu_manage.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spu_manage.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spu_manage.c	2010-04-13 02:18:55.472633084 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spu_manage.c	2010-04-13 02:19:00.548633075 +0000
@@ -23,7 +23,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/mm.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spu_priv1_mmio.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spu_priv1_mmio.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spu_priv1_mmio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spu_priv1_mmio.c	2010-04-13 02:19:00.548633075 +0000
@@ -22,7 +22,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/mm.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/coredump.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/coredump.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/coredump.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/coredump.c	2010-04-13 02:19:00.548633075 +0000
@@ -24,6 +24,7 @@
 #include <linux/file.h>
 #include <linux/fdtable.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/syscalls.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/file.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/file.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/file.c	2010-04-13 02:19:00.548633075 +0000
@@ -29,6 +29,7 @@
 #include <linux/poll.h>
 #include <linux/ptrace.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/time.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/lscsa_alloc.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/lscsa_alloc.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/lscsa_alloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/lscsa_alloc.c	2010-04-13 02:19:00.548633075 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <asm/spu.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/sched.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/sched.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/sched.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/sched.c	2010-04-13 02:19:00.549633075 +0000
@@ -27,6 +27,7 @@
 #include <linux/sched.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/completion.h>
 #include <linux/vmalloc.h>
 #include <linux/smp.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/syscalls.c linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/syscalls.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/cell/spufs/syscalls.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/cell/spufs/syscalls.c	2010-04-13 02:19:00.549633075 +0000
@@ -3,6 +3,7 @@
 #include <linux/module.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/chrp/nvram.c linux-2.6.34-rc4/arch/powerpc/platforms/chrp/nvram.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/chrp/nvram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/chrp/nvram.c	2010-04-13 02:19:00.549633075 +0000
@@ -12,7 +12,6 @@
 
 #include <linux/kernel.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <asm/uaccess.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/chrp/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/chrp/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/chrp/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/chrp/setup.c	2010-04-13 02:19:00.549633075 +0000
@@ -15,7 +15,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/major.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/iseries/iommu.c linux-2.6.34-rc4/arch/powerpc/platforms/iseries/iommu.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/iseries/iommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/iseries/iommu.c	2010-04-13 02:19:00.549633075 +0000
@@ -29,6 +29,7 @@
 #include <linux/list.h>
 #include <linux/pci.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <asm/iommu.h>
 #include <asm/vio.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/iseries/mf.c linux-2.6.34-rc4/arch/powerpc/platforms/iseries/mf.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/iseries/mf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/iseries/mf.c	2010-04-13 02:19:00.550633042 +0000
@@ -33,6 +33,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/bcd.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 
 #include <asm/time.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/iseries/pci.c linux-2.6.34-rc4/arch/powerpc/platforms/iseries/pci.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/iseries/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/iseries/pci.c	2010-04-13 02:19:00.550633042 +0000
@@ -27,6 +27,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/iseries/vio.c linux-2.6.34-rc4/arch/powerpc/platforms/iseries/vio.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/iseries/vio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/iseries/vio.c	2010-04-13 02:19:00.550633042 +0000
@@ -22,7 +22,7 @@
  */
 #include <linux/of.h>
 #include <linux/init.h>
-#include <linux/gfp.h>
+#include <linux/slab.h>
 #include <linux/completion.h>
 #include <linux/proc_fs.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/iseries/viopath.c linux-2.6.34-rc4/arch/powerpc/platforms/iseries/viopath.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/iseries/viopath.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/iseries/viopath.c	2010-04-13 02:19:00.550633042 +0000
@@ -29,6 +29,7 @@
  */
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/vmalloc.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/maple/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/maple/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/maple/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/maple/setup.c	2010-04-13 02:19:00.550633042 +0000
@@ -21,7 +21,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/dma_lib.c linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/dma_lib.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/dma_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/dma_lib.c	2010-04-13 02:19:00.551585771 +0000
@@ -21,6 +21,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/of.h>
 
 #include <asm/pasemi_dma.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/gpio_mdio.c linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/gpio_mdio.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/gpio_mdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/gpio_mdio.c	2010-04-13 02:19:00.551585771 +0000
@@ -24,6 +24,7 @@
 #include <linux/io.h>
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pasemi/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pasemi/setup.c	2010-04-13 02:19:00.551585771 +0000
@@ -28,6 +28,7 @@
 #include <linux/console.h>
 #include <linux/pci.h>
 #include <linux/of_platform.h>
+#include <linux/gfp.h>
 
 #include <asm/prom.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/cpufreq_32.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/cpufreq_32.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/cpufreq_32.c	2010-04-13 02:18:55.473633075 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/cpufreq_32.c	2010-04-13 02:19:00.551585771 +0000
@@ -21,7 +21,6 @@
 #include <linux/sched.h>
 #include <linux/adb.h>
 #include <linux/pmu.h>
-#include <linux/slab.h>
 #include <linux/cpufreq.h>
 #include <linux/init.h>
 #include <linux/sysdev.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/cpufreq_64.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/cpufreq_64.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/cpufreq_64.c	2010-04-13 02:18:55.474633021 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/cpufreq_64.c	2010-04-13 02:19:00.551585771 +0000
@@ -18,7 +18,6 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/cpufreq.h>
 #include <linux/init.h>
 #include <linux/completion.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/low_i2c.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/low_i2c.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/low_i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/low_i2c.c	2010-04-13 02:19:00.552633059 +0000
@@ -43,6 +43,7 @@
 #include <linux/timer.h>
 #include <linux/mutex.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <asm/keylargo.h>
 #include <asm/uninorth.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/nvram.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/nvram.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/nvram.c	2010-04-13 02:18:55.474633021 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/nvram.c	2010-04-13 02:19:00.552633059 +0000
@@ -14,7 +14,6 @@
 #include <linux/string.h>
 #include <linux/nvram.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/errno.h>
 #include <linux/adb.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/pfunc_core.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/pfunc_core.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/pfunc_core.c	2010-04-13 02:18:55.474633021 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/pfunc_core.c	2010-04-13 02:19:00.552633059 +0000
@@ -9,6 +9,7 @@
 #include <linux/delay.h>
 #include <linux/kernel.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/powermac/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/powermac/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/powermac/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/powermac/setup.c	2010-04-13 02:19:00.553633029 +0000
@@ -31,7 +31,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/ps3/device-init.c linux-2.6.34-rc4/arch/powerpc/platforms/ps3/device-init.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/ps3/device-init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/ps3/device-init.c	2010-04-13 02:19:00.553633029 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/kthread.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/reboot.h>
 
 #include <asm/firmware.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/ps3/mm.c linux-2.6.34-rc4/arch/powerpc/platforms/ps3/mm.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/ps3/mm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/ps3/mm.c	2010-04-13 02:19:00.553633029 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/memory_hotplug.h>
 #include <linux/lmb.h>
+#include <linux/slab.h>
 
 #include <asm/cell-regs.h>
 #include <asm/firmware.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/ps3/os-area.c linux-2.6.34-rc4/arch/powerpc/platforms/ps3/os-area.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/ps3/os-area.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/ps3/os-area.c	2010-04-13 02:19:00.554633080 +0000
@@ -26,6 +26,7 @@
 #include <linux/ctype.h>
 #include <linux/lmb.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 
 #include <asm/prom.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/ps3/spu.c linux-2.6.34-rc4/arch/powerpc/platforms/ps3/spu.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/ps3/spu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/ps3/spu.c	2010-04-13 02:19:00.554633080 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/mmzone.h>
 #include <linux/io.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/ps3/system-bus.c linux-2.6.34-rc4/arch/powerpc/platforms/ps3/system-bus.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/ps3/system-bus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/ps3/system-bus.c	2010-04-13 02:19:00.554633080 +0000
@@ -23,6 +23,7 @@
 #include <linux/module.h>
 #include <linux/dma-mapping.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <asm/udbg.h>
 #include <asm/lv1call.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/cmm.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/cmm.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/cmm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/cmm.c	2010-04-13 02:19:00.554633080 +0000
@@ -24,6 +24,7 @@
 #include <linux/delay.h>
 #include <linux/errno.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kthread.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/dlpar.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/dlpar.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/dlpar.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/dlpar.c	2010-04-13 02:19:00.554633080 +0000
@@ -16,6 +16,7 @@
 #include <linux/proc_fs.h>
 #include <linux/spinlock.h>
 #include <linux/cpu.h>
+#include <linux/slab.h>
 #include "offline_states.h"
 
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/dtl.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/dtl.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/dtl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/dtl.c	2010-04-13 02:19:00.554633080 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/debugfs.h>
 #include <asm/smp.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/eeh_cache.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/eeh_cache.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/eeh_cache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/eeh_cache.c	2010-04-13 02:19:00.555633032 +0000
@@ -23,6 +23,7 @@
 #include <linux/list.h>
 #include <linux/pci.h>
 #include <linux/rbtree.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <asm/atomic.h>
 #include <asm/pci-bridge.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/eeh_event.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/eeh_event.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/eeh_event.c	2010-04-13 02:18:55.476633008 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/eeh_event.c	2010-04-13 02:19:00.555633032 +0000
@@ -22,6 +22,7 @@
 #include <linux/list.h>
 #include <linux/mutex.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <asm/eeh_event.h>
 #include <asm/ppc-pci.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/nvram.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/nvram.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/nvram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/nvram.c	2010-04-13 02:19:00.555633032 +0000
@@ -15,7 +15,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <asm/uaccess.h>
 #include <asm/nvram.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/phyp_dump.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/phyp_dump.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/phyp_dump.c	2010-04-13 02:18:55.476633008 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/phyp_dump.c	2010-04-13 02:19:00.555633032 +0000
@@ -11,6 +11,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kobject.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/ras.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/ras.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/ras.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/ras.c	2010-04-13 02:19:00.556633082 +0000
@@ -30,7 +30,6 @@
 #include <linux/interrupt.h>
 #include <linux/timex.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/irq.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/reconfig.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/reconfig.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/reconfig.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/reconfig.c	2010-04-13 02:19:00.556633082 +0000
@@ -15,6 +15,7 @@
 #include <linux/kref.h>
 #include <linux/notifier.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 
 #include <asm/prom.h>
 #include <asm/machdep.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/scanlog.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/scanlog.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/scanlog.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/scanlog.c	2010-04-13 02:19:00.556633082 +0000
@@ -26,6 +26,7 @@
 #include <linux/proc_fs.h>
 #include <linux/init.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/rtas.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/platforms/pseries/setup.c linux-2.6.34-rc4/arch/powerpc/platforms/pseries/setup.c
--- linux-2.6.34-rc3/arch/powerpc/platforms/pseries/setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/platforms/pseries/setup.c	2010-04-13 02:19:00.556633082 +0000
@@ -23,7 +23,6 @@
 #include <linux/mm.h>
 #include <linux/stddef.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/major.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/cpm1.c linux-2.6.34-rc4/arch/powerpc/sysdev/cpm1.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/cpm1.c	2010-04-13 02:18:55.477633083 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/cpm1.c	2010-04-13 02:19:00.556633082 +0000
@@ -31,6 +31,7 @@
 #include <linux/irq.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <asm/page.h>
 #include <asm/pgtable.h>
 #include <asm/8xx_immap.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/cpm_common.c linux-2.6.34-rc4/arch/powerpc/sysdev/cpm_common.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/cpm_common.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/cpm_common.c	2010-04-13 02:19:00.557633049 +0000
@@ -21,6 +21,7 @@
 #include <linux/of_device.h>
 #include <linux/spinlock.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 
 #include <asm/udbg.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/dart_iommu.c linux-2.6.34-rc4/arch/powerpc/sysdev/dart_iommu.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/dart_iommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/dart_iommu.c	2010-04-13 02:19:00.557633049 +0000
@@ -29,7 +29,6 @@
 
 #include <linux/init.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
@@ -38,6 +37,7 @@
 #include <linux/vmalloc.h>
 #include <linux/suspend.h>
 #include <linux/lmb.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <asm/prom.h>
 #include <asm/iommu.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_gtm.c linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_gtm.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_gtm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_gtm.c	2010-04-13 02:19:00.557633049 +0000
@@ -20,6 +20,7 @@
 #include <linux/of.h>
 #include <linux/spinlock.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <asm/fsl_gtm.h>
 
 #define GTCFR_STP(x)		((x) & 1 ? 1 << 5 : 1 << 1)
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_msi.c linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_msi.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_msi.c	2010-04-13 02:18:55.477633083 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_msi.c	2010-04-13 02:19:00.557633049 +0000
@@ -16,6 +16,7 @@
 #include <linux/bootmem.h>
 #include <linux/msi.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/of_platform.h>
 #include <sysdev/fsl_soc.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_pci.c linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_pci.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_pci.c	2010-04-13 02:19:00.557633049 +0000
@@ -25,6 +25,7 @@
 #include <linux/bootmem.h>
 #include <linux/lmb.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_rio.c linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_rio.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/fsl_rio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/fsl_rio.c	2010-04-13 02:19:00.557633049 +0000
@@ -23,6 +23,7 @@
 #include <linux/rio_drv.h>
 #include <linux/of_platform.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/mpc8xxx_gpio.c linux-2.6.34-rc4/arch/powerpc/sysdev/mpc8xxx_gpio.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/mpc8xxx_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/mpc8xxx_gpio.c	2010-04-13 02:19:00.558633085 +0000
@@ -15,6 +15,7 @@
 #include <linux/of.h>
 #include <linux/of_gpio.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #define MPC8XXX_GPIO_PINS	32
 
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/mpic.c linux-2.6.34-rc4/arch/powerpc/sysdev/mpic.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/mpic.c	2010-04-13 02:18:55.478633068 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/mpic.c	2010-04-13 02:19:00.558633085 +0000
@@ -26,6 +26,7 @@
 #include <linux/bootmem.h>
 #include <linux/spinlock.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include <asm/ptrace.h>
 #include <asm/signal.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/msi_bitmap.c linux-2.6.34-rc4/arch/powerpc/sysdev/msi_bitmap.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/msi_bitmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/msi_bitmap.c	2010-04-13 02:19:00.559633037 +0000
@@ -8,6 +8,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/bitmap.h>
 #include <asm/msi_bitmap.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/of_rtc.c linux-2.6.34-rc4/arch/powerpc/sysdev/of_rtc.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/of_rtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/of_rtc.c	2010-04-13 02:19:00.559633037 +0000
@@ -12,6 +12,7 @@
 #include <linux/of.h>
 #include <linux/init.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 
 static __initdata struct {
 	const char *compatible;
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/pmi.c linux-2.6.34-rc4/arch/powerpc/sysdev/pmi.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/pmi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/pmi.c	2010-04-13 02:19:00.559633037 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/completion.h>
 #include <linux/spinlock.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/ppc4xx_gpio.c linux-2.6.34-rc4/arch/powerpc/sysdev/ppc4xx_gpio.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/ppc4xx_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/ppc4xx_gpio.c	2010-04-13 02:19:00.559633037 +0000
@@ -29,6 +29,7 @@
 #include <linux/of_gpio.h>
 #include <linux/gpio.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 
 #define GPIO_MASK(gpio)		(0x80000000 >> (gpio))
 #define GPIO_MASK2(gpio)	(0xc0000000 >> ((gpio) * 2))
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/ppc4xx_pci.c linux-2.6.34-rc4/arch/powerpc/sysdev/ppc4xx_pci.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/ppc4xx_pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/ppc4xx_pci.c	2010-04-13 02:19:00.559633037 +0000
@@ -24,6 +24,7 @@
 #include <linux/of.h>
 #include <linux/bootmem.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/pci-bridge.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/qe_lib/gpio.c linux-2.6.34-rc4/arch/powerpc/sysdev/qe_lib/gpio.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/qe_lib/gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/qe_lib/gpio.c	2010-04-13 02:19:00.559633037 +0000
@@ -19,6 +19,7 @@
 #include <linux/of.h>
 #include <linux/of_gpio.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 #include <asm/qe.h>
 
 struct qe_gpio_chip {
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/qe_lib/ucc.c linux-2.6.34-rc4/arch/powerpc/sysdev/qe_lib/ucc.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/qe_lib/ucc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/qe_lib/ucc.c	2010-04-13 02:19:00.560633081 +0000
@@ -16,7 +16,6 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/spinlock.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/simple_gpio.c linux-2.6.34-rc4/arch/powerpc/sysdev/simple_gpio.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/simple_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/simple_gpio.c	2010-04-13 02:19:00.560633081 +0000
@@ -21,6 +21,7 @@
 #include <linux/of.h>
 #include <linux/of_gpio.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include "simple_gpio.h"
 
diff -urN linux-2.6.34-rc3/arch/powerpc/sysdev/tsi108_pci.c linux-2.6.34-rc4/arch/powerpc/sysdev/tsi108_pci.c
--- linux-2.6.34-rc3/arch/powerpc/sysdev/tsi108_pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/powerpc/sysdev/tsi108_pci.c	2010-04-13 02:19:00.560633081 +0000
@@ -24,7 +24,6 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/irq.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/arch/s390/appldata/appldata_mem.c linux-2.6.34-rc4/arch/s390/appldata/appldata_mem.c
--- linux-2.6.34-rc3/arch/s390/appldata/appldata_mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/appldata/appldata_mem.c	2010-04-13 02:19:00.561633081 +0000
@@ -11,7 +11,6 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kernel_stat.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/arch/s390/appldata/appldata_net_sum.c linux-2.6.34-rc4/arch/s390/appldata/appldata_net_sum.c
--- linux-2.6.34-rc3/arch/s390/appldata/appldata_net_sum.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/appldata/appldata_net_sum.c	2010-04-13 02:19:00.561633081 +0000
@@ -12,7 +12,6 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kernel_stat.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/arch/s390/crypto/prng.c linux-2.6.34-rc4/arch/s390/crypto/prng.c
--- linux-2.6.34-rc3/arch/s390/crypto/prng.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/crypto/prng.c	2010-04-13 02:19:00.562633132 +0000
@@ -10,6 +10,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <asm/debug.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/arch/s390/defconfig linux-2.6.34-rc4/arch/s390/defconfig
--- linux-2.6.34-rc3/arch/s390/defconfig	2010-04-13 02:18:55.480570470 +0000
+++ linux-2.6.34-rc4/arch/s390/defconfig	2010-04-13 02:19:00.562633132 +0000
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don't edit
-# Linux kernel version: 2.6.33-rc2
-# Mon Jan  4 09:03:07 2010
+# Linux kernel version: 2.6.34-rc3
+# Fri Apr  9 09:57:10 2010
 #
 CONFIG_SCHED_MC=y
 CONFIG_MMU=y
@@ -17,6 +17,7 @@
 CONFIG_GENERIC_TIME_VSYSCALL=y
 CONFIG_GENERIC_CLOCKEVENTS=y
 CONFIG_GENERIC_BUG=y
+CONFIG_GENERIC_BUG_RELATIVE_POINTERS=y
 CONFIG_NO_IOMEM=y
 CONFIG_NO_DMA=y
 CONFIG_GENERIC_LOCKBREAK=y
@@ -62,15 +63,11 @@
 # CONFIG_RCU_TRACE is not set
 CONFIG_RCU_FANOUT=64
 # CONFIG_RCU_FANOUT_EXACT is not set
+# CONFIG_RCU_FAST_NO_HZ is not set
 # CONFIG_TREE_RCU_TRACE is not set
 CONFIG_IKCONFIG=y
 CONFIG_IKCONFIG_PROC=y
 CONFIG_LOG_BUF_SHIFT=17
-CONFIG_GROUP_SCHED=y
-CONFIG_FAIR_GROUP_SCHED=y
-# CONFIG_RT_GROUP_SCHED is not set
-CONFIG_USER_SCHED=y
-# CONFIG_CGROUP_SCHED is not set
 CONFIG_CGROUPS=y
 # CONFIG_CGROUP_DEBUG is not set
 CONFIG_CGROUP_NS=y
@@ -79,6 +76,7 @@
 # CONFIG_CPUSETS is not set
 # CONFIG_CGROUP_CPUACCT is not set
 # CONFIG_RESOURCE_COUNTERS is not set
+# CONFIG_CGROUP_SCHED is not set
 CONFIG_SYSFS_DEPRECATED=y
 CONFIG_SYSFS_DEPRECATED_V2=y
 # CONFIG_RELAY is not set
@@ -93,6 +91,7 @@
 CONFIG_RD_GZIP=y
 CONFIG_RD_BZIP2=y
 CONFIG_RD_LZMA=y
+CONFIG_RD_LZO=y
 # CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
 CONFIG_SYSCTL=y
 CONFIG_ANON_INODES=y
@@ -126,6 +125,7 @@
 # CONFIG_SLUB is not set
 # CONFIG_SLOB is not set
 # CONFIG_PROFILING is not set
+CONFIG_TRACEPOINTS=y
 CONFIG_HAVE_OPROFILE=y
 CONFIG_KPROBES=y
 CONFIG_HAVE_SYSCALL_WRAPPERS=y
@@ -134,6 +134,7 @@
 CONFIG_HAVE_KRETPROBES=y
 CONFIG_HAVE_ARCH_TRACEHOOK=y
 CONFIG_USE_GENERIC_SMP_HELPERS=y
+CONFIG_HAVE_REGS_AND_STACK_ACCESS_API=y
 CONFIG_HAVE_DEFAULT_NO_SPIN_MUTEXES=y
 
 #
@@ -246,6 +247,7 @@
 CONFIG_SMP=y
 CONFIG_NR_CPUS=32
 CONFIG_HOTPLUG_CPU=y
+# CONFIG_SCHED_BOOK is not set
 CONFIG_COMPAT=y
 CONFIG_SYSVIPC_COMPAT=y
 CONFIG_AUDIT_ARCH=y
@@ -345,13 +347,13 @@
 CONFIG_HIBERNATION=y
 CONFIG_PM_STD_PARTITION=""
 # CONFIG_PM_RUNTIME is not set
+CONFIG_PM_OPS=y
 CONFIG_NET=y
 
 #
 # Networking options
 #
 CONFIG_PACKET=y
-# CONFIG_PACKET_MMAP is not set
 CONFIG_UNIX=y
 CONFIG_XFRM=y
 # CONFIG_XFRM_USER is not set
@@ -529,6 +531,7 @@
 #
 # CONFIG_NET_PKTGEN is not set
 # CONFIG_NET_TCPPROBE is not set
+# CONFIG_NET_DROP_MONITOR is not set
 CONFIG_CAN=m
 CONFIG_CAN_RAW=m
 CONFIG_CAN_BCM=m
@@ -605,6 +608,7 @@
 #
 # SCSI device support
 #
+CONFIG_SCSI_MOD=y
 # CONFIG_RAID_ATTRS is not set
 CONFIG_SCSI=y
 # CONFIG_SCSI_DMA is not set
@@ -863,6 +867,7 @@
 # CONFIG_BEFS_FS is not set
 # CONFIG_BFS_FS is not set
 # CONFIG_EFS_FS is not set
+# CONFIG_LOGFS is not set
 # CONFIG_CRAMFS is not set
 # CONFIG_SQUASHFS is not set
 # CONFIG_VXFS_FS is not set
@@ -891,6 +896,7 @@
 # CONFIG_RPCSEC_GSS_KRB5 is not set
 # CONFIG_RPCSEC_GSS_SPKM3 is not set
 # CONFIG_SMB_FS is not set
+# CONFIG_CEPH_FS is not set
 # CONFIG_CIFS is not set
 # CONFIG_NCP_FS is not set
 # CONFIG_CODA_FS is not set
@@ -952,6 +958,7 @@
 # CONFIG_LOCK_STAT is not set
 CONFIG_DEBUG_SPINLOCK_SLEEP=y
 # CONFIG_DEBUG_LOCKING_API_SELFTESTS is not set
+CONFIG_STACKTRACE=y
 # CONFIG_DEBUG_KOBJECT is not set
 CONFIG_DEBUG_BUGVERBOSE=y
 # CONFIG_DEBUG_INFO is not set
@@ -973,12 +980,17 @@
 # CONFIG_LATENCYTOP is not set
 CONFIG_SYSCTL_SYSCALL_CHECK=y
 # CONFIG_DEBUG_PAGEALLOC is not set
+CONFIG_NOP_TRACER=y
 CONFIG_HAVE_FUNCTION_TRACER=y
 CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y
 CONFIG_HAVE_FUNCTION_TRACE_MCOUNT_TEST=y
 CONFIG_HAVE_DYNAMIC_FTRACE=y
 CONFIG_HAVE_FTRACE_MCOUNT_RECORD=y
 CONFIG_HAVE_SYSCALL_TRACEPOINTS=y
+CONFIG_RING_BUFFER=y
+CONFIG_EVENT_TRACING=y
+CONFIG_CONTEXT_SWITCH_TRACER=y
+CONFIG_TRACING=y
 CONFIG_TRACING_SUPPORT=y
 CONFIG_FTRACE=y
 # CONFIG_FUNCTION_TRACER is not set
@@ -995,10 +1007,15 @@
 # CONFIG_KMEMTRACE is not set
 # CONFIG_WORKQUEUE_TRACER is not set
 # CONFIG_BLK_DEV_IO_TRACE is not set
+CONFIG_KPROBE_EVENT=y
+# CONFIG_RING_BUFFER_BENCHMARK is not set
 # CONFIG_DYNAMIC_DEBUG is not set
 CONFIG_SAMPLES=y
+# CONFIG_SAMPLE_TRACEPOINTS is not set
+# CONFIG_SAMPLE_TRACE_EVENTS is not set
 # CONFIG_SAMPLE_KOBJECT is not set
 # CONFIG_SAMPLE_KPROBES is not set
+# CONFIG_DEBUG_STRICT_USER_COPY_CHECKS is not set
 
 #
 # Security options
@@ -1032,6 +1049,7 @@
 CONFIG_CRYPTO_MANAGER2=y
 CONFIG_CRYPTO_GF128MUL=m
 # CONFIG_CRYPTO_NULL is not set
+# CONFIG_CRYPTO_PCRYPT is not set
 CONFIG_CRYPTO_WORKQUEUE=y
 # CONFIG_CRYPTO_CRYPTD is not set
 CONFIG_CRYPTO_AUTHENC=m
@@ -1119,7 +1137,7 @@
 # CONFIG_CRYPTO_DES_S390 is not set
 # CONFIG_CRYPTO_AES_S390 is not set
 CONFIG_S390_PRNG=m
-# CONFIG_BINARY_PRINTF is not set
+CONFIG_BINARY_PRINTF=y
 
 #
 # Library routines
@@ -1136,14 +1154,16 @@
 CONFIG_ZLIB_INFLATE=y
 CONFIG_ZLIB_DEFLATE=m
 CONFIG_LZO_COMPRESS=m
-CONFIG_LZO_DECOMPRESS=m
+CONFIG_LZO_DECOMPRESS=y
 CONFIG_DECOMPRESS_GZIP=y
 CONFIG_DECOMPRESS_BZIP2=y
 CONFIG_DECOMPRESS_LZMA=y
+CONFIG_DECOMPRESS_LZO=y
 CONFIG_NLATTR=y
 CONFIG_HAVE_KVM=y
 CONFIG_VIRTUALIZATION=y
 CONFIG_KVM=m
+# CONFIG_VHOST_NET is not set
 CONFIG_VIRTIO=y
 CONFIG_VIRTIO_RING=y
 CONFIG_VIRTIO_BALLOON=m
diff -urN linux-2.6.34-rc3/arch/s390/hypfs/hypfs_diag.c linux-2.6.34-rc4/arch/s390/hypfs/hypfs_diag.c
--- linux-2.6.34-rc3/arch/s390/hypfs/hypfs_diag.c	2010-04-13 02:18:55.480570470 +0000
+++ linux-2.6.34-rc4/arch/s390/hypfs/hypfs_diag.c	2010-04-13 02:19:00.562633132 +0000
@@ -12,7 +12,6 @@
 
 #include <linux/types.h>
 #include <linux/errno.h>
-#include <linux/gfp.h>
 #include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/arch/s390/hypfs/inode.c linux-2.6.34-rc4/arch/s390/hypfs/inode.c
--- linux-2.6.34-rc3/arch/s390/hypfs/inode.c	2010-04-13 02:18:55.480570470 +0000
+++ linux-2.6.34-rc4/arch/s390/hypfs/inode.c	2010-04-13 02:19:00.562633132 +0000
@@ -14,8 +14,8 @@
 #include <linux/fs.h>
 #include <linux/namei.h>
 #include <linux/vfs.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
-#include <linux/gfp.h>
 #include <linux/time.h>
 #include <linux/parser.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/arch/s390/include/asm/pgtable.h linux-2.6.34-rc4/arch/s390/include/asm/pgtable.h
--- linux-2.6.34-rc3/arch/s390/include/asm/pgtable.h	2010-04-13 02:18:55.482633040 +0000
+++ linux-2.6.34-rc4/arch/s390/include/asm/pgtable.h	2010-04-13 02:19:00.564633065 +0000
@@ -105,7 +105,7 @@
 #ifndef __ASSEMBLY__
 /*
  * The vmalloc area will always be on the topmost area of the kernel
- * mapping. We reserve 96MB (31bit) / 1GB (64bit) for vmalloc,
+ * mapping. We reserve 96MB (31bit) / 128GB (64bit) for vmalloc,
  * which should be enough for any sane case.
  * By putting vmalloc at the top, we maximise the gap between physical
  * memory and vmalloc to catch misplaced memory accesses. As a side
@@ -120,8 +120,8 @@
 #define VMALLOC_END	0x7e000000UL
 #define VMEM_MAP_END	0x80000000UL
 #else /* __s390x__ */
-#define VMALLOC_SIZE	(1UL << 30)
-#define VMALLOC_END	0x3e040000000UL
+#define VMALLOC_SIZE	(128UL << 30)
+#define VMALLOC_END	0x3e000000000UL
 #define VMEM_MAP_END	0x40000000000UL
 #endif /* __s390x__ */
 
diff -urN linux-2.6.34-rc3/arch/s390/kernel/compat_linux.c linux-2.6.34-rc4/arch/s390/kernel/compat_linux.c
--- linux-2.6.34-rc3/arch/s390/kernel/compat_linux.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/compat_linux.c	2010-04-13 02:19:00.566633053 +0000
@@ -29,7 +29,6 @@
 #include <linux/sem.h>
 #include <linux/msg.h>
 #include <linux/shm.h>
-#include <linux/slab.h>
 #include <linux/uio.h>
 #include <linux/quota.h>
 #include <linux/module.h>
@@ -52,6 +51,7 @@
 #include <linux/ptrace.h>
 #include <linux/fadvise.h>
 #include <linux/ipc.h>
+#include <linux/slab.h>
 
 #include <asm/types.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/early.c linux-2.6.34-rc4/arch/s390/kernel/early.c
--- linux-2.6.34-rc3/arch/s390/kernel/early.c	2010-04-13 02:18:55.485633114 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/early.c	2010-04-13 02:19:00.567633070 +0000
@@ -82,7 +82,8 @@
 	"	lm	6,15,24(15)\n"
 #endif
 	"	br	14\n"
-	"	.size	savesys_ipl_nss, .-savesys_ipl_nss\n");
+	"	.size	savesys_ipl_nss, .-savesys_ipl_nss\n"
+	"	.previous\n");
 
 static __initdata char upper_command_line[COMMAND_LINE_SIZE];
 
diff -urN linux-2.6.34-rc3/arch/s390/kernel/entry.S linux-2.6.34-rc4/arch/s390/kernel/entry.S
--- linux-2.6.34-rc3/arch/s390/kernel/entry.S	2010-04-13 02:18:55.485633114 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/entry.S	2010-04-13 02:19:00.567633070 +0000
@@ -964,7 +964,7 @@
 	clc	4(4,%r12),BASED(cleanup_table_io_work_loop)
 	bl	BASED(0f)
 	clc	4(4,%r12),BASED(cleanup_table_io_work_loop+4)
-	bl	BASED(cleanup_io_return)
+	bl	BASED(cleanup_io_work_loop)
 0:
 	br	%r14
 
@@ -1039,6 +1039,12 @@
 
 cleanup_io_return:
 	mvc	__LC_RETURN_PSW(4),0(%r12)
+	mvc	__LC_RETURN_PSW+4(4),BASED(cleanup_table_io_return)
+	la	%r12,__LC_RETURN_PSW
+	br	%r14
+
+cleanup_io_work_loop:
+	mvc	__LC_RETURN_PSW(4),0(%r12)
 	mvc	__LC_RETURN_PSW+4(4),BASED(cleanup_table_io_work_loop)
 	la	%r12,__LC_RETURN_PSW
 	br	%r14
diff -urN linux-2.6.34-rc3/arch/s390/kernel/entry64.S linux-2.6.34-rc4/arch/s390/kernel/entry64.S
--- linux-2.6.34-rc3/arch/s390/kernel/entry64.S	2010-04-13 02:18:55.486633048 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/entry64.S	2010-04-13 02:19:00.568633112 +0000
@@ -946,7 +946,7 @@
 	clc	8(8,%r12),BASED(cleanup_table_io_work_loop)
 	jl	0f
 	clc	8(8,%r12),BASED(cleanup_table_io_work_loop+8)
-	jl	cleanup_io_return
+	jl	cleanup_io_work_loop
 0:
 	br	%r14
 
@@ -1021,6 +1021,12 @@
 
 cleanup_io_return:
 	mvc	__LC_RETURN_PSW(8),0(%r12)
+	mvc	__LC_RETURN_PSW+8(8),BASED(cleanup_table_io_return)
+	la	%r12,__LC_RETURN_PSW
+	br	%r14
+
+cleanup_io_work_loop:
+	mvc	__LC_RETURN_PSW(8),0(%r12)
 	mvc	__LC_RETURN_PSW+8(8),BASED(cleanup_table_io_work_loop)
 	la	%r12,__LC_RETURN_PSW
 	br	%r14
diff -urN linux-2.6.34-rc3/arch/s390/kernel/ipl.c linux-2.6.34-rc4/arch/s390/kernel/ipl.c
--- linux-2.6.34-rc3/arch/s390/kernel/ipl.c	2010-04-13 02:18:55.486633048 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/ipl.c	2010-04-13 02:19:00.569633076 +0000
@@ -15,6 +15,7 @@
 #include <linux/reboot.h>
 #include <linux/ctype.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <asm/ipl.h>
 #include <asm/smp.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/kprobes.c linux-2.6.34-rc4/arch/s390/kernel/kprobes.c
--- linux-2.6.34-rc3/arch/s390/kernel/kprobes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/kprobes.c	2010-04-13 02:19:00.569633076 +0000
@@ -29,6 +29,7 @@
 #include <asm/cacheflush.h>
 #include <asm/sections.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 DEFINE_PER_CPU(struct kprobe *, current_kprobe) = NULL;
 DEFINE_PER_CPU(struct kprobe_ctlblk, kprobe_ctlblk);
diff -urN linux-2.6.34-rc3/arch/s390/kernel/process.c linux-2.6.34-rc4/arch/s390/kernel/process.c
--- linux-2.6.34-rc3/arch/s390/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/process.c	2010-04-13 02:19:00.569633076 +0000
@@ -16,9 +16,9 @@
 #include <linux/fs.h>
 #include <linux/smp.h>
 #include <linux/stddef.h>
+#include <linux/slab.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/user.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/setup.c linux-2.6.34-rc4/arch/s390/kernel/setup.c
--- linux-2.6.34-rc3/arch/s390/kernel/setup.c	2010-04-13 02:18:55.487633023 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/setup.c	2010-04-13 02:19:00.570633115 +0000
@@ -25,7 +25,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/tty.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/smp.c linux-2.6.34-rc4/arch/s390/kernel/smp.c
--- linux-2.6.34-rc3/arch/s390/kernel/smp.c	2010-04-13 02:18:55.487633023 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/smp.c	2010-04-13 02:19:00.570633115 +0000
@@ -36,6 +36,7 @@
 #include <linux/cpu.h>
 #include <linux/timex.h>
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 #include <asm/asm-offsets.h>
 #include <asm/ipl.h>
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/sysinfo.c linux-2.6.34-rc4/arch/s390/kernel/sysinfo.c
--- linux-2.6.34-rc3/arch/s390/kernel/sysinfo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/sysinfo.c	2010-04-13 02:19:00.571633024 +0000
@@ -11,6 +11,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/ebcdic.h>
 #include <asm/sysinfo.h>
 #include <asm/cpcmd.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/time.c linux-2.6.34-rc4/arch/s390/kernel/time.c
--- linux-2.6.34-rc3/arch/s390/kernel/time.c	2010-04-13 02:18:55.488633059 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/time.c	2010-04-13 02:19:00.571633024 +0000
@@ -36,6 +36,7 @@
 #include <linux/notifier.h>
 #include <linux/clocksource.h>
 #include <linux/clockchips.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 #include <asm/delay.h>
 #include <asm/s390_ext.h>
diff -urN linux-2.6.34-rc3/arch/s390/kernel/topology.c linux-2.6.34-rc4/arch/s390/kernel/topology.c
--- linux-2.6.34-rc3/arch/s390/kernel/topology.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/kernel/topology.c	2010-04-13 02:19:00.571633024 +0000
@@ -165,10 +165,11 @@
 		default:
 			clear_cores();
 			machine_has_topology = 0;
-			return;
+			goto out;
 		}
 		tle = next_tle(tle);
 	}
+out:
 	spin_unlock_irq(&topology_lock);
 }
 
diff -urN linux-2.6.34-rc3/arch/s390/kvm/interrupt.c linux-2.6.34-rc4/arch/s390/kvm/interrupt.c
--- linux-2.6.34-rc3/arch/s390/kvm/interrupt.c	2010-04-13 02:18:55.489571917 +0000
+++ linux-2.6.34-rc4/arch/s390/kvm/interrupt.c	2010-04-13 02:19:00.572633033 +0000
@@ -14,6 +14,7 @@
 #include <linux/kvm_host.h>
 #include <linux/hrtimer.h>
 #include <linux/signal.h>
+#include <linux/slab.h>
 #include <asm/asm-offsets.h>
 #include <asm/uaccess.h>
 #include "kvm-s390.h"
diff -urN linux-2.6.34-rc3/arch/s390/kvm/priv.c linux-2.6.34-rc4/arch/s390/kvm/priv.c
--- linux-2.6.34-rc3/arch/s390/kvm/priv.c	2010-04-13 02:18:55.489571917 +0000
+++ linux-2.6.34-rc4/arch/s390/kvm/priv.c	2010-04-13 02:19:00.572633033 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/kvm.h>
+#include <linux/gfp.h>
 #include <linux/errno.h>
 #include <asm/current.h>
 #include <asm/debug.h>
diff -urN linux-2.6.34-rc3/arch/s390/kvm/sigp.c linux-2.6.34-rc4/arch/s390/kvm/sigp.c
--- linux-2.6.34-rc3/arch/s390/kvm/sigp.c	2010-04-13 02:18:55.489571917 +0000
+++ linux-2.6.34-rc4/arch/s390/kvm/sigp.c	2010-04-13 02:19:00.572633033 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/kvm.h>
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 #include "gaccess.h"
 #include "kvm-s390.h"
 
diff -urN linux-2.6.34-rc3/arch/s390/mm/cmm.c linux-2.6.34-rc4/arch/s390/mm/cmm.c
--- linux-2.6.34-rc3/arch/s390/mm/cmm.c	2010-04-13 02:18:55.490570531 +0000
+++ linux-2.6.34-rc4/arch/s390/mm/cmm.c	2010-04-13 02:19:00.572633033 +0000
@@ -12,6 +12,7 @@
 #include <linux/fs.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/sysctl.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/arch/s390/mm/init.c linux-2.6.34-rc4/arch/s390/mm/init.c
--- linux-2.6.34-rc3/arch/s390/mm/init.c	2010-04-13 02:18:55.490570531 +0000
+++ linux-2.6.34-rc4/arch/s390/mm/init.c	2010-04-13 02:19:00.573633078 +0000
@@ -26,6 +26,7 @@
 #include <linux/pfn.h>
 #include <linux/poison.h>
 #include <linux/initrd.h>
+#include <linux/gfp.h>
 #include <asm/processor.h>
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/s390/mm/page-states.c linux-2.6.34-rc4/arch/s390/mm/page-states.c
--- linux-2.6.34-rc3/arch/s390/mm/page-states.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/mm/page-states.c	2010-04-13 02:19:00.573633078 +0000
@@ -10,6 +10,7 @@
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 
 #define ESSA_SET_STABLE		1
diff -urN linux-2.6.34-rc3/arch/s390/mm/pgtable.c linux-2.6.34-rc4/arch/s390/mm/pgtable.c
--- linux-2.6.34-rc3/arch/s390/mm/pgtable.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/mm/pgtable.c	2010-04-13 02:19:00.573633078 +0000
@@ -6,11 +6,11 @@
 #include <linux/sched.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/smp.h>
 #include <linux/highmem.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/spinlock.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/s390/mm/vmem.c linux-2.6.34-rc4/arch/s390/mm/vmem.c
--- linux-2.6.34-rc3/arch/s390/mm/vmem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/s390/mm/vmem.c	2010-04-13 02:19:00.573633078 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/list.h>
 #include <linux/hugetlb.h>
+#include <linux/slab.h>
 #include <asm/pgalloc.h>
 #include <asm/pgtable.h>
 #include <asm/setup.h>
@@ -70,12 +71,8 @@
 		pte = alloc_bootmem(PTRS_PER_PTE * sizeof(pte_t));
 	if (!pte)
 		return NULL;
-	if (MACHINE_HAS_HPAGE)
-		clear_table((unsigned long *) pte, _PAGE_TYPE_EMPTY | _PAGE_CO,
-			    PTRS_PER_PTE * sizeof(pte_t));
-	else
-		clear_table((unsigned long *) pte, _PAGE_TYPE_EMPTY,
-			    PTRS_PER_PTE * sizeof(pte_t));
+	clear_table((unsigned long *) pte, _PAGE_TYPE_EMPTY,
+		    PTRS_PER_PTE * sizeof(pte_t));
 	return pte;
 }
 
@@ -116,8 +113,7 @@
 		if (MACHINE_HAS_HPAGE && !(address & ~HPAGE_MASK) &&
 		    (address + HPAGE_SIZE <= start + size) &&
 		    (address >= HPAGE_SIZE)) {
-			pte_val(pte) |= _SEGMENT_ENTRY_LARGE |
-					_SEGMENT_ENTRY_CO;
+			pte_val(pte) |= _SEGMENT_ENTRY_LARGE;
 			pmd_val(*pm_dir) = pte_val(pte);
 			address += HPAGE_SIZE - PAGE_SIZE;
 			continue;
diff -urN linux-2.6.34-rc3/arch/score/kernel/sys_score.c linux-2.6.34-rc4/arch/score/kernel/sys_score.c
--- linux-2.6.34-rc3/arch/score/kernel/sys_score.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/score/kernel/sys_score.c	2010-04-13 02:19:00.573633078 +0000
@@ -28,6 +28,7 @@
 #include <linux/mm.h>
 #include <linux/mman.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/unistd.h>
 #include <linux/syscalls.h>
 #include <asm/syscalls.h>
diff -urN linux-2.6.34-rc3/arch/score/mm/init.c linux-2.6.34-rc4/arch/score/mm/init.c
--- linux-2.6.34-rc3/arch/score/mm/init.c	2010-04-13 02:18:55.490570531 +0000
+++ linux-2.6.34-rc4/arch/score/mm/init.c	2010-04-13 02:19:00.574633051 +0000
@@ -26,6 +26,7 @@
 #include <linux/errno.h>
 #include <linux/bootmem.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/mm.h>
 #include <linux/mman.h>
diff -urN linux-2.6.34-rc3/arch/sh/configs/ecovec24_defconfig linux-2.6.34-rc4/arch/sh/configs/ecovec24_defconfig
--- linux-2.6.34-rc3/arch/sh/configs/ecovec24_defconfig	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/configs/ecovec24_defconfig	2010-04-13 02:19:00.583633081 +0000
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don't edit
-# Linux kernel version: 2.6.33-rc2
-# Mon Jan  4 11:20:36 2010
+# Linux kernel version: 2.6.34-rc2
+# Mon Mar 29 02:21:58 2010
 #
 CONFIG_SUPERH=y
 CONFIG_SUPERH32=y
@@ -13,8 +13,8 @@
 CONFIG_GENERIC_HWEIGHT=y
 CONFIG_GENERIC_HARDIRQS=y
 CONFIG_GENERIC_HARDIRQS_NO__DO_IRQ=y
-CONFIG_GENERIC_IRQ_PROBE=y
 CONFIG_IRQ_PER_CPU=y
+CONFIG_SPARSE_IRQ=y
 CONFIG_GENERIC_GPIO=y
 CONFIG_GENERIC_TIME=y
 CONFIG_GENERIC_CLOCKEVENTS=y
@@ -32,6 +32,7 @@
 CONFIG_ARCH_HAS_DEFAULT_IDLE=y
 CONFIG_ARCH_HAS_CPU_IDLE_WAIT=y
 CONFIG_DMA_NONCOHERENT=y
+CONFIG_NEED_DMA_MAP_STATE=y
 CONFIG_DEFCONFIG_LIST="/lib/modules/$UNAME_RELEASE/.config"
 CONFIG_CONSTRUCTORS=y
 
@@ -47,9 +48,11 @@
 CONFIG_HAVE_KERNEL_GZIP=y
 CONFIG_HAVE_KERNEL_BZIP2=y
 CONFIG_HAVE_KERNEL_LZMA=y
+CONFIG_HAVE_KERNEL_LZO=y
 CONFIG_KERNEL_GZIP=y
 # CONFIG_KERNEL_BZIP2 is not set
 # CONFIG_KERNEL_LZMA is not set
+# CONFIG_KERNEL_LZO is not set
 CONFIG_SWAP=y
 CONFIG_SYSVIPC=y
 CONFIG_SYSVIPC_SYSCTL=y
@@ -71,14 +74,8 @@
 # CONFIG_TREE_RCU_TRACE is not set
 # CONFIG_IKCONFIG is not set
 CONFIG_LOG_BUF_SHIFT=14
-CONFIG_GROUP_SCHED=y
-CONFIG_FAIR_GROUP_SCHED=y
-# CONFIG_RT_GROUP_SCHED is not set
-CONFIG_USER_SCHED=y
-# CONFIG_CGROUP_SCHED is not set
 # CONFIG_CGROUPS is not set
-CONFIG_SYSFS_DEPRECATED=y
-CONFIG_SYSFS_DEPRECATED_V2=y
+# CONFIG_SYSFS_DEPRECATED_V2 is not set
 # CONFIG_RELAY is not set
 # CONFIG_NAMESPACES is not set
 # CONFIG_BLK_DEV_INITRD is not set
@@ -107,7 +104,7 @@
 #
 # Kernel Performance Events And Counters
 #
-# CONFIG_PERF_EVENTS is not set
+CONFIG_PERF_EVENTS=y
 # CONFIG_PERF_COUNTERS is not set
 CONFIG_VM_EVENT_COUNTERS=y
 CONFIG_COMPAT_BRK=y
@@ -116,13 +113,13 @@
 # CONFIG_SLOB is not set
 # CONFIG_PROFILING is not set
 CONFIG_HAVE_OPROFILE=y
-CONFIG_HAVE_IOREMAP_PROT=y
 CONFIG_HAVE_KPROBES=y
 CONFIG_HAVE_KRETPROBES=y
 CONFIG_HAVE_ARCH_TRACEHOOK=y
 CONFIG_HAVE_DMA_ATTRS=y
 CONFIG_HAVE_CLK=y
 CONFIG_HAVE_DMA_API_DEBUG=y
+CONFIG_HAVE_HW_BREAKPOINT=y
 
 #
 # GCOV-based kernel profiling
@@ -234,12 +231,12 @@
 CONFIG_QUICKLIST=y
 CONFIG_MMU=y
 CONFIG_PAGE_OFFSET=0x80000000
-CONFIG_FORCE_MAX_ZONEORDER=11
+CONFIG_FORCE_MAX_ZONEORDER=12
 CONFIG_MEMORY_START=0x08000000
 CONFIG_MEMORY_SIZE=0x10000000
 CONFIG_29BIT=y
-# CONFIG_PMB_ENABLE is not set
-# CONFIG_X2TLB is not set
+# CONFIG_PMB is not set
+CONFIG_X2TLB=y
 CONFIG_VSYSCALL=y
 CONFIG_ARCH_FLATMEM_ENABLE=y
 CONFIG_ARCH_SPARSEMEM_ENABLE=y
@@ -247,6 +244,8 @@
 CONFIG_MAX_ACTIVE_REGIONS=1
 CONFIG_ARCH_POPULATES_NODE_MAP=y
 CONFIG_ARCH_SELECT_MEMORY_MODEL=y
+CONFIG_IOREMAP_FIXED=y
+CONFIG_UNCACHED_MAPPING=y
 CONFIG_PAGE_SIZE_4KB=y
 # CONFIG_PAGE_SIZE_8KB is not set
 # CONFIG_PAGE_SIZE_16KB is not set
@@ -262,7 +261,7 @@
 CONFIG_SPLIT_PTLOCK_CPUS=4
 # CONFIG_PHYS_ADDR_T_64BIT is not set
 CONFIG_ZONE_DMA_FLAG=0
-CONFIG_NR_QUICK=2
+CONFIG_NR_QUICK=1
 # CONFIG_KSM is not set
 CONFIG_DEFAULT_MMAP_MIN_ADDR=4096
 
@@ -337,7 +336,6 @@
 # CONFIG_PREEMPT_VOLUNTARY is not set
 CONFIG_PREEMPT=y
 CONFIG_GUSA=y
-# CONFIG_SPARSE_IRQ is not set
 
 #
 # Boot options
@@ -347,7 +345,7 @@
 CONFIG_ENTRY_OFFSET=0x00001000
 CONFIG_CMDLINE_OVERWRITE=y
 # CONFIG_CMDLINE_EXTEND is not set
-CONFIG_CMDLINE="console=tty0, console=ttySC0,115200 root=/dev/nfs ip=dhcp mem=120M memchunk.vpu=4m"
+CONFIG_CMDLINE="console=tty0, console=ttySC0,115200 root=/dev/nfs ip=dhcp mem=248M memchunk.vpu=8m memchunk.veu0=4m"
 
 #
 # Bus options
@@ -373,6 +371,7 @@
 CONFIG_SUSPEND_FREEZER=y
 # CONFIG_HIBERNATION is not set
 CONFIG_PM_RUNTIME=y
+CONFIG_PM_OPS=y
 # CONFIG_CPU_IDLE is not set
 CONFIG_NET=y
 
@@ -380,7 +379,6 @@
 # Networking options
 #
 CONFIG_PACKET=y
-# CONFIG_PACKET_MMAP is not set
 CONFIG_UNIX=y
 # CONFIG_NET_KEY is not set
 CONFIG_INET=y
@@ -445,7 +443,45 @@
 # CONFIG_NET_PKTGEN is not set
 # CONFIG_HAMRADIO is not set
 # CONFIG_CAN is not set
-# CONFIG_IRDA is not set
+CONFIG_IRDA=y
+
+#
+# IrDA protocols
+#
+# CONFIG_IRLAN is not set
+# CONFIG_IRCOMM is not set
+# CONFIG_IRDA_ULTRA is not set
+
+#
+# IrDA options
+#
+# CONFIG_IRDA_CACHE_LAST_LSAP is not set
+# CONFIG_IRDA_FAST_RR is not set
+# CONFIG_IRDA_DEBUG is not set
+
+#
+# Infrared-port device drivers
+#
+
+#
+# SIR device drivers
+#
+# CONFIG_IRTTY_SIR is not set
+
+#
+# Dongle support
+#
+CONFIG_SH_SIR=y
+# CONFIG_KINGSUN_DONGLE is not set
+# CONFIG_KSDAZZLE_DONGLE is not set
+# CONFIG_KS959_DONGLE is not set
+
+#
+# FIR device drivers
+#
+# CONFIG_USB_IRDA is not set
+# CONFIG_SIGMATEL_FIR is not set
+# CONFIG_MCS_FIR is not set
 # CONFIG_BT is not set
 # CONFIG_AF_RXRPC is not set
 CONFIG_WIRELESS=y
@@ -556,6 +592,7 @@
 # CONFIG_MTD_NAND_NANDSIM is not set
 # CONFIG_MTD_NAND_PLATFORM is not set
 # CONFIG_MTD_ALAUDA is not set
+# CONFIG_MTD_NAND_SH_FLCTL is not set
 # CONFIG_MTD_ONENAND is not set
 
 #
@@ -597,6 +634,7 @@
 # CONFIG_ICS932S401 is not set
 # CONFIG_ENCLOSURE_SERVICES is not set
 # CONFIG_ISL29003 is not set
+# CONFIG_SENSORS_TSL2550 is not set
 # CONFIG_DS1682 is not set
 # CONFIG_TI_DAC7512 is not set
 # CONFIG_C2PORT is not set
@@ -616,6 +654,7 @@
 #
 # SCSI device support
 #
+CONFIG_SCSI_MOD=y
 # CONFIG_RAID_ATTRS is not set
 CONFIG_SCSI=y
 CONFIG_SCSI_DMA=y
@@ -768,7 +807,29 @@
 # CONFIG_INPUT_MOUSE is not set
 # CONFIG_INPUT_JOYSTICK is not set
 # CONFIG_INPUT_TABLET is not set
-# CONFIG_INPUT_TOUCHSCREEN is not set
+CONFIG_INPUT_TOUCHSCREEN=y
+# CONFIG_TOUCHSCREEN_ADS7846 is not set
+# CONFIG_TOUCHSCREEN_AD7877 is not set
+# CONFIG_TOUCHSCREEN_AD7879_I2C is not set
+# CONFIG_TOUCHSCREEN_AD7879_SPI is not set
+# CONFIG_TOUCHSCREEN_AD7879 is not set
+# CONFIG_TOUCHSCREEN_DYNAPRO is not set
+# CONFIG_TOUCHSCREEN_EETI is not set
+# CONFIG_TOUCHSCREEN_FUJITSU is not set
+# CONFIG_TOUCHSCREEN_GUNZE is not set
+# CONFIG_TOUCHSCREEN_ELO is not set
+# CONFIG_TOUCHSCREEN_WACOM_W8001 is not set
+# CONFIG_TOUCHSCREEN_MCS5000 is not set
+# CONFIG_TOUCHSCREEN_MTOUCH is not set
+# CONFIG_TOUCHSCREEN_INEXIO is not set
+# CONFIG_TOUCHSCREEN_MK712 is not set
+# CONFIG_TOUCHSCREEN_PENMOUNT is not set
+# CONFIG_TOUCHSCREEN_TOUCHRIGHT is not set
+# CONFIG_TOUCHSCREEN_TOUCHWIN is not set
+# CONFIG_TOUCHSCREEN_USB_COMPOSITE is not set
+# CONFIG_TOUCHSCREEN_TOUCHIT213 is not set
+CONFIG_TOUCHSCREEN_TSC2007=y
+# CONFIG_TOUCHSCREEN_W90X900 is not set
 # CONFIG_INPUT_MISC is not set
 
 #
@@ -802,10 +863,10 @@
 CONFIG_SERIAL_SH_SCI_CONSOLE=y
 CONFIG_SERIAL_CORE=y
 CONFIG_SERIAL_CORE_CONSOLE=y
+# CONFIG_SERIAL_TIMBERDALE is not set
 CONFIG_UNIX98_PTYS=y
 # CONFIG_DEVPTS_MULTIPLE_INSTANCES is not set
-CONFIG_LEGACY_PTYS=y
-CONFIG_LEGACY_PTY_COUNT=256
+# CONFIG_LEGACY_PTYS is not set
 # CONFIG_IPMI_HANDLER is not set
 CONFIG_HW_RANDOM=y
 # CONFIG_HW_RANDOM_TIMERIOMEM is not set
@@ -830,6 +891,7 @@
 # CONFIG_I2C_OCORES is not set
 CONFIG_I2C_SH_MOBILE=y
 # CONFIG_I2C_SIMTEC is not set
+# CONFIG_I2C_XILINX is not set
 
 #
 # External I2C/SMBus adapter drivers
@@ -843,15 +905,9 @@
 #
 # CONFIG_I2C_PCA_PLATFORM is not set
 # CONFIG_I2C_STUB is not set
-
-#
-# Miscellaneous I2C Chip support
-#
-# CONFIG_SENSORS_TSL2550 is not set
 # CONFIG_I2C_DEBUG_CORE is not set
 # CONFIG_I2C_DEBUG_ALGO is not set
 # CONFIG_I2C_DEBUG_BUS is not set
-# CONFIG_I2C_DEBUG_CHIP is not set
 CONFIG_SPI=y
 CONFIG_SPI_MASTER=y
 
@@ -882,13 +938,16 @@
 #
 # Memory mapped GPIO expanders:
 #
+# CONFIG_GPIO_IT8761E is not set
 
 #
 # I2C GPIO expanders:
 #
+# CONFIG_GPIO_MAX7300 is not set
 # CONFIG_GPIO_MAX732X is not set
 # CONFIG_GPIO_PCA953X is not set
 # CONFIG_GPIO_PCF857X is not set
+# CONFIG_GPIO_ADP5588 is not set
 
 #
 # PCI GPIO expanders:
@@ -919,23 +978,26 @@
 #
 # Multifunction device drivers
 #
-# CONFIG_MFD_CORE is not set
+CONFIG_MFD_CORE=y
+# CONFIG_MFD_88PM860X is not set
 # CONFIG_MFD_SM501 is not set
-# CONFIG_MFD_SH_MOBILE_SDHI is not set
+CONFIG_MFD_SH_MOBILE_SDHI=y
 # CONFIG_HTC_PASIC3 is not set
+# CONFIG_HTC_I2CPLD is not set
 # CONFIG_TPS65010 is not set
 # CONFIG_TWL4030_CORE is not set
 # CONFIG_MFD_TMIO is not set
 # CONFIG_PMIC_DA903X is not set
 # CONFIG_PMIC_ADP5520 is not set
+# CONFIG_MFD_MAX8925 is not set
 # CONFIG_MFD_WM8400 is not set
 # CONFIG_MFD_WM831X is not set
 # CONFIG_MFD_WM8350_I2C is not set
+# CONFIG_MFD_WM8994 is not set
 # CONFIG_MFD_PCF50633 is not set
 # CONFIG_MFD_MC13783 is not set
 # CONFIG_AB3100_CORE is not set
 # CONFIG_EZX_PCAP is not set
-# CONFIG_MFD_88PM8607 is not set
 # CONFIG_AB4500_CORE is not set
 # CONFIG_REGULATOR is not set
 CONFIG_MEDIA_SUPPORT=y
@@ -985,10 +1047,10 @@
 # CONFIG_SOC_CAMERA_MT9M001 is not set
 # CONFIG_SOC_CAMERA_MT9M111 is not set
 # CONFIG_SOC_CAMERA_MT9T031 is not set
-# CONFIG_SOC_CAMERA_MT9T112 is not set
+CONFIG_SOC_CAMERA_MT9T112=y
 # CONFIG_SOC_CAMERA_MT9V022 is not set
 # CONFIG_SOC_CAMERA_RJ54N1 is not set
-# CONFIG_SOC_CAMERA_TW9910 is not set
+CONFIG_SOC_CAMERA_TW9910=y
 # CONFIG_SOC_CAMERA_PLATFORM is not set
 # CONFIG_SOC_CAMERA_OV772X is not set
 # CONFIG_SOC_CAMERA_OV9640 is not set
@@ -1001,6 +1063,7 @@
 # CONFIG_RADIO_SI470X is not set
 # CONFIG_USB_MR800 is not set
 # CONFIG_RADIO_TEA5764 is not set
+# CONFIG_RADIO_SAA7706H is not set
 # CONFIG_RADIO_TEF6862 is not set
 # CONFIG_DAB is not set
 
@@ -1034,6 +1097,7 @@
 #
 # CONFIG_FB_S1D13XXX is not set
 CONFIG_FB_SH_MOBILE_LCDC=y
+# CONFIG_FB_TMIO is not set
 # CONFIG_FB_VIRTUAL is not set
 # CONFIG_FB_METRONOME is not set
 # CONFIG_FB_MB862XX is not set
@@ -1062,7 +1126,46 @@
 # CONFIG_LOGO_SUPERH_MONO is not set
 # CONFIG_LOGO_SUPERH_VGA16 is not set
 CONFIG_LOGO_SUPERH_CLUT224=y
-# CONFIG_SOUND is not set
+CONFIG_SOUND=y
+CONFIG_SOUND_OSS_CORE=y
+CONFIG_SOUND_OSS_CORE_PRECLAIM=y
+CONFIG_SND=y
+CONFIG_SND_TIMER=y
+CONFIG_SND_PCM=y
+CONFIG_SND_JACK=y
+CONFIG_SND_SEQUENCER=y
+CONFIG_SND_SEQ_DUMMY=y
+CONFIG_SND_OSSEMUL=y
+CONFIG_SND_MIXER_OSS=y
+CONFIG_SND_PCM_OSS=y
+CONFIG_SND_PCM_OSS_PLUGINS=y
+# CONFIG_SND_SEQUENCER_OSS is not set
+# CONFIG_SND_DYNAMIC_MINORS is not set
+CONFIG_SND_SUPPORT_OLD_API=y
+CONFIG_SND_VERBOSE_PROCFS=y
+# CONFIG_SND_VERBOSE_PRINTK is not set
+# CONFIG_SND_DEBUG is not set
+# CONFIG_SND_RAWMIDI_SEQ is not set
+# CONFIG_SND_OPL3_LIB_SEQ is not set
+# CONFIG_SND_OPL4_LIB_SEQ is not set
+# CONFIG_SND_SBAWE_SEQ is not set
+# CONFIG_SND_EMU10K1_SEQ is not set
+# CONFIG_SND_DRIVERS is not set
+# CONFIG_SND_SPI is not set
+CONFIG_SND_SUPERH=y
+# CONFIG_SND_USB is not set
+CONFIG_SND_SOC=y
+
+#
+# SoC Audio support for SuperH
+#
+CONFIG_SND_SOC_SH4_FSI=y
+# CONFIG_SND_FSI_AK4642 is not set
+CONFIG_SND_FSI_DA7210=y
+CONFIG_SND_SOC_I2C_AND_SPI=y
+# CONFIG_SND_SOC_ALL_CODECS is not set
+CONFIG_SND_SOC_DA7210=y
+# CONFIG_SOUND_PRIME is not set
 CONFIG_HID_SUPPORT=y
 CONFIG_HID=y
 # CONFIG_HIDRAW is not set
@@ -1077,6 +1180,7 @@
 #
 # Special HID drivers
 #
+# CONFIG_HID_3M_PCT is not set
 # CONFIG_HID_A4TECH is not set
 # CONFIG_HID_APPLE is not set
 # CONFIG_HID_BELKIN is not set
@@ -1091,12 +1195,16 @@
 # CONFIG_HID_KENSINGTON is not set
 # CONFIG_HID_LOGITECH is not set
 # CONFIG_HID_MICROSOFT is not set
+# CONFIG_HID_MOSART is not set
 # CONFIG_HID_MONTEREY is not set
 # CONFIG_HID_NTRIG is not set
+# CONFIG_HID_ORTEK is not set
 # CONFIG_HID_PANTHERLORD is not set
 # CONFIG_HID_PETALYNX is not set
+# CONFIG_HID_QUANTA is not set
 # CONFIG_HID_SAMSUNG is not set
 # CONFIG_HID_SONY is not set
+# CONFIG_HID_STANTUM is not set
 # CONFIG_HID_SUNPLUS is not set
 # CONFIG_HID_GREENASIA is not set
 # CONFIG_HID_SMARTJOYPLUS is not set
@@ -1136,6 +1244,7 @@
 # CONFIG_USB_SL811_HCD is not set
 CONFIG_USB_R8A66597_HCD=y
 # CONFIG_USB_HWA_HCD is not set
+# CONFIG_USB_GADGET_MUSB_HDRC is not set
 
 #
 # USB Device Class drivers
@@ -1188,7 +1297,6 @@
 # CONFIG_USB_RIO500 is not set
 # CONFIG_USB_LEGOTOWER is not set
 # CONFIG_USB_LCD is not set
-# CONFIG_USB_BERRY_CHARGE is not set
 # CONFIG_USB_LED is not set
 # CONFIG_USB_CYPRESS_CY7C63 is not set
 # CONFIG_USB_CYTHERM is not set
@@ -1200,8 +1308,45 @@
 # CONFIG_USB_IOWARRIOR is not set
 # CONFIG_USB_TEST is not set
 # CONFIG_USB_ISIGHTFW is not set
-# CONFIG_USB_VST is not set
-# CONFIG_USB_GADGET is not set
+CONFIG_USB_GADGET=y
+# CONFIG_USB_GADGET_DEBUG_FILES is not set
+# CONFIG_USB_GADGET_DEBUG_FS is not set
+CONFIG_USB_GADGET_VBUS_DRAW=2
+CONFIG_USB_GADGET_SELECTED=y
+# CONFIG_USB_GADGET_AT91 is not set
+# CONFIG_USB_GADGET_ATMEL_USBA is not set
+# CONFIG_USB_GADGET_FSL_USB2 is not set
+# CONFIG_USB_GADGET_LH7A40X is not set
+# CONFIG_USB_GADGET_OMAP is not set
+# CONFIG_USB_GADGET_PXA25X is not set
+CONFIG_USB_GADGET_R8A66597=y
+CONFIG_USB_R8A66597=y
+# CONFIG_USB_GADGET_PXA27X is not set
+# CONFIG_USB_GADGET_S3C_HSOTG is not set
+# CONFIG_USB_GADGET_IMX is not set
+# CONFIG_USB_GADGET_S3C2410 is not set
+# CONFIG_USB_GADGET_M66592 is not set
+# CONFIG_USB_GADGET_AMD5536UDC is not set
+# CONFIG_USB_GADGET_FSL_QE is not set
+# CONFIG_USB_GADGET_CI13XXX is not set
+# CONFIG_USB_GADGET_NET2280 is not set
+# CONFIG_USB_GADGET_GOKU is not set
+# CONFIG_USB_GADGET_LANGWELL is not set
+# CONFIG_USB_GADGET_DUMMY_HCD is not set
+CONFIG_USB_GADGET_DUALSPEED=y
+# CONFIG_USB_ZERO is not set
+# CONFIG_USB_AUDIO is not set
+# CONFIG_USB_ETH is not set
+# CONFIG_USB_GADGETFS is not set
+CONFIG_USB_FILE_STORAGE=m
+# CONFIG_USB_FILE_STORAGE_TEST is not set
+# CONFIG_USB_MASS_STORAGE is not set
+# CONFIG_USB_G_SERIAL is not set
+# CONFIG_USB_MIDI_GADGET is not set
+# CONFIG_USB_G_PRINTER is not set
+# CONFIG_USB_CDC_COMPOSITE is not set
+# CONFIG_USB_G_NOKIA is not set
+# CONFIG_USB_G_MULTI is not set
 
 #
 # OTG and related infrastructure
@@ -1224,10 +1369,8 @@
 # MMC/SD/SDIO Host Controller Drivers
 #
 # CONFIG_MMC_SDHCI is not set
-# CONFIG_MMC_AT91 is not set
-# CONFIG_MMC_ATMELMCI is not set
 CONFIG_MMC_SPI=y
-# CONFIG_MMC_TMIO is not set
+CONFIG_MMC_TMIO=y
 # CONFIG_MEMSTICK is not set
 # CONFIG_NEW_LEDS is not set
 # CONFIG_ACCESSIBILITY is not set
@@ -1253,10 +1396,10 @@
 # CONFIG_RTC_DRV_DS1374 is not set
 # CONFIG_RTC_DRV_DS1672 is not set
 # CONFIG_RTC_DRV_MAX6900 is not set
-# CONFIG_RTC_DRV_RS5C372 is not set
+CONFIG_RTC_DRV_RS5C372=y
 # CONFIG_RTC_DRV_ISL1208 is not set
 # CONFIG_RTC_DRV_X1205 is not set
-CONFIG_RTC_DRV_PCF8563=y
+# CONFIG_RTC_DRV_PCF8563 is not set
 # CONFIG_RTC_DRV_PCF8583 is not set
 # CONFIG_RTC_DRV_M41T80 is not set
 # CONFIG_RTC_DRV_BQ32K is not set
@@ -1303,8 +1446,6 @@
 CONFIG_UIO=y
 # CONFIG_UIO_PDRV is not set
 CONFIG_UIO_PDRV_GENIRQ=y
-# CONFIG_UIO_SMX is not set
-# CONFIG_UIO_SERCOS3 is not set
 
 #
 # TI VLYNQ
@@ -1390,6 +1531,7 @@
 # CONFIG_EFS_FS is not set
 # CONFIG_JFFS2_FS is not set
 # CONFIG_UBIFS_FS is not set
+# CONFIG_LOGFS is not set
 # CONFIG_CRAMFS is not set
 # CONFIG_SQUASHFS is not set
 # CONFIG_VXFS_FS is not set
@@ -1418,6 +1560,7 @@
 # CONFIG_RPCSEC_GSS_KRB5 is not set
 # CONFIG_RPCSEC_GSS_SPKM3 is not set
 # CONFIG_SMB_FS is not set
+# CONFIG_CEPH_FS is not set
 # CONFIG_CIFS is not set
 # CONFIG_NCP_FS is not set
 # CONFIG_CODA_FS is not set
@@ -1487,6 +1630,7 @@
 CONFIG_DEBUG_BUGVERBOSE=y
 # CONFIG_DEBUG_MEMORY_INIT is not set
 # CONFIG_RCU_CPU_STALL_DETECTOR is not set
+# CONFIG_LKDTM is not set
 # CONFIG_LATENCYTOP is not set
 CONFIG_SYSCTL_SYSCALL_CHECK=y
 CONFIG_HAVE_FUNCTION_TRACER=y
@@ -1618,7 +1762,7 @@
 #
 CONFIG_BITREVERSE=y
 CONFIG_GENERIC_FIND_LAST_BIT=y
-# CONFIG_CRC_CCITT is not set
+CONFIG_CRC_CCITT=y
 # CONFIG_CRC16 is not set
 CONFIG_CRC_T10DIF=y
 CONFIG_CRC_ITU_T=y
diff -urN linux-2.6.34-rc3/arch/sh/drivers/dma/dma-api.c linux-2.6.34-rc4/arch/sh/drivers/dma/dma-api.c
--- linux-2.6.34-rc3/arch/sh/drivers/dma/dma-api.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/drivers/dma/dma-api.c	2010-04-13 02:19:00.584633048 +0000
@@ -17,6 +17,7 @@
 #include <linux/platform_device.h>
 #include <linux/mm.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/dma.h>
 
 DEFINE_SPINLOCK(dma_spin_lock);
diff -urN linux-2.6.34-rc3/arch/sh/drivers/dma/dmabrg.c linux-2.6.34-rc4/arch/sh/drivers/dma/dmabrg.c
--- linux-2.6.34-rc3/arch/sh/drivers/dma/dmabrg.c	2010-04-13 02:18:55.501633062 +0000
+++ linux-2.6.34-rc4/arch/sh/drivers/dma/dmabrg.c	2010-04-13 02:19:00.585633045 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/interrupt.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <asm/dma.h>
 #include <asm/dmabrg.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/sh/drivers/heartbeat.c linux-2.6.34-rc4/arch/sh/drivers/heartbeat.c
--- linux-2.6.34-rc3/arch/sh/drivers/heartbeat.c	2010-04-13 02:18:55.501633062 +0000
+++ linux-2.6.34-rc4/arch/sh/drivers/heartbeat.c	2010-04-13 02:19:00.585633045 +0000
@@ -24,6 +24,7 @@
 #include <linux/sched.h>
 #include <linux/timer.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/heartbeat.h>
 
 #define DRV_NAME "heartbeat"
diff -urN linux-2.6.34-rc3/arch/sh/drivers/pci/pcie-sh7786.c linux-2.6.34-rc4/arch/sh/drivers/pci/pcie-sh7786.c
--- linux-2.6.34-rc3/arch/sh/drivers/pci/pcie-sh7786.c	2010-04-13 02:18:55.503633034 +0000
+++ linux-2.6.34-rc4/arch/sh/drivers/pci/pcie-sh7786.c	2010-04-13 02:19:00.587633029 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/io.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "pcie-sh7786.h"
 #include <asm/sizes.h>
 
diff -urN linux-2.6.34-rc3/arch/sh/drivers/push-switch.c linux-2.6.34-rc4/arch/sh/drivers/push-switch.c
--- linux-2.6.34-rc3/arch/sh/drivers/push-switch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/drivers/push-switch.c	2010-04-13 02:19:00.587633029 +0000
@@ -8,6 +8,7 @@
  * for more details.
  */
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/arch/sh/include/asm/elf.h linux-2.6.34-rc4/arch/sh/include/asm/elf.h
--- linux-2.6.34-rc3/arch/sh/include/asm/elf.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/include/asm/elf.h	2010-04-13 02:19:00.589570465 +0000
@@ -211,7 +211,9 @@
 
 #define VSYSCALL_AUX_ENT					\
 	if (vdso_enabled)					\
-		NEW_AUX_ENT(AT_SYSINFO_EHDR, VDSO_BASE);
+		NEW_AUX_ENT(AT_SYSINFO_EHDR, VDSO_BASE);	\
+	else							\
+		NEW_AUX_ENT(AT_IGNORE, 0);
 #else
 #define VSYSCALL_AUX_ENT
 #endif /* CONFIG_VSYSCALL */
@@ -219,7 +221,7 @@
 #ifdef CONFIG_SH_FPU
 #define FPU_AUX_ENT	NEW_AUX_ENT(AT_FPUCW, FPSCR_INIT)
 #else
-#define FPU_AUX_ENT
+#define FPU_AUX_ENT	NEW_AUX_ENT(AT_IGNORE, 0)
 #endif
 
 extern int l1i_cache_shape, l1d_cache_shape, l2_cache_shape;
diff -urN linux-2.6.34-rc3/arch/sh/include/cpu-sh4/cpu/mmu_context.h linux-2.6.34-rc4/arch/sh/include/cpu-sh4/cpu/mmu_context.h
--- linux-2.6.34-rc3/arch/sh/include/cpu-sh4/cpu/mmu_context.h	2010-04-13 02:18:55.511633074 +0000
+++ linux-2.6.34-rc4/arch/sh/include/cpu-sh4/cpu/mmu_context.h	2010-04-13 02:19:00.594570217 +0000
@@ -30,6 +30,8 @@
 #define MMUCR_URB		0x00FC0000
 #define MMUCR_URB_SHIFT		18
 #define MMUCR_URB_NENTRIES	64
+#define MMUCR_URC		0x0000FC00
+#define MMUCR_URC_SHIFT		10
 
 #if defined(CONFIG_32BIT) && defined(CONFIG_CPU_SUBTYPE_ST40)
 #define MMUCR_SE		(1 << 4)
diff -urN linux-2.6.34-rc3/arch/sh/kernel/cpu/fpu.c linux-2.6.34-rc4/arch/sh/kernel/cpu/fpu.c
--- linux-2.6.34-rc3/arch/sh/kernel/cpu/fpu.c	2010-04-13 02:18:55.512633044 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/cpu/fpu.c	2010-04-13 02:19:00.596633138 +0000
@@ -1,4 +1,5 @@
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/processor.h>
 #include <asm/fpu.h>
 
diff -urN linux-2.6.34-rc3/arch/sh/kernel/cpu/hwblk.c linux-2.6.34-rc4/arch/sh/kernel/cpu/hwblk.c
--- linux-2.6.34-rc3/arch/sh/kernel/cpu/hwblk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/cpu/hwblk.c	2010-04-13 02:19:00.596633138 +0000
@@ -1,6 +1,5 @@
 #include <linux/clk.h>
 #include <linux/compiler.h>
-#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/spinlock.h>
 #include <asm/suspend.h>
diff -urN linux-2.6.34-rc3/arch/sh/kernel/cpufreq.c linux-2.6.34-rc4/arch/sh/kernel/cpufreq.c
--- linux-2.6.34-rc3/arch/sh/kernel/cpufreq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/cpufreq.c	2010-04-13 02:19:00.603633076 +0000
@@ -48,7 +48,7 @@
 		return -ENODEV;
 
 	cpus_allowed = current->cpus_allowed;
-	set_cpus_allowed(current, cpumask_of_cpu(cpu));
+	set_cpus_allowed_ptr(current, cpumask_of(cpu));
 
 	BUG_ON(smp_processor_id() != cpu);
 
@@ -66,7 +66,7 @@
 	freqs.flags	= 0;
 
 	cpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);
-	set_cpus_allowed(current, cpus_allowed);
+	set_cpus_allowed_ptr(current, &cpus_allowed);
 	clk_set_rate(cpuclk, freq);
 	cpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);
 
diff -urN linux-2.6.34-rc3/arch/sh/kernel/dwarf.c linux-2.6.34-rc4/arch/sh/kernel/dwarf.c
--- linux-2.6.34-rc3/arch/sh/kernel/dwarf.c	2010-04-13 02:18:55.520570772 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/dwarf.c	2010-04-13 02:19:00.604633073 +0000
@@ -22,6 +22,7 @@
 #include <linux/mm.h>
 #include <linux/elf.h>
 #include <linux/ftrace.h>
+#include <linux/slab.h>
 #include <asm/dwarf.h>
 #include <asm/unwinder.h>
 #include <asm/sections.h>
diff -urN linux-2.6.34-rc3/arch/sh/kernel/kprobes.c linux-2.6.34-rc4/arch/sh/kernel/kprobes.c
--- linux-2.6.34-rc3/arch/sh/kernel/kprobes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/kprobes.c	2010-04-13 02:19:00.606633042 +0000
@@ -13,6 +13,7 @@
 #include <linux/ptrace.h>
 #include <linux/preempt.h>
 #include <linux/kdebug.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/arch/sh/kernel/process.c linux-2.6.34-rc4/arch/sh/kernel/process.c
--- linux-2.6.34-rc3/arch/sh/kernel/process.c	2010-04-13 02:18:55.522633095 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/process.c	2010-04-13 02:19:00.606633042 +0000
@@ -1,5 +1,6 @@
 #include <linux/mm.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 struct kmem_cache *task_xstate_cachep = NULL;
diff -urN linux-2.6.34-rc3/arch/sh/kernel/process_32.c linux-2.6.34-rc4/arch/sh/kernel/process_32.c
--- linux-2.6.34-rc3/arch/sh/kernel/process_32.c	2010-04-13 02:18:55.523633047 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/process_32.c	2010-04-13 02:19:00.606633042 +0000
@@ -15,6 +15,7 @@
  */
 #include <linux/module.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/elfcore.h>
 #include <linux/kallsyms.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/sh/kernel/process_64.c linux-2.6.34-rc4/arch/sh/kernel/process_64.c
--- linux-2.6.34-rc3/arch/sh/kernel/process_64.c	2010-04-13 02:18:55.523633047 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/process_64.c	2010-04-13 02:19:00.606633042 +0000
@@ -21,6 +21,7 @@
 #include <linux/fs.h>
 #include <linux/ptrace.h>
 #include <linux/reboot.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/sh/kernel/ptrace_32.c linux-2.6.34-rc4/arch/sh/kernel/ptrace_32.c
--- linux-2.6.34-rc3/arch/sh/kernel/ptrace_32.c	2010-04-13 02:18:55.523633047 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/ptrace_32.c	2010-04-13 02:19:00.607633045 +0000
@@ -17,7 +17,6 @@
 #include <linux/errno.h>
 #include <linux/ptrace.h>
 #include <linux/user.h>
-#include <linux/slab.h>
 #include <linux/security.h>
 #include <linux/signal.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/sh/kernel/return_address.c linux-2.6.34-rc4/arch/sh/kernel/return_address.c
--- linux-2.6.34-rc3/arch/sh/kernel/return_address.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/return_address.c	2010-04-13 02:19:00.607633045 +0000
@@ -9,6 +9,7 @@
  * for more details.
  */
 #include <linux/kernel.h>
+#include <linux/module.h>
 #include <asm/dwarf.h>
 
 #ifdef CONFIG_DWARF_UNWINDER
@@ -52,3 +53,5 @@
 }
 
 #endif
+
+EXPORT_SYMBOL_GPL(return_address);
diff -urN linux-2.6.34-rc3/arch/sh/kernel/smp.c linux-2.6.34-rc4/arch/sh/kernel/smp.c
--- linux-2.6.34-rc3/arch/sh/kernel/smp.c	2010-04-13 02:18:55.524633083 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/smp.c	2010-04-13 02:19:00.608633048 +0000
@@ -69,6 +69,7 @@
 	unsigned int cpu;
 	struct mm_struct *mm = &init_mm;
 
+	enable_mmu();
 	atomic_inc(&mm->mm_count);
 	atomic_inc(&mm->mm_users);
 	current->active_mm = mm;
diff -urN linux-2.6.34-rc3/arch/sh/kernel/vsyscall/vsyscall.c linux-2.6.34-rc4/arch/sh/kernel/vsyscall/vsyscall.c
--- linux-2.6.34-rc3/arch/sh/kernel/vsyscall/vsyscall.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/kernel/vsyscall/vsyscall.c	2010-04-13 02:19:00.608633048 +0000
@@ -11,7 +11,6 @@
  * for more details.
  */
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/gfp.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/consistent.c linux-2.6.34-rc4/arch/sh/mm/consistent.c
--- linux-2.6.34-rc3/arch/sh/mm/consistent.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/consistent.c	2010-04-13 02:19:00.610633029 +0000
@@ -16,6 +16,7 @@
 #include <linux/dma-debug.h>
 #include <linux/io.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <asm/cacheflush.h>
 #include <asm/addrspace.h>
 
diff -urN linux-2.6.34-rc3/arch/sh/mm/hugetlbpage.c linux-2.6.34-rc4/arch/sh/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/sh/mm/hugetlbpage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/hugetlbpage.c	2010-04-13 02:19:00.610633029 +0000
@@ -13,7 +13,6 @@
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
-#include <linux/slab.h>
 #include <linux/sysctl.h>
 
 #include <asm/mman.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/init.c linux-2.6.34-rc4/arch/sh/mm/init.c
--- linux-2.6.34-rc3/arch/sh/mm/init.c	2010-04-13 02:18:55.526633085 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/init.c	2010-04-13 02:19:00.610633029 +0000
@@ -10,6 +10,7 @@
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/bootmem.h>
 #include <linux/proc_fs.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/ioremap.c linux-2.6.34-rc4/arch/sh/mm/ioremap.c
--- linux-2.6.34-rc3/arch/sh/mm/ioremap.c	2010-04-13 02:18:55.527633046 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/ioremap.c	2010-04-13 02:19:00.610633029 +0000
@@ -14,6 +14,7 @@
  */
 #include <linux/vmalloc.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/pci.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/ioremap_fixed.c linux-2.6.34-rc4/arch/sh/mm/ioremap_fixed.c
--- linux-2.6.34-rc3/arch/sh/mm/ioremap_fixed.c	2010-04-13 02:18:55.528633073 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/ioremap_fixed.c	2010-04-13 02:19:00.611633131 +0000
@@ -15,7 +15,6 @@
 #include <linux/io.h>
 #include <linux/bootmem.h>
 #include <linux/proc_fs.h>
-#include <linux/slab.h>
 #include <asm/fixmap.h>
 #include <asm/page.h>
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/pgtable.c linux-2.6.34-rc4/arch/sh/mm/pgtable.c
--- linux-2.6.34-rc3/arch/sh/mm/pgtable.c	2010-04-13 02:18:55.528633073 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/pgtable.c	2010-04-13 02:19:00.612633089 +0000
@@ -1,4 +1,5 @@
 #include <linux/mm.h>
+#include <linux/slab.h>
 
 #define PGALLOC_GFP GFP_KERNEL | __GFP_REPEAT | __GFP_ZERO
 
diff -urN linux-2.6.34-rc3/arch/sh/mm/pmb.c linux-2.6.34-rc4/arch/sh/mm/pmb.c
--- linux-2.6.34-rc3/arch/sh/mm/pmb.c	2010-04-13 02:18:55.528633073 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/pmb.c	2010-04-13 02:19:00.612633089 +0000
@@ -15,7 +15,6 @@
 #include <linux/sysdev.h>
 #include <linux/cpu.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/bitops.h>
 #include <linux/debugfs.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/sh/mm/tlb-pteaex.c linux-2.6.34-rc4/arch/sh/mm/tlb-pteaex.c
--- linux-2.6.34-rc3/arch/sh/mm/tlb-pteaex.c	2010-04-13 02:18:55.529571418 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/tlb-pteaex.c	2010-04-13 02:19:00.612633089 +0000
@@ -77,3 +77,31 @@
 	__raw_writel(asid, MMU_ITLB_ADDRESS_ARRAY2 | MMU_PAGE_ASSOC_BIT);
 	back_to_cached();
 }
+
+void local_flush_tlb_all(void)
+{
+	unsigned long flags, status;
+	int i;
+
+	/*
+	 * Flush all the TLB.
+	 */
+	local_irq_save(flags);
+	jump_to_uncached();
+
+	status = __raw_readl(MMUCR);
+	status = ((status & MMUCR_URB) >> MMUCR_URB_SHIFT);
+
+	if (status == 0)
+		status = MMUCR_URB_NENTRIES;
+
+	for (i = 0; i < status; i++)
+		__raw_writel(0x0, MMU_UTLB_ADDRESS_ARRAY | (i << 8));
+
+	for (i = 0; i < 4; i++)
+		__raw_writel(0x0, MMU_ITLB_ADDRESS_ARRAY | (i << 8));
+
+	back_to_cached();
+	ctrl_barrier();
+	local_irq_restore(flags);
+}
diff -urN linux-2.6.34-rc3/arch/sh/mm/tlb-sh3.c linux-2.6.34-rc4/arch/sh/mm/tlb-sh3.c
--- linux-2.6.34-rc3/arch/sh/mm/tlb-sh3.c	2010-04-13 02:18:55.529571418 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/tlb-sh3.c	2010-04-13 02:19:00.612633089 +0000
@@ -77,3 +77,22 @@
 	for (i = 0; i < ways; i++)
 		__raw_writel(data, addr + (i << 8));
 }
+
+void local_flush_tlb_all(void)
+{
+	unsigned long flags, status;
+
+	/*
+	 * Flush all the TLB.
+	 *
+	 * Write to the MMU control register's bit:
+	 *	TF-bit for SH-3, TI-bit for SH-4.
+	 *      It's same position, bit #2.
+	 */
+	local_irq_save(flags);
+	status = __raw_readl(MMUCR);
+	status |= 0x04;
+	__raw_writel(status, MMUCR);
+	ctrl_barrier();
+	local_irq_restore(flags);
+}
diff -urN linux-2.6.34-rc3/arch/sh/mm/tlb-sh4.c linux-2.6.34-rc4/arch/sh/mm/tlb-sh4.c
--- linux-2.6.34-rc3/arch/sh/mm/tlb-sh4.c	2010-04-13 02:18:55.529571418 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/tlb-sh4.c	2010-04-13 02:19:00.612633089 +0000
@@ -80,3 +80,31 @@
 	__raw_writel(data, addr);
 	back_to_cached();
 }
+
+void local_flush_tlb_all(void)
+{
+	unsigned long flags, status;
+	int i;
+
+	/*
+	 * Flush all the TLB.
+	 */
+	local_irq_save(flags);
+	jump_to_uncached();
+
+	status = __raw_readl(MMUCR);
+	status = ((status & MMUCR_URB) >> MMUCR_URB_SHIFT);
+
+	if (status == 0)
+		status = MMUCR_URB_NENTRIES;
+
+	for (i = 0; i < status; i++)
+		__raw_writel(0x0, MMU_UTLB_ADDRESS_ARRAY | (i << 8));
+
+	for (i = 0; i < 4; i++)
+		__raw_writel(0x0, MMU_ITLB_ADDRESS_ARRAY | (i << 8));
+
+	back_to_cached();
+	ctrl_barrier();
+	local_irq_restore(flags);
+}
diff -urN linux-2.6.34-rc3/arch/sh/mm/tlb-urb.c linux-2.6.34-rc4/arch/sh/mm/tlb-urb.c
--- linux-2.6.34-rc3/arch/sh/mm/tlb-urb.c	2010-04-13 02:18:55.529571418 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/tlb-urb.c	2010-04-13 02:19:00.613633035 +0000
@@ -24,13 +24,9 @@
 
 	local_irq_save(flags);
 
-	/* Load the entry into the TLB */
-	__update_tlb(vma, addr, pte);
-
-	/* ... and wire it up. */
 	status = __raw_readl(MMUCR);
 	urb = (status & MMUCR_URB) >> MMUCR_URB_SHIFT;
-	status &= ~MMUCR_URB;
+	status &= ~MMUCR_URC;
 
 	/*
 	 * Make sure we're not trying to wire the last TLB entry slot.
@@ -39,7 +35,23 @@
 
 	urb = urb % MMUCR_URB_NENTRIES;
 
+	/*
+	 * Insert this entry into the highest non-wired TLB slot (via
+	 * the URC field).
+	 */
+	status |= (urb << MMUCR_URC_SHIFT);
+	__raw_writel(status, MMUCR);
+	ctrl_barrier();
+
+	/* Load the entry into the TLB */
+	__update_tlb(vma, addr, pte);
+
+	/* ... and wire it up. */
+	status = __raw_readl(MMUCR);
+
+	status &= ~MMUCR_URB;
 	status |= (urb << MMUCR_URB_SHIFT);
+
 	__raw_writel(status, MMUCR);
 	ctrl_barrier();
 
diff -urN linux-2.6.34-rc3/arch/sh/mm/tlbflush_32.c linux-2.6.34-rc4/arch/sh/mm/tlbflush_32.c
--- linux-2.6.34-rc3/arch/sh/mm/tlbflush_32.c	2010-04-13 02:18:55.529571418 +0000
+++ linux-2.6.34-rc4/arch/sh/mm/tlbflush_32.c	2010-04-13 02:19:00.613633035 +0000
@@ -119,31 +119,3 @@
 		local_irq_restore(flags);
 	}
 }
-
-void local_flush_tlb_all(void)
-{
-	unsigned long flags, status;
-	int i;
-
-	/*
-	 * Flush all the TLB.
-	 */
-	local_irq_save(flags);
-	jump_to_uncached();
-
-	status = __raw_readl(MMUCR);
-	status = ((status & MMUCR_URB) >> MMUCR_URB_SHIFT);
-
-	if (status == 0)
-		status = MMUCR_URB_NENTRIES;
-
-	for (i = 0; i < status; i++)
-		__raw_writel(0x0, MMU_UTLB_ADDRESS_ARRAY | (i << 8));
-
-	for (i = 0; i < 4; i++)
-		__raw_writel(0x0, MMU_ITLB_ADDRESS_ARRAY | (i << 8));
-
-	back_to_cached();
-	ctrl_barrier();
-	local_irq_restore(flags);
-}
diff -urN linux-2.6.34-rc3/arch/sparc/configs/sparc64_defconfig linux-2.6.34-rc4/arch/sparc/configs/sparc64_defconfig
--- linux-2.6.34-rc3/arch/sparc/configs/sparc64_defconfig	2010-04-13 02:18:55.530570496 +0000
+++ linux-2.6.34-rc4/arch/sparc/configs/sparc64_defconfig	2010-04-13 02:19:00.614633043 +0000
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don't edit
-# Linux kernel version: 2.6.33
-# Wed Mar  3 02:54:29 2010
+# Linux kernel version: 2.6.34-rc3
+# Sat Apr  3 15:49:56 2010
 #
 CONFIG_64BIT=y
 CONFIG_SPARC=y
@@ -23,6 +23,7 @@
 CONFIG_NEED_PER_CPU_PAGE_FIRST_CHUNK=y
 CONFIG_GENERIC_HARDIRQS_NO__DO_IRQ=y
 CONFIG_MMU=y
+CONFIG_NEED_DMA_MAP_STATE=y
 CONFIG_ARCH_NO_VIRT_TO_BUS=y
 CONFIG_OF=y
 CONFIG_ARCH_SUPPORTS_DEBUG_PAGEALLOC=y
@@ -439,6 +440,7 @@
 # CONFIG_ENCLOSURE_SERVICES is not set
 # CONFIG_HP_ILO is not set
 # CONFIG_ISL29003 is not set
+# CONFIG_SENSORS_TSL2550 is not set
 # CONFIG_DS1682 is not set
 # CONFIG_C2PORT is not set
 
@@ -511,6 +513,7 @@
 #
 # SCSI device support
 #
+CONFIG_SCSI_MOD=y
 CONFIG_RAID_ATTRS=m
 CONFIG_SCSI=y
 CONFIG_SCSI_DMA=y
@@ -888,6 +891,7 @@
 CONFIG_SERIAL_CORE=y
 CONFIG_SERIAL_CORE_CONSOLE=y
 # CONFIG_SERIAL_JSM is not set
+# CONFIG_SERIAL_TIMBERDALE is not set
 # CONFIG_SERIAL_GRLIB_GAISLER_APBUART is not set
 CONFIG_UNIX98_PTYS=y
 # CONFIG_DEVPTS_MULTIPLE_INSTANCES is not set
@@ -935,6 +939,7 @@
 #
 # CONFIG_I2C_OCORES is not set
 # CONFIG_I2C_SIMTEC is not set
+# CONFIG_I2C_XILINX is not set
 
 #
 # External I2C/SMBus adapter drivers
@@ -948,15 +953,9 @@
 #
 # CONFIG_I2C_PCA_PLATFORM is not set
 # CONFIG_I2C_STUB is not set
-
-#
-# Miscellaneous I2C Chip support
-#
-# CONFIG_SENSORS_TSL2550 is not set
 # CONFIG_I2C_DEBUG_CORE is not set
 # CONFIG_I2C_DEBUG_ALGO is not set
 # CONFIG_I2C_DEBUG_BUS is not set
-# CONFIG_I2C_DEBUG_CHIP is not set
 # CONFIG_SPI is not set
 
 #
@@ -982,10 +981,11 @@
 # CONFIG_SENSORS_ADM1029 is not set
 # CONFIG_SENSORS_ADM1031 is not set
 # CONFIG_SENSORS_ADM9240 is not set
+# CONFIG_SENSORS_ADT7411 is not set
 # CONFIG_SENSORS_ADT7462 is not set
 # CONFIG_SENSORS_ADT7470 is not set
-# CONFIG_SENSORS_ADT7473 is not set
 # CONFIG_SENSORS_ADT7475 is not set
+# CONFIG_SENSORS_ASC7621 is not set
 # CONFIG_SENSORS_ATXP1 is not set
 # CONFIG_SENSORS_DS1621 is not set
 # CONFIG_SENSORS_I5K_AMB is not set
@@ -1052,18 +1052,21 @@
 # Multifunction device drivers
 #
 # CONFIG_MFD_CORE is not set
+# CONFIG_MFD_88PM860X is not set
 # CONFIG_MFD_SM501 is not set
 # CONFIG_HTC_PASIC3 is not set
 # CONFIG_TWL4030_CORE is not set
 # CONFIG_MFD_TMIO is not set
 # CONFIG_PMIC_DA903X is not set
 # CONFIG_PMIC_ADP5520 is not set
+# CONFIG_MFD_MAX8925 is not set
 # CONFIG_MFD_WM8400 is not set
 # CONFIG_MFD_WM831X is not set
 # CONFIG_MFD_WM8350_I2C is not set
+# CONFIG_MFD_WM8994 is not set
 # CONFIG_MFD_PCF50633 is not set
 # CONFIG_AB3100_CORE is not set
-# CONFIG_MFD_88PM8607 is not set
+# CONFIG_LPC_SCH is not set
 # CONFIG_REGULATOR is not set
 # CONFIG_MEDIA_SUPPORT is not set
 
@@ -1113,6 +1116,7 @@
 # CONFIG_FB_LEO is not set
 CONFIG_FB_XVR500=y
 CONFIG_FB_XVR2500=y
+CONFIG_FB_XVR1000=y
 # CONFIG_FB_S1D13XXX is not set
 # CONFIG_FB_NVIDIA is not set
 # CONFIG_FB_RIVA is not set
@@ -1430,7 +1434,6 @@
 # CONFIG_USB_RIO500 is not set
 # CONFIG_USB_LEGOTOWER is not set
 # CONFIG_USB_LCD is not set
-# CONFIG_USB_BERRY_CHARGE is not set
 # CONFIG_USB_LED is not set
 # CONFIG_USB_CYPRESS_CY7C63 is not set
 # CONFIG_USB_CYTHERM is not set
@@ -1443,7 +1446,6 @@
 # CONFIG_USB_IOWARRIOR is not set
 # CONFIG_USB_TEST is not set
 # CONFIG_USB_ISIGHTFW is not set
-# CONFIG_USB_VST is not set
 # CONFIG_USB_GADGET is not set
 
 #
@@ -1610,6 +1612,7 @@
 # CONFIG_BEFS_FS is not set
 # CONFIG_BFS_FS is not set
 # CONFIG_EFS_FS is not set
+# CONFIG_LOGFS is not set
 # CONFIG_CRAMFS is not set
 # CONFIG_SQUASHFS is not set
 # CONFIG_VXFS_FS is not set
@@ -1624,6 +1627,7 @@
 # CONFIG_NFS_FS is not set
 # CONFIG_NFSD is not set
 # CONFIG_SMB_FS is not set
+# CONFIG_CEPH_FS is not set
 # CONFIG_CIFS is not set
 # CONFIG_NCP_FS is not set
 # CONFIG_CODA_FS is not set
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/central.c linux-2.6.34-rc4/arch/sparc/kernel/central.c
--- linux-2.6.34-rc3/arch/sparc/kernel/central.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/central.c	2010-04-13 02:19:00.616633019 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/cpumap.c linux-2.6.34-rc4/arch/sparc/kernel/cpumap.c
--- linux-2.6.34-rc3/arch/sparc/kernel/cpumap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/cpumap.c	2010-04-13 02:19:00.616633019 +0000
@@ -4,6 +4,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/cpumask.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/helpers.S linux-2.6.34-rc4/arch/sparc/kernel/helpers.S
--- linux-2.6.34-rc3/arch/sparc/kernel/helpers.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/helpers.S	2010-04-13 02:19:00.616633019 +0000
@@ -46,6 +46,81 @@
 	 nop
 	.size		stack_trace_flush,.-stack_trace_flush
 
+#ifdef CONFIG_PERF_EVENTS
+	.globl		perf_arch_fetch_caller_regs
+	.type		perf_arch_fetch_caller_regs,#function
+perf_arch_fetch_caller_regs:
+	/* We always read the %pstate into %o5 since we will use
+	 * that to construct a fake %tstate to store into the regs.
+	 */
+	rdpr		%pstate, %o5
+	brz,pn		%o2, 50f
+	 mov		%o2, %g7
+
+	/* Turn off interrupts while we walk around the register
+	 * window by hand.
+	 */
+	wrpr		%o5, PSTATE_IE, %pstate
+
+	/* The %canrestore tells us how many register windows are
+	 * still live in the chip above us, past that we have to
+	 * walk the frame as saved on the stack.   We stash away
+	 * the %cwp in %g1 so we can return back to the original
+	 * register window.
+	 */
+	rdpr		%cwp, %g1
+	rdpr		%canrestore, %g2
+	sub		%g1, 1, %g3
+
+	/* We have the skip count in %g7, if it hits zero then
+	 * %fp/%i7 are the registers we need.  Otherwise if our
+	 * %canrestore count maintained in %g2 hits zero we have
+	 * to start traversing the stack.
+	 */
+10:	brz,pn		%g2, 4f
+	 sub		%g2, 1, %g2
+	wrpr		%g3, %cwp
+	subcc		%g7, 1, %g7
+	bne,pt		%xcc, 10b
+	 sub		%g3, 1, %g3
+
+	/* We found the values we need in the cpu's register
+	 * windows.
+	 */
+	mov		%fp, %g3
+	ba,pt		%xcc, 3f
+	 mov		%i7, %g2
+
+50:	mov		%fp, %g3
+	ba,pt		%xcc, 2f
+	 mov		%i7, %g2
+
+	/* We hit the end of the valid register windows in the
+	 * cpu, start traversing the stack frame.
+	 */
+4:	mov		%fp, %g3
+
+20:	ldx		[%g3 + STACK_BIAS + RW_V9_I7], %g2
+	subcc		%g7, 1, %g7
+	bne,pn		%xcc, 20b
+	 ldx		[%g3 + STACK_BIAS + RW_V9_I6], %g3
+
+	/* Restore the current register window position and
+	 * re-enable interrupts.
+	 */
+3:	wrpr		%g1, %cwp
+	wrpr		%o5, %pstate
+
+2:	stx		%g3, [%o0 + PT_V9_FP]
+	sllx		%o5, 8, %o5
+	stx		%o5, [%o0 + PT_V9_TSTATE]
+	stx		%g2, [%o0 + PT_V9_TPC]
+	add		%g2, 4, %g2
+	retl
+	 stx		%g2, [%o0 + PT_V9_TNPC]
+	.size		perf_arch_fetch_caller_regs,.-perf_arch_fetch_caller_regs
+#endif /* CONFIG_PERF_EVENTS */
+
 #ifdef CONFIG_SMP
 	.globl		hard_smp_processor_id
 	.type		hard_smp_processor_id,#function
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/hvapi.c linux-2.6.34-rc4/arch/sparc/kernel/hvapi.c
--- linux-2.6.34-rc3/arch/sparc/kernel/hvapi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/hvapi.c	2010-04-13 02:19:00.616633019 +0000
@@ -5,7 +5,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 
 #include <asm/hypervisor.h>
 #include <asm/oplib.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/iommu.c linux-2.6.34-rc4/arch/sparc/kernel/iommu.c
--- linux-2.6.34-rc3/arch/sparc/kernel/iommu.c	2010-04-13 02:18:55.532633048 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/iommu.c	2010-04-13 02:19:00.616633019 +0000
@@ -6,6 +6,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/kprobes.c linux-2.6.34-rc4/arch/sparc/kernel/kprobes.c
--- linux-2.6.34-rc3/arch/sparc/kernel/kprobes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/kprobes.c	2010-04-13 02:19:00.617633061 +0000
@@ -7,6 +7,7 @@
 #include <linux/kprobes.h>
 #include <linux/module.h>
 #include <linux/kdebug.h>
+#include <linux/slab.h>
 #include <asm/signal.h>
 #include <asm/cacheflush.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/led.c linux-2.6.34-rc4/arch/sparc/kernel/led.c
--- linux-2.6.34-rc3/arch/sparc/kernel/led.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/led.c	2010-04-13 02:19:00.617633061 +0000
@@ -3,6 +3,7 @@
 #include <linux/init.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/jiffies.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/leon_kernel.c linux-2.6.34-rc4/arch/sparc/kernel/leon_kernel.c
--- linux-2.6.34-rc3/arch/sparc/kernel/leon_kernel.c	2010-04-13 02:18:55.532633048 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/leon_kernel.c	2010-04-13 02:19:00.617633061 +0000
@@ -7,7 +7,6 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/mutex.h>
-#include <linux/slab.h>
 #include <linux/of.h>
 #include <linux/of_platform.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/leon_smp.c linux-2.6.34-rc4/arch/sparc/kernel/leon_smp.c
--- linux-2.6.34-rc3/arch/sparc/kernel/leon_smp.c	2010-04-13 02:18:55.532633048 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/leon_smp.c	2010-04-13 02:19:00.617633061 +0000
@@ -22,6 +22,7 @@
 #include <linux/profile.h>
 #include <linux/pm.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include <asm/cacheflush.h>
 #include <asm/tlbflush.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/module.c linux-2.6.34-rc4/arch/sparc/kernel/module.c
--- linux-2.6.34-rc3/arch/sparc/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/module.c	2010-04-13 02:19:00.617633061 +0000
@@ -9,9 +9,9 @@
 #include <linux/elf.h>
 #include <linux/vmalloc.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/string.h>
 #include <linux/ctype.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 
 #include <asm/processor.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/of_device_common.c linux-2.6.34-rc4/arch/sparc/kernel/of_device_common.c
--- linux-2.6.34-rc3/arch/sparc/kernel/of_device_common.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/of_device_common.c	2010-04-13 02:19:00.617633061 +0000
@@ -4,7 +4,6 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/mod_devicetable.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/irq.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/pci_msi.c linux-2.6.34-rc4/arch/sparc/kernel/pci_msi.c
--- linux-2.6.34-rc3/arch/sparc/kernel/pci_msi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/pci_msi.c	2010-04-13 02:19:00.618633027 +0000
@@ -4,6 +4,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/irq.h>
 
 #include "pci_impl.h"
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/process_32.c linux-2.6.34-rc4/arch/sparc/kernel/process_32.c
--- linux-2.6.34-rc3/arch/sparc/kernel/process_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/process_32.c	2010-04-13 02:19:00.618633027 +0000
@@ -17,13 +17,13 @@
 #include <linux/mm.h>
 #include <linux/stddef.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/smp.h>
 #include <linux/reboot.h>
 #include <linux/delay.h>
 #include <linux/pm.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <asm/auxio.h>
 #include <asm/oplib.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/ptrace_32.c linux-2.6.34-rc4/arch/sparc/kernel/ptrace_32.c
--- linux-2.6.34-rc3/arch/sparc/kernel/ptrace_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/ptrace_32.c	2010-04-13 02:19:00.619633153 +0000
@@ -65,6 +65,7 @@
 			*k++ = regs->u_regs[pos++];
 
 		reg_window = (unsigned long __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		for (; count > 0 && pos < 32; count--) {
 			if (get_user(*k++, &reg_window[pos++]))
 				return -EFAULT;
@@ -76,6 +77,7 @@
 		}
 
 		reg_window = (unsigned long __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		for (; count > 0 && pos < 32; count--) {
 			if (get_user(reg, &reg_window[pos++]) ||
 			    put_user(reg, u++))
@@ -141,6 +143,7 @@
 			regs->u_regs[pos++] = *k++;
 
 		reg_window = (unsigned long __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		for (; count > 0 && pos < 32; count--) {
 			if (put_user(*k++, &reg_window[pos++]))
 				return -EFAULT;
@@ -153,6 +156,7 @@
 		}
 
 		reg_window = (unsigned long __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		for (; count > 0 && pos < 32; count--) {
 			if (get_user(reg, u++) ||
 			    put_user(reg, &reg_window[pos++]))
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/ptrace_64.c linux-2.6.34-rc4/arch/sparc/kernel/ptrace_64.c
--- linux-2.6.34-rc3/arch/sparc/kernel/ptrace_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/ptrace_64.c	2010-04-13 02:19:00.619633153 +0000
@@ -492,6 +492,7 @@
 			*k++ = regs->u_regs[pos++];
 
 		reg_window = (compat_ulong_t __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		if (target == current) {
 			for (; count > 0 && pos < 32; count--) {
 				if (get_user(*k++, &reg_window[pos++]))
@@ -516,6 +517,7 @@
 		}
 
 		reg_window = (compat_ulong_t __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		if (target == current) {
 			for (; count > 0 && pos < 32; count--) {
 				if (get_user(reg, &reg_window[pos++]) ||
@@ -599,6 +601,7 @@
 			regs->u_regs[pos++] = *k++;
 
 		reg_window = (compat_ulong_t __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		if (target == current) {
 			for (; count > 0 && pos < 32; count--) {
 				if (put_user(*k++, &reg_window[pos++]))
@@ -625,6 +628,7 @@
 		}
 
 		reg_window = (compat_ulong_t __user *) regs->u_regs[UREG_I6];
+		reg_window -= 16;
 		if (target == current) {
 			for (; count > 0 && pos < 32; count--) {
 				if (get_user(reg, u++) ||
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/setup_64.c linux-2.6.34-rc4/arch/sparc/kernel/setup_64.c
--- linux-2.6.34-rc3/arch/sparc/kernel/setup_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/setup_64.c	2010-04-13 02:19:00.619633153 +0000
@@ -12,7 +12,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <asm/smp.h>
 #include <linux/user.h>
 #include <linux/screen_info.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/smp_64.c linux-2.6.34-rc4/arch/sparc/kernel/smp_64.c
--- linux-2.6.34-rc3/arch/sparc/kernel/smp_64.c	2010-04-13 02:18:55.534633023 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/smp_64.c	2010-04-13 02:19:00.620633075 +0000
@@ -23,6 +23,7 @@
 #include <linux/bootmem.h>
 #include <linux/vmalloc.h>
 #include <linux/cpu.h>
+#include <linux/slab.h>
 
 #include <asm/head.h>
 #include <asm/ptrace.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/sun4c_irq.c linux-2.6.34-rc4/arch/sparc/kernel/sun4c_irq.c
--- linux-2.6.34-rc3/arch/sparc/kernel/sun4c_irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/sun4c_irq.c	2010-04-13 02:19:00.620633075 +0000
@@ -16,7 +16,6 @@
 #include <linux/sched.h>
 #include <linux/ptrace.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/sun4m_irq.c linux-2.6.34-rc4/arch/sparc/kernel/sun4m_irq.c
--- linux-2.6.34-rc3/arch/sparc/kernel/sun4m_irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/sun4m_irq.c	2010-04-13 02:19:00.620633075 +0000
@@ -17,7 +17,6 @@
 #include <linux/ptrace.h>
 #include <linux/smp.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/of.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/sys_sparc32.c linux-2.6.34-rc4/arch/sparc/kernel/sys_sparc32.c
--- linux-2.6.34-rc3/arch/sparc/kernel/sys_sparc32.c	2010-04-13 02:18:55.535633071 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/sys_sparc32.c	2010-04-13 02:19:00.620633075 +0000
@@ -21,7 +21,6 @@
 #include <linux/sem.h>
 #include <linux/msg.h>
 #include <linux/shm.h>
-#include <linux/slab.h>
 #include <linux/uio.h>
 #include <linux/nfs_fs.h>
 #include <linux/quota.h>
@@ -44,6 +43,7 @@
 #include <linux/compat.h>
 #include <linux/vfs.h>
 #include <linux/ptrace.h>
+#include <linux/slab.h>
 
 #include <asm/types.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/traps_64.c linux-2.6.34-rc4/arch/sparc/kernel/traps_64.c
--- linux-2.6.34-rc3/arch/sparc/kernel/traps_64.c	2010-04-13 02:18:55.536633014 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/traps_64.c	2010-04-13 02:19:00.621633090 +0000
@@ -17,6 +17,7 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/kdebug.h>
+#include <linux/gfp.h>
 
 #include <asm/smp.h>
 #include <asm/delay.h>
diff -urN linux-2.6.34-rc3/arch/sparc/kernel/vio.c linux-2.6.34-rc4/arch/sparc/kernel/vio.c
--- linux-2.6.34-rc3/arch/sparc/kernel/vio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/kernel/vio.c	2010-04-13 02:19:00.622633047 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/irq.h>
 #include <linux/init.h>
 
diff -urN linux-2.6.34-rc3/arch/sparc/mm/hugetlbpage.c linux-2.6.34-rc4/arch/sparc/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/sparc/mm/hugetlbpage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/hugetlbpage.c	2010-04-13 02:19:00.622633047 +0000
@@ -10,7 +10,6 @@
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
-#include <linux/slab.h>
 #include <linux/sysctl.h>
 
 #include <asm/mman.h>
diff -urN linux-2.6.34-rc3/arch/sparc/mm/init_32.c linux-2.6.34-rc4/arch/sparc/mm/init_32.c
--- linux-2.6.34-rc3/arch/sparc/mm/init_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/init_32.c	2010-04-13 02:19:00.622633047 +0000
@@ -24,6 +24,7 @@
 #include <linux/bootmem.h>
 #include <linux/pagemap.h>
 #include <linux/poison.h>
+#include <linux/gfp.h>
 
 #include <asm/sections.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/arch/sparc/mm/init_64.c linux-2.6.34-rc4/arch/sparc/mm/init_64.c
--- linux-2.6.34-rc3/arch/sparc/mm/init_64.c	2010-04-13 02:18:55.537633056 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/init_64.c	2010-04-13 02:19:00.623633068 +0000
@@ -13,7 +13,6 @@
 #include <linux/bootmem.h>
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
-#include <linux/slab.h>
 #include <linux/initrd.h>
 #include <linux/swap.h>
 #include <linux/pagemap.h>
@@ -26,6 +25,7 @@
 #include <linux/percpu.h>
 #include <linux/lmb.h>
 #include <linux/mmzone.h>
+#include <linux/gfp.h>
 
 #include <asm/head.h>
 #include <asm/system.h>
@@ -2117,7 +2117,7 @@
 			       "node=%d entry=%lu/%lu\n", start, block, nr,
 			       node,
 			       addr >> VMEMMAP_CHUNK_SHIFT,
-			       VMEMMAP_SIZE >> VMEMMAP_CHUNK_SHIFT);
+			       VMEMMAP_SIZE);
 		}
 	}
 	return 0;
diff -urN linux-2.6.34-rc3/arch/sparc/mm/srmmu.c linux-2.6.34-rc4/arch/sparc/mm/srmmu.c
--- linux-2.6.34-rc3/arch/sparc/mm/srmmu.c	2010-04-13 02:18:55.537633056 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/srmmu.c	2010-04-13 02:19:00.623633068 +0000
@@ -10,7 +10,6 @@
 
 #include <linux/kernel.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/pagemap.h>
 #include <linux/init.h>
@@ -20,6 +19,7 @@
 #include <linux/seq_file.h>
 #include <linux/kdebug.h>
 #include <linux/log2.h>
+#include <linux/gfp.h>
 
 #include <asm/bitext.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/sparc/mm/sun4c.c linux-2.6.34-rc4/arch/sparc/mm/sun4c.c
--- linux-2.6.34-rc3/arch/sparc/mm/sun4c.c	2010-04-13 02:18:55.537633056 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/sun4c.c	2010-04-13 02:19:00.623633068 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/bootmem.h>
 #include <linux/highmem.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/arch/sparc/mm/tsb.c linux-2.6.34-rc4/arch/sparc/mm/tsb.c
--- linux-2.6.34-rc3/arch/sparc/mm/tsb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/sparc/mm/tsb.c	2010-04-13 02:19:00.624633131 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/kernel.h>
 #include <linux/preempt.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/page.h>
 #include <asm/tlbflush.h>
diff -urN linux-2.6.34-rc3/arch/um/drivers/net_kern.c linux-2.6.34-rc4/arch/um/drivers/net_kern.c
--- linux-2.6.34-rc3/arch/um/drivers/net_kern.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/drivers/net_kern.c	2010-04-13 02:19:00.625633103 +0000
@@ -16,6 +16,7 @@
 #include <linux/platform_device.h>
 #include <linux/rtnetlink.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include "init.h"
 #include "irq_kern.h"
diff -urN linux-2.6.34-rc3/arch/um/drivers/port_kern.c linux-2.6.34-rc4/arch/um/drivers/port_kern.c
--- linux-2.6.34-rc3/arch/um/drivers/port_kern.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/drivers/port_kern.c	2010-04-13 02:19:00.625633103 +0000
@@ -7,6 +7,7 @@
 #include "linux/interrupt.h"
 #include "linux/list.h"
 #include "linux/mutex.h"
+#include "linux/slab.h"
 #include "linux/workqueue.h"
 #include "asm/atomic.h"
 #include "init.h"
diff -urN linux-2.6.34-rc3/arch/um/drivers/ubd_kern.c linux-2.6.34-rc4/arch/um/drivers/ubd_kern.c
--- linux-2.6.34-rc3/arch/um/drivers/ubd_kern.c	2010-04-13 02:18:55.539571925 +0000
+++ linux-2.6.34-rc4/arch/um/drivers/ubd_kern.c	2010-04-13 02:19:00.625633103 +0000
@@ -31,6 +31,7 @@
 #include "linux/ctype.h"
 #include "linux/capability.h"
 #include "linux/mm.h"
+#include "linux/slab.h"
 #include "linux/vmalloc.h"
 #include "linux/blkpg.h"
 #include "linux/genhd.h"
diff -urN linux-2.6.34-rc3/arch/um/kernel/exec.c linux-2.6.34-rc4/arch/um/kernel/exec.c
--- linux-2.6.34-rc3/arch/um/kernel/exec.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/exec.c	2010-04-13 02:19:00.626578459 +0000
@@ -8,6 +8,7 @@
 #include "linux/smp_lock.h"
 #include "linux/ptrace.h"
 #include "linux/sched.h"
+#include "linux/slab.h"
 #include "asm/current.h"
 #include "asm/processor.h"
 #include "asm/uaccess.h"
diff -urN linux-2.6.34-rc3/arch/um/kernel/irq.c linux-2.6.34-rc4/arch/um/kernel/irq.c
--- linux-2.6.34-rc3/arch/um/kernel/irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/irq.c	2010-04-13 02:19:00.626578459 +0000
@@ -12,6 +12,7 @@
 #include "linux/module.h"
 #include "linux/sched.h"
 #include "linux/seq_file.h"
+#include "linux/slab.h"
 #include "as-layout.h"
 #include "kern_util.h"
 #include "os.h"
diff -urN linux-2.6.34-rc3/arch/um/kernel/mem.c linux-2.6.34-rc4/arch/um/kernel/mem.c
--- linux-2.6.34-rc3/arch/um/kernel/mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/mem.c	2010-04-13 02:19:00.626578459 +0000
@@ -5,10 +5,10 @@
 
 #include <linux/stddef.h>
 #include <linux/bootmem.h>
-#include <linux/gfp.h>
 #include <linux/highmem.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 #include <asm/fixmap.h>
 #include <asm/page.h>
 #include "as-layout.h"
diff -urN linux-2.6.34-rc3/arch/um/kernel/process.c linux-2.6.34-rc4/arch/um/kernel/process.c
--- linux-2.6.34-rc3/arch/um/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/process.c	2010-04-13 02:19:00.626578459 +0000
@@ -7,13 +7,13 @@
 #include <linux/stddef.h>
 #include <linux/err.h>
 #include <linux/hardirq.h>
-#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/personality.h>
 #include <linux/proc_fs.h>
 #include <linux/ptrace.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/seq_file.h>
 #include <linux/tick.h>
diff -urN linux-2.6.34-rc3/arch/um/kernel/reboot.c linux-2.6.34-rc4/arch/um/kernel/reboot.c
--- linux-2.6.34-rc3/arch/um/kernel/reboot.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/reboot.c	2010-04-13 02:19:00.626578459 +0000
@@ -4,6 +4,7 @@
  */
 
 #include "linux/sched.h"
+#include "linux/slab.h"
 #include "kern_util.h"
 #include "os.h"
 #include "skas.h"
diff -urN linux-2.6.34-rc3/arch/um/kernel/skas/mmu.c linux-2.6.34-rc4/arch/um/kernel/skas/mmu.c
--- linux-2.6.34-rc3/arch/um/kernel/skas/mmu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/kernel/skas/mmu.c	2010-04-13 02:19:00.626578459 +0000
@@ -5,6 +5,7 @@
 
 #include "linux/mm.h"
 #include "linux/sched.h"
+#include "linux/slab.h"
 #include "asm/pgalloc.h"
 #include "asm/pgtable.h"
 #include "as-layout.h"
diff -urN linux-2.6.34-rc3/arch/um/os-Linux/helper.c linux-2.6.34-rc4/arch/um/os-Linux/helper.c
--- linux-2.6.34-rc3/arch/um/os-Linux/helper.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/os-Linux/helper.c	2010-04-13 02:19:00.626578459 +0000
@@ -8,6 +8,7 @@
 #include <errno.h>
 #include <sched.h>
 #include <linux/limits.h>
+#include <linux/slab.h>
 #include <sys/socket.h>
 #include <sys/wait.h>
 #include "kern_constants.h"
diff -urN linux-2.6.34-rc3/arch/um/sys-i386/ldt.c linux-2.6.34-rc4/arch/um/sys-i386/ldt.c
--- linux-2.6.34-rc3/arch/um/sys-i386/ldt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/um/sys-i386/ldt.c	2010-04-13 02:19:00.627633052 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/mm.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/unistd.h>
 #include "os.h"
 #include "proc_mm.h"
diff -urN linux-2.6.34-rc3/arch/x86/Kconfig linux-2.6.34-rc4/arch/x86/Kconfig
--- linux-2.6.34-rc3/arch/x86/Kconfig	2010-04-13 02:18:55.541570496 +0000
+++ linux-2.6.34-rc4/arch/x86/Kconfig	2010-04-13 02:19:00.628633052 +0000
@@ -1216,8 +1216,8 @@
 
 config NODES_SHIFT
 	int "Maximum NUMA Nodes (as a power of 2)" if !MAXSMP
-	range 1 9
-	default "9" if MAXSMP
+	range 1 10
+	default "10" if MAXSMP
 	default "6" if X86_64
 	default "4" if X86_NUMAQ
 	default "3"
diff -urN linux-2.6.34-rc3/arch/x86/crypto/fpu.c linux-2.6.34-rc4/arch/x86/crypto/fpu.c
--- linux-2.6.34-rc3/arch/x86/crypto/fpu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/crypto/fpu.c	2010-04-13 02:19:00.628633052 +0000
@@ -16,6 +16,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/i387.h>
 
 struct crypto_fpu_ctx {
diff -urN linux-2.6.34-rc3/arch/x86/ia32/ia32_aout.c linux-2.6.34-rc4/arch/x86/ia32/ia32_aout.c
--- linux-2.6.34-rc3/arch/x86/ia32/ia32_aout.c	2010-04-13 02:18:55.541570496 +0000
+++ linux-2.6.34-rc4/arch/x86/ia32/ia32_aout.c	2010-04-13 02:19:00.629570445 +0000
@@ -21,7 +21,6 @@
 #include <linux/fcntl.h>
 #include <linux/ptrace.h>
 #include <linux/user.h>
-#include <linux/slab.h>
 #include <linux/binfmts.h>
 #include <linux/personality.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/x86/ia32/sys_ia32.c linux-2.6.34-rc4/arch/x86/ia32/sys_ia32.c
--- linux-2.6.34-rc3/arch/x86/ia32/sys_ia32.c	2010-04-13 02:18:55.542633069 +0000
+++ linux-2.6.34-rc4/arch/x86/ia32/sys_ia32.c	2010-04-13 02:19:00.629570445 +0000
@@ -40,6 +40,7 @@
 #include <linux/ptrace.h>
 #include <linux/highuid.h>
 #include <linux/sysctl.h>
+#include <linux/slab.h>
 #include <asm/mman.h>
 #include <asm/types.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/x86/include/asm/pgtable_32.h linux-2.6.34-rc4/arch/x86/include/asm/pgtable_32.h
--- linux-2.6.34-rc3/arch/x86/include/asm/pgtable_32.h	2010-04-13 02:18:55.549571562 +0000
+++ linux-2.6.34-rc4/arch/x86/include/asm/pgtable_32.h	2010-04-13 02:19:00.636633026 +0000
@@ -19,7 +19,6 @@
 #include <asm/paravirt.h>
 
 #include <linux/bitops.h>
-#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/spinlock.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/acpi/boot.c linux-2.6.34-rc4/arch/x86/kernel/acpi/boot.c
--- linux-2.6.34-rc3/arch/x86/kernel/acpi/boot.c	2010-04-13 02:18:55.551570578 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/acpi/boot.c	2010-04-13 02:19:00.639633088 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/dmi.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <linux/bootmem.h>
 #include <linux/ioport.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/alternative.c linux-2.6.34-rc4/arch/x86/kernel/alternative.c
--- linux-2.6.34-rc3/arch/x86/kernel/alternative.c	2010-04-13 02:18:55.552633055 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/alternative.c	2010-04-13 02:19:00.639633088 +0000
@@ -8,6 +8,7 @@
 #include <linux/vmalloc.h>
 #include <linux/memory.h>
 #include <linux/stop_machine.h>
+#include <linux/slab.h>
 #include <asm/alternative.h>
 #include <asm/sections.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/amd_iommu.c linux-2.6.34-rc4/arch/x86/kernel/amd_iommu.c
--- linux-2.6.34-rc3/arch/x86/kernel/amd_iommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/amd_iommu.c	2010-04-13 02:19:00.639633088 +0000
@@ -18,8 +18,8 @@
  */
 
 #include <linux/pci.h>
-#include <linux/gfp.h>
 #include <linux/bitmap.h>
+#include <linux/slab.h>
 #include <linux/debugfs.h>
 #include <linux/scatterlist.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/amd_iommu_init.c linux-2.6.34-rc4/arch/x86/kernel/amd_iommu_init.c
--- linux-2.6.34-rc3/arch/x86/kernel/amd_iommu_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/amd_iommu_init.c	2010-04-13 02:19:00.639633088 +0000
@@ -19,8 +19,8 @@
 
 #include <linux/pci.h>
 #include <linux/acpi.h>
-#include <linux/gfp.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/sysdev.h>
 #include <linux/interrupt.h>
 #include <linux/msi.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apb_timer.c linux-2.6.34-rc4/arch/x86/kernel/apb_timer.c
--- linux-2.6.34-rc3/arch/x86/kernel/apb_timer.c	2010-04-13 02:18:55.552633055 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apb_timer.c	2010-04-13 02:19:00.640633031 +0000
@@ -33,6 +33,7 @@
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/sysdev.h>
+#include <linux/slab.h>
 #include <linux/pm.h>
 #include <linux/pci.h>
 #include <linux/sfi.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apic/apic.c linux-2.6.34-rc4/arch/x86/kernel/apic/apic.c
--- linux-2.6.34-rc3/arch/x86/kernel/apic/apic.c	2010-04-13 02:18:55.553633075 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apic/apic.c	2010-04-13 02:19:00.640633031 +0000
@@ -1640,8 +1640,10 @@
 	}
 #endif
 
+#ifndef CONFIG_SMP
 	enable_IR_x2apic();
 	default_setup_apic_routing();
+#endif
 
 	verify_local_APIC();
 	connect_bsp_APIC();
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apic/es7000_32.c linux-2.6.34-rc4/arch/x86/kernel/apic/es7000_32.c
--- linux-2.6.34-rc3/arch/x86/kernel/apic/es7000_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apic/es7000_32.c	2010-04-13 02:19:00.641633030 +0000
@@ -42,6 +42,7 @@
 #include <linux/errno.h>
 #include <linux/acpi.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/nmi.h>
 #include <linux/smp.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apic/io_apic.c linux-2.6.34-rc4/arch/x86/kernel/apic/io_apic.c
--- linux-2.6.34-rc3/arch/x86/kernel/apic/io_apic.c	2010-04-13 02:18:55.554633066 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apic/io_apic.c	2010-04-13 02:19:00.642633051 +0000
@@ -36,6 +36,7 @@
 #include <linux/freezer.h>
 #include <linux/kthread.h>
 #include <linux/jiffies.h>	/* time_after() */
+#include <linux/slab.h>
 #ifdef CONFIG_ACPI
 #include <acpi/acpi_bus.h>
 #endif
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apic/nmi.c linux-2.6.34-rc4/arch/x86/kernel/apic/nmi.c
--- linux-2.6.34-rc3/arch/x86/kernel/apic/nmi.c	2010-04-13 02:18:55.554633066 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apic/nmi.c	2010-04-13 02:19:00.642633051 +0000
@@ -18,6 +18,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/sysdev.h>
 #include <linux/sysctl.h>
 #include <linux/percpu.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/apic/x2apic_uv_x.c linux-2.6.34-rc4/arch/x86/kernel/apic/x2apic_uv_x.c
--- linux-2.6.34-rc3/arch/x86/kernel/apic/x2apic_uv_x.c	2010-04-13 02:18:55.554633066 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/apic/x2apic_uv_x.c	2010-04-13 02:19:00.642633051 +0000
@@ -17,6 +17,7 @@
 #include <linux/ctype.h>
 #include <linux/sched.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/cpu.h>
 #include <linux/init.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/bootflag.c linux-2.6.34-rc4/arch/x86/kernel/bootflag.c
--- linux-2.6.34-rc3/arch/x86/kernel/bootflag.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/bootflag.c	2010-04-13 02:19:00.643633015 +0000
@@ -5,7 +5,6 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/acpi.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/acpi-cpufreq.c	2010-04-13 02:19:00.643633015 +0000
@@ -33,6 +33,7 @@
 #include <linux/cpufreq.h>
 #include <linux/compiler.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 #include <trace/events/power.h>
 
 #include <linux/acpi.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/elanfreq.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/elanfreq.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/elanfreq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/elanfreq.c	2010-04-13 02:19:00.644633405 +0000
@@ -20,7 +20,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/cpufreq.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/gx-suspmod.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/gx-suspmod.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/gx-suspmod.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/gx-suspmod.c	2010-04-13 02:19:00.644633405 +0000
@@ -80,6 +80,7 @@
 #include <linux/cpufreq.h>
 #include <linux/pci.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include <asm/processor-cyrix.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/longrun.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/longrun.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/longrun.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/longrun.c	2010-04-13 02:19:00.644633405 +0000
@@ -9,7 +9,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/cpufreq.h>
 #include <linux/timex.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/p4-clockmod.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/p4-clockmod.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/p4-clockmod.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/p4-clockmod.c	2010-04-13 02:19:00.644633405 +0000
@@ -25,7 +25,6 @@
 #include <linux/init.h>
 #include <linux/smp.h>
 #include <linux/cpufreq.h>
-#include <linux/slab.h>
 #include <linux/cpumask.h>
 #include <linux/timex.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/pcc-cpufreq.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/pcc-cpufreq.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/pcc-cpufreq.c	2010-04-13 02:18:55.555633054 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/pcc-cpufreq.c	2010-04-13 02:19:00.644633405 +0000
@@ -30,6 +30,7 @@
 #include <linux/sched.h>
 #include <linux/cpufreq.h>
 #include <linux/compiler.h>
+#include <linux/slab.h>
 
 #include <linux/acpi.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/powernow-k6.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/powernow-k6.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/powernow-k6.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/powernow-k6.c	2010-04-13 02:19:00.644633405 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/cpufreq.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/timex.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-centrino.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-centrino.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-centrino.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-centrino.c	2010-04-13 02:19:00.645633065 +0000
@@ -20,6 +20,7 @@
 #include <linux/sched.h>	/* current */
 #include <linux/delay.h>
 #include <linux/compiler.h>
+#include <linux/gfp.h>
 
 #include <asm/msr.h>
 #include <asm/processor.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-ich.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-ich.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-ich.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-ich.c	2010-04-13 02:19:00.645633065 +0000
@@ -23,7 +23,6 @@
 #include <linux/init.h>
 #include <linux/cpufreq.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include "speedstep-lib.h"
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-lib.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-lib.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-lib.c	2010-04-13 02:19:00.645633065 +0000
@@ -13,7 +13,6 @@
 #include <linux/moduleparam.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
-#include <linux/slab.h>
 
 #include <asm/msr.h>
 #include <asm/tsc.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-smi.c linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-smi.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/cpufreq/speedstep-smi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/cpufreq/speedstep-smi.c	2010-04-13 02:19:00.645633065 +0000
@@ -17,7 +17,6 @@
 #include <linux/moduleparam.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <asm/ist.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce-inject.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce-inject.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce-inject.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce-inject.c	2010-04-13 02:19:00.646633026 +0000
@@ -22,6 +22,7 @@
 #include <linux/kdebug.h>
 #include <linux/cpu.h>
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include <asm/mce.h>
 #include <asm/apic.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce.c	2010-04-13 02:18:55.557633110 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce.c	2010-04-13 02:19:00.646633026 +0000
@@ -26,6 +26,7 @@
 #include <linux/sched.h>
 #include <linux/sysfs.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kmod.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce_amd.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce_amd.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce_amd.c	2010-04-13 02:18:55.557633110 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce_amd.c	2010-04-13 02:19:00.646633026 +0000
@@ -21,6 +21,7 @@
 #include <linux/errno.h>
 #include <linux/sched.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/cpu.h>
 #include <linux/smp.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce_intel.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce_intel.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mcheck/mce_intel.c	2010-04-13 02:18:55.557633110 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mcheck/mce_intel.c	2010-04-13 02:19:00.646633026 +0000
@@ -5,6 +5,7 @@
  * Author: Andi Kleen
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/percpu.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mtrr/generic.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mtrr/generic.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mtrr/generic.c	2010-04-13 02:18:55.558633059 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mtrr/generic.c	2010-04-13 02:19:00.647633011 +0000
@@ -6,7 +6,6 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/mm.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/mtrr/if.c linux-2.6.34-rc4/arch/x86/kernel/cpu/mtrr/if.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/mtrr/if.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/mtrr/if.c	2010-04-13 02:19:00.647633011 +0000
@@ -5,6 +5,7 @@
 #include <linux/module.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #define LINE_SIZE 80
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event.c linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event.c	2010-04-13 02:18:55.560570477 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event.c	2010-04-13 02:19:00.650633016 +0000
@@ -21,6 +21,7 @@
 #include <linux/kdebug.h>
 #include <linux/sched.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/cpu.h>
 #include <linux/bitops.h>
@@ -28,6 +29,7 @@
 #include <asm/apic.h>
 #include <asm/stacktrace.h>
 #include <asm/nmi.h>
+#include <asm/compat.h>
 
 static u64 perf_event_mask __read_mostly;
 
@@ -158,7 +160,7 @@
 						 struct perf_event *event);
 	struct event_constraint *event_constraints;
 
-	void		(*cpu_prepare)(int cpu);
+	int		(*cpu_prepare)(int cpu);
 	void		(*cpu_starting)(int cpu);
 	void		(*cpu_dying)(int cpu);
 	void		(*cpu_dead)(int cpu);
@@ -1333,11 +1335,12 @@
 x86_pmu_notifier(struct notifier_block *self, unsigned long action, void *hcpu)
 {
 	unsigned int cpu = (long)hcpu;
+	int ret = NOTIFY_OK;
 
 	switch (action & ~CPU_TASKS_FROZEN) {
 	case CPU_UP_PREPARE:
 		if (x86_pmu.cpu_prepare)
-			x86_pmu.cpu_prepare(cpu);
+			ret = x86_pmu.cpu_prepare(cpu);
 		break;
 
 	case CPU_STARTING:
@@ -1350,6 +1353,7 @@
 			x86_pmu.cpu_dying(cpu);
 		break;
 
+	case CPU_UP_CANCELED:
 	case CPU_DEAD:
 		if (x86_pmu.cpu_dead)
 			x86_pmu.cpu_dead(cpu);
@@ -1359,7 +1363,7 @@
 		break;
 	}
 
-	return NOTIFY_OK;
+	return ret;
 }
 
 static void __init pmu_check_apic(void)
@@ -1628,14 +1632,42 @@
 	return len;
 }
 
-static int copy_stack_frame(const void __user *fp, struct stack_frame *frame)
+#ifdef CONFIG_COMPAT
+static inline int
+perf_callchain_user32(struct pt_regs *regs, struct perf_callchain_entry *entry)
 {
-	unsigned long bytes;
+	/* 32-bit process in 64-bit kernel. */
+	struct stack_frame_ia32 frame;
+	const void __user *fp;
 
-	bytes = copy_from_user_nmi(frame, fp, sizeof(*frame));
+	if (!test_thread_flag(TIF_IA32))
+		return 0;
+
+	fp = compat_ptr(regs->bp);
+	while (entry->nr < PERF_MAX_STACK_DEPTH) {
+		unsigned long bytes;
+		frame.next_frame     = 0;
+		frame.return_address = 0;
+
+		bytes = copy_from_user_nmi(&frame, fp, sizeof(frame));
+		if (bytes != sizeof(frame))
+			break;
+
+		if (fp < compat_ptr(regs->sp))
+			break;
 
-	return bytes == sizeof(*frame);
+		callchain_store(entry, frame.return_address);
+		fp = compat_ptr(frame.next_frame);
+	}
+	return 1;
+}
+#else
+static inline int
+perf_callchain_user32(struct pt_regs *regs, struct perf_callchain_entry *entry)
+{
+    return 0;
 }
+#endif
 
 static void
 perf_callchain_user(struct pt_regs *regs, struct perf_callchain_entry *entry)
@@ -1651,11 +1683,16 @@
 	callchain_store(entry, PERF_CONTEXT_USER);
 	callchain_store(entry, regs->ip);
 
+	if (perf_callchain_user32(regs, entry))
+		return;
+
 	while (entry->nr < PERF_MAX_STACK_DEPTH) {
+		unsigned long bytes;
 		frame.next_frame	     = NULL;
 		frame.return_address = 0;
 
-		if (!copy_stack_frame(fp, &frame))
+		bytes = copy_from_user_nmi(&frame, fp, sizeof(frame));
+		if (bytes != sizeof(frame))
 			break;
 
 		if ((unsigned long)fp < regs->sp)
@@ -1702,7 +1739,6 @@
 	return entry;
 }
 
-#ifdef CONFIG_EVENT_TRACING
 void perf_arch_fetch_caller_regs(struct pt_regs *regs, unsigned long ip, int skip)
 {
 	regs->ip = ip;
@@ -1714,4 +1750,3 @@
 	regs->cs = __KERNEL_CS;
 	local_save_flags(regs->flags);
 }
-#endif
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event_amd.c linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event_amd.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event_amd.c	2010-04-13 02:18:55.560570477 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event_amd.c	2010-04-13 02:19:00.650633016 +0000
@@ -137,6 +137,13 @@
 	return (hwc->config & 0xe0) == 0xe0;
 }
 
+static inline int amd_has_nb(struct cpu_hw_events *cpuc)
+{
+	struct amd_nb *nb = cpuc->amd_nb;
+
+	return nb && nb->nb_id != -1;
+}
+
 static void amd_put_event_constraints(struct cpu_hw_events *cpuc,
 				      struct perf_event *event)
 {
@@ -147,7 +154,7 @@
 	/*
 	 * only care about NB events
 	 */
-	if (!(nb && amd_is_nb_event(hwc)))
+	if (!(amd_has_nb(cpuc) && amd_is_nb_event(hwc)))
 		return;
 
 	/*
@@ -214,7 +221,7 @@
 	/*
 	 * if not NB event or no NB, then no constraints
 	 */
-	if (!(nb && amd_is_nb_event(hwc)))
+	if (!(amd_has_nb(cpuc) && amd_is_nb_event(hwc)))
 		return &unconstrained;
 
 	/*
@@ -293,51 +300,55 @@
 	return nb;
 }
 
-static void amd_pmu_cpu_online(int cpu)
+static int amd_pmu_cpu_prepare(int cpu)
+{
+	struct cpu_hw_events *cpuc = &per_cpu(cpu_hw_events, cpu);
+
+	WARN_ON_ONCE(cpuc->amd_nb);
+
+	if (boot_cpu_data.x86_max_cores < 2)
+		return NOTIFY_OK;
+
+	cpuc->amd_nb = amd_alloc_nb(cpu, -1);
+	if (!cpuc->amd_nb)
+		return NOTIFY_BAD;
+
+	return NOTIFY_OK;
+}
+
+static void amd_pmu_cpu_starting(int cpu)
 {
-	struct cpu_hw_events *cpu1, *cpu2;
-	struct amd_nb *nb = NULL;
+	struct cpu_hw_events *cpuc = &per_cpu(cpu_hw_events, cpu);
+	struct amd_nb *nb;
 	int i, nb_id;
 
 	if (boot_cpu_data.x86_max_cores < 2)
 		return;
 
-	/*
-	 * function may be called too early in the
-	 * boot process, in which case nb_id is bogus
-	 */
 	nb_id = amd_get_nb_id(cpu);
-	if (nb_id == BAD_APICID)
-		return;
-
-	cpu1 = &per_cpu(cpu_hw_events, cpu);
-	cpu1->amd_nb = NULL;
+	WARN_ON_ONCE(nb_id == BAD_APICID);
 
 	raw_spin_lock(&amd_nb_lock);
 
 	for_each_online_cpu(i) {
-		cpu2 = &per_cpu(cpu_hw_events, i);
-		nb = cpu2->amd_nb;
-		if (!nb)
+		nb = per_cpu(cpu_hw_events, i).amd_nb;
+		if (WARN_ON_ONCE(!nb))
 			continue;
-		if (nb->nb_id == nb_id)
-			goto found;
-	}
 
-	nb = amd_alloc_nb(cpu, nb_id);
-	if (!nb) {
-		pr_err("perf_events: failed NB allocation for CPU%d\n", cpu);
-		raw_spin_unlock(&amd_nb_lock);
-		return;
+		if (nb->nb_id == nb_id) {
+			kfree(cpuc->amd_nb);
+			cpuc->amd_nb = nb;
+			break;
+		}
 	}
-found:
-	nb->refcnt++;
-	cpu1->amd_nb = nb;
+
+	cpuc->amd_nb->nb_id = nb_id;
+	cpuc->amd_nb->refcnt++;
 
 	raw_spin_unlock(&amd_nb_lock);
 }
 
-static void amd_pmu_cpu_offline(int cpu)
+static void amd_pmu_cpu_dead(int cpu)
 {
 	struct cpu_hw_events *cpuhw;
 
@@ -349,8 +360,10 @@
 	raw_spin_lock(&amd_nb_lock);
 
 	if (cpuhw->amd_nb) {
-		if (--cpuhw->amd_nb->refcnt == 0)
-			kfree(cpuhw->amd_nb);
+		struct amd_nb *nb = cpuhw->amd_nb;
+
+		if (nb->nb_id == -1 || --nb->refcnt == 0)
+			kfree(nb);
 
 		cpuhw->amd_nb = NULL;
 	}
@@ -379,8 +392,9 @@
 	.get_event_constraints	= amd_get_event_constraints,
 	.put_event_constraints	= amd_put_event_constraints,
 
-	.cpu_prepare		= amd_pmu_cpu_online,
-	.cpu_dead		= amd_pmu_cpu_offline,
+	.cpu_prepare		= amd_pmu_cpu_prepare,
+	.cpu_starting		= amd_pmu_cpu_starting,
+	.cpu_dead		= amd_pmu_cpu_dead,
 };
 
 static __init int amd_pmu_init(void)
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event_intel.c linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event_intel.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpu/perf_event_intel.c	2010-04-13 02:18:55.561633079 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpu/perf_event_intel.c	2010-04-13 02:19:00.650633016 +0000
@@ -936,6 +936,7 @@
 
 	case 26: /* 45 nm nehalem, "Bloomfield" */
 	case 30: /* 45 nm nehalem, "Lynnfield" */
+	case 46: /* 45 nm nehalem-ex, "Beckton" */
 		memcpy(hw_cache_event_ids, nehalem_hw_cache_event_ids,
 		       sizeof(hw_cache_event_ids));
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/cpuid.c linux-2.6.34-rc4/arch/x86/kernel/cpuid.c
--- linux-2.6.34-rc3/arch/x86/kernel/cpuid.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/cpuid.c	2010-04-13 02:19:00.651633031 +0000
@@ -40,6 +40,7 @@
 #include <linux/cpu.h>
 #include <linux/notifier.h>
 #include <linux/uaccess.h>
+#include <linux/gfp.h>
 
 #include <asm/processor.h>
 #include <asm/msr.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/crash_dump_32.c linux-2.6.34-rc4/arch/x86/kernel/crash_dump_32.c
--- linux-2.6.34-rc3/arch/x86/kernel/crash_dump_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/crash_dump_32.c	2010-04-13 02:19:00.651633031 +0000
@@ -5,6 +5,7 @@
  *	Copyright (C) IBM Corporation, 2004. All rights reserved
  */
 
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/highmem.h>
 #include <linux/crash_dump.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/dumpstack.h linux-2.6.34-rc4/arch/x86/kernel/dumpstack.h
--- linux-2.6.34-rc3/arch/x86/kernel/dumpstack.h	2010-04-13 02:18:55.561633079 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/dumpstack.h	2010-04-13 02:19:00.651633031 +0000
@@ -30,6 +30,11 @@
 	unsigned long return_address;
 };
 
+struct stack_frame_ia32 {
+    u32 next_frame;
+    u32 return_address;
+};
+
 static inline unsigned long rewind_frame_pointer(int n)
 {
 	struct stack_frame *frame;
diff -urN linux-2.6.34-rc3/arch/x86/kernel/e820.c linux-2.6.34-rc4/arch/x86/kernel/e820.c
--- linux-2.6.34-rc3/arch/x86/kernel/e820.c	2010-04-13 02:18:55.562633040 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/e820.c	2010-04-13 02:19:00.651633031 +0000
@@ -519,29 +519,45 @@
 	printk(KERN_DEBUG "e820 remove range: %016Lx - %016Lx ",
 		       (unsigned long long) start,
 		       (unsigned long long) end);
-	e820_print_type(old_type);
+	if (checktype)
+		e820_print_type(old_type);
 	printk(KERN_CONT "\n");
 
 	for (i = 0; i < e820.nr_map; i++) {
 		struct e820entry *ei = &e820.map[i];
 		u64 final_start, final_end;
+		u64 ei_end;
 
 		if (checktype && ei->type != old_type)
 			continue;
+
+		ei_end = ei->addr + ei->size;
 		/* totally covered? */
-		if (ei->addr >= start &&
-		    (ei->addr + ei->size) <= (start + size)) {
+		if (ei->addr >= start && ei_end <= end) {
 			real_removed_size += ei->size;
 			memset(ei, 0, sizeof(struct e820entry));
 			continue;
 		}
+
+		/* new range is totally covered? */
+		if (ei->addr < start && ei_end > end) {
+			e820_add_region(end, ei_end - end, ei->type);
+			ei->size = start - ei->addr;
+			real_removed_size += size;
+			continue;
+		}
+
 		/* partially covered */
 		final_start = max(start, ei->addr);
-		final_end = min(start + size, ei->addr + ei->size);
+		final_end = min(end, ei_end);
 		if (final_start >= final_end)
 			continue;
 		real_removed_size += final_end - final_start;
 
+		/*
+		 * left range could be head or tail, so need to update
+		 * size at first.
+		 */
 		ei->size -= final_end - final_start;
 		if (ei->addr < final_start)
 			continue;
diff -urN linux-2.6.34-rc3/arch/x86/kernel/hpet.c linux-2.6.34-rc4/arch/x86/kernel/hpet.c
--- linux-2.6.34-rc3/arch/x86/kernel/hpet.c	2010-04-13 02:18:55.563633094 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/hpet.c	2010-04-13 02:19:00.652633048 +0000
@@ -4,6 +4,7 @@
 #include <linux/sysdev.h>
 #include <linux/delay.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/hpet.h>
 #include <linux/init.h>
 #include <linux/cpu.h>
@@ -399,9 +400,15 @@
 	 * then we might have a real hardware problem. We can not do
 	 * much about it here, but at least alert the user/admin with
 	 * a prominent warning.
+	 * An erratum on some chipsets (ICH9,..), results in comparator read
+	 * immediately following a write returning old value. Workaround
+	 * for this is to read this value second time, when first
+	 * read returns old value.
 	 */
-	WARN_ONCE(hpet_readl(HPET_Tn_CMP(timer)) != cnt,
+	if (unlikely((u32)hpet_readl(HPET_Tn_CMP(timer)) != cnt)) {
+		WARN_ONCE(hpet_readl(HPET_Tn_CMP(timer)) != cnt,
 		  KERN_WARNING "hpet: compare register read back failed.\n");
+	}
 
 	return (s32)(hpet_readl(HPET_COUNTER) - cnt) >= 0 ? -ETIME : 0;
 }
@@ -1143,6 +1150,7 @@
 		do_div(clc, freq);
 		clc >>= hpet_clockevent.shift;
 		hpet_pie_delta = clc;
+		hpet_pie_limit = 0;
 	}
 	return 1;
 }
diff -urN linux-2.6.34-rc3/arch/x86/kernel/i387.c linux-2.6.34-rc4/arch/x86/kernel/i387.c
--- linux-2.6.34-rc3/arch/x86/kernel/i387.c	2010-04-13 02:18:55.563633094 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/i387.c	2010-04-13 02:19:00.653633087 +0000
@@ -8,6 +8,7 @@
 #include <linux/module.h>
 #include <linux/regset.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/sigcontext.h>
 #include <asm/processor.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/i8259.c linux-2.6.34-rc4/arch/x86/kernel/i8259.c
--- linux-2.6.34-rc3/arch/x86/kernel/i8259.c	2010-04-13 02:18:55.563633094 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/i8259.c	2010-04-13 02:19:00.653633087 +0000
@@ -5,7 +5,6 @@
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/init.h>
 #include <linux/kernel_stat.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/irqinit.c linux-2.6.34-rc4/arch/x86/kernel/irqinit.c
--- linux-2.6.34-rc3/arch/x86/kernel/irqinit.c	2010-04-13 02:18:55.563633094 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/irqinit.c	2010-04-13 02:19:00.653633087 +0000
@@ -5,7 +5,6 @@
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <linux/timex.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/kprobes.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/k8.c linux-2.6.34-rc4/arch/x86/kernel/k8.c
--- linux-2.6.34-rc3/arch/x86/kernel/k8.c	2010-04-13 02:18:55.563633094 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/k8.c	2010-04-13 02:19:00.653633087 +0000
@@ -2,8 +2,8 @@
  * Shared support code for AMD K8 northbridges and derivates.
  * Copyright 2006 Andi Kleen, SUSE Labs. Subject to GPLv2.
  */
-#include <linux/gfp.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/kdebugfs.c linux-2.6.34-rc4/arch/x86/kernel/kdebugfs.c
--- linux-2.6.34-rc3/arch/x86/kernel/kdebugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/kdebugfs.c	2010-04-13 02:19:00.653633087 +0000
@@ -9,6 +9,7 @@
 #include <linux/debugfs.h>
 #include <linux/uaccess.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/stat.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/kgdb.c linux-2.6.34-rc4/arch/x86/kernel/kgdb.c
--- linux-2.6.34-rc3/arch/x86/kernel/kgdb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/kgdb.c	2010-04-13 02:19:00.653633087 +0000
@@ -618,8 +618,8 @@
 	 * portion of kgdb because this operation requires mutexs to
 	 * complete.
 	 */
+	hw_breakpoint_init(&attr);
 	attr.bp_addr = (unsigned long)kgdb_arch_init;
-	attr.type = PERF_TYPE_BREAKPOINT;
 	attr.bp_len = HW_BREAKPOINT_LEN_1;
 	attr.bp_type = HW_BREAKPOINT_W;
 	attr.disabled = 1;
diff -urN linux-2.6.34-rc3/arch/x86/kernel/ldt.c linux-2.6.34-rc4/arch/x86/kernel/ldt.c
--- linux-2.6.34-rc3/arch/x86/kernel/ldt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/ldt.c	2010-04-13 02:19:00.654633066 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/string.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/machine_kexec_64.c linux-2.6.34-rc4/arch/x86/kernel/machine_kexec_64.c
--- linux-2.6.34-rc3/arch/x86/kernel/machine_kexec_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/machine_kexec_64.c	2010-04-13 02:19:00.654633066 +0000
@@ -9,6 +9,7 @@
 #include <linux/mm.h>
 #include <linux/kexec.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 #include <linux/reboot.h>
 #include <linux/numa.h>
 #include <linux/ftrace.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/mca_32.c linux-2.6.34-rc4/arch/x86/kernel/mca_32.c
--- linux-2.6.34-rc3/arch/x86/kernel/mca_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/mca_32.c	2010-04-13 02:19:00.654633066 +0000
@@ -42,6 +42,7 @@
 #include <linux/kernel.h>
 #include <linux/mca.h>
 #include <linux/kprobes.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/io.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/module.c linux-2.6.34-rc4/arch/x86/kernel/module.c
--- linux-2.6.34-rc3/arch/x86/kernel/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/module.c	2010-04-13 02:19:00.655633039 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/bug.h>
 #include <linux/mm.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/mpparse.c linux-2.6.34-rc4/arch/x86/kernel/mpparse.c
--- linux-2.6.34-rc3/arch/x86/kernel/mpparse.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/mpparse.c	2010-04-13 02:19:00.655633039 +0000
@@ -664,7 +664,7 @@
 {
 	unsigned long size = get_mpc_size(mpf->physptr);
 
-	reserve_early(mpf->physptr, mpf->physptr+size, "MP-table mpc");
+	reserve_early_overlap_ok(mpf->physptr, mpf->physptr+size, "MP-table mpc");
 }
 
 static int __init smp_scan_config(unsigned long base, unsigned long length)
@@ -693,7 +693,7 @@
 			       mpf, (u64)virt_to_phys(mpf));
 
 			mem = virt_to_phys(mpf);
-			reserve_early(mem, mem + sizeof(*mpf), "MP-table mpf");
+			reserve_early_overlap_ok(mem, mem + sizeof(*mpf), "MP-table mpf");
 			if (mpf->physptr)
 				smp_reserve_memory(mpf);
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/msr.c linux-2.6.34-rc4/arch/x86/kernel/msr.c
--- linux-2.6.34-rc3/arch/x86/kernel/msr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/msr.c	2010-04-13 02:19:00.655633039 +0000
@@ -37,6 +37,7 @@
 #include <linux/cpu.h>
 #include <linux/notifier.h>
 #include <linux/uaccess.h>
+#include <linux/gfp.h>
 
 #include <asm/processor.h>
 #include <asm/msr.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/pci-dma.c linux-2.6.34-rc4/arch/x86/kernel/pci-dma.c
--- linux-2.6.34-rc3/arch/x86/kernel/pci-dma.c	2010-04-13 02:18:55.565633045 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/pci-dma.c	2010-04-13 02:19:00.656633008 +0000
@@ -2,6 +2,7 @@
 #include <linux/dma-debug.h>
 #include <linux/dmar.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/kmemleak.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/pci-gart_64.c linux-2.6.34-rc4/arch/x86/kernel/pci-gart_64.c
--- linux-2.6.34-rc3/arch/x86/kernel/pci-gart_64.c	2010-04-13 02:18:55.565633045 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/pci-gart_64.c	2010-04-13 02:19:00.656633008 +0000
@@ -29,6 +29,7 @@
 #include <linux/iommu-helper.h>
 #include <linux/sysdev.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 #include <asm/atomic.h>
 #include <asm/mtrr.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/pci-nommu.c linux-2.6.34-rc4/arch/x86/kernel/pci-nommu.c
--- linux-2.6.34-rc3/arch/x86/kernel/pci-nommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/pci-nommu.c	2010-04-13 02:19:00.656633008 +0000
@@ -4,6 +4,7 @@
 #include <linux/scatterlist.h>
 #include <linux/string.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/mm.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kernel/ptrace.c linux-2.6.34-rc4/arch/x86/kernel/ptrace.c
--- linux-2.6.34-rc3/arch/x86/kernel/ptrace.c	2010-04-13 02:18:55.566633078 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/ptrace.c	2010-04-13 02:19:00.656633008 +0000
@@ -12,6 +12,7 @@
 #include <linux/mm.h>
 #include <linux/smp.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/ptrace.h>
 #include <linux/regset.h>
 #include <linux/tracehook.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/setup.c linux-2.6.34-rc4/arch/x86/kernel/setup.c
--- linux-2.6.34-rc3/arch/x86/kernel/setup.c	2010-04-13 02:18:55.566633078 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/setup.c	2010-04-13 02:19:00.657633077 +0000
@@ -55,7 +55,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/user.h>
 #include <linux/delay.h>
 
@@ -608,6 +607,16 @@
 early_param("elfcorehdr", setup_elfcorehdr);
 #endif
 
+static __init void reserve_ibft_region(void)
+{
+	unsigned long addr, size = 0;
+
+	addr = find_ibft_region(&size);
+
+	if (size)
+		reserve_early_overlap_ok(addr, addr + size, "ibft");
+}
+
 #ifdef CONFIG_X86_RESERVE_LOW_64K
 static int __init dmi_low_memory_corruption(const struct dmi_system_id *d)
 {
@@ -910,6 +919,8 @@
 	 */
 	find_smp_config();
 
+	reserve_ibft_region();
+
 	reserve_trampoline_memory();
 
 #ifdef CONFIG_ACPI_SLEEP
@@ -977,8 +988,6 @@
 
 	dma32_reserve_bootmem();
 
-	reserve_ibft_region();
-
 #ifdef CONFIG_KVM_CLOCK
 	kvmclock_init();
 #endif
diff -urN linux-2.6.34-rc3/arch/x86/kernel/smp.c linux-2.6.34-rc4/arch/x86/kernel/smp.c
--- linux-2.6.34-rc3/arch/x86/kernel/smp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/smp.c	2010-04-13 02:19:00.657633077 +0000
@@ -21,6 +21,7 @@
 #include <linux/cache.h>
 #include <linux/interrupt.h>
 #include <linux/cpu.h>
+#include <linux/gfp.h>
 
 #include <asm/mtrr.h>
 #include <asm/tlbflush.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/smpboot.c linux-2.6.34-rc4/arch/x86/kernel/smpboot.c
--- linux-2.6.34-rc3/arch/x86/kernel/smpboot.c	2010-04-13 02:18:55.566633078 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/smpboot.c	2010-04-13 02:19:00.657633077 +0000
@@ -49,6 +49,7 @@
 #include <linux/nmi.h>
 #include <linux/tboot.h>
 #include <linux/stackprotector.h>
+#include <linux/gfp.h>
 
 #include <asm/acpi.h>
 #include <asm/desc.h>
@@ -242,8 +243,6 @@
 	end_local_APIC_setup();
 	map_cpu_to_logical_apicid();
 
-	notify_cpu_starting(cpuid);
-
 	/*
 	 * Need to setup vector mappings before we enable interrupts.
 	 */
@@ -264,6 +263,8 @@
 	 */
 	smp_store_cpu_info(cpuid);
 
+	notify_cpu_starting(cpuid);
+
 	/*
 	 * Allow the master to continue.
 	 */
diff -urN linux-2.6.34-rc3/arch/x86/kernel/tlb_uv.c linux-2.6.34-rc4/arch/x86/kernel/tlb_uv.c
--- linux-2.6.34-rc3/arch/x86/kernel/tlb_uv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/tlb_uv.c	2010-04-13 02:19:00.658633023 +0000
@@ -9,6 +9,7 @@
 #include <linux/seq_file.h>
 #include <linux/proc_fs.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include <asm/mmu_context.h>
 #include <asm/uv/uv.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/uv_irq.c linux-2.6.34-rc4/arch/x86/kernel/uv_irq.c
--- linux-2.6.34-rc3/arch/x86/kernel/uv_irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/uv_irq.c	2010-04-13 02:19:00.658633023 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/module.h>
 #include <linux/rbtree.h>
+#include <linux/slab.h>
 #include <linux/irq.h>
 
 #include <asm/apic.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/uv_time.c linux-2.6.34-rc4/arch/x86/kernel/uv_time.c
--- linux-2.6.34-rc3/arch/x86/kernel/uv_time.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/uv_time.c	2010-04-13 02:19:00.659633050 +0000
@@ -19,6 +19,7 @@
  *  Copyright (c) Dimitri Sivanich
  */
 #include <linux/clockchips.h>
+#include <linux/slab.h>
 
 #include <asm/uv/uv_mmrs.h>
 #include <asm/uv/uv_hub.h>
diff -urN linux-2.6.34-rc3/arch/x86/kernel/vmi_32.c linux-2.6.34-rc4/arch/x86/kernel/vmi_32.c
--- linux-2.6.34-rc3/arch/x86/kernel/vmi_32.c	2010-04-13 02:18:55.568633009 +0000
+++ linux-2.6.34-rc4/arch/x86/kernel/vmi_32.c	2010-04-13 02:19:00.659633050 +0000
@@ -28,6 +28,7 @@
 #include <linux/mm.h>
 #include <linux/highmem.h>
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include <asm/vmi.h>
 #include <asm/io.h>
 #include <asm/fixmap.h>
diff -urN linux-2.6.34-rc3/arch/x86/kvm/i8254.c linux-2.6.34-rc4/arch/x86/kvm/i8254.c
--- linux-2.6.34-rc3/arch/x86/kvm/i8254.c	2010-04-13 02:18:55.569571500 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/i8254.c	2010-04-13 02:19:00.661633385 +0000
@@ -32,6 +32,7 @@
 #define pr_fmt(fmt) "pit: " fmt
 
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 
 #include "irq.h"
 #include "i8254.h"
diff -urN linux-2.6.34-rc3/arch/x86/kvm/i8259.c linux-2.6.34-rc4/arch/x86/kvm/i8259.c
--- linux-2.6.34-rc3/arch/x86/kvm/i8259.c	2010-04-13 02:18:55.570570429 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/i8259.c	2010-04-13 02:19:00.661633385 +0000
@@ -26,6 +26,7 @@
  *   Port from Qemu.
  */
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/bitops.h>
 #include "irq.h"
 
diff -urN linux-2.6.34-rc3/arch/x86/kvm/lapic.c linux-2.6.34-rc4/arch/x86/kvm/lapic.c
--- linux-2.6.34-rc3/arch/x86/kvm/lapic.c	2010-04-13 02:18:55.570570429 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/lapic.c	2010-04-13 02:19:00.661633385 +0000
@@ -26,6 +26,7 @@
 #include <linux/io.h>
 #include <linux/module.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 #include <asm/processor.h>
 #include <asm/msr.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/x86/kvm/mmu.c linux-2.6.34-rc4/arch/x86/kvm/mmu.c
--- linux-2.6.34-rc3/arch/x86/kvm/mmu.c	2010-04-13 02:18:55.571633074 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/mmu.c	2010-04-13 02:19:00.662633103 +0000
@@ -31,6 +31,7 @@
 #include <linux/hugetlb.h>
 #include <linux/compiler.h>
 #include <linux/srcu.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 #include <asm/cmpxchg.h>
diff -urN linux-2.6.34-rc3/arch/x86/kvm/svm.c linux-2.6.34-rc4/arch/x86/kvm/svm.c
--- linux-2.6.34-rc3/arch/x86/kvm/svm.c	2010-04-13 02:18:55.572633031 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/svm.c	2010-04-13 02:19:00.663633001 +0000
@@ -26,6 +26,7 @@
 #include <linux/highmem.h>
 #include <linux/sched.h>
 #include <linux/ftrace_event.h>
+#include <linux/slab.h>
 
 #include <asm/desc.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/kvm/vmx.c linux-2.6.34-rc4/arch/x86/kvm/vmx.c
--- linux-2.6.34-rc3/arch/x86/kvm/vmx.c	2010-04-13 02:18:55.573633049 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/vmx.c	2010-04-13 02:19:00.664633066 +0000
@@ -26,6 +26,7 @@
 #include <linux/sched.h>
 #include <linux/moduleparam.h>
 #include <linux/ftrace_event.h>
+#include <linux/slab.h>
 #include "kvm_cache_regs.h"
 #include "x86.h"
 
diff -urN linux-2.6.34-rc3/arch/x86/kvm/x86.c linux-2.6.34-rc4/arch/x86/kvm/x86.c
--- linux-2.6.34-rc3/arch/x86/kvm/x86.c	2010-04-13 02:18:55.574633037 +0000
+++ linux-2.6.34-rc4/arch/x86/kvm/x86.c	2010-04-13 02:19:00.666633036 +0000
@@ -39,6 +39,7 @@
 #include <linux/cpufreq.h>
 #include <linux/user-return-notifier.h>
 #include <linux/srcu.h>
+#include <linux/slab.h>
 #include <trace/events/kvm.h>
 #undef TRACE_INCLUDE_FILE
 #define CREATE_TRACE_POINTS
diff -urN linux-2.6.34-rc3/arch/x86/mm/hugetlbpage.c linux-2.6.34-rc4/arch/x86/mm/hugetlbpage.c
--- linux-2.6.34-rc3/arch/x86/mm/hugetlbpage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/hugetlbpage.c	2010-04-13 02:19:00.667633054 +0000
@@ -9,7 +9,6 @@
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
-#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/sysctl.h>
 #include <asm/mman.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/init.c linux-2.6.34-rc4/arch/x86/mm/init.c
--- linux-2.6.34-rc3/arch/x86/mm/init.c	2010-04-13 02:18:55.576633102 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/init.c	2010-04-13 02:19:00.668633101 +0000
@@ -1,3 +1,4 @@
+#include <linux/gfp.h>
 #include <linux/initrd.h>
 #include <linux/ioport.h>
 #include <linux/swap.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/init_32.c linux-2.6.34-rc4/arch/x86/mm/init_32.c
--- linux-2.6.34-rc3/arch/x86/mm/init_32.c	2010-04-13 02:18:55.576633102 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/init_32.c	2010-04-13 02:19:00.668633101 +0000
@@ -25,11 +25,11 @@
 #include <linux/pfn.h>
 #include <linux/poison.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/memory_hotplug.h>
 #include <linux/initrd.h>
 #include <linux/cpumask.h>
+#include <linux/gfp.h>
 
 #include <asm/asm.h>
 #include <asm/bios_ebda.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/init_64.c linux-2.6.34-rc4/arch/x86/mm/init_64.c
--- linux-2.6.34-rc3/arch/x86/mm/init_64.c	2010-04-13 02:18:55.576633102 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/init_64.c	2010-04-13 02:19:00.668633101 +0000
@@ -29,6 +29,7 @@
 #include <linux/module.h>
 #include <linux/memory_hotplug.h>
 #include <linux/nmi.h>
+#include <linux/gfp.h>
 
 #include <asm/processor.h>
 #include <asm/bios_ebda.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/kmmio.c linux-2.6.34-rc4/arch/x86/mm/kmmio.c
--- linux-2.6.34-rc3/arch/x86/mm/kmmio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/kmmio.c	2010-04-13 02:19:00.669633077 +0000
@@ -21,6 +21,7 @@
 #include <linux/kdebug.h>
 #include <linux/mutex.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 #include <asm/tlbflush.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/mmio-mod.c linux-2.6.34-rc4/arch/x86/mm/mmio-mod.c
--- linux-2.6.34-rc3/arch/x86/mm/mmio-mod.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/mmio-mod.c	2010-04-13 02:19:00.669633077 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/module.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/io.h>
 #include <linux/version.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/pageattr.c linux-2.6.34-rc4/arch/x86/mm/pageattr.c
--- linux-2.6.34-rc3/arch/x86/mm/pageattr.c	2010-04-13 02:18:55.578633030 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/pageattr.c	2010-04-13 02:19:00.670633194 +0000
@@ -6,13 +6,13 @@
 #include <linux/bootmem.h>
 #include <linux/module.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/interrupt.h>
 #include <linux/seq_file.h>
 #include <linux/debugfs.h>
 #include <linux/pfn.h>
 #include <linux/percpu.h>
+#include <linux/gfp.h>
 
 #include <asm/e820.h>
 #include <asm/processor.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/pat.c linux-2.6.34-rc4/arch/x86/mm/pat.c
--- linux-2.6.34-rc3/arch/x86/mm/pat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/pat.c	2010-04-13 02:19:00.670633194 +0000
@@ -12,7 +12,7 @@
 #include <linux/debugfs.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/gfp.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/fs.h>
 #include <linux/rbtree.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/pgtable.c linux-2.6.34-rc4/arch/x86/mm/pgtable.c
--- linux-2.6.34-rc3/arch/x86/mm/pgtable.c	2010-04-13 02:18:55.578633030 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/pgtable.c	2010-04-13 02:19:00.670633194 +0000
@@ -1,4 +1,5 @@
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include <asm/pgalloc.h>
 #include <asm/pgtable.h>
 #include <asm/tlb.h>
diff -urN linux-2.6.34-rc3/arch/x86/mm/pgtable_32.c linux-2.6.34-rc4/arch/x86/mm/pgtable_32.c
--- linux-2.6.34-rc3/arch/x86/mm/pgtable_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/mm/pgtable_32.c	2010-04-13 02:19:00.670633194 +0000
@@ -6,7 +6,6 @@
 #include <linux/swap.h>
 #include <linux/smp.h>
 #include <linux/highmem.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/spinlock.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/arch/x86/pci/acpi.c linux-2.6.34-rc4/arch/x86/pci/acpi.c
--- linux-2.6.34-rc3/arch/x86/pci/acpi.c	2010-04-13 02:18:55.579571819 +0000
+++ linux-2.6.34-rc4/arch/x86/pci/acpi.c	2010-04-13 02:19:00.671633050 +0000
@@ -3,6 +3,7 @@
 #include <linux/init.h>
 #include <linux/irq.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 #include <asm/numa.h>
 #include <asm/pci_x86.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/pci/common.c linux-2.6.34-rc4/arch/x86/pci/common.c
--- linux-2.6.34-rc3/arch/x86/pci/common.c	2010-04-13 02:18:55.580570432 +0000
+++ linux-2.6.34-rc4/arch/x86/pci/common.c	2010-04-13 02:19:00.672633049 +0000
@@ -9,6 +9,7 @@
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #include <asm/acpi.h>
 #include <asm/segment.h>
diff -urN linux-2.6.34-rc3/arch/x86/pci/irq.c linux-2.6.34-rc4/arch/x86/pci/irq.c
--- linux-2.6.34-rc3/arch/x86/pci/irq.c	2010-04-13 02:18:55.580570432 +0000
+++ linux-2.6.34-rc4/arch/x86/pci/irq.c	2010-04-13 02:19:00.672633049 +0000
@@ -8,7 +8,6 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/dmi.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/arch/x86/pci/mmconfig-shared.c linux-2.6.34-rc4/arch/x86/pci/mmconfig-shared.c
--- linux-2.6.34-rc3/arch/x86/pci/mmconfig-shared.c	2010-04-13 02:18:55.580570432 +0000
+++ linux-2.6.34-rc4/arch/x86/pci/mmconfig-shared.c	2010-04-13 02:19:00.672633049 +0000
@@ -16,6 +16,7 @@
 #include <linux/sfi_acpi.h>
 #include <linux/bitmap.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 #include <asm/e820.h>
 #include <asm/pci_x86.h>
 #include <asm/acpi.h>
diff -urN linux-2.6.34-rc3/arch/x86/pci/pcbios.c linux-2.6.34-rc4/arch/x86/pci/pcbios.c
--- linux-2.6.34-rc3/arch/x86/pci/pcbios.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/pci/pcbios.c	2010-04-13 02:19:00.673633100 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/pci.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/uaccess.h>
 #include <asm/pci_x86.h>
diff -urN linux-2.6.34-rc3/arch/x86/power/hibernate_32.c linux-2.6.34-rc4/arch/x86/power/hibernate_32.c
--- linux-2.6.34-rc3/arch/x86/power/hibernate_32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/power/hibernate_32.c	2010-04-13 02:19:00.673633100 +0000
@@ -6,6 +6,7 @@
  * Copyright (c) 2006 Rafael J. Wysocki <rjw@sisk.pl>
  */
 
+#include <linux/gfp.h>
 #include <linux/suspend.h>
 #include <linux/bootmem.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/power/hibernate_64.c linux-2.6.34-rc4/arch/x86/power/hibernate_64.c
--- linux-2.6.34-rc3/arch/x86/power/hibernate_64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/power/hibernate_64.c	2010-04-13 02:19:00.673633100 +0000
@@ -8,6 +8,7 @@
  * Copyright (c) 2001 Patrick Mochel <mochel@osdl.org>
  */
 
+#include <linux/gfp.h>
 #include <linux/smp.h>
 #include <linux/suspend.h>
 #include <asm/proto.h>
diff -urN linux-2.6.34-rc3/arch/x86/power/hibernate_asm_32.S linux-2.6.34-rc4/arch/x86/power/hibernate_asm_32.S
--- linux-2.6.34-rc3/arch/x86/power/hibernate_asm_32.S	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/power/hibernate_asm_32.S	2010-04-13 02:19:00.673633100 +0000
@@ -27,10 +27,17 @@
 	ret
 
 ENTRY(restore_image)
+	movl	mmu_cr4_features, %ecx
 	movl	resume_pg_dir, %eax
 	subl	$__PAGE_OFFSET, %eax
 	movl	%eax, %cr3
 
+	jecxz	1f	# cr4 Pentium and higher, skip if zero
+	andl	$~(X86_CR4_PGE), %ecx
+	movl	%ecx, %cr4;  # turn off PGE
+	movl	%cr3, %eax;  # flush TLB
+	movl	%eax, %cr3
+1:
 	movl	restore_pblist, %edx
 	.p2align 4,,7
 
@@ -54,16 +61,8 @@
 	movl	$swapper_pg_dir, %eax
 	subl	$__PAGE_OFFSET, %eax
 	movl	%eax, %cr3
-	/* Flush TLB, including "global" things (vmalloc) */
 	movl	mmu_cr4_features, %ecx
 	jecxz	1f	# cr4 Pentium and higher, skip if zero
-	movl	%ecx, %edx
-	andl	$~(X86_CR4_PGE), %edx
-	movl	%edx, %cr4;  # turn off PGE
-1:
-	movl	%cr3, %eax;  # flush TLB
-	movl	%eax, %cr3
-	jecxz	1f	# cr4 Pentium and higher, skip if zero
 	movl	%ecx, %cr4;  # turn PGE back on
 1:
 
diff -urN linux-2.6.34-rc3/arch/x86/vdso/vma.c linux-2.6.34-rc4/arch/x86/vdso/vma.c
--- linux-2.6.34-rc3/arch/x86/vdso/vma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/vdso/vma.c	2010-04-13 02:19:00.673633100 +0000
@@ -6,6 +6,7 @@
 #include <linux/mm.h>
 #include <linux/err.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/random.h>
 #include <linux/elf.h>
diff -urN linux-2.6.34-rc3/arch/x86/xen/debugfs.c linux-2.6.34-rc4/arch/x86/xen/debugfs.c
--- linux-2.6.34-rc3/arch/x86/xen/debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/debugfs.c	2010-04-13 02:19:00.673633100 +0000
@@ -1,5 +1,6 @@
 #include <linux/init.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "debugfs.h"
diff -urN linux-2.6.34-rc3/arch/x86/xen/enlighten.c linux-2.6.34-rc4/arch/x86/xen/enlighten.c
--- linux-2.6.34-rc3/arch/x86/xen/enlighten.c	2010-04-13 02:18:55.581633038 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/enlighten.c	2010-04-13 02:19:00.674633052 +0000
@@ -28,6 +28,7 @@
 #include <linux/highmem.h>
 #include <linux/console.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 
 #include <xen/xen.h>
 #include <xen/interface/xen.h>
diff -urN linux-2.6.34-rc3/arch/x86/xen/mmu.c linux-2.6.34-rc4/arch/x86/xen/mmu.c
--- linux-2.6.34-rc3/arch/x86/xen/mmu.c	2010-04-13 02:18:55.581633038 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/mmu.c	2010-04-13 02:19:00.674633052 +0000
@@ -43,6 +43,7 @@
 #include <linux/debugfs.h>
 #include <linux/bug.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 
 #include <asm/pgtable.h>
 #include <asm/tlbflush.h>
diff -urN linux-2.6.34-rc3/arch/x86/xen/smp.c linux-2.6.34-rc4/arch/x86/xen/smp.c
--- linux-2.6.34-rc3/arch/x86/xen/smp.c	2010-04-13 02:18:55.582571695 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/smp.c	2010-04-13 02:19:00.674633052 +0000
@@ -14,6 +14,7 @@
  */
 #include <linux/sched.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/smp.h>
 
 #include <asm/paravirt.h>
diff -urN linux-2.6.34-rc3/arch/x86/xen/spinlock.c linux-2.6.34-rc4/arch/x86/xen/spinlock.c
--- linux-2.6.34-rc3/arch/x86/xen/spinlock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/spinlock.c	2010-04-13 02:19:00.674633052 +0000
@@ -6,6 +6,7 @@
 #include <linux/spinlock.h>
 #include <linux/debugfs.h>
 #include <linux/log2.h>
+#include <linux/gfp.h>
 
 #include <asm/paravirt.h>
 
diff -urN linux-2.6.34-rc3/arch/x86/xen/time.c linux-2.6.34-rc4/arch/x86/xen/time.c
--- linux-2.6.34-rc3/arch/x86/xen/time.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/x86/xen/time.c	2010-04-13 02:19:00.674633052 +0000
@@ -13,6 +13,7 @@
 #include <linux/clockchips.h>
 #include <linux/kernel_stat.h>
 #include <linux/math64.h>
+#include <linux/gfp.h>
 
 #include <asm/pvclock.h>
 #include <asm/xen/hypervisor.h>
diff -urN linux-2.6.34-rc3/arch/xtensa/kernel/pci-dma.c linux-2.6.34-rc4/arch/xtensa/kernel/pci-dma.c
--- linux-2.6.34-rc3/arch/xtensa/kernel/pci-dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/xtensa/kernel/pci-dma.c	2010-04-13 02:19:00.675633028 +0000
@@ -20,6 +20,7 @@
 #include <linux/mm.h>
 #include <linux/string.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <asm/cacheflush.h>
 
diff -urN linux-2.6.34-rc3/arch/xtensa/kernel/process.c linux-2.6.34-rc4/arch/xtensa/kernel/process.c
--- linux-2.6.34-rc3/arch/xtensa/kernel/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/xtensa/kernel/process.c	2010-04-13 02:19:00.675633028 +0000
@@ -23,7 +23,6 @@
 #include <linux/stddef.h>
 #include <linux/unistd.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/elf.h>
 #include <linux/init.h>
 #include <linux/prctl.h>
@@ -31,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/mqueue.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 
 #include <asm/pgtable.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/arch/xtensa/mm/init.c linux-2.6.34-rc4/arch/xtensa/mm/init.c
--- linux-2.6.34-rc3/arch/xtensa/mm/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/xtensa/mm/init.c	2010-04-13 02:19:00.675633028 +0000
@@ -18,11 +18,11 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/bootmem.h>
+#include <linux/gfp.h>
 #include <linux/swap.h>
 #include <linux/mman.h>
 #include <linux/nodemask.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 
 #include <asm/bootparam.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/arch/xtensa/platforms/iss/console.c linux-2.6.34-rc4/arch/xtensa/platforms/iss/console.c
--- linux-2.6.34-rc3/arch/xtensa/platforms/iss/console.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/arch/xtensa/platforms/iss/console.c	2010-04-13 02:19:00.676633042 +0000
@@ -14,7 +14,6 @@
 #include <linux/sched.h>
 #include <linux/console.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/major.h>
 #include <linux/param.h>
diff -urN linux-2.6.34-rc3/block/Kconfig linux-2.6.34-rc4/block/Kconfig
--- linux-2.6.34-rc3/block/Kconfig	2010-04-13 02:18:55.583570654 +0000
+++ linux-2.6.34-rc4/block/Kconfig	2010-04-13 02:19:00.676633042 +0000
@@ -78,8 +78,9 @@
 	Protection.  If in doubt, say N.
 
 config BLK_CGROUP
-	tristate
+	tristate "Block cgroup support"
 	depends on CGROUPS
+	depends on CFQ_GROUP_IOSCHED
 	default n
 	---help---
 	Generic block IO controller cgroup interface. This is the common
diff -urN linux-2.6.34-rc3/block/blk-barrier.c linux-2.6.34-rc4/block/blk-barrier.c
--- linux-2.6.34-rc3/block/blk-barrier.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/block/blk-barrier.c	2010-04-13 02:19:00.676633042 +0000
@@ -5,6 +5,7 @@
 #include <linux/module.h>
 #include <linux/bio.h>
 #include <linux/blkdev.h>
+#include <linux/gfp.h>
 
 #include "blk.h"
 
diff -urN linux-2.6.34-rc3/block/blk-cgroup.c linux-2.6.34-rc4/block/blk-cgroup.c
--- linux-2.6.34-rc3/block/blk-cgroup.c	2010-04-13 02:18:55.583570654 +0000
+++ linux-2.6.34-rc4/block/blk-cgroup.c	2010-04-13 02:19:00.676633042 +0000
@@ -15,6 +15,7 @@
 #include <linux/kdev_t.h>
 #include <linux/module.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include "blk-cgroup.h"
 
 static DEFINE_SPINLOCK(blkio_list_lock);
diff -urN linux-2.6.34-rc3/block/blk-integrity.c linux-2.6.34-rc4/block/blk-integrity.c
--- linux-2.6.34-rc3/block/blk-integrity.c	2010-04-13 02:18:55.584570485 +0000
+++ linux-2.6.34-rc4/block/blk-integrity.c	2010-04-13 02:19:00.677633083 +0000
@@ -24,6 +24,7 @@
 #include <linux/mempool.h>
 #include <linux/bio.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include "blk.h"
 
diff -urN linux-2.6.34-rc3/block/blk-ioc.c linux-2.6.34-rc4/block/blk-ioc.c
--- linux-2.6.34-rc3/block/blk-ioc.c	2010-04-13 02:18:55.584570485 +0000
+++ linux-2.6.34-rc4/block/blk-ioc.c	2010-04-13 02:19:00.677633083 +0000
@@ -7,6 +7,7 @@
 #include <linux/bio.h>
 #include <linux/blkdev.h>
 #include <linux/bootmem.h>	/* for max_pfn/max_low_pfn */
+#include <linux/slab.h>
 
 #include "blk.h"
 
diff -urN linux-2.6.34-rc3/block/blk-settings.c linux-2.6.34-rc4/block/blk-settings.c
--- linux-2.6.34-rc3/block/blk-settings.c	2010-04-13 02:18:55.584570485 +0000
+++ linux-2.6.34-rc4/block/blk-settings.c	2010-04-13 02:19:00.677633083 +0000
@@ -8,7 +8,9 @@
 #include <linux/blkdev.h>
 #include <linux/bootmem.h>	/* for max_pfn/max_low_pfn */
 #include <linux/gcd.h>
+#include <linux/lcm.h>
 #include <linux/jiffies.h>
+#include <linux/gfp.h>
 
 #include "blk.h"
 
@@ -461,16 +463,6 @@
 }
 EXPORT_SYMBOL(blk_queue_stack_limits);
 
-static unsigned int lcm(unsigned int a, unsigned int b)
-{
-	if (a && b)
-		return (a * b) / gcd(a, b);
-	else if (b)
-		return b;
-
-	return a;
-}
-
 /**
  * blk_stack_limits - adjust queue_limits for stacked devices
  * @t:	the stacking driver limits (top device)
diff -urN linux-2.6.34-rc3/block/blk-sysfs.c linux-2.6.34-rc4/block/blk-sysfs.c
--- linux-2.6.34-rc3/block/blk-sysfs.c	2010-04-13 02:18:55.584570485 +0000
+++ linux-2.6.34-rc4/block/blk-sysfs.c	2010-04-13 02:19:00.677633083 +0000
@@ -2,6 +2,7 @@
  * Functions related to sysfs handling
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/bio.h>
 #include <linux/blkdev.h>
@@ -106,6 +107,19 @@
 	return queue_var_show(max_sectors_kb, (page));
 }
 
+static ssize_t queue_max_segments_show(struct request_queue *q, char *page)
+{
+	return queue_var_show(queue_max_segments(q), (page));
+}
+
+static ssize_t queue_max_segment_size_show(struct request_queue *q, char *page)
+{
+	if (test_bit(QUEUE_FLAG_CLUSTER, &q->queue_flags))
+		return queue_var_show(queue_max_segment_size(q), (page));
+
+	return queue_var_show(PAGE_CACHE_SIZE, (page));
+}
+
 static ssize_t queue_logical_block_size_show(struct request_queue *q, char *page)
 {
 	return queue_var_show(queue_logical_block_size(q), page);
@@ -280,6 +294,16 @@
 	.show = queue_max_hw_sectors_show,
 };
 
+static struct queue_sysfs_entry queue_max_segments_entry = {
+	.attr = {.name = "max_segments", .mode = S_IRUGO },
+	.show = queue_max_segments_show,
+};
+
+static struct queue_sysfs_entry queue_max_segment_size_entry = {
+	.attr = {.name = "max_segment_size", .mode = S_IRUGO },
+	.show = queue_max_segment_size_show,
+};
+
 static struct queue_sysfs_entry queue_iosched_entry = {
 	.attr = {.name = "scheduler", .mode = S_IRUGO | S_IWUSR },
 	.show = elv_iosched_show,
@@ -355,6 +379,8 @@
 	&queue_ra_entry.attr,
 	&queue_max_hw_sectors_entry.attr,
 	&queue_max_sectors_entry.attr,
+	&queue_max_segments_entry.attr,
+	&queue_max_segment_size_entry.attr,
 	&queue_iosched_entry.attr,
 	&queue_hw_sector_size_entry.attr,
 	&queue_logical_block_size_entry.attr,
diff -urN linux-2.6.34-rc3/block/blk-tag.c linux-2.6.34-rc4/block/blk-tag.c
--- linux-2.6.34-rc3/block/blk-tag.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/block/blk-tag.c	2010-04-13 02:19:00.677633083 +0000
@@ -5,6 +5,7 @@
 #include <linux/module.h>
 #include <linux/bio.h>
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 
 #include "blk.h"
 
diff -urN linux-2.6.34-rc3/block/bsg.c linux-2.6.34-rc4/block/bsg.c
--- linux-2.6.34-rc3/block/bsg.c	2010-04-13 02:18:55.584570485 +0000
+++ linux-2.6.34-rc4/block/bsg.c	2010-04-13 02:19:00.678633049 +0000
@@ -21,6 +21,7 @@
 #include <linux/idr.h>
 #include <linux/bsg.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_ioctl.h>
diff -urN linux-2.6.34-rc3/block/cfq-iosched.c linux-2.6.34-rc4/block/cfq-iosched.c
--- linux-2.6.34-rc3/block/cfq-iosched.c	2010-04-13 02:18:55.585633082 +0000
+++ linux-2.6.34-rc4/block/cfq-iosched.c	2010-04-13 02:19:00.678633049 +0000
@@ -7,6 +7,7 @@
  *  Copyright (C) 2003 Jens Axboe <axboe@kernel.dk>
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/elevator.h>
 #include <linux/jiffies.h>
@@ -47,6 +48,7 @@
 #define CFQ_SERVICE_SHIFT       12
 
 #define CFQQ_SEEK_THR		(sector_t)(8 * 100)
+#define CFQQ_CLOSE_THR		(sector_t)(8 * 1024)
 #define CFQQ_SECT_THR_NONROT	(sector_t)(2 * 32)
 #define CFQQ_SEEKY(cfqq)	(hweight32(cfqq->seek_history) > 32/8)
 
@@ -947,6 +949,11 @@
 	unsigned int major, minor;
 
 	cfqg = cfqg_of_blkg(blkiocg_lookup_group(blkcg, key));
+	if (cfqg && !cfqg->blkg.dev && bdi->dev && dev_name(bdi->dev)) {
+		sscanf(dev_name(bdi->dev), "%u:%u", &major, &minor);
+		cfqg->blkg.dev = MKDEV(major, minor);
+		goto done;
+	}
 	if (cfqg || !create)
 		goto done;
 
@@ -1517,7 +1524,8 @@
 				   struct cfq_queue *cfqq)
 {
 	if (cfqq) {
-		cfq_log_cfqq(cfqd, cfqq, "set_active");
+		cfq_log_cfqq(cfqd, cfqq, "set_active wl_prio:%d wl_type:%d",
+				cfqd->serving_prio, cfqd->serving_type);
 		cfqq->slice_start = 0;
 		cfqq->dispatch_start = jiffies;
 		cfqq->allocated_slice = 0;
@@ -1660,9 +1668,9 @@
 }
 
 static inline int cfq_rq_close(struct cfq_data *cfqd, struct cfq_queue *cfqq,
-			       struct request *rq, bool for_preempt)
+			       struct request *rq)
 {
-	return cfq_dist_from_last(cfqd, rq) <= CFQQ_SEEK_THR;
+	return cfq_dist_from_last(cfqd, rq) <= CFQQ_CLOSE_THR;
 }
 
 static struct cfq_queue *cfqq_close(struct cfq_data *cfqd,
@@ -1689,7 +1697,7 @@
 	 * will contain the closest sector.
 	 */
 	__cfqq = rb_entry(parent, struct cfq_queue, p_node);
-	if (cfq_rq_close(cfqd, cur_cfqq, __cfqq->next_rq, false))
+	if (cfq_rq_close(cfqd, cur_cfqq, __cfqq->next_rq))
 		return __cfqq;
 
 	if (blk_rq_pos(__cfqq->next_rq) < sector)
@@ -1700,7 +1708,7 @@
 		return NULL;
 
 	__cfqq = rb_entry(node, struct cfq_queue, p_node);
-	if (cfq_rq_close(cfqd, cur_cfqq, __cfqq->next_rq, false))
+	if (cfq_rq_close(cfqd, cur_cfqq, __cfqq->next_rq))
 		return __cfqq;
 
 	return NULL;
@@ -1721,6 +1729,8 @@
 {
 	struct cfq_queue *cfqq;
 
+	if (cfq_class_idle(cur_cfqq))
+		return NULL;
 	if (!cfq_cfqq_sync(cur_cfqq))
 		return NULL;
 	if (CFQQ_SEEKY(cur_cfqq))
@@ -1787,7 +1797,11 @@
 	 * Otherwise, we do only if they are the last ones
 	 * in their service tree.
 	 */
-	return service_tree->count == 1 && cfq_cfqq_sync(cfqq);
+	if (service_tree->count == 1 && cfq_cfqq_sync(cfqq))
+		return 1;
+	cfq_log_cfqq(cfqd, cfqq, "Not idling. st->count:%d",
+			service_tree->count);
+	return 0;
 }
 
 static void cfq_arm_slice_timer(struct cfq_data *cfqd)
@@ -1832,8 +1846,11 @@
 	 * time slice.
 	 */
 	if (sample_valid(cic->ttime_samples) &&
-	    (cfqq->slice_end - jiffies < cic->ttime_mean))
+	    (cfqq->slice_end - jiffies < cic->ttime_mean)) {
+		cfq_log_cfqq(cfqd, cfqq, "Not idling. think_time:%d",
+				cic->ttime_mean);
 		return;
+	}
 
 	cfq_mark_cfqq_wait_request(cfqq);
 
@@ -2041,6 +2058,7 @@
 		slice = max(slice, 2 * cfqd->cfq_slice_idle);
 
 	slice = max_t(unsigned, slice, CFQ_MIN_TT);
+	cfq_log(cfqd, "workload slice:%d", slice);
 	cfqd->workload_expires = jiffies + slice;
 	cfqd->noidle_tree_requires_idle = false;
 }
@@ -2188,10 +2206,13 @@
 	struct cfq_queue *cfqq;
 	int dispatched = 0;
 
-	while ((cfqq = cfq_get_next_queue_forced(cfqd)) != NULL)
+	/* Expire the timeslice of the current active queue first */
+	cfq_slice_expired(cfqd, 0);
+	while ((cfqq = cfq_get_next_queue_forced(cfqd)) != NULL) {
+		__cfq_set_active_queue(cfqd, cfqq);
 		dispatched += __cfq_forced_dispatch_cfqq(cfqq);
+	}
 
-	cfq_slice_expired(cfqd, 0);
 	BUG_ON(cfqd->busy_queues);
 
 	cfq_log(cfqd, "forced_dispatch=%d", dispatched);
@@ -3103,7 +3124,7 @@
 	 * if this request is as-good as one we would expect from the
 	 * current cfqq, let it preempt
 	 */
-	if (cfq_rq_close(cfqd, cfqq, rq, true))
+	if (cfq_rq_close(cfqd, cfqq, rq))
 		return true;
 
 	return false;
@@ -3307,6 +3328,7 @@
 		if (cfq_should_wait_busy(cfqd, cfqq)) {
 			cfqq->slice_end = jiffies + cfqd->cfq_slice_idle;
 			cfq_mark_cfqq_wait_busy(cfqq);
+			cfq_log_cfqq(cfqd, cfqq, "will busy wait");
 		}
 
 		/*
diff -urN linux-2.6.34-rc3/block/compat_ioctl.c linux-2.6.34-rc4/block/compat_ioctl.c
--- linux-2.6.34-rc3/block/compat_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/block/compat_ioctl.c	2010-04-13 02:19:00.679633027 +0000
@@ -6,6 +6,7 @@
 #include <linux/elevator.h>
 #include <linux/fd.h>
 #include <linux/hdreg.h>
+#include <linux/slab.h>
 #include <linux/syscalls.h>
 #include <linux/smp_lock.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/block/elevator.c linux-2.6.34-rc4/block/elevator.c
--- linux-2.6.34-rc3/block/elevator.c	2010-04-13 02:18:55.585633082 +0000
+++ linux-2.6.34-rc4/block/elevator.c	2010-04-13 02:19:00.679633027 +0000
@@ -154,7 +154,7 @@
 
 		spin_unlock(&elv_list_lock);
 
-		sprintf(elv, "%s-iosched", name);
+		snprintf(elv, sizeof(elv), "%s-iosched", name);
 
 		request_module("%s", elv);
 		spin_lock(&elv_list_lock);
diff -urN linux-2.6.34-rc3/block/ioctl.c linux-2.6.34-rc4/block/ioctl.c
--- linux-2.6.34-rc3/block/ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/block/ioctl.c	2010-04-13 02:19:00.679633027 +0000
@@ -1,5 +1,6 @@
 #include <linux/capability.h>
 #include <linux/blkdev.h>
+#include <linux/gfp.h>
 #include <linux/blkpg.h>
 #include <linux/hdreg.h>
 #include <linux/backing-dev.h>
diff -urN linux-2.6.34-rc3/block/noop-iosched.c linux-2.6.34-rc4/block/noop-iosched.c
--- linux-2.6.34-rc3/block/noop-iosched.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/block/noop-iosched.c	2010-04-13 02:19:00.679633027 +0000
@@ -5,6 +5,7 @@
 #include <linux/elevator.h>
 #include <linux/bio.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 struct noop_data {
diff -urN linux-2.6.34-rc3/crypto/algapi.c linux-2.6.34-rc4/crypto/algapi.c
--- linux-2.6.34-rc3/crypto/algapi.c	2010-04-13 02:18:55.586633136 +0000
+++ linux-2.6.34-rc4/crypto/algapi.c	2010-04-13 02:19:00.680633068 +0000
@@ -17,6 +17,7 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #include "internal.h"
diff -urN linux-2.6.34-rc3/crypto/algboss.c linux-2.6.34-rc4/crypto/algboss.c
--- linux-2.6.34-rc3/crypto/algboss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/algboss.c	2010-04-13 02:19:00.680633068 +0000
@@ -19,6 +19,7 @@
 #include <linux/notifier.h>
 #include <linux/rtnetlink.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #include "internal.h"
diff -urN linux-2.6.34-rc3/crypto/async_tx/async_pq.c linux-2.6.34-rc4/crypto/async_tx/async_pq.c
--- linux-2.6.34-rc3/crypto/async_tx/async_pq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/async_tx/async_pq.c	2010-04-13 02:19:00.680633068 +0000
@@ -24,6 +24,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/raid/pq.h>
 #include <linux/async_tx.h>
+#include <linux/gfp.h>
 
 /**
  * pq_scribble_page - space to hold throwaway P or Q buffer for
diff -urN linux-2.6.34-rc3/crypto/async_tx/raid6test.c linux-2.6.34-rc4/crypto/async_tx/raid6test.c
--- linux-2.6.34-rc3/crypto/async_tx/raid6test.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/async_tx/raid6test.c	2010-04-13 02:19:00.680633068 +0000
@@ -20,6 +20,7 @@
  *
  */
 #include <linux/async_tx.h>
+#include <linux/gfp.h>
 #include <linux/random.h>
 
 #undef pr
diff -urN linux-2.6.34-rc3/crypto/hmac.c linux-2.6.34-rc4/crypto/hmac.c
--- linux-2.6.34-rc3/crypto/hmac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/hmac.c	2010-04-13 02:19:00.683633056 +0000
@@ -23,7 +23,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/scatterlist.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 
 struct hmac_ctx {
diff -urN linux-2.6.34-rc3/crypto/rng.c linux-2.6.34-rc4/crypto/rng.c
--- linux-2.6.34-rc3/crypto/rng.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/rng.c	2010-04-13 02:19:00.684633028 +0000
@@ -19,6 +19,7 @@
 #include <linux/mutex.h>
 #include <linux/random.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 static DEFINE_MUTEX(crypto_default_rng_lock);
diff -urN linux-2.6.34-rc3/crypto/seqiv.c linux-2.6.34-rc4/crypto/seqiv.c
--- linux-2.6.34-rc3/crypto/seqiv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/seqiv.c	2010-04-13 02:19:00.684633028 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 
diff -urN linux-2.6.34-rc3/crypto/tcrypt.c linux-2.6.34-rc4/crypto/tcrypt.c
--- linux-2.6.34-rc3/crypto/tcrypt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/tcrypt.c	2010-04-13 02:19:00.684633028 +0000
@@ -18,8 +18,8 @@
 #include <crypto/hash.h>
 #include <linux/err.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/scatterlist.h>
 #include <linux/string.h>
 #include <linux/moduleparam.h>
diff -urN linux-2.6.34-rc3/crypto/xor.c linux-2.6.34-rc4/crypto/xor.c
--- linux-2.6.34-rc3/crypto/xor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/crypto/xor.c	2010-04-13 02:19:00.684633028 +0000
@@ -18,6 +18,7 @@
 
 #define BH_TRACE 0
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/raid/xor.h>
 #include <linux/jiffies.h>
 #include <asm/xor.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/ac.c linux-2.6.34-rc4/drivers/acpi/ac.c
--- linux-2.6.34-rc3/drivers/acpi/ac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/ac.c	2010-04-13 02:19:00.685633081 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #ifdef CONFIG_ACPI_PROCFS_POWER
diff -urN linux-2.6.34-rc3/drivers/acpi/acpi_memhotplug.c linux-2.6.34-rc4/drivers/acpi/acpi_memhotplug.c
--- linux-2.6.34-rc3/drivers/acpi/acpi_memhotplug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/acpi_memhotplug.c	2010-04-13 02:19:00.685633081 +0000
@@ -30,6 +30,7 @@
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/memory_hotplug.h>
+#include <linux/slab.h>
 #include <acpi/acpi_drivers.h>
 
 #define ACPI_MEMORY_DEVICE_CLASS		"memory"
diff -urN linux-2.6.34-rc3/drivers/acpi/acpi_pad.c linux-2.6.34-rc4/drivers/acpi/acpi_pad.c
--- linux-2.6.34-rc3/drivers/acpi/acpi_pad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/acpi_pad.c	2010-04-13 02:19:00.685633081 +0000
@@ -27,6 +27,7 @@
 #include <linux/freezer.h>
 #include <linux/cpu.h>
 #include <linux/clockchips.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/acpica/evgpe.c linux-2.6.34-rc4/drivers/acpi/acpica/evgpe.c
--- linux-2.6.34-rc3/drivers/acpi/acpica/evgpe.c	2010-04-13 02:18:55.595633020 +0000
+++ linux-2.6.34-rc4/drivers/acpi/acpica/evgpe.c	2010-04-13 02:19:00.689633086 +0000
@@ -117,19 +117,14 @@
 	if (ACPI_FAILURE(status))
 		return_ACPI_STATUS(status);
 
-	/* Mark wake-enabled or HW enable, or both */
-
-	if (gpe_event_info->runtime_count) {
-		/* Clear the GPE (of stale events), then enable it */
-		status = acpi_hw_clear_gpe(gpe_event_info);
-		if (ACPI_FAILURE(status))
-			return_ACPI_STATUS(status);
-
-		/* Enable the requested runtime GPE */
-		status = acpi_hw_write_gpe_enable_reg(gpe_event_info);
-	}
+	/* Clear the GPE (of stale events), then enable it */
+	status = acpi_hw_clear_gpe(gpe_event_info);
+	if (ACPI_FAILURE(status))
+		return_ACPI_STATUS(status);
 
-	return_ACPI_STATUS(AE_OK);
+	/* Enable the requested GPE */
+	status = acpi_hw_write_gpe_enable_reg(gpe_event_info);
+	return_ACPI_STATUS(status);
 }
 
 /*******************************************************************************
diff -urN linux-2.6.34-rc3/drivers/acpi/acpica/exprep.c linux-2.6.34-rc4/drivers/acpi/acpica/exprep.c
--- linux-2.6.34-rc3/drivers/acpi/acpica/exprep.c	2010-04-13 02:18:55.599571666 +0000
+++ linux-2.6.34-rc4/drivers/acpi/acpica/exprep.c	2010-04-13 02:19:00.693633059 +0000
@@ -468,6 +468,18 @@
 
 		acpi_ut_add_reference(obj_desc->field.region_obj);
 
+		/* allow full data read from EC address space */
+		if (obj_desc->field.region_obj->region.space_id ==
+			ACPI_ADR_SPACE_EC) {
+			if (obj_desc->common_field.bit_length > 8)
+				obj_desc->common_field.access_bit_width =
+				ACPI_ROUND_UP(obj_desc->common_field.
+							bit_length, 8);
+				obj_desc->common_field.access_byte_width =
+				ACPI_DIV_8(obj_desc->common_field.
+							access_bit_width);
+		}
+
 		ACPI_DEBUG_PRINT((ACPI_DB_BFIELD,
 				  "RegionField: BitOff %X, Off %X, Gran %X, Region %p\n",
 				  obj_desc->field.start_field_bit_offset,
diff -urN linux-2.6.34-rc3/drivers/acpi/battery.c linux-2.6.34-rc4/drivers/acpi/battery.c
--- linux-2.6.34-rc3/drivers/acpi/battery.c	2010-04-13 02:18:55.609571640 +0000
+++ linux-2.6.34-rc4/drivers/acpi/battery.c	2010-04-13 02:19:00.703633046 +0000
@@ -32,6 +32,7 @@
 #include <linux/jiffies.h>
 #include <linux/async.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_ACPI_PROCFS_POWER
 #include <linux/proc_fs.h>
@@ -567,13 +568,13 @@
 	result = acpi_battery_get_status(battery);
 	if (result)
 		return result;
-#ifdef CONFIG_ACPI_SYSFS_POWER
 	if (!acpi_battery_present(battery)) {
+#ifdef CONFIG_ACPI_SYSFS_POWER
 		sysfs_remove_battery(battery);
+#endif
 		battery->update_time = 0;
 		return 0;
 	}
-#endif
 	if (!battery->update_time ||
 	    old_present != acpi_battery_present(battery)) {
 		result = acpi_battery_get_info(battery);
@@ -879,7 +880,7 @@
 #ifdef CONFIG_ACPI_SYSFS_POWER
 	/* acpi_battery_update could remove power_supply object */
 	if (battery->bat.dev)
-		kobject_uevent(&battery->bat.dev->kobj, KOBJ_CHANGE);
+		power_supply_changed(&battery->bat);
 #endif
 }
 
diff -urN linux-2.6.34-rc3/drivers/acpi/bus.c linux-2.6.34-rc4/drivers/acpi/bus.c
--- linux-2.6.34-rc3/drivers/acpi/bus.c	2010-04-13 02:18:55.609571640 +0000
+++ linux-2.6.34-rc4/drivers/acpi/bus.c	2010-04-13 02:19:00.703633046 +0000
@@ -32,6 +32,7 @@
 #include <linux/device.h>
 #include <linux/proc_fs.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #ifdef CONFIG_X86
 #include <asm/mpspec.h>
 #endif
diff -urN linux-2.6.34-rc3/drivers/acpi/button.c linux-2.6.34-rc4/drivers/acpi/button.c
--- linux-2.6.34-rc3/drivers/acpi/button.c	2010-04-13 02:18:55.609571640 +0000
+++ linux-2.6.34-rc4/drivers/acpi/button.c	2010-04-13 02:19:00.703633046 +0000
@@ -30,6 +30,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/container.c linux-2.6.34-rc4/drivers/acpi/container.c
--- linux-2.6.34-rc3/drivers/acpi/container.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/container.c	2010-04-13 02:19:00.703633046 +0000
@@ -29,6 +29,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/acpi.h>
 #include <acpi/acpi_bus.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/debug.c linux-2.6.34-rc4/drivers/acpi/debug.c
--- linux-2.6.34-rc3/drivers/acpi/debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/debug.c	2010-04-13 02:19:00.704633075 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/moduleparam.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/dock.c linux-2.6.34-rc4/drivers/acpi/dock.c
--- linux-2.6.34-rc3/drivers/acpi/dock.c	2010-04-13 02:18:55.609571640 +0000
+++ linux-2.6.34-rc4/drivers/acpi/dock.c	2010-04-13 02:19:00.704633075 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/notifier.h>
@@ -1025,13 +1026,10 @@
 static acpi_status
 find_dock(acpi_handle handle, u32 lvl, void *context, void **rv)
 {
-	acpi_status status = AE_OK;
-
 	if (is_dock(handle))
-		if (dock_add(handle) >= 0)
-			status = AE_CTRL_TERMINATE;
+		dock_add(handle);
 
-	return status;
+	return AE_OK;
 }
 
 static acpi_status
diff -urN linux-2.6.34-rc3/drivers/acpi/ec.c linux-2.6.34-rc4/drivers/acpi/ec.c
--- linux-2.6.34-rc3/drivers/acpi/ec.c	2010-04-13 02:18:55.610570548 +0000
+++ linux-2.6.34-rc4/drivers/acpi/ec.c	2010-04-13 02:19:00.704633075 +0000
@@ -39,6 +39,7 @@
 #include <linux/interrupt.h>
 #include <linux/list.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
@@ -628,12 +629,12 @@
 
 static acpi_status
 acpi_ec_space_handler(u32 function, acpi_physical_address address,
-		      u32 bits, u64 *value,
+		      u32 bits, u64 *value64,
 		      void *handler_context, void *region_context)
 {
 	struct acpi_ec *ec = handler_context;
-	int result = 0, i;
-	u8 temp = 0;
+	int result = 0, i, bytes = bits / 8;
+	u8 *value = (u8 *)value64;
 
 	if ((address > 0xFF) || !value || !handler_context)
 		return AE_BAD_PARAMETER;
@@ -641,32 +642,15 @@
 	if (function != ACPI_READ && function != ACPI_WRITE)
 		return AE_BAD_PARAMETER;
 
-	if (bits != 8 && acpi_strict)
-		return AE_BAD_PARAMETER;
-
-	if (EC_FLAGS_MSI)
+	if (EC_FLAGS_MSI || bits > 8)
 		acpi_ec_burst_enable(ec);
 
-	if (function == ACPI_READ) {
-		result = acpi_ec_read(ec, address, &temp);
-		*value = temp;
-	} else {
-		temp = 0xff & (*value);
-		result = acpi_ec_write(ec, address, temp);
-	}
-
-	for (i = 8; unlikely(bits - i > 0); i += 8) {
-		++address;
-		if (function == ACPI_READ) {
-			result = acpi_ec_read(ec, address, &temp);
-			(*value) |= ((u64)temp) << i;
-		} else {
-			temp = 0xff & ((*value) >> i);
-			result = acpi_ec_write(ec, address, temp);
-		}
-	}
+	for (i = 0; i < bytes; ++i, ++address, ++value)
+		result = (function == ACPI_READ) ?
+			acpi_ec_read(ec, address, value) :
+			acpi_ec_write(ec, address, *value);
 
-	if (EC_FLAGS_MSI)
+	if (EC_FLAGS_MSI || bits > 8)
 		acpi_ec_burst_disable(ec);
 
 	switch (result) {
diff -urN linux-2.6.34-rc3/drivers/acpi/event.c linux-2.6.34-rc4/drivers/acpi/event.c
--- linux-2.6.34-rc3/drivers/acpi/event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/event.c	2010-04-13 02:19:00.704633075 +0000
@@ -10,6 +10,7 @@
 #include <linux/proc_fs.h>
 #include <linux/init.h>
 #include <linux/poll.h>
+#include <linux/gfp.h>
 #include <acpi/acpi_drivers.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/glue.c linux-2.6.34-rc4/drivers/acpi/glue.c
--- linux-2.6.34-rc3/drivers/acpi/glue.c	2010-04-13 02:18:55.610570548 +0000
+++ linux-2.6.34-rc4/drivers/acpi/glue.c	2010-04-13 02:19:00.704633075 +0000
@@ -9,6 +9,7 @@
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/rwsem.h>
 #include <linux/acpi.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/numa.c linux-2.6.34-rc4/drivers/acpi/numa.c
--- linux-2.6.34-rc3/drivers/acpi/numa.c	2010-04-13 02:18:55.610570548 +0000
+++ linux-2.6.34-rc4/drivers/acpi/numa.c	2010-04-13 02:19:00.704633075 +0000
@@ -61,8 +61,10 @@
 
 void __acpi_map_pxm_to_node(int pxm, int node)
 {
-	pxm_to_node_map[pxm] = node;
-	node_to_pxm_map[node] = pxm;
+	if (pxm_to_node_map[pxm] == NUMA_NO_NODE || node < pxm_to_node_map[pxm])
+		pxm_to_node_map[pxm] = node;
+	if (node_to_pxm_map[node] == PXM_INVAL || pxm < node_to_pxm_map[node])
+		node_to_pxm_map[node] = pxm;
 }
 
 int acpi_map_pxm_to_node(int pxm)
diff -urN linux-2.6.34-rc3/drivers/acpi/osl.c linux-2.6.34-rc4/drivers/acpi/osl.c
--- linux-2.6.34-rc3/drivers/acpi/osl.c	2010-04-13 02:18:55.610570548 +0000
+++ linux-2.6.34-rc4/drivers/acpi/osl.c	2010-04-13 02:19:00.705633086 +0000
@@ -758,7 +758,14 @@
 	queue = hp ? kacpi_hotplug_wq :
 		(type == OSL_NOTIFY_HANDLER ? kacpi_notify_wq : kacpid_wq);
 	dpc->wait = hp ? 1 : 0;
-	INIT_WORK(&dpc->work, acpi_os_execute_deferred);
+
+	if (queue == kacpi_hotplug_wq)
+		INIT_WORK(&dpc->work, acpi_os_execute_deferred);
+	else if (queue == kacpi_notify_wq)
+		INIT_WORK(&dpc->work, acpi_os_execute_deferred);
+	else
+		INIT_WORK(&dpc->work, acpi_os_execute_deferred);
+
 	ret = queue_work(queue, &dpc->work);
 
 	if (!ret) {
@@ -1151,16 +1158,10 @@
 
 	if (clash) {
 		if (acpi_enforce_resources != ENFORCE_RESOURCES_NO) {
-			printk("%sACPI: %s resource %s [0x%llx-0x%llx]"
-			       " conflicts with ACPI region %s"
-			       " [0x%llx-0x%llx]\n",
-			       acpi_enforce_resources == ENFORCE_RESOURCES_LAX
-			       ? KERN_WARNING : KERN_ERR,
-			       ioport ? "I/O" : "Memory", res->name,
-			       (long long) res->start, (long long) res->end,
-			       res_list_elem->name,
-			       (long long) res_list_elem->start,
-			       (long long) res_list_elem->end);
+			printk(KERN_WARNING "ACPI: resource %s %pR"
+			       " conflicts with ACPI region %s %pR\n",
+			       res->name, res, res_list_elem->name,
+			       res_list_elem);
 			if (acpi_enforce_resources == ENFORCE_RESOURCES_LAX)
 				printk(KERN_NOTICE "ACPI: This conflict may"
 				       " cause random problems and system"
diff -urN linux-2.6.34-rc3/drivers/acpi/pci_irq.c linux-2.6.34-rc4/drivers/acpi/pci_irq.c
--- linux-2.6.34-rc3/drivers/acpi/pci_irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/pci_irq.c	2010-04-13 02:19:00.705633086 +0000
@@ -37,6 +37,7 @@
 #include <linux/pm.h>
 #include <linux/pci.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/pci_link.c linux-2.6.34-rc4/drivers/acpi/pci_link.c
--- linux-2.6.34-rc3/drivers/acpi/pci_link.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/pci_link.c	2010-04-13 02:19:00.705633086 +0000
@@ -39,6 +39,7 @@
 #include <linux/pm.h>
 #include <linux/pci.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/pci_root.c linux-2.6.34-rc4/drivers/acpi/pci_root.c
--- linux-2.6.34-rc3/drivers/acpi/pci_root.c	2010-04-13 02:18:55.610570548 +0000
+++ linux-2.6.34-rc4/drivers/acpi/pci_root.c	2010-04-13 02:19:00.705633086 +0000
@@ -34,6 +34,7 @@
 #include <linux/pci.h>
 #include <linux/pci-acpi.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/acpi/pci_slot.c linux-2.6.34-rc4/drivers/acpi/pci_slot.c
--- linux-2.6.34-rc3/drivers/acpi/pci_slot.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/pci_slot.c	2010-04-13 02:19:00.705633086 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/acpi.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/power.c linux-2.6.34-rc4/drivers/acpi/power.c
--- linux-2.6.34-rc3/drivers/acpi/power.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/power.c	2010-04-13 02:19:00.705633086 +0000
@@ -39,6 +39,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <acpi/acpi_bus.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/power_meter.c linux-2.6.34-rc4/drivers/acpi/power_meter.c
--- linux-2.6.34-rc3/drivers/acpi/power_meter.c	2010-04-13 02:18:55.611570622 +0000
+++ linux-2.6.34-rc4/drivers/acpi/power_meter.c	2010-04-13 02:19:00.706633034 +0000
@@ -25,6 +25,7 @@
 #include <linux/jiffies.h>
 #include <linux/mutex.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 #include <linux/kdev_t.h>
 #include <linux/sched.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/processor_core.c linux-2.6.34-rc4/drivers/acpi/processor_core.c
--- linux-2.6.34-rc3/drivers/acpi/processor_core.c	2010-04-13 02:18:55.611570622 +0000
+++ linux-2.6.34-rc4/drivers/acpi/processor_core.c	2010-04-13 02:19:00.706633034 +0000
@@ -8,6 +8,7 @@
  *	- Added _PDC for platforms with Intel CPUs
  */
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #include <acpi/acpi_drivers.h>
 #include <acpi/processor.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/processor_driver.c linux-2.6.34-rc4/drivers/acpi/processor_driver.c
--- linux-2.6.34-rc3/drivers/acpi/processor_driver.c	2010-04-13 02:18:55.612633033 +0000
+++ linux-2.6.34-rc4/drivers/acpi/processor_driver.c	2010-04-13 02:19:00.707633069 +0000
@@ -45,6 +45,7 @@
 #include <linux/dmi.h>
 #include <linux/moduleparam.h>
 #include <linux/cpuidle.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/processor_idle.c linux-2.6.34-rc4/drivers/acpi/processor_idle.c
--- linux-2.6.34-rc3/drivers/acpi/processor_idle.c	2010-04-13 02:18:55.612633033 +0000
+++ linux-2.6.34-rc4/drivers/acpi/processor_idle.c	2010-04-13 02:19:00.707633069 +0000
@@ -32,6 +32,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/acpi.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/processor_perflib.c linux-2.6.34-rc4/drivers/acpi/processor_perflib.c
--- linux-2.6.34-rc3/drivers/acpi/processor_perflib.c	2010-04-13 02:18:55.613633084 +0000
+++ linux-2.6.34-rc4/drivers/acpi/processor_perflib.c	2010-04-13 02:19:00.708633080 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_X86
 #include <asm/cpufeature.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/processor_throttling.c linux-2.6.34-rc4/drivers/acpi/processor_throttling.c
--- linux-2.6.34-rc3/drivers/acpi/processor_throttling.c	2010-04-13 02:18:55.614633063 +0000
+++ linux-2.6.34-rc4/drivers/acpi/processor_throttling.c	2010-04-13 02:19:00.708633080 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include <linux/cpufreq.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/sbs.c linux-2.6.34-rc4/drivers/acpi/sbs.c
--- linux-2.6.34-rc3/drivers/acpi/sbs.c	2010-04-13 02:18:55.614633063 +0000
+++ linux-2.6.34-rc4/drivers/acpi/sbs.c	2010-04-13 02:19:00.708633080 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/sbshc.c linux-2.6.34-rc4/drivers/acpi/sbshc.c
--- linux-2.6.34-rc3/drivers/acpi/sbshc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/acpi/sbshc.c	2010-04-13 02:19:00.709633052 +0000
@@ -11,6 +11,7 @@
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include "sbshc.h"
diff -urN linux-2.6.34-rc3/drivers/acpi/scan.c linux-2.6.34-rc4/drivers/acpi/scan.c
--- linux-2.6.34-rc3/drivers/acpi/scan.c	2010-04-13 02:18:55.614633063 +0000
+++ linux-2.6.34-rc4/drivers/acpi/scan.c	2010-04-13 02:19:00.709633052 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/acpi.h>
 #include <linux/signal.h>
@@ -1080,12 +1081,6 @@
 		if (ACPI_IS_ROOT_DEVICE(device)) {
 			acpi_add_id(device, ACPI_SYSTEM_HID);
 			break;
-		} else if (ACPI_IS_ROOT_DEVICE(device->parent)) {
-			/* \_SB_, the only root-level namespace device */
-			acpi_add_id(device, ACPI_BUS_HID);
-			strcpy(device->pnp.device_name, ACPI_BUS_DEVICE_NAME);
-			strcpy(device->pnp.device_class, ACPI_BUS_CLASS);
-			break;
 		}
 
 		status = acpi_get_object_info(device->handle, &info);
@@ -1120,6 +1115,12 @@
 			acpi_add_id(device, ACPI_DOCK_HID);
 		else if (!acpi_ibm_smbus_match(device))
 			acpi_add_id(device, ACPI_SMBUS_IBM_HID);
+		else if (!acpi_device_hid(device) &&
+			 ACPI_IS_ROOT_DEVICE(device->parent)) {
+			acpi_add_id(device, ACPI_BUS_HID); /* \_SB, LNXSYBUS */
+			strcpy(device->pnp.device_name, ACPI_BUS_DEVICE_NAME);
+			strcpy(device->pnp.device_class, ACPI_BUS_CLASS);
+		}
 
 		break;
 	case ACPI_BUS_TYPE_POWER:
diff -urN linux-2.6.34-rc3/drivers/acpi/system.c linux-2.6.34-rc4/drivers/acpi/system.c
--- linux-2.6.34-rc3/drivers/acpi/system.c	2010-04-13 02:18:55.614633063 +0000
+++ linux-2.6.34-rc4/drivers/acpi/system.c	2010-04-13 02:19:00.709633052 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/string.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/thermal.c linux-2.6.34-rc4/drivers/acpi/thermal.c
--- linux-2.6.34-rc3/drivers/acpi/thermal.c	2010-04-13 02:18:55.615633047 +0000
+++ linux-2.6.34-rc4/drivers/acpi/thermal.c	2010-04-13 02:19:00.709633052 +0000
@@ -35,6 +35,7 @@
 #include <linux/module.h>
 #include <linux/dmi.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/proc_fs.h>
 #include <linux/jiffies.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/utils.c linux-2.6.34-rc4/drivers/acpi/utils.c
--- linux-2.6.34-rc3/drivers/acpi/utils.c	2010-04-13 02:18:55.615633047 +0000
+++ linux-2.6.34-rc4/drivers/acpi/utils.c	2010-04-13 02:19:00.710633093 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <acpi/acpi_bus.h>
diff -urN linux-2.6.34-rc3/drivers/acpi/video.c linux-2.6.34-rc4/drivers/acpi/video.c
--- linux-2.6.34-rc3/drivers/acpi/video.c	2010-04-13 02:18:55.615633047 +0000
+++ linux-2.6.34-rc4/drivers/acpi/video.c	2010-04-13 02:19:00.710633093 +0000
@@ -39,10 +39,12 @@
 #include <linux/sort.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/dmi.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
+#include <linux/suspend.h>
 
 #define PREFIX "ACPI: "
 
@@ -88,7 +90,6 @@
 static int register_count = 0;
 static int acpi_video_bus_add(struct acpi_device *device);
 static int acpi_video_bus_remove(struct acpi_device *device, int type);
-static int acpi_video_resume(struct acpi_device *device);
 static void acpi_video_bus_notify(struct acpi_device *device, u32 event);
 
 static const struct acpi_device_id video_device_ids[] = {
@@ -104,7 +105,6 @@
 	.ops = {
 		.add = acpi_video_bus_add,
 		.remove = acpi_video_bus_remove,
-		.resume = acpi_video_resume,
 		.notify = acpi_video_bus_notify,
 		},
 };
@@ -159,6 +159,7 @@
 	struct proc_dir_entry *dir;
 	struct input_dev *input;
 	char phys[32];	/* for input device */
+	struct notifier_block pm_nb;
 };
 
 struct acpi_video_device_flags {
@@ -1020,6 +1021,13 @@
 		if (IS_ERR(device->backlight))
 			return;
 
+		/*
+		 * Save current brightness level in case we have to restore it
+		 * before acpi_video_device_lcd_set_level() is called next time.
+		 */
+		device->backlight->props.brightness =
+				acpi_video_get_brightness(device->backlight);
+
 		result = sysfs_create_link(&device->backlight->dev.kobj,
 					   &device->dev->dev.kobj, "device");
 		if (result)
@@ -2122,7 +2130,7 @@
 {
 	struct acpi_video_bus *video = acpi_driver_data(device);
 	struct input_dev *input;
-	int keycode;
+	int keycode = 0;
 
 	if (!video)
 		return;
@@ -2158,17 +2166,19 @@
 		break;
 
 	default:
-		keycode = KEY_UNKNOWN;
 		ACPI_DEBUG_PRINT((ACPI_DB_INFO,
 				  "Unsupported event [0x%x]\n", event));
 		break;
 	}
 
 	acpi_notifier_call_chain(device, event, 0);
-	input_report_key(input, keycode, 1);
-	input_sync(input);
-	input_report_key(input, keycode, 0);
-	input_sync(input);
+
+	if (keycode) {
+		input_report_key(input, keycode, 1);
+		input_sync(input);
+		input_report_key(input, keycode, 0);
+		input_sync(input);
+	}
 
 	return;
 }
@@ -2179,7 +2189,7 @@
 	struct acpi_device *device = NULL;
 	struct acpi_video_bus *bus;
 	struct input_dev *input;
-	int keycode;
+	int keycode = 0;
 
 	if (!video_device)
 		return;
@@ -2220,39 +2230,48 @@
 		keycode = KEY_DISPLAY_OFF;
 		break;
 	default:
-		keycode = KEY_UNKNOWN;
 		ACPI_DEBUG_PRINT((ACPI_DB_INFO,
 				  "Unsupported event [0x%x]\n", event));
 		break;
 	}
 
 	acpi_notifier_call_chain(device, event, 0);
-	input_report_key(input, keycode, 1);
-	input_sync(input);
-	input_report_key(input, keycode, 0);
-	input_sync(input);
+
+	if (keycode) {
+		input_report_key(input, keycode, 1);
+		input_sync(input);
+		input_report_key(input, keycode, 0);
+		input_sync(input);
+	}
 
 	return;
 }
 
-static int instance;
-static int acpi_video_resume(struct acpi_device *device)
+static int acpi_video_resume(struct notifier_block *nb,
+				unsigned long val, void *ign)
 {
 	struct acpi_video_bus *video;
 	struct acpi_video_device *video_device;
 	int i;
 
-	if (!device || !acpi_driver_data(device))
-		return -EINVAL;
+	switch (val) {
+	case PM_HIBERNATION_PREPARE:
+	case PM_SUSPEND_PREPARE:
+	case PM_RESTORE_PREPARE:
+		return NOTIFY_DONE;
+	}
 
-	video = acpi_driver_data(device);
+	video = container_of(nb, struct acpi_video_bus, pm_nb);
+
+	dev_info(&video->device->dev, "Restoring backlight state\n");
 
 	for (i = 0; i < video->attached_count; i++) {
 		video_device = video->attached_array[i].bind_info;
 		if (video_device && video_device->backlight)
 			acpi_video_set_brightness(video_device->backlight);
 	}
-	return AE_OK;
+
+	return NOTIFY_OK;
 }
 
 static acpi_status
@@ -2276,6 +2295,8 @@
 	return AE_OK;
 }
 
+static int instance;
+
 static int acpi_video_bus_add(struct acpi_device *device)
 {
 	struct acpi_video_bus *video;
@@ -2357,7 +2378,6 @@
 	set_bit(KEY_BRIGHTNESSDOWN, input->keybit);
 	set_bit(KEY_BRIGHTNESS_ZERO, input->keybit);
 	set_bit(KEY_DISPLAY_OFF, input->keybit);
-	set_bit(KEY_UNKNOWN, input->keybit);
 
 	error = input_register_device(input);
 	if (error)
@@ -2369,6 +2389,10 @@
 	       video->flags.rom ? "yes" : "no",
 	       video->flags.post ? "yes" : "no");
 
+	video->pm_nb.notifier_call = acpi_video_resume;
+	video->pm_nb.priority = 0;
+	register_pm_notifier(&video->pm_nb);
+
 	return 0;
 
  err_free_input_dev:
@@ -2395,6 +2419,8 @@
 
 	video = acpi_driver_data(device);
 
+	unregister_pm_notifier(&video->pm_nb);
+
 	acpi_video_bus_stop_devices(video);
 	acpi_video_bus_put_devices(video);
 	acpi_video_bus_remove_fs(device);
diff -urN linux-2.6.34-rc3/drivers/ata/ahci.c linux-2.6.34-rc4/drivers/ata/ahci.c
--- linux-2.6.34-rc3/drivers/ata/ahci.c	2010-04-13 02:18:55.616571071 +0000
+++ linux-2.6.34-rc4/drivers/ata/ahci.c	2010-04-13 02:19:00.711633032 +0000
@@ -42,6 +42,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/device.h>
 #include <linux/dmi.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_cmnd.h>
 #include <linux/libata.h>
diff -urN linux-2.6.34-rc3/drivers/ata/ata_piix.c linux-2.6.34-rc4/drivers/ata/ata_piix.c
--- linux-2.6.34-rc3/drivers/ata/ata_piix.c	2010-04-13 02:18:55.617570534 +0000
+++ linux-2.6.34-rc4/drivers/ata/ata_piix.c	2010-04-13 02:19:00.712633046 +0000
@@ -90,6 +90,7 @@
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 #include <linux/dmi.h>
diff -urN linux-2.6.34-rc3/drivers/ata/libata-acpi.c linux-2.6.34-rc4/drivers/ata/libata-acpi.c
--- linux-2.6.34-rc3/drivers/ata/libata-acpi.c	2010-04-13 02:18:55.617570534 +0000
+++ linux-2.6.34-rc4/drivers/ata/libata-acpi.c	2010-04-13 02:19:00.712633046 +0000
@@ -15,6 +15,7 @@
 #include <linux/acpi.h>
 #include <linux/libata.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <scsi/scsi_device.h>
 #include "libata.h"
 
diff -urN linux-2.6.34-rc3/drivers/ata/libata-core.c linux-2.6.34-rc4/drivers/ata/libata-core.c
--- linux-2.6.34-rc3/drivers/ata/libata-core.c	2010-04-13 02:18:55.618570453 +0000
+++ linux-2.6.34-rc4/drivers/ata/libata-core.c	2010-04-13 02:19:00.713633087 +0000
@@ -58,6 +58,7 @@
 #include <linux/io.h>
 #include <linux/async.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_host.h>
@@ -1493,6 +1494,7 @@
 {
 	struct ata_eh_context *ehc = &dev->link->eh_context;
 	int print_info = ehc->i.flags & ATA_EHI_PRINTINFO;
+	bool unlock_hpa = ata_ignore_hpa || dev->flags & ATA_DFLAG_UNLOCK_HPA;
 	u64 sectors = ata_id_n_sectors(dev->id);
 	u64 native_sectors;
 	int rc;
@@ -1509,7 +1511,7 @@
 		/* If device aborted the command or HPA isn't going to
 		 * be unlocked, skip HPA resizing.
 		 */
-		if (rc == -EACCES || !ata_ignore_hpa) {
+		if (rc == -EACCES || !unlock_hpa) {
 			ata_dev_printk(dev, KERN_WARNING, "HPA support seems "
 				       "broken, skipping HPA handling\n");
 			dev->horkage |= ATA_HORKAGE_BROKEN_HPA;
@@ -1524,7 +1526,7 @@
 	dev->n_native_sectors = native_sectors;
 
 	/* nothing to do? */
-	if (native_sectors <= sectors || !ata_ignore_hpa) {
+	if (native_sectors <= sectors || !unlock_hpa) {
 		if (!print_info || native_sectors == sectors)
 			return 0;
 
@@ -4185,36 +4187,51 @@
 		goto fail;
 
 	/* verify n_sectors hasn't changed */
-	if (dev->class == ATA_DEV_ATA && n_sectors &&
-	    dev->n_sectors != n_sectors) {
-		ata_dev_printk(dev, KERN_WARNING, "n_sectors mismatch "
-			       "%llu != %llu\n",
-			       (unsigned long long)n_sectors,
-			       (unsigned long long)dev->n_sectors);
-		/*
-		 * Something could have caused HPA to be unlocked
-		 * involuntarily.  If n_native_sectors hasn't changed
-		 * and the new size matches it, keep the device.
-		 */
-		if (dev->n_native_sectors == n_native_sectors &&
-		    dev->n_sectors > n_sectors &&
-		    dev->n_sectors == n_native_sectors) {
-			ata_dev_printk(dev, KERN_WARNING,
-				       "new n_sectors matches native, probably "
-				       "late HPA unlock, continuing\n");
-			/* keep using the old n_sectors */
-			dev->n_sectors = n_sectors;
-		} else {
-			/* restore original n_[native]_sectors and fail */
-			dev->n_native_sectors = n_native_sectors;
-			dev->n_sectors = n_sectors;
-			rc = -ENODEV;
-			goto fail;
-		}
+	if (dev->class != ATA_DEV_ATA || !n_sectors ||
+	    dev->n_sectors == n_sectors)
+		return 0;
+
+	/* n_sectors has changed */
+	ata_dev_printk(dev, KERN_WARNING, "n_sectors mismatch %llu != %llu\n",
+		       (unsigned long long)n_sectors,
+		       (unsigned long long)dev->n_sectors);
+
+	/*
+	 * Something could have caused HPA to be unlocked
+	 * involuntarily.  If n_native_sectors hasn't changed and the
+	 * new size matches it, keep the device.
+	 */
+	if (dev->n_native_sectors == n_native_sectors &&
+	    dev->n_sectors > n_sectors && dev->n_sectors == n_native_sectors) {
+		ata_dev_printk(dev, KERN_WARNING,
+			       "new n_sectors matches native, probably "
+			       "late HPA unlock, continuing\n");
+		/* keep using the old n_sectors */
+		dev->n_sectors = n_sectors;
+		return 0;
 	}
 
-	return 0;
+	/*
+	 * Some BIOSes boot w/o HPA but resume w/ HPA locked.  Try
+	 * unlocking HPA in those cases.
+	 *
+	 * https://bugzilla.kernel.org/show_bug.cgi?id=15396
+	 */
+	if (dev->n_native_sectors == n_native_sectors &&
+	    dev->n_sectors < n_sectors && n_sectors == n_native_sectors &&
+	    !(dev->horkage & ATA_HORKAGE_BROKEN_HPA)) {
+		ata_dev_printk(dev, KERN_WARNING,
+			       "old n_sectors matches native, probably "
+			       "late HPA lock, will try to unlock HPA\n");
+		/* try unlocking HPA */
+		dev->flags |= ATA_DFLAG_UNLOCK_HPA;
+		rc = -EIO;
+	} else
+		rc = -ENODEV;
 
+	/* restore original n_[native_]sectors and fail */
+	dev->n_native_sectors = n_native_sectors;
+	dev->n_sectors = n_sectors;
  fail:
 	ata_dev_printk(dev, KERN_ERR, "revalidation failed (errno=%d)\n", rc);
 	return rc;
@@ -4353,6 +4370,9 @@
 	{ "HTS541080G9SA00",    "MB4OC60D",     ATA_HORKAGE_NONCQ, },
 	{ "HTS541010G9SA00",    "MBZOC60D",     ATA_HORKAGE_NONCQ, },
 
+	/* https://bugzilla.kernel.org/show_bug.cgi?id=15573 */
+	{ "C300-CTFDDAC128MAG",	"0001",		ATA_HORKAGE_NONCQ, },
+
 	/* devices which puke on READ_NATIVE_MAX */
 	{ "HDS724040KLSA80",	"KFAOA20N",	ATA_HORKAGE_BROKEN_HPA, },
 	{ "WDC WD3200JD-00KLB0", "WD-WCAMR1130137", ATA_HORKAGE_BROKEN_HPA },
diff -urN linux-2.6.34-rc3/drivers/ata/libata-pmp.c linux-2.6.34-rc4/drivers/ata/libata-pmp.c
--- linux-2.6.34-rc3/drivers/ata/libata-pmp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/libata-pmp.c	2010-04-13 02:19:00.713633087 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/kernel.h>
 #include <linux/libata.h>
+#include <linux/slab.h>
 #include "libata.h"
 
 const struct ata_port_operations sata_pmp_port_ops = {
diff -urN linux-2.6.34-rc3/drivers/ata/libata-scsi.c linux-2.6.34-rc4/drivers/ata/libata-scsi.c
--- linux-2.6.34-rc3/drivers/ata/libata-scsi.c	2010-04-13 02:18:55.618570453 +0000
+++ linux-2.6.34-rc4/drivers/ata/libata-scsi.c	2010-04-13 02:19:00.714633020 +0000
@@ -33,6 +33,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/blkdev.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/ata/libata-sff.c linux-2.6.34-rc4/drivers/ata/libata-sff.c
--- linux-2.6.34-rc3/drivers/ata/libata-sff.c	2010-04-13 02:18:55.619570773 +0000
+++ linux-2.6.34-rc4/drivers/ata/libata-sff.c	2010-04-13 02:19:00.714633020 +0000
@@ -33,6 +33,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/libata.h>
 #include <linux/highmem.h>
@@ -1815,10 +1816,6 @@
 			    !ap->ops->sff_irq_check(ap))
 				continue;
 
-			if (printk_ratelimit())
-				ata_port_printk(ap, KERN_INFO,
-						"clearing spurious IRQ\n");
-
 			if (idle & (1 << i)) {
 				ap->ops->sff_check_status(ap);
 				ap->ops->sff_irq_clear(ap);
diff -urN linux-2.6.34-rc3/drivers/ata/pata_acpi.c linux-2.6.34-rc4/drivers/ata/pata_acpi.c
--- linux-2.6.34-rc3/drivers/ata/pata_acpi.c	2010-04-13 02:18:55.619570773 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_acpi.c	2010-04-13 02:19:00.714633020 +0000
@@ -11,6 +11,7 @@
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <acpi/acpi_bus.h>
 
diff -urN linux-2.6.34-rc3/drivers/ata/pata_at32.c linux-2.6.34-rc4/drivers/ata/pata_at32.c
--- linux-2.6.34-rc3/drivers/ata/pata_at32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_at32.c	2010-04-13 02:19:00.715633103 +0000
@@ -18,6 +18,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <scsi/scsi_host.h>
 #include <linux/ata.h>
 #include <linux/libata.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_at91.c linux-2.6.34-rc4/drivers/ata/pata_at91.c
--- linux-2.6.34-rc3/drivers/ata/pata_at91.c	2010-04-13 02:18:55.620570476 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_at91.c	2010-04-13 02:19:00.715633103 +0000
@@ -19,6 +19,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/ata.h>
 #include <linux/clk.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_atp867x.c linux-2.6.34-rc4/drivers/ata/pata_atp867x.c
--- linux-2.6.34-rc3/drivers/ata/pata_atp867x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_atp867x.c	2010-04-13 02:19:00.715633103 +0000
@@ -33,6 +33,7 @@
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 
diff -urN linux-2.6.34-rc3/drivers/ata/pata_cmd640.c linux-2.6.34-rc4/drivers/ata/pata_cmd640.c
--- linux-2.6.34-rc3/drivers/ata/pata_cmd640.c	2010-04-13 02:18:55.620570476 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_cmd640.c	2010-04-13 02:19:00.715633103 +0000
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 
diff -urN linux-2.6.34-rc3/drivers/ata/pata_icside.c linux-2.6.34-rc4/drivers/ata/pata_icside.c
--- linux-2.6.34-rc3/drivers/ata/pata_icside.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_icside.c	2010-04-13 02:19:00.717633104 +0000
@@ -2,6 +2,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/ata.h>
 #include <linux/libata.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_it821x.c linux-2.6.34-rc4/drivers/ata/pata_it821x.c
--- linux-2.6.34-rc3/drivers/ata/pata_it821x.c	2010-04-13 02:18:55.621633046 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_it821x.c	2010-04-13 02:19:00.717633104 +0000
@@ -75,6 +75,7 @@
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 
diff -urN linux-2.6.34-rc3/drivers/ata/pata_macio.c linux-2.6.34-rc4/drivers/ata/pata_macio.c
--- linux-2.6.34-rc3/drivers/ata/pata_macio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_macio.c	2010-04-13 02:19:00.717633104 +0000
@@ -21,6 +21,7 @@
 #include <linux/pmu.h>
 #include <linux/scatterlist.h>
 #include <linux/of.h>
+#include <linux/gfp.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_host.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_mpc52xx.c linux-2.6.34-rc4/drivers/ata/pata_mpc52xx.c
--- linux-2.6.34-rc3/drivers/ata/pata_mpc52xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_mpc52xx.c	2010-04-13 02:19:00.717633104 +0000
@@ -16,7 +16,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/libata.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_octeon_cf.c linux-2.6.34-rc4/drivers/ata/pata_octeon_cf.c
--- linux-2.6.34-rc3/drivers/ata/pata_octeon_cf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_octeon_cf.c	2010-04-13 02:19:00.718633031 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/libata.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/workqueue.h>
 #include <scsi/scsi_host.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_pcmcia.c linux-2.6.34-rc4/drivers/ata/pata_pcmcia.c
--- linux-2.6.34-rc3/drivers/ata/pata_pcmcia.c	2010-04-13 02:18:55.622633091 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_pcmcia.c	2010-04-13 02:19:00.718633031 +0000
@@ -29,6 +29,7 @@
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <scsi/scsi_host.h>
 #include <linux/ata.h>
 #include <linux/libata.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_rb532_cf.c linux-2.6.34-rc4/drivers/ata/pata_rb532_cf.c
--- linux-2.6.34-rc3/drivers/ata/pata_rb532_cf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_rb532_cf.c	2010-04-13 02:19:00.719633075 +0000
@@ -19,6 +19,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_rdc.c linux-2.6.34-rc4/drivers/ata/pata_rdc.c
--- linux-2.6.34-rc3/drivers/ata/pata_rdc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_rdc.c	2010-04-13 02:19:00.719633075 +0000
@@ -28,6 +28,7 @@
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 #include <linux/dmi.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pata_via.c linux-2.6.34-rc4/drivers/ata/pata_via.c
--- linux-2.6.34-rc3/drivers/ata/pata_via.c	2010-04-13 02:18:55.624633162 +0000
+++ linux-2.6.34-rc4/drivers/ata/pata_via.c	2010-04-13 02:19:00.720633074 +0000
@@ -58,6 +58,7 @@
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <linux/libata.h>
 #include <linux/dmi.h>
diff -urN linux-2.6.34-rc3/drivers/ata/pdc_adma.c linux-2.6.34-rc4/drivers/ata/pdc_adma.c
--- linux-2.6.34-rc3/drivers/ata/pdc_adma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/pdc_adma.c	2010-04-13 02:19:00.720633074 +0000
@@ -34,6 +34,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_fsl.c linux-2.6.34-rc4/drivers/ata/sata_fsl.c
--- linux-2.6.34-rc3/drivers/ata/sata_fsl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_fsl.c	2010-04-13 02:19:00.720633074 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_inic162x.c linux-2.6.34-rc4/drivers/ata/sata_inic162x.c
--- linux-2.6.34-rc3/drivers/ata/sata_inic162x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_inic162x.c	2010-04-13 02:19:00.720633074 +0000
@@ -39,6 +39,7 @@
  * happy to assist.
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_mv.c linux-2.6.34-rc4/drivers/ata/sata_mv.c
--- linux-2.6.34-rc3/drivers/ata/sata_mv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_mv.c	2010-04-13 02:19:00.721633223 +0000
@@ -64,6 +64,7 @@
 #include <linux/ata_platform.h>
 #include <linux/mbus.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_nv.c linux-2.6.34-rc4/drivers/ata/sata_nv.c
--- linux-2.6.34-rc3/drivers/ata/sata_nv.c	2010-04-13 02:18:55.624633162 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_nv.c	2010-04-13 02:19:00.721633223 +0000
@@ -38,6 +38,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_promise.c linux-2.6.34-rc4/drivers/ata/sata_promise.c
--- linux-2.6.34-rc3/drivers/ata/sata_promise.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_promise.c	2010-04-13 02:19:00.722633048 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_qstor.c linux-2.6.34-rc4/drivers/ata/sata_qstor.c
--- linux-2.6.34-rc3/drivers/ata/sata_qstor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_qstor.c	2010-04-13 02:19:00.722633048 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_sil24.c linux-2.6.34-rc4/drivers/ata/sata_sil24.c
--- linux-2.6.34-rc3/drivers/ata/sata_sil24.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_sil24.c	2010-04-13 02:19:00.722633048 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_sx4.c linux-2.6.34-rc4/drivers/ata/sata_sx4.c
--- linux-2.6.34-rc3/drivers/ata/sata_sx4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_sx4.c	2010-04-13 02:19:00.722633048 +0000
@@ -81,6 +81,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/ata/sata_uli.c linux-2.6.34-rc4/drivers/ata/sata_uli.c
--- linux-2.6.34-rc3/drivers/ata/sata_uli.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ata/sata_uli.c	2010-04-13 02:19:00.722633048 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/atm/adummy.c linux-2.6.34-rc4/drivers/atm/adummy.c
--- linux-2.6.34-rc3/drivers/atm/adummy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/adummy.c	2010-04-13 02:19:00.722633048 +0000
@@ -13,6 +13,7 @@
 #include <linux/mm.h>
 #include <linux/timer.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/byteorder.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/atm/ambassador.c linux-2.6.34-rc4/drivers/atm/ambassador.c
--- linux-2.6.34-rc3/drivers/atm/ambassador.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/ambassador.c	2010-04-13 02:19:00.723633011 +0000
@@ -36,6 +36,7 @@
 #include <linux/mutex.h>
 #include <linux/firmware.h>
 #include <linux/ihex.h>
+#include <linux/slab.h>
 
 #include <asm/atomic.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/atm/atmtcp.c linux-2.6.34-rc4/drivers/atm/atmtcp.c
--- linux-2.6.34-rc3/drivers/atm/atmtcp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/atmtcp.c	2010-04-13 02:19:00.723633011 +0000
@@ -9,6 +9,7 @@
 #include <linux/atm_tcp.h>
 #include <linux/bitops.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/atomic.h>
 
diff -urN linux-2.6.34-rc3/drivers/atm/eni.c linux-2.6.34-rc4/drivers/atm/eni.c
--- linux-2.6.34-rc3/drivers/atm/eni.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/eni.c	2010-04-13 02:19:00.723633011 +0000
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/atm_eni.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/io.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/atm/firestream.c linux-2.6.34-rc4/drivers/atm/firestream.c
--- linux-2.6.34-rc3/drivers/atm/firestream.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/firestream.c	2010-04-13 02:19:00.723633011 +0000
@@ -46,6 +46,7 @@
 #include <linux/init.h>
 #include <linux/capability.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include <asm/system.h>
 #include <asm/string.h>
diff -urN linux-2.6.34-rc3/drivers/atm/he.c linux-2.6.34-rc4/drivers/atm/he.c
--- linux-2.6.34-rc3/drivers/atm/he.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/he.c	2010-04-13 02:19:00.724633046 +0000
@@ -67,6 +67,7 @@
 #include <linux/timer.h>
 #include <linux/interrupt.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/byteorder.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/atm/horizon.c linux-2.6.34-rc4/drivers/atm/horizon.c
--- linux-2.6.34-rc3/drivers/atm/horizon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/horizon.c	2010-04-13 02:19:00.725633054 +0000
@@ -40,6 +40,7 @@
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/atm/idt77105.c linux-2.6.34-rc4/drivers/atm/idt77105.c
--- linux-2.6.34-rc3/drivers/atm/idt77105.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/idt77105.c	2010-04-13 02:19:00.725633054 +0000
@@ -15,6 +15,7 @@
 #include <linux/capability.h>
 #include <linux/atm_idt77105.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/param.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/atm/idt77252.c linux-2.6.34-rc4/drivers/atm/idt77252.c
--- linux-2.6.34-rc3/drivers/atm/idt77252.c	2010-04-13 02:18:55.625633060 +0000
+++ linux-2.6.34-rc4/drivers/atm/idt77252.c	2010-04-13 02:19:00.725633054 +0000
@@ -41,6 +41,7 @@
 #include <linux/wait.h>
 #include <linux/jiffies.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/atm/iphase.c linux-2.6.34-rc4/drivers/atm/iphase.c
--- linux-2.6.34-rc3/drivers/atm/iphase.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/iphase.c	2010-04-13 02:19:00.726633011 +0000
@@ -54,6 +54,7 @@
 #include <linux/uio.h>  
 #include <linux/init.h>  
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <asm/system.h>  
 #include <asm/io.h>  
 #include <asm/atomic.h>  
diff -urN linux-2.6.34-rc3/drivers/atm/lanai.c linux-2.6.34-rc4/drivers/atm/lanai.c
--- linux-2.6.34-rc3/drivers/atm/lanai.c	2010-04-13 02:18:55.626633065 +0000
+++ linux-2.6.34-rc4/drivers/atm/lanai.c	2010-04-13 02:19:00.726633011 +0000
@@ -55,6 +55,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/atmdev.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/atm/nicstar.c linux-2.6.34-rc4/drivers/atm/nicstar.c
--- linux-2.6.34-rc3/drivers/atm/nicstar.c	2010-04-13 02:18:55.626633065 +0000
+++ linux-2.6.34-rc4/drivers/atm/nicstar.c	2010-04-13 02:19:00.727632992 +0000
@@ -49,6 +49,7 @@
 #include <linux/timer.h>
 #include <linux/interrupt.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/atm/solos-pci.c linux-2.6.34-rc4/drivers/atm/solos-pci.c
--- linux-2.6.34-rc3/drivers/atm/solos-pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/solos-pci.c	2010-04-13 02:19:00.727632992 +0000
@@ -40,6 +40,7 @@
 #include <linux/firmware.h>
 #include <linux/ctype.h>
 #include <linux/swab.h>
+#include <linux/slab.h>
 
 #define VERSION "0.07"
 #define PTAG "solos-pci"
diff -urN linux-2.6.34-rc3/drivers/atm/suni.c linux-2.6.34-rc4/drivers/atm/suni.c
--- linux-2.6.34-rc3/drivers/atm/suni.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/suni.c	2010-04-13 02:19:00.727632992 +0000
@@ -21,6 +21,7 @@
 #include <linux/init.h>
 #include <linux/capability.h>
 #include <linux/atm_suni.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/param.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/atm/uPD98402.c linux-2.6.34-rc4/drivers/atm/uPD98402.c
--- linux-2.6.34-rc3/drivers/atm/uPD98402.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/uPD98402.c	2010-04-13 02:19:00.727632992 +0000
@@ -9,6 +9,7 @@
 #include <linux/atmdev.h>
 #include <linux/sonet.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/atomic.h>
 
diff -urN linux-2.6.34-rc3/drivers/atm/zatm.c linux-2.6.34-rc4/drivers/atm/zatm.c
--- linux-2.6.34-rc3/drivers/atm/zatm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/atm/zatm.c	2010-04-13 02:19:00.727632992 +0000
@@ -21,6 +21,7 @@
 #include <linux/capability.h>
 #include <linux/bitops.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include <asm/system.h>
 #include <asm/string.h>
diff -urN linux-2.6.34-rc3/drivers/auxdisplay/cfag12864b.c linux-2.6.34-rc4/drivers/auxdisplay/cfag12864b.c
--- linux-2.6.34-rc3/drivers/auxdisplay/cfag12864b.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/auxdisplay/cfag12864b.c	2010-04-13 02:19:00.727632992 +0000
@@ -27,6 +27,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/cdev.h>
 #include <linux/delay.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/auxdisplay/cfag12864bfb.c linux-2.6.34-rc4/drivers/auxdisplay/cfag12864bfb.c
--- linux-2.6.34-rc3/drivers/auxdisplay/cfag12864bfb.c	2010-04-13 02:18:55.626633065 +0000
+++ linux-2.6.34-rc4/drivers/auxdisplay/cfag12864bfb.c	2010-04-13 02:19:00.727632992 +0000
@@ -31,7 +31,6 @@
 #include <linux/fb.h>
 #include <linux/mm.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/uaccess.h>
 #include <linux/cfag12864b.h>
diff -urN linux-2.6.34-rc3/drivers/base/attribute_container.c linux-2.6.34-rc4/drivers/base/attribute_container.c
--- linux-2.6.34-rc3/drivers/base/attribute_container.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/attribute_container.c	2010-04-13 02:19:00.728633072 +0000
@@ -328,6 +328,7 @@
 		return sysfs_create_group(&classdev->kobj, cont->grp);
 
 	for (i = 0; attrs[i]; i++) {
+		sysfs_attr_init(&attrs[i]->attr);
 		error = device_create_file(classdev, attrs[i]);
 		if (error)
 			return error;
diff -urN linux-2.6.34-rc3/drivers/base/bus.c linux-2.6.34-rc4/drivers/base/bus.c
--- linux-2.6.34-rc3/drivers/base/bus.c	2010-04-13 02:18:55.626633065 +0000
+++ linux-2.6.34-rc4/drivers/base/bus.c	2010-04-13 02:19:00.728633072 +0000
@@ -13,6 +13,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/string.h>
 #include "base.h"
diff -urN linux-2.6.34-rc3/drivers/base/cpu.c linux-2.6.34-rc4/drivers/base/cpu.c
--- linux-2.6.34-rc3/drivers/base/cpu.c	2010-04-13 02:18:55.627633083 +0000
+++ linux-2.6.34-rc4/drivers/base/cpu.c	2010-04-13 02:19:00.728633072 +0000
@@ -10,6 +10,7 @@
 #include <linux/topology.h>
 #include <linux/device.h>
 #include <linux/node.h>
+#include <linux/gfp.h>
 
 #include "base.h"
 
diff -urN linux-2.6.34-rc3/drivers/base/devres.c linux-2.6.34-rc4/drivers/base/devres.c
--- linux-2.6.34-rc3/drivers/base/devres.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/devres.c	2010-04-13 02:19:00.729633078 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/device.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "base.h"
 
diff -urN linux-2.6.34-rc3/drivers/base/devtmpfs.c linux-2.6.34-rc4/drivers/base/devtmpfs.c
--- linux-2.6.34-rc3/drivers/base/devtmpfs.c	2010-04-13 02:18:55.627633083 +0000
+++ linux-2.6.34-rc4/drivers/base/devtmpfs.c	2010-04-13 02:19:00.729633078 +0000
@@ -23,6 +23,7 @@
 #include <linux/cred.h>
 #include <linux/sched.h>
 #include <linux/init_task.h>
+#include <linux/slab.h>
 
 static struct vfsmount *dev_mnt;
 
diff -urN linux-2.6.34-rc3/drivers/base/dma-coherent.c linux-2.6.34-rc4/drivers/base/dma-coherent.c
--- linux-2.6.34-rc3/drivers/base/dma-coherent.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/dma-coherent.c	2010-04-13 02:19:00.729633078 +0000
@@ -2,6 +2,7 @@
  * Coherent per-device memory handling.
  * Borrowed from i386
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/dma-mapping.h>
 
diff -urN linux-2.6.34-rc3/drivers/base/dma-mapping.c linux-2.6.34-rc4/drivers/base/dma-mapping.c
--- linux-2.6.34-rc3/drivers/base/dma-mapping.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/dma-mapping.c	2010-04-13 02:19:00.729633078 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 /*
  * Managed DMA API
diff -urN linux-2.6.34-rc3/drivers/base/driver.c linux-2.6.34-rc4/drivers/base/driver.c
--- linux-2.6.34-rc3/drivers/base/driver.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/driver.c	2010-04-13 02:19:00.729633078 +0000
@@ -13,6 +13,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include "base.h"
 
diff -urN linux-2.6.34-rc3/drivers/base/firmware_class.c linux-2.6.34-rc4/drivers/base/firmware_class.c
--- linux-2.6.34-rc3/drivers/base/firmware_class.c	2010-04-13 02:18:55.628633062 +0000
+++ linux-2.6.34-rc4/drivers/base/firmware_class.c	2010-04-13 02:19:00.729633078 +0000
@@ -19,6 +19,7 @@
 #include <linux/kthread.h>
 #include <linux/highmem.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #define to_dev(obj) container_of(obj, struct device, kobj)
 
diff -urN linux-2.6.34-rc3/drivers/base/memory.c linux-2.6.34-rc4/drivers/base/memory.c
--- linux-2.6.34-rc3/drivers/base/memory.c	2010-04-13 02:18:55.628633062 +0000
+++ linux-2.6.34-rc4/drivers/base/memory.c	2010-04-13 02:19:00.730633029 +0000
@@ -22,6 +22,7 @@
 #include <linux/mm.h>
 #include <linux/mutex.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 
 #include <asm/atomic.h>
 #include <asm/uaccess.h>
@@ -312,7 +313,7 @@
 print_block_size(struct sysdev_class *class, struct sysdev_class_attribute *attr,
 		 char *buf)
 {
-	return sprintf(buf, "%#lx\n", (unsigned long)PAGES_PER_SECTION * PAGE_SIZE);
+	return sprintf(buf, "%lx\n", (unsigned long)PAGES_PER_SECTION * PAGE_SIZE);
 }
 
 static SYSDEV_CLASS_ATTR(block_size_bytes, 0444, print_block_size, NULL);
diff -urN linux-2.6.34-rc3/drivers/base/module.c linux-2.6.34-rc4/drivers/base/module.c
--- linux-2.6.34-rc3/drivers/base/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/base/module.c	2010-04-13 02:19:00.730633029 +0000
@@ -7,6 +7,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include "base.h"
 
diff -urN linux-2.6.34-rc3/drivers/base/node.c linux-2.6.34-rc4/drivers/base/node.c
--- linux-2.6.34-rc3/drivers/base/node.c	2010-04-13 02:18:55.628633062 +0000
+++ linux-2.6.34-rc4/drivers/base/node.c	2010-04-13 02:19:00.730633029 +0000
@@ -15,6 +15,7 @@
 #include <linux/cpu.h>
 #include <linux/device.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 
 static struct sysdev_class_attribute *node_state_attrs[];
 
diff -urN linux-2.6.34-rc3/drivers/base/sys.c linux-2.6.34-rc4/drivers/base/sys.c
--- linux-2.6.34-rc3/drivers/base/sys.c	2010-04-13 02:18:55.630570464 +0000
+++ linux-2.6.34-rc4/drivers/base/sys.c	2010-04-13 02:19:00.731633058 +0000
@@ -17,7 +17,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/pm.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/block/DAC960.c linux-2.6.34-rc4/drivers/block/DAC960.c
--- linux-2.6.34-rc3/drivers/block/DAC960.c	2010-04-13 02:18:55.631633103 +0000
+++ linux-2.6.34-rc4/drivers/block/DAC960.c	2010-04-13 02:19:00.732633108 +0000
@@ -2533,7 +2533,6 @@
   	Controller->RequestQueue[n] = RequestQueue;
   	blk_queue_bounce_limit(RequestQueue, Controller->BounceBufferLimit);
   	RequestQueue->queuedata = Controller;
-  	blk_queue_max_hw_segments(RequestQueue, Controller->DriverScatterGatherLimit);
 	blk_queue_max_segments(RequestQueue, Controller->DriverScatterGatherLimit);
 	blk_queue_max_hw_sectors(RequestQueue, Controller->MaxBlocksPerCommand);
 	disk->queue = RequestQueue;
diff -urN linux-2.6.34-rc3/drivers/block/amiflop.c linux-2.6.34-rc4/drivers/block/amiflop.c
--- linux-2.6.34-rc3/drivers/block/amiflop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/amiflop.c	2010-04-13 02:19:00.733633089 +0000
@@ -54,6 +54,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/fd.h>
 #include <linux/hdreg.h>
diff -urN linux-2.6.34-rc3/drivers/block/aoe/aoeblk.c linux-2.6.34-rc4/drivers/block/aoe/aoeblk.c
--- linux-2.6.34-rc3/drivers/block/aoe/aoeblk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/aoe/aoeblk.c	2010-04-13 02:19:00.733633089 +0000
@@ -9,6 +9,7 @@
 #include <linux/backing-dev.h>
 #include <linux/fs.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <linux/genhd.h>
 #include <linux/netdevice.h>
 #include "aoe.h"
diff -urN linux-2.6.34-rc3/drivers/block/aoe/aoechr.c linux-2.6.34-rc4/drivers/block/aoe/aoechr.c
--- linux-2.6.34-rc3/drivers/block/aoe/aoechr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/aoe/aoechr.c	2010-04-13 02:19:00.733633089 +0000
@@ -8,6 +8,7 @@
 #include <linux/blkdev.h>
 #include <linux/completion.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/skbuff.h>
 #include "aoe.h"
diff -urN linux-2.6.34-rc3/drivers/block/aoe/aoecmd.c linux-2.6.34-rc4/drivers/block/aoe/aoecmd.c
--- linux-2.6.34-rc3/drivers/block/aoe/aoecmd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/aoe/aoecmd.c	2010-04-13 02:19:00.733633089 +0000
@@ -5,6 +5,7 @@
  */
 
 #include <linux/ata.h>
+#include <linux/slab.h>
 #include <linux/hdreg.h>
 #include <linux/blkdev.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/drivers/block/aoe/aoedev.c linux-2.6.34-rc4/drivers/block/aoe/aoedev.c
--- linux-2.6.34-rc3/drivers/block/aoe/aoedev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/aoe/aoedev.c	2010-04-13 02:19:00.733633089 +0000
@@ -8,6 +8,7 @@
 #include <linux/blkdev.h>
 #include <linux/netdevice.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "aoe.h"
 
 static void dummy_timer(ulong);
diff -urN linux-2.6.34-rc3/drivers/block/aoe/aoenet.c linux-2.6.34-rc4/drivers/block/aoe/aoenet.c
--- linux-2.6.34-rc3/drivers/block/aoe/aoenet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/aoe/aoenet.c	2010-04-13 02:19:00.733633089 +0000
@@ -4,6 +4,7 @@
  * Ethernet portion of AoE driver
  */
 
+#include <linux/gfp.h>
 #include <linux/hdreg.h>
 #include <linux/blkdev.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/block/brd.c linux-2.6.34-rc4/drivers/block/brd.c
--- linux-2.6.34-rc3/drivers/block/brd.c	2010-04-13 02:18:55.631633103 +0000
+++ linux-2.6.34-rc4/drivers/block/brd.c	2010-04-13 02:19:00.734633028 +0000
@@ -15,9 +15,9 @@
 #include <linux/blkdev.h>
 #include <linux/bio.h>
 #include <linux/highmem.h>
-#include <linux/gfp.h>
 #include <linux/radix-tree.h>
 #include <linux/buffer_head.h> /* invalidate_bh_lrus() */
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/block/cciss.c linux-2.6.34-rc4/drivers/block/cciss.c
--- linux-2.6.34-rc3/drivers/block/cciss.c	2010-04-13 02:18:55.632633037 +0000
+++ linux-2.6.34-rc4/drivers/block/cciss.c	2010-04-13 02:19:00.734633028 +0000
@@ -3341,6 +3341,7 @@
 					printk(KERN_WARNING
 					       "cciss: controller cciss%d failed, stopping.\n",
 					       h->ctlr);
+					spin_unlock_irqrestore(CCISS_LOCK(h->ctlr), flags);
 					fail_all_cmds(h->ctlr);
 					return IRQ_HANDLED;
 				}
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_actlog.c linux-2.6.34-rc4/drivers/block/drbd/drbd_actlog.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_actlog.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_actlog.c	2010-04-13 02:19:00.736633032 +0000
@@ -536,7 +536,9 @@
 	put_ldev(mdev);
 }
 
+/* sector to word */
 #define S2W(s)	((s)<<(BM_EXT_SHIFT-BM_BLOCK_SHIFT-LN2_BPL))
+
 /* activity log to on disk bitmap -- prepare bio unless that sector
  * is already covered by previously prepared bios */
 static int atodb_prepare_unless_covered(struct drbd_conf *mdev,
@@ -546,13 +548,20 @@
 {
 	struct bio *bio;
 	struct page *page;
-	sector_t on_disk_sector = enr + mdev->ldev->md.md_offset
-				      + mdev->ldev->md.bm_offset;
+	sector_t on_disk_sector;
 	unsigned int page_offset = PAGE_SIZE;
 	int offset;
 	int i = 0;
 	int err = -ENOMEM;
 
+	/* We always write aligned, full 4k blocks,
+	 * so we can ignore the logical_block_size (for now) */
+	enr &= ~7U;
+	on_disk_sector = enr + mdev->ldev->md.md_offset
+			     + mdev->ldev->md.bm_offset;
+
+	D_ASSERT(!(on_disk_sector & 7U));
+
 	/* Check if that enr is already covered by an already created bio.
 	 * Caution, bios[] is not NULL terminated,
 	 * but only initialized to all NULL.
@@ -588,7 +597,7 @@
 
 	offset = S2W(enr);
 	drbd_bm_get_lel(mdev, offset,
-			min_t(size_t, S2W(1), drbd_bm_words(mdev) - offset),
+			min_t(size_t, S2W(8), drbd_bm_words(mdev) - offset),
 			kmap(page) + page_offset);
 	kunmap(page);
 
@@ -597,7 +606,7 @@
 	bio->bi_bdev = mdev->ldev->md_bdev;
 	bio->bi_sector = on_disk_sector;
 
-	if (bio_add_page(bio, page, MD_SECTOR_SIZE, page_offset) != MD_SECTOR_SIZE)
+	if (bio_add_page(bio, page, 4096, page_offset) != 4096)
 		goto out_put_page;
 
 	atomic_inc(&wc->count);
@@ -1327,7 +1336,7 @@
 		/* ok, ->resync is there. */
 		for (i = 0; i < mdev->resync->nr_elements; i++) {
 			e = lc_element_by_index(mdev->resync, i);
-			bm_ext = e ? lc_entry(e, struct bm_extent, lce) : NULL;
+			bm_ext = lc_entry(e, struct bm_extent, lce);
 			if (bm_ext->lce.lc_number == LC_FREE)
 				continue;
 			if (bm_ext->lce.lc_number == mdev->resync_wenr) {
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_bitmap.c linux-2.6.34-rc4/drivers/block/drbd/drbd_bitmap.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_bitmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_bitmap.c	2010-04-13 02:19:00.736633032 +0000
@@ -26,6 +26,7 @@
 #include <linux/vmalloc.h>
 #include <linux/string.h>
 #include <linux/drbd.h>
+#include <linux/slab.h>
 #include <asm/kmap_types.h>
 #include "drbd_int.h"
 
@@ -66,7 +67,7 @@
 	size_t   bm_words;
 	size_t   bm_number_of_pages;
 	sector_t bm_dev_capacity;
-	struct semaphore bm_change; /* serializes resize operations */
+	struct mutex bm_change; /* serializes resize operations */
 
 	atomic_t bm_async_io;
 	wait_queue_head_t bm_io_wait;
@@ -114,7 +115,7 @@
 		return;
 	}
 
-	trylock_failed = down_trylock(&b->bm_change);
+	trylock_failed = !mutex_trylock(&b->bm_change);
 
 	if (trylock_failed) {
 		dev_warn(DEV, "%s going to '%s' but bitmap already locked for '%s' by %s\n",
@@ -125,7 +126,7 @@
 		    b->bm_task == mdev->receiver.task ? "receiver" :
 		    b->bm_task == mdev->asender.task  ? "asender"  :
 		    b->bm_task == mdev->worker.task   ? "worker"   : "?");
-		down(&b->bm_change);
+		mutex_lock(&b->bm_change);
 	}
 	if (__test_and_set_bit(BM_LOCKED, &b->bm_flags))
 		dev_err(DEV, "FIXME bitmap already locked in bm_lock\n");
@@ -147,7 +148,7 @@
 
 	b->bm_why  = NULL;
 	b->bm_task = NULL;
-	up(&b->bm_change);
+	mutex_unlock(&b->bm_change);
 }
 
 /* word offset to long pointer */
@@ -295,7 +296,7 @@
 	if (!b)
 		return -ENOMEM;
 	spin_lock_init(&b->bm_lock);
-	init_MUTEX(&b->bm_change);
+	mutex_init(&b->bm_change);
 	init_waitqueue_head(&b->bm_io_wait);
 
 	mdev->bitmap = b;
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_int.h linux-2.6.34-rc4/drivers/block/drbd/drbd_int.h
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_int.h	2010-04-13 02:18:55.633633052 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_int.h	2010-04-13 02:19:00.737633130 +0000
@@ -261,6 +261,9 @@
 		[P_OV_REQUEST]          = "OVRequest",
 		[P_OV_REPLY]            = "OVReply",
 		[P_OV_RESULT]           = "OVResult",
+		[P_CSUM_RS_REQUEST]     = "CsumRSRequest",
+		[P_RS_IS_IN_SYNC]	= "CsumRSIsInSync",
+		[P_COMPRESSED_BITMAP]   = "CBitmap",
 		[P_MAX_CMD]	        = NULL,
 	};
 
@@ -443,13 +446,18 @@
 	char csums_alg[SHARED_SECRET_MAX];
 } __packed;
 
+enum drbd_conn_flags {
+	CF_WANT_LOSE = 1,
+	CF_DRY_RUN = 2,
+};
+
 struct p_protocol {
 	struct p_header head;
 	u32 protocol;
 	u32 after_sb_0p;
 	u32 after_sb_1p;
 	u32 after_sb_2p;
-	u32 want_lose;
+	u32 conn_flags;
 	u32 two_primaries;
 
               /* Since protocol version 87 and higher. */
@@ -791,6 +799,8 @@
 				 * while this is set. */
 	RESIZE_PENDING,		/* Size change detected locally, waiting for the response from
 				 * the peer, if it changed there as well. */
+	CONN_DRY_RUN,		/* Expect disconnect after resync handshake. */
+	GOT_PING_ACK,		/* set when we receive a ping_ack packet, misc wait gets woken */
 };
 
 struct drbd_bitmap; /* opaque for drbd_conf */
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_main.c linux-2.6.34-rc4/drivers/block/drbd/drbd_main.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_main.c	2010-04-13 02:19:00.737633130 +0000
@@ -1668,7 +1668,7 @@
 int drbd_send_protocol(struct drbd_conf *mdev)
 {
 	struct p_protocol *p;
-	int size, rv;
+	int size, cf, rv;
 
 	size = sizeof(struct p_protocol);
 
@@ -1685,9 +1685,21 @@
 	p->after_sb_0p   = cpu_to_be32(mdev->net_conf->after_sb_0p);
 	p->after_sb_1p   = cpu_to_be32(mdev->net_conf->after_sb_1p);
 	p->after_sb_2p   = cpu_to_be32(mdev->net_conf->after_sb_2p);
-	p->want_lose     = cpu_to_be32(mdev->net_conf->want_lose);
 	p->two_primaries = cpu_to_be32(mdev->net_conf->two_primaries);
 
+	cf = 0;
+	if (mdev->net_conf->want_lose)
+		cf |= CF_WANT_LOSE;
+	if (mdev->net_conf->dry_run) {
+		if (mdev->agreed_pro_version >= 92)
+			cf |= CF_DRY_RUN;
+		else {
+			dev_err(DEV, "--dry-run is not supported by peer");
+			return 0;
+		}
+	}
+	p->conn_flags    = cpu_to_be32(cf);
+
 	if (mdev->agreed_pro_version >= 87)
 		strcpy(p->integrity_alg, mdev->net_conf->integrity_alg);
 
@@ -3161,14 +3173,18 @@
 void drbd_free_sock(struct drbd_conf *mdev)
 {
 	if (mdev->data.socket) {
+		mutex_lock(&mdev->data.mutex);
 		kernel_sock_shutdown(mdev->data.socket, SHUT_RDWR);
 		sock_release(mdev->data.socket);
 		mdev->data.socket = NULL;
+		mutex_unlock(&mdev->data.mutex);
 	}
 	if (mdev->meta.socket) {
+		mutex_lock(&mdev->meta.mutex);
 		kernel_sock_shutdown(mdev->meta.socket, SHUT_RDWR);
 		sock_release(mdev->meta.socket);
 		mdev->meta.socket = NULL;
+		mutex_unlock(&mdev->meta.mutex);
 	}
 }
 
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_nl.c linux-2.6.34-rc4/drivers/block/drbd/drbd_nl.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_nl.c	2010-04-13 02:18:55.634633072 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_nl.c	2010-04-13 02:19:00.737633130 +0000
@@ -285,8 +285,8 @@
 		}
 
 		if (r == SS_NO_UP_TO_DATE_DISK && force &&
-		    (mdev->state.disk == D_INCONSISTENT ||
-		     mdev->state.disk == D_OUTDATED)) {
+		    (mdev->state.disk < D_UP_TO_DATE &&
+		     mdev->state.disk >= D_INCONSISTENT)) {
 			mask.disk = D_MASK;
 			val.disk  = D_UP_TO_DATE;
 			forced = 1;
@@ -407,7 +407,7 @@
 	}
 
 	reply->ret_code =
-		drbd_set_role(mdev, R_PRIMARY, primary_args.overwrite_peer);
+		drbd_set_role(mdev, R_PRIMARY, primary_args.primary_force);
 
 	return 0;
 }
@@ -941,6 +941,25 @@
 
 	drbd_md_set_sector_offsets(mdev, nbc);
 
+	/* allocate a second IO page if logical_block_size != 512 */
+	logical_block_size = bdev_logical_block_size(nbc->md_bdev);
+	if (logical_block_size == 0)
+		logical_block_size = MD_SECTOR_SIZE;
+
+	if (logical_block_size != MD_SECTOR_SIZE) {
+		if (!mdev->md_io_tmpp) {
+			struct page *page = alloc_page(GFP_NOIO);
+			if (!page)
+				goto force_diskless_dec;
+
+			dev_warn(DEV, "Meta data's bdev logical_block_size = %d != %d\n",
+			     logical_block_size, MD_SECTOR_SIZE);
+			dev_warn(DEV, "Workaround engaged (has performance impact).\n");
+
+			mdev->md_io_tmpp = page;
+		}
+	}
+
 	if (!mdev->bitmap) {
 		if (drbd_bm_init(mdev)) {
 			retcode = ERR_NOMEM;
@@ -980,25 +999,6 @@
 		goto force_diskless_dec;
 	}
 
-	/* allocate a second IO page if logical_block_size != 512 */
-	logical_block_size = bdev_logical_block_size(nbc->md_bdev);
-	if (logical_block_size == 0)
-		logical_block_size = MD_SECTOR_SIZE;
-
-	if (logical_block_size != MD_SECTOR_SIZE) {
-		if (!mdev->md_io_tmpp) {
-			struct page *page = alloc_page(GFP_NOIO);
-			if (!page)
-				goto force_diskless_dec;
-
-			dev_warn(DEV, "Meta data's bdev logical_block_size = %d != %d\n",
-			     logical_block_size, MD_SECTOR_SIZE);
-			dev_warn(DEV, "Workaround engaged (has performance impact).\n");
-
-			mdev->md_io_tmpp = page;
-		}
-	}
-
 	/* Reset the "barriers don't work" bits here, then force meta data to
 	 * be written, to ensure we determine if barriers are supported. */
 	if (nbc->dc.no_md_flush)
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_proc.c linux-2.6.34-rc4/drivers/block/drbd/drbd_proc.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_proc.c	2010-04-13 02:19:00.737633130 +0000
@@ -28,7 +28,6 @@
 #include <asm/uaccess.h>
 #include <linux/fs.h>
 #include <linux/file.h>
-#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/drbd.h>
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_receiver.c linux-2.6.34-rc4/drivers/block/drbd/drbd_receiver.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_receiver.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_receiver.c	2010-04-13 02:19:00.738633045 +0000
@@ -2513,6 +2513,10 @@
 	}
 
 	if (hg == -100) {
+		/* FIXME this log message is not correct if we end up here
+		 * after an attempted attach on a diskless node.
+		 * We just refuse to attach -- well, we drop the "connection"
+		 * to that disk, in a way... */
 		dev_alert(DEV, "Split-Brain detected, dropping connection!\n");
 		drbd_khelper(mdev, "split-brain");
 		return C_MASK;
@@ -2538,6 +2542,16 @@
 		}
 	}
 
+	if (mdev->net_conf->dry_run || test_bit(CONN_DRY_RUN, &mdev->flags)) {
+		if (hg == 0)
+			dev_info(DEV, "dry-run connect: No resync, would become Connected immediately.\n");
+		else
+			dev_info(DEV, "dry-run connect: Would become %s, doing a %s resync.",
+				 drbd_conn_str(hg > 0 ? C_SYNC_SOURCE : C_SYNC_TARGET),
+				 abs(hg) >= 2 ? "full" : "bit-map based");
+		return C_MASK;
+	}
+
 	if (abs(hg) >= 2) {
 		dev_info(DEV, "Writing the whole bitmap, full sync required after drbd_sync_handshake.\n");
 		if (drbd_bitmap_io(mdev, &drbd_bmio_set_n_write, "set_n_write from sync_handshake"))
@@ -2585,7 +2599,7 @@
 	struct p_protocol *p = (struct p_protocol *)h;
 	int header_size, data_size;
 	int p_proto, p_after_sb_0p, p_after_sb_1p, p_after_sb_2p;
-	int p_want_lose, p_two_primaries;
+	int p_want_lose, p_two_primaries, cf;
 	char p_integrity_alg[SHARED_SECRET_MAX] = "";
 
 	header_size = sizeof(*p) - sizeof(*h);
@@ -2598,8 +2612,14 @@
 	p_after_sb_0p	= be32_to_cpu(p->after_sb_0p);
 	p_after_sb_1p	= be32_to_cpu(p->after_sb_1p);
 	p_after_sb_2p	= be32_to_cpu(p->after_sb_2p);
-	p_want_lose	= be32_to_cpu(p->want_lose);
 	p_two_primaries = be32_to_cpu(p->two_primaries);
+	cf		= be32_to_cpu(p->conn_flags);
+	p_want_lose = cf & CF_WANT_LOSE;
+
+	clear_bit(CONN_DRY_RUN, &mdev->flags);
+
+	if (cf & CF_DRY_RUN)
+		set_bit(CONN_DRY_RUN, &mdev->flags);
 
 	if (p_proto != mdev->net_conf->wire_protocol) {
 		dev_err(DEV, "incompatible communication protocols\n");
@@ -3118,13 +3138,16 @@
 
 		put_ldev(mdev);
 		if (nconn == C_MASK) {
+			nconn = C_CONNECTED;
 			if (mdev->state.disk == D_NEGOTIATING) {
 				drbd_force_state(mdev, NS(disk, D_DISKLESS));
-				nconn = C_CONNECTED;
 			} else if (peer_state.disk == D_NEGOTIATING) {
 				dev_err(DEV, "Disk attach process on the peer node was aborted.\n");
 				peer_state.disk = D_DISKLESS;
+				real_peer_disk = D_DISKLESS;
 			} else {
+				if (test_and_clear_bit(CONN_DRY_RUN, &mdev->flags))
+					return FALSE;
 				D_ASSERT(oconn == C_WF_REPORT_PARAMS);
 				drbd_force_state(mdev, NS(conn, C_DISCONNECTING));
 				return FALSE;
@@ -3594,10 +3617,7 @@
 
 	/* asender does not clean up anything. it must not interfere, either */
 	drbd_thread_stop(&mdev->asender);
-
-	mutex_lock(&mdev->data.mutex);
 	drbd_free_sock(mdev);
-	mutex_unlock(&mdev->data.mutex);
 
 	spin_lock_irq(&mdev->req_lock);
 	_drbd_wait_ee_list_empty(mdev, &mdev->active_ee);
@@ -4054,6 +4074,8 @@
 {
 	/* restore idle timeout */
 	mdev->meta.socket->sk->sk_rcvtimeo = mdev->net_conf->ping_int*HZ;
+	if (!test_and_set_bit(GOT_PING_ACK, &mdev->flags))
+		wake_up(&mdev->misc_wait);
 
 	return TRUE;
 }
diff -urN linux-2.6.34-rc3/drivers/block/drbd/drbd_worker.c linux-2.6.34-rc4/drivers/block/drbd/drbd_worker.c
--- linux-2.6.34-rc3/drivers/block/drbd/drbd_worker.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/drbd/drbd_worker.c	2010-04-13 02:19:00.738633045 +0000
@@ -938,7 +938,8 @@
 
 		if (eq) {
 			drbd_set_in_sync(mdev, e->sector, e->size);
-			mdev->rs_same_csum++;
+			/* rs_same_csums unit is BM_BLOCK_SIZE */
+			mdev->rs_same_csum += e->size >> BM_BLOCK_SHIFT;
 			ok = drbd_send_ack(mdev, P_RS_IS_IN_SYNC, e);
 		} else {
 			inc_rs_pending(mdev);
@@ -1288,6 +1289,14 @@
 	return retcode;
 }
 
+static void ping_peer(struct drbd_conf *mdev)
+{
+	clear_bit(GOT_PING_ACK, &mdev->flags);
+	request_ping(mdev);
+	wait_event(mdev->misc_wait,
+		   test_bit(GOT_PING_ACK, &mdev->flags) || mdev->state.conn < C_CONNECTED);
+}
+
 /**
  * drbd_start_resync() - Start the resync process
  * @mdev:	DRBD device.
@@ -1371,7 +1380,6 @@
 		_drbd_pause_after(mdev);
 	}
 	write_unlock_irq(&global_state_lock);
-	drbd_state_unlock(mdev);
 	put_ldev(mdev);
 
 	if (r == SS_SUCCESS) {
@@ -1382,11 +1390,8 @@
 
 		if (mdev->rs_total == 0) {
 			/* Peer still reachable? Beware of failing before-resync-target handlers! */
-			request_ping(mdev);
-			__set_current_state(TASK_INTERRUPTIBLE);
-			schedule_timeout(mdev->net_conf->ping_timeo*HZ/9); /* 9 instead 10 */
+			ping_peer(mdev);
 			drbd_resync_finished(mdev);
-			return;
 		}
 
 		/* ns.conn may already be != mdev->state.conn,
@@ -1398,6 +1403,7 @@
 
 		drbd_md_sync(mdev);
 	}
+	drbd_state_unlock(mdev);
 }
 
 int drbd_worker(struct drbd_thread *thi)
diff -urN linux-2.6.34-rc3/drivers/block/hd.c linux-2.6.34-rc4/drivers/block/hd.c
--- linux-2.6.34-rc3/drivers/block/hd.c	2010-04-13 02:18:55.636633027 +0000
+++ linux-2.6.34-rc4/drivers/block/hd.c	2010-04-13 02:19:00.741633048 +0000
@@ -34,7 +34,6 @@
 #include <linux/fs.h>
 #include <linux/kernel.h>
 #include <linux/genhd.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/block/loop.c linux-2.6.34-rc4/drivers/block/loop.c
--- linux-2.6.34-rc3/drivers/block/loop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/loop.c	2010-04-13 02:19:00.741633048 +0000
@@ -71,7 +71,6 @@
 #include <linux/buffer_head.h>		/* for invalidate_bdev() */
 #include <linux/completion.h>
 #include <linux/highmem.h>
-#include <linux/gfp.h>
 #include <linux/kthread.h>
 #include <linux/splice.h>
 
@@ -238,6 +237,8 @@
 		if (ret)
 			goto fail;
 
+		file_update_time(file);
+
 		transfer_result = lo_do_transfer(lo, WRITE, page, offset,
 				bvec->bv_page, bv_offs, size, IV);
 		copied = size;
diff -urN linux-2.6.34-rc3/drivers/block/mg_disk.c linux-2.6.34-rc4/drivers/block/mg_disk.c
--- linux-2.6.34-rc3/drivers/block/mg_disk.c	2010-04-13 02:18:55.636633027 +0000
+++ linux-2.6.34-rc4/drivers/block/mg_disk.c	2010-04-13 02:19:00.741633048 +0000
@@ -23,6 +23,7 @@
 #include <linux/platform_device.h>
 #include <linux/gpio.h>
 #include <linux/mg_disk.h>
+#include <linux/slab.h>
 
 #define MG_RES_SEC (CONFIG_MG_DISK_RES << 1)
 
diff -urN linux-2.6.34-rc3/drivers/block/nbd.c linux-2.6.34-rc4/drivers/block/nbd.c
--- linux-2.6.34-rc3/drivers/block/nbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/nbd.c	2010-04-13 02:19:00.741633048 +0000
@@ -27,6 +27,7 @@
 #include <linux/compiler.h>
 #include <linux/err.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/net.h>
 #include <linux/kthread.h>
diff -urN linux-2.6.34-rc3/drivers/block/osdblk.c linux-2.6.34-rc4/drivers/block/osdblk.c
--- linux-2.6.34-rc3/drivers/block/osdblk.c	2010-04-13 02:18:55.636633027 +0000
+++ linux-2.6.34-rc4/drivers/block/osdblk.c	2010-04-13 02:19:00.741633048 +0000
@@ -63,6 +63,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <scsi/osd_initiator.h>
 #include <scsi/osd_attributes.h>
 #include <scsi/osd_sec.h>
diff -urN linux-2.6.34-rc3/drivers/block/paride/pcd.c linux-2.6.34-rc4/drivers/block/paride/pcd.c
--- linux-2.6.34-rc3/drivers/block/paride/pcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/paride/pcd.c	2010-04-13 02:19:00.742633038 +0000
@@ -341,11 +341,11 @@
 	       && (j++ < PCD_SPIN))
 		udelay(PCD_DELAY);
 
-	if ((r & (IDE_ERR & stop)) || (j >= PCD_SPIN)) {
+	if ((r & (IDE_ERR & stop)) || (j > PCD_SPIN)) {
 		s = read_reg(cd, 7);
 		e = read_reg(cd, 1);
 		p = read_reg(cd, 2);
-		if (j >= PCD_SPIN)
+		if (j > PCD_SPIN)
 			e |= 0x100;
 		if (fun)
 			printk("%s: %s %s: alt=0x%x stat=0x%x err=0x%x"
diff -urN linux-2.6.34-rc3/drivers/block/paride/pd.c linux-2.6.34-rc4/drivers/block/paride/pd.c
--- linux-2.6.34-rc3/drivers/block/paride/pd.c	2010-04-13 02:18:55.637633120 +0000
+++ linux-2.6.34-rc4/drivers/block/paride/pd.c	2010-04-13 02:19:00.742633038 +0000
@@ -145,6 +145,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/delay.h>
 #include <linux/hdreg.h>
diff -urN linux-2.6.34-rc3/drivers/block/paride/pf.c linux-2.6.34-rc4/drivers/block/paride/pf.c
--- linux-2.6.34-rc3/drivers/block/paride/pf.c	2010-04-13 02:18:55.637633120 +0000
+++ linux-2.6.34-rc4/drivers/block/paride/pf.c	2010-04-13 02:19:00.742633038 +0000
@@ -391,11 +391,11 @@
 	       && (j++ < PF_SPIN))
 		udelay(PF_SPIN_DEL);
 
-	if ((r & (STAT_ERR & stop)) || (j >= PF_SPIN)) {
+	if ((r & (STAT_ERR & stop)) || (j > PF_SPIN)) {
 		s = read_reg(pf, 7);
 		e = read_reg(pf, 1);
 		p = read_reg(pf, 2);
-		if (j >= PF_SPIN)
+		if (j > PF_SPIN)
 			e |= 0x100;
 		if (fun)
 			printk("%s: %s %s: alt=0x%x stat=0x%x err=0x%x"
diff -urN linux-2.6.34-rc3/drivers/block/paride/pt.c linux-2.6.34-rc4/drivers/block/paride/pt.c
--- linux-2.6.34-rc3/drivers/block/paride/pt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/paride/pt.c	2010-04-13 02:19:00.742633038 +0000
@@ -274,11 +274,11 @@
 	       && (j++ < PT_SPIN))
 		udelay(PT_SPIN_DEL);
 
-	if ((r & (STAT_ERR & stop)) || (j >= PT_SPIN)) {
+	if ((r & (STAT_ERR & stop)) || (j > PT_SPIN)) {
 		s = read_reg(pi, 7);
 		e = read_reg(pi, 1);
 		p = read_reg(pi, 2);
-		if (j >= PT_SPIN)
+		if (j > PT_SPIN)
 			e |= 0x100;
 		if (fun)
 			printk("%s: %s %s: alt=0x%x stat=0x%x err=0x%x"
diff -urN linux-2.6.34-rc3/drivers/block/pktcdvd.c linux-2.6.34-rc4/drivers/block/pktcdvd.c
--- linux-2.6.34-rc3/drivers/block/pktcdvd.c	2010-04-13 02:18:55.637633120 +0000
+++ linux-2.6.34-rc4/drivers/block/pktcdvd.c	2010-04-13 02:19:00.743633037 +0000
@@ -57,6 +57,7 @@
 #include <linux/miscdevice.h>
 #include <linux/freezer.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_ioctl.h>
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/block/ps3disk.c linux-2.6.34-rc4/drivers/block/ps3disk.c
--- linux-2.6.34-rc3/drivers/block/ps3disk.c	2010-04-13 02:18:55.638633074 +0000
+++ linux-2.6.34-rc4/drivers/block/ps3disk.c	2010-04-13 02:19:00.743633037 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/ata.h>
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 
 #include <asm/lv1call.h>
 #include <asm/ps3stor.h>
diff -urN linux-2.6.34-rc3/drivers/block/ps3vram.c linux-2.6.34-rc4/drivers/block/ps3vram.c
--- linux-2.6.34-rc3/drivers/block/ps3vram.c	2010-04-13 02:18:55.638633074 +0000
+++ linux-2.6.34-rc4/drivers/block/ps3vram.c	2010-04-13 02:19:00.743633037 +0000
@@ -12,6 +12,7 @@
 #include <linux/delay.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/cell-regs.h>
 #include <asm/firmware.h>
diff -urN linux-2.6.34-rc3/drivers/block/swim.c linux-2.6.34-rc4/drivers/block/swim.c
--- linux-2.6.34-rc3/drivers/block/swim.c	2010-04-13 02:18:55.638633074 +0000
+++ linux-2.6.34-rc4/drivers/block/swim.c	2010-04-13 02:19:00.744633447 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/module.h>
 #include <linux/fd.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/hdreg.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/block/ub.c linux-2.6.34-rc4/drivers/block/ub.c
--- linux-2.6.34-rc3/drivers/block/ub.c	2010-04-13 02:18:55.639571809 +0000
+++ linux-2.6.34-rc4/drivers/block/ub.c	2010-04-13 02:19:00.744633447 +0000
@@ -27,6 +27,7 @@
 #include <linux/blkdev.h>
 #include <linux/timer.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 
 #define DRV_NAME "ub"
diff -urN linux-2.6.34-rc3/drivers/block/umem.c linux-2.6.34-rc4/drivers/block/umem.c
--- linux-2.6.34-rc3/drivers/block/umem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/umem.c	2010-04-13 02:19:00.744633447 +0000
@@ -40,13 +40,13 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/mman.h>
+#include <linux/gfp.h>
 #include <linux/ioctl.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/timer.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 
 #include <linux/fcntl.h>        /* O_ACCMODE */
diff -urN linux-2.6.34-rc3/drivers/block/virtio_blk.c linux-2.6.34-rc4/drivers/block/virtio_blk.c
--- linux-2.6.34-rc3/drivers/block/virtio_blk.c	2010-04-13 02:18:55.639571809 +0000
+++ linux-2.6.34-rc4/drivers/block/virtio_blk.c	2010-04-13 02:19:00.745633053 +0000
@@ -1,5 +1,6 @@
 //#define DEBUG
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/hdreg.h>
 #include <linux/virtio.h>
@@ -347,14 +348,13 @@
 	set_capacity(vblk->disk, cap);
 
 	/* We can handle whatever the host told us to handle. */
-	blk_queue_max_phys_segments(q, vblk->sg_elems-2);
-	blk_queue_max_hw_segments(q, vblk->sg_elems-2);
+	blk_queue_max_segments(q, vblk->sg_elems-2);
 
 	/* No need to bounce any requests */
 	blk_queue_bounce_limit(q, BLK_BOUNCE_ANY);
 
 	/* No real sector limit. */
-	blk_queue_max_sectors(q, -1U);
+	blk_queue_max_hw_sectors(q, -1U);
 
 	/* Host can optionally specify maximum segment size and number of
 	 * segments. */
diff -urN linux-2.6.34-rc3/drivers/block/xd.c linux-2.6.34-rc4/drivers/block/xd.c
--- linux-2.6.34-rc3/drivers/block/xd.c	2010-04-13 02:18:55.639571809 +0000
+++ linux-2.6.34-rc4/drivers/block/xd.c	2010-04-13 02:19:00.745633053 +0000
@@ -49,6 +49,7 @@
 #include <linux/blkpg.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/block/xen-blkfront.c linux-2.6.34-rc4/drivers/block/xen-blkfront.c
--- linux-2.6.34-rc3/drivers/block/xen-blkfront.c	2010-04-13 02:18:55.640570456 +0000
+++ linux-2.6.34-rc4/drivers/block/xen-blkfront.c	2010-04-13 02:19:00.745633053 +0000
@@ -40,6 +40,7 @@
 #include <linux/hdreg.h>
 #include <linux/cdrom.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/scatterlist.h>
 
 #include <xen/xen.h>
diff -urN linux-2.6.34-rc3/drivers/block/z2ram.c linux-2.6.34-rc4/drivers/block/z2ram.c
--- linux-2.6.34-rc3/drivers/block/z2ram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/block/z2ram.c	2010-04-13 02:19:00.746633049 +0000
@@ -33,6 +33,7 @@
 #include <linux/module.h>
 #include <linux/blkdev.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #include <asm/setup.h>
 #include <asm/amigahw.h>
diff -urN linux-2.6.34-rc3/drivers/bluetooth/btmrvl_debugfs.c linux-2.6.34-rc4/drivers/bluetooth/btmrvl_debugfs.c
--- linux-2.6.34-rc3/drivers/bluetooth/btmrvl_debugfs.c	2010-04-13 02:18:55.641570453 +0000
+++ linux-2.6.34-rc4/drivers/bluetooth/btmrvl_debugfs.c	2010-04-13 02:19:00.746633049 +0000
@@ -19,6 +19,7 @@
  **/
 
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include <net/bluetooth/bluetooth.h>
 #include <net/bluetooth/hci_core.h>
diff -urN linux-2.6.34-rc3/drivers/bluetooth/btmrvl_drv.h linux-2.6.34-rc4/drivers/bluetooth/btmrvl_drv.h
--- linux-2.6.34-rc3/drivers/bluetooth/btmrvl_drv.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/bluetooth/btmrvl_drv.h	2010-04-13 02:19:00.746633049 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/kthread.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <net/bluetooth/bluetooth.h>
 
 #define BTM_HEADER_LEN			4
diff -urN linux-2.6.34-rc3/drivers/bluetooth/btmrvl_sdio.c linux-2.6.34-rc4/drivers/bluetooth/btmrvl_sdio.c
--- linux-2.6.34-rc3/drivers/bluetooth/btmrvl_sdio.c	2010-04-13 02:18:55.641570453 +0000
+++ linux-2.6.34-rc4/drivers/bluetooth/btmrvl_sdio.c	2010-04-13 02:19:00.747632997 +0000
@@ -19,6 +19,7 @@
  **/
 
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/sdio_ids.h>
 #include <linux/mmc/sdio_func.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/amd-k7-agp.c linux-2.6.34-rc4/drivers/char/agp/amd-k7-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/amd-k7-agp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/amd-k7-agp.c	2010-04-13 02:19:00.749633064 +0000
@@ -6,9 +6,9 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/agp_backend.h>
-#include <linux/gfp.h>
 #include <linux/page-flags.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include "agp.h"
 
 #define AMD_MMBASE	0x14
diff -urN linux-2.6.34-rc3/drivers/char/agp/backend.c linux-2.6.34-rc4/drivers/char/agp/backend.c
--- linux-2.6.34-rc3/drivers/char/agp/backend.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/backend.c	2010-04-13 02:19:00.750633102 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/miscdevice.h>
 #include <linux/pm.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/compat_ioctl.c linux-2.6.34-rc4/drivers/char/agp/compat_ioctl.c
--- linux-2.6.34-rc3/drivers/char/agp/compat_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/compat_ioctl.c	2010-04-13 02:19:00.750633102 +0000
@@ -30,6 +30,7 @@
 #include <linux/pci.h>
 #include <linux/fs.h>
 #include <linux/agpgart.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include "agp.h"
 #include "compat_ioctl.h"
diff -urN linux-2.6.34-rc3/drivers/char/agp/generic.c linux-2.6.34-rc4/drivers/char/agp/generic.c
--- linux-2.6.34-rc3/drivers/char/agp/generic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/generic.c	2010-04-13 02:19:00.750633102 +0000
@@ -38,6 +38,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/mm.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/cacheflush.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/hp-agp.c linux-2.6.34-rc4/drivers/char/agp/hp-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/hp-agp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/hp-agp.c	2010-04-13 02:19:00.750633102 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/agp_backend.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 #include <asm/acpi-ext.h>
 
diff -urN linux-2.6.34-rc3/drivers/char/agp/intel-agp.c linux-2.6.34-rc4/drivers/char/agp/intel-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/intel-agp.c	2010-04-13 02:18:55.644633043 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/intel-agp.c	2010-04-13 02:19:00.751633119 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/nvidia-agp.c linux-2.6.34-rc4/drivers/char/agp/nvidia-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/nvidia-agp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/nvidia-agp.c	2010-04-13 02:19:00.751633119 +0000
@@ -8,7 +8,6 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/agp_backend.h>
-#include <linux/gfp.h>
 #include <linux/page-flags.h>
 #include <linux/mm.h>
 #include <linux/jiffies.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/sgi-agp.c linux-2.6.34-rc4/drivers/char/agp/sgi-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/sgi-agp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/sgi-agp.c	2010-04-13 02:19:00.751633119 +0000
@@ -14,6 +14,7 @@
 #include <linux/acpi.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/agp_backend.h>
 #include <asm/sn/addrs.h>
diff -urN linux-2.6.34-rc3/drivers/char/agp/uninorth-agp.c linux-2.6.34-rc4/drivers/char/agp/uninorth-agp.c
--- linux-2.6.34-rc3/drivers/char/agp/uninorth-agp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/agp/uninorth-agp.c	2010-04-13 02:19:00.751633119 +0000
@@ -3,6 +3,7 @@
  */
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/pagemap.h>
 #include <linux/agp_backend.h>
diff -urN linux-2.6.34-rc3/drivers/char/amiserial.c linux-2.6.34-rc4/drivers/char/amiserial.c
--- linux-2.6.34-rc3/drivers/char/amiserial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/amiserial.c	2010-04-13 02:19:00.751633119 +0000
@@ -2021,8 +2021,6 @@
 	state->baud_base = amiga_colorclock;
 	state->xmit_fifo_size = 1;
 
-	local_irq_save(flags);
-
 	/* set ISRs, and then disable the rx interrupts */
 	error = request_irq(IRQ_AMIGA_TBE, ser_tx_int, 0, "serial TX", state);
 	if (error)
@@ -2033,6 +2031,8 @@
 	if (error)
 		goto fail_free_irq;
 
+	local_irq_save(flags);
+
 	/* turn off Rx and Tx interrupts */
 	custom.intena = IF_RBF | IF_TBE;
 	mb();
diff -urN linux-2.6.34-rc3/drivers/char/bfin_jtag_comm.c linux-2.6.34-rc4/drivers/char/bfin_jtag_comm.c
--- linux-2.6.34-rc3/drivers/char/bfin_jtag_comm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/bfin_jtag_comm.c	2010-04-13 02:19:00.751633119 +0000
@@ -21,6 +21,7 @@
 #include <linux/module.h>
 #include <linux/mutex.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/tty_driver.h>
 #include <linux/tty_flip.h>
diff -urN linux-2.6.34-rc3/drivers/char/briq_panel.c linux-2.6.34-rc4/drivers/char/briq_panel.c
--- linux-2.6.34-rc3/drivers/char/briq_panel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/briq_panel.c	2010-04-13 02:19:00.752633082 +0000
@@ -14,7 +14,6 @@
 #include <linux/kernel.h>
 #include <linux/wait.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/miscdevice.h>
diff -urN linux-2.6.34-rc3/drivers/char/bsr.c linux-2.6.34-rc4/drivers/char/bsr.c
--- linux-2.6.34-rc3/drivers/char/bsr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/bsr.c	2010-04-13 02:19:00.752633082 +0000
@@ -27,6 +27,7 @@
 #include <linux/cdev.h>
 #include <linux/list.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <asm/pgtable.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/char/cyclades.c linux-2.6.34-rc4/drivers/char/cyclades.c
--- linux-2.6.34-rc3/drivers/char/cyclades.c	2010-04-13 02:18:55.645633067 +0000
+++ linux-2.6.34-rc4/drivers/char/cyclades.c	2010-04-13 02:19:00.752633082 +0000
@@ -79,6 +79,7 @@
 #include <linux/bitops.h>
 #include <linux/firmware.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 #include <linux/io.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/char/dsp56k.c linux-2.6.34-rc4/drivers/char/dsp56k.c
--- linux-2.6.34-rc3/drivers/char/dsp56k.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/dsp56k.c	2010-04-13 02:19:00.752633082 +0000
@@ -24,7 +24,6 @@
  */
 
 #include <linux/module.h>
-#include <linux/slab.h>	/* for kmalloc() and kfree() */
 #include <linux/major.h>
 #include <linux/types.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/char/epca.c linux-2.6.34-rc4/drivers/char/epca.c
--- linux-2.6.34-rc3/drivers/char/epca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/epca.c	2010-04-13 02:19:00.753633048 +0000
@@ -36,7 +36,6 @@
 #include <linux/ctype.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/char/generic_serial.c linux-2.6.34-rc4/drivers/char/generic_serial.c
--- linux-2.6.34-rc3/drivers/char/generic_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/generic_serial.c	2010-04-13 02:19:00.753633048 +0000
@@ -29,6 +29,7 @@
 #include <linux/interrupt.h>
 #include <linux/tty_flip.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 
 #define DEBUG 
diff -urN linux-2.6.34-rc3/drivers/char/hpet.c linux-2.6.34-rc4/drivers/char/hpet.c
--- linux-2.6.34-rc3/drivers/char/hpet.c	2010-04-13 02:18:55.645633067 +0000
+++ linux-2.6.34-rc4/drivers/char/hpet.c	2010-04-13 02:19:00.753633048 +0000
@@ -31,6 +31,7 @@
 #include <linux/seq_file.h>
 #include <linux/bitops.h>
 #include <linux/clocksource.h>
+#include <linux/slab.h>
 
 #include <asm/current.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/char/hvc_console.c linux-2.6.34-rc4/drivers/char/hvc_console.c
--- linux-2.6.34-rc3/drivers/char/hvc_console.c	2010-04-13 02:18:55.645633067 +0000
+++ linux-2.6.34-rc4/drivers/char/hvc_console.c	2010-04-13 02:19:00.753633048 +0000
@@ -38,6 +38,7 @@
 #include <linux/spinlock.h>
 #include <linux/delay.h>
 #include <linux/freezer.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
@@ -367,16 +368,12 @@
 	hp = tty->driver_data;
 
 	spin_lock_irqsave(&hp->lock, flags);
-	tty_kref_get(tty);
 
 	if (--hp->count == 0) {
 		/* We are done with the tty pointer now. */
 		hp->tty = NULL;
 		spin_unlock_irqrestore(&hp->lock, flags);
 
-		/* Put the ref obtained in hvc_open() */
-		tty_kref_put(tty);
-
 		if (hp->ops->notifier_del)
 			hp->ops->notifier_del(hp, hp->data);
 
diff -urN linux-2.6.34-rc3/drivers/char/hvc_iucv.c linux-2.6.34-rc4/drivers/char/hvc_iucv.c
--- linux-2.6.34-rc3/drivers/char/hvc_iucv.c	2010-04-13 02:18:55.646633096 +0000
+++ linux-2.6.34-rc4/drivers/char/hvc_iucv.c	2010-04-13 02:19:00.754633041 +0000
@@ -12,6 +12,7 @@
 #define pr_fmt(fmt)		KMSG_COMPONENT ": " fmt
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <asm/ebcdic.h>
 #include <linux/ctype.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/char/hvcs.c linux-2.6.34-rc4/drivers/char/hvcs.c
--- linux-2.6.34-rc3/drivers/char/hvcs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/hvcs.c	2010-04-13 02:19:00.754633041 +0000
@@ -74,6 +74,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/stat.h>
 #include <linux/tty.h>
diff -urN linux-2.6.34-rc3/drivers/char/hw_random/intel-rng.c linux-2.6.34-rc4/drivers/char/hw_random/intel-rng.c
--- linux-2.6.34-rc3/drivers/char/hw_random/intel-rng.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/hw_random/intel-rng.c	2010-04-13 02:19:00.755633073 +0000
@@ -30,6 +30,7 @@
 #include <linux/pci.h>
 #include <linux/stop_machine.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/char/hw_random/octeon-rng.c linux-2.6.34-rc4/drivers/char/hw_random/octeon-rng.c
--- linux-2.6.34-rc3/drivers/char/hw_random/octeon-rng.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/hw_random/octeon-rng.c	2010-04-13 02:19:00.755633073 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/hw_random.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-rnm-defs.h>
diff -urN linux-2.6.34-rc3/drivers/char/hw_random/tx4939-rng.c linux-2.6.34-rc4/drivers/char/hw_random/tx4939-rng.c
--- linux-2.6.34-rc3/drivers/char/hw_random/tx4939-rng.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/hw_random/tx4939-rng.c	2010-04-13 02:19:00.755633073 +0000
@@ -14,6 +14,7 @@
 #include <linux/io.h>
 #include <linux/platform_device.h>
 #include <linux/hw_random.h>
+#include <linux/gfp.h>
 
 #define TX4939_RNG_RCSR		0x00000000
 #define TX4939_RNG_ROR(n)	(0x00000018 + (n) * 8)
diff -urN linux-2.6.34-rc3/drivers/char/isicom.c linux-2.6.34-rc4/drivers/char/isicom.c
--- linux-2.6.34-rc3/drivers/char/isicom.c	2010-04-13 02:18:55.649572010 +0000
+++ linux-2.6.34-rc4/drivers/char/isicom.c	2010-04-13 02:19:00.757633062 +0000
@@ -130,6 +130,7 @@
 #include <linux/timer.h>
 #include <linux/delay.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 
 #include <linux/uaccess.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/mbcs.c linux-2.6.34-rc4/drivers/char/mbcs.c
--- linux-2.6.34-rc3/drivers/char/mbcs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/mbcs.c	2010-04-13 02:19:00.758633058 +0000
@@ -26,6 +26,7 @@
 #include <linux/uio.h>
 #include <linux/mutex.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/char/mem.c linux-2.6.34-rc4/drivers/char/mem.c
--- linux-2.6.34-rc3/drivers/char/mem.c	2010-04-13 02:18:55.650570396 +0000
+++ linux-2.6.34-rc4/drivers/char/mem.c	2010-04-13 02:19:00.758633058 +0000
@@ -225,6 +225,7 @@
  * outside of main memory.
  *
  */
+#ifdef pgprot_noncached
 static int uncached_access(struct file *file, unsigned long addr)
 {
 #if defined(CONFIG_IA64)
@@ -251,6 +252,7 @@
 	return addr >= __pa(high_memory);
 #endif
 }
+#endif
 
 static pgprot_t phys_mem_access_prot(struct file *file, unsigned long pfn,
 				     unsigned long size, pgprot_t vma_prot)
@@ -710,11 +712,6 @@
 	switch (orig) {
 	case SEEK_CUR:
 		offset += file->f_pos;
-		if ((unsigned long long)offset <
-		    (unsigned long long)file->f_pos) {
-			ret = -EOVERFLOW;
-			break;
-		}
 	case SEEK_SET:
 		/* to avoid userland mistaking f_pos=-9 as -EBADF=-9 */
 		if ((unsigned long long)offset >= ~0xFFFULL) {
@@ -908,6 +905,9 @@
 		printk("unable to get major %d for memory devs\n", MEM_MAJOR);
 
 	mem_class = class_create(THIS_MODULE, "mem");
+	if (IS_ERR(mem_class))
+		return PTR_ERR(mem_class);
+
 	mem_class->devnode = mem_devnode;
 	for (minor = 1; minor < ARRAY_SIZE(devlist); minor++) {
 		if (!devlist[minor].name)
diff -urN linux-2.6.34-rc3/drivers/char/misc.c linux-2.6.34-rc4/drivers/char/misc.c
--- linux-2.6.34-rc3/drivers/char/misc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/misc.c	2010-04-13 02:19:00.758633058 +0000
@@ -40,7 +40,6 @@
 #include <linux/miscdevice.h>
 #include <linux/kernel.h>
 #include <linux/major.h>
-#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
@@ -49,6 +48,7 @@
 #include <linux/device.h>
 #include <linux/tty.h>
 #include <linux/kmod.h>
+#include <linux/gfp.h>
 
 /*
  * Head entry for the doubly linked miscdevice list
diff -urN linux-2.6.34-rc3/drivers/char/mmtimer.c linux-2.6.34-rc4/drivers/char/mmtimer.c
--- linux-2.6.34-rc3/drivers/char/mmtimer.c	2010-04-13 02:18:55.650570396 +0000
+++ linux-2.6.34-rc4/drivers/char/mmtimer.c	2010-04-13 02:19:00.758633058 +0000
@@ -33,6 +33,7 @@
 #include <linux/time.h>
 #include <linux/math64.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/sn/addrs.h>
diff -urN linux-2.6.34-rc3/drivers/char/moxa.c linux-2.6.34-rc4/drivers/char/moxa.c
--- linux-2.6.34-rc3/drivers/char/moxa.c	2010-04-13 02:18:55.650570396 +0000
+++ linux-2.6.34-rc4/drivers/char/moxa.c	2010-04-13 02:19:00.758633058 +0000
@@ -43,6 +43,7 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/mxser.c linux-2.6.34-rc4/drivers/char/mxser.c
--- linux-2.6.34-rc3/drivers/char/mxser.c	2010-04-13 02:18:55.651633185 +0000
+++ linux-2.6.34-rc4/drivers/char/mxser.c	2010-04-13 02:19:00.759633015 +0000
@@ -33,12 +33,12 @@
 #include <linux/string.h>
 #include <linux/fcntl.h>
 #include <linux/ptrace.h>
-#include <linux/gfp.h>
 #include <linux/ioport.h>
 #include <linux/mm.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
@@ -1768,7 +1768,7 @@
 		int len, lsr;
 
 		len = mxser_chars_in_buffer(tty);
-		spin_lock(&info->slock);
+		spin_lock_irq(&info->slock);
 		lsr = inb(info->ioaddr + UART_LSR) & UART_LSR_THRE;
 		spin_unlock_irq(&info->slock);
 		len += (lsr ? 0 : 1);
@@ -1778,12 +1778,12 @@
 	case MOXA_ASPP_MON: {
 		int mcr, status;
 
-		spin_lock(&info->slock);
+		spin_lock_irq(&info->slock);
 		status = mxser_get_msr(info->ioaddr, 1, tty->index);
 		mxser_check_modem_status(tty, info, status);
 
 		mcr = inb(info->ioaddr + UART_MCR);
-		spin_unlock(&info->slock);
+		spin_unlock_irq(&info->slock);
 
 		if (mcr & MOXA_MUST_MCR_XON_FLAG)
 			info->mon_data.hold_reason &= ~NPPI_NOTIFY_XOFFHOLD;
diff -urN linux-2.6.34-rc3/drivers/char/nozomi.c linux-2.6.34-rc4/drivers/char/nozomi.c
--- linux-2.6.34-rc3/drivers/char/nozomi.c	2010-04-13 02:18:55.651633185 +0000
+++ linux-2.6.34-rc4/drivers/char/nozomi.c	2010-04-13 02:19:00.760633071 +0000
@@ -55,6 +55,7 @@
 #include <linux/init.h>
 #include <linux/kfifo.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/char/nvram.c linux-2.6.34-rc4/drivers/char/nvram.c
--- linux-2.6.34-rc3/drivers/char/nvram.c	2010-04-13 02:18:55.651633185 +0000
+++ linux-2.6.34-rc4/drivers/char/nvram.c	2010-04-13 02:19:00.760633071 +0000
@@ -100,7 +100,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/miscdevice.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/fcntl.h>
 #include <linux/mc146818rtc.h>
diff -urN linux-2.6.34-rc3/drivers/char/pcmcia/ipwireless/network.c linux-2.6.34-rc4/drivers/char/pcmcia/ipwireless/network.c
--- linux-2.6.34-rc3/drivers/char/pcmcia/ipwireless/network.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/pcmcia/ipwireless/network.c	2010-04-13 02:19:00.760633071 +0000
@@ -21,6 +21,7 @@
 #include <linux/netdevice.h>
 #include <linux/ppp_channel.h>
 #include <linux/ppp_defs.h>
+#include <linux/slab.h>
 #include <linux/if_ppp.h>
 #include <linux/skbuff.h>
 
diff -urN linux-2.6.34-rc3/drivers/char/ppdev.c linux-2.6.34-rc4/drivers/char/ppdev.c
--- linux-2.6.34-rc3/drivers/char/ppdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/ppdev.c	2010-04-13 02:19:00.760633071 +0000
@@ -64,6 +64,7 @@
 #include <linux/parport.h>
 #include <linux/ctype.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/major.h>
 #include <linux/ppdev.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/char/ps3flash.c linux-2.6.34-rc4/drivers/char/ps3flash.c
--- linux-2.6.34-rc3/drivers/char/ps3flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/ps3flash.c	2010-04-13 02:19:00.760633071 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/fs.h>
 #include <linux/miscdevice.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #include <asm/lv1call.h>
diff -urN linux-2.6.34-rc3/drivers/char/pty.c linux-2.6.34-rc4/drivers/char/pty.c
--- linux-2.6.34-rc3/drivers/char/pty.c	2010-04-13 02:18:55.652633044 +0000
+++ linux-2.6.34-rc4/drivers/char/pty.c	2010-04-13 02:19:00.760633071 +0000
@@ -29,6 +29,7 @@
 #include <linux/uaccess.h>
 #include <linux/bitops.h>
 #include <linux/devpts_fs.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 
diff -urN linux-2.6.34-rc3/drivers/char/raw.c linux-2.6.34-rc4/drivers/char/raw.c
--- linux-2.6.34-rc3/drivers/char/raw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/raw.c	2010-04-13 02:19:00.761633067 +0000
@@ -20,6 +20,7 @@
 #include <linux/device.h>
 #include <linux/mutex.h>
 #include <linux/smp_lock.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 
@@ -247,6 +248,7 @@
 	.aio_read = 	generic_file_aio_read,
 	.write	=	do_sync_write,
 	.aio_write =	blkdev_aio_write,
+	.fsync	=	blkdev_fsync,
 	.open	=	raw_open,
 	.release=	raw_release,
 	.ioctl	=	raw_ioctl,
diff -urN linux-2.6.34-rc3/drivers/char/rio/rioinit.c linux-2.6.34-rc4/drivers/char/rio/rioinit.c
--- linux-2.6.34-rc3/drivers/char/rio/rioinit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/rio/rioinit.c	2010-04-13 02:19:00.761633067 +0000
@@ -31,7 +31,6 @@
 */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/delay.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/rio/riointr.c linux-2.6.34-rc4/drivers/char/rio/riointr.c
--- linux-2.6.34-rc3/drivers/char/rio/riointr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/rio/riointr.c	2010-04-13 02:19:00.761633067 +0000
@@ -31,7 +31,6 @@
 */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
diff -urN linux-2.6.34-rc3/drivers/char/rio/rioparam.c linux-2.6.34-rc4/drivers/char/rio/rioparam.c
--- linux-2.6.34-rc3/drivers/char/rio/rioparam.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/rio/rioparam.c	2010-04-13 02:19:00.761633067 +0000
@@ -31,7 +31,6 @@
 */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/tty.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/rio/rioroute.c linux-2.6.34-rc4/drivers/char/rio/rioroute.c
--- linux-2.6.34-rc3/drivers/char/rio/rioroute.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/rio/rioroute.c	2010-04-13 02:19:00.761633067 +0000
@@ -31,7 +31,6 @@
 */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <asm/io.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/char/rio/riotty.c linux-2.6.34-rc4/drivers/char/rio/riotty.c
--- linux-2.6.34-rc3/drivers/char/rio/riotty.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/rio/riotty.c	2010-04-13 02:19:00.762633030 +0000
@@ -34,7 +34,6 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/tty.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/char/serial167.c linux-2.6.34-rc4/drivers/char/serial167.c
--- linux-2.6.34-rc3/drivers/char/serial167.c	2010-04-13 02:18:55.652633044 +0000
+++ linux-2.6.34-rc4/drivers/char/serial167.c	2010-04-13 02:19:00.762633030 +0000
@@ -64,6 +64,7 @@
 #include <linux/module.h>
 #include <linux/bitops.h>
 #include <linux/tty_flip.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/snsc_event.c linux-2.6.34-rc4/drivers/char/snsc_event.c
--- linux-2.6.34-rc3/drivers/char/snsc_event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/snsc_event.c	2010-04-13 02:19:00.762633030 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/interrupt.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include <asm/sn/sn_sal.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/drivers/char/sonypi.c linux-2.6.34-rc4/drivers/char/sonypi.c
--- linux-2.6.34-rc3/drivers/char/sonypi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/sonypi.c	2010-04-13 02:19:00.762633030 +0000
@@ -50,6 +50,7 @@
 #include <linux/err.h>
 #include <linux/kfifo.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/char/specialix.c linux-2.6.34-rc4/drivers/char/specialix.c
--- linux-2.6.34-rc3/drivers/char/specialix.c	2010-04-13 02:18:55.653633037 +0000
+++ linux-2.6.34-rc4/drivers/char/specialix.c	2010-04-13 02:19:00.763633017 +0000
@@ -94,6 +94,7 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/uaccess.h>
+#include <linux/gfp.h>
 
 #include "specialix_io8.h"
 #include "cd1865.h"
diff -urN linux-2.6.34-rc3/drivers/char/sysrq.c linux-2.6.34-rc4/drivers/char/sysrq.c
--- linux-2.6.34-rc3/drivers/char/sysrq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/sysrq.c	2010-04-13 02:19:00.765633063 +0000
@@ -38,6 +38,7 @@
 #include <linux/workqueue.h>
 #include <linux/hrtimer.h>
 #include <linux/oom.h>
+#include <linux/slab.h>
 
 #include <asm/ptrace.h>
 #include <asm/irq_regs.h>
diff -urN linux-2.6.34-rc3/drivers/char/tpm/tpm.c linux-2.6.34-rc4/drivers/char/tpm/tpm.c
--- linux-2.6.34-rc3/drivers/char/tpm/tpm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/tpm/tpm.c	2010-04-13 02:19:00.765633063 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/spinlock.h>
 
diff -urN linux-2.6.34-rc3/drivers/char/tpm/tpm_bios.c linux-2.6.34-rc4/drivers/char/tpm/tpm_bios.c
--- linux-2.6.34-rc3/drivers/char/tpm/tpm_bios.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/tpm/tpm_bios.c	2010-04-13 02:19:00.765633063 +0000
@@ -22,6 +22,7 @@
 #include <linux/fs.h>
 #include <linux/security.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <acpi/acpi.h>
 #include "tpm.h"
 
diff -urN linux-2.6.34-rc3/drivers/char/tpm/tpm_nsc.c linux-2.6.34-rc4/drivers/char/tpm/tpm_nsc.c
--- linux-2.6.34-rc3/drivers/char/tpm/tpm_nsc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/tpm/tpm_nsc.c	2010-04-13 02:19:00.765633063 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include "tpm.h"
 
 /* National definitions */
diff -urN linux-2.6.34-rc3/drivers/char/tpm/tpm_tis.c linux-2.6.34-rc4/drivers/char/tpm/tpm_tis.c
--- linux-2.6.34-rc3/drivers/char/tpm/tpm_tis.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/tpm/tpm_tis.c	2010-04-13 02:19:00.765633063 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/pnp.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/wait.h>
 #include "tpm.h"
diff -urN linux-2.6.34-rc3/drivers/char/tty_audit.c linux-2.6.34-rc4/drivers/char/tty_audit.c
--- linux-2.6.34-rc3/drivers/char/tty_audit.c	2010-04-13 02:18:55.655633049 +0000
+++ linux-2.6.34-rc4/drivers/char/tty_audit.c	2010-04-13 02:19:00.765633063 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/audit.h>
+#include <linux/slab.h>
 #include <linux/tty.h>
 
 struct tty_audit_buf {
diff -urN linux-2.6.34-rc3/drivers/char/tty_io.c linux-2.6.34-rc4/drivers/char/tty_io.c
--- linux-2.6.34-rc3/drivers/char/tty_io.c	2010-04-13 02:18:55.655633049 +0000
+++ linux-2.6.34-rc4/drivers/char/tty_io.c	2010-04-13 02:19:00.766633011 +0000
@@ -1423,6 +1423,8 @@
 	list_del_init(&tty->tty_files);
 	file_list_unlock();
 
+	put_pid(tty->pgrp);
+	put_pid(tty->session);
 	free_tty_struct(tty);
 }
 
diff -urN linux-2.6.34-rc3/drivers/char/viotape.c linux-2.6.34-rc4/drivers/char/viotape.c
--- linux-2.6.34-rc3/drivers/char/viotape.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/viotape.c	2010-04-13 02:19:00.766633011 +0000
@@ -47,6 +47,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/ioctls.h>
diff -urN linux-2.6.34-rc3/drivers/char/virtio_console.c linux-2.6.34-rc4/drivers/char/virtio_console.c
--- linux-2.6.34-rc3/drivers/char/virtio_console.c	2010-04-13 02:18:55.656633154 +0000
+++ linux-2.6.34-rc4/drivers/char/virtio_console.c	2010-04-13 02:19:00.767633010 +0000
@@ -25,6 +25,7 @@
 #include <linux/list.h>
 #include <linux/poll.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/virtio.h>
 #include <linux/virtio_console.h>
@@ -32,6 +33,35 @@
 #include <linux/workqueue.h>
 #include "hvc_console.h"
 
+/* Moved here from .h file in order to disable MULTIPORT. */
+#define VIRTIO_CONSOLE_F_MULTIPORT 1	/* Does host provide multiple ports? */
+
+struct virtio_console_multiport_conf {
+	struct virtio_console_config config;
+	/* max. number of ports this device can hold */
+	__u32 max_nr_ports;
+	/* number of ports added so far */
+	__u32 nr_ports;
+} __attribute__((packed));
+
+/*
+ * A message that's passed between the Host and the Guest for a
+ * particular port.
+ */
+struct virtio_console_control {
+	__u32 id;		/* Port number */
+	__u16 event;		/* The kind of control event (see below) */
+	__u16 value;		/* Extra information for the key */
+};
+
+/* Some events for control messages */
+#define VIRTIO_CONSOLE_PORT_READY	0
+#define VIRTIO_CONSOLE_CONSOLE_PORT	1
+#define VIRTIO_CONSOLE_RESIZE		2
+#define VIRTIO_CONSOLE_PORT_OPEN	3
+#define VIRTIO_CONSOLE_PORT_NAME	4
+#define VIRTIO_CONSOLE_PORT_REMOVE	5
+
 /*
  * This is a global struct for storing common data for all the devices
  * this driver handles.
@@ -120,7 +150,7 @@
 	spinlock_t cvq_lock;
 
 	/* The current config space is stored here */
-	struct virtio_console_config config;
+	struct virtio_console_multiport_conf config;
 
 	/* The virtio device we're associated with */
 	struct virtio_device *vdev;
@@ -415,20 +445,16 @@
 	out_vq->vq_ops->kick(out_vq);
 
 	if (ret < 0) {
-		len = 0;
+		in_count = 0;
 		goto fail;
 	}
 
-	/*
-	 * Wait till the host acknowledges it pushed out the data we
-	 * sent. Also ensure we return to userspace the number of
-	 * bytes that were successfully consumed by the host.
-	 */
+	/* Wait till the host acknowledges it pushed out the data we sent. */
 	while (!out_vq->vq_ops->get_buf(out_vq, &len))
 		cpu_relax();
 fail:
 	/* We're expected to return the amount of data we wrote */
-	return len;
+	return in_count;
 }
 
 /*
@@ -645,13 +671,13 @@
 {
 	struct port *port;
 
+	if (unlikely(early_put_chars))
+		return early_put_chars(vtermno, buf, count);
+
 	port = find_port_by_vtermno(vtermno);
 	if (!port)
 		return 0;
 
-	if (unlikely(early_put_chars))
-		return early_put_chars(vtermno, buf, count);
-
 	return send_buf(port, (void *)buf, count);
 }
 
@@ -1217,7 +1243,7 @@
  */
 static void config_work_handler(struct work_struct *work)
 {
-	struct virtio_console_config virtconconf;
+	struct virtio_console_multiport_conf virtconconf;
 	struct ports_device *portdev;
 	struct virtio_device *vdev;
 	int err;
@@ -1226,7 +1252,8 @@
 
 	vdev = portdev->vdev;
 	vdev->config->get(vdev,
-			  offsetof(struct virtio_console_config, nr_ports),
+			  offsetof(struct virtio_console_multiport_conf,
+				   nr_ports),
 			  &virtconconf.nr_ports,
 			  sizeof(virtconconf.nr_ports));
 
@@ -1418,16 +1445,19 @@
 	multiport = false;
 	portdev->config.nr_ports = 1;
 	portdev->config.max_nr_ports = 1;
+#if 0 /* Multiport is not quite ready yet --RR */
 	if (virtio_has_feature(vdev, VIRTIO_CONSOLE_F_MULTIPORT)) {
 		multiport = true;
 		vdev->features[0] |= 1 << VIRTIO_CONSOLE_F_MULTIPORT;
 
-		vdev->config->get(vdev, offsetof(struct virtio_console_config,
-						 nr_ports),
+		vdev->config->get(vdev,
+				  offsetof(struct virtio_console_multiport_conf,
+					   nr_ports),
 				  &portdev->config.nr_ports,
 				  sizeof(portdev->config.nr_ports));
-		vdev->config->get(vdev, offsetof(struct virtio_console_config,
-						 max_nr_ports),
+		vdev->config->get(vdev,
+				  offsetof(struct virtio_console_multiport_conf,
+					   max_nr_ports),
 				  &portdev->config.max_nr_ports,
 				  sizeof(portdev->config.max_nr_ports));
 		if (portdev->config.nr_ports > portdev->config.max_nr_ports) {
@@ -1443,6 +1473,7 @@
 
 	/* Let the Host know we support multiple ports.*/
 	vdev->config->finalize_features(vdev);
+#endif
 
 	err = init_vqs(portdev);
 	if (err < 0) {
@@ -1525,7 +1556,6 @@
 
 static unsigned int features[] = {
 	VIRTIO_CONSOLE_F_SIZE,
-	VIRTIO_CONSOLE_F_MULTIPORT,
 };
 
 static struct virtio_driver virtio_console = {
diff -urN linux-2.6.34-rc3/drivers/char/vme_scc.c linux-2.6.34-rc4/drivers/char/vme_scc.c
--- linux-2.6.34-rc3/drivers/char/vme_scc.c	2010-04-13 02:18:55.657633153 +0000
+++ linux-2.6.34-rc4/drivers/char/vme_scc.c	2010-04-13 02:19:00.767633010 +0000
@@ -27,7 +27,6 @@
 #include <linux/fcntl.h>
 #include <linux/major.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/miscdevice.h>
 #include <linux/console.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/char/xilinx_hwicap/xilinx_hwicap.c linux-2.6.34-rc4/drivers/char/xilinx_hwicap/xilinx_hwicap.c
--- linux-2.6.34-rc3/drivers/char/xilinx_hwicap/xilinx_hwicap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/char/xilinx_hwicap/xilinx_hwicap.c	2010-04-13 02:19:00.768633094 +0000
@@ -86,6 +86,7 @@
 #include <linux/fs.h>
 #include <linux/cdev.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/clocksource/sh_cmt.c linux-2.6.34-rc4/drivers/clocksource/sh_cmt.c
--- linux-2.6.34-rc3/drivers/clocksource/sh_cmt.c	2010-04-13 02:18:55.658633039 +0000
+++ linux-2.6.34-rc4/drivers/clocksource/sh_cmt.c	2010-04-13 02:19:00.769633087 +0000
@@ -29,6 +29,7 @@
 #include <linux/clocksource.h>
 #include <linux/clockchips.h>
 #include <linux/sh_timer.h>
+#include <linux/slab.h>
 
 struct sh_cmt_priv {
 	void __iomem *mapbase;
diff -urN linux-2.6.34-rc3/drivers/clocksource/sh_mtu2.c linux-2.6.34-rc4/drivers/clocksource/sh_mtu2.c
--- linux-2.6.34-rc3/drivers/clocksource/sh_mtu2.c	2010-04-13 02:18:55.658633039 +0000
+++ linux-2.6.34-rc4/drivers/clocksource/sh_mtu2.c	2010-04-13 02:19:00.769633087 +0000
@@ -29,6 +29,7 @@
 #include <linux/err.h>
 #include <linux/clockchips.h>
 #include <linux/sh_timer.h>
+#include <linux/slab.h>
 
 struct sh_mtu2_priv {
 	void __iomem *mapbase;
diff -urN linux-2.6.34-rc3/drivers/clocksource/sh_tmu.c linux-2.6.34-rc4/drivers/clocksource/sh_tmu.c
--- linux-2.6.34-rc3/drivers/clocksource/sh_tmu.c	2010-04-13 02:18:55.658633039 +0000
+++ linux-2.6.34-rc4/drivers/clocksource/sh_tmu.c	2010-04-13 02:19:00.769633087 +0000
@@ -30,6 +30,7 @@
 #include <linux/clocksource.h>
 #include <linux/clockchips.h>
 #include <linux/sh_timer.h>
+#include <linux/slab.h>
 
 struct sh_tmu_priv {
 	void __iomem *mapbase;
diff -urN linux-2.6.34-rc3/drivers/connector/cn_proc.c linux-2.6.34-rc4/drivers/connector/cn_proc.c
--- linux-2.6.34-rc3/drivers/connector/cn_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/connector/cn_proc.c	2010-04-13 02:19:00.769633087 +0000
@@ -27,6 +27,7 @@
 #include <linux/ktime.h>
 #include <linux/init.h>
 #include <linux/connector.h>
+#include <linux/gfp.h>
 #include <asm/atomic.h>
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/drivers/connector/connector.c linux-2.6.34-rc4/drivers/connector/connector.c
--- linux-2.6.34-rc3/drivers/connector/connector.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/connector/connector.c	2010-04-13 02:19:00.769633087 +0000
@@ -26,6 +26,7 @@
 #include <linux/netlink.h>
 #include <linux/moduleparam.h>
 #include <linux/connector.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/proc_fs.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/cpufreq/cpufreq_stats.c linux-2.6.34-rc4/drivers/cpufreq/cpufreq_stats.c
--- linux-2.6.34-rc3/drivers/cpufreq/cpufreq_stats.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/cpufreq/cpufreq_stats.c	2010-04-13 02:19:00.770633074 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/sysdev.h>
 #include <linux/cpu.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/cpuidle/sysfs.c linux-2.6.34-rc4/drivers/cpuidle/sysfs.c
--- linux-2.6.34-rc3/drivers/cpuidle/sysfs.c	2010-04-13 02:18:55.659571804 +0000
+++ linux-2.6.34-rc4/drivers/cpuidle/sysfs.c	2010-04-13 02:19:00.770633074 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/cpuidle.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 #include <linux/cpu.h>
 
 #include "cpuidle.h"
diff -urN linux-2.6.34-rc3/drivers/crypto/amcc/crypto4xx_core.c linux-2.6.34-rc4/drivers/crypto/amcc/crypto4xx_core.c
--- linux-2.6.34-rc3/drivers/crypto/amcc/crypto4xx_core.c	2010-04-13 02:18:55.659571804 +0000
+++ linux-2.6.34-rc4/drivers/crypto/amcc/crypto4xx_core.c	2010-04-13 02:19:00.770633074 +0000
@@ -28,6 +28,7 @@
 #include <linux/platform_device.h>
 #include <linux/init.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 #include <asm/dcr.h>
 #include <asm/dcr-regs.h>
 #include <asm/cacheflush.h>
diff -urN linux-2.6.34-rc3/drivers/crypto/ixp4xx_crypto.c linux-2.6.34-rc4/drivers/crypto/ixp4xx_crypto.c
--- linux-2.6.34-rc3/drivers/crypto/ixp4xx_crypto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/crypto/ixp4xx_crypto.c	2010-04-13 02:19:00.771633052 +0000
@@ -17,6 +17,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
+#include <linux/gfp.h>
 
 #include <crypto/ctr.h>
 #include <crypto/des.h>
diff -urN linux-2.6.34-rc3/drivers/crypto/mv_cesa.c linux-2.6.34-rc4/drivers/crypto/mv_cesa.c
--- linux-2.6.34-rc3/drivers/crypto/mv_cesa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/crypto/mv_cesa.c	2010-04-13 02:19:00.771633052 +0000
@@ -14,6 +14,7 @@
 #include <linux/kthread.h>
 #include <linux/platform_device.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include "mv_cesa.h"
 /*
diff -urN linux-2.6.34-rc3/drivers/crypto/padlock-aes.c linux-2.6.34-rc4/drivers/crypto/padlock-aes.c
--- linux-2.6.34-rc3/drivers/crypto/padlock-aes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/crypto/padlock-aes.c	2010-04-13 02:19:00.771633052 +0000
@@ -17,6 +17,7 @@
 #include <linux/kernel.h>
 #include <linux/percpu.h>
 #include <linux/smp.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include <asm/processor.h>
 #include <asm/i387.h>
diff -urN linux-2.6.34-rc3/drivers/crypto/talitos.c linux-2.6.34-rc4/drivers/crypto/talitos.c
--- linux-2.6.34-rc3/drivers/crypto/talitos.c	2010-04-13 02:18:55.660570478 +0000
+++ linux-2.6.34-rc4/drivers/crypto/talitos.c	2010-04-13 02:19:00.771633052 +0000
@@ -37,6 +37,7 @@
 #include <linux/io.h>
 #include <linux/spinlock.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 
 #include <crypto/algapi.h>
 #include <crypto/aes.h>
diff -urN linux-2.6.34-rc3/drivers/dca/dca-core.c linux-2.6.34-rc4/drivers/dca/dca-core.c
--- linux-2.6.34-rc3/drivers/dca/dca-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dca/dca-core.c	2010-04-13 02:19:00.771633052 +0000
@@ -27,6 +27,7 @@
 #include <linux/notifier.h>
 #include <linux/device.h>
 #include <linux/dca.h>
+#include <linux/slab.h>
 
 #define DCA_VERSION "1.12.1"
 
diff -urN linux-2.6.34-rc3/drivers/dca/dca-sysfs.c linux-2.6.34-rc4/drivers/dca/dca-sysfs.c
--- linux-2.6.34-rc3/drivers/dca/dca-sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dca/dca-sysfs.c	2010-04-13 02:19:00.771633052 +0000
@@ -26,6 +26,7 @@
 #include <linux/kdev_t.h>
 #include <linux/err.h>
 #include <linux/dca.h>
+#include <linux/gfp.h>
 
 static struct class *dca_class;
 static struct idr dca_idr;
diff -urN linux-2.6.34-rc3/drivers/dma/at_hdmac.c linux-2.6.34-rc4/drivers/dma/at_hdmac.c
--- linux-2.6.34-rc3/drivers/dma/at_hdmac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dma/at_hdmac.c	2010-04-13 02:19:00.772633207 +0000
@@ -22,6 +22,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include "at_hdmac_regs.h"
 
diff -urN linux-2.6.34-rc3/drivers/dma/coh901318_lli.c linux-2.6.34-rc4/drivers/dma/coh901318_lli.c
--- linux-2.6.34-rc3/drivers/dma/coh901318_lli.c	2010-04-13 02:18:55.661633056 +0000
+++ linux-2.6.34-rc4/drivers/dma/coh901318_lli.c	2010-04-13 02:19:00.772633207 +0000
@@ -11,6 +11,7 @@
 #include <linux/spinlock.h>
 #include <linux/dmapool.h>
 #include <linux/memory.h>
+#include <linux/gfp.h>
 #include <mach/coh901318.h>
 
 #include "coh901318_lli.h"
diff -urN linux-2.6.34-rc3/drivers/dma/dmaengine.c linux-2.6.34-rc4/drivers/dma/dmaengine.c
--- linux-2.6.34-rc3/drivers/dma/dmaengine.c	2010-04-13 02:18:55.661633056 +0000
+++ linux-2.6.34-rc4/drivers/dma/dmaengine.c	2010-04-13 02:19:00.773633068 +0000
@@ -58,6 +58,7 @@
 #include <linux/jiffies.h>
 #include <linux/rculist.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 
 static DEFINE_MUTEX(dma_list_mutex);
 static LIST_HEAD(dma_device_list);
diff -urN linux-2.6.34-rc3/drivers/dma/dmatest.c linux-2.6.34-rc4/drivers/dma/dmatest.c
--- linux-2.6.34-rc3/drivers/dma/dmatest.c	2010-04-13 02:18:55.661633056 +0000
+++ linux-2.6.34-rc4/drivers/dma/dmatest.c	2010-04-13 02:19:00.773633068 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/wait.h>
 
 static unsigned int test_buf_size = 16384;
diff -urN linux-2.6.34-rc3/drivers/dma/fsldma.c linux-2.6.34-rc4/drivers/dma/fsldma.c
--- linux-2.6.34-rc3/drivers/dma/fsldma.c	2010-04-13 02:18:55.662633044 +0000
+++ linux-2.6.34-rc4/drivers/dma/fsldma.c	2010-04-13 02:19:00.774633052 +0000
@@ -27,6 +27,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/dmaengine.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/dma/ioat/dma.c linux-2.6.34-rc4/drivers/dma/ioat/dma.c
--- linux-2.6.34-rc3/drivers/dma/ioat/dma.c	2010-04-13 02:18:55.662633044 +0000
+++ linux-2.6.34-rc4/drivers/dma/ioat/dma.c	2010-04-13 02:19:00.774633052 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/dmaengine.h>
diff -urN linux-2.6.34-rc3/drivers/dma/ioat/dma_v2.c linux-2.6.34-rc4/drivers/dma/ioat/dma_v2.c
--- linux-2.6.34-rc3/drivers/dma/ioat/dma_v2.c	2010-04-13 02:18:55.663633044 +0000
+++ linux-2.6.34-rc4/drivers/dma/ioat/dma_v2.c	2010-04-13 02:19:00.775633012 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/dmaengine.h>
diff -urN linux-2.6.34-rc3/drivers/dma/ioat/dma_v3.c linux-2.6.34-rc4/drivers/dma/ioat/dma_v3.c
--- linux-2.6.34-rc3/drivers/dma/ioat/dma_v3.c	2010-04-13 02:18:55.663633044 +0000
+++ linux-2.6.34-rc4/drivers/dma/ioat/dma_v3.c	2010-04-13 02:19:00.775633012 +0000
@@ -57,6 +57,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <linux/dmaengine.h>
 #include <linux/dma-mapping.h>
 #include "registers.h"
diff -urN linux-2.6.34-rc3/drivers/dma/ioat/pci.c linux-2.6.34-rc4/drivers/dma/ioat/pci.c
--- linux-2.6.34-rc3/drivers/dma/ioat/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dma/ioat/pci.c	2010-04-13 02:19:00.775633012 +0000
@@ -30,6 +30,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/dca.h>
+#include <linux/slab.h>
 #include "dma.h"
 #include "dma_v2.h"
 #include "registers.h"
diff -urN linux-2.6.34-rc3/drivers/dma/iop-adma.c linux-2.6.34-rc4/drivers/dma/iop-adma.c
--- linux-2.6.34-rc3/drivers/dma/iop-adma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dma/iop-adma.c	2010-04-13 02:19:00.775633012 +0000
@@ -32,6 +32,7 @@
 #include <linux/memory.h>
 #include <linux/ioport.h>
 #include <linux/raid/pq.h>
+#include <linux/slab.h>
 
 #include <mach/adma.h>
 
diff -urN linux-2.6.34-rc3/drivers/dma/iovlock.c linux-2.6.34-rc4/drivers/dma/iovlock.c
--- linux-2.6.34-rc3/drivers/dma/iovlock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dma/iovlock.c	2010-04-13 02:19:00.776633056 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/dmaengine.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <net/tcp.h> /* for memcpy_toiovec */
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/dma/mpc512x_dma.c linux-2.6.34-rc4/drivers/dma/mpc512x_dma.c
--- linux-2.6.34-rc3/drivers/dma/mpc512x_dma.c	2010-04-13 02:18:55.664633071 +0000
+++ linux-2.6.34-rc4/drivers/dma/mpc512x_dma.c	2010-04-13 02:19:00.776633056 +0000
@@ -37,6 +37,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/of_device.h>
 #include <linux/of_platform.h>
 
diff -urN linux-2.6.34-rc3/drivers/dma/mv_xor.c linux-2.6.34-rc4/drivers/dma/mv_xor.c
--- linux-2.6.34-rc3/drivers/dma/mv_xor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/dma/mv_xor.c	2010-04-13 02:19:00.776633056 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/dma/ppc4xx/adma.c linux-2.6.34-rc4/drivers/dma/ppc4xx/adma.c
--- linux-2.6.34-rc3/drivers/dma/ppc4xx/adma.c	2010-04-13 02:18:55.665633049 +0000
+++ linux-2.6.34-rc4/drivers/dma/ppc4xx/adma.c	2010-04-13 02:19:00.777633064 +0000
@@ -38,6 +38,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/spinlock.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/proc_fs.h>
 #include <linux/of.h>
diff -urN linux-2.6.34-rc3/drivers/dma/shdma.c linux-2.6.34-rc4/drivers/dma/shdma.c
--- linux-2.6.34-rc3/drivers/dma/shdma.c	2010-04-13 02:18:55.665633049 +0000
+++ linux-2.6.34-rc4/drivers/dma/shdma.c	2010-04-13 02:19:00.778633015 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/dmaengine.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/edac/amd76x_edac.c linux-2.6.34-rc4/drivers/edac/amd76x_edac.c
--- linux-2.6.34-rc3/drivers/edac/amd76x_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/amd76x_edac.c	2010-04-13 02:19:00.779633368 +0000
@@ -16,7 +16,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/cpc925_edac.c linux-2.6.34-rc4/drivers/edac/cpc925_edac.c
--- linux-2.6.34-rc3/drivers/edac/cpc925_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/cpc925_edac.c	2010-04-13 02:19:00.779633368 +0000
@@ -25,6 +25,7 @@
 #include <linux/edac.h>
 #include <linux/of.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 
 #include "edac_core.h"
 #include "edac_module.h"
diff -urN linux-2.6.34-rc3/drivers/edac/e752x_edac.c linux-2.6.34-rc4/drivers/edac/e752x_edac.c
--- linux-2.6.34-rc3/drivers/edac/e752x_edac.c	2010-04-13 02:18:55.666633064 +0000
+++ linux-2.6.34-rc4/drivers/edac/e752x_edac.c	2010-04-13 02:19:00.779633368 +0000
@@ -21,7 +21,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/e7xxx_edac.c linux-2.6.34-rc4/drivers/edac/e7xxx_edac.c
--- linux-2.6.34-rc3/drivers/edac/e7xxx_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/e7xxx_edac.c	2010-04-13 02:19:00.780633067 +0000
@@ -26,7 +26,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/edac_device_sysfs.c linux-2.6.34-rc4/drivers/edac/edac_device_sysfs.c
--- linux-2.6.34-rc3/drivers/edac/edac_device_sysfs.c	2010-04-13 02:18:55.667633073 +0000
+++ linux-2.6.34-rc4/drivers/edac/edac_device_sysfs.c	2010-04-13 02:19:00.780633067 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/ctype.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "edac_core.h"
 #include "edac_module.h"
diff -urN linux-2.6.34-rc3/drivers/edac/edac_mc_sysfs.c linux-2.6.34-rc4/drivers/edac/edac_mc_sysfs.c
--- linux-2.6.34-rc3/drivers/edac/edac_mc_sysfs.c	2010-04-13 02:18:55.667633073 +0000
+++ linux-2.6.34-rc4/drivers/edac/edac_mc_sysfs.c	2010-04-13 02:19:00.780633067 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/bug.h>
 
 #include "edac_core.h"
diff -urN linux-2.6.34-rc3/drivers/edac/edac_pci_sysfs.c linux-2.6.34-rc4/drivers/edac/edac_pci_sysfs.c
--- linux-2.6.34-rc3/drivers/edac/edac_pci_sysfs.c	2010-04-13 02:18:55.667633073 +0000
+++ linux-2.6.34-rc4/drivers/edac/edac_pci_sysfs.c	2010-04-13 02:19:00.780633067 +0000
@@ -8,6 +8,7 @@
  */
 #include <linux/module.h>
 #include <linux/sysdev.h>
+#include <linux/slab.h>
 #include <linux/ctype.h>
 
 #include "edac_core.h"
diff -urN linux-2.6.34-rc3/drivers/edac/i3000_edac.c linux-2.6.34-rc4/drivers/edac/i3000_edac.c
--- linux-2.6.34-rc3/drivers/edac/i3000_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i3000_edac.c	2010-04-13 02:19:00.780633067 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/i3200_edac.c linux-2.6.34-rc4/drivers/edac/i3200_edac.c
--- linux-2.6.34-rc3/drivers/edac/i3200_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i3200_edac.c	2010-04-13 02:19:00.780633067 +0000
@@ -11,7 +11,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include <linux/io.h>
 #include "edac_core.h"
diff -urN linux-2.6.34-rc3/drivers/edac/i5100_edac.c linux-2.6.34-rc4/drivers/edac/i5100_edac.c
--- linux-2.6.34-rc3/drivers/edac/i5100_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i5100_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -19,7 +19,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include <linux/delay.h>
 #include <linux/mmzone.h>
diff -urN linux-2.6.34-rc3/drivers/edac/i82443bxgx_edac.c linux-2.6.34-rc4/drivers/edac/i82443bxgx_edac.c
--- linux-2.6.34-rc3/drivers/edac/i82443bxgx_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i82443bxgx_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -27,7 +27,6 @@
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
 
-#include <linux/slab.h>
 
 #include <linux/edac.h>
 #include "edac_core.h"
diff -urN linux-2.6.34-rc3/drivers/edac/i82860_edac.c linux-2.6.34-rc4/drivers/edac/i82860_edac.c
--- linux-2.6.34-rc3/drivers/edac/i82860_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i82860_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/i82875p_edac.c linux-2.6.34-rc4/drivers/edac/i82875p_edac.c
--- linux-2.6.34-rc3/drivers/edac/i82875p_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i82875p_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -17,7 +17,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/i82975x_edac.c linux-2.6.34-rc4/drivers/edac/i82975x_edac.c
--- linux-2.6.34-rc3/drivers/edac/i82975x_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/i82975x_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/mpc85xx_edac.c linux-2.6.34-rc4/drivers/edac/mpc85xx_edac.c
--- linux-2.6.34-rc3/drivers/edac/mpc85xx_edac.c	2010-04-13 02:18:55.667633073 +0000
+++ linux-2.6.34-rc4/drivers/edac/mpc85xx_edac.c	2010-04-13 02:19:00.781633063 +0000
@@ -11,13 +11,13 @@
  */
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/ctype.h>
 #include <linux/io.h>
 #include <linux/mod_devicetable.h>
 #include <linux/edac.h>
 #include <linux/smp.h>
+#include <linux/gfp.h>
 
 #include <linux/of_platform.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/drivers/edac/mv64x60_edac.c linux-2.6.34-rc4/drivers/edac/mv64x60_edac.c
--- linux-2.6.34-rc3/drivers/edac/mv64x60_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/mv64x60_edac.c	2010-04-13 02:19:00.782633050 +0000
@@ -12,10 +12,10 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
 #include <linux/edac.h>
+#include <linux/gfp.h>
 
 #include "edac_core.h"
 #include "edac_module.h"
diff -urN linux-2.6.34-rc3/drivers/edac/pasemi_edac.c linux-2.6.34-rc4/drivers/edac/pasemi_edac.c
--- linux-2.6.34-rc3/drivers/edac/pasemi_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/pasemi_edac.c	2010-04-13 02:19:00.782633050 +0000
@@ -25,7 +25,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/r82600_edac.c linux-2.6.34-rc4/drivers/edac/r82600_edac.c
--- linux-2.6.34-rc3/drivers/edac/r82600_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/r82600_edac.c	2010-04-13 02:19:00.782633050 +0000
@@ -19,7 +19,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/edac/x38_edac.c linux-2.6.34-rc4/drivers/edac/x38_edac.c
--- linux-2.6.34-rc3/drivers/edac/x38_edac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/edac/x38_edac.c	2010-04-13 02:19:00.782633050 +0000
@@ -13,7 +13,6 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
-#include <linux/slab.h>
 #include <linux/edac.h>
 #include "edac_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/firewire/core-cdev.c linux-2.6.34-rc4/drivers/firewire/core-cdev.c
--- linux-2.6.34-rc3/drivers/firewire/core-cdev.c	2010-04-13 02:18:55.668633121 +0000
+++ linux-2.6.34-rc4/drivers/firewire/core-cdev.c	2010-04-13 02:19:00.783633052 +0000
@@ -34,6 +34,7 @@
 #include <linux/mutex.h>
 #include <linux/poll.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/drivers/firewire/core-device.c linux-2.6.34-rc4/drivers/firewire/core-device.c
--- linux-2.6.34-rc3/drivers/firewire/core-device.c	2010-04-13 02:18:55.669571801 +0000
+++ linux-2.6.34-rc4/drivers/firewire/core-device.c	2010-04-13 02:19:00.783633052 +0000
@@ -33,6 +33,7 @@
 #include <linux/module.h>
 #include <linux/mutex.h>
 #include <linux/rwsem.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/firewire/core-iso.c linux-2.6.34-rc4/drivers/firewire/core-iso.c
--- linux-2.6.34-rc3/drivers/firewire/core-iso.c	2010-04-13 02:18:55.669571801 +0000
+++ linux-2.6.34-rc4/drivers/firewire/core-iso.c	2010-04-13 02:19:00.783633052 +0000
@@ -26,6 +26,7 @@
 #include <linux/firewire-constants.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/vmalloc.h>
 
diff -urN linux-2.6.34-rc3/drivers/firewire/net.c linux-2.6.34-rc4/drivers/firewire/net.c
--- linux-2.6.34-rc3/drivers/firewire/net.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firewire/net.c	2010-04-13 02:19:00.784633045 +0000
@@ -21,6 +21,7 @@
 #include <linux/mutex.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/drivers/firewire/ohci.c linux-2.6.34-rc4/drivers/firewire/ohci.c
--- linux-2.6.34-rc3/drivers/firewire/ohci.c	2010-04-13 02:18:55.670570466 +0000
+++ linux-2.6.34-rc4/drivers/firewire/ohci.c	2010-04-13 02:19:00.785633092 +0000
@@ -24,7 +24,6 @@
 #include <linux/dma-mapping.h>
 #include <linux/firewire.h>
 #include <linux/firewire-constants.h>
-#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
@@ -35,6 +34,7 @@
 #include <linux/moduleparam.h>
 #include <linux/pci.h>
 #include <linux/pci_ids.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 
diff -urN linux-2.6.34-rc3/drivers/firmware/dcdbas.c linux-2.6.34-rc4/drivers/firmware/dcdbas.c
--- linux-2.6.34-rc3/drivers/firmware/dcdbas.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firmware/dcdbas.c	2010-04-13 02:19:00.785633092 +0000
@@ -23,6 +23,7 @@
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/mc146818rtc.h>
diff -urN linux-2.6.34-rc3/drivers/firmware/dell_rbu.c linux-2.6.34-rc4/drivers/firmware/dell_rbu.c
--- linux-2.6.34-rc3/drivers/firmware/dell_rbu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firmware/dell_rbu.c	2010-04-13 02:19:00.785633092 +0000
@@ -36,6 +36,7 @@
  */
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/firmware/dmi-id.c linux-2.6.34-rc4/drivers/firmware/dmi-id.c
--- linux-2.6.34-rc3/drivers/firmware/dmi-id.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firmware/dmi-id.c	2010-04-13 02:19:00.785633092 +0000
@@ -11,6 +11,7 @@
 #include <linux/init.h>
 #include <linux/dmi.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 struct dmi_device_attribute{
 	struct device_attribute dev_attr;
diff -urN linux-2.6.34-rc3/drivers/firmware/dmi_scan.c linux-2.6.34-rc4/drivers/firmware/dmi_scan.c
--- linux-2.6.34-rc3/drivers/firmware/dmi_scan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firmware/dmi_scan.c	2010-04-13 02:19:00.785633092 +0000
@@ -5,7 +5,6 @@
 #include <linux/dmi.h>
 #include <linux/efi.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
 #include <asm/dmi.h>
 
 /*
diff -urN linux-2.6.34-rc3/drivers/firmware/efivars.c linux-2.6.34-rc4/drivers/firmware/efivars.c
--- linux-2.6.34-rc3/drivers/firmware/efivars.c	2010-04-13 02:18:55.670570466 +0000
+++ linux-2.6.34-rc4/drivers/firmware/efivars.c	2010-04-13 02:19:00.786633001 +0000
@@ -77,6 +77,7 @@
 #include <linux/sysfs.h>
 #include <linux/kobject.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/firmware/iscsi_ibft_find.c linux-2.6.34-rc4/drivers/firmware/iscsi_ibft_find.c
--- linux-2.6.34-rc3/drivers/firmware/iscsi_ibft_find.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/firmware/iscsi_ibft_find.c	2010-04-13 02:19:00.786633001 +0000
@@ -27,7 +27,6 @@
 #include <linux/limits.h>
 #include <linux/module.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/stat.h>
 #include <linux/string.h>
 #include <linux/types.h>
@@ -52,7 +51,7 @@
  * Routine used to find the iSCSI Boot Format Table. The logical
  * kernel address is set in the ibft_addr global variable.
  */
-void __init reserve_ibft_region(void)
+unsigned long __init find_ibft_region(unsigned long *sizep)
 {
 	unsigned long pos;
 	unsigned int len = 0;
@@ -78,6 +77,11 @@
 			}
 		}
 	}
-	if (ibft_addr)
-		reserve_bootmem(pos, PAGE_ALIGN(len), BOOTMEM_DEFAULT);
+	if (ibft_addr) {
+		*sizep = PAGE_ALIGN(len);
+		return pos;
+	}
+
+	*sizep = 0;
+	return 0;
 }
diff -urN linux-2.6.34-rc3/drivers/firmware/memmap.c linux-2.6.34-rc4/drivers/firmware/memmap.c
--- linux-2.6.34-rc3/drivers/firmware/memmap.c	2010-04-13 02:18:55.671633042 +0000
+++ linux-2.6.34-rc4/drivers/firmware/memmap.c	2010-04-13 02:19:00.786633001 +0000
@@ -20,6 +20,7 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 
 /*
  * Data types ------------------------------------------------------------------
diff -urN linux-2.6.34-rc3/drivers/gpio/adp5520-gpio.c linux-2.6.34-rc4/drivers/gpio/adp5520-gpio.c
--- linux-2.6.34-rc3/drivers/gpio/adp5520-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/adp5520-gpio.c	2010-04-13 02:19:00.786633001 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/adp5588-gpio.c linux-2.6.34-rc4/drivers/gpio/adp5588-gpio.c
--- linux-2.6.34-rc3/drivers/gpio/adp5588-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/adp5588-gpio.c	2010-04-13 02:19:00.786633001 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/i2c.h>
 #include <linux/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/bt8xxgpio.c linux-2.6.34-rc4/drivers/gpio/bt8xxgpio.c
--- linux-2.6.34-rc3/drivers/gpio/bt8xxgpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/bt8xxgpio.c	2010-04-13 02:19:00.787633045 +0000
@@ -47,6 +47,7 @@
 #include <linux/pci.h>
 #include <linux/spinlock.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 /* Steal the hardware definitions from the bttv driver. */
 #include "../media/video/bt8xx/bt848.h"
diff -urN linux-2.6.34-rc3/drivers/gpio/gpiolib.c linux-2.6.34-rc4/drivers/gpio/gpiolib.c
--- linux-2.6.34-rc3/drivers/gpio/gpiolib.c	2010-04-13 02:18:55.671633042 +0000
+++ linux-2.6.34-rc4/drivers/gpio/gpiolib.c	2010-04-13 02:19:00.787633045 +0000
@@ -9,6 +9,7 @@
 #include <linux/seq_file.h>
 #include <linux/gpio.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 
 
 /* Optional implementation infrastructure for GPIO interfaces.
diff -urN linux-2.6.34-rc3/drivers/gpio/langwell_gpio.c linux-2.6.34-rc4/drivers/gpio/langwell_gpio.c
--- linux-2.6.34-rc3/drivers/gpio/langwell_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/langwell_gpio.c	2010-04-13 02:19:00.787633045 +0000
@@ -29,6 +29,7 @@
 #include <linux/irq.h>
 #include <linux/io.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 struct lnw_gpio_register {
 	u32	GPLR[2];
diff -urN linux-2.6.34-rc3/drivers/gpio/max7300.c linux-2.6.34-rc4/drivers/gpio/max7300.c
--- linux-2.6.34-rc3/drivers/gpio/max7300.c	2010-04-13 02:18:55.672633018 +0000
+++ linux-2.6.34-rc4/drivers/gpio/max7300.c	2010-04-13 02:19:00.787633045 +0000
@@ -16,6 +16,7 @@
 #include <linux/mutex.h>
 #include <linux/i2c.h>
 #include <linux/spi/max7301.h>
+#include <linux/slab.h>
 
 static int max7300_i2c_write(struct device *dev, unsigned int reg,
 				unsigned int val)
diff -urN linux-2.6.34-rc3/drivers/gpio/max7301.c linux-2.6.34-rc4/drivers/gpio/max7301.c
--- linux-2.6.34-rc3/drivers/gpio/max7301.c	2010-04-13 02:18:55.672633018 +0000
+++ linux-2.6.34-rc4/drivers/gpio/max7301.c	2010-04-13 02:19:00.787633045 +0000
@@ -16,6 +16,7 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/max7301.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpio/max730x.c linux-2.6.34-rc4/drivers/gpio/max730x.c
--- linux-2.6.34-rc3/drivers/gpio/max730x.c	2010-04-13 02:18:55.672633018 +0000
+++ linux-2.6.34-rc4/drivers/gpio/max730x.c	2010-04-13 02:19:00.788633050 +0000
@@ -38,6 +38,7 @@
 #include <linux/mutex.h>
 #include <linux/spi/max7301.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 /*
  * Pin configurations, see MAX7301 datasheet page 6
diff -urN linux-2.6.34-rc3/drivers/gpio/mc33880.c linux-2.6.34-rc4/drivers/gpio/mc33880.c
--- linux-2.6.34-rc3/drivers/gpio/mc33880.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/mc33880.c	2010-04-13 02:19:00.788633050 +0000
@@ -25,6 +25,7 @@
 #include <linux/spi/spi.h>
 #include <linux/spi/mc33880.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "mc33880"
 
diff -urN linux-2.6.34-rc3/drivers/gpio/mcp23s08.c linux-2.6.34-rc4/drivers/gpio/mcp23s08.c
--- linux-2.6.34-rc3/drivers/gpio/mcp23s08.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/mcp23s08.c	2010-04-13 02:19:00.788633050 +0000
@@ -9,6 +9,7 @@
 #include <linux/gpio.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/mcp23s08.h>
+#include <linux/slab.h>
 
 
 /* Registers are all 8 bits wide.
diff -urN linux-2.6.34-rc3/drivers/gpio/pca953x.c linux-2.6.34-rc4/drivers/gpio/pca953x.c
--- linux-2.6.34-rc3/drivers/gpio/pca953x.c	2010-04-13 02:18:55.672633018 +0000
+++ linux-2.6.34-rc4/drivers/gpio/pca953x.c	2010-04-13 02:19:00.788633050 +0000
@@ -18,6 +18,7 @@
 #include <linux/irq.h>
 #include <linux/i2c.h>
 #include <linux/i2c/pca953x.h>
+#include <linux/slab.h>
 #ifdef CONFIG_OF_GPIO
 #include <linux/of_platform.h>
 #include <linux/of_gpio.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/pl061.c linux-2.6.34-rc4/drivers/gpio/pl061.c
--- linux-2.6.34-rc3/drivers/gpio/pl061.c	2010-04-13 02:18:55.672633018 +0000
+++ linux-2.6.34-rc4/drivers/gpio/pl061.c	2010-04-13 02:19:00.788633050 +0000
@@ -24,6 +24,7 @@
 #include <linux/device.h>
 #include <linux/amba/bus.h>
 #include <linux/amba/pl061.h>
+#include <linux/slab.h>
 
 #define GPIODIR 0x400
 #define GPIOIS  0x404
diff -urN linux-2.6.34-rc3/drivers/gpio/timbgpio.c linux-2.6.34-rc4/drivers/gpio/timbgpio.c
--- linux-2.6.34-rc3/drivers/gpio/timbgpio.c	2010-04-13 02:18:55.673633128 +0000
+++ linux-2.6.34-rc4/drivers/gpio/timbgpio.c	2010-04-13 02:19:00.788633050 +0000
@@ -27,6 +27,7 @@
 #include <linux/io.h>
 #include <linux/timb_gpio.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "timb-gpio"
 
@@ -130,6 +131,7 @@
 	unsigned long flags;
 	u32 lvr, flr, bflr = 0;
 	u32 ver;
+	int ret = 0;
 
 	if (offset < 0 || offset > tgpio->gpio.ngpio)
 		return -EINVAL;
@@ -153,8 +155,10 @@
 	}
 
 	if ((trigger & IRQ_TYPE_EDGE_BOTH) == IRQ_TYPE_EDGE_BOTH) {
-		if (ver < 3)
-			return -EINVAL;
+		if (ver < 3) {
+			ret = -EINVAL;
+			goto out;
+		}
 		else {
 			flr |= 1 << offset;
 			bflr |= 1 << offset;
@@ -174,9 +178,10 @@
 		iowrite32(bflr, tgpio->membase + TGPIO_BFLR);
 
 	iowrite32(1 << offset, tgpio->membase + TGPIO_ICR);
-	spin_unlock_irqrestore(&tgpio->lock, flags);
 
-	return 0;
+out:
+	spin_unlock_irqrestore(&tgpio->lock, flags);
+	return ret;
 }
 
 static void timbgpio_irq(unsigned int irq, struct irq_desc *desc)
diff -urN linux-2.6.34-rc3/drivers/gpio/twl4030-gpio.c linux-2.6.34-rc4/drivers/gpio/twl4030-gpio.c
--- linux-2.6.34-rc3/drivers/gpio/twl4030-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/twl4030-gpio.c	2010-04-13 02:19:00.789633058 +0000
@@ -32,7 +32,6 @@
 #include <linux/irq.h>
 #include <linux/gpio.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 
 #include <linux/i2c/twl.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpio/wm831x-gpio.c linux-2.6.34-rc4/drivers/gpio/wm831x-gpio.c
--- linux-2.6.34-rc3/drivers/gpio/wm831x-gpio.c	2010-04-13 02:18:55.673633128 +0000
+++ linux-2.6.34-rc4/drivers/gpio/wm831x-gpio.c	2010-04-13 02:19:00.789633058 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/gpio.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/wm8350-gpiolib.c linux-2.6.34-rc4/drivers/gpio/wm8350-gpiolib.c
--- linux-2.6.34-rc3/drivers/gpio/wm8350-gpiolib.c	2010-04-13 02:18:55.673633128 +0000
+++ linux-2.6.34-rc4/drivers/gpio/wm8350-gpiolib.c	2010-04-13 02:19:00.789633058 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/gpio.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/wm8994-gpio.c linux-2.6.34-rc4/drivers/gpio/wm8994-gpio.c
--- linux-2.6.34-rc3/drivers/gpio/wm8994-gpio.c	2010-04-13 02:18:55.673633128 +0000
+++ linux-2.6.34-rc4/drivers/gpio/wm8994-gpio.c	2010-04-13 02:19:00.789633058 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/gpio.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/gpio/xilinx_gpio.c linux-2.6.34-rc4/drivers/gpio/xilinx_gpio.c
--- linux-2.6.34-rc3/drivers/gpio/xilinx_gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpio/xilinx_gpio.c	2010-04-13 02:19:00.789633058 +0000
@@ -19,6 +19,7 @@
 #include <linux/of_gpio.h>
 #include <linux/io.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 /* Register Offset Definitions */
 #define XGPIO_DATA_OFFSET   (0x0)	/* Data register  */
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_agpsupport.c linux-2.6.34-rc4/drivers/gpu/drm/drm_agpsupport.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_agpsupport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_agpsupport.c	2010-04-13 02:19:00.789633058 +0000
@@ -33,6 +33,7 @@
 
 #include "drmP.h"
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #if __OS_HAS_AGP
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_bufs.c linux-2.6.34-rc4/drivers/gpu/drm/drm_bufs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_bufs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_bufs.c	2010-04-13 02:19:00.790633057 +0000
@@ -34,6 +34,7 @@
  */
 
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/log2.h>
 #include <asm/shmparam.h>
 #include "drmP.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_crtc.c linux-2.6.34-rc4/drivers/gpu/drm/drm_crtc.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_crtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_crtc.c	2010-04-13 02:19:00.790633057 +0000
@@ -30,6 +30,7 @@
  *      Jesse Barnes <jesse.barnes@intel.com>
  */
 #include <linux/list.h>
+#include <linux/slab.h>
 #include "drm.h"
 #include "drmP.h"
 #include "drm_crtc.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_crtc_helper.c linux-2.6.34-rc4/drivers/gpu/drm/drm_crtc_helper.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_crtc_helper.c	2010-04-13 02:18:55.673633128 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_crtc_helper.c	2010-04-13 02:19:00.790633057 +0000
@@ -104,6 +104,7 @@
 	if (connector->status == connector_status_disconnected) {
 		DRM_DEBUG_KMS("%s is disconnected\n",
 			  drm_get_connector_name(connector));
+		drm_mode_connector_update_edid_property(connector, NULL);
 		goto prune;
 	}
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_debugfs.c linux-2.6.34-rc4/drivers/gpu/drm/drm_debugfs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_debugfs.c	2010-04-13 02:19:00.790633057 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/debugfs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 
 #if defined(CONFIG_DEBUG_FS)
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_dp_i2c_helper.c linux-2.6.34-rc4/drivers/gpu/drm/drm_dp_i2c_helper.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_dp_i2c_helper.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_dp_i2c_helper.c	2010-04-13 02:19:00.790633057 +0000
@@ -23,7 +23,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_drv.c linux-2.6.34-rc4/drivers/gpu/drm/drm_drv.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_drv.c	2010-04-13 02:18:55.674633044 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_drv.c	2010-04-13 02:19:00.790633057 +0000
@@ -47,6 +47,7 @@
  */
 
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_edid.c linux-2.6.34-rc4/drivers/gpu/drm/drm_edid.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_edid.c	2010-04-13 02:18:55.674633044 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_edid.c	2010-04-13 02:19:00.791633047 +0000
@@ -27,6 +27,7 @@
  * DEALINGS IN THE SOFTWARE.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/i2c-algo-bit.h>
 #include "drmP.h"
@@ -84,6 +85,8 @@
 
 	/* Envision Peripherals, Inc. EN-7100e */
 	{ "EPI", 59264, EDID_QUIRK_135_CLOCK_TOO_HIGH },
+	/* Envision EN2028 */
+	{ "EPI", 8232, EDID_QUIRK_PREFER_LARGE_60 },
 
 	/* Funai Electronics PM36B */
 	{ "FCM", 13600, EDID_QUIRK_PREFER_LARGE_75 |
@@ -707,15 +710,6 @@
 	mode->vsync_end = mode->vsync_start + vsync_pulse_width;
 	mode->vtotal = mode->vdisplay + vblank;
 
-	/* perform the basic check for the detailed timing */
-	if (mode->hsync_end > mode->htotal ||
-		mode->vsync_end > mode->vtotal) {
-		drm_mode_destroy(dev, mode);
-		DRM_DEBUG_KMS("Incorrect detailed timing. "
-				"Sync is beyond the blank.\n");
-		return NULL;
-	}
-
 	/* Some EDIDs have bogus h/vtotal values */
 	if (mode->hsync_end > mode->htotal)
 		mode->htotal = mode->hsync_end + 1;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_fb_helper.c linux-2.6.34-rc4/drivers/gpu/drm/drm_fb_helper.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_fb_helper.c	2010-04-13 02:18:55.674633044 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_fb_helper.c	2010-04-13 02:19:00.791633047 +0000
@@ -29,6 +29,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/sysrq.h>
+#include <linux/slab.h>
 #include <linux/fb.h>
 #include "drmP.h"
 #include "drm_crtc.h"
@@ -283,6 +284,8 @@
 	.help_msg = "force-fb(V)",
 	.action_msg = "Restore framebuffer console",
 };
+#else
+static struct sysrq_key_op sysrq_drm_fb_helper_restore_op = { };
 #endif
 
 static void drm_fb_helper_on(struct fb_info *info)
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_fops.c linux-2.6.34-rc4/drivers/gpu/drm/drm_fops.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_fops.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_fops.c	2010-04-13 02:19:00.791633047 +0000
@@ -36,6 +36,7 @@
 
 #include "drmP.h"
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 
 static int drm_open_helper(struct inode *inode, struct file *filp,
@@ -140,14 +141,16 @@
 		spin_unlock(&dev->count_lock);
 	}
 out:
-	mutex_lock(&dev->struct_mutex);
-	if (minor->type == DRM_MINOR_LEGACY) {
-		BUG_ON((dev->dev_mapping != NULL) &&
-			(dev->dev_mapping != inode->i_mapping));
-		if (dev->dev_mapping == NULL)
-			dev->dev_mapping = inode->i_mapping;
+	if (!retcode) {
+		mutex_lock(&dev->struct_mutex);
+		if (minor->type == DRM_MINOR_LEGACY) {
+			if (dev->dev_mapping == NULL)
+				dev->dev_mapping = inode->i_mapping;
+			else if (dev->dev_mapping != inode->i_mapping)
+				retcode = -ENODEV;
+		}
+		mutex_unlock(&dev->struct_mutex);
 	}
-	mutex_unlock(&dev->struct_mutex);
 
 	return retcode;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_hashtab.c linux-2.6.34-rc4/drivers/gpu/drm/drm_hashtab.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_hashtab.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_hashtab.c	2010-04-13 02:19:00.791633047 +0000
@@ -35,6 +35,7 @@
 #include "drmP.h"
 #include "drm_hashtab.h"
 #include <linux/hash.h>
+#include <linux/slab.h>
 
 int drm_ht_create(struct drm_open_hash *ht, unsigned int order)
 {
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_irq.c linux-2.6.34-rc4/drivers/gpu/drm/drm_irq.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_irq.c	2010-04-13 02:19:00.792633103 +0000
@@ -36,6 +36,7 @@
 #include "drmP.h"
 
 #include <linux/interrupt.h>	/* For task queue support */
+#include <linux/slab.h>
 
 #include <linux/vgaarb.h>
 /**
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_pci.c linux-2.6.34-rc4/drivers/gpu/drm/drm_pci.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_pci.c	2010-04-13 02:19:00.792633103 +0000
@@ -37,6 +37,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 #include "drmP.h"
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_proc.c linux-2.6.34-rc4/drivers/gpu/drm/drm_proc.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_proc.c	2010-04-13 02:19:00.792633103 +0000
@@ -38,6 +38,7 @@
  */
 
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 
 /***************************************************
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_scatter.c linux-2.6.34-rc4/drivers/gpu/drm/drm_scatter.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_scatter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_scatter.c	2010-04-13 02:19:00.792633103 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include "drmP.h"
 
 #define DEBUG_SCATTER 0
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_stub.c linux-2.6.34-rc4/drivers/gpu/drm/drm_stub.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_stub.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_stub.c	2010-04-13 02:19:00.792633103 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_sysfs.c linux-2.6.34-rc4/drivers/gpu/drm/drm_sysfs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_sysfs.c	2010-04-13 02:18:55.675572175 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_sysfs.c	2010-04-13 02:19:00.792633103 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/device.h>
 #include <linux/kdev_t.h>
+#include <linux/gfp.h>
 #include <linux/err.h>
 
 #include "drm_sysfs.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/drm_vm.c linux-2.6.34-rc4/drivers/gpu/drm/drm_vm.c
--- linux-2.6.34-rc3/drivers/gpu/drm/drm_vm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/drm_vm.c	2010-04-13 02:19:00.792633103 +0000
@@ -36,6 +36,7 @@
 #include "drmP.h"
 #if defined(__ia64__)
 #include <linux/efi.h>
+#include <linux/slab.h>
 #endif
 
 static void drm_vm_open(struct vm_area_struct *vma);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i810/i810_dma.c linux-2.6.34-rc4/drivers/gpu/drm/i810/i810_dma.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i810/i810_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i810/i810_dma.c	2010-04-13 02:19:00.792633103 +0000
@@ -36,6 +36,7 @@
 #include "i810_drv.h"
 #include <linux/interrupt.h>	/* For task queue support */
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 
 #define I810_BUF_FREE		2
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i830/i830_dma.c linux-2.6.34-rc4/drivers/gpu/drm/i830/i830_dma.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i830/i830_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i830/i830_dma.c	2010-04-13 02:19:00.793633111 +0000
@@ -38,6 +38,7 @@
 #include <linux/interrupt.h>	/* For task queue support */
 #include <linux/pagemap.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #define I830_BUF_FREE		2
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_debugfs.c linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_debugfs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_debugfs.c	2010-04-13 02:18:55.675572175 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_debugfs.c	2010-04-13 02:19:00.793633111 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/seq_file.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "i915_drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_dma.c linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_dma.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_dma.c	2010-04-13 02:18:55.675572175 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_dma.c	2010-04-13 02:19:00.793633111 +0000
@@ -38,6 +38,7 @@
 #include <linux/acpi.h>
 #include <linux/pnp.h>
 #include <linux/vga_switcheroo.h>
+#include <linux/slab.h>
 
 /* Really want an OS-independent resettable timer.  Would like to have
  * this loop run for (eg) 3 sec, but have the timer reset every time
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_gem.c linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_gem.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_gem.c	2010-04-13 02:18:55.677633042 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_gem.c	2010-04-13 02:19:00.795633058 +0000
@@ -31,6 +31,7 @@
 #include "i915_drv.h"
 #include "i915_trace.h"
 #include "intel_drv.h"
+#include <linux/slab.h>
 #include <linux/swap.h>
 #include <linux/pci.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_irq.c linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_irq.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/i915_irq.c	2010-04-13 02:18:55.678633059 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/i915_irq.c	2010-04-13 02:19:00.796633174 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/sysrq.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "i915_drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_crt.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_crt.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_crt.c	2010-04-13 02:18:55.679571820 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_crt.c	2010-04-13 02:19:00.797590442 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "drm_crtc.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_display.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_display.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_display.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_display.c	2010-04-13 02:19:00.798633022 +0000
@@ -28,6 +28,7 @@
 #include <linux/input.h>
 #include <linux/i2c.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "intel_drv.h"
 #include "i915_drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_dp.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_dp.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_dp.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_dp.c	2010-04-13 02:19:00.798633022 +0000
@@ -26,6 +26,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "drm_crtc.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_dvo.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_dvo.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_dvo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_dvo.c	2010-04-13 02:19:00.798633022 +0000
@@ -25,6 +25,7 @@
  *	Eric Anholt <eric@anholt.net>
  */
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "drm_crtc.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_fb.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_fb.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_fb.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_fb.c	2010-04-13 02:19:00.798633022 +0000
@@ -30,7 +30,6 @@
 #include <linux/string.h>
 #include <linux/mm.h>
 #include <linux/tty.h>
-#include <linux/slab.h>
 #include <linux/sysrq.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_hdmi.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_hdmi.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_hdmi.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_hdmi.c	2010-04-13 02:19:00.798633022 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "drmP.h"
 #include "drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_i2c.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_i2c.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_i2c.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_i2c.c	2010-04-13 02:19:00.798633022 +0000
@@ -26,6 +26,7 @@
  *	Eric Anholt <eric@anholt.net>
  */
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/i2c-id.h>
 #include <linux/i2c-algo-bit.h>
 #include "drmP.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_lvds.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_lvds.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_lvds.c	2010-04-13 02:18:55.680570466 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_lvds.c	2010-04-13 02:19:00.799633051 +0000
@@ -30,6 +30,7 @@
 #include <acpi/button.h>
 #include <linux/dmi.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "drm_crtc.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_modes.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_modes.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_modes.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_modes.c	2010-04-13 02:19:00.799633051 +0000
@@ -23,6 +23,7 @@
  * DEALINGS IN THE SOFTWARE.
  */
 
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/fb.h>
 #include "drmP.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_sdvo.c linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_sdvo.c
--- linux-2.6.34-rc3/drivers/gpu/drm/i915/intel_sdvo.c	2010-04-13 02:18:55.681633071 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/i915/intel_sdvo.c	2010-04-13 02:19:00.800570486 +0000
@@ -26,6 +26,7 @@
  *	Eric Anholt <eric@anholt.net>
  */
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "drmP.h"
 #include "drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/Makefile linux-2.6.34-rc4/drivers/gpu/drm/nouveau/Makefile
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/Makefile	2010-04-13 02:18:55.681633071 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/Makefile	2010-04-13 02:19:00.800570486 +0000
@@ -12,7 +12,7 @@
              nouveau_dp.o nouveau_grctx.o \
              nv04_timer.o \
              nv04_mc.o nv40_mc.o nv50_mc.o \
-             nv04_fb.o nv10_fb.o nv40_fb.o \
+             nv04_fb.o nv10_fb.o nv40_fb.o nv50_fb.o \
              nv04_fifo.o nv10_fifo.o nv40_fifo.o nv50_fifo.o \
              nv04_graph.o nv10_graph.o nv20_graph.o \
              nv40_graph.o nv50_graph.o \
@@ -22,7 +22,7 @@
              nv50_cursor.o nv50_display.o nv50_fbcon.o \
              nv04_dac.o nv04_dfp.o nv04_tv.o nv17_tv.o nv17_tv_modes.o \
              nv04_crtc.o nv04_display.o nv04_cursor.o nv04_fbcon.o \
-             nv17_gpio.o
+             nv17_gpio.o nv50_gpio.o
 
 nouveau-$(CONFIG_DRM_NOUVEAU_DEBUG) += nouveau_debugfs.o
 nouveau-$(CONFIG_COMPAT) += nouveau_ioc32.o
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_acpi.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_acpi.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_acpi.c	2010-04-13 02:18:55.681633071 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_acpi.c	2010-04-13 02:19:00.800570486 +0000
@@ -1,5 +1,6 @@
 #include <linux/pci.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_drivers.h>
 #include <acpi/acpi_bus.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bios.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bios.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bios.c	2010-04-13 02:18:55.683633033 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bios.c	2010-04-13 02:19:00.801570254 +0000
@@ -2573,48 +2573,34 @@
 	 * each GPIO according to various values listed in each entry
 	 */
 
-	const uint32_t nv50_gpio_reg[4] = { 0xe104, 0xe108, 0xe280, 0xe284 };
+	struct drm_nouveau_private *dev_priv = bios->dev->dev_private;
 	const uint32_t nv50_gpio_ctl[2] = { 0xe100, 0xe28c };
-	const uint8_t *gpio_table = &bios->data[bios->dcb.gpio_table_ptr];
-	const uint8_t *gpio_entry;
 	int i;
 
-	if (!iexec->execute)
-		return 1;
-
-	if (bios->dcb.version != 0x40) {
-		NV_ERROR(bios->dev, "DCB table not version 4.0\n");
-		return 0;
+	if (dev_priv->card_type != NV_50) {
+		NV_ERROR(bios->dev, "INIT_GPIO on unsupported chipset\n");
+		return -ENODEV;
 	}
 
-	if (!bios->dcb.gpio_table_ptr) {
-		NV_WARN(bios->dev, "Invalid pointer to INIT_8E table\n");
-		return 0;
-	}
+	if (!iexec->execute)
+		return 1;
 
-	gpio_entry = gpio_table + gpio_table[1];
-	for (i = 0; i < gpio_table[2]; i++, gpio_entry += gpio_table[3]) {
-		uint32_t entry = ROM32(gpio_entry[0]), r, s, v;
-		int line = (entry & 0x0000001f);
+	for (i = 0; i < bios->dcb.gpio.entries; i++) {
+		struct dcb_gpio_entry *gpio = &bios->dcb.gpio.entry[i];
+		uint32_t r, s, v;
 
-		BIOSLOG(bios, "0x%04X: Entry: 0x%08X\n", offset, entry);
+		BIOSLOG(bios, "0x%04X: Entry: 0x%08X\n", offset, gpio->entry);
 
-		if ((entry & 0x0000ff00) == 0x0000ff00)
-			continue;
+		nv50_gpio_set(bios->dev, gpio->tag, gpio->state_default);
 
-		r = nv50_gpio_reg[line >> 3];
-		s = (line & 0x07) << 2;
-		v = bios_rd32(bios, r) & ~(0x00000003 << s);
-		if (entry & 0x01000000)
-			v |= (((entry & 0x60000000) >> 29) ^ 2) << s;
-		else
-			v |= (((entry & 0x18000000) >> 27) ^ 2) << s;
-		bios_wr32(bios, r, v);
-
-		r = nv50_gpio_ctl[line >> 4];
-		s = (line & 0x0f);
+		/* The NVIDIA binary driver doesn't appear to actually do
+		 * any of this, my VBIOS does however.
+		 */
+		/* Not a clue, needs de-magicing */
+		r = nv50_gpio_ctl[gpio->line >> 4];
+		s = (gpio->line & 0x0f);
 		v = bios_rd32(bios, r) & ~(0x00010001 << s);
-		switch ((entry & 0x06000000) >> 25) {
+		switch ((gpio->entry & 0x06000000) >> 25) {
 		case 1:
 			v |= (0x00000001 << s);
 			break;
@@ -3198,7 +3184,6 @@
 	struct nvbios *bios = &dev_priv->vbios;
 	unsigned int outputset = (dcbent->or == 4) ? 1 : 0;
 	uint16_t scriptptr = 0, clktable;
-	uint8_t clktableptr = 0;
 
 	/*
 	 * For now we assume version 3.0 table - g80 support will need some
@@ -3217,26 +3202,29 @@
 		scriptptr = ROM16(bios->data[bios->fp.lvdsmanufacturerpointer + 11 + outputset * 2]);
 		break;
 	case LVDS_RESET:
+		clktable = bios->fp.lvdsmanufacturerpointer + 15;
+		if (dcbent->or == 4)
+			clktable += 8;
+
 		if (dcbent->lvdsconf.use_straps_for_mode) {
 			if (bios->fp.dual_link)
-				clktableptr += 2;
-			if (bios->fp.BITbit1)
-				clktableptr++;
+				clktable += 4;
+			if (bios->fp.if_is_24bit)
+				clktable += 2;
 		} else {
 			/* using EDID */
-			uint8_t fallback = bios->data[bios->fp.lvdsmanufacturerpointer + 4];
-			int fallbackcmpval = (dcbent->or == 4) ? 4 : 1;
+			int cmpval_24bit = (dcbent->or == 4) ? 4 : 1;
 
 			if (bios->fp.dual_link) {
-				clktableptr += 2;
-				fallbackcmpval *= 2;
+				clktable += 4;
+				cmpval_24bit <<= 1;
 			}
-			if (fallbackcmpval & fallback)
-				clktableptr++;
+
+			if (bios->fp.strapless_is_24bit & cmpval_24bit)
+				clktable += 2;
 		}
 
-		/* adding outputset * 8 may not be correct */
-		clktable = ROM16(bios->data[bios->fp.lvdsmanufacturerpointer + 15 + clktableptr * 2 + outputset * 8]);
+		clktable = ROM16(bios->data[clktable]);
 		if (!clktable) {
 			NV_ERROR(dev, "Pixel clock comparison table not found\n");
 			return -ENOENT;
@@ -3638,37 +3626,40 @@
 		*if_is_24bit = bios->data[lvdsofs] & 16;
 		break;
 	case 0x30:
-		/*
-		 * My money would be on there being a 24 bit interface bit in
-		 * this table, but I have no example of a laptop bios with a
-		 * 24 bit panel to confirm that. Hence we shout loudly if any
-		 * bit other than bit 0 is set (I've not even seen bit 1)
-		 */
-		if (bios->data[lvdsofs] > 1)
-			NV_ERROR(dev,
-				 "You have a very unusual laptop display; please report it\n");
+	case 0x40:
 		/*
 		 * No sign of the "power off for reset" or "reset for panel
 		 * on" bits, but it's safer to assume we should
 		 */
 		bios->fp.power_off_for_reset = true;
 		bios->fp.reset_after_pclk_change = true;
+
 		/*
 		 * It's ok lvdsofs is wrong for nv4x edid case; dual_link is
-		 * over-written, and BITbit1 isn't used
+		 * over-written, and if_is_24bit isn't used
 		 */
 		bios->fp.dual_link = bios->data[lvdsofs] & 1;
-		bios->fp.BITbit1 = bios->data[lvdsofs] & 2;
-		bios->fp.duallink_transition_clk = ROM16(bios->data[bios->fp.lvdsmanufacturerpointer + 5]) * 10;
-		break;
-	case 0x40:
-		bios->fp.dual_link = bios->data[lvdsofs] & 1;
 		bios->fp.if_is_24bit = bios->data[lvdsofs] & 2;
 		bios->fp.strapless_is_24bit = bios->data[bios->fp.lvdsmanufacturerpointer + 4];
 		bios->fp.duallink_transition_clk = ROM16(bios->data[bios->fp.lvdsmanufacturerpointer + 5]) * 10;
 		break;
 	}
 
+	/* Dell Latitude D620 reports a too-high value for the dual-link
+	 * transition freq, causing us to program the panel incorrectly.
+	 *
+	 * It doesn't appear the VBIOS actually uses its transition freq
+	 * (90000kHz), instead it uses the "Number of LVDS channels" field
+	 * out of the panel ID structure (http://www.spwg.org/).
+	 *
+	 * For the moment, a quirk will do :)
+	 */
+	if ((dev->pdev->device == 0x01d7) &&
+	    (dev->pdev->subsystem_vendor == 0x1028) &&
+	    (dev->pdev->subsystem_device == 0x01c2)) {
+		bios->fp.duallink_transition_clk = 80000;
+	}
+
 	/* set dual_link flag for EDID case */
 	if (pxclk && (chip_version < 0x25 || chip_version > 0x28))
 		bios->fp.dual_link = (pxclk >= bios->fp.duallink_transition_clk);
@@ -5077,25 +5068,25 @@
 	gpio->tag = tag;
 	gpio->line = line;
 	gpio->invert = flags != 4;
+	gpio->entry = ent;
 }
 
 static void
 parse_dcb40_gpio_entry(struct nvbios *bios, uint16_t offset)
 {
+	uint32_t entry = ROM32(bios->data[offset]);
 	struct dcb_gpio_entry *gpio;
-	uint32_t ent = ROM32(bios->data[offset]);
-	uint8_t line = ent & 0x1f,
-		tag = ent >> 8 & 0xff;
 
-	if (tag == 0xff)
+	if ((entry & 0x0000ff00) == 0x0000ff00)
 		return;
 
 	gpio = new_gpio_entry(bios);
-
-	/* Currently unused, we may need more fields parsed at some
-	 * point. */
-	gpio->tag = tag;
-	gpio->line = line;
+	gpio->tag = (entry & 0x0000ff00) >> 8;
+	gpio->line = (entry & 0x0000001f) >> 0;
+	gpio->state_default = (entry & 0x01000000) >> 24;
+	gpio->state[0] = (entry & 0x18000000) >> 27;
+	gpio->state[1] = (entry & 0x60000000) >> 29;
+	gpio->entry = entry;
 }
 
 static void
@@ -5211,6 +5202,21 @@
 }
 
 static void
+apply_dcb_connector_quirks(struct nvbios *bios, int idx)
+{
+	struct dcb_connector_table_entry *cte = &bios->dcb.connector.entry[idx];
+	struct drm_device *dev = bios->dev;
+
+	/* Gigabyte NX85T */
+	if ((dev->pdev->device == 0x0421) &&
+	    (dev->pdev->subsystem_vendor == 0x1458) &&
+	    (dev->pdev->subsystem_device == 0x344c)) {
+		if (cte->type == DCB_CONNECTOR_HDMI_1)
+			cte->type = DCB_CONNECTOR_DVI_I;
+	}
+}
+
+static void
 parse_dcb_connector_table(struct nvbios *bios)
 {
 	struct drm_device *dev = bios->dev;
@@ -5238,13 +5244,14 @@
 	entry = conntab + conntab[1];
 	cte = &ct->entry[0];
 	for (i = 0; i < conntab[2]; i++, entry += conntab[3], cte++) {
+		cte->index = i;
 		if (conntab[3] == 2)
 			cte->entry = ROM16(entry[0]);
 		else
 			cte->entry = ROM32(entry[0]);
 
 		cte->type  = (cte->entry & 0x000000ff) >> 0;
-		cte->index = (cte->entry & 0x00000f00) >> 8;
+		cte->index2 = (cte->entry & 0x00000f00) >> 8;
 		switch (cte->entry & 0x00033000) {
 		case 0x00001000:
 			cte->gpio_tag = 0x07;
@@ -5266,6 +5273,8 @@
 		if (cte->type == 0xff)
 			continue;
 
+		apply_dcb_connector_quirks(bios, i);
+
 		NV_INFO(dev, "  %d: 0x%08x: type 0x%02x idx %d tag 0x%02x\n",
 			i, cte->entry, cte->type, cte->index, cte->gpio_tag);
 
@@ -5287,10 +5296,16 @@
 			break;
 		default:
 			cte->type = divine_connector_type(bios, cte->index);
-			NV_WARN(dev, "unknown type, using 0x%02x", cte->type);
+			NV_WARN(dev, "unknown type, using 0x%02x\n", cte->type);
 			break;
 		}
 
+		if (nouveau_override_conntype) {
+			int type = divine_connector_type(bios, cte->index);
+			if (type != cte->type)
+				NV_WARN(dev, " -> type 0x%02x\n", cte->type);
+		}
+
 	}
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bios.h linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bios.h
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bios.h	2010-04-13 02:18:55.683633033 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bios.h	2010-04-13 02:19:00.801570254 +0000
@@ -49,6 +49,9 @@
 	enum dcb_gpio_tag tag;
 	int line;
 	bool invert;
+	uint32_t entry;
+	uint8_t state_default;
+	uint8_t state[2];
 };
 
 struct dcb_gpio_table {
@@ -72,9 +75,10 @@
 };
 
 struct dcb_connector_table_entry {
+	uint8_t index;
 	uint32_t entry;
 	enum dcb_connector_type type;
-	uint8_t index;
+	uint8_t index2;
 	uint8_t gpio_tag;
 };
 
@@ -266,7 +270,6 @@
 		bool reset_after_pclk_change;
 		bool dual_link;
 		bool link_c_increment;
-		bool BITbit1;
 		bool if_is_24bit;
 		int duallink_transition_clk;
 		uint8_t strapless_is_24bit;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bo.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bo.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_bo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_bo.c	2010-04-13 02:19:00.802633066 +0000
@@ -34,6 +34,7 @@
 #include "nouveau_dma.h"
 
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 static void
 nouveau_bo_del_ttm(struct ttm_buffer_object *bo)
@@ -71,7 +72,7 @@
 	 * many small buffers.
 	 */
 	if (dev_priv->card_type == NV_50) {
-		uint32_t block_size = nouveau_mem_fb_amount(dev) >> 15;
+		uint32_t block_size = dev_priv->vram_size >> 15;
 		int i;
 
 		switch (tile_flags) {
@@ -153,7 +154,7 @@
 
 	nvbo->placement.fpfn = 0;
 	nvbo->placement.lpfn = mappable ? dev_priv->fb_mappable_pages : 0;
-	nouveau_bo_placement_set(nvbo, flags);
+	nouveau_bo_placement_set(nvbo, flags, 0);
 
 	nvbo->channel = chan;
 	ret = ttm_bo_init(&dev_priv->ttm.bdev, &nvbo->bo, size,
@@ -172,26 +173,33 @@
 	return 0;
 }
 
-void
-nouveau_bo_placement_set(struct nouveau_bo *nvbo, uint32_t memtype)
+static void
+set_placement_list(uint32_t *pl, unsigned *n, uint32_t type, uint32_t flags)
 {
-	int n = 0;
+	*n = 0;
 
-	if (memtype & TTM_PL_FLAG_VRAM)
-		nvbo->placements[n++] = TTM_PL_FLAG_VRAM | TTM_PL_MASK_CACHING;
-	if (memtype & TTM_PL_FLAG_TT)
-		nvbo->placements[n++] = TTM_PL_FLAG_TT | TTM_PL_MASK_CACHING;
-	if (memtype & TTM_PL_FLAG_SYSTEM)
-		nvbo->placements[n++] = TTM_PL_FLAG_SYSTEM | TTM_PL_MASK_CACHING;
-	nvbo->placement.placement = nvbo->placements;
-	nvbo->placement.busy_placement = nvbo->placements;
-	nvbo->placement.num_placement = n;
-	nvbo->placement.num_busy_placement = n;
-
-	if (nvbo->pin_refcnt) {
-		while (n--)
-			nvbo->placements[n] |= TTM_PL_FLAG_NO_EVICT;
-	}
+	if (type & TTM_PL_FLAG_VRAM)
+		pl[(*n)++] = TTM_PL_FLAG_VRAM | flags;
+	if (type & TTM_PL_FLAG_TT)
+		pl[(*n)++] = TTM_PL_FLAG_TT | flags;
+	if (type & TTM_PL_FLAG_SYSTEM)
+		pl[(*n)++] = TTM_PL_FLAG_SYSTEM | flags;
+}
+
+void
+nouveau_bo_placement_set(struct nouveau_bo *nvbo, uint32_t type, uint32_t busy)
+{
+	struct ttm_placement *pl = &nvbo->placement;
+	uint32_t flags = TTM_PL_MASK_CACHING |
+		(nvbo->pin_refcnt ? TTM_PL_FLAG_NO_EVICT : 0);
+
+	pl->placement = nvbo->placements;
+	set_placement_list(nvbo->placements, &pl->num_placement,
+			   type, flags);
+
+	pl->busy_placement = nvbo->busy_placements;
+	set_placement_list(nvbo->busy_placements, &pl->num_busy_placement,
+			   type | busy, flags);
 }
 
 int
@@ -199,7 +207,7 @@
 {
 	struct drm_nouveau_private *dev_priv = nouveau_bdev(nvbo->bo.bdev);
 	struct ttm_buffer_object *bo = &nvbo->bo;
-	int ret, i;
+	int ret;
 
 	if (nvbo->pin_refcnt && !(memtype & (1 << bo->mem.mem_type))) {
 		NV_ERROR(nouveau_bdev(bo->bdev)->dev,
@@ -215,9 +223,7 @@
 	if (ret)
 		goto out;
 
-	nouveau_bo_placement_set(nvbo, memtype);
-	for (i = 0; i < nvbo->placement.num_placement; i++)
-		nvbo->placements[i] |= TTM_PL_FLAG_NO_EVICT;
+	nouveau_bo_placement_set(nvbo, memtype, 0);
 
 	ret = ttm_bo_validate(bo, &nvbo->placement, false, false);
 	if (ret == 0) {
@@ -244,7 +250,7 @@
 {
 	struct drm_nouveau_private *dev_priv = nouveau_bdev(nvbo->bo.bdev);
 	struct ttm_buffer_object *bo = &nvbo->bo;
-	int ret, i;
+	int ret;
 
 	if (--nvbo->pin_refcnt)
 		return 0;
@@ -253,8 +259,7 @@
 	if (ret)
 		return ret;
 
-	for (i = 0; i < nvbo->placement.num_placement; i++)
-		nvbo->placements[i] &= ~TTM_PL_FLAG_NO_EVICT;
+	nouveau_bo_placement_set(nvbo, bo->mem.placement, 0);
 
 	ret = ttm_bo_validate(bo, &nvbo->placement, false, false);
 	if (ret == 0) {
@@ -395,8 +400,8 @@
 		man->io_addr = NULL;
 		man->io_offset = drm_get_resource_start(dev, 1);
 		man->io_size = drm_get_resource_len(dev, 1);
-		if (man->io_size > nouveau_mem_fb_amount(dev))
-			man->io_size = nouveau_mem_fb_amount(dev);
+		if (man->io_size > dev_priv->vram_size)
+			man->io_size = dev_priv->vram_size;
 
 		man->gpu_offset = dev_priv->vm_vram_base;
 		break;
@@ -439,11 +444,11 @@
 
 	switch (bo->mem.mem_type) {
 	case TTM_PL_VRAM:
-		nouveau_bo_placement_set(nvbo, TTM_PL_FLAG_TT |
+		nouveau_bo_placement_set(nvbo, TTM_PL_FLAG_TT,
 					 TTM_PL_FLAG_SYSTEM);
 		break;
 	default:
-		nouveau_bo_placement_set(nvbo, TTM_PL_FLAG_SYSTEM);
+		nouveau_bo_placement_set(nvbo, TTM_PL_FLAG_SYSTEM, 0);
 		break;
 	}
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_channel.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_channel.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_channel.c	2010-04-13 02:18:55.683633033 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_channel.c	2010-04-13 02:19:00.802633066 +0000
@@ -142,7 +142,6 @@
 					   GFP_KERNEL);
 	if (!dev_priv->fifos[channel])
 		return -ENOMEM;
-	dev_priv->fifo_alloc_count++;
 	chan = dev_priv->fifos[channel];
 	INIT_LIST_HEAD(&chan->nvsw.vbl_wait);
 	INIT_LIST_HEAD(&chan->fence.pending);
@@ -321,7 +320,6 @@
 		iounmap(chan->user);
 
 	dev_priv->fifos[chan->id] = NULL;
-	dev_priv->fifo_alloc_count--;
 	kfree(chan);
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_connector.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_connector.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_connector.c	2010-04-13 02:18:55.684633020 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_connector.c	2010-04-13 02:19:00.802633066 +0000
@@ -302,7 +302,7 @@
 
 detect_analog:
 	nv_encoder = find_encoder_by_type(connector, OUTPUT_ANALOG);
-	if (!nv_encoder)
+	if (!nv_encoder && !nouveau_tv_disable)
 		nv_encoder = find_encoder_by_type(connector, OUTPUT_TV);
 	if (nv_encoder) {
 		struct drm_encoder *encoder = to_drm_encoder(nv_encoder);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_debugfs.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_debugfs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_debugfs.c	2010-04-13 02:18:55.684633020 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_debugfs.c	2010-04-13 02:19:00.803633074 +0000
@@ -137,10 +137,9 @@
 {
 	struct drm_info_node *node = (struct drm_info_node *) m->private;
 	struct drm_minor *minor = node->minor;
-	struct drm_device *dev = minor->dev;
+	struct drm_nouveau_private *dev_priv = minor->dev->dev_private;
 
-	seq_printf(m, "VRAM total: %dKiB\n",
-		   (int)(nouveau_mem_fb_amount(dev) >> 10));
+	seq_printf(m, "VRAM total: %dKiB\n", (int)(dev_priv->vram_size >> 10));
 	return 0;
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_dma.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_dma.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_dma.c	2010-04-13 02:18:55.684633020 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_dma.c	2010-04-13 02:19:00.803633074 +0000
@@ -190,6 +190,11 @@
 	nouveau_bo_wr32(pb, ip++, upper_32_bits(offset) | length << 8);
 
 	chan->dma.ib_put = (chan->dma.ib_put + 1) & chan->dma.ib_max;
+
+	DRM_MEMORYBARRIER();
+	/* Flush writes. */
+	nouveau_bo_rd32(pb, 0);
+
 	nvchan_wr32(chan, 0x8c, chan->dma.ib_put);
 	chan->dma.ib_free--;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_dp.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_dp.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_dp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_dp.c	2010-04-13 02:19:00.803633074 +0000
@@ -483,7 +483,7 @@
 	ctrl |= (cmd << NV50_AUXCH_CTRL_CMD_SHIFT);
 	ctrl |= ((data_nr - 1) << NV50_AUXCH_CTRL_LEN_SHIFT);
 
-	for (;;) {
+	for (i = 0; i < 16; i++) {
 		nv_wr32(dev, NV50_AUXCH_CTRL(index), ctrl | 0x80000000);
 		nv_wr32(dev, NV50_AUXCH_CTRL(index), ctrl);
 		nv_wr32(dev, NV50_AUXCH_CTRL(index), ctrl | 0x00010000);
@@ -502,6 +502,12 @@
 			break;
 	}
 
+	if (i == 16) {
+		NV_ERROR(dev, "auxch DEFER too many times, bailing\n");
+		ret = -EREMOTEIO;
+		goto out;
+	}
+
 	if (cmd & 1) {
 		if ((stat & NV50_AUXCH_STAT_COUNT) != data_nr) {
 			ret = -EREMOTEIO;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_drv.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_drv.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_drv.c	2010-04-13 02:18:55.684633020 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_drv.c	2010-04-13 02:19:00.803633074 +0000
@@ -83,6 +83,14 @@
 int nouveau_nofbaccel = 0;
 module_param_named(nofbaccel, nouveau_nofbaccel, int, 0400);
 
+MODULE_PARM_DESC(override_conntype, "Ignore DCB connector type");
+int nouveau_override_conntype = 0;
+module_param_named(override_conntype, nouveau_override_conntype, int, 0400);
+
+MODULE_PARM_DESC(tv_disable, "Disable TV-out detection\n");
+int nouveau_tv_disable = 0;
+module_param_named(tv_disable, nouveau_tv_disable, int, 0400);
+
 MODULE_PARM_DESC(tv_norm, "Default TV norm.\n"
 		 "\t\tSupported: PAL, PAL-M, PAL-N, PAL-Nc, NTSC-M, NTSC-J,\n"
 		 "\t\t\thd480i, hd480p, hd576i, hd576p, hd720p, hd1080i.\n"
@@ -154,9 +162,11 @@
 	if (pm_state.event == PM_EVENT_PRETHAW)
 		return 0;
 
+	NV_INFO(dev, "Disabling fbcon acceleration...\n");
 	fbdev_flags = dev_priv->fbdev_info->flags;
 	dev_priv->fbdev_info->flags |= FBINFO_HWACCEL_DISABLED;
 
+	NV_INFO(dev, "Unpinning framebuffer(s)...\n");
 	list_for_each_entry(crtc, &dev->mode_config.crtc_list, head) {
 		struct nouveau_framebuffer *nouveau_fb;
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_drv.h linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_drv.h
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_drv.h	2010-04-13 02:18:55.685633058 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_drv.h	2010-04-13 02:19:00.804633055 +0000
@@ -76,6 +76,7 @@
 	struct ttm_buffer_object bo;
 	struct ttm_placement placement;
 	u32 placements[3];
+	u32 busy_placements[3];
 	struct ttm_bo_kmap_obj kmap;
 	struct list_head head;
 
@@ -519,6 +520,7 @@
 
 	struct workqueue_struct *wq;
 	struct work_struct irq_work;
+	struct work_struct hpd_work;
 
 	struct list_head vbl_waiting;
 
@@ -533,7 +535,6 @@
 
 	struct fb_info *fbdev_info;
 
-	int fifo_alloc_count;
 	struct nouveau_channel *fifos[NOUVEAU_MAX_CHANNEL_NR];
 
 	struct nouveau_engine engine;
@@ -553,12 +554,6 @@
 	uint32_t ramro_offset;
 	uint32_t ramro_size;
 
-	/* base physical addresses */
-	uint64_t fb_phys;
-	uint64_t fb_available_size;
-	uint64_t fb_mappable_pages;
-	uint64_t fb_aper_free;
-
 	struct {
 		enum {
 			NOUVEAU_GART_NONE = 0,
@@ -572,10 +567,6 @@
 		struct nouveau_gpuobj *sg_ctxdma;
 		struct page *sg_dummy_page;
 		dma_addr_t sg_dummy_bus;
-
-		/* nottm hack */
-		struct drm_ttm_backend *sg_be;
-		unsigned long sg_handle;
 	} gart_info;
 
 	/* nv10-nv40 tiling regions */
@@ -584,6 +575,16 @@
 		spinlock_t lock;
 	} tile;
 
+	/* VRAM/fb configuration */
+	uint64_t vram_size;
+	uint64_t vram_sys_base;
+
+	uint64_t fb_phys;
+	uint64_t fb_available_size;
+	uint64_t fb_mappable_pages;
+	uint64_t fb_aper_free;
+	int fb_mtrr;
+
 	/* G8x/G9x virtual address space */
 	uint64_t vm_gart_base;
 	uint64_t vm_gart_size;
@@ -592,10 +593,6 @@
 	uint64_t vm_end;
 	struct nouveau_gpuobj *vm_vram_pt[NV50_VM_VRAM_NR];
 	int vm_vram_pt_nr;
-	uint64_t vram_sys_base;
-
-	/* the mtrr covering the FB */
-	int fb_mtrr;
 
 	struct mem_block *ramin_heap;
 
@@ -614,11 +611,7 @@
 	uint32_t dac_users[4];
 
 	struct nouveau_suspend_resume {
-		uint32_t fifo_mode;
-		uint32_t graph_ctx_control;
-		uint32_t graph_state;
 		uint32_t *ramin_copy;
-		uint64_t ramin_size;
 	} susres;
 
 	struct backlight_device *backlight;
@@ -681,6 +674,7 @@
 extern int nouveau_vram_pushbuf;
 extern int nouveau_vram_notify;
 extern int nouveau_fbpercrtc;
+extern int nouveau_tv_disable;
 extern char *nouveau_tv_norm;
 extern int nouveau_reg_debug;
 extern char *nouveau_vbios;
@@ -688,6 +682,7 @@
 extern int nouveau_ignorelid;
 extern int nouveau_nofbaccel;
 extern int nouveau_noaccel;
+extern int nouveau_override_conntype;
 
 extern int nouveau_pci_suspend(struct pci_dev *pdev, pm_message_t pm_state);
 extern int nouveau_pci_resume(struct pci_dev *pdev);
@@ -715,7 +710,7 @@
 						 struct drm_file *, int tail);
 extern void nouveau_mem_takedown(struct mem_block **heap);
 extern void nouveau_mem_free_block(struct mem_block *);
-extern uint64_t nouveau_mem_fb_amount(struct drm_device *);
+extern int  nouveau_mem_detect(struct drm_device *dev);
 extern void nouveau_mem_release(struct drm_file *, struct mem_block *heap);
 extern int  nouveau_mem_init(struct drm_device *);
 extern int  nouveau_mem_init_agp(struct drm_device *);
@@ -926,6 +921,10 @@
 extern void nv40_fb_set_region_tiling(struct drm_device *, int, uint32_t,
 				      uint32_t, uint32_t);
 
+/* nv50_fb.c */
+extern int  nv50_fb_init(struct drm_device *);
+extern void nv50_fb_takedown(struct drm_device *);
+
 /* nv04_fifo.c */
 extern int  nv04_fifo_init(struct drm_device *);
 extern void nv04_fifo_disable(struct drm_device *);
@@ -1118,7 +1117,8 @@
 extern int nouveau_bo_unpin(struct nouveau_bo *);
 extern int nouveau_bo_map(struct nouveau_bo *);
 extern void nouveau_bo_unmap(struct nouveau_bo *);
-extern void nouveau_bo_placement_set(struct nouveau_bo *, uint32_t memtype);
+extern void nouveau_bo_placement_set(struct nouveau_bo *, uint32_t type,
+				     uint32_t busy);
 extern u16 nouveau_bo_rd16(struct nouveau_bo *nvbo, unsigned index);
 extern void nouveau_bo_wr16(struct nouveau_bo *nvbo, unsigned index, u16 val);
 extern u32 nouveau_bo_rd32(struct nouveau_bo *nvbo, unsigned index);
@@ -1162,6 +1162,10 @@
 int nv17_gpio_get(struct drm_device *dev, enum dcb_gpio_tag tag);
 int nv17_gpio_set(struct drm_device *dev, enum dcb_gpio_tag tag, int state);
 
+/* nv50_gpio.c */
+int nv50_gpio_get(struct drm_device *dev, enum dcb_gpio_tag tag);
+int nv50_gpio_set(struct drm_device *dev, enum dcb_gpio_tag tag, int state);
+
 #ifndef ioread32_native
 #ifdef __BIG_ENDIAN
 #define ioread16_native ioread16be
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_encoder.h linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_encoder.h
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_encoder.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_encoder.h	2010-04-13 02:19:00.804633055 +0000
@@ -47,6 +47,7 @@
 
 	union {
 		struct {
+			int mc_unknown;
 			int dpcd_version;
 			int link_nr;
 			int link_bw;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_fbcon.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_fbcon.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_fbcon.c	2010-04-13 02:18:55.685633058 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_fbcon.c	2010-04-13 02:19:00.804633055 +0000
@@ -30,7 +30,6 @@
 #include <linux/string.h>
 #include <linux/mm.h>
 #include <linux/tty.h>
-#include <linux/slab.h>
 #include <linux/sysrq.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_gem.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_gem.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_gem.c	2010-04-13 02:18:55.685633058 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_gem.c	2010-04-13 02:19:00.804633055 +0000
@@ -180,40 +180,35 @@
 {
 	struct nouveau_bo *nvbo = gem->driver_private;
 	struct ttm_buffer_object *bo = &nvbo->bo;
-	uint64_t flags;
+	uint32_t domains = valid_domains &
+		(write_domains ? write_domains : read_domains);
+	uint32_t pref_flags = 0, valid_flags = 0;
 
-	if (!valid_domains || (!read_domains && !write_domains))
+	if (!domains)
 		return -EINVAL;
 
-	if (write_domains) {
-		if ((valid_domains & NOUVEAU_GEM_DOMAIN_VRAM) &&
-		    (write_domains & NOUVEAU_GEM_DOMAIN_VRAM))
-			flags = TTM_PL_FLAG_VRAM;
-		else
-		if ((valid_domains & NOUVEAU_GEM_DOMAIN_GART) &&
-		    (write_domains & NOUVEAU_GEM_DOMAIN_GART))
-			flags = TTM_PL_FLAG_TT;
-		else
-			return -EINVAL;
-	} else {
-		if ((valid_domains & NOUVEAU_GEM_DOMAIN_VRAM) &&
-		    (read_domains & NOUVEAU_GEM_DOMAIN_VRAM) &&
-		    bo->mem.mem_type == TTM_PL_VRAM)
-			flags = TTM_PL_FLAG_VRAM;
-		else
-		if ((valid_domains & NOUVEAU_GEM_DOMAIN_GART) &&
-		    (read_domains & NOUVEAU_GEM_DOMAIN_GART) &&
-		    bo->mem.mem_type == TTM_PL_TT)
-			flags = TTM_PL_FLAG_TT;
-		else
-		if ((valid_domains & NOUVEAU_GEM_DOMAIN_VRAM) &&
-		    (read_domains & NOUVEAU_GEM_DOMAIN_VRAM))
-			flags = TTM_PL_FLAG_VRAM;
-		else
-			flags = TTM_PL_FLAG_TT;
-	}
+	if (valid_domains & NOUVEAU_GEM_DOMAIN_VRAM)
+		valid_flags |= TTM_PL_FLAG_VRAM;
+
+	if (valid_domains & NOUVEAU_GEM_DOMAIN_GART)
+		valid_flags |= TTM_PL_FLAG_TT;
+
+	if ((domains & NOUVEAU_GEM_DOMAIN_VRAM) &&
+	    bo->mem.mem_type == TTM_PL_VRAM)
+		pref_flags |= TTM_PL_FLAG_VRAM;
+
+	else if ((domains & NOUVEAU_GEM_DOMAIN_GART) &&
+		 bo->mem.mem_type == TTM_PL_TT)
+		pref_flags |= TTM_PL_FLAG_TT;
+
+	else if (domains & NOUVEAU_GEM_DOMAIN_VRAM)
+		pref_flags |= TTM_PL_FLAG_VRAM;
+
+	else
+		pref_flags |= TTM_PL_FLAG_TT;
+
+	nouveau_bo_placement_set(nvbo, pref_flags, valid_flags);
 
-	nouveau_bo_placement_set(nvbo, flags);
 	return 0;
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_grctx.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_grctx.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_grctx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_grctx.c	2010-04-13 02:19:00.804633055 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include "drmP.h"
 #include "nouveau_drv.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_irq.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_irq.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_irq.c	2010-04-13 02:18:55.686633162 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_irq.c	2010-04-13 02:19:00.805633102 +0000
@@ -51,6 +51,7 @@
 
 	if (dev_priv->card_type == NV_50) {
 		INIT_WORK(&dev_priv->irq_work, nv50_display_irq_handler_bh);
+		INIT_WORK(&dev_priv->hpd_work, nv50_display_irq_hotplug_bh);
 		INIT_LIST_HEAD(&dev_priv->vbl_waiting);
 	}
 }
@@ -311,6 +312,31 @@
 #define nouveau_print_bitfield_names(val, namelist) \
 	nouveau_print_bitfield_names_((val), (namelist), ARRAY_SIZE(namelist))
 
+struct nouveau_enum_names {
+	uint32_t value;
+	const char *name;
+};
+
+static void
+nouveau_print_enum_names_(uint32_t value,
+				const struct nouveau_enum_names *namelist,
+				const int namelist_len)
+{
+	/*
+	 * Caller must have already printed the KERN_* log level for us.
+	 * Also the caller is responsible for adding the newline.
+	 */
+	int i;
+	for (i = 0; i < namelist_len; ++i) {
+		if (value == namelist[i].value) {
+			printk("%s", namelist[i].name);
+			return;
+		}
+	}
+	printk("unknown value 0x%08x", value);
+}
+#define nouveau_print_enum_names(val, namelist) \
+	nouveau_print_enum_names_((val), (namelist), ARRAY_SIZE(namelist))
 
 static int
 nouveau_graph_chid_from_grctx(struct drm_device *dev)
@@ -427,14 +453,16 @@
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	uint32_t nsource = trap->nsource, nstatus = trap->nstatus;
 
-	NV_INFO(dev, "%s - nSource:", id);
-	nouveau_print_bitfield_names(nsource, nsource_names);
-	printk(", nStatus:");
-	if (dev_priv->card_type < NV_10)
-		nouveau_print_bitfield_names(nstatus, nstatus_names);
-	else
-		nouveau_print_bitfield_names(nstatus, nstatus_names_nv10);
-	printk("\n");
+	if (dev_priv->card_type < NV_50) {
+		NV_INFO(dev, "%s - nSource:", id);
+		nouveau_print_bitfield_names(nsource, nsource_names);
+		printk(", nStatus:");
+		if (dev_priv->card_type < NV_10)
+			nouveau_print_bitfield_names(nstatus, nstatus_names);
+		else
+			nouveau_print_bitfield_names(nstatus, nstatus_names_nv10);
+		printk("\n");
+	}
 
 	NV_INFO(dev, "%s - Ch %d/%d Class 0x%04x Mthd 0x%04x "
 					"Data 0x%08x:0x%08x\n",
@@ -578,27 +606,502 @@
 }
 
 static void
+nv50_pfb_vm_trap(struct drm_device *dev, int display, const char *name)
+{
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
+	uint32_t trap[6];
+	int i, ch;
+	uint32_t idx = nv_rd32(dev, 0x100c90);
+	if (idx & 0x80000000) {
+		idx &= 0xffffff;
+		if (display) {
+			for (i = 0; i < 6; i++) {
+				nv_wr32(dev, 0x100c90, idx | i << 24);
+				trap[i] = nv_rd32(dev, 0x100c94);
+			}
+			for (ch = 0; ch < dev_priv->engine.fifo.channels; ch++) {
+				struct nouveau_channel *chan = dev_priv->fifos[ch];
+
+				if (!chan || !chan->ramin)
+					continue;
+
+				if (trap[1] == chan->ramin->instance >> 12)
+					break;
+			}
+			NV_INFO(dev, "%s - VM: Trapped %s at %02x%04x%04x status %08x %08x channel %d\n",
+					name, (trap[5]&0x100?"read":"write"),
+					trap[5]&0xff, trap[4]&0xffff,
+					trap[3]&0xffff, trap[0], trap[2], ch);
+		}
+		nv_wr32(dev, 0x100c90, idx | 0x80000000);
+	} else if (display) {
+		NV_INFO(dev, "%s - no VM fault?\n", name);
+	}
+}
+
+static struct nouveau_enum_names nv50_mp_exec_error_names[] =
+{
+	{ 3, "STACK_UNDERFLOW" },
+	{ 4, "QUADON_ACTIVE" },
+	{ 8, "TIMEOUT" },
+	{ 0x10, "INVALID_OPCODE" },
+	{ 0x40, "BREAKPOINT" },
+};
+
+static void
+nv50_pgraph_mp_trap(struct drm_device *dev, int tpid, int display)
+{
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
+	uint32_t units = nv_rd32(dev, 0x1540);
+	uint32_t addr, mp10, status, pc, oplow, ophigh;
+	int i;
+	int mps = 0;
+	for (i = 0; i < 4; i++) {
+		if (!(units & 1 << (i+24)))
+			continue;
+		if (dev_priv->chipset < 0xa0)
+			addr = 0x408200 + (tpid << 12) + (i << 7);
+		else
+			addr = 0x408100 + (tpid << 11) + (i << 7);
+		mp10 = nv_rd32(dev, addr + 0x10);
+		status = nv_rd32(dev, addr + 0x14);
+		if (!status)
+			continue;
+		if (display) {
+			nv_rd32(dev, addr + 0x20);
+			pc = nv_rd32(dev, addr + 0x24);
+			oplow = nv_rd32(dev, addr + 0x70);
+			ophigh= nv_rd32(dev, addr + 0x74);
+			NV_INFO(dev, "PGRAPH_TRAP_MP_EXEC - "
+					"TP %d MP %d: ", tpid, i);
+			nouveau_print_enum_names(status,
+					nv50_mp_exec_error_names);
+			printk(" at %06x warp %d, opcode %08x %08x\n",
+					pc&0xffffff, pc >> 24,
+					oplow, ophigh);
+		}
+		nv_wr32(dev, addr + 0x10, mp10);
+		nv_wr32(dev, addr + 0x14, 0);
+		mps++;
+	}
+	if (!mps && display)
+		NV_INFO(dev, "PGRAPH_TRAP_MP_EXEC - TP %d: "
+				"No MPs claiming errors?\n", tpid);
+}
+
+static void
+nv50_pgraph_tp_trap(struct drm_device *dev, int type, uint32_t ustatus_old,
+		uint32_t ustatus_new, int display, const char *name)
+{
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
+	int tps = 0;
+	uint32_t units = nv_rd32(dev, 0x1540);
+	int i, r;
+	uint32_t ustatus_addr, ustatus;
+	for (i = 0; i < 16; i++) {
+		if (!(units & (1 << i)))
+			continue;
+		if (dev_priv->chipset < 0xa0)
+			ustatus_addr = ustatus_old + (i << 12);
+		else
+			ustatus_addr = ustatus_new + (i << 11);
+		ustatus = nv_rd32(dev, ustatus_addr) & 0x7fffffff;
+		if (!ustatus)
+			continue;
+		tps++;
+		switch (type) {
+		case 6: /* texture error... unknown for now */
+			nv50_pfb_vm_trap(dev, display, name);
+			if (display) {
+				NV_ERROR(dev, "magic set %d:\n", i);
+				for (r = ustatus_addr + 4; r <= ustatus_addr + 0x10; r += 4)
+					NV_ERROR(dev, "\t0x%08x: 0x%08x\n", r,
+						nv_rd32(dev, r));
+			}
+			break;
+		case 7: /* MP error */
+			if (ustatus & 0x00010000) {
+				nv50_pgraph_mp_trap(dev, i, display);
+				ustatus &= ~0x00010000;
+			}
+			break;
+		case 8: /* TPDMA error */
+			{
+			uint32_t e0c = nv_rd32(dev, ustatus_addr + 4);
+			uint32_t e10 = nv_rd32(dev, ustatus_addr + 8);
+			uint32_t e14 = nv_rd32(dev, ustatus_addr + 0xc);
+			uint32_t e18 = nv_rd32(dev, ustatus_addr + 0x10);
+			uint32_t e1c = nv_rd32(dev, ustatus_addr + 0x14);
+			uint32_t e20 = nv_rd32(dev, ustatus_addr + 0x18);
+			uint32_t e24 = nv_rd32(dev, ustatus_addr + 0x1c);
+			nv50_pfb_vm_trap(dev, display, name);
+			/* 2d engine destination */
+			if (ustatus & 0x00000010) {
+				if (display) {
+					NV_INFO(dev, "PGRAPH_TRAP_TPDMA_2D - TP %d - Unknown fault at address %02x%08x\n",
+							i, e14, e10);
+					NV_INFO(dev, "PGRAPH_TRAP_TPDMA_2D - TP %d - e0c: %08x, e18: %08x, e1c: %08x, e20: %08x, e24: %08x\n",
+							i, e0c, e18, e1c, e20, e24);
+				}
+				ustatus &= ~0x00000010;
+			}
+			/* Render target */
+			if (ustatus & 0x00000040) {
+				if (display) {
+					NV_INFO(dev, "PGRAPH_TRAP_TPDMA_RT - TP %d - Unknown fault at address %02x%08x\n",
+							i, e14, e10);
+					NV_INFO(dev, "PGRAPH_TRAP_TPDMA_RT - TP %d - e0c: %08x, e18: %08x, e1c: %08x, e20: %08x, e24: %08x\n",
+							i, e0c, e18, e1c, e20, e24);
+				}
+				ustatus &= ~0x00000040;
+			}
+			/* CUDA memory: l[], g[] or stack. */
+			if (ustatus & 0x00000080) {
+				if (display) {
+					if (e18 & 0x80000000) {
+						/* g[] read fault? */
+						NV_INFO(dev, "PGRAPH_TRAP_TPDMA - TP %d - Global read fault at address %02x%08x\n",
+								i, e14, e10 | ((e18 >> 24) & 0x1f));
+						e18 &= ~0x1f000000;
+					} else if (e18 & 0xc) {
+						/* g[] write fault? */
+						NV_INFO(dev, "PGRAPH_TRAP_TPDMA - TP %d - Global write fault at address %02x%08x\n",
+								i, e14, e10 | ((e18 >> 7) & 0x1f));
+						e18 &= ~0x00000f80;
+					} else {
+						NV_INFO(dev, "PGRAPH_TRAP_TPDMA - TP %d - Unknown CUDA fault at address %02x%08x\n",
+								i, e14, e10);
+					}
+					NV_INFO(dev, "PGRAPH_TRAP_TPDMA - TP %d - e0c: %08x, e18: %08x, e1c: %08x, e20: %08x, e24: %08x\n",
+							i, e0c, e18, e1c, e20, e24);
+				}
+				ustatus &= ~0x00000080;
+			}
+			}
+			break;
+		}
+		if (ustatus) {
+			if (display)
+				NV_INFO(dev, "%s - TP%d: Unhandled ustatus 0x%08x\n", name, i, ustatus);
+		}
+		nv_wr32(dev, ustatus_addr, 0xc0000000);
+	}
+
+	if (!tps && display)
+		NV_INFO(dev, "%s - No TPs claiming errors?\n", name);
+}
+
+static void
+nv50_pgraph_trap_handler(struct drm_device *dev)
+{
+	struct nouveau_pgraph_trap trap;
+	uint32_t status = nv_rd32(dev, 0x400108);
+	uint32_t ustatus;
+	int display = nouveau_ratelimit();
+
+
+	if (!status && display) {
+		nouveau_graph_trap_info(dev, &trap);
+		nouveau_graph_dump_trap_info(dev, "PGRAPH_TRAP", &trap);
+		NV_INFO(dev, "PGRAPH_TRAP - no units reporting traps?\n");
+	}
+
+	/* DISPATCH: Relays commands to other units and handles NOTIFY,
+	 * COND, QUERY. If you get a trap from it, the command is still stuck
+	 * in DISPATCH and you need to do something about it. */
+	if (status & 0x001) {
+		ustatus = nv_rd32(dev, 0x400804) & 0x7fffffff;
+		if (!ustatus && display) {
+			NV_INFO(dev, "PGRAPH_TRAP_DISPATCH - no ustatus?\n");
+		}
+
+		/* Known to be triggered by screwed up NOTIFY and COND... */
+		if (ustatus & 0x00000001) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_DISPATCH_FAULT");
+			nv_wr32(dev, 0x400500, 0);
+			if (nv_rd32(dev, 0x400808) & 0x80000000) {
+				if (display) {
+					if (nouveau_graph_trapped_channel(dev, &trap.channel))
+						trap.channel = -1;
+					trap.class = nv_rd32(dev, 0x400814);
+					trap.mthd = nv_rd32(dev, 0x400808) & 0x1ffc;
+					trap.subc = (nv_rd32(dev, 0x400808) >> 16) & 0x7;
+					trap.data = nv_rd32(dev, 0x40080c);
+					trap.data2 = nv_rd32(dev, 0x400810);
+					nouveau_graph_dump_trap_info(dev,
+							"PGRAPH_TRAP_DISPATCH_FAULT", &trap);
+					NV_INFO(dev, "PGRAPH_TRAP_DISPATCH_FAULT - 400808: %08x\n", nv_rd32(dev, 0x400808));
+					NV_INFO(dev, "PGRAPH_TRAP_DISPATCH_FAULT - 400848: %08x\n", nv_rd32(dev, 0x400848));
+				}
+				nv_wr32(dev, 0x400808, 0);
+			} else if (display) {
+				NV_INFO(dev, "PGRAPH_TRAP_DISPATCH_FAULT - No stuck command?\n");
+			}
+			nv_wr32(dev, 0x4008e8, nv_rd32(dev, 0x4008e8) & 3);
+			nv_wr32(dev, 0x400848, 0);
+			ustatus &= ~0x00000001;
+		}
+		if (ustatus & 0x00000002) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_DISPATCH_QUERY");
+			nv_wr32(dev, 0x400500, 0);
+			if (nv_rd32(dev, 0x40084c) & 0x80000000) {
+				if (display) {
+					if (nouveau_graph_trapped_channel(dev, &trap.channel))
+						trap.channel = -1;
+					trap.class = nv_rd32(dev, 0x400814);
+					trap.mthd = nv_rd32(dev, 0x40084c) & 0x1ffc;
+					trap.subc = (nv_rd32(dev, 0x40084c) >> 16) & 0x7;
+					trap.data = nv_rd32(dev, 0x40085c);
+					trap.data2 = 0;
+					nouveau_graph_dump_trap_info(dev,
+							"PGRAPH_TRAP_DISPATCH_QUERY", &trap);
+					NV_INFO(dev, "PGRAPH_TRAP_DISPATCH_QUERY - 40084c: %08x\n", nv_rd32(dev, 0x40084c));
+				}
+				nv_wr32(dev, 0x40084c, 0);
+			} else if (display) {
+				NV_INFO(dev, "PGRAPH_TRAP_DISPATCH_QUERY - No stuck command?\n");
+			}
+			ustatus &= ~0x00000002;
+		}
+		if (ustatus && display)
+			NV_INFO(dev, "PGRAPH_TRAP_DISPATCH - Unhandled ustatus 0x%08x\n", ustatus);
+		nv_wr32(dev, 0x400804, 0xc0000000);
+		nv_wr32(dev, 0x400108, 0x001);
+		status &= ~0x001;
+	}
+
+	/* TRAPs other than dispatch use the "normal" trap regs. */
+	if (status && display) {
+		nouveau_graph_trap_info(dev, &trap);
+		nouveau_graph_dump_trap_info(dev,
+				"PGRAPH_TRAP", &trap);
+	}
+
+	/* M2MF: Memory to memory copy engine. */
+	if (status & 0x002) {
+		ustatus = nv_rd32(dev, 0x406800) & 0x7fffffff;
+		if (!ustatus && display) {
+			NV_INFO(dev, "PGRAPH_TRAP_M2MF - no ustatus?\n");
+		}
+		if (ustatus & 0x00000001) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_M2MF_NOTIFY");
+			ustatus &= ~0x00000001;
+		}
+		if (ustatus & 0x00000002) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_M2MF_IN");
+			ustatus &= ~0x00000002;
+		}
+		if (ustatus & 0x00000004) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_M2MF_OUT");
+			ustatus &= ~0x00000004;
+		}
+		NV_INFO (dev, "PGRAPH_TRAP_M2MF - %08x %08x %08x %08x\n",
+				nv_rd32(dev, 0x406804),
+				nv_rd32(dev, 0x406808),
+				nv_rd32(dev, 0x40680c),
+				nv_rd32(dev, 0x406810));
+		if (ustatus && display)
+			NV_INFO(dev, "PGRAPH_TRAP_M2MF - Unhandled ustatus 0x%08x\n", ustatus);
+		/* No sane way found yet -- just reset the bugger. */
+		nv_wr32(dev, 0x400040, 2);
+		nv_wr32(dev, 0x400040, 0);
+		nv_wr32(dev, 0x406800, 0xc0000000);
+		nv_wr32(dev, 0x400108, 0x002);
+		status &= ~0x002;
+	}
+
+	/* VFETCH: Fetches data from vertex buffers. */
+	if (status & 0x004) {
+		ustatus = nv_rd32(dev, 0x400c04) & 0x7fffffff;
+		if (!ustatus && display) {
+			NV_INFO(dev, "PGRAPH_TRAP_VFETCH - no ustatus?\n");
+		}
+		if (ustatus & 0x00000001) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_VFETCH_FAULT");
+			NV_INFO (dev, "PGRAPH_TRAP_VFETCH_FAULT - %08x %08x %08x %08x\n",
+					nv_rd32(dev, 0x400c00),
+					nv_rd32(dev, 0x400c08),
+					nv_rd32(dev, 0x400c0c),
+					nv_rd32(dev, 0x400c10));
+			ustatus &= ~0x00000001;
+		}
+		if (ustatus && display)
+			NV_INFO(dev, "PGRAPH_TRAP_VFETCH - Unhandled ustatus 0x%08x\n", ustatus);
+		nv_wr32(dev, 0x400c04, 0xc0000000);
+		nv_wr32(dev, 0x400108, 0x004);
+		status &= ~0x004;
+	}
+
+	/* STRMOUT: DirectX streamout / OpenGL transform feedback. */
+	if (status & 0x008) {
+		ustatus = nv_rd32(dev, 0x401800) & 0x7fffffff;
+		if (!ustatus && display) {
+			NV_INFO(dev, "PGRAPH_TRAP_STRMOUT - no ustatus?\n");
+		}
+		if (ustatus & 0x00000001) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_STRMOUT_FAULT");
+			NV_INFO (dev, "PGRAPH_TRAP_STRMOUT_FAULT - %08x %08x %08x %08x\n",
+					nv_rd32(dev, 0x401804),
+					nv_rd32(dev, 0x401808),
+					nv_rd32(dev, 0x40180c),
+					nv_rd32(dev, 0x401810));
+			ustatus &= ~0x00000001;
+		}
+		if (ustatus && display)
+			NV_INFO(dev, "PGRAPH_TRAP_STRMOUT - Unhandled ustatus 0x%08x\n", ustatus);
+		/* No sane way found yet -- just reset the bugger. */
+		nv_wr32(dev, 0x400040, 0x80);
+		nv_wr32(dev, 0x400040, 0);
+		nv_wr32(dev, 0x401800, 0xc0000000);
+		nv_wr32(dev, 0x400108, 0x008);
+		status &= ~0x008;
+	}
+
+	/* CCACHE: Handles code and c[] caches and fills them. */
+	if (status & 0x010) {
+		ustatus = nv_rd32(dev, 0x405018) & 0x7fffffff;
+		if (!ustatus && display) {
+			NV_INFO(dev, "PGRAPH_TRAP_CCACHE - no ustatus?\n");
+		}
+		if (ustatus & 0x00000001) {
+			nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_CCACHE_FAULT");
+			NV_INFO (dev, "PGRAPH_TRAP_CCACHE_FAULT - %08x %08x %08x %08x %08x %08x %08x\n",
+					nv_rd32(dev, 0x405800),
+					nv_rd32(dev, 0x405804),
+					nv_rd32(dev, 0x405808),
+					nv_rd32(dev, 0x40580c),
+					nv_rd32(dev, 0x405810),
+					nv_rd32(dev, 0x405814),
+					nv_rd32(dev, 0x40581c));
+			ustatus &= ~0x00000001;
+		}
+		if (ustatus && display)
+			NV_INFO(dev, "PGRAPH_TRAP_CCACHE - Unhandled ustatus 0x%08x\n", ustatus);
+		nv_wr32(dev, 0x405018, 0xc0000000);
+		nv_wr32(dev, 0x400108, 0x010);
+		status &= ~0x010;
+	}
+
+	/* Unknown, not seen yet... 0x402000 is the only trap status reg
+	 * remaining, so try to handle it anyway. Perhaps related to that
+	 * unknown DMA slot on tesla? */
+	if (status & 0x20) {
+		nv50_pfb_vm_trap(dev, display, "PGRAPH_TRAP_UNKC04");
+		ustatus = nv_rd32(dev, 0x402000) & 0x7fffffff;
+		if (display)
+			NV_INFO(dev, "PGRAPH_TRAP_UNKC04 - Unhandled ustatus 0x%08x\n", ustatus);
+		nv_wr32(dev, 0x402000, 0xc0000000);
+		/* no status modifiction on purpose */
+	}
+
+	/* TEXTURE: CUDA texturing units */
+	if (status & 0x040) {
+		nv50_pgraph_tp_trap (dev, 6, 0x408900, 0x408600, display,
+				"PGRAPH_TRAP_TEXTURE");
+		nv_wr32(dev, 0x400108, 0x040);
+		status &= ~0x040;
+	}
+
+	/* MP: CUDA execution engines. */
+	if (status & 0x080) {
+		nv50_pgraph_tp_trap (dev, 7, 0x408314, 0x40831c, display,
+				"PGRAPH_TRAP_MP");
+		nv_wr32(dev, 0x400108, 0x080);
+		status &= ~0x080;
+	}
+
+	/* TPDMA:  Handles TP-initiated uncached memory accesses:
+	 * l[], g[], stack, 2d surfaces, render targets. */
+	if (status & 0x100) {
+		nv50_pgraph_tp_trap (dev, 8, 0x408e08, 0x408708, display,
+				"PGRAPH_TRAP_TPDMA");
+		nv_wr32(dev, 0x400108, 0x100);
+		status &= ~0x100;
+	}
+
+	if (status) {
+		if (display)
+			NV_INFO(dev, "PGRAPH_TRAP - Unknown trap 0x%08x\n",
+				status);
+		nv_wr32(dev, 0x400108, status);
+	}
+}
+
+/* There must be a *lot* of these. Will take some time to gather them up. */
+static struct nouveau_enum_names nv50_data_error_names[] =
+{
+	{ 4,	"INVALID_VALUE" },
+	{ 5,	"INVALID_ENUM" },
+	{ 8,	"INVALID_OBJECT" },
+	{ 0xc,	"INVALID_BITFIELD" },
+	{ 0x28,	"MP_NO_REG_SPACE" },
+	{ 0x2b,	"MP_BLOCK_SIZE_MISMATCH" },
+};
+
+static void
 nv50_pgraph_irq_handler(struct drm_device *dev)
 {
+	struct nouveau_pgraph_trap trap;
+	int unhandled = 0;
 	uint32_t status;
 
 	while ((status = nv_rd32(dev, NV03_PGRAPH_INTR))) {
-		uint32_t nsource = nv_rd32(dev, NV03_PGRAPH_NSOURCE);
-
+		/* NOTIFY: You've set a NOTIFY an a command and it's done. */
 		if (status & 0x00000001) {
-			nouveau_pgraph_intr_notify(dev, nsource);
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_NOTIFY", &trap);
 			status &= ~0x00000001;
 			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00000001);
 		}
 
-		if (status & 0x00000010) {
-			nouveau_pgraph_intr_error(dev, nsource |
-					NV03_PGRAPH_NSOURCE_ILLEGAL_MTHD);
+		/* COMPUTE_QUERY: Purpose and exact cause unknown, happens
+		 * when you write 0x200 to 0x50c0 method 0x31c. */
+		if (status & 0x00000002) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_COMPUTE_QUERY", &trap);
+			status &= ~0x00000002;
+			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00000002);
+		}
 
+		/* Unknown, never seen: 0x4 */
+
+		/* ILLEGAL_MTHD: You used a wrong method for this class. */
+		if (status & 0x00000010) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_pgraph_intr_swmthd(dev, &trap))
+				unhandled = 1;
+			if (unhandled && nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_ILLEGAL_MTHD", &trap);
 			status &= ~0x00000010;
 			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00000010);
 		}
 
+		/* ILLEGAL_CLASS: You used a wrong class. */
+		if (status & 0x00000020) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_ILLEGAL_CLASS", &trap);
+			status &= ~0x00000020;
+			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00000020);
+		}
+
+		/* DOUBLE_NOTIFY: You tried to set a NOTIFY on another NOTIFY. */
+		if (status & 0x00000040) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_DOUBLE_NOTIFY", &trap);
+			status &= ~0x00000040;
+			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00000040);
+		}
+
+		/* CONTEXT_SWITCH: PGRAPH needs us to load a new context */
 		if (status & 0x00001000) {
 			nv_wr32(dev, 0x400500, 0x00000000);
 			nv_wr32(dev, NV03_PGRAPH_INTR,
@@ -613,49 +1116,59 @@
 			status &= ~NV_PGRAPH_INTR_CONTEXT_SWITCH;
 		}
 
-		if (status & 0x00100000) {
-			nouveau_pgraph_intr_error(dev, nsource |
-					NV03_PGRAPH_NSOURCE_DATA_ERROR);
+		/* BUFFER_NOTIFY: Your m2mf transfer finished */
+		if (status & 0x00010000) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_BUFFER_NOTIFY", &trap);
+			status &= ~0x00010000;
+			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00010000);
+		}
 
+		/* DATA_ERROR: Invalid value for this method, or invalid
+		 * state in current PGRAPH context for this operation */
+		if (status & 0x00100000) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit()) {
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_DATA_ERROR", &trap);
+				NV_INFO (dev, "PGRAPH_DATA_ERROR - ");
+				nouveau_print_enum_names(nv_rd32(dev, 0x400110),
+						nv50_data_error_names);
+				printk("\n");
+			}
 			status &= ~0x00100000;
 			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00100000);
 		}
 
+		/* TRAP: Something bad happened in the middle of command
+		 * execution.  Has a billion types, subtypes, and even
+		 * subsubtypes. */
 		if (status & 0x00200000) {
-			int r;
-
-			nouveau_pgraph_intr_error(dev, nsource |
-					NV03_PGRAPH_NSOURCE_PROTECTION_ERROR);
-
-			NV_ERROR(dev, "magic set 1:\n");
-			for (r = 0x408900; r <= 0x408910; r += 4)
-				NV_ERROR(dev, "\t0x%08x: 0x%08x\n", r,
-					nv_rd32(dev, r));
-			nv_wr32(dev, 0x408900,
-				nv_rd32(dev, 0x408904) | 0xc0000000);
-			for (r = 0x408e08; r <= 0x408e24; r += 4)
-				NV_ERROR(dev, "\t0x%08x: 0x%08x\n", r,
-							nv_rd32(dev, r));
-			nv_wr32(dev, 0x408e08,
-				nv_rd32(dev, 0x408e08) | 0xc0000000);
-
-			NV_ERROR(dev, "magic set 2:\n");
-			for (r = 0x409900; r <= 0x409910; r += 4)
-				NV_ERROR(dev, "\t0x%08x: 0x%08x\n", r,
-					nv_rd32(dev, r));
-			nv_wr32(dev, 0x409900,
-				nv_rd32(dev, 0x409904) | 0xc0000000);
-			for (r = 0x409e08; r <= 0x409e24; r += 4)
-				NV_ERROR(dev, "\t0x%08x: 0x%08x\n", r,
-					nv_rd32(dev, r));
-			nv_wr32(dev, 0x409e08,
-				nv_rd32(dev, 0x409e08) | 0xc0000000);
-
+			nv50_pgraph_trap_handler(dev);
 			status &= ~0x00200000;
-			nv_wr32(dev, NV03_PGRAPH_NSOURCE, nsource);
 			nv_wr32(dev, NV03_PGRAPH_INTR, 0x00200000);
 		}
 
+		/* Unknown, never seen: 0x00400000 */
+
+		/* SINGLE_STEP: Happens on every method if you turned on
+		 * single stepping in 40008c */
+		if (status & 0x01000000) {
+			nouveau_graph_trap_info(dev, &trap);
+			if (nouveau_ratelimit())
+				nouveau_graph_dump_trap_info(dev,
+						"PGRAPH_SINGLE_STEP", &trap);
+			status &= ~0x01000000;
+			nv_wr32(dev, NV03_PGRAPH_INTR, 0x01000000);
+		}
+
+		/* 0x02000000 happens when you pause a ctxprog...
+		 * but the only way this can happen that I know is by
+		 * poking the relevant MMIO register, and we don't
+		 * do that. */
+
 		if (status) {
 			NV_INFO(dev, "Unhandled PGRAPH_INTR - 0x%08x\n",
 				status);
@@ -672,7 +1185,8 @@
 	}
 
 	nv_wr32(dev, NV03_PMC_INTR_0, NV_PMC_INTR_0_PGRAPH_PENDING);
-	nv_wr32(dev, 0x400824, nv_rd32(dev, 0x400824) & ~(1 << 31));
+	if (nv_rd32(dev, 0x400824) & (1 << 31))
+		nv_wr32(dev, 0x400824, nv_rd32(dev, 0x400824) & ~(1 << 31));
 }
 
 static void
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_mem.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_mem.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_mem.c	2010-04-13 02:19:00.805633102 +0000
@@ -347,6 +347,20 @@
 		return -EBUSY;
 	}
 
+	nv_wr32(dev, 0x100c80, 0x00040001);
+	if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+		NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+		NV_ERROR(dev, "0x100c80 = 0x%08x\n", nv_rd32(dev, 0x100c80));
+		return -EBUSY;
+	}
+
+	nv_wr32(dev, 0x100c80, 0x00060001);
+	if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+		NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+		NV_ERROR(dev, "0x100c80 = 0x%08x\n", nv_rd32(dev, 0x100c80));
+		return -EBUSY;
+	}
+
 	return 0;
 }
 
@@ -387,6 +401,20 @@
 	if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
 		NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
 		NV_ERROR(dev, "0x100c80 = 0x%08x\n", nv_rd32(dev, 0x100c80));
+		return;
+	}
+
+	nv_wr32(dev, 0x100c80, 0x00040001);
+	if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+		NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+		NV_ERROR(dev, "0x100c80 = 0x%08x\n", nv_rd32(dev, 0x100c80));
+		return;
+	}
+
+	nv_wr32(dev, 0x100c80, 0x00060001);
+	if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+		NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+		NV_ERROR(dev, "0x100c80 = 0x%08x\n", nv_rd32(dev, 0x100c80));
 	}
 }
 
@@ -449,9 +477,30 @@
 	}
 }
 
-/*XXX won't work on BSD because of pci_read_config_dword */
 static uint32_t
-nouveau_mem_fb_amount_igp(struct drm_device *dev)
+nouveau_mem_detect_nv04(struct drm_device *dev)
+{
+	uint32_t boot0 = nv_rd32(dev, NV03_BOOT_0);
+
+	if (boot0 & 0x00000100)
+		return (((boot0 >> 12) & 0xf) * 2 + 2) * 1024 * 1024;
+
+	switch (boot0 & NV03_BOOT_0_RAM_AMOUNT) {
+	case NV04_BOOT_0_RAM_AMOUNT_32MB:
+		return 32 * 1024 * 1024;
+	case NV04_BOOT_0_RAM_AMOUNT_16MB:
+		return 16 * 1024 * 1024;
+	case NV04_BOOT_0_RAM_AMOUNT_8MB:
+		return 8 * 1024 * 1024;
+	case NV04_BOOT_0_RAM_AMOUNT_4MB:
+		return 4 * 1024 * 1024;
+	}
+
+	return 0;
+}
+
+static uint32_t
+nouveau_mem_detect_nforce(struct drm_device *dev)
 {
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	struct pci_dev *bridge;
@@ -463,11 +512,11 @@
 		return 0;
 	}
 
-	if (dev_priv->flags&NV_NFORCE) {
+	if (dev_priv->flags & NV_NFORCE) {
 		pci_read_config_dword(bridge, 0x7C, &mem);
 		return (uint64_t)(((mem >> 6) & 31) + 1)*1024*1024;
 	} else
-	if (dev_priv->flags&NV_NFORCE2) {
+	if (dev_priv->flags & NV_NFORCE2) {
 		pci_read_config_dword(bridge, 0x84, &mem);
 		return (uint64_t)(((mem >> 4) & 127) + 1)*1024*1024;
 	}
@@ -477,50 +526,32 @@
 }
 
 /* returns the amount of FB ram in bytes */
-uint64_t nouveau_mem_fb_amount(struct drm_device *dev)
+int
+nouveau_mem_detect(struct drm_device *dev)
 {
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
-	uint32_t boot0;
 
-	switch (dev_priv->card_type) {
-	case NV_04:
-		boot0 = nv_rd32(dev, NV03_BOOT_0);
-		if (boot0 & 0x00000100)
-			return (((boot0 >> 12) & 0xf) * 2 + 2) * 1024 * 1024;
-
-		switch (boot0 & NV03_BOOT_0_RAM_AMOUNT) {
-		case NV04_BOOT_0_RAM_AMOUNT_32MB:
-			return 32 * 1024 * 1024;
-		case NV04_BOOT_0_RAM_AMOUNT_16MB:
-			return 16 * 1024 * 1024;
-		case NV04_BOOT_0_RAM_AMOUNT_8MB:
-			return 8 * 1024 * 1024;
-		case NV04_BOOT_0_RAM_AMOUNT_4MB:
-			return 4 * 1024 * 1024;
-		}
-		break;
-	case NV_10:
-	case NV_20:
-	case NV_30:
-	case NV_40:
-	case NV_50:
-	default:
-		if (dev_priv->flags & (NV_NFORCE | NV_NFORCE2)) {
-			return nouveau_mem_fb_amount_igp(dev);
-		} else {
-			uint64_t mem;
-			mem = (nv_rd32(dev, NV04_FIFO_DATA) &
-					NV10_FIFO_DATA_RAM_AMOUNT_MB_MASK) >>
-					NV10_FIFO_DATA_RAM_AMOUNT_MB_SHIFT;
-			return mem * 1024 * 1024;
-		}
-		break;
+	if (dev_priv->card_type == NV_04) {
+		dev_priv->vram_size = nouveau_mem_detect_nv04(dev);
+	} else
+	if (dev_priv->flags & (NV_NFORCE | NV_NFORCE2)) {
+		dev_priv->vram_size = nouveau_mem_detect_nforce(dev);
+	} else {
+		dev_priv->vram_size  = nv_rd32(dev, NV04_FIFO_DATA);
+		dev_priv->vram_size &= NV10_FIFO_DATA_RAM_AMOUNT_MB_MASK;
+		if (dev_priv->chipset == 0xaa || dev_priv->chipset == 0xac)
+			dev_priv->vram_sys_base = nv_rd32(dev, 0x100e10) << 12;
+	}
+
+	NV_INFO(dev, "Detected %dMiB VRAM\n", (int)(dev_priv->vram_size >> 20));
+	if (dev_priv->vram_sys_base) {
+		NV_INFO(dev, "Stolen system memory at: 0x%010llx\n",
+			dev_priv->vram_sys_base);
 	}
 
-	NV_ERROR(dev,
-		"Unable to detect video ram size. Please report your setup to "
-							DRIVER_EMAIL "\n");
-	return 0;
+	if (dev_priv->vram_size)
+		return 0;
+	return -ENOMEM;
 }
 
 #if __OS_HAS_AGP
@@ -631,15 +662,12 @@
 	spin_lock_init(&dev_priv->ttm.bo_list_lock);
 	spin_lock_init(&dev_priv->tile.lock);
 
-	dev_priv->fb_available_size = nouveau_mem_fb_amount(dev);
-
+	dev_priv->fb_available_size = dev_priv->vram_size;
 	dev_priv->fb_mappable_pages = dev_priv->fb_available_size;
 	if (dev_priv->fb_mappable_pages > drm_get_resource_len(dev, 1))
 		dev_priv->fb_mappable_pages = drm_get_resource_len(dev, 1);
 	dev_priv->fb_mappable_pages >>= PAGE_SHIFT;
 
-	NV_INFO(dev, "%d MiB VRAM\n", (int)(dev_priv->fb_available_size >> 20));
-
 	/* remove reserved space at end of vram from available amount */
 	dev_priv->fb_available_size -= dev_priv->ramin_rsvd_vram;
 	dev_priv->fb_aper_free = dev_priv->fb_available_size;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_sgdma.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_sgdma.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_sgdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_sgdma.c	2010-04-13 02:19:00.806633023 +0000
@@ -1,6 +1,7 @@
 #include "drmP.h"
 #include "nouveau_drv.h"
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 
 #define NV_CTXDMA_PAGE_SHIFT 12
 #define NV_CTXDMA_PAGE_SIZE  (1 << NV_CTXDMA_PAGE_SHIFT)
@@ -171,6 +172,24 @@
 	}
 	dev_priv->engine.instmem.finish_access(nvbe->dev);
 
+	if (dev_priv->card_type == NV_50) {
+		nv_wr32(dev, 0x100c80, 0x00050001);
+		if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+			NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+			NV_ERROR(dev, "0x100c80 = 0x%08x\n",
+						nv_rd32(dev, 0x100c80));
+			return -EBUSY;
+		}
+
+		nv_wr32(dev, 0x100c80, 0x00000001);
+		if (!nv_wait(0x100c80, 0x00000001, 0x00000000)) {
+			NV_ERROR(dev, "timeout: (0x100c80 & 1) == 0 (2)\n");
+			NV_ERROR(dev, "0x100c80 = 0x%08x\n",
+						nv_rd32(dev, 0x100c80));
+			return -EBUSY;
+		}
+	}
+
 	nvbe->bound = false;
 	return 0;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_state.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_state.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nouveau_state.c	2010-04-13 02:18:55.686633162 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nouveau_state.c	2010-04-13 02:19:00.806633023 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/swab.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "drm_sarea.h"
@@ -35,7 +36,6 @@
 #include "nouveau_drm.h"
 #include "nv50_display.h"
 
-static int nouveau_stub_init(struct drm_device *dev) { return 0; }
 static void nouveau_stub_takedown(struct drm_device *dev) {}
 
 static int nouveau_init_engine_ptrs(struct drm_device *dev)
@@ -277,8 +277,8 @@
 		engine->timer.init		= nv04_timer_init;
 		engine->timer.read		= nv04_timer_read;
 		engine->timer.takedown		= nv04_timer_takedown;
-		engine->fb.init			= nouveau_stub_init;
-		engine->fb.takedown		= nouveau_stub_takedown;
+		engine->fb.init			= nv50_fb_init;
+		engine->fb.takedown		= nv50_fb_takedown;
 		engine->graph.grclass		= nv50_graph_grclass;
 		engine->graph.init		= nv50_graph_init;
 		engine->graph.takedown		= nv50_graph_takedown;
@@ -341,7 +341,7 @@
 
 	gpuobj = NULL;
 	ret = nouveau_gpuobj_dma_new(dev_priv->channel, NV_CLASS_DMA_IN_MEMORY,
-				     0, nouveau_mem_fb_amount(dev),
+				     0, dev_priv->vram_size,
 				     NV_DMA_ACCESS_RW, NV_DMA_TARGET_VIDMEM,
 				     &gpuobj);
 	if (ret)
@@ -427,6 +427,10 @@
 			goto out;
 	}
 
+	ret = nouveau_mem_detect(dev);
+	if (ret)
+		goto out_bios;
+
 	ret = nouveau_gpuobj_early_init(dev);
 	if (ret)
 		goto out_bios;
@@ -502,7 +506,7 @@
 		else
 			ret = nv04_display_create(dev);
 		if (ret)
-			goto out_irq;
+			goto out_channel;
 	}
 
 	ret = nouveau_backlight_init(dev);
@@ -516,6 +520,11 @@
 
 	return 0;
 
+out_channel:
+	if (dev_priv->channel) {
+		nouveau_channel_free(dev_priv->channel);
+		dev_priv->channel = NULL;
+	}
 out_irq:
 	drm_irq_uninstall(dev);
 out_fifo:
@@ -533,6 +542,7 @@
 out_gpuobj:
 	nouveau_gpuobj_takedown(dev);
 out_mem:
+	nouveau_sgdma_takedown(dev);
 	nouveau_mem_close(dev);
 out_instmem:
 	engine->instmem.takedown(dev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv04_crtc.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv04_crtc.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv04_crtc.c	2010-04-13 02:18:55.686633162 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv04_crtc.c	2010-04-13 02:19:00.806633023 +0000
@@ -230,9 +230,9 @@
 	struct drm_framebuffer *fb = crtc->fb;
 
 	/* Calculate our timings */
-	int horizDisplay	= (mode->crtc_hdisplay >> 3) 	- 1;
-	int horizStart		= (mode->crtc_hsync_start >> 3) 	- 1;
-	int horizEnd		= (mode->crtc_hsync_end >> 3) 	- 1;
+	int horizDisplay	= (mode->crtc_hdisplay >> 3)		- 1;
+	int horizStart		= (mode->crtc_hsync_start >> 3) 	+ 1;
+	int horizEnd		= (mode->crtc_hsync_end >> 3)		+ 1;
 	int horizTotal		= (mode->crtc_htotal >> 3)		- 5;
 	int horizBlankStart	= (mode->crtc_hdisplay >> 3)		- 1;
 	int horizBlankEnd	= (mode->crtc_htotal >> 3)		- 1;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv04_fbcon.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv04_fbcon.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv04_fbcon.c	2010-04-13 02:18:55.687633044 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv04_fbcon.c	2010-04-13 02:19:00.807571916 +0000
@@ -118,8 +118,8 @@
 		return;
 	}
 
-	width = ALIGN(image->width, 32);
-	dsize = (width * image->height) >> 5;
+	width = ALIGN(image->width, 8);
+	dsize = ALIGN(width * image->height, 32) >> 5;
 
 	if (info->fix.visual == FB_VISUAL_TRUECOLOR ||
 	    info->fix.visual == FB_VISUAL_DIRECTCOLOR) {
@@ -136,8 +136,8 @@
 			 ((image->dx + image->width) & 0xffff));
 	OUT_RING(chan, bg);
 	OUT_RING(chan, fg);
-	OUT_RING(chan, (image->height << 16) | image->width);
 	OUT_RING(chan, (image->height << 16) | width);
+	OUT_RING(chan, (image->height << 16) | image->width);
 	OUT_RING(chan, (image->dy << 16) | (image->dx & 0xffff));
 
 	while (dsize) {
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv40_fifo.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv40_fifo.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv40_fifo.c	2010-04-13 02:18:55.687633044 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv40_fifo.c	2010-04-13 02:19:00.807571916 +0000
@@ -278,7 +278,7 @@
 	default:
 		nv_wr32(dev, 0x2230, 0);
 		nv_wr32(dev, NV40_PFIFO_RAMFC,
-			((nouveau_mem_fb_amount(dev) - 512 * 1024 +
+			((dev_priv->vram_size - 512 * 1024 +
 			  dev_priv->ramfc_offset) >> 16) | (3 << 16));
 		break;
 	}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv40_graph.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv40_graph.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv40_graph.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv40_graph.c	2010-04-13 02:19:00.807571916 +0000
@@ -335,6 +335,27 @@
 	nv_wr32(dev, 0x400b38, 0x2ffff800);
 	nv_wr32(dev, 0x400b3c, 0x00006000);
 
+	/* Tiling related stuff. */
+	switch (dev_priv->chipset) {
+	case 0x44:
+	case 0x4a:
+		nv_wr32(dev, 0x400bc4, 0x1003d888);
+		nv_wr32(dev, 0x400bbc, 0xb7a7b500);
+		break;
+	case 0x46:
+		nv_wr32(dev, 0x400bc4, 0x0000e024);
+		nv_wr32(dev, 0x400bbc, 0xb7a7b520);
+		break;
+	case 0x4c:
+	case 0x4e:
+	case 0x67:
+		nv_wr32(dev, 0x400bc4, 0x1003d888);
+		nv_wr32(dev, 0x400bbc, 0xb7a7b540);
+		break;
+	default:
+		break;
+	}
+
 	/* Turn all the tiling regions off. */
 	for (i = 0; i < pfb->num_tiles; i++)
 		nv40_graph_set_region_tiling(dev, i, 0, 0, 0);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_display.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_display.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_display.c	2010-04-13 02:18:55.688633034 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_display.c	2010-04-13 02:19:00.808570605 +0000
@@ -143,7 +143,7 @@
 	}
 
 	ret = nv50_evo_dmaobj_new(chan, 0x3d, NvEvoVRAM, 0, 0x19,
-				  0, nouveau_mem_fb_amount(dev));
+				  0, dev_priv->vram_size);
 	if (ret) {
 		nv50_evo_channel_del(pchan);
 		return ret;
@@ -231,7 +231,7 @@
 	/* This used to be in crtc unblank, but seems out of place there. */
 	nv_wr32(dev, NV50_PDISPLAY_UNK_380, 0);
 	/* RAM is clamped to 256 MiB. */
-	ram_amount = nouveau_mem_fb_amount(dev);
+	ram_amount = dev_priv->vram_size;
 	NV_DEBUG_KMS(dev, "ram_amount %d\n", ram_amount);
 	if (ram_amount > 256*1024*1024)
 		ram_amount = 256*1024*1024;
@@ -522,15 +522,17 @@
 	}
 
 	for (i = 0 ; i < dcb->connector.entries; i++) {
-		if (i != 0 && dcb->connector.entry[i].index ==
-			      dcb->connector.entry[i - 1].index)
+		if (i != 0 && dcb->connector.entry[i].index2 ==
+			      dcb->connector.entry[i - 1].index2)
 			continue;
 		nouveau_connector_create(dev, &dcb->connector.entry[i]);
 	}
 
 	ret = nv50_display_init(dev);
-	if (ret)
+	if (ret) {
+		nv50_display_destroy(dev);
 		return ret;
+	}
 
 	return 0;
 }
@@ -885,10 +887,12 @@
 	nv_wr32(dev, NV50_PDISPLAY_TRAPPED_ADDR, 0x90000000);
 }
 
-static void
-nv50_display_irq_hotplug(struct drm_device *dev)
+void
+nv50_display_irq_hotplug_bh(struct work_struct *work)
 {
-	struct drm_nouveau_private *dev_priv = dev->dev_private;
+	struct drm_nouveau_private *dev_priv =
+		container_of(work, struct drm_nouveau_private, hpd_work);
+	struct drm_device *dev = dev_priv->dev;
 	struct drm_connector *connector;
 	const uint32_t gpio_reg[4] = { 0xe104, 0xe108, 0xe280, 0xe284 };
 	uint32_t unplug_mask, plug_mask, change_mask;
@@ -949,8 +953,10 @@
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	uint32_t delayed = 0;
 
-	while (nv_rd32(dev, NV50_PMC_INTR_0) & NV50_PMC_INTR_0_HOTPLUG)
-		nv50_display_irq_hotplug(dev);
+	if (nv_rd32(dev, NV50_PMC_INTR_0) & NV50_PMC_INTR_0_HOTPLUG) {
+		if (!work_pending(&dev_priv->hpd_work))
+			queue_work(dev_priv->wq, &dev_priv->hpd_work);
+	}
 
 	while (nv_rd32(dev, NV50_PMC_INTR_0) & NV50_PMC_INTR_0_DISPLAY) {
 		uint32_t intr0 = nv_rd32(dev, NV50_PDISPLAY_INTR_0);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_display.h linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_display.h
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_display.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_display.h	2010-04-13 02:19:00.808570605 +0000
@@ -37,6 +37,7 @@
 
 void nv50_display_irq_handler(struct drm_device *dev);
 void nv50_display_irq_handler_bh(struct work_struct *work);
+void nv50_display_irq_hotplug_bh(struct work_struct *work);
 int nv50_display_init(struct drm_device *dev);
 int nv50_display_create(struct drm_device *dev);
 int nv50_display_destroy(struct drm_device *dev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_fb.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_fb.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_fb.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_fb.c	2010-04-13 02:19:00.808570605 +0000
@@ -0,0 +1,32 @@
+#include "drmP.h"
+#include "drm.h"
+#include "nouveau_drv.h"
+#include "nouveau_drm.h"
+
+int
+nv50_fb_init(struct drm_device *dev)
+{
+	/* This is needed to get meaningful information from 100c90
+	 * on traps. No idea what these values mean exactly. */
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
+
+	switch (dev_priv->chipset) {
+	case 0x50:
+		nv_wr32(dev, 0x100c90, 0x0707ff);
+		break;
+	case 0xa5:
+	case 0xa8:
+		nv_wr32(dev, 0x100c90, 0x0d0fff);
+		break;
+	default:
+		nv_wr32(dev, 0x100c90, 0x1d07ff);
+		break;
+	}
+
+	return 0;
+}
+
+void
+nv50_fb_takedown(struct drm_device *dev)
+{
+}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_fbcon.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_fbcon.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_fbcon.c	2010-04-13 02:18:55.688633034 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_fbcon.c	2010-04-13 02:19:00.808570605 +0000
@@ -157,8 +157,11 @@
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	struct nouveau_channel *chan = dev_priv->channel;
 	struct nouveau_gpuobj *eng2d = NULL;
+	uint64_t fb;
 	int ret, format;
 
+	fb = info->fix.smem_start - dev_priv->fb_phys + dev_priv->vm_vram_base;
+
 	switch (info->var.bits_per_pixel) {
 	case 8:
 		format = 0xf3;
@@ -233,7 +236,7 @@
 	BEGIN_RING(chan, NvSub2D, 0x0808, 3);
 	OUT_RING(chan, 0);
 	OUT_RING(chan, 0);
-	OUT_RING(chan, 0);
+	OUT_RING(chan, 1);
 	BEGIN_RING(chan, NvSub2D, 0x081c, 1);
 	OUT_RING(chan, 1);
 	BEGIN_RING(chan, NvSub2D, 0x0840, 4);
@@ -248,9 +251,8 @@
 	OUT_RING(chan, info->fix.line_length);
 	OUT_RING(chan, info->var.xres_virtual);
 	OUT_RING(chan, info->var.yres_virtual);
-	OUT_RING(chan, 0);
-	OUT_RING(chan, info->fix.smem_start - dev_priv->fb_phys +
-			 dev_priv->vm_vram_base);
+	OUT_RING(chan, upper_32_bits(fb));
+	OUT_RING(chan, lower_32_bits(fb));
 	BEGIN_RING(chan, NvSub2D, 0x0230, 2);
 	OUT_RING(chan, format);
 	OUT_RING(chan, 1);
@@ -258,9 +260,8 @@
 	OUT_RING(chan, info->fix.line_length);
 	OUT_RING(chan, info->var.xres_virtual);
 	OUT_RING(chan, info->var.yres_virtual);
-	OUT_RING(chan, 0);
-	OUT_RING(chan, info->fix.smem_start - dev_priv->fb_phys +
-			 dev_priv->vm_vram_base);
+	OUT_RING(chan, upper_32_bits(fb));
+	OUT_RING(chan, lower_32_bits(fb));
 
 	return 0;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_gpio.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_gpio.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_gpio.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_gpio.c	2010-04-13 02:19:00.808570605 +0000
@@ -0,0 +1,76 @@
+/*
+ * Copyright 2010 Red Hat Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Authors: Ben Skeggs
+ */
+
+#include "drmP.h"
+#include "nouveau_drv.h"
+#include "nouveau_hw.h"
+
+static int
+nv50_gpio_location(struct dcb_gpio_entry *gpio, uint32_t *reg, uint32_t *shift)
+{
+	const uint32_t nv50_gpio_reg[4] = { 0xe104, 0xe108, 0xe280, 0xe284 };
+
+	if (gpio->line > 32)
+		return -EINVAL;
+
+	*reg = nv50_gpio_reg[gpio->line >> 3];
+	*shift = (gpio->line & 7) << 2;
+	return 0;
+}
+
+int
+nv50_gpio_get(struct drm_device *dev, enum dcb_gpio_tag tag)
+{
+	struct dcb_gpio_entry *gpio;
+	uint32_t r, s, v;
+
+	gpio = nouveau_bios_gpio_entry(dev, tag);
+	if (!gpio)
+		return -ENOENT;
+
+	if (nv50_gpio_location(gpio, &r, &s))
+		return -EINVAL;
+
+	v = nv_rd32(dev, r) >> (s + 2);
+	return ((v & 1) == (gpio->state[1] & 1));
+}
+
+int
+nv50_gpio_set(struct drm_device *dev, enum dcb_gpio_tag tag, int state)
+{
+	struct dcb_gpio_entry *gpio;
+	uint32_t r, s, v;
+
+	gpio = nouveau_bios_gpio_entry(dev, tag);
+	if (!gpio)
+		return -ENOENT;
+
+	if (nv50_gpio_location(gpio, &r, &s))
+		return -EINVAL;
+
+	v  = nv_rd32(dev, r) & ~(0x3 << s);
+	v |= (gpio->state[state] ^ 2) << s;
+	nv_wr32(dev, r, v);
+	return 0;
+}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_graph.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_graph.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_graph.c	2010-04-13 02:18:55.688633034 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_graph.c	2010-04-13 02:19:00.808570605 +0000
@@ -56,6 +56,10 @@
 static void
 nv50_graph_init_regs__nv(struct drm_device *dev)
 {
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
+	uint32_t units = nv_rd32(dev, 0x1540);
+	int i;
+
 	NV_DEBUG(dev, "\n");
 
 	nv_wr32(dev, 0x400804, 0xc0000000);
@@ -65,6 +69,20 @@
 	nv_wr32(dev, 0x405018, 0xc0000000);
 	nv_wr32(dev, 0x402000, 0xc0000000);
 
+	for (i = 0; i < 16; i++) {
+		if (units & 1 << i) {
+			if (dev_priv->chipset < 0xa0) {
+				nv_wr32(dev, 0x408900 + (i << 12), 0xc0000000);
+				nv_wr32(dev, 0x408e08 + (i << 12), 0xc0000000);
+				nv_wr32(dev, 0x408314 + (i << 12), 0xc0000000);
+			} else {
+				nv_wr32(dev, 0x408600 + (i << 11), 0xc0000000);
+				nv_wr32(dev, 0x408708 + (i << 11), 0xc0000000);
+				nv_wr32(dev, 0x40831c + (i << 11), 0xc0000000);
+			}
+		}
+	}
+
 	nv_wr32(dev, 0x400108, 0xffffffff);
 
 	nv_wr32(dev, 0x400824, 0x00004000);
@@ -229,10 +247,6 @@
 		nouveau_grctx_vals_load(dev, ctx);
 	}
 	nv_wo32(dev, ctx, 0x00000/4, chan->ramin->instance >> 12);
-	if ((dev_priv->chipset & 0xf0) == 0xa0)
-		nv_wo32(dev, ctx, 0x00004/4, 0x00000000);
-	else
-		nv_wo32(dev, ctx, 0x0011c/4, 0x00000000);
 	dev_priv->engine.instmem.finish_access(dev);
 
 	return 0;
@@ -396,9 +410,10 @@
 	{ 0x5039, false, NULL }, /* m2mf */
 	{ 0x502d, false, NULL }, /* 2d */
 	{ 0x50c0, false, NULL }, /* compute */
+	{ 0x85c0, false, NULL }, /* compute (nva3, nva5, nva8) */
 	{ 0x5097, false, NULL }, /* tesla (nv50) */
-	{ 0x8297, false, NULL }, /* tesla (nv80/nv90) */
-	{ 0x8397, false, NULL }, /* tesla (nva0) */
-	{ 0x8597, false, NULL }, /* tesla (nva8) */
+	{ 0x8297, false, NULL }, /* tesla (nv8x/nv9x) */
+	{ 0x8397, false, NULL }, /* tesla (nva0, nvaa, nvac) */
+	{ 0x8597, false, NULL }, /* tesla (nva3, nva5, nva8) */
 	{}
 };
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_grctx.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_grctx.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_grctx.c	2010-04-13 02:18:55.689571417 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_grctx.c	2010-04-13 02:19:00.809633045 +0000
@@ -55,15 +55,18 @@
 #define CP_FLAG_AUTO_LOAD             ((2 * 32) + 5)
 #define CP_FLAG_AUTO_LOAD_NOT_PENDING 0
 #define CP_FLAG_AUTO_LOAD_PENDING     1
+#define CP_FLAG_NEWCTX                ((2 * 32) + 10)
+#define CP_FLAG_NEWCTX_BUSY           0
+#define CP_FLAG_NEWCTX_DONE           1
 #define CP_FLAG_XFER                  ((2 * 32) + 11)
 #define CP_FLAG_XFER_IDLE             0
 #define CP_FLAG_XFER_BUSY             1
-#define CP_FLAG_NEWCTX                ((2 * 32) + 12)
-#define CP_FLAG_NEWCTX_BUSY           0
-#define CP_FLAG_NEWCTX_DONE           1
 #define CP_FLAG_ALWAYS                ((2 * 32) + 13)
 #define CP_FLAG_ALWAYS_FALSE          0
 #define CP_FLAG_ALWAYS_TRUE           1
+#define CP_FLAG_INTR                  ((2 * 32) + 15)
+#define CP_FLAG_INTR_NOT_PENDING      0
+#define CP_FLAG_INTR_PENDING          1
 
 #define CP_CTX                   0x00100000
 #define CP_CTX_COUNT             0x000f0000
@@ -174,6 +177,7 @@
 	case 0x96:
 	case 0x98:
 	case 0xa0:
+	case 0xa3:
 	case 0xa5:
 	case 0xa8:
 	case 0xaa:
@@ -214,6 +218,8 @@
 	cp_name(ctx, cp_setup_save);
 	cp_set (ctx, UNK1D, SET);
 	cp_wait(ctx, STATUS, BUSY);
+	cp_wait(ctx, INTR, PENDING);
+	cp_bra (ctx, STATUS, BUSY, cp_setup_save);
 	cp_set (ctx, UNK01, SET);
 	cp_set (ctx, SWAP_DIRECTION, SAVE);
 
@@ -269,7 +275,7 @@
 	int offset, base;
 	uint32_t units = nv_rd32 (ctx->dev, 0x1540);
 
-	/* 0800 */
+	/* 0800: DISPATCH */
 	cp_ctx(ctx, 0x400808, 7);
 	gr_def(ctx, 0x400814, 0x00000030);
 	cp_ctx(ctx, 0x400834, 0x32);
@@ -300,7 +306,7 @@
 		gr_def(ctx, 0x400b20, 0x0001629d);
 	}
 
-	/* 0C00 */
+	/* 0C00: VFETCH */
 	cp_ctx(ctx, 0x400c08, 0x2);
 	gr_def(ctx, 0x400c08, 0x0000fe0c);
 
@@ -326,7 +332,7 @@
 	cp_ctx(ctx, 0x401540, 0x5);
 	gr_def(ctx, 0x401550, 0x00001018);
 
-	/* 1800 */
+	/* 1800: STREAMOUT */
 	cp_ctx(ctx, 0x401814, 0x1);
 	gr_def(ctx, 0x401814, 0x000000ff);
 	if (dev_priv->chipset == 0x50) {
@@ -359,6 +365,7 @@
 	case 0xac:
 		gr_def(ctx, 0x401c00, 0x042500df);
 		break;
+	case 0xa3:
 	case 0xa5:
 	case 0xa8:
 		gr_def(ctx, 0x401c00, 0x142500df);
@@ -413,6 +420,7 @@
 		break;
 	case 0x84:
 	case 0xa0:
+	case 0xa3:
 	case 0xa5:
 	case 0xa8:
 	case 0xaa:
@@ -641,7 +649,7 @@
 	if (dev_priv->chipset == 0x50)
 		cp_ctx(ctx, 0x4063e0, 0x1);
 
-	/* 6800 */
+	/* 6800: M2MF */
 	if (dev_priv->chipset < 0x90) {
 		cp_ctx(ctx, 0x406814, 0x2b);
 		gr_def(ctx, 0x406818, 0x00000f80);
@@ -787,6 +795,7 @@
 				case 0xa5:
 					gr_def(ctx, offset + 0x1c, 0x310c0000);
 					break;
+				case 0xa3:
 				case 0xa8:
 				case 0xaa:
 				case 0xac:
@@ -854,6 +863,8 @@
 			else
 				gr_def(ctx, offset + 0x8, 0x05010202);
 			gr_def(ctx, offset + 0xc, 0x00030201);
+			if (dev_priv->chipset == 0xa3)
+				cp_ctx(ctx, base + 0x36c, 1);
 
 			cp_ctx(ctx, base + 0x400, 2);
 			gr_def(ctx, base + 0x404, 0x00000040);
@@ -1154,7 +1165,9 @@
 		nv50_graph_construct_gene_unk8(ctx);
 		if (dev_priv->chipset == 0xa0)
 			xf_emit(ctx, 0x189, 0);
-		else if (dev_priv->chipset < 0xa8)
+		else if (dev_priv->chipset == 0xa3)
+			xf_emit(ctx, 0xd5, 0);
+		else if (dev_priv->chipset == 0xa5)
 			xf_emit(ctx, 0x99, 0);
 		else if (dev_priv->chipset == 0xaa)
 			xf_emit(ctx, 0x65, 0);
@@ -1192,6 +1205,8 @@
 		ctx->ctxvals_pos = offset + 4;
 		if (dev_priv->chipset == 0xa0)
 			xf_emit(ctx, 0xa80, 0);
+		else if (dev_priv->chipset == 0xa3)
+			xf_emit(ctx, 0xa7c, 0);
 		else
 			xf_emit(ctx, 0xa7a, 0);
 		xf_emit(ctx, 1, 0x3fffff);
@@ -1336,6 +1351,7 @@
 		xf_emit(ctx, 0x942, 0);
 		break;
 	case 0xa0:
+	case 0xa3:
 		xf_emit(ctx, 0x2042, 0);
 		break;
 	case 0xa5:
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_instmem.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_instmem.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_instmem.c	2010-04-13 02:18:55.689571417 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_instmem.c	2010-04-13 02:19:00.810633065 +0000
@@ -63,9 +63,10 @@
 	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	struct nouveau_channel *chan;
 	uint32_t c_offset, c_size, c_ramfc, c_vmpd, c_base, pt_size;
+	uint32_t save_nv001700;
+	uint64_t v;
 	struct nv50_instmem_priv *priv;
 	int ret, i;
-	uint32_t v, save_nv001700;
 
 	priv = kzalloc(sizeof(*priv), GFP_KERNEL);
 	if (!priv)
@@ -76,17 +77,12 @@
 	for (i = 0x1700; i <= 0x1710; i += 4)
 		priv->save1700[(i-0x1700)/4] = nv_rd32(dev, i);
 
-	if (dev_priv->chipset == 0xaa || dev_priv->chipset == 0xac)
-		dev_priv->vram_sys_base = nv_rd32(dev, 0x100e10) << 12;
-	else
-		dev_priv->vram_sys_base = 0;
-
 	/* Reserve the last MiB of VRAM, we should probably try to avoid
 	 * setting up the below tables over the top of the VBIOS image at
 	 * some point.
 	 */
 	dev_priv->ramin_rsvd_vram = 1 << 20;
-	c_offset = nouveau_mem_fb_amount(dev) - dev_priv->ramin_rsvd_vram;
+	c_offset = dev_priv->vram_size - dev_priv->ramin_rsvd_vram;
 	c_size   = 128 << 10;
 	c_vmpd   = ((dev_priv->chipset & 0xf0) == 0x50) ? 0x1400 : 0x200;
 	c_ramfc  = ((dev_priv->chipset & 0xf0) == 0x50) ? 0x0 : 0x20;
@@ -106,7 +102,7 @@
 	dev_priv->vm_gart_size = NV50_VM_BLOCK;
 
 	dev_priv->vm_vram_base = dev_priv->vm_gart_base + dev_priv->vm_gart_size;
-	dev_priv->vm_vram_size = nouveau_mem_fb_amount(dev);
+	dev_priv->vm_vram_size = dev_priv->vram_size;
 	if (dev_priv->vm_vram_size > NV50_VM_MAX_VRAM)
 		dev_priv->vm_vram_size = NV50_VM_MAX_VRAM;
 	dev_priv->vm_vram_size = roundup(dev_priv->vm_vram_size, NV50_VM_BLOCK);
@@ -189,8 +185,8 @@
 
 	i = 0;
 	while (v < dev_priv->vram_sys_base + c_offset + c_size) {
-		BAR0_WI32(priv->pramin_pt->gpuobj, i + 0, v);
-		BAR0_WI32(priv->pramin_pt->gpuobj, i + 4, 0x00000000);
+		BAR0_WI32(priv->pramin_pt->gpuobj, i + 0, lower_32_bits(v));
+		BAR0_WI32(priv->pramin_pt->gpuobj, i + 4, upper_32_bits(v));
 		v += 0x1000;
 		i += 8;
 	}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_sor.c linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_sor.c
--- linux-2.6.34-rc3/drivers/gpu/drm/nouveau/nv50_sor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/nouveau/nv50_sor.c	2010-04-13 02:19:00.810633065 +0000
@@ -211,7 +211,7 @@
 			mode_ctl = 0x0200;
 		break;
 	case OUTPUT_DP:
-		mode_ctl |= 0x00050000;
+		mode_ctl |= (nv_encoder->dp.mc_unknown << 16);
 		if (nv_encoder->dcb->sorconf.link & 1)
 			mode_ctl |= 0x00000800;
 		else
@@ -274,6 +274,7 @@
 int
 nv50_sor_create(struct drm_device *dev, struct dcb_entry *entry)
 {
+	struct drm_nouveau_private *dev_priv = dev->dev_private;
 	struct nouveau_encoder *nv_encoder = NULL;
 	struct drm_encoder *encoder;
 	bool dum;
@@ -319,5 +320,27 @@
 	encoder->possible_crtcs = entry->heads;
 	encoder->possible_clones = 0;
 
+	if (nv_encoder->dcb->type == OUTPUT_DP) {
+		uint32_t mc, or = nv_encoder->or;
+
+		if (dev_priv->chipset < 0x90 ||
+		    dev_priv->chipset == 0x92 || dev_priv->chipset == 0xa0)
+			mc = nv_rd32(dev, NV50_PDISPLAY_SOR_MODE_CTRL_C(or));
+		else
+			mc = nv_rd32(dev, NV90_PDISPLAY_SOR_MODE_CTRL_C(or));
+
+		switch ((mc & 0x00000f00) >> 8) {
+		case 8:
+		case 9:
+			nv_encoder->dp.mc_unknown = (mc & 0x000f0000) >> 16;
+			break;
+		default:
+			break;
+		}
+
+		if (!nv_encoder->dp.mc_unknown)
+			nv_encoder->dp.mc_unknown = 5;
+	}
+
 	return 0;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/r128/r128_cce.c linux-2.6.34-rc4/drivers/gpu/drm/r128/r128_cce.c
--- linux-2.6.34-rc3/drivers/gpu/drm/r128/r128_cce.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/r128/r128_cce.c	2010-04-13 02:19:00.810633065 +0000
@@ -31,6 +31,7 @@
 
 #include <linux/firmware.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include "drmP.h"
 #include "drm.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/Makefile linux-2.6.34-rc4/drivers/gpu/drm/radeon/Makefile
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/Makefile	2010-04-13 02:18:55.690570468 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/Makefile	2010-04-13 02:19:00.810633065 +0000
@@ -50,7 +50,7 @@
 radeon-y := radeon_drv.o radeon_cp.o radeon_state.o radeon_mem.o \
 	radeon_irq.o r300_cmdbuf.o r600_cp.o
 # add KMS driver
-radeon-y += radeon_device.o radeon_kms.o \
+radeon-y += radeon_device.o radeon_asic.o radeon_kms.o \
 	radeon_atombios.o radeon_agp.o atombios_crtc.o radeon_combios.o \
 	atom.o radeon_fence.o radeon_ttm.o radeon_object.o radeon_gart.o \
 	radeon_legacy_crtc.o radeon_legacy_encoders.o radeon_connectors.o \
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/atom.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/atom.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/atom.c	2010-04-13 02:18:55.690570468 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/atom.c	2010-04-13 02:19:00.810633065 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #define ATOM_DEBUG
@@ -52,15 +53,17 @@
 
 typedef struct {
 	struct atom_context *ctx;
-
 	uint32_t *ps, *ws;
 	int ps_shift;
 	uint16_t start;
+	unsigned last_jump;
+	unsigned long last_jump_jiffies;
+	bool abort;
 } atom_exec_context;
 
 int atom_debug = 0;
-static void atom_execute_table_locked(struct atom_context *ctx, int index, uint32_t * params);
-void atom_execute_table(struct atom_context *ctx, int index, uint32_t * params);
+static int atom_execute_table_locked(struct atom_context *ctx, int index, uint32_t * params);
+int atom_execute_table(struct atom_context *ctx, int index, uint32_t * params);
 
 static uint32_t atom_arg_mask[8] =
     { 0xFFFFFFFF, 0xFFFF, 0xFFFF00, 0xFFFF0000, 0xFF, 0xFF00, 0xFF0000,
@@ -604,12 +607,17 @@
 static void atom_op_calltable(atom_exec_context *ctx, int *ptr, int arg)
 {
 	int idx = U8((*ptr)++);
+	int r = 0;
+
 	if (idx < ATOM_TABLE_NAMES_CNT)
 		SDEBUG("   table: %d (%s)\n", idx, atom_table_names[idx]);
 	else
 		SDEBUG("   table: %d\n", idx);
 	if (U16(ctx->ctx->cmd_table + 4 + 2 * idx))
-		atom_execute_table_locked(ctx->ctx, idx, ctx->ps + ctx->ps_shift);
+		r = atom_execute_table_locked(ctx->ctx, idx, ctx->ps + ctx->ps_shift);
+	if (r) {
+		ctx->abort = true;
+	}
 }
 
 static void atom_op_clear(atom_exec_context *ctx, int *ptr, int arg)
@@ -673,6 +681,8 @@
 static void atom_op_jump(atom_exec_context *ctx, int *ptr, int arg)
 {
 	int execute = 0, target = U16(*ptr);
+	unsigned long cjiffies;
+
 	(*ptr) += 2;
 	switch (arg) {
 	case ATOM_COND_ABOVE:
@@ -700,8 +710,25 @@
 	if (arg != ATOM_COND_ALWAYS)
 		SDEBUG("   taken: %s\n", execute ? "yes" : "no");
 	SDEBUG("   target: 0x%04X\n", target);
-	if (execute)
+	if (execute) {
+		if (ctx->last_jump == (ctx->start + target)) {
+			cjiffies = jiffies;
+			if (time_after(cjiffies, ctx->last_jump_jiffies)) {
+				cjiffies -= ctx->last_jump_jiffies;
+				if ((jiffies_to_msecs(cjiffies) > 1000)) {
+					DRM_ERROR("atombios stuck in loop for more than 1sec aborting\n");
+					ctx->abort = true;
+				}
+			} else {
+				/* jiffies wrap around we will just wait a little longer */
+				ctx->last_jump_jiffies = jiffies;
+			}
+		} else {
+			ctx->last_jump = ctx->start + target;
+			ctx->last_jump_jiffies = jiffies;
+		}
 		*ptr = ctx->start + target;
+	}
 }
 
 static void atom_op_mask(atom_exec_context *ctx, int *ptr, int arg)
@@ -1104,15 +1131,16 @@
 	atom_op_shr, ATOM_ARG_MC}, {
 atom_op_debug, 0},};
 
-static void atom_execute_table_locked(struct atom_context *ctx, int index, uint32_t * params)
+static int atom_execute_table_locked(struct atom_context *ctx, int index, uint32_t * params)
 {
 	int base = CU16(ctx->cmd_table + 4 + 2 * index);
 	int len, ws, ps, ptr;
 	unsigned char op;
 	atom_exec_context ectx;
+	int ret = 0;
 
 	if (!base)
-		return;
+		return -EINVAL;
 
 	len = CU16(base + ATOM_CT_SIZE_PTR);
 	ws = CU8(base + ATOM_CT_WS_PTR);
@@ -1125,6 +1153,8 @@
 	ectx.ps_shift = ps / 4;
 	ectx.start = base;
 	ectx.ps = params;
+	ectx.abort = false;
+	ectx.last_jump = 0;
 	if (ws)
 		ectx.ws = kzalloc(4 * ws, GFP_KERNEL);
 	else
@@ -1137,6 +1167,12 @@
 			SDEBUG("%s @ 0x%04X\n", atom_op_names[op], ptr - 1);
 		else
 			SDEBUG("[%d] @ 0x%04X\n", op, ptr - 1);
+		if (ectx.abort) {
+			DRM_ERROR("atombios stuck executing %04X (len %d, WS %d, PS %d) @ 0x%04X\n",
+				base, len, ws, ps, ptr - 1);
+			ret = -EINVAL;
+			goto free;
+		}
 
 		if (op < ATOM_OP_CNT && op > 0)
 			opcode_table[op].func(&ectx, &ptr,
@@ -1150,12 +1186,16 @@
 	debug_depth--;
 	SDEBUG("<<\n");
 
+free:
 	if (ws)
 		kfree(ectx.ws);
+	return ret;
 }
 
-void atom_execute_table(struct atom_context *ctx, int index, uint32_t * params)
+int atom_execute_table(struct atom_context *ctx, int index, uint32_t * params)
 {
+	int r;
+
 	mutex_lock(&ctx->mutex);
 	/* reset reg block */
 	ctx->reg_block = 0;
@@ -1163,8 +1203,9 @@
 	ctx->fb_base = 0;
 	/* reset io mode */
 	ctx->io_mode = ATOM_IO_MM;
-	atom_execute_table_locked(ctx, index, params);
+	r = atom_execute_table_locked(ctx, index, params);
 	mutex_unlock(&ctx->mutex);
+	return r;
 }
 
 static int atom_iio_len[] = { 1, 2, 3, 3, 3, 3, 4, 4, 4, 3 };
@@ -1248,9 +1289,7 @@
 
 	if (!CU16(ctx->cmd_table + 4 + 2 * ATOM_CMD_INIT))
 		return 1;
-	atom_execute_table(ctx, ATOM_CMD_INIT, ps);
-
-	return 0;
+	return atom_execute_table(ctx, ATOM_CMD_INIT, ps);
 }
 
 void atom_destroy(struct atom_context *ctx)
@@ -1260,12 +1299,16 @@
 	kfree(ctx);
 }
 
-void atom_parse_data_header(struct atom_context *ctx, int index,
+bool atom_parse_data_header(struct atom_context *ctx, int index,
 			    uint16_t * size, uint8_t * frev, uint8_t * crev,
 			    uint16_t * data_start)
 {
 	int offset = index * 2 + 4;
 	int idx = CU16(ctx->data_table + offset);
+	u16 *mdt = (u16 *)(ctx->bios + ctx->data_table + 4);
+
+	if (!mdt[index])
+		return false;
 
 	if (size)
 		*size = CU16(idx);
@@ -1274,38 +1317,42 @@
 	if (crev)
 		*crev = CU8(idx + 3);
 	*data_start = idx;
-	return;
+	return true;
 }
 
-void atom_parse_cmd_header(struct atom_context *ctx, int index, uint8_t * frev,
+bool atom_parse_cmd_header(struct atom_context *ctx, int index, uint8_t * frev,
 			   uint8_t * crev)
 {
 	int offset = index * 2 + 4;
 	int idx = CU16(ctx->cmd_table + offset);
+	u16 *mct = (u16 *)(ctx->bios + ctx->cmd_table + 4);
+
+	if (!mct[index])
+		return false;
 
 	if (frev)
 		*frev = CU8(idx + 2);
 	if (crev)
 		*crev = CU8(idx + 3);
-	return;
+	return true;
 }
 
 int atom_allocate_fb_scratch(struct atom_context *ctx)
 {
 	int index = GetIndexIntoMasterTable(DATA, VRAM_UsageByFirmware);
 	uint16_t data_offset;
-	int usage_bytes;
+	int usage_bytes = 0;
 	struct _ATOM_VRAM_USAGE_BY_FIRMWARE *firmware_usage;
 
-	atom_parse_data_header(ctx, index, NULL, NULL, NULL, &data_offset);
+	if (atom_parse_data_header(ctx, index, NULL, NULL, NULL, &data_offset)) {
+		firmware_usage = (struct _ATOM_VRAM_USAGE_BY_FIRMWARE *)(ctx->bios + data_offset);
 
-	firmware_usage = (struct _ATOM_VRAM_USAGE_BY_FIRMWARE *)(ctx->bios + data_offset);
+		DRM_DEBUG("atom firmware requested %08x %dkb\n",
+			  firmware_usage->asFirmwareVramReserveInfo[0].ulStartAddrUsedByFirmware,
+			  firmware_usage->asFirmwareVramReserveInfo[0].usFirmwareUseInKb);
 
-	DRM_DEBUG("atom firmware requested %08x %dkb\n",
-		  firmware_usage->asFirmwareVramReserveInfo[0].ulStartAddrUsedByFirmware,
-		  firmware_usage->asFirmwareVramReserveInfo[0].usFirmwareUseInKb);
-
-	usage_bytes = firmware_usage->asFirmwareVramReserveInfo[0].usFirmwareUseInKb * 1024;
+		usage_bytes = firmware_usage->asFirmwareVramReserveInfo[0].usFirmwareUseInKb * 1024;
+	}
 	if (usage_bytes == 0)
 		usage_bytes = 20 * 1024;
 	/* allocate some scratch memory */
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/atom.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/atom.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/atom.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/atom.h	2010-04-13 02:19:00.810633065 +0000
@@ -140,11 +140,13 @@
 extern int atom_debug;
 
 struct atom_context *atom_parse(struct card_info *, void *);
-void atom_execute_table(struct atom_context *, int, uint32_t *);
+int atom_execute_table(struct atom_context *, int, uint32_t *);
 int atom_asic_init(struct atom_context *);
 void atom_destroy(struct atom_context *);
-void atom_parse_data_header(struct atom_context *ctx, int index, uint16_t *size, uint8_t *frev, uint8_t *crev, uint16_t *data_start);
-void atom_parse_cmd_header(struct atom_context *ctx, int index, uint8_t *frev, uint8_t *crev);
+bool atom_parse_data_header(struct atom_context *ctx, int index, uint16_t *size,
+			    uint8_t *frev, uint8_t *crev, uint16_t *data_start);
+bool atom_parse_cmd_header(struct atom_context *ctx, int index,
+			   uint8_t *frev, uint8_t *crev);
 int atom_allocate_fb_scratch(struct atom_context *ctx);
 #include "atom-types.h"
 #include "atombios.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/atombios_crtc.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/atombios_crtc.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/atombios_crtc.c	2010-04-13 02:18:55.697633070 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/atombios_crtc.c	2010-04-13 02:19:00.818570559 +0000
@@ -353,12 +353,55 @@
 	atom_execute_table(rdev->mode_info.atom_context, index, (uint32_t *)&args);
 }
 
+static void atombios_disable_ss(struct drm_crtc *crtc)
+{
+	struct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);
+	struct drm_device *dev = crtc->dev;
+	struct radeon_device *rdev = dev->dev_private;
+	u32 ss_cntl;
+
+	if (ASIC_IS_DCE4(rdev)) {
+		switch (radeon_crtc->pll_id) {
+		case ATOM_PPLL1:
+			ss_cntl = RREG32(EVERGREEN_P1PLL_SS_CNTL);
+			ss_cntl &= ~EVERGREEN_PxPLL_SS_EN;
+			WREG32(EVERGREEN_P1PLL_SS_CNTL, ss_cntl);
+			break;
+		case ATOM_PPLL2:
+			ss_cntl = RREG32(EVERGREEN_P2PLL_SS_CNTL);
+			ss_cntl &= ~EVERGREEN_PxPLL_SS_EN;
+			WREG32(EVERGREEN_P2PLL_SS_CNTL, ss_cntl);
+			break;
+		case ATOM_DCPLL:
+		case ATOM_PPLL_INVALID:
+			return;
+		}
+	} else if (ASIC_IS_AVIVO(rdev)) {
+		switch (radeon_crtc->pll_id) {
+		case ATOM_PPLL1:
+			ss_cntl = RREG32(AVIVO_P1PLL_INT_SS_CNTL);
+			ss_cntl &= ~1;
+			WREG32(AVIVO_P1PLL_INT_SS_CNTL, ss_cntl);
+			break;
+		case ATOM_PPLL2:
+			ss_cntl = RREG32(AVIVO_P2PLL_INT_SS_CNTL);
+			ss_cntl &= ~1;
+			WREG32(AVIVO_P2PLL_INT_SS_CNTL, ss_cntl);
+			break;
+		case ATOM_DCPLL:
+		case ATOM_PPLL_INVALID:
+			return;
+		}
+	}
+}
+
+
 union atom_enable_ss {
 	ENABLE_LVDS_SS_PARAMETERS legacy;
 	ENABLE_SPREAD_SPECTRUM_ON_PPLL_PS_ALLOCATION v1;
 };
 
-static void atombios_set_ss(struct drm_crtc *crtc, int enable)
+static void atombios_enable_ss(struct drm_crtc *crtc)
 {
 	struct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);
 	struct drm_device *dev = crtc->dev;
@@ -387,9 +430,9 @@
 					step = dig->ss->step;
 					delay = dig->ss->delay;
 					range = dig->ss->range;
-				} else if (enable)
+				} else
 					return;
-			} else if (enable)
+			} else
 				return;
 			break;
 		}
@@ -406,13 +449,13 @@
 		args.v1.ucSpreadSpectrumDelay = delay;
 		args.v1.ucSpreadSpectrumRange = range;
 		args.v1.ucPpll = radeon_crtc->crtc_id ? ATOM_PPLL2 : ATOM_PPLL1;
-		args.v1.ucEnable = enable;
+		args.v1.ucEnable = ATOM_ENABLE;
 	} else {
 		args.legacy.usSpreadSpectrumPercentage = cpu_to_le16(percentage);
 		args.legacy.ucSpreadSpectrumType = type;
 		args.legacy.ucSpreadSpectrumStepSize_Delay = (step & 3) << 2;
 		args.legacy.ucSpreadSpectrumStepSize_Delay |= (delay & 7) << 4;
-		args.legacy.ucEnable = enable;
+		args.legacy.ucEnable = ATOM_ENABLE;
 	}
 	atom_execute_table(rdev->mode_info.atom_context, index, (uint32_t *)&args);
 }
@@ -478,11 +521,6 @@
 				/* DVO wants 2x pixel clock if the DVO chip is in 12 bit mode */
 				if (radeon_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1)
 					adjusted_clock = mode->clock * 2;
-				/* LVDS PLL quirks */
-				if (encoder->encoder_type == DRM_MODE_ENCODER_LVDS) {
-					struct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;
-					pll->algo = dig->pll_algo;
-				}
 			} else {
 				if (encoder->encoder_type != DRM_MODE_ENCODER_DAC)
 					pll->flags |= RADEON_PLL_NO_ODD_POST_DIV;
@@ -503,8 +541,9 @@
 		int index;
 
 		index = GetIndexIntoMasterTable(COMMAND, AdjustDisplayPll);
-		atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
-				      &crev);
+		if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
+					   &crev))
+			return adjusted_clock;
 
 		memset(&args, 0, sizeof(args));
 
@@ -542,11 +581,16 @@
 					}
 				} else if (radeon_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {
 					/* may want to enable SS on DP/eDP eventually */
-					args.v3.sInput.ucDispPllConfig |=
-						DISPPLL_CONFIG_SS_ENABLE;
-					if (mode->clock > 165000)
+					/*args.v3.sInput.ucDispPllConfig |=
+						DISPPLL_CONFIG_SS_ENABLE;*/
+					if (encoder_mode == ATOM_ENCODER_MODE_DP)
 						args.v3.sInput.ucDispPllConfig |=
-							DISPPLL_CONFIG_DUAL_LINK;
+							DISPPLL_CONFIG_COHERENT_MODE;
+					else {
+						if (mode->clock > 165000)
+							args.v3.sInput.ucDispPllConfig |=
+								DISPPLL_CONFIG_DUAL_LINK;
+					}
 				}
 				atom_execute_table(rdev->mode_info.atom_context,
 						   index, (uint32_t *)&args);
@@ -592,8 +636,9 @@
 	memset(&args, 0, sizeof(args));
 
 	index = GetIndexIntoMasterTable(COMMAND, SetPixelClock);
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
-			      &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
+				   &crev))
+		return;
 
 	switch (frev) {
 	case 1:
@@ -667,8 +712,9 @@
 			   &ref_div, &post_div);
 
 	index = GetIndexIntoMasterTable(COMMAND, SetPixelClock);
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
-			      &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev,
+				   &crev))
+		return;
 
 	switch (frev) {
 	case 1:
@@ -1083,15 +1129,12 @@
 
 	/* TODO color tiling */
 
-	/* pick pll */
-	radeon_crtc->pll_id = radeon_atom_pick_pll(crtc);
-
-	atombios_set_ss(crtc, 0);
+	atombios_disable_ss(crtc);
 	/* always set DCPLL */
 	if (ASIC_IS_DCE4(rdev))
 		atombios_crtc_set_dcpll(crtc);
 	atombios_crtc_set_pll(crtc, adjusted_mode);
-	atombios_set_ss(crtc, 1);
+	atombios_enable_ss(crtc);
 
 	if (ASIC_IS_DCE4(rdev))
 		atombios_set_crtc_dtd_timing(crtc, adjusted_mode);
@@ -1120,6 +1163,11 @@
 
 static void atombios_crtc_prepare(struct drm_crtc *crtc)
 {
+	struct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);
+
+	/* pick pll */
+	radeon_crtc->pll_id = radeon_atom_pick_pll(crtc);
+
 	atombios_lock_crtc(crtc, ATOM_ENABLE);
 	atombios_crtc_dpms(crtc, DRM_MODE_DPMS_OFF);
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/atombios_dp.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/atombios_dp.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/atombios_dp.c	2010-04-13 02:18:55.697633070 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/atombios_dp.c	2010-04-13 02:19:00.818570559 +0000
@@ -745,14 +745,14 @@
 			  >> DP_TRAIN_PRE_EMPHASIS_SHIFT);
 
 	/* disable the training pattern on the sink */
+	dp_set_training(radeon_connector, DP_TRAINING_PATTERN_DISABLE);
+
+	/* disable the training pattern on the source */
 	if (ASIC_IS_DCE4(rdev))
 		atombios_dig_encoder_setup(encoder, ATOM_ENCODER_CMD_DP_LINK_TRAINING_COMPLETE);
 	else
 		radeon_dp_encoder_service(rdev, ATOM_DP_ACTION_TRAINING_COMPLETE,
 					  dig_connector->dp_clock, enc_id, 0);
-
-	radeon_dp_encoder_service(rdev, ATOM_DP_ACTION_TRAINING_COMPLETE,
-				  dig_connector->dp_clock, enc_id, 0);
 }
 
 int radeon_dp_i2c_aux_ch(struct i2c_adapter *adapter, int mode,
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/evergreen.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/evergreen.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/evergreen.c	2010-04-13 02:18:55.698633063 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/evergreen.c	2010-04-13 02:19:00.818570559 +0000
@@ -23,8 +23,10 @@
  */
 #include <linux/firmware.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "radeon_drm.h"
 #include "rv770d.h"
 #include "atom.h"
@@ -436,7 +438,6 @@
 
 int evergreen_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 	u32 tmp;
 	int chansize, numchan;
 
@@ -481,12 +482,8 @@
 		rdev->mc.real_vram_size = rdev->mc.aper_size;
 	}
 	r600_vram_gtt_location(rdev, &rdev->mc);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+	radeon_update_bandwidth_info(rdev);
+
 	return 0;
 }
 
@@ -746,6 +743,7 @@
 
 void evergreen_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	evergreen_suspend(rdev);
 #if 0
 	r600_blit_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r100.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r100.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r100.c	2010-04-13 02:18:55.699571500 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r100.c	2010-04-13 02:19:00.819570363 +0000
@@ -26,11 +26,13 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "radeon_drm.h"
 #include "radeon_reg.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "r100d.h"
 #include "rs100d.h"
 #include "rv200d.h"
@@ -235,9 +237,9 @@
 
 void r100_pci_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	r100_pci_gart_disable(rdev);
 	radeon_gart_table_ram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 int r100_irq_set(struct radeon_device *rdev)
@@ -312,10 +314,12 @@
 		/* Vertical blank interrupts */
 		if (status & RADEON_CRTC_VBLANK_STAT) {
 			drm_handle_vblank(rdev->ddev, 0);
+			rdev->pm.vblank_sync = true;
 			wake_up(&rdev->irq.vblank_queue);
 		}
 		if (status & RADEON_CRTC2_VBLANK_STAT) {
 			drm_handle_vblank(rdev->ddev, 1);
+			rdev->pm.vblank_sync = true;
 			wake_up(&rdev->irq.vblank_queue);
 		}
 		if (status & RADEON_FP_DETECT_STAT) {
@@ -741,6 +745,8 @@
 	udelay(10);
 	rdev->cp.rptr = RREG32(RADEON_CP_RB_RPTR);
 	rdev->cp.wptr = RREG32(RADEON_CP_RB_WPTR);
+	/* protect against crazy HW on resume */
+	rdev->cp.wptr &= rdev->cp.ptr_mask;
 	/* Set cp mode to bus mastering & enable cp*/
 	WREG32(RADEON_CP_CSQ_MODE,
 	       REG_SET(RADEON_INDIRECT2_START, indirect2_start) |
@@ -1804,6 +1810,7 @@
 {
 	struct drm_device *dev = rdev->ddev;
 	bool force_dac2 = false;
+	u32 tmp;
 
 	/* set these so they don't interfere with anything */
 	WREG32(RADEON_OV0_SCALE_CNTL, 0);
@@ -1875,6 +1882,12 @@
 		WREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);
 		WREG32(RADEON_DAC_CNTL2, dac2_cntl);
 	}
+
+	/* switch PM block to ACPI mode */
+	tmp = RREG32_PLL(RADEON_PLL_PWRMGT_CNTL);
+	tmp &= ~RADEON_PM_MODE_SEL;
+	WREG32_PLL(RADEON_PLL_PWRMGT_CNTL, tmp);
+
 }
 
 /*
@@ -2022,6 +2035,7 @@
 	radeon_vram_location(rdev, &rdev->mc, base);
 	if (!(rdev->flags & RADEON_IS_AGP))
 		radeon_gtt_location(rdev, &rdev->mc);
+	radeon_update_bandwidth_info(rdev);
 }
 
 
@@ -2385,6 +2399,8 @@
 	uint32_t pixel_bytes1 = 0;
 	uint32_t pixel_bytes2 = 0;
 
+	radeon_update_display_priority(rdev);
+
 	if (rdev->mode_info.crtcs[0]->base.enabled) {
 		mode1 = &rdev->mode_info.crtcs[0]->base.mode;
 		pixel_bytes1 = rdev->mode_info.crtcs[0]->base.fb->bits_per_pixel / 8;
@@ -2413,11 +2429,8 @@
 	/*
 	 * determine is there is enough bw for current mode
 	 */
-	mclk_ff.full = rfixed_const(rdev->clock.default_mclk);
-	temp_ff.full = rfixed_const(100);
-	mclk_ff.full = rfixed_div(mclk_ff, temp_ff);
-	sclk_ff.full = rfixed_const(rdev->clock.default_sclk);
-	sclk_ff.full = rfixed_div(sclk_ff, temp_ff);
+	sclk_ff = rdev->pm.sclk;
+	mclk_ff = rdev->pm.mclk;
 
 	temp = (rdev->mc.vram_width / 8) * (rdev->mc.vram_is_ddr ? 2 : 1);
 	temp_ff.full = rfixed_const(temp);
@@ -3440,6 +3453,7 @@
 
 void r100_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r200.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r200.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r200.c	2010-04-13 02:18:55.699571500 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r200.c	2010-04-13 02:19:00.819570363 +0000
@@ -30,6 +30,7 @@
 #include "radeon_drm.h"
 #include "radeon_reg.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 
 #include "r100d.h"
 #include "r200_reg_safe.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r300.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r300.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r300.c	2010-04-13 02:18:55.699571500 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r300.c	2010-04-13 02:19:00.820633073 +0000
@@ -26,10 +26,12 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "radeon_reg.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "radeon_drm.h"
 #include "r100_track.h"
 #include "r300d.h"
@@ -164,9 +166,9 @@
 
 void rv370_pcie_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	rv370_pcie_gart_disable(rdev);
 	radeon_gart_table_vram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 void r300_fence_ring_emit(struct radeon_device *rdev,
@@ -323,11 +325,12 @@
 
 	r100_hdp_reset(rdev);
 	/* FIXME: rv380 one pipes ? */
-	if ((rdev->family == CHIP_R300) || (rdev->family == CHIP_R350)) {
+	if ((rdev->family == CHIP_R300 && rdev->pdev->device != 0x4144) ||
+	    (rdev->family == CHIP_R350)) {
 		/* r300,r350 */
 		rdev->num_gb_pipes = 2;
 	} else {
-		/* rv350,rv370,rv380 */
+		/* rv350,rv370,rv380,r300 AD */
 		rdev->num_gb_pipes = 1;
 	}
 	rdev->num_z_pipes = 1;
@@ -481,6 +484,7 @@
 	radeon_vram_location(rdev, &rdev->mc, base);
 	if (!(rdev->flags & RADEON_IS_AGP))
 		radeon_gtt_location(rdev, &rdev->mc);
+	radeon_update_bandwidth_info(rdev);
 }
 
 void rv370_set_pcie_lanes(struct radeon_device *rdev, int lanes)
@@ -1334,6 +1338,7 @@
 
 void r300_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r420.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r420.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r420.c	2010-04-13 02:18:55.700570470 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r420.c	2010-04-13 02:19:00.821633132 +0000
@@ -26,9 +26,11 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "radeon_reg.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "atom.h"
 #include "r100d.h"
 #include "r420d.h"
@@ -266,6 +268,7 @@
 
 void r420_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r520.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r520.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r520.c	2010-04-13 02:18:55.701570259 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r520.c	2010-04-13 02:19:00.821633132 +0000
@@ -27,6 +27,7 @@
  */
 #include "drmP.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "atom.h"
 #include "r520d.h"
 
@@ -121,19 +122,13 @@
 
 void r520_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 
 	r520_vram_get_type(rdev);
 	r100_vram_init_sizes(rdev);
 	radeon_vram_location(rdev, &rdev->mc, 0);
 	if (!(rdev->flags & RADEON_IS_AGP))
 		radeon_gtt_location(rdev, &rdev->mc);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+	radeon_update_bandwidth_info(rdev);
 }
 
 void r520_mc_program(struct radeon_device *rdev)
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600.c	2010-04-13 02:18:55.701570259 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600.c	2010-04-13 02:19:00.822633056 +0000
@@ -25,12 +25,14 @@
  *          Alex Deucher
  *          Jerome Glisse
  */
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/firmware.h>
 #include <linux/platform_device.h>
 #include "drmP.h"
 #include "radeon_drm.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "radeon_mode.h"
 #include "r600d.h"
 #include "atom.h"
@@ -491,9 +493,9 @@
 
 void r600_pcie_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	r600_pcie_gart_disable(rdev);
 	radeon_gart_table_vram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 void r600_agp_enable(struct radeon_device *rdev)
@@ -675,7 +677,6 @@
 
 int r600_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 	u32 tmp;
 	int chansize, numchan;
 
@@ -719,14 +720,10 @@
 		rdev->mc.real_vram_size = rdev->mc.aper_size;
 	}
 	r600_vram_gtt_location(rdev, &rdev->mc);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+
 	if (rdev->flags & RADEON_IS_IGP)
 		rdev->mc.igp_sideport_enabled = radeon_atombios_sideport_present(rdev);
+	radeon_update_bandwidth_info(rdev);
 	return 0;
 }
 
@@ -1132,6 +1129,7 @@
 	/* Setup pipes */
 	WREG32(CC_RB_BACKEND_DISABLE, cc_rb_backend_disable);
 	WREG32(CC_GC_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);
+	WREG32(GC_USER_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);
 
 	tmp = R6XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & INACTIVE_QD_PIPES_MASK) >> 8);
 	WREG32(VGT_OUT_DEALLOC_CNTL, (tmp * 4) & DEALLOC_DIST_MASK);
@@ -2119,6 +2117,7 @@
 
 void r600_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r600_audio_fini(rdev);
 	r600_blit_fini(rdev);
 	r600_cp_fini(rdev);
@@ -2398,19 +2397,19 @@
 		WREG32(DC_HPD4_INT_CONTROL, tmp);
 		if (ASIC_IS_DCE32(rdev)) {
 			tmp = RREG32(DC_HPD5_INT_CONTROL) & DC_HPDx_INT_POLARITY;
-			WREG32(DC_HPD5_INT_CONTROL, 0);
+			WREG32(DC_HPD5_INT_CONTROL, tmp);
 			tmp = RREG32(DC_HPD6_INT_CONTROL) & DC_HPDx_INT_POLARITY;
-			WREG32(DC_HPD6_INT_CONTROL, 0);
+			WREG32(DC_HPD6_INT_CONTROL, tmp);
 		}
 	} else {
 		WREG32(DACA_AUTODETECT_INT_CONTROL, 0);
 		WREG32(DACB_AUTODETECT_INT_CONTROL, 0);
 		tmp = RREG32(DC_HOT_PLUG_DETECT1_INT_CONTROL) & DC_HOT_PLUG_DETECTx_INT_POLARITY;
-		WREG32(DC_HOT_PLUG_DETECT1_INT_CONTROL, 0);
+		WREG32(DC_HOT_PLUG_DETECT1_INT_CONTROL, tmp);
 		tmp = RREG32(DC_HOT_PLUG_DETECT2_INT_CONTROL) & DC_HOT_PLUG_DETECTx_INT_POLARITY;
-		WREG32(DC_HOT_PLUG_DETECT2_INT_CONTROL, 0);
+		WREG32(DC_HOT_PLUG_DETECT2_INT_CONTROL, tmp);
 		tmp = RREG32(DC_HOT_PLUG_DETECT3_INT_CONTROL) & DC_HOT_PLUG_DETECTx_INT_POLARITY;
-		WREG32(DC_HOT_PLUG_DETECT3_INT_CONTROL, 0);
+		WREG32(DC_HOT_PLUG_DETECT3_INT_CONTROL, tmp);
 	}
 }
 
@@ -2765,6 +2764,7 @@
 			case 0: /* D1 vblank */
 				if (disp_int & LB_D1_VBLANK_INTERRUPT) {
 					drm_handle_vblank(rdev->ddev, 0);
+					rdev->pm.vblank_sync = true;
 					wake_up(&rdev->irq.vblank_queue);
 					disp_int &= ~LB_D1_VBLANK_INTERRUPT;
 					DRM_DEBUG("IH: D1 vblank\n");
@@ -2786,6 +2786,7 @@
 			case 0: /* D2 vblank */
 				if (disp_int & LB_D2_VBLANK_INTERRUPT) {
 					drm_handle_vblank(rdev->ddev, 1);
+					rdev->pm.vblank_sync = true;
 					wake_up(&rdev->irq.vblank_queue);
 					disp_int &= ~LB_D2_VBLANK_INTERRUPT;
 					DRM_DEBUG("IH: D2 vblank\n");
@@ -2834,14 +2835,14 @@
 				break;
 			case 10:
 				if (disp_int_cont2 & DC_HPD5_INTERRUPT) {
-					disp_int_cont &= ~DC_HPD5_INTERRUPT;
+					disp_int_cont2 &= ~DC_HPD5_INTERRUPT;
 					queue_hotplug = true;
 					DRM_DEBUG("IH: HPD5\n");
 				}
 				break;
 			case 12:
 				if (disp_int_cont2 & DC_HPD6_INTERRUPT) {
-					disp_int_cont &= ~DC_HPD6_INTERRUPT;
+					disp_int_cont2 &= ~DC_HPD6_INTERRUPT;
 					queue_hotplug = true;
 					DRM_DEBUG("IH: HPD6\n");
 				}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_audio.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_audio.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_audio.c	2010-04-13 02:18:55.701570259 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_audio.c	2010-04-13 02:19:00.822633056 +0000
@@ -182,41 +182,6 @@
 }
 
 /*
- * determin how the encoders and audio interface is wired together
- */
-int r600_audio_tmds_index(struct drm_encoder *encoder)
-{
-	struct drm_device *dev = encoder->dev;
-	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
-	struct drm_encoder *other;
-
-	switch (radeon_encoder->encoder_id) {
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
-		return 0;
-
-	case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
-		/* special case check if an TMDS1 is present */
-		list_for_each_entry(other, &dev->mode_config.encoder_list, head) {
-			if (to_radeon_encoder(other)->encoder_id ==
-				ENCODER_OBJECT_ID_INTERNAL_TMDS1)
-				return 1;
-		}
-		return 0;
-
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:
-		return 1;
-
-	default:
-		DRM_ERROR("Unsupported encoder type 0x%02X\n",
-			  radeon_encoder->encoder_id);
-		return -1;
-	}
-}
-
-/*
  * atach the audio codec to the clock source of the encoder
  */
 void r600_audio_set_clock(struct drm_encoder *encoder, int clock)
@@ -224,6 +189,7 @@
 	struct drm_device *dev = encoder->dev;
 	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
+	struct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;
 	int base_rate = 48000;
 
 	switch (radeon_encoder->encoder_id) {
@@ -231,32 +197,34 @@
 	case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
 		WREG32_P(R600_AUDIO_TIMING, 0, ~0x301);
 		break;
-
 	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
 	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
 	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
 	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:
 		WREG32_P(R600_AUDIO_TIMING, 0x100, ~0x301);
 		break;
-
 	default:
 		DRM_ERROR("Unsupported encoder type 0x%02X\n",
 			  radeon_encoder->encoder_id);
 		return;
 	}
 
-	switch (r600_audio_tmds_index(encoder)) {
+	switch (dig->dig_encoder) {
 	case 0:
-		WREG32(R600_AUDIO_PLL1_MUL, base_rate*50);
-		WREG32(R600_AUDIO_PLL1_DIV, clock*100);
+		WREG32(R600_AUDIO_PLL1_MUL, base_rate * 50);
+		WREG32(R600_AUDIO_PLL1_DIV, clock * 100);
 		WREG32(R600_AUDIO_CLK_SRCSEL, 0);
 		break;
 
 	case 1:
-		WREG32(R600_AUDIO_PLL2_MUL, base_rate*50);
-		WREG32(R600_AUDIO_PLL2_DIV, clock*100);
+		WREG32(R600_AUDIO_PLL2_MUL, base_rate * 50);
+		WREG32(R600_AUDIO_PLL2_DIV, clock * 100);
 		WREG32(R600_AUDIO_CLK_SRCSEL, 1);
 		break;
+	default:
+		dev_err(rdev->dev, "Unsupported DIG on encoder 0x%02X\n",
+			  radeon_encoder->encoder_id);
+		return;
 	}
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_blit_shaders.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_blit_shaders.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_blit_shaders.c	2010-04-13 02:18:55.702633206 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_blit_shaders.c	2010-04-13 02:19:00.822633056 +0000
@@ -1,7 +1,42 @@
+/*
+ * Copyright 2009 Advanced Micro Devices, Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice (including the next
+ * paragraph) shall be included in all copies or substantial portions of the
+ * Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+ * DEALINGS IN THE SOFTWARE.
+ *
+ * Authors:
+ *     Alex Deucher <alexander.deucher@amd.com>
+ */
 
 #include <linux/types.h>
 #include <linux/kernel.h>
 
+/*
+ * R6xx+ cards need to use the 3D engine to blit data which requires
+ * quite a bit of hw state setup.  Rather than pull the whole 3D driver
+ * (which normally generates the 3D state) into the DRM, we opt to use
+ * statically generated state tables.  The regsiter state and shaders
+ * were hand generated to support blitting functionality.  See the 3D
+ * driver or documentation for descriptions of the registers and
+ * shader instructions.
+ */
+
 const u32 r6xx_default_state[] =
 {
 	0xc0002400,
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_cp.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_cp.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_cp.c	2010-04-13 02:18:55.702633206 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_cp.c	2010-04-13 02:19:00.823632986 +0000
@@ -1548,10 +1548,13 @@
 
 	RADEON_WRITE(R600_CC_RB_BACKEND_DISABLE,      cc_rb_backend_disable);
 	RADEON_WRITE(R600_CC_GC_SHADER_PIPE_CONFIG,   cc_gc_shader_pipe_config);
+	RADEON_WRITE(R600_GC_USER_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);
 
 	RADEON_WRITE(R700_CC_SYS_RB_BACKEND_DISABLE, cc_rb_backend_disable);
 	RADEON_WRITE(R700_CGTS_SYS_TCC_DISABLE, 0);
 	RADEON_WRITE(R700_CGTS_TCC_DISABLE, 0);
+	RADEON_WRITE(R700_CGTS_USER_SYS_TCC_DISABLE, 0);
+	RADEON_WRITE(R700_CGTS_USER_TCC_DISABLE, 0);
 
 	num_qd_pipes =
 		R7XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & R600_INACTIVE_QD_PIPES_MASK) >> 8);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_cs.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_cs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_cs.c	2010-04-13 02:18:55.703633067 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_cs.c	2010-04-13 02:19:00.824633048 +0000
@@ -45,6 +45,7 @@
 	u32			nbanks;
 	u32			npipes;
 	/* value we track */
+	u32			sq_config;
 	u32			nsamples;
 	u32			cb_color_base_last[8];
 	struct radeon_bo	*cb_color_bo[8];
@@ -141,6 +142,8 @@
 {
 	int i;
 
+	/* assume DX9 mode */
+	track->sq_config = DX9_CONSTS;
 	for (i = 0; i < 8; i++) {
 		track->cb_color_base_last[i] = 0;
 		track->cb_color_size[i] = 0;
@@ -715,6 +718,9 @@
 		tmp =radeon_get_ib_value(p, idx);
 		ib[idx] = 0;
 		break;
+	case SQ_CONFIG:
+		track->sq_config = radeon_get_ib_value(p, idx);
+		break;
 	case R_028800_DB_DEPTH_CONTROL:
 		track->db_depth_control = radeon_get_ib_value(p, idx);
 		break;
@@ -869,6 +875,54 @@
 	case SQ_PGM_START_VS:
 	case SQ_PGM_START_GS:
 	case SQ_PGM_START_PS:
+	case SQ_ALU_CONST_CACHE_GS_0:
+	case SQ_ALU_CONST_CACHE_GS_1:
+	case SQ_ALU_CONST_CACHE_GS_2:
+	case SQ_ALU_CONST_CACHE_GS_3:
+	case SQ_ALU_CONST_CACHE_GS_4:
+	case SQ_ALU_CONST_CACHE_GS_5:
+	case SQ_ALU_CONST_CACHE_GS_6:
+	case SQ_ALU_CONST_CACHE_GS_7:
+	case SQ_ALU_CONST_CACHE_GS_8:
+	case SQ_ALU_CONST_CACHE_GS_9:
+	case SQ_ALU_CONST_CACHE_GS_10:
+	case SQ_ALU_CONST_CACHE_GS_11:
+	case SQ_ALU_CONST_CACHE_GS_12:
+	case SQ_ALU_CONST_CACHE_GS_13:
+	case SQ_ALU_CONST_CACHE_GS_14:
+	case SQ_ALU_CONST_CACHE_GS_15:
+	case SQ_ALU_CONST_CACHE_PS_0:
+	case SQ_ALU_CONST_CACHE_PS_1:
+	case SQ_ALU_CONST_CACHE_PS_2:
+	case SQ_ALU_CONST_CACHE_PS_3:
+	case SQ_ALU_CONST_CACHE_PS_4:
+	case SQ_ALU_CONST_CACHE_PS_5:
+	case SQ_ALU_CONST_CACHE_PS_6:
+	case SQ_ALU_CONST_CACHE_PS_7:
+	case SQ_ALU_CONST_CACHE_PS_8:
+	case SQ_ALU_CONST_CACHE_PS_9:
+	case SQ_ALU_CONST_CACHE_PS_10:
+	case SQ_ALU_CONST_CACHE_PS_11:
+	case SQ_ALU_CONST_CACHE_PS_12:
+	case SQ_ALU_CONST_CACHE_PS_13:
+	case SQ_ALU_CONST_CACHE_PS_14:
+	case SQ_ALU_CONST_CACHE_PS_15:
+	case SQ_ALU_CONST_CACHE_VS_0:
+	case SQ_ALU_CONST_CACHE_VS_1:
+	case SQ_ALU_CONST_CACHE_VS_2:
+	case SQ_ALU_CONST_CACHE_VS_3:
+	case SQ_ALU_CONST_CACHE_VS_4:
+	case SQ_ALU_CONST_CACHE_VS_5:
+	case SQ_ALU_CONST_CACHE_VS_6:
+	case SQ_ALU_CONST_CACHE_VS_7:
+	case SQ_ALU_CONST_CACHE_VS_8:
+	case SQ_ALU_CONST_CACHE_VS_9:
+	case SQ_ALU_CONST_CACHE_VS_10:
+	case SQ_ALU_CONST_CACHE_VS_11:
+	case SQ_ALU_CONST_CACHE_VS_12:
+	case SQ_ALU_CONST_CACHE_VS_13:
+	case SQ_ALU_CONST_CACHE_VS_14:
+	case SQ_ALU_CONST_CACHE_VS_15:
 		r = r600_cs_packet_next_reloc(p, &reloc);
 		if (r) {
 			dev_warn(p->dev, "bad SET_CONTEXT_REG "
@@ -1226,13 +1280,15 @@
 		}
 		break;
 	case PACKET3_SET_ALU_CONST:
-		start_reg = (idx_value << 2) + PACKET3_SET_ALU_CONST_OFFSET;
-		end_reg = 4 * pkt->count + start_reg - 4;
-		if ((start_reg < PACKET3_SET_ALU_CONST_OFFSET) ||
-		    (start_reg >= PACKET3_SET_ALU_CONST_END) ||
-		    (end_reg >= PACKET3_SET_ALU_CONST_END)) {
-			DRM_ERROR("bad SET_ALU_CONST\n");
-			return -EINVAL;
+		if (track->sq_config & DX9_CONSTS) {
+			start_reg = (idx_value << 2) + PACKET3_SET_ALU_CONST_OFFSET;
+			end_reg = 4 * pkt->count + start_reg - 4;
+			if ((start_reg < PACKET3_SET_ALU_CONST_OFFSET) ||
+			    (start_reg >= PACKET3_SET_ALU_CONST_END) ||
+			    (end_reg >= PACKET3_SET_ALU_CONST_END)) {
+				DRM_ERROR("bad SET_ALU_CONST\n");
+				return -EINVAL;
+			}
 		}
 		break;
 	case PACKET3_SET_BOOL_CONST:
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_hdmi.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_hdmi.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_hdmi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_hdmi.c	2010-04-13 02:19:00.824633048 +0000
@@ -42,13 +42,13 @@
  */
 enum r600_hdmi_iec_status_bits {
 	AUDIO_STATUS_DIG_ENABLE   = 0x01,
-	AUDIO_STATUS_V	    = 0x02,
-	AUDIO_STATUS_VCFG	 = 0x04,
+	AUDIO_STATUS_V            = 0x02,
+	AUDIO_STATUS_VCFG         = 0x04,
 	AUDIO_STATUS_EMPHASIS     = 0x08,
 	AUDIO_STATUS_COPYRIGHT    = 0x10,
 	AUDIO_STATUS_NONAUDIO     = 0x20,
 	AUDIO_STATUS_PROFESSIONAL = 0x40,
-	AUDIO_STATUS_LEVEL	= 0x80
+	AUDIO_STATUS_LEVEL        = 0x80
 };
 
 struct {
@@ -85,7 +85,7 @@
 static void r600_hdmi_calc_CTS(uint32_t clock, int *CTS, int N, int freq)
 {
 	if (*CTS == 0)
-		*CTS = clock*N/(128*freq)*1000;
+		*CTS = clock * N / (128 * freq) * 1000;
 	DRM_DEBUG("Using ACR timing N=%d CTS=%d for frequency %d\n",
 		  N, *CTS, freq);
 }
@@ -131,11 +131,11 @@
 					 uint8_t length,
 					 uint8_t *frame)
 {
-    int i;
-    frame[0] = packetType + versionNumber + length;
-    for (i = 1; i <= length; i++)
-	frame[0] += frame[i];
-    frame[0] = 0x100 - frame[0];
+	int i;
+	frame[0] = packetType + versionNumber + length;
+	for (i = 1; i <= length; i++)
+		frame[0] += frame[i];
+	frame[0] = 0x100 - frame[0];
 }
 
 /*
@@ -417,90 +417,141 @@
 	WREG32_P(offset+R600_HDMI_CNTL, 0x04000000, ~0x04000000);
 }
 
-/*
- * enable/disable the HDMI engine
- */
-void r600_hdmi_enable(struct drm_encoder *encoder, int enable)
+static int r600_hdmi_find_free_block(struct drm_device *dev)
+{
+	struct radeon_device *rdev = dev->dev_private;
+	struct drm_encoder *encoder;
+	struct radeon_encoder *radeon_encoder;
+	bool free_blocks[3] = { true, true, true };
+
+	list_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {
+		radeon_encoder = to_radeon_encoder(encoder);
+		switch (radeon_encoder->hdmi_offset) {
+		case R600_HDMI_BLOCK1:
+			free_blocks[0] = false;
+			break;
+		case R600_HDMI_BLOCK2:
+			free_blocks[1] = false;
+			break;
+		case R600_HDMI_BLOCK3:
+			free_blocks[2] = false;
+			break;
+		}
+	}
+
+	if (rdev->family == CHIP_RS600 || rdev->family == CHIP_RS690) {
+		return free_blocks[0] ? R600_HDMI_BLOCK1 : 0;
+	} else if (rdev->family >= CHIP_R600) {
+		if (free_blocks[0])
+			return R600_HDMI_BLOCK1;
+		else if (free_blocks[1])
+			return R600_HDMI_BLOCK2;
+	}
+	return 0;
+}
+
+static void r600_hdmi_assign_block(struct drm_encoder *encoder)
 {
 	struct drm_device *dev = encoder->dev;
 	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
-	uint32_t offset = to_radeon_encoder(encoder)->hdmi_offset;
+	struct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;
 
-	if (!offset)
+	if (!dig) {
+		dev_err(rdev->dev, "Enabling HDMI on non-dig encoder\n");
 		return;
+	}
 
-	DRM_DEBUG("%s HDMI interface @ 0x%04X\n", enable ? "Enabling" : "Disabling", offset);
-
-	/* some version of atombios ignore the enable HDMI flag
-	 * so enabling/disabling HDMI was moved here for TMDS1+2 */
-	switch (radeon_encoder->encoder_id) {
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:
-		WREG32_P(AVIVO_TMDSA_CNTL, enable ? 0x4 : 0x0, ~0x4);
-		WREG32(offset+R600_HDMI_ENABLE, enable ? 0x101 : 0x0);
-		break;
-
-	case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
-		WREG32_P(AVIVO_LVTMA_CNTL, enable ? 0x4 : 0x0, ~0x4);
-		WREG32(offset+R600_HDMI_ENABLE, enable ? 0x105 : 0x0);
-		break;
-
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:
-		/* This part is doubtfull in my opinion */
-		WREG32(offset+R600_HDMI_ENABLE, enable ? 0x110 : 0x0);
-		break;
-
-	default:
-		DRM_ERROR("unknown HDMI output type\n");
-		break;
+	if (ASIC_IS_DCE4(rdev)) {
+		/* TODO */
+	} else if (ASIC_IS_DCE3(rdev)) {
+		radeon_encoder->hdmi_offset = dig->dig_encoder ?
+			R600_HDMI_BLOCK3 : R600_HDMI_BLOCK1;
+		if (ASIC_IS_DCE32(rdev))
+			radeon_encoder->hdmi_config_offset = dig->dig_encoder ?
+				R600_HDMI_CONFIG2 : R600_HDMI_CONFIG1;
+	} else if (rdev->family >= CHIP_R600) {
+		radeon_encoder->hdmi_offset = r600_hdmi_find_free_block(dev);
 	}
 }
 
 /*
- * determin at which register offset the HDMI encoder is
+ * enable the HDMI engine
  */
-void r600_hdmi_init(struct drm_encoder *encoder)
+void r600_hdmi_enable(struct drm_encoder *encoder)
 {
+	struct drm_device *dev = encoder->dev;
+	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
 
-	switch (radeon_encoder->encoder_id) {
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
-		radeon_encoder->hdmi_offset = R600_HDMI_TMDS1;
-		break;
-
-	case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
-		switch (r600_audio_tmds_index(encoder)) {
-		case 0:
-			radeon_encoder->hdmi_offset = R600_HDMI_TMDS1;
+	if (!radeon_encoder->hdmi_offset) {
+		r600_hdmi_assign_block(encoder);
+		if (!radeon_encoder->hdmi_offset) {
+			dev_warn(rdev->dev, "Could not find HDMI block for "
+				"0x%x encoder\n", radeon_encoder->encoder_id);
+			return;
+		}
+	}
+
+	if (ASIC_IS_DCE32(rdev) && !ASIC_IS_DCE4(rdev)) {
+		WREG32_P(radeon_encoder->hdmi_config_offset + 0x4, 0x1, ~0x1);
+	} else if (rdev->family >= CHIP_R600 && !ASIC_IS_DCE3(rdev)) {
+		int offset = radeon_encoder->hdmi_offset;
+		switch (radeon_encoder->encoder_id) {
+		case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:
+			WREG32_P(AVIVO_TMDSA_CNTL, 0x4, ~0x4);
+			WREG32(offset + R600_HDMI_ENABLE, 0x101);
 			break;
-		case 1:
-			radeon_encoder->hdmi_offset = R600_HDMI_TMDS2;
+		case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
+			WREG32_P(AVIVO_LVTMA_CNTL, 0x4, ~0x4);
+			WREG32(offset + R600_HDMI_ENABLE, 0x105);
 			break;
 		default:
-			radeon_encoder->hdmi_offset = 0;
+			dev_err(rdev->dev, "Unknown HDMI output type\n");
 			break;
 		}
-	case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
-		radeon_encoder->hdmi_offset = R600_HDMI_TMDS2;
-		break;
+	}
 
-	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:
-		radeon_encoder->hdmi_offset = R600_HDMI_DIG;
-		break;
+	DRM_DEBUG("Enabling HDMI interface @ 0x%04X for encoder 0x%x\n",
+		radeon_encoder->hdmi_offset, radeon_encoder->encoder_id);
+}
 
-	default:
-		radeon_encoder->hdmi_offset = 0;
-		break;
+/*
+ * disable the HDMI engine
+ */
+void r600_hdmi_disable(struct drm_encoder *encoder)
+{
+	struct drm_device *dev = encoder->dev;
+	struct radeon_device *rdev = dev->dev_private;
+	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
+
+	if (!radeon_encoder->hdmi_offset) {
+		dev_err(rdev->dev, "Disabling not enabled HDMI\n");
+		return;
 	}
 
-	DRM_DEBUG("using HDMI engine at offset 0x%04X for encoder 0x%x\n",
-		  radeon_encoder->hdmi_offset, radeon_encoder->encoder_id);
+	DRM_DEBUG("Disabling HDMI interface @ 0x%04X for encoder 0x%x\n",
+		radeon_encoder->hdmi_offset, radeon_encoder->encoder_id);
+
+	if (ASIC_IS_DCE32(rdev) && !ASIC_IS_DCE4(rdev)) {
+		WREG32_P(radeon_encoder->hdmi_config_offset + 0x4, 0, ~0x1);
+	} else if (rdev->family >= CHIP_R600 && !ASIC_IS_DCE3(rdev)) {
+		int offset = radeon_encoder->hdmi_offset;
+		switch (radeon_encoder->encoder_id) {
+		case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:
+			WREG32_P(AVIVO_TMDSA_CNTL, 0, ~0x4);
+			WREG32(offset + R600_HDMI_ENABLE, 0);
+			break;
+		case ENCODER_OBJECT_ID_INTERNAL_LVTM1:
+			WREG32_P(AVIVO_LVTMA_CNTL, 0, ~0x4);
+			WREG32(offset + R600_HDMI_ENABLE, 0);
+			break;
+		default:
+			dev_err(rdev->dev, "Unknown HDMI output type\n");
+			break;
+		}
+	}
 
-	/* TODO: make this configureable */
-	radeon_encoder->hdmi_audio_workaround = 0;
+	radeon_encoder->hdmi_offset = 0;
+	radeon_encoder->hdmi_config_offset = 0;
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_reg.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_reg.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600_reg.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600_reg.h	2010-04-13 02:19:00.824633048 +0000
@@ -152,9 +152,9 @@
 #define R600_AUDIO_STATUS_BITS            0x73d8
 
 /* HDMI base register addresses */
-#define R600_HDMI_TMDS1                   0x7400
-#define R600_HDMI_TMDS2                   0x7700
-#define R600_HDMI_DIG                     0x7800
+#define R600_HDMI_BLOCK1                  0x7400
+#define R600_HDMI_BLOCK2                  0x7700
+#define R600_HDMI_BLOCK3                  0x7800
 
 /* HDMI registers */
 #define R600_HDMI_ENABLE           0x00
@@ -185,4 +185,8 @@
 #define R600_HDMI_AUDIO_DEBUG_2    0xe8
 #define R600_HDMI_AUDIO_DEBUG_3    0xec
 
+/* HDMI additional config base register addresses */
+#define R600_HDMI_CONFIG1                 0x7600
+#define R600_HDMI_CONFIG2                 0x7a00
+
 #endif
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600d.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600d.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/r600d.h	2010-04-13 02:18:55.703633067 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/r600d.h	2010-04-13 02:19:00.825633068 +0000
@@ -77,6 +77,55 @@
 #define CB_COLOR0_FRAG                                  0x280e0
 #define CB_COLOR0_MASK                                  0x28100
 
+#define SQ_ALU_CONST_CACHE_PS_0				0x28940
+#define SQ_ALU_CONST_CACHE_PS_1				0x28944
+#define SQ_ALU_CONST_CACHE_PS_2				0x28948
+#define SQ_ALU_CONST_CACHE_PS_3				0x2894c
+#define SQ_ALU_CONST_CACHE_PS_4				0x28950
+#define SQ_ALU_CONST_CACHE_PS_5				0x28954
+#define SQ_ALU_CONST_CACHE_PS_6				0x28958
+#define SQ_ALU_CONST_CACHE_PS_7				0x2895c
+#define SQ_ALU_CONST_CACHE_PS_8				0x28960
+#define SQ_ALU_CONST_CACHE_PS_9				0x28964
+#define SQ_ALU_CONST_CACHE_PS_10			0x28968
+#define SQ_ALU_CONST_CACHE_PS_11			0x2896c
+#define SQ_ALU_CONST_CACHE_PS_12			0x28970
+#define SQ_ALU_CONST_CACHE_PS_13			0x28974
+#define SQ_ALU_CONST_CACHE_PS_14			0x28978
+#define SQ_ALU_CONST_CACHE_PS_15			0x2897c
+#define SQ_ALU_CONST_CACHE_VS_0				0x28980
+#define SQ_ALU_CONST_CACHE_VS_1				0x28984
+#define SQ_ALU_CONST_CACHE_VS_2				0x28988
+#define SQ_ALU_CONST_CACHE_VS_3				0x2898c
+#define SQ_ALU_CONST_CACHE_VS_4				0x28990
+#define SQ_ALU_CONST_CACHE_VS_5				0x28994
+#define SQ_ALU_CONST_CACHE_VS_6				0x28998
+#define SQ_ALU_CONST_CACHE_VS_7				0x2899c
+#define SQ_ALU_CONST_CACHE_VS_8				0x289a0
+#define SQ_ALU_CONST_CACHE_VS_9				0x289a4
+#define SQ_ALU_CONST_CACHE_VS_10			0x289a8
+#define SQ_ALU_CONST_CACHE_VS_11			0x289ac
+#define SQ_ALU_CONST_CACHE_VS_12			0x289b0
+#define SQ_ALU_CONST_CACHE_VS_13			0x289b4
+#define SQ_ALU_CONST_CACHE_VS_14			0x289b8
+#define SQ_ALU_CONST_CACHE_VS_15			0x289bc
+#define SQ_ALU_CONST_CACHE_GS_0				0x289c0
+#define SQ_ALU_CONST_CACHE_GS_1				0x289c4
+#define SQ_ALU_CONST_CACHE_GS_2				0x289c8
+#define SQ_ALU_CONST_CACHE_GS_3				0x289cc
+#define SQ_ALU_CONST_CACHE_GS_4				0x289d0
+#define SQ_ALU_CONST_CACHE_GS_5				0x289d4
+#define SQ_ALU_CONST_CACHE_GS_6				0x289d8
+#define SQ_ALU_CONST_CACHE_GS_7				0x289dc
+#define SQ_ALU_CONST_CACHE_GS_8				0x289e0
+#define SQ_ALU_CONST_CACHE_GS_9				0x289e4
+#define SQ_ALU_CONST_CACHE_GS_10			0x289e8
+#define SQ_ALU_CONST_CACHE_GS_11			0x289ec
+#define SQ_ALU_CONST_CACHE_GS_12			0x289f0
+#define SQ_ALU_CONST_CACHE_GS_13			0x289f4
+#define SQ_ALU_CONST_CACHE_GS_14			0x289f8
+#define SQ_ALU_CONST_CACHE_GS_15			0x289fc
+
 #define	CONFIG_MEMSIZE					0x5428
 #define CONFIG_CNTL					0x5424
 #define	CP_STAT						0x8680
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon.h	2010-04-13 02:18:55.704633051 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon.h	2010-04-13 02:19:00.825633068 +0000
@@ -91,6 +91,8 @@
 extern int radeon_new_pll;
 extern int radeon_dynpm;
 extern int radeon_audio;
+extern int radeon_disp_priority;
+extern int radeon_hw_i2c;
 
 /*
  * Copy from radeon_drv.h so we don't have to include both and have conflicting
@@ -168,6 +170,7 @@
  * Power management
  */
 int radeon_pm_init(struct radeon_device *rdev);
+void radeon_pm_fini(struct radeon_device *rdev);
 void radeon_pm_compute_clocks(struct radeon_device *rdev);
 void radeon_combios_get_power_modes(struct radeon_device *rdev);
 void radeon_atombios_get_power_modes(struct radeon_device *rdev);
@@ -687,6 +690,7 @@
 	bool 			downclocked;
 	int			active_crtcs;
 	int			req_vblank;
+	bool			vblank_sync;
 	fixed20_12		max_bandwidth;
 	fixed20_12		igp_sideport_mclk;
 	fixed20_12		igp_system_mclk;
@@ -697,6 +701,7 @@
 	fixed20_12		ht_bandwidth;
 	fixed20_12		core_bandwidth;
 	fixed20_12		sclk;
+	fixed20_12		mclk;
 	fixed20_12		needed_bandwidth;
 	/* XXX: use a define for num power modes */
 	struct radeon_power_state power_state[8];
@@ -707,6 +712,7 @@
 	struct radeon_power_state *requested_power_state;
 	struct radeon_pm_clock_info *requested_clock_mode;
 	struct radeon_power_state *default_power_state;
+	struct radeon_i2c_chan *i2c_bus;
 };
 
 
@@ -729,8 +735,6 @@
 			     struct drm_info_list *files,
 			     unsigned nfiles);
 int radeon_debugfs_fence_init(struct radeon_device *rdev);
-int r100_debugfs_rbbm_init(struct radeon_device *rdev);
-int r100_debugfs_cp_init(struct radeon_device *rdev);
 
 
 /*
@@ -782,7 +786,7 @@
 	int (*set_surface_reg)(struct radeon_device *rdev, int reg,
 			       uint32_t tiling_flags, uint32_t pitch,
 			       uint32_t offset, uint32_t obj_size);
-	int (*clear_surface_reg)(struct radeon_device *rdev, int reg);
+	void (*clear_surface_reg)(struct radeon_device *rdev, int reg);
 	void (*bandwidth_update)(struct radeon_device *rdev);
 	void (*hpd_init)(struct radeon_device *rdev);
 	void (*hpd_fini)(struct radeon_device *rdev);
@@ -862,6 +866,12 @@
 	struct rv770_asic	rv770;
 };
 
+/*
+ * asic initizalization from radeon_asic.c
+ */
+void radeon_agp_disable(struct radeon_device *rdev);
+int radeon_asic_init(struct radeon_device *rdev);
+
 
 /*
  * IOCTL.
@@ -1172,6 +1182,8 @@
 extern int radeon_modeset_init(struct radeon_device *rdev);
 extern void radeon_modeset_fini(struct radeon_device *rdev);
 extern bool radeon_card_posted(struct radeon_device *rdev);
+extern void radeon_update_bandwidth_info(struct radeon_device *rdev);
+extern void radeon_update_display_priority(struct radeon_device *rdev);
 extern bool radeon_boot_test_post_card(struct radeon_device *rdev);
 extern int radeon_clocks_init(struct radeon_device *rdev);
 extern void radeon_clocks_fini(struct radeon_device *rdev);
@@ -1188,51 +1200,6 @@
 extern int radeon_suspend_kms(struct drm_device *dev, pm_message_t state);
 
 /* r100,rv100,rs100,rv200,rs200,r200,rv250,rs300,rv280 */
-struct r100_mc_save {
-	u32	GENMO_WT;
-	u32	CRTC_EXT_CNTL;
-	u32	CRTC_GEN_CNTL;
-	u32	CRTC2_GEN_CNTL;
-	u32	CUR_OFFSET;
-	u32	CUR2_OFFSET;
-};
-extern void r100_cp_disable(struct radeon_device *rdev);
-extern int r100_cp_init(struct radeon_device *rdev, unsigned ring_size);
-extern void r100_cp_fini(struct radeon_device *rdev);
-extern void r100_pci_gart_tlb_flush(struct radeon_device *rdev);
-extern int r100_pci_gart_init(struct radeon_device *rdev);
-extern void r100_pci_gart_fini(struct radeon_device *rdev);
-extern int r100_pci_gart_enable(struct radeon_device *rdev);
-extern void r100_pci_gart_disable(struct radeon_device *rdev);
-extern int r100_pci_gart_set_page(struct radeon_device *rdev, int i, uint64_t addr);
-extern int r100_debugfs_mc_info_init(struct radeon_device *rdev);
-extern int r100_gui_wait_for_idle(struct radeon_device *rdev);
-extern void r100_ib_fini(struct radeon_device *rdev);
-extern int r100_ib_init(struct radeon_device *rdev);
-extern void r100_irq_disable(struct radeon_device *rdev);
-extern int r100_irq_set(struct radeon_device *rdev);
-extern void r100_mc_stop(struct radeon_device *rdev, struct r100_mc_save *save);
-extern void r100_mc_resume(struct radeon_device *rdev, struct r100_mc_save *save);
-extern void r100_vram_init_sizes(struct radeon_device *rdev);
-extern void r100_wb_disable(struct radeon_device *rdev);
-extern void r100_wb_fini(struct radeon_device *rdev);
-extern int r100_wb_init(struct radeon_device *rdev);
-extern void r100_hdp_reset(struct radeon_device *rdev);
-extern int r100_rb2d_reset(struct radeon_device *rdev);
-extern int r100_cp_reset(struct radeon_device *rdev);
-extern void r100_vga_render_disable(struct radeon_device *rdev);
-extern int r100_cs_track_check_pkt3_indx_buffer(struct radeon_cs_parser *p,
-						struct radeon_cs_packet *pkt,
-						struct radeon_bo *robj);
-extern int r100_cs_parse_packet0(struct radeon_cs_parser *p,
-				struct radeon_cs_packet *pkt,
-				const unsigned *auth, unsigned n,
-				radeon_packet0_check_t check);
-extern int r100_cs_packet_parse(struct radeon_cs_parser *p,
-				struct radeon_cs_packet *pkt,
-				unsigned idx);
-extern void r100_enable_bm(struct radeon_device *rdev);
-extern void r100_set_common_regs(struct radeon_device *rdev);
 
 /* rv200,rv250,rv280 */
 extern void r200_set_safe_registers(struct radeon_device *rdev);
@@ -1322,7 +1289,8 @@
 extern void r600_audio_set_clock(struct drm_encoder *encoder, int clock);
 extern void r600_audio_fini(struct radeon_device *rdev);
 extern void r600_hdmi_init(struct drm_encoder *encoder);
-extern void r600_hdmi_enable(struct drm_encoder *encoder, int enable);
+extern void r600_hdmi_enable(struct drm_encoder *encoder);
+extern void r600_hdmi_disable(struct drm_encoder *encoder);
 extern void r600_hdmi_setmode(struct drm_encoder *encoder, struct drm_display_mode *mode);
 extern int r600_hdmi_buffer_status_changed(struct drm_encoder *encoder);
 extern void r600_hdmi_update_audio_settings(struct drm_encoder *encoder,
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_asic.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_asic.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_asic.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_asic.c	2010-04-13 02:19:00.826633034 +0000
@@ -0,0 +1,772 @@
+/*
+ * Copyright 2008 Advanced Micro Devices, Inc.
+ * Copyright 2008 Red Hat Inc.
+ * Copyright 2009 Jerome Glisse.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Authors: Dave Airlie
+ *          Alex Deucher
+ *          Jerome Glisse
+ */
+
+#include <linux/console.h>
+#include <drm/drmP.h>
+#include <drm/drm_crtc_helper.h>
+#include <drm/radeon_drm.h>
+#include <linux/vgaarb.h>
+#include <linux/vga_switcheroo.h>
+#include "radeon_reg.h"
+#include "radeon.h"
+#include "radeon_asic.h"
+#include "atom.h"
+
+/*
+ * Registers accessors functions.
+ */
+static uint32_t radeon_invalid_rreg(struct radeon_device *rdev, uint32_t reg)
+{
+	DRM_ERROR("Invalid callback to read register 0x%04X\n", reg);
+	BUG_ON(1);
+	return 0;
+}
+
+static void radeon_invalid_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v)
+{
+	DRM_ERROR("Invalid callback to write register 0x%04X with 0x%08X\n",
+		  reg, v);
+	BUG_ON(1);
+}
+
+static void radeon_register_accessor_init(struct radeon_device *rdev)
+{
+	rdev->mc_rreg = &radeon_invalid_rreg;
+	rdev->mc_wreg = &radeon_invalid_wreg;
+	rdev->pll_rreg = &radeon_invalid_rreg;
+	rdev->pll_wreg = &radeon_invalid_wreg;
+	rdev->pciep_rreg = &radeon_invalid_rreg;
+	rdev->pciep_wreg = &radeon_invalid_wreg;
+
+	/* Don't change order as we are overridding accessor. */
+	if (rdev->family < CHIP_RV515) {
+		rdev->pcie_reg_mask = 0xff;
+	} else {
+		rdev->pcie_reg_mask = 0x7ff;
+	}
+	/* FIXME: not sure here */
+	if (rdev->family <= CHIP_R580) {
+		rdev->pll_rreg = &r100_pll_rreg;
+		rdev->pll_wreg = &r100_pll_wreg;
+	}
+	if (rdev->family >= CHIP_R420) {
+		rdev->mc_rreg = &r420_mc_rreg;
+		rdev->mc_wreg = &r420_mc_wreg;
+	}
+	if (rdev->family >= CHIP_RV515) {
+		rdev->mc_rreg = &rv515_mc_rreg;
+		rdev->mc_wreg = &rv515_mc_wreg;
+	}
+	if (rdev->family == CHIP_RS400 || rdev->family == CHIP_RS480) {
+		rdev->mc_rreg = &rs400_mc_rreg;
+		rdev->mc_wreg = &rs400_mc_wreg;
+	}
+	if (rdev->family == CHIP_RS690 || rdev->family == CHIP_RS740) {
+		rdev->mc_rreg = &rs690_mc_rreg;
+		rdev->mc_wreg = &rs690_mc_wreg;
+	}
+	if (rdev->family == CHIP_RS600) {
+		rdev->mc_rreg = &rs600_mc_rreg;
+		rdev->mc_wreg = &rs600_mc_wreg;
+	}
+	if ((rdev->family >= CHIP_R600) && (rdev->family <= CHIP_RV740)) {
+		rdev->pciep_rreg = &r600_pciep_rreg;
+		rdev->pciep_wreg = &r600_pciep_wreg;
+	}
+}
+
+
+/* helper to disable agp */
+void radeon_agp_disable(struct radeon_device *rdev)
+{
+	rdev->flags &= ~RADEON_IS_AGP;
+	if (rdev->family >= CHIP_R600) {
+		DRM_INFO("Forcing AGP to PCIE mode\n");
+		rdev->flags |= RADEON_IS_PCIE;
+	} else if (rdev->family >= CHIP_RV515 ||
+			rdev->family == CHIP_RV380 ||
+			rdev->family == CHIP_RV410 ||
+			rdev->family == CHIP_R423) {
+		DRM_INFO("Forcing AGP to PCIE mode\n");
+		rdev->flags |= RADEON_IS_PCIE;
+		rdev->asic->gart_tlb_flush = &rv370_pcie_gart_tlb_flush;
+		rdev->asic->gart_set_page = &rv370_pcie_gart_set_page;
+	} else {
+		DRM_INFO("Forcing AGP to PCI mode\n");
+		rdev->flags |= RADEON_IS_PCI;
+		rdev->asic->gart_tlb_flush = &r100_pci_gart_tlb_flush;
+		rdev->asic->gart_set_page = &r100_pci_gart_set_page;
+	}
+	rdev->mc.gtt_size = radeon_gart_size * 1024 * 1024;
+}
+
+/*
+ * ASIC
+ */
+static struct radeon_asic r100_asic = {
+	.init = &r100_init,
+	.fini = &r100_fini,
+	.suspend = &r100_suspend,
+	.resume = &r100_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r100_gpu_reset,
+	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
+	.gart_set_page = &r100_pci_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r100_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r100_fence_ring_emit,
+	.cs_parse = &r100_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = NULL,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_legacy_get_engine_clock,
+	.set_engine_clock = &radeon_legacy_set_engine_clock,
+	.get_memory_clock = &radeon_legacy_get_memory_clock,
+	.set_memory_clock = NULL,
+	.get_pcie_lanes = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_legacy_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r200_asic = {
+	.init = &r100_init,
+	.fini = &r100_fini,
+	.suspend = &r100_suspend,
+	.resume = &r100_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r100_gpu_reset,
+	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
+	.gart_set_page = &r100_pci_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r100_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r100_fence_ring_emit,
+	.cs_parse = &r100_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_legacy_get_engine_clock,
+	.set_engine_clock = &radeon_legacy_set_engine_clock,
+	.get_memory_clock = &radeon_legacy_get_memory_clock,
+	.set_memory_clock = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_legacy_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r300_asic = {
+	.init = &r300_init,
+	.fini = &r300_fini,
+	.suspend = &r300_suspend,
+	.resume = &r300_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
+	.gart_set_page = &r100_pci_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_legacy_get_engine_clock,
+	.set_engine_clock = &radeon_legacy_set_engine_clock,
+	.get_memory_clock = &radeon_legacy_get_memory_clock,
+	.set_memory_clock = NULL,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = &rv370_set_pcie_lanes,
+	.set_clock_gating = &radeon_legacy_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r300_asic_pcie = {
+	.init = &r300_init,
+	.fini = &r300_fini,
+	.suspend = &r300_suspend,
+	.resume = &r300_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
+	.gart_set_page = &rv370_pcie_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_legacy_get_engine_clock,
+	.set_engine_clock = &radeon_legacy_set_engine_clock,
+	.get_memory_clock = &radeon_legacy_get_memory_clock,
+	.set_memory_clock = NULL,
+	.set_pcie_lanes = &rv370_set_pcie_lanes,
+	.set_clock_gating = &radeon_legacy_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r420_asic = {
+	.init = &r420_init,
+	.fini = &r420_fini,
+	.suspend = &r420_suspend,
+	.resume = &r420_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
+	.gart_set_page = &rv370_pcie_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = &rv370_set_pcie_lanes,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic rs400_asic = {
+	.init = &rs400_init,
+	.fini = &rs400_fini,
+	.suspend = &rs400_suspend,
+	.resume = &rs400_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &rs400_gart_tlb_flush,
+	.gart_set_page = &rs400_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &r100_irq_set,
+	.irq_process = &r100_irq_process,
+	.get_vblank_counter = &r100_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_legacy_get_engine_clock,
+	.set_engine_clock = &radeon_legacy_set_engine_clock,
+	.get_memory_clock = &radeon_legacy_get_memory_clock,
+	.set_memory_clock = NULL,
+	.get_pcie_lanes = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_legacy_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &r100_bandwidth_update,
+	.hpd_init = &r100_hpd_init,
+	.hpd_fini = &r100_hpd_fini,
+	.hpd_sense = &r100_hpd_sense,
+	.hpd_set_polarity = &r100_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic rs600_asic = {
+	.init = &rs600_init,
+	.fini = &rs600_fini,
+	.suspend = &rs600_suspend,
+	.resume = &rs600_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &rs600_gart_tlb_flush,
+	.gart_set_page = &rs600_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &rs600_irq_set,
+	.irq_process = &rs600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &rs600_bandwidth_update,
+	.hpd_init = &rs600_hpd_init,
+	.hpd_fini = &rs600_hpd_fini,
+	.hpd_sense = &rs600_hpd_sense,
+	.hpd_set_polarity = &rs600_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic rs690_asic = {
+	.init = &rs690_init,
+	.fini = &rs690_fini,
+	.suspend = &rs690_suspend,
+	.resume = &rs690_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &r300_gpu_reset,
+	.gart_tlb_flush = &rs400_gart_tlb_flush,
+	.gart_set_page = &rs400_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &r300_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &rs600_irq_set,
+	.irq_process = &rs600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r200_copy_dma,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &rs690_bandwidth_update,
+	.hpd_init = &rs600_hpd_init,
+	.hpd_fini = &rs600_hpd_fini,
+	.hpd_sense = &rs600_hpd_sense,
+	.hpd_set_polarity = &rs600_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic rv515_asic = {
+	.init = &rv515_init,
+	.fini = &rv515_fini,
+	.suspend = &rv515_suspend,
+	.resume = &rv515_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &rv515_gpu_reset,
+	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
+	.gart_set_page = &rv370_pcie_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &rv515_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &rs600_irq_set,
+	.irq_process = &rs600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = &rv370_set_pcie_lanes,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &rv515_bandwidth_update,
+	.hpd_init = &rs600_hpd_init,
+	.hpd_fini = &rs600_hpd_fini,
+	.hpd_sense = &rs600_hpd_sense,
+	.hpd_set_polarity = &rs600_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r520_asic = {
+	.init = &r520_init,
+	.fini = &rv515_fini,
+	.suspend = &rv515_suspend,
+	.resume = &r520_resume,
+	.vga_set_state = &r100_vga_set_state,
+	.gpu_reset = &rv515_gpu_reset,
+	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
+	.gart_set_page = &rv370_pcie_gart_set_page,
+	.cp_commit = &r100_cp_commit,
+	.ring_start = &rv515_ring_start,
+	.ring_test = &r100_ring_test,
+	.ring_ib_execute = &r100_ring_ib_execute,
+	.irq_set = &rs600_irq_set,
+	.irq_process = &rs600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r300_fence_ring_emit,
+	.cs_parse = &r300_cs_parse,
+	.copy_blit = &r100_copy_blit,
+	.copy_dma = &r200_copy_dma,
+	.copy = &r100_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = &rv370_set_pcie_lanes,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r100_set_surface_reg,
+	.clear_surface_reg = r100_clear_surface_reg,
+	.bandwidth_update = &rv515_bandwidth_update,
+	.hpd_init = &rs600_hpd_init,
+	.hpd_fini = &rs600_hpd_fini,
+	.hpd_sense = &rs600_hpd_sense,
+	.hpd_set_polarity = &rs600_hpd_set_polarity,
+	.ioctl_wait_idle = NULL,
+};
+
+static struct radeon_asic r600_asic = {
+	.init = &r600_init,
+	.fini = &r600_fini,
+	.suspend = &r600_suspend,
+	.resume = &r600_resume,
+	.cp_commit = &r600_cp_commit,
+	.vga_set_state = &r600_vga_set_state,
+	.gpu_reset = &r600_gpu_reset,
+	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
+	.gart_set_page = &rs600_gart_set_page,
+	.ring_test = &r600_ring_test,
+	.ring_ib_execute = &r600_ring_ib_execute,
+	.irq_set = &r600_irq_set,
+	.irq_process = &r600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r600_fence_ring_emit,
+	.cs_parse = &r600_cs_parse,
+	.copy_blit = &r600_copy_blit,
+	.copy_dma = &r600_copy_blit,
+	.copy = &r600_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = NULL,
+	.set_surface_reg = r600_set_surface_reg,
+	.clear_surface_reg = r600_clear_surface_reg,
+	.bandwidth_update = &rv515_bandwidth_update,
+	.hpd_init = &r600_hpd_init,
+	.hpd_fini = &r600_hpd_fini,
+	.hpd_sense = &r600_hpd_sense,
+	.hpd_set_polarity = &r600_hpd_set_polarity,
+	.ioctl_wait_idle = r600_ioctl_wait_idle,
+};
+
+static struct radeon_asic rs780_asic = {
+	.init = &r600_init,
+	.fini = &r600_fini,
+	.suspend = &r600_suspend,
+	.resume = &r600_resume,
+	.cp_commit = &r600_cp_commit,
+	.vga_set_state = &r600_vga_set_state,
+	.gpu_reset = &r600_gpu_reset,
+	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
+	.gart_set_page = &rs600_gart_set_page,
+	.ring_test = &r600_ring_test,
+	.ring_ib_execute = &r600_ring_ib_execute,
+	.irq_set = &r600_irq_set,
+	.irq_process = &r600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r600_fence_ring_emit,
+	.cs_parse = &r600_cs_parse,
+	.copy_blit = &r600_copy_blit,
+	.copy_dma = &r600_copy_blit,
+	.copy = &r600_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = NULL,
+	.set_memory_clock = NULL,
+	.get_pcie_lanes = NULL,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = NULL,
+	.set_surface_reg = r600_set_surface_reg,
+	.clear_surface_reg = r600_clear_surface_reg,
+	.bandwidth_update = &rs690_bandwidth_update,
+	.hpd_init = &r600_hpd_init,
+	.hpd_fini = &r600_hpd_fini,
+	.hpd_sense = &r600_hpd_sense,
+	.hpd_set_polarity = &r600_hpd_set_polarity,
+	.ioctl_wait_idle = r600_ioctl_wait_idle,
+};
+
+static struct radeon_asic rv770_asic = {
+	.init = &rv770_init,
+	.fini = &rv770_fini,
+	.suspend = &rv770_suspend,
+	.resume = &rv770_resume,
+	.cp_commit = &r600_cp_commit,
+	.gpu_reset = &rv770_gpu_reset,
+	.vga_set_state = &r600_vga_set_state,
+	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
+	.gart_set_page = &rs600_gart_set_page,
+	.ring_test = &r600_ring_test,
+	.ring_ib_execute = &r600_ring_ib_execute,
+	.irq_set = &r600_irq_set,
+	.irq_process = &r600_irq_process,
+	.get_vblank_counter = &rs600_get_vblank_counter,
+	.fence_ring_emit = &r600_fence_ring_emit,
+	.cs_parse = &r600_cs_parse,
+	.copy_blit = &r600_copy_blit,
+	.copy_dma = &r600_copy_blit,
+	.copy = &r600_copy_blit,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.get_pcie_lanes = &rv370_get_pcie_lanes,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = &radeon_atom_set_clock_gating,
+	.set_surface_reg = r600_set_surface_reg,
+	.clear_surface_reg = r600_clear_surface_reg,
+	.bandwidth_update = &rv515_bandwidth_update,
+	.hpd_init = &r600_hpd_init,
+	.hpd_fini = &r600_hpd_fini,
+	.hpd_sense = &r600_hpd_sense,
+	.hpd_set_polarity = &r600_hpd_set_polarity,
+	.ioctl_wait_idle = r600_ioctl_wait_idle,
+};
+
+static struct radeon_asic evergreen_asic = {
+	.init = &evergreen_init,
+	.fini = &evergreen_fini,
+	.suspend = &evergreen_suspend,
+	.resume = &evergreen_resume,
+	.cp_commit = NULL,
+	.gpu_reset = &evergreen_gpu_reset,
+	.vga_set_state = &r600_vga_set_state,
+	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
+	.gart_set_page = &rs600_gart_set_page,
+	.ring_test = NULL,
+	.ring_ib_execute = NULL,
+	.irq_set = NULL,
+	.irq_process = NULL,
+	.get_vblank_counter = NULL,
+	.fence_ring_emit = NULL,
+	.cs_parse = NULL,
+	.copy_blit = NULL,
+	.copy_dma = NULL,
+	.copy = NULL,
+	.get_engine_clock = &radeon_atom_get_engine_clock,
+	.set_engine_clock = &radeon_atom_set_engine_clock,
+	.get_memory_clock = &radeon_atom_get_memory_clock,
+	.set_memory_clock = &radeon_atom_set_memory_clock,
+	.set_pcie_lanes = NULL,
+	.set_clock_gating = NULL,
+	.set_surface_reg = r600_set_surface_reg,
+	.clear_surface_reg = r600_clear_surface_reg,
+	.bandwidth_update = &evergreen_bandwidth_update,
+	.hpd_init = &evergreen_hpd_init,
+	.hpd_fini = &evergreen_hpd_fini,
+	.hpd_sense = &evergreen_hpd_sense,
+	.hpd_set_polarity = &evergreen_hpd_set_polarity,
+};
+
+int radeon_asic_init(struct radeon_device *rdev)
+{
+	radeon_register_accessor_init(rdev);
+	switch (rdev->family) {
+	case CHIP_R100:
+	case CHIP_RV100:
+	case CHIP_RS100:
+	case CHIP_RV200:
+	case CHIP_RS200:
+		rdev->asic = &r100_asic;
+		break;
+	case CHIP_R200:
+	case CHIP_RV250:
+	case CHIP_RS300:
+	case CHIP_RV280:
+		rdev->asic = &r200_asic;
+		break;
+	case CHIP_R300:
+	case CHIP_R350:
+	case CHIP_RV350:
+	case CHIP_RV380:
+		if (rdev->flags & RADEON_IS_PCIE)
+			rdev->asic = &r300_asic_pcie;
+		else
+			rdev->asic = &r300_asic;
+		break;
+	case CHIP_R420:
+	case CHIP_R423:
+	case CHIP_RV410:
+		rdev->asic = &r420_asic;
+		break;
+	case CHIP_RS400:
+	case CHIP_RS480:
+		rdev->asic = &rs400_asic;
+		break;
+	case CHIP_RS600:
+		rdev->asic = &rs600_asic;
+		break;
+	case CHIP_RS690:
+	case CHIP_RS740:
+		rdev->asic = &rs690_asic;
+		break;
+	case CHIP_RV515:
+		rdev->asic = &rv515_asic;
+		break;
+	case CHIP_R520:
+	case CHIP_RV530:
+	case CHIP_RV560:
+	case CHIP_RV570:
+	case CHIP_R580:
+		rdev->asic = &r520_asic;
+		break;
+	case CHIP_R600:
+	case CHIP_RV610:
+	case CHIP_RV630:
+	case CHIP_RV620:
+	case CHIP_RV635:
+	case CHIP_RV670:
+		rdev->asic = &r600_asic;
+		break;
+	case CHIP_RS780:
+	case CHIP_RS880:
+		rdev->asic = &rs780_asic;
+		break;
+	case CHIP_RV770:
+	case CHIP_RV730:
+	case CHIP_RV710:
+	case CHIP_RV740:
+		rdev->asic = &rv770_asic;
+		break;
+	case CHIP_CEDAR:
+	case CHIP_REDWOOD:
+	case CHIP_JUNIPER:
+	case CHIP_CYPRESS:
+	case CHIP_HEMLOCK:
+		rdev->asic = &evergreen_asic;
+		break;
+	default:
+		/* FIXME: not supported yet */
+		return -EINVAL;
+	}
+
+	if (rdev->flags & RADEON_IS_IGP) {
+		rdev->asic->get_memory_clock = NULL;
+		rdev->asic->set_memory_clock = NULL;
+	}
+
+	/* set the number of crtcs */
+	if (rdev->flags & RADEON_SINGLE_CRTC)
+		rdev->num_crtc = 1;
+	else {
+		if (ASIC_IS_DCE4(rdev))
+			rdev->num_crtc = 6;
+		else
+			rdev->num_crtc = 2;
+	}
+
+	return 0;
+}
+
+/*
+ * Wrapper around modesetting bits. Move to radeon_clocks.c?
+ */
+int radeon_clocks_init(struct radeon_device *rdev)
+{
+	int r;
+
+	r = radeon_static_clocks_init(rdev->ddev);
+	if (r) {
+		return r;
+	}
+	DRM_INFO("Clocks initialized !\n");
+	return 0;
+}
+
+void radeon_clocks_fini(struct radeon_device *rdev)
+{
+}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_asic.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_asic.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_asic.h	2010-04-13 02:18:55.704633051 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_asic.h	2010-04-13 02:19:00.826633034 +0000
@@ -45,10 +45,18 @@
 /*
  * r100,rv100,rs100,rv200,rs200
  */
-extern int r100_init(struct radeon_device *rdev);
-extern void r100_fini(struct radeon_device *rdev);
-extern int r100_suspend(struct radeon_device *rdev);
-extern int r100_resume(struct radeon_device *rdev);
+struct r100_mc_save {
+	u32	GENMO_WT;
+	u32	CRTC_EXT_CNTL;
+	u32	CRTC_GEN_CNTL;
+	u32	CRTC2_GEN_CNTL;
+	u32	CUR_OFFSET;
+	u32	CUR2_OFFSET;
+};
+int r100_init(struct radeon_device *rdev);
+void r100_fini(struct radeon_device *rdev);
+int r100_suspend(struct radeon_device *rdev);
+int r100_resume(struct radeon_device *rdev);
 uint32_t r100_mm_rreg(struct radeon_device *rdev, uint32_t reg);
 void r100_mm_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v);
 void r100_vga_set_state(struct radeon_device *rdev, bool state);
@@ -73,7 +81,7 @@
 int r100_set_surface_reg(struct radeon_device *rdev, int reg,
 			 uint32_t tiling_flags, uint32_t pitch,
 			 uint32_t offset, uint32_t obj_size);
-int r100_clear_surface_reg(struct radeon_device *rdev, int reg);
+void r100_clear_surface_reg(struct radeon_device *rdev, int reg);
 void r100_bandwidth_update(struct radeon_device *rdev);
 void r100_ring_ib_execute(struct radeon_device *rdev, struct radeon_ib *ib);
 int r100_ring_test(struct radeon_device *rdev);
@@ -82,44 +90,42 @@
 bool r100_hpd_sense(struct radeon_device *rdev, enum radeon_hpd_id hpd);
 void r100_hpd_set_polarity(struct radeon_device *rdev,
 			   enum radeon_hpd_id hpd);
-
-static struct radeon_asic r100_asic = {
-	.init = &r100_init,
-	.fini = &r100_fini,
-	.suspend = &r100_suspend,
-	.resume = &r100_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r100_gpu_reset,
-	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
-	.gart_set_page = &r100_pci_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r100_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r100_fence_ring_emit,
-	.cs_parse = &r100_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = NULL,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_legacy_get_engine_clock,
-	.set_engine_clock = &radeon_legacy_set_engine_clock,
-	.get_memory_clock = &radeon_legacy_get_memory_clock,
-	.set_memory_clock = NULL,
-	.get_pcie_lanes = NULL,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_legacy_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
+int r100_debugfs_rbbm_init(struct radeon_device *rdev);
+int r100_debugfs_cp_init(struct radeon_device *rdev);
+void r100_cp_disable(struct radeon_device *rdev);
+int r100_cp_init(struct radeon_device *rdev, unsigned ring_size);
+void r100_cp_fini(struct radeon_device *rdev);
+int r100_pci_gart_init(struct radeon_device *rdev);
+void r100_pci_gart_fini(struct radeon_device *rdev);
+int r100_pci_gart_enable(struct radeon_device *rdev);
+void r100_pci_gart_disable(struct radeon_device *rdev);
+int r100_debugfs_mc_info_init(struct radeon_device *rdev);
+int r100_gui_wait_for_idle(struct radeon_device *rdev);
+void r100_ib_fini(struct radeon_device *rdev);
+int r100_ib_init(struct radeon_device *rdev);
+void r100_irq_disable(struct radeon_device *rdev);
+void r100_mc_stop(struct radeon_device *rdev, struct r100_mc_save *save);
+void r100_mc_resume(struct radeon_device *rdev, struct r100_mc_save *save);
+void r100_vram_init_sizes(struct radeon_device *rdev);
+void r100_wb_disable(struct radeon_device *rdev);
+void r100_wb_fini(struct radeon_device *rdev);
+int r100_wb_init(struct radeon_device *rdev);
+void r100_hdp_reset(struct radeon_device *rdev);
+int r100_rb2d_reset(struct radeon_device *rdev);
+int r100_cp_reset(struct radeon_device *rdev);
+void r100_vga_render_disable(struct radeon_device *rdev);
+int r100_cs_track_check_pkt3_indx_buffer(struct radeon_cs_parser *p,
+					 struct radeon_cs_packet *pkt,
+					 struct radeon_bo *robj);
+int r100_cs_parse_packet0(struct radeon_cs_parser *p,
+			  struct radeon_cs_packet *pkt,
+			  const unsigned *auth, unsigned n,
+			  radeon_packet0_check_t check);
+int r100_cs_packet_parse(struct radeon_cs_parser *p,
+			 struct radeon_cs_packet *pkt,
+			 unsigned idx);
+void r100_enable_bm(struct radeon_device *rdev);
+void r100_set_common_regs(struct radeon_device *rdev);
 
 /*
  * r200,rv250,rs300,rv280
@@ -129,43 +135,6 @@
 			uint64_t dst_offset,
 			unsigned num_pages,
 			struct radeon_fence *fence);
-static struct radeon_asic r200_asic = {
-	.init = &r100_init,
-	.fini = &r100_fini,
-	.suspend = &r100_suspend,
-	.resume = &r100_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r100_gpu_reset,
-	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
-	.gart_set_page = &r100_pci_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r100_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r100_fence_ring_emit,
-	.cs_parse = &r100_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_legacy_get_engine_clock,
-	.set_engine_clock = &radeon_legacy_set_engine_clock,
-	.get_memory_clock = &radeon_legacy_get_memory_clock,
-	.set_memory_clock = NULL,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_legacy_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 
 /*
  * r300,r350,rv350,rv380
@@ -186,82 +155,6 @@
 extern void rv370_set_pcie_lanes(struct radeon_device *rdev, int lanes);
 extern int rv370_get_pcie_lanes(struct radeon_device *rdev);
 
-static struct radeon_asic r300_asic = {
-	.init = &r300_init,
-	.fini = &r300_fini,
-	.suspend = &r300_suspend,
-	.resume = &r300_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &r100_pci_gart_tlb_flush,
-	.gart_set_page = &r100_pci_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_legacy_get_engine_clock,
-	.set_engine_clock = &radeon_legacy_set_engine_clock,
-	.get_memory_clock = &radeon_legacy_get_memory_clock,
-	.set_memory_clock = NULL,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = &rv370_set_pcie_lanes,
-	.set_clock_gating = &radeon_legacy_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
-
-static struct radeon_asic r300_asic_pcie = {
-	.init = &r300_init,
-	.fini = &r300_fini,
-	.suspend = &r300_suspend,
-	.resume = &r300_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
-	.gart_set_page = &rv370_pcie_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_legacy_get_engine_clock,
-	.set_engine_clock = &radeon_legacy_set_engine_clock,
-	.get_memory_clock = &radeon_legacy_get_memory_clock,
-	.set_memory_clock = NULL,
-	.set_pcie_lanes = &rv370_set_pcie_lanes,
-	.set_clock_gating = &radeon_legacy_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 /*
  * r420,r423,rv410
  */
@@ -269,44 +162,6 @@
 extern void r420_fini(struct radeon_device *rdev);
 extern int r420_suspend(struct radeon_device *rdev);
 extern int r420_resume(struct radeon_device *rdev);
-static struct radeon_asic r420_asic = {
-	.init = &r420_init,
-	.fini = &r420_fini,
-	.suspend = &r420_suspend,
-	.resume = &r420_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
-	.gart_set_page = &rv370_pcie_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = &rv370_set_pcie_lanes,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 
 /*
  * rs400,rs480
@@ -319,44 +174,6 @@
 int rs400_gart_set_page(struct radeon_device *rdev, int i, uint64_t addr);
 uint32_t rs400_mc_rreg(struct radeon_device *rdev, uint32_t reg);
 void rs400_mc_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v);
-static struct radeon_asic rs400_asic = {
-	.init = &rs400_init,
-	.fini = &rs400_fini,
-	.suspend = &rs400_suspend,
-	.resume = &rs400_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &rs400_gart_tlb_flush,
-	.gart_set_page = &rs400_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &r100_irq_set,
-	.irq_process = &r100_irq_process,
-	.get_vblank_counter = &r100_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_legacy_get_engine_clock,
-	.set_engine_clock = &radeon_legacy_set_engine_clock,
-	.get_memory_clock = &radeon_legacy_get_memory_clock,
-	.set_memory_clock = NULL,
-	.get_pcie_lanes = NULL,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_legacy_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &r100_bandwidth_update,
-	.hpd_init = &r100_hpd_init,
-	.hpd_fini = &r100_hpd_fini,
-	.hpd_sense = &r100_hpd_sense,
-	.hpd_set_polarity = &r100_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 
 /*
  * rs600.
@@ -379,45 +196,6 @@
 void rs600_hpd_set_polarity(struct radeon_device *rdev,
 			    enum radeon_hpd_id hpd);
 
-static struct radeon_asic rs600_asic = {
-	.init = &rs600_init,
-	.fini = &rs600_fini,
-	.suspend = &rs600_suspend,
-	.resume = &rs600_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &rs600_gart_tlb_flush,
-	.gart_set_page = &rs600_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &rs600_irq_set,
-	.irq_process = &rs600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = NULL,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &rs600_bandwidth_update,
-	.hpd_init = &rs600_hpd_init,
-	.hpd_fini = &rs600_hpd_fini,
-	.hpd_sense = &rs600_hpd_sense,
-	.hpd_set_polarity = &rs600_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
-
 /*
  * rs690,rs740
  */
@@ -428,44 +206,6 @@
 uint32_t rs690_mc_rreg(struct radeon_device *rdev, uint32_t reg);
 void rs690_mc_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v);
 void rs690_bandwidth_update(struct radeon_device *rdev);
-static struct radeon_asic rs690_asic = {
-	.init = &rs690_init,
-	.fini = &rs690_fini,
-	.suspend = &rs690_suspend,
-	.resume = &rs690_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &r300_gpu_reset,
-	.gart_tlb_flush = &rs400_gart_tlb_flush,
-	.gart_set_page = &rs400_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &r300_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &rs600_irq_set,
-	.irq_process = &rs600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r200_copy_dma,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = NULL,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &rs690_bandwidth_update,
-	.hpd_init = &rs600_hpd_init,
-	.hpd_fini = &rs600_hpd_fini,
-	.hpd_sense = &rs600_hpd_sense,
-	.hpd_set_polarity = &rs600_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 
 /*
  * rv515
@@ -481,87 +221,12 @@
 void rv515_bandwidth_update(struct radeon_device *rdev);
 int rv515_resume(struct radeon_device *rdev);
 int rv515_suspend(struct radeon_device *rdev);
-static struct radeon_asic rv515_asic = {
-	.init = &rv515_init,
-	.fini = &rv515_fini,
-	.suspend = &rv515_suspend,
-	.resume = &rv515_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &rv515_gpu_reset,
-	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
-	.gart_set_page = &rv370_pcie_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &rv515_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &rs600_irq_set,
-	.irq_process = &rs600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = &rv370_set_pcie_lanes,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &rv515_bandwidth_update,
-	.hpd_init = &rs600_hpd_init,
-	.hpd_fini = &rs600_hpd_fini,
-	.hpd_sense = &rs600_hpd_sense,
-	.hpd_set_polarity = &rs600_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
-
 
 /*
  * r520,rv530,rv560,rv570,r580
  */
 int r520_init(struct radeon_device *rdev);
 int r520_resume(struct radeon_device *rdev);
-static struct radeon_asic r520_asic = {
-	.init = &r520_init,
-	.fini = &rv515_fini,
-	.suspend = &rv515_suspend,
-	.resume = &r520_resume,
-	.vga_set_state = &r100_vga_set_state,
-	.gpu_reset = &rv515_gpu_reset,
-	.gart_tlb_flush = &rv370_pcie_gart_tlb_flush,
-	.gart_set_page = &rv370_pcie_gart_set_page,
-	.cp_commit = &r100_cp_commit,
-	.ring_start = &rv515_ring_start,
-	.ring_test = &r100_ring_test,
-	.ring_ib_execute = &r100_ring_ib_execute,
-	.irq_set = &rs600_irq_set,
-	.irq_process = &rs600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r300_fence_ring_emit,
-	.cs_parse = &r300_cs_parse,
-	.copy_blit = &r100_copy_blit,
-	.copy_dma = &r200_copy_dma,
-	.copy = &r100_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = &rv370_set_pcie_lanes,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r100_set_surface_reg,
-	.clear_surface_reg = r100_clear_surface_reg,
-	.bandwidth_update = &rv515_bandwidth_update,
-	.hpd_init = &rs600_hpd_init,
-	.hpd_fini = &rs600_hpd_fini,
-	.hpd_sense = &rs600_hpd_sense,
-	.hpd_set_polarity = &rs600_hpd_set_polarity,
-	.ioctl_wait_idle = NULL,
-};
 
 /*
  * r600,rv610,rv630,rv620,rv635,rv670,rs780,rs880
@@ -591,7 +256,7 @@
 int r600_set_surface_reg(struct radeon_device *rdev, int reg,
 			 uint32_t tiling_flags, uint32_t pitch,
 			 uint32_t offset, uint32_t obj_size);
-int r600_clear_surface_reg(struct radeon_device *rdev, int reg);
+void r600_clear_surface_reg(struct radeon_device *rdev, int reg);
 void r600_ring_ib_execute(struct radeon_device *rdev, struct radeon_ib *ib);
 int r600_ring_test(struct radeon_device *rdev);
 int r600_copy_blit(struct radeon_device *rdev,
@@ -604,43 +269,6 @@
 			   enum radeon_hpd_id hpd);
 extern void r600_ioctl_wait_idle(struct radeon_device *rdev, struct radeon_bo *bo);
 
-static struct radeon_asic r600_asic = {
-	.init = &r600_init,
-	.fini = &r600_fini,
-	.suspend = &r600_suspend,
-	.resume = &r600_resume,
-	.cp_commit = &r600_cp_commit,
-	.vga_set_state = &r600_vga_set_state,
-	.gpu_reset = &r600_gpu_reset,
-	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
-	.gart_set_page = &rs600_gart_set_page,
-	.ring_test = &r600_ring_test,
-	.ring_ib_execute = &r600_ring_ib_execute,
-	.irq_set = &r600_irq_set,
-	.irq_process = &r600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r600_fence_ring_emit,
-	.cs_parse = &r600_cs_parse,
-	.copy_blit = &r600_copy_blit,
-	.copy_dma = &r600_copy_blit,
-	.copy = &r600_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = NULL,
-	.set_surface_reg = r600_set_surface_reg,
-	.clear_surface_reg = r600_clear_surface_reg,
-	.bandwidth_update = &rv515_bandwidth_update,
-	.hpd_init = &r600_hpd_init,
-	.hpd_fini = &r600_hpd_fini,
-	.hpd_sense = &r600_hpd_sense,
-	.hpd_set_polarity = &r600_hpd_set_polarity,
-	.ioctl_wait_idle = r600_ioctl_wait_idle,
-};
-
 /*
  * rv770,rv730,rv710,rv740
  */
@@ -650,43 +278,6 @@
 int rv770_resume(struct radeon_device *rdev);
 int rv770_gpu_reset(struct radeon_device *rdev);
 
-static struct radeon_asic rv770_asic = {
-	.init = &rv770_init,
-	.fini = &rv770_fini,
-	.suspend = &rv770_suspend,
-	.resume = &rv770_resume,
-	.cp_commit = &r600_cp_commit,
-	.gpu_reset = &rv770_gpu_reset,
-	.vga_set_state = &r600_vga_set_state,
-	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
-	.gart_set_page = &rs600_gart_set_page,
-	.ring_test = &r600_ring_test,
-	.ring_ib_execute = &r600_ring_ib_execute,
-	.irq_set = &r600_irq_set,
-	.irq_process = &r600_irq_process,
-	.get_vblank_counter = &rs600_get_vblank_counter,
-	.fence_ring_emit = &r600_fence_ring_emit,
-	.cs_parse = &r600_cs_parse,
-	.copy_blit = &r600_copy_blit,
-	.copy_dma = &r600_copy_blit,
-	.copy = &r600_copy_blit,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.get_pcie_lanes = &rv370_get_pcie_lanes,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = &radeon_atom_set_clock_gating,
-	.set_surface_reg = r600_set_surface_reg,
-	.clear_surface_reg = r600_clear_surface_reg,
-	.bandwidth_update = &rv515_bandwidth_update,
-	.hpd_init = &r600_hpd_init,
-	.hpd_fini = &r600_hpd_fini,
-	.hpd_sense = &r600_hpd_sense,
-	.hpd_set_polarity = &r600_hpd_set_polarity,
-	.ioctl_wait_idle = r600_ioctl_wait_idle,
-};
-
 /*
  * evergreen
  */
@@ -701,40 +292,4 @@
 bool evergreen_hpd_sense(struct radeon_device *rdev, enum radeon_hpd_id hpd);
 void evergreen_hpd_set_polarity(struct radeon_device *rdev,
 				enum radeon_hpd_id hpd);
-
-static struct radeon_asic evergreen_asic = {
-	.init = &evergreen_init,
-	.fini = &evergreen_fini,
-	.suspend = &evergreen_suspend,
-	.resume = &evergreen_resume,
-	.cp_commit = NULL,
-	.gpu_reset = &evergreen_gpu_reset,
-	.vga_set_state = &r600_vga_set_state,
-	.gart_tlb_flush = &r600_pcie_gart_tlb_flush,
-	.gart_set_page = &rs600_gart_set_page,
-	.ring_test = NULL,
-	.ring_ib_execute = NULL,
-	.irq_set = NULL,
-	.irq_process = NULL,
-	.get_vblank_counter = NULL,
-	.fence_ring_emit = NULL,
-	.cs_parse = NULL,
-	.copy_blit = NULL,
-	.copy_dma = NULL,
-	.copy = NULL,
-	.get_engine_clock = &radeon_atom_get_engine_clock,
-	.set_engine_clock = &radeon_atom_set_engine_clock,
-	.get_memory_clock = &radeon_atom_get_memory_clock,
-	.set_memory_clock = &radeon_atom_set_memory_clock,
-	.set_pcie_lanes = NULL,
-	.set_clock_gating = NULL,
-	.set_surface_reg = r600_set_surface_reg,
-	.clear_surface_reg = r600_clear_surface_reg,
-	.bandwidth_update = &evergreen_bandwidth_update,
-	.hpd_init = &evergreen_hpd_init,
-	.hpd_fini = &evergreen_hpd_fini,
-	.hpd_sense = &evergreen_hpd_sense,
-	.hpd_set_polarity = &evergreen_hpd_set_polarity,
-};
-
 #endif
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_atombios.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_atombios.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_atombios.c	2010-04-13 02:18:55.705633098 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_atombios.c	2010-04-13 02:19:00.827633021 +0000
@@ -69,52 +69,54 @@
 	struct radeon_i2c_bus_rec i2c;
 	int index = GetIndexIntoMasterTable(DATA, GPIO_I2C_Info);
 	struct _ATOM_GPIO_I2C_INFO *i2c_info;
-	uint16_t data_offset;
-	int i;
+	uint16_t data_offset, size;
+	int i, num_indices;
 
 	memset(&i2c, 0, sizeof(struct radeon_i2c_bus_rec));
 	i2c.valid = false;
 
-	atom_parse_data_header(ctx, index, NULL, NULL, NULL, &data_offset);
-
-	i2c_info = (struct _ATOM_GPIO_I2C_INFO *)(ctx->bios + data_offset);
-
+	if (atom_parse_data_header(ctx, index, &size, NULL, NULL, &data_offset)) {
+		i2c_info = (struct _ATOM_GPIO_I2C_INFO *)(ctx->bios + data_offset);
 
-	for (i = 0; i < ATOM_MAX_SUPPORTED_DEVICE; i++) {
-		gpio = &i2c_info->asGPIO_Info[i];
+		num_indices = (size - sizeof(ATOM_COMMON_TABLE_HEADER)) /
+			sizeof(ATOM_GPIO_I2C_ASSIGMENT);
 
-		if (gpio->sucI2cId.ucAccess == id) {
-			i2c.mask_clk_reg = le16_to_cpu(gpio->usClkMaskRegisterIndex) * 4;
-			i2c.mask_data_reg = le16_to_cpu(gpio->usDataMaskRegisterIndex) * 4;
-			i2c.en_clk_reg = le16_to_cpu(gpio->usClkEnRegisterIndex) * 4;
-			i2c.en_data_reg = le16_to_cpu(gpio->usDataEnRegisterIndex) * 4;
-			i2c.y_clk_reg = le16_to_cpu(gpio->usClkY_RegisterIndex) * 4;
-			i2c.y_data_reg = le16_to_cpu(gpio->usDataY_RegisterIndex) * 4;
-			i2c.a_clk_reg = le16_to_cpu(gpio->usClkA_RegisterIndex) * 4;
-			i2c.a_data_reg = le16_to_cpu(gpio->usDataA_RegisterIndex) * 4;
-			i2c.mask_clk_mask = (1 << gpio->ucClkMaskShift);
-			i2c.mask_data_mask = (1 << gpio->ucDataMaskShift);
-			i2c.en_clk_mask = (1 << gpio->ucClkEnShift);
-			i2c.en_data_mask = (1 << gpio->ucDataEnShift);
-			i2c.y_clk_mask = (1 << gpio->ucClkY_Shift);
-			i2c.y_data_mask = (1 << gpio->ucDataY_Shift);
-			i2c.a_clk_mask = (1 << gpio->ucClkA_Shift);
-			i2c.a_data_mask = (1 << gpio->ucDataA_Shift);
+		for (i = 0; i < num_indices; i++) {
+			gpio = &i2c_info->asGPIO_Info[i];
 
-			if (gpio->sucI2cId.sbfAccess.bfHW_Capable)
-				i2c.hw_capable = true;
-			else
-				i2c.hw_capable = false;
-
-			if (gpio->sucI2cId.ucAccess == 0xa0)
-				i2c.mm_i2c = true;
-			else
-				i2c.mm_i2c = false;
+			if (gpio->sucI2cId.ucAccess == id) {
+				i2c.mask_clk_reg = le16_to_cpu(gpio->usClkMaskRegisterIndex) * 4;
+				i2c.mask_data_reg = le16_to_cpu(gpio->usDataMaskRegisterIndex) * 4;
+				i2c.en_clk_reg = le16_to_cpu(gpio->usClkEnRegisterIndex) * 4;
+				i2c.en_data_reg = le16_to_cpu(gpio->usDataEnRegisterIndex) * 4;
+				i2c.y_clk_reg = le16_to_cpu(gpio->usClkY_RegisterIndex) * 4;
+				i2c.y_data_reg = le16_to_cpu(gpio->usDataY_RegisterIndex) * 4;
+				i2c.a_clk_reg = le16_to_cpu(gpio->usClkA_RegisterIndex) * 4;
+				i2c.a_data_reg = le16_to_cpu(gpio->usDataA_RegisterIndex) * 4;
+				i2c.mask_clk_mask = (1 << gpio->ucClkMaskShift);
+				i2c.mask_data_mask = (1 << gpio->ucDataMaskShift);
+				i2c.en_clk_mask = (1 << gpio->ucClkEnShift);
+				i2c.en_data_mask = (1 << gpio->ucDataEnShift);
+				i2c.y_clk_mask = (1 << gpio->ucClkY_Shift);
+				i2c.y_data_mask = (1 << gpio->ucDataY_Shift);
+				i2c.a_clk_mask = (1 << gpio->ucClkA_Shift);
+				i2c.a_data_mask = (1 << gpio->ucDataA_Shift);
+
+				if (gpio->sucI2cId.sbfAccess.bfHW_Capable)
+					i2c.hw_capable = true;
+				else
+					i2c.hw_capable = false;
+
+				if (gpio->sucI2cId.ucAccess == 0xa0)
+					i2c.mm_i2c = true;
+				else
+					i2c.mm_i2c = false;
 
-			i2c.i2c_id = gpio->sucI2cId.ucAccess;
+				i2c.i2c_id = gpio->sucI2cId.ucAccess;
 
-			i2c.valid = true;
-			break;
+				i2c.valid = true;
+				break;
+			}
 		}
 	}
 
@@ -135,20 +137,21 @@
 	memset(&gpio, 0, sizeof(struct radeon_gpio_rec));
 	gpio.valid = false;
 
-	atom_parse_data_header(ctx, index, &size, NULL, NULL, &data_offset);
-
-	gpio_info = (struct _ATOM_GPIO_PIN_LUT *)(ctx->bios + data_offset);
+	if (atom_parse_data_header(ctx, index, &size, NULL, NULL, &data_offset)) {
+		gpio_info = (struct _ATOM_GPIO_PIN_LUT *)(ctx->bios + data_offset);
 
-	num_indices = (size - sizeof(ATOM_COMMON_TABLE_HEADER)) / sizeof(ATOM_GPIO_PIN_ASSIGNMENT);
+		num_indices = (size - sizeof(ATOM_COMMON_TABLE_HEADER)) /
+			sizeof(ATOM_GPIO_PIN_ASSIGNMENT);
 
-	for (i = 0; i < num_indices; i++) {
-		pin = &gpio_info->asGPIO_Pin[i];
-		if (id == pin->ucGPIO_ID) {
-			gpio.id = pin->ucGPIO_ID;
-			gpio.reg = pin->usGpioPin_AIndex * 4;
-			gpio.mask = (1 << pin->ucGpioPinBitShift);
-			gpio.valid = true;
-			break;
+		for (i = 0; i < num_indices; i++) {
+			pin = &gpio_info->asGPIO_Pin[i];
+			if (id == pin->ucGPIO_ID) {
+				gpio.id = pin->ucGPIO_ID;
+				gpio.reg = pin->usGpioPin_AIndex * 4;
+				gpio.mask = (1 << pin->ucGpioPinBitShift);
+				gpio.valid = true;
+				break;
+			}
 		}
 	}
 
@@ -264,6 +267,8 @@
 		if ((supported_device == ATOM_DEVICE_CRT1_SUPPORT) ||
 		    (supported_device == ATOM_DEVICE_DFP2_SUPPORT))
 			return false;
+		if (supported_device == ATOM_DEVICE_CRT2_SUPPORT)
+			*line_mux = 0x90;
 	}
 
 	/* ASUS HD 3600 XT board lists the DVI port as HDMI */
@@ -395,9 +400,7 @@
 	struct radeon_gpio_rec gpio;
 	struct radeon_hpd hpd;
 
-	atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset);
-
-	if (data_offset == 0)
+	if (!atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset))
 		return false;
 
 	if (crev < 2)
@@ -449,37 +452,43 @@
 				    GetIndexIntoMasterTable(DATA,
 							    IntegratedSystemInfo);
 
-				atom_parse_data_header(ctx, index, &size, &frev,
-						       &crev, &igp_offset);
+				if (atom_parse_data_header(ctx, index, &size, &frev,
+							   &crev, &igp_offset)) {
 
-				if (crev >= 2) {
-					igp_obj =
-					    (ATOM_INTEGRATED_SYSTEM_INFO_V2
-					     *) (ctx->bios + igp_offset);
-
-					if (igp_obj) {
-						uint32_t slot_config, ct;
-
-						if (con_obj_num == 1)
-							slot_config =
-							    igp_obj->
-							    ulDDISlot1Config;
-						else
-							slot_config =
-							    igp_obj->
-							    ulDDISlot2Config;
-
-						ct = (slot_config >> 16) & 0xff;
-						connector_type =
-						    object_connector_convert
-						    [ct];
-						connector_object_id = ct;
-						igp_lane_info =
-						    slot_config & 0xffff;
+					if (crev >= 2) {
+						igp_obj =
+							(ATOM_INTEGRATED_SYSTEM_INFO_V2
+							 *) (ctx->bios + igp_offset);
+
+						if (igp_obj) {
+							uint32_t slot_config, ct;
+
+							if (con_obj_num == 1)
+								slot_config =
+									igp_obj->
+									ulDDISlot1Config;
+							else
+								slot_config =
+									igp_obj->
+									ulDDISlot2Config;
+
+							ct = (slot_config >> 16) & 0xff;
+							connector_type =
+								object_connector_convert
+								[ct];
+							connector_object_id = ct;
+							igp_lane_info =
+								slot_config & 0xffff;
+						} else
+							continue;
 					} else
 						continue;
-				} else
-					continue;
+				} else {
+					igp_lane_info = 0;
+					connector_type =
+						object_connector_convert[con_obj_id];
+					connector_object_id = con_obj_id;
+				}
 			} else {
 				igp_lane_info = 0;
 				connector_type =
@@ -627,20 +636,23 @@
 		uint8_t frev, crev;
 		ATOM_XTMDS_INFO *xtmds;
 
-		atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset);
-		xtmds = (ATOM_XTMDS_INFO *)(ctx->bios + data_offset);
+		if (atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset)) {
+			xtmds = (ATOM_XTMDS_INFO *)(ctx->bios + data_offset);
 
-		if (xtmds->ucSupportedLink & ATOM_XTMDS_SUPPORTED_DUALLINK) {
-			if (connector_type == DRM_MODE_CONNECTOR_DVII)
-				return CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I;
-			else
-				return CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D;
-		} else {
-			if (connector_type == DRM_MODE_CONNECTOR_DVII)
-				return CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;
-			else
-				return CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D;
-		}
+			if (xtmds->ucSupportedLink & ATOM_XTMDS_SUPPORTED_DUALLINK) {
+				if (connector_type == DRM_MODE_CONNECTOR_DVII)
+					return CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I;
+				else
+					return CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D;
+			} else {
+				if (connector_type == DRM_MODE_CONNECTOR_DVII)
+					return CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;
+				else
+					return CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D;
+			}
+		} else
+			return supported_devices_connector_object_id_convert
+				[connector_type];
 	} else {
 		return supported_devices_connector_object_id_convert
 			[connector_type];
@@ -672,7 +684,8 @@
 	int i, j, max_device;
 	struct bios_connector bios_connectors[ATOM_MAX_SUPPORTED_DEVICE];
 
-	atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset);
+	if (!atom_parse_data_header(ctx, index, &size, &frev, &crev, &data_offset))
+		return false;
 
 	supported_devices =
 	    (union atom_supported_devices *)(ctx->bios + data_offset);
@@ -865,14 +878,11 @@
 	struct radeon_pll *mpll = &rdev->clock.mpll;
 	uint16_t data_offset;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev,
-			       &crev, &data_offset);
-
-	firmware_info =
-	    (union firmware_info *)(mode_info->atom_context->bios +
-				    data_offset);
-
-	if (firmware_info) {
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		firmware_info =
+			(union firmware_info *)(mode_info->atom_context->bios +
+						data_offset);
 		/* pixel clocks */
 		p1pll->reference_freq =
 		    le16_to_cpu(firmware_info->info.usReferenceClock);
@@ -887,6 +897,20 @@
 		p1pll->pll_out_max =
 		    le32_to_cpu(firmware_info->info.ulMaxPixelClockPLL_Output);
 
+		if (crev >= 4) {
+			p1pll->lcd_pll_out_min =
+				le16_to_cpu(firmware_info->info_14.usLcdMinPixelClockPLL_Output) * 100;
+			if (p1pll->lcd_pll_out_min == 0)
+				p1pll->lcd_pll_out_min = p1pll->pll_out_min;
+			p1pll->lcd_pll_out_max =
+				le16_to_cpu(firmware_info->info_14.usLcdMaxPixelClockPLL_Output) * 100;
+			if (p1pll->lcd_pll_out_max == 0)
+				p1pll->lcd_pll_out_max = p1pll->pll_out_max;
+		} else {
+			p1pll->lcd_pll_out_min = p1pll->pll_out_min;
+			p1pll->lcd_pll_out_max = p1pll->pll_out_max;
+		}
+
 		if (p1pll->pll_out_min == 0) {
 			if (ASIC_IS_AVIVO(rdev))
 				p1pll->pll_out_min = 64800;
@@ -992,13 +1016,10 @@
 	u8 frev, crev;
 	u16 data_offset;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev,
-			       &crev, &data_offset);
-
-	igp_info = (union igp_info *)(mode_info->atom_context->bios +
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		igp_info = (union igp_info *)(mode_info->atom_context->bios +
 				      data_offset);
-
-	if (igp_info) {
 		switch (crev) {
 		case 1:
 			if (igp_info->info.ucMemoryType & 0xf0)
@@ -1029,14 +1050,12 @@
 	uint16_t maxfreq;
 	int i;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev,
-			       &crev, &data_offset);
-
-	tmds_info =
-	    (struct _ATOM_TMDS_INFO *)(mode_info->atom_context->bios +
-				       data_offset);
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		tmds_info =
+			(struct _ATOM_TMDS_INFO *)(mode_info->atom_context->bios +
+						   data_offset);
 
-	if (tmds_info) {
 		maxfreq = le16_to_cpu(tmds_info->usMaxFrequency);
 		for (i = 0; i < 4; i++) {
 			tmds->tmds_pll[i].freq =
@@ -1085,13 +1104,11 @@
 	if (id > ATOM_MAX_SS_ENTRY)
 		return NULL;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev,
-			       &crev, &data_offset);
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		ss_info =
+			(struct _ATOM_SPREAD_SPECTRUM_INFO *)(mode_info->atom_context->bios + data_offset);
 
-	ss_info =
-	    (struct _ATOM_SPREAD_SPECTRUM_INFO *)(mode_info->atom_context->bios + data_offset);
-
-	if (ss_info) {
 		ss =
 		    kzalloc(sizeof(struct radeon_atom_ss), GFP_KERNEL);
 
@@ -1114,30 +1131,6 @@
 	return ss;
 }
 
-static void radeon_atom_apply_lvds_quirks(struct drm_device *dev,
-					  struct radeon_encoder_atom_dig *lvds)
-{
-
-	/* Toshiba A300-1BU laptop panel doesn't like new pll divider algo */
-	if ((dev->pdev->device == 0x95c4) &&
-	    (dev->pdev->subsystem_vendor == 0x1179) &&
-	    (dev->pdev->subsystem_device == 0xff50)) {
-		if ((lvds->native_mode.hdisplay == 1280) &&
-		    (lvds->native_mode.vdisplay == 800))
-			lvds->pll_algo = PLL_ALGO_LEGACY;
-	}
-
-	/* Dell Studio 15 laptop panel doesn't like new pll divider algo */
-	if ((dev->pdev->device == 0x95c4) &&
-	    (dev->pdev->subsystem_vendor == 0x1028) &&
-	    (dev->pdev->subsystem_device == 0x029f)) {
-		if ((lvds->native_mode.hdisplay == 1280) &&
-		    (lvds->native_mode.vdisplay == 800))
-			lvds->pll_algo = PLL_ALGO_LEGACY;
-	}
-
-}
-
 union lvds_info {
 	struct _ATOM_LVDS_INFO info;
 	struct _ATOM_LVDS_INFO_V12 info_12;
@@ -1156,13 +1149,10 @@
 	uint8_t frev, crev;
 	struct radeon_encoder_atom_dig *lvds = NULL;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev,
-			       &crev, &data_offset);
-
-	lvds_info =
-	    (union lvds_info *)(mode_info->atom_context->bios + data_offset);
-
-	if (lvds_info) {
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		lvds_info =
+			(union lvds_info *)(mode_info->atom_context->bios + data_offset);
 		lvds =
 		    kzalloc(sizeof(struct radeon_encoder_atom_dig), GFP_KERNEL);
 
@@ -1220,9 +1210,6 @@
 				lvds->pll_algo = PLL_ALGO_LEGACY;
 		}
 
-		/* LVDS quirks */
-		radeon_atom_apply_lvds_quirks(dev, lvds);
-
 		encoder->native_mode = lvds->native_mode;
 	}
 	return lvds;
@@ -1241,11 +1228,11 @@
 	uint8_t bg, dac;
 	struct radeon_encoder_primary_dac *p_dac = NULL;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev, &crev, &data_offset);
-
-	dac_info = (struct _COMPASSIONATE_DATA *)(mode_info->atom_context->bios + data_offset);
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		dac_info = (struct _COMPASSIONATE_DATA *)
+			(mode_info->atom_context->bios + data_offset);
 
-	if (dac_info) {
 		p_dac = kzalloc(sizeof(struct radeon_encoder_primary_dac), GFP_KERNEL);
 
 		if (!p_dac)
@@ -1270,7 +1257,9 @@
 	u8 frev, crev;
 	u16 data_offset, misc;
 
-	atom_parse_data_header(mode_info->atom_context, data_index, NULL, &frev, &crev, &data_offset);
+	if (!atom_parse_data_header(mode_info->atom_context, data_index, NULL,
+				    &frev, &crev, &data_offset))
+		return false;
 
 	switch (crev) {
 	case 1:
@@ -1362,47 +1351,50 @@
 	struct _ATOM_ANALOG_TV_INFO *tv_info;
 	enum radeon_tv_std tv_std = TV_STD_NTSC;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev, &crev, &data_offset);
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
 
-	tv_info = (struct _ATOM_ANALOG_TV_INFO *)(mode_info->atom_context->bios + data_offset);
+		tv_info = (struct _ATOM_ANALOG_TV_INFO *)
+			(mode_info->atom_context->bios + data_offset);
 
-	switch (tv_info->ucTV_BootUpDefaultStandard) {
-	case ATOM_TV_NTSC:
-		tv_std = TV_STD_NTSC;
-		DRM_INFO("Default TV standard: NTSC\n");
-		break;
-	case ATOM_TV_NTSCJ:
-		tv_std = TV_STD_NTSC_J;
-		DRM_INFO("Default TV standard: NTSC-J\n");
-		break;
-	case ATOM_TV_PAL:
-		tv_std = TV_STD_PAL;
-		DRM_INFO("Default TV standard: PAL\n");
-		break;
-	case ATOM_TV_PALM:
-		tv_std = TV_STD_PAL_M;
-		DRM_INFO("Default TV standard: PAL-M\n");
-		break;
-	case ATOM_TV_PALN:
-		tv_std = TV_STD_PAL_N;
-		DRM_INFO("Default TV standard: PAL-N\n");
-		break;
-	case ATOM_TV_PALCN:
-		tv_std = TV_STD_PAL_CN;
-		DRM_INFO("Default TV standard: PAL-CN\n");
-		break;
-	case ATOM_TV_PAL60:
-		tv_std = TV_STD_PAL_60;
-		DRM_INFO("Default TV standard: PAL-60\n");
-		break;
-	case ATOM_TV_SECAM:
-		tv_std = TV_STD_SECAM;
-		DRM_INFO("Default TV standard: SECAM\n");
-		break;
-	default:
-		tv_std = TV_STD_NTSC;
-		DRM_INFO("Unknown TV standard; defaulting to NTSC\n");
-		break;
+		switch (tv_info->ucTV_BootUpDefaultStandard) {
+		case ATOM_TV_NTSC:
+			tv_std = TV_STD_NTSC;
+			DRM_INFO("Default TV standard: NTSC\n");
+			break;
+		case ATOM_TV_NTSCJ:
+			tv_std = TV_STD_NTSC_J;
+			DRM_INFO("Default TV standard: NTSC-J\n");
+			break;
+		case ATOM_TV_PAL:
+			tv_std = TV_STD_PAL;
+			DRM_INFO("Default TV standard: PAL\n");
+			break;
+		case ATOM_TV_PALM:
+			tv_std = TV_STD_PAL_M;
+			DRM_INFO("Default TV standard: PAL-M\n");
+			break;
+		case ATOM_TV_PALN:
+			tv_std = TV_STD_PAL_N;
+			DRM_INFO("Default TV standard: PAL-N\n");
+			break;
+		case ATOM_TV_PALCN:
+			tv_std = TV_STD_PAL_CN;
+			DRM_INFO("Default TV standard: PAL-CN\n");
+			break;
+		case ATOM_TV_PAL60:
+			tv_std = TV_STD_PAL_60;
+			DRM_INFO("Default TV standard: PAL-60\n");
+			break;
+		case ATOM_TV_SECAM:
+			tv_std = TV_STD_SECAM;
+			DRM_INFO("Default TV standard: SECAM\n");
+			break;
+		default:
+			tv_std = TV_STD_NTSC;
+			DRM_INFO("Unknown TV standard; defaulting to NTSC\n");
+			break;
+		}
 	}
 	return tv_std;
 }
@@ -1420,11 +1412,12 @@
 	uint8_t bg, dac;
 	struct radeon_encoder_tv_dac *tv_dac = NULL;
 
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev, &crev, &data_offset);
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
 
-	dac_info = (struct _COMPASSIONATE_DATA *)(mode_info->atom_context->bios + data_offset);
+		dac_info = (struct _COMPASSIONATE_DATA *)
+			(mode_info->atom_context->bios + data_offset);
 
-	if (dac_info) {
 		tv_dac = kzalloc(sizeof(struct radeon_encoder_tv_dac), GFP_KERNEL);
 
 		if (!tv_dac)
@@ -1447,6 +1440,30 @@
 	return tv_dac;
 }
 
+static const char *thermal_controller_names[] = {
+	"NONE",
+	"LM63",
+	"ADM1032",
+	"ADM1030",
+	"MUA6649",
+	"LM64",
+	"F75375",
+	"ASC7512",
+};
+
+static const char *pp_lib_thermal_controller_names[] = {
+	"NONE",
+	"LM63",
+	"ADM1032",
+	"ADM1030",
+	"MUA6649",
+	"LM64",
+	"F75375",
+	"RV6xx",
+	"RV770",
+	"ADT7473",
+};
+
 union power_info {
 	struct _ATOM_POWERPLAY_INFO info;
 	struct _ATOM_POWERPLAY_INFO_V2 info_2;
@@ -1466,15 +1483,22 @@
 	struct _ATOM_PPLIB_STATE *power_state;
 	int num_modes = 0, i, j;
 	int state_index = 0, mode_index = 0;
-
-	atom_parse_data_header(mode_info->atom_context, index, NULL, &frev, &crev, &data_offset);
-
-	power_info = (union power_info *)(mode_info->atom_context->bios + data_offset);
+	struct radeon_i2c_bus_rec i2c_bus;
 
 	rdev->pm.default_power_state = NULL;
 
-	if (power_info) {
+	if (atom_parse_data_header(mode_info->atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		power_info = (union power_info *)(mode_info->atom_context->bios + data_offset);
 		if (frev < 4) {
+			/* add the i2c bus for thermal/fan chip */
+			if (power_info->info.ucOverdriveThermalController > 0) {
+				DRM_INFO("Possible %s thermal controller at 0x%02x\n",
+					 thermal_controller_names[power_info->info.ucOverdriveThermalController],
+					 power_info->info.ucOverdriveControllerAddress >> 1);
+				i2c_bus = radeon_lookup_i2c_gpio(rdev, power_info->info.ucOverdriveI2cLine);
+				rdev->pm.i2c_bus = radeon_i2c_create(rdev->ddev, &i2c_bus, "Thermal");
+			}
 			num_modes = power_info->info.ucNumOfPowerModeEntries;
 			if (num_modes > ATOM_MAX_NUMBEROF_POWER_BLOCK)
 				num_modes = ATOM_MAX_NUMBEROF_POWER_BLOCK;
@@ -1684,6 +1708,24 @@
 				}
 			}
 		} else if (frev == 4) {
+			/* add the i2c bus for thermal/fan chip */
+			/* no support for internal controller yet */
+			if (power_info->info_4.sThermalController.ucType > 0) {
+				if ((power_info->info_4.sThermalController.ucType == ATOM_PP_THERMALCONTROLLER_RV6xx) ||
+				    (power_info->info_4.sThermalController.ucType == ATOM_PP_THERMALCONTROLLER_RV770)) {
+					DRM_INFO("Internal thermal controller %s fan control\n",
+						 (power_info->info_4.sThermalController.ucFanParameters &
+						  ATOM_PP_FANPARAMETERS_NOFAN) ? "without" : "with");
+				} else {
+					DRM_INFO("Possible %s thermal controller at 0x%02x %s fan control\n",
+						 pp_lib_thermal_controller_names[power_info->info_4.sThermalController.ucType],
+						 power_info->info_4.sThermalController.ucI2cAddress >> 1,
+						 (power_info->info_4.sThermalController.ucFanParameters &
+						  ATOM_PP_FANPARAMETERS_NOFAN) ? "without" : "with");
+					i2c_bus = radeon_lookup_i2c_gpio(rdev, power_info->info_4.sThermalController.ucI2cLine);
+					rdev->pm.i2c_bus = radeon_i2c_create(rdev->ddev, &i2c_bus, "Thermal");
+				}
+			}
 			for (i = 0; i < power_info->info_4.ucNumStates; i++) {
 				mode_index = 0;
 				power_state = (struct _ATOM_PPLIB_STATE *)
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_atpx_handler.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_atpx_handler.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_atpx_handler.c	2010-04-13 02:18:55.705633098 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_atpx_handler.c	2010-04-13 02:19:00.827633021 +0000
@@ -7,6 +7,7 @@
  * ATPX support for both Intel/ATI
  */
 #include <linux/vga_switcheroo.h>
+#include <linux/slab.h>
 #include <acpi/acpi.h>
 #include <acpi/acpi_bus.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_bios.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_bios.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_bios.c	2010-04-13 02:18:55.705633098 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_bios.c	2010-04-13 02:19:00.827633021 +0000
@@ -31,6 +31,7 @@
 #include "atom.h"
 
 #include <linux/vga_switcheroo.h>
+#include <linux/slab.h>
 /*
  * BIOS.
  */
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_combios.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_combios.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_combios.c	2010-04-13 02:18:55.706633091 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_combios.c	2010-04-13 02:19:00.828633056 +0000
@@ -531,10 +531,7 @@
 	case CHIP_RS300:
 		switch (ddc_line) {
 		case RADEON_GPIO_DVI_DDC:
-			/* in theory this should be hw capable,
-			 * but it doesn't seem to work
-			 */
-			i2c.hw_capable = false;
+			i2c.hw_capable = true;
 			break;
 		default:
 			i2c.hw_capable = false;
@@ -633,6 +630,8 @@
 		p1pll->reference_div = RBIOS16(pll_info + 0x10);
 		p1pll->pll_out_min = RBIOS32(pll_info + 0x12);
 		p1pll->pll_out_max = RBIOS32(pll_info + 0x16);
+		p1pll->lcd_pll_out_min = p1pll->pll_out_min;
+		p1pll->lcd_pll_out_max = p1pll->pll_out_max;
 
 		if (rev > 9) {
 			p1pll->pll_in_min = RBIOS32(pll_info + 0x36);
@@ -761,7 +760,9 @@
 			dac = RBIOS8(dac_info + 0x3) & 0xf;
 			p_dac->ps2_pdac_adj = (bg << 8) | (dac);
 		}
-		found = 1;
+		/* if the values are all zeros, use the table */
+		if (p_dac->ps2_pdac_adj)
+			found = 1;
 	}
 
 	if (!found) /* fallback to defaults */
@@ -896,7 +897,9 @@
 			bg = RBIOS8(dac_info + 0x10) & 0xf;
 			dac = RBIOS8(dac_info + 0x11) & 0xf;
 			tv_dac->ntsc_tvdac_adj = (bg << 16) | (dac << 20);
-			found = 1;
+			/* if the values are all zeros, use the table */
+			if (tv_dac->ps2_tvdac_adj)
+				found = 1;
 		} else if (rev > 1) {
 			bg = RBIOS8(dac_info + 0xc) & 0xf;
 			dac = (RBIOS8(dac_info + 0xc) >> 4) & 0xf;
@@ -909,7 +912,9 @@
 			bg = RBIOS8(dac_info + 0xe) & 0xf;
 			dac = (RBIOS8(dac_info + 0xe) >> 4) & 0xf;
 			tv_dac->ntsc_tvdac_adj = (bg << 16) | (dac << 20);
-			found = 1;
+			/* if the values are all zeros, use the table */
+			if (tv_dac->ps2_tvdac_adj)
+				found = 1;
 		}
 		tv_dac->tv_std = radeon_combios_get_tv_info(rdev);
 	}
@@ -926,7 +931,9 @@
 				    (bg << 16) | (dac << 20);
 				tv_dac->pal_tvdac_adj = tv_dac->ps2_tvdac_adj;
 				tv_dac->ntsc_tvdac_adj = tv_dac->ps2_tvdac_adj;
-				found = 1;
+				/* if the values are all zeros, use the table */
+				if (tv_dac->ps2_tvdac_adj)
+					found = 1;
 			} else {
 				bg = RBIOS8(dac_info + 0x4) & 0xf;
 				dac = RBIOS8(dac_info + 0x5) & 0xf;
@@ -934,7 +941,9 @@
 				    (bg << 16) | (dac << 20);
 				tv_dac->pal_tvdac_adj = tv_dac->ps2_tvdac_adj;
 				tv_dac->ntsc_tvdac_adj = tv_dac->ps2_tvdac_adj;
-				found = 1;
+				/* if the values are all zeros, use the table */
+				if (tv_dac->ps2_tvdac_adj)
+					found = 1;
 			}
 		} else {
 			DRM_INFO("No TV DAC info found in BIOS\n");
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_connectors.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_connectors.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_connectors.c	2010-04-13 02:18:55.706633091 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_connectors.c	2010-04-13 02:19:00.828633056 +0000
@@ -315,7 +315,7 @@
 		radeon_encoder = to_radeon_encoder(encoder);
 		if (!radeon_encoder->enc_priv)
 			return 0;
-		if (rdev->is_atom_bios) {
+		if (ASIC_IS_AVIVO(rdev) || radeon_r4xx_atom) {
 			struct radeon_encoder_atom_dac *dac_int;
 			dac_int = radeon_encoder->enc_priv;
 			dac_int->tv_std = val;
@@ -940,7 +940,7 @@
 	if (radeon_connector->edid)
 		kfree(radeon_connector->edid);
 	if (radeon_dig_connector->dp_i2c_bus)
-		radeon_i2c_destroy_dp(radeon_dig_connector->dp_i2c_bus);
+		radeon_i2c_destroy(radeon_dig_connector->dp_i2c_bus);
 	kfree(radeon_connector->con_priv);
 	drm_sysfs_connector_remove(connector);
 	drm_connector_cleanup(connector);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_cp.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_cp.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_cp.c	2010-04-13 02:18:55.707633076 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_cp.c	2010-04-13 02:19:00.829633076 +0000
@@ -417,8 +417,9 @@
 	return -EBUSY;
 }
 
-static void radeon_init_pipes(drm_radeon_private_t *dev_priv)
+static void radeon_init_pipes(struct drm_device *dev)
 {
+	drm_radeon_private_t *dev_priv = dev->dev_private;
 	uint32_t gb_tile_config, gb_pipe_sel = 0;
 
 	if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV530) {
@@ -436,11 +437,12 @@
 		dev_priv->num_gb_pipes = ((gb_pipe_sel >> 12) & 0x3) + 1;
 	} else {
 		/* R3xx */
-		if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R300) ||
+		if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R300 &&
+		     dev->pdev->device != 0x4144) ||
 		    ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R350)) {
 			dev_priv->num_gb_pipes = 2;
 		} else {
-			/* R3Vxx */
+			/* RV3xx/R300 AD */
 			dev_priv->num_gb_pipes = 1;
 		}
 	}
@@ -736,7 +738,7 @@
 
 	/* setup the raster pipes */
 	if ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R300)
-	    radeon_init_pipes(dev_priv);
+	    radeon_init_pipes(dev);
 
 	/* Reset the CP ring */
 	radeon_do_cp_reset(dev_priv);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_cs.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_cs.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_cs.c	2010-04-13 02:18:55.707633076 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_cs.c	2010-04-13 02:19:00.829633076 +0000
@@ -193,9 +193,11 @@
 		radeon_bo_list_fence(&parser->validated, parser->ib->fence);
 	}
 	radeon_bo_list_unreserve(&parser->validated);
-	for (i = 0; i < parser->nrelocs; i++) {
-		if (parser->relocs[i].gobj)
-			drm_gem_object_unreference_unlocked(parser->relocs[i].gobj);
+	if (parser->relocs != NULL) {
+		for (i = 0; i < parser->nrelocs; i++) {
+			if (parser->relocs[i].gobj)
+				drm_gem_object_unreference_unlocked(parser->relocs[i].gobj);
+		}
 	}
 	kfree(parser->track);
 	kfree(parser->relocs);
@@ -243,7 +245,8 @@
 	}
 	r = radeon_cs_parser_relocs(&parser);
 	if (r) {
-		DRM_ERROR("Failed to parse relocation !\n");
+		if (r != -ERESTARTSYS)
+			DRM_ERROR("Failed to parse relocation %d!\n", r);
 		radeon_cs_parser_fini(&parser, r);
 		mutex_unlock(&rdev->cs_mutex);
 		return r;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_device.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_device.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_device.c	2010-04-13 02:18:55.707633076 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_device.c	2010-04-13 02:19:00.829633076 +0000
@@ -26,6 +26,7 @@
  *          Jerome Glisse
  */
 #include <linux/console.h>
+#include <linux/slab.h>
 #include <drm/drmP.h>
 #include <drm/drm_crtc_helper.h>
 #include <drm/radeon_drm.h>
@@ -33,7 +34,6 @@
 #include <linux/vga_switcheroo.h>
 #include "radeon_reg.h"
 #include "radeon.h"
-#include "radeon_asic.h"
 #include "atom.h"
 
 /*
@@ -242,6 +242,36 @@
 
 }
 
+void radeon_update_bandwidth_info(struct radeon_device *rdev)
+{
+	fixed20_12 a;
+	u32 sclk, mclk;
+
+	if (rdev->flags & RADEON_IS_IGP) {
+		sclk = radeon_get_engine_clock(rdev);
+		mclk = rdev->clock.default_mclk;
+
+		a.full = rfixed_const(100);
+		rdev->pm.sclk.full = rfixed_const(sclk);
+		rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+		rdev->pm.mclk.full = rfixed_const(mclk);
+		rdev->pm.mclk.full = rfixed_div(rdev->pm.mclk, a);
+
+		a.full = rfixed_const(16);
+		/* core_bandwidth = sclk(Mhz) * 16 */
+		rdev->pm.core_bandwidth.full = rfixed_div(rdev->pm.sclk, a);
+	} else {
+		sclk = radeon_get_engine_clock(rdev);
+		mclk = radeon_get_memory_clock(rdev);
+
+		a.full = rfixed_const(100);
+		rdev->pm.sclk.full = rfixed_const(sclk);
+		rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+		rdev->pm.mclk.full = rfixed_const(mclk);
+		rdev->pm.mclk.full = rfixed_div(rdev->pm.mclk, a);
+	}
+}
+
 bool radeon_boot_test_post_card(struct radeon_device *rdev)
 {
 	if (radeon_card_posted(rdev))
@@ -288,181 +318,6 @@
 }
 
 
-/*
- * Registers accessors functions.
- */
-uint32_t radeon_invalid_rreg(struct radeon_device *rdev, uint32_t reg)
-{
-	DRM_ERROR("Invalid callback to read register 0x%04X\n", reg);
-	BUG_ON(1);
-	return 0;
-}
-
-void radeon_invalid_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v)
-{
-	DRM_ERROR("Invalid callback to write register 0x%04X with 0x%08X\n",
-		  reg, v);
-	BUG_ON(1);
-}
-
-void radeon_register_accessor_init(struct radeon_device *rdev)
-{
-	rdev->mc_rreg = &radeon_invalid_rreg;
-	rdev->mc_wreg = &radeon_invalid_wreg;
-	rdev->pll_rreg = &radeon_invalid_rreg;
-	rdev->pll_wreg = &radeon_invalid_wreg;
-	rdev->pciep_rreg = &radeon_invalid_rreg;
-	rdev->pciep_wreg = &radeon_invalid_wreg;
-
-	/* Don't change order as we are overridding accessor. */
-	if (rdev->family < CHIP_RV515) {
-		rdev->pcie_reg_mask = 0xff;
-	} else {
-		rdev->pcie_reg_mask = 0x7ff;
-	}
-	/* FIXME: not sure here */
-	if (rdev->family <= CHIP_R580) {
-		rdev->pll_rreg = &r100_pll_rreg;
-		rdev->pll_wreg = &r100_pll_wreg;
-	}
-	if (rdev->family >= CHIP_R420) {
-		rdev->mc_rreg = &r420_mc_rreg;
-		rdev->mc_wreg = &r420_mc_wreg;
-	}
-	if (rdev->family >= CHIP_RV515) {
-		rdev->mc_rreg = &rv515_mc_rreg;
-		rdev->mc_wreg = &rv515_mc_wreg;
-	}
-	if (rdev->family == CHIP_RS400 || rdev->family == CHIP_RS480) {
-		rdev->mc_rreg = &rs400_mc_rreg;
-		rdev->mc_wreg = &rs400_mc_wreg;
-	}
-	if (rdev->family == CHIP_RS690 || rdev->family == CHIP_RS740) {
-		rdev->mc_rreg = &rs690_mc_rreg;
-		rdev->mc_wreg = &rs690_mc_wreg;
-	}
-	if (rdev->family == CHIP_RS600) {
-		rdev->mc_rreg = &rs600_mc_rreg;
-		rdev->mc_wreg = &rs600_mc_wreg;
-	}
-	if ((rdev->family >= CHIP_R600) && (rdev->family <= CHIP_RV740)) {
-		rdev->pciep_rreg = &r600_pciep_rreg;
-		rdev->pciep_wreg = &r600_pciep_wreg;
-	}
-}
-
-
-/*
- * ASIC
- */
-int radeon_asic_init(struct radeon_device *rdev)
-{
-	radeon_register_accessor_init(rdev);
-	switch (rdev->family) {
-	case CHIP_R100:
-	case CHIP_RV100:
-	case CHIP_RS100:
-	case CHIP_RV200:
-	case CHIP_RS200:
-		rdev->asic = &r100_asic;
-		break;
-	case CHIP_R200:
-	case CHIP_RV250:
-	case CHIP_RS300:
-	case CHIP_RV280:
-		rdev->asic = &r200_asic;
-		break;
-	case CHIP_R300:
-	case CHIP_R350:
-	case CHIP_RV350:
-	case CHIP_RV380:
-		if (rdev->flags & RADEON_IS_PCIE)
-			rdev->asic = &r300_asic_pcie;
-		else
-			rdev->asic = &r300_asic;
-		break;
-	case CHIP_R420:
-	case CHIP_R423:
-	case CHIP_RV410:
-		rdev->asic = &r420_asic;
-		break;
-	case CHIP_RS400:
-	case CHIP_RS480:
-		rdev->asic = &rs400_asic;
-		break;
-	case CHIP_RS600:
-		rdev->asic = &rs600_asic;
-		break;
-	case CHIP_RS690:
-	case CHIP_RS740:
-		rdev->asic = &rs690_asic;
-		break;
-	case CHIP_RV515:
-		rdev->asic = &rv515_asic;
-		break;
-	case CHIP_R520:
-	case CHIP_RV530:
-	case CHIP_RV560:
-	case CHIP_RV570:
-	case CHIP_R580:
-		rdev->asic = &r520_asic;
-		break;
-	case CHIP_R600:
-	case CHIP_RV610:
-	case CHIP_RV630:
-	case CHIP_RV620:
-	case CHIP_RV635:
-	case CHIP_RV670:
-	case CHIP_RS780:
-	case CHIP_RS880:
-		rdev->asic = &r600_asic;
-		break;
-	case CHIP_RV770:
-	case CHIP_RV730:
-	case CHIP_RV710:
-	case CHIP_RV740:
-		rdev->asic = &rv770_asic;
-		break;
-	case CHIP_CEDAR:
-	case CHIP_REDWOOD:
-	case CHIP_JUNIPER:
-	case CHIP_CYPRESS:
-	case CHIP_HEMLOCK:
-		rdev->asic = &evergreen_asic;
-		break;
-	default:
-		/* FIXME: not supported yet */
-		return -EINVAL;
-	}
-
-	if (rdev->flags & RADEON_IS_IGP) {
-		rdev->asic->get_memory_clock = NULL;
-		rdev->asic->set_memory_clock = NULL;
-	}
-
-	return 0;
-}
-
-
-/*
- * Wrapper around modesetting bits.
- */
-int radeon_clocks_init(struct radeon_device *rdev)
-{
-	int r;
-
-	r = radeon_static_clocks_init(rdev->ddev);
-	if (r) {
-		return r;
-	}
-	DRM_INFO("Clocks initialized !\n");
-	return 0;
-}
-
-void radeon_clocks_fini(struct radeon_device *rdev)
-{
-}
-
 /* ATOM accessor methods */
 static uint32_t cail_pll_read(struct card_info *info, uint32_t reg)
 {
@@ -567,29 +422,6 @@
 		return VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM;
 }
 
-void radeon_agp_disable(struct radeon_device *rdev)
-{
-	rdev->flags &= ~RADEON_IS_AGP;
-	if (rdev->family >= CHIP_R600) {
-		DRM_INFO("Forcing AGP to PCIE mode\n");
-		rdev->flags |= RADEON_IS_PCIE;
-	} else if (rdev->family >= CHIP_RV515 ||
-			rdev->family == CHIP_RV380 ||
-			rdev->family == CHIP_RV410 ||
-			rdev->family == CHIP_R423) {
-		DRM_INFO("Forcing AGP to PCIE mode\n");
-		rdev->flags |= RADEON_IS_PCIE;
-		rdev->asic->gart_tlb_flush = &rv370_pcie_gart_tlb_flush;
-		rdev->asic->gart_set_page = &rv370_pcie_gart_set_page;
-	} else {
-		DRM_INFO("Forcing AGP to PCI mode\n");
-		rdev->flags |= RADEON_IS_PCI;
-		rdev->asic->gart_tlb_flush = &r100_pci_gart_tlb_flush;
-		rdev->asic->gart_set_page = &r100_pci_gart_set_page;
-	}
-	rdev->mc.gtt_size = radeon_gart_size * 1024 * 1024;
-}
-
 void radeon_check_arguments(struct radeon_device *rdev)
 {
 	/* vramlimit must be a power of two */
@@ -731,6 +563,14 @@
 		return r;
 	radeon_check_arguments(rdev);
 
+	/* all of the newer IGP chips have an internal gart
+	 * However some rs4xx report as AGP, so remove that here.
+	 */
+	if ((rdev->family >= CHIP_RS400) &&
+	    (rdev->flags & RADEON_IS_IGP)) {
+		rdev->flags &= ~RADEON_IS_AGP;
+	}
+
 	if (rdev->flags & RADEON_IS_AGP && radeon_agpmode == -1) {
 		radeon_agp_disable(rdev);
 	}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_display.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_display.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_display.c	2010-04-13 02:18:55.708633027 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_display.c	2010-04-13 02:19:00.830633024 +0000
@@ -368,10 +368,9 @@
 
 	if (rdev->bios) {
 		if (rdev->is_atom_bios) {
-			if (rdev->family >= CHIP_R600)
+			ret = radeon_get_atom_connector_info_from_supported_devices_table(dev);
+			if (ret == false)
 				ret = radeon_get_atom_connector_info_from_object_table(dev);
-			else
-				ret = radeon_get_atom_connector_info_from_supported_devices_table(dev);
 		} else {
 			ret = radeon_get_legacy_connector_info_from_bios(dev);
 			if (ret == false)
@@ -469,10 +468,19 @@
 	uint32_t best_error = 0xffffffff;
 	uint32_t best_vco_diff = 1;
 	uint32_t post_div;
+	u32 pll_out_min, pll_out_max;
 
 	DRM_DEBUG("PLL freq %llu %u %u\n", freq, pll->min_ref_div, pll->max_ref_div);
 	freq = freq * 1000;
 
+	if (pll->flags & RADEON_PLL_IS_LCD) {
+		pll_out_min = pll->lcd_pll_out_min;
+		pll_out_max = pll->lcd_pll_out_max;
+	} else {
+		pll_out_min = pll->pll_out_min;
+		pll_out_max = pll->pll_out_max;
+	}
+
 	if (pll->flags & RADEON_PLL_USE_REF_DIV)
 		min_ref_div = max_ref_div = pll->reference_div;
 	else {
@@ -536,10 +544,10 @@
 				tmp = (uint64_t)pll->reference_freq * feedback_div;
 				vco = radeon_div(tmp, ref_div);
 
-				if (vco < pll->pll_out_min) {
+				if (vco < pll_out_min) {
 					min_feed_div = feedback_div + 1;
 					continue;
-				} else if (vco > pll->pll_out_max) {
+				} else if (vco > pll_out_max) {
 					max_feed_div = feedback_div;
 					continue;
 				}
@@ -675,6 +683,15 @@
 {
 	fixed20_12 ffreq, max_error, error, pll_out, a;
 	u32 vco;
+	u32 pll_out_min, pll_out_max;
+
+	if (pll->flags & RADEON_PLL_IS_LCD) {
+		pll_out_min = pll->lcd_pll_out_min;
+		pll_out_max = pll->lcd_pll_out_max;
+	} else {
+		pll_out_min = pll->pll_out_min;
+		pll_out_max = pll->pll_out_max;
+	}
 
 	ffreq.full = rfixed_const(freq);
 	/* max_error = ffreq * 0.0025; */
@@ -686,7 +703,7 @@
 			vco = pll->reference_freq * (((*fb_div) * 10) + (*fb_div_frac));
 			vco = vco / ((*ref_div) * 10);
 
-			if ((vco < pll->pll_out_min) || (vco > pll->pll_out_max))
+			if ((vco < pll_out_min) || (vco > pll_out_max))
 				continue;
 
 			/* pll_out = vco / post_div; */
@@ -714,6 +731,15 @@
 {
 	u32 fb_div = 0, fb_div_frac = 0, post_div = 0, ref_div = 0;
 	u32 best_freq = 0, vco_frequency;
+	u32 pll_out_min, pll_out_max;
+
+	if (pll->flags & RADEON_PLL_IS_LCD) {
+		pll_out_min = pll->lcd_pll_out_min;
+		pll_out_max = pll->lcd_pll_out_max;
+	} else {
+		pll_out_min = pll->pll_out_min;
+		pll_out_max = pll->pll_out_max;
+	}
 
 	/* freq = freq / 10; */
 	do_div(freq, 10);
@@ -724,7 +750,7 @@
 			goto done;
 
 		vco_frequency = freq * post_div;
-		if ((vco_frequency < pll->pll_out_min) || (vco_frequency > pll->pll_out_max))
+		if ((vco_frequency < pll_out_min) || (vco_frequency > pll_out_max))
 			goto done;
 
 		if (pll->flags & RADEON_PLL_USE_REF_DIV) {
@@ -749,7 +775,7 @@
 				continue;
 
 			vco_frequency = freq * post_div;
-			if ((vco_frequency < pll->pll_out_min) || (vco_frequency > pll->pll_out_max))
+			if ((vco_frequency < pll_out_min) || (vco_frequency > pll_out_max))
 				continue;
 			if (pll->flags & RADEON_PLL_USE_REF_DIV) {
 				ref_div = pll->reference_div;
@@ -945,6 +971,23 @@
 	return 0;
 }
 
+void radeon_update_display_priority(struct radeon_device *rdev)
+{
+	/* adjustment options for the display watermarks */
+	if ((radeon_disp_priority == 0) || (radeon_disp_priority > 2)) {
+		/* set display priority to high for r3xx, rv515 chips
+		 * this avoids flickering due to underflow to the
+		 * display controllers during heavy acceleration.
+		 */
+		if (ASIC_IS_R300(rdev) || (rdev->family == CHIP_RV515))
+			rdev->disp_priority = 2;
+		else
+			rdev->disp_priority = 0;
+	} else
+		rdev->disp_priority = radeon_disp_priority;
+
+}
+
 int radeon_modeset_init(struct radeon_device *rdev)
 {
 	int i;
@@ -976,15 +1019,6 @@
 		radeon_combios_check_hardcoded_edid(rdev);
 	}
 
-	if (rdev->flags & RADEON_SINGLE_CRTC)
-		rdev->num_crtc = 1;
-	else {
-		if (ASIC_IS_DCE4(rdev))
-			rdev->num_crtc = 6;
-		else
-			rdev->num_crtc = 2;
-	}
-
 	/* allocate crtcs */
 	for (i = 0; i < rdev->num_crtc; i++) {
 		radeon_crtc_init(rdev->ddev, i);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_drv.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_drv.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_drv.c	2010-04-13 02:18:55.708633027 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_drv.c	2010-04-13 02:19:00.830633024 +0000
@@ -42,9 +42,10 @@
  * KMS wrapper.
  * - 2.0.0 - initial interface
  * - 2.1.0 - add square tiling interface
+ * - 2.2.0 - add r6xx/r7xx const buffer support
  */
 #define KMS_DRIVER_MAJOR	2
-#define KMS_DRIVER_MINOR	1
+#define KMS_DRIVER_MINOR	2
 #define KMS_DRIVER_PATCHLEVEL	0
 int radeon_driver_load_kms(struct drm_device *dev, unsigned long flags);
 int radeon_driver_unload_kms(struct drm_device *dev);
@@ -91,6 +92,8 @@
 int radeon_new_pll = -1;
 int radeon_dynpm = -1;
 int radeon_audio = 1;
+int radeon_disp_priority = 0;
+int radeon_hw_i2c = 0;
 
 MODULE_PARM_DESC(no_wb, "Disable AGP writeback for scratch registers");
 module_param_named(no_wb, radeon_no_wb, int, 0444);
@@ -134,6 +137,12 @@
 MODULE_PARM_DESC(audio, "Audio enable (0 = disable)");
 module_param_named(audio, radeon_audio, int, 0444);
 
+MODULE_PARM_DESC(disp_priority, "Display Priority (0 = auto, 1 = normal, 2 = high)");
+module_param_named(disp_priority, radeon_disp_priority, int, 0444);
+
+MODULE_PARM_DESC(hw_i2c, "hw i2c engine enable (0 = disable)");
+module_param_named(hw_i2c, radeon_hw_i2c, int, 0444);
+
 static int radeon_suspend(struct drm_device *dev, pm_message_t state)
 {
 	drm_radeon_private_t *dev_priv = dev->dev_private;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_drv.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_drv.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_drv.h	2010-04-13 02:18:55.708633027 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_drv.h	2010-04-13 02:19:00.830633024 +0000
@@ -107,9 +107,10 @@
  * 1.30- Add support for occlusion queries
  * 1.31- Add support for num Z pipes from GET_PARAM
  * 1.32- fixes for rv740 setup
+ * 1.33- Add r6xx/r7xx const buffer support
  */
 #define DRIVER_MAJOR		1
-#define DRIVER_MINOR		32
+#define DRIVER_MINOR		33
 #define DRIVER_PATCHLEVEL	0
 
 enum radeon_cp_microcode_version {
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_encoders.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_encoders.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_encoders.c	2010-04-13 02:18:55.709571302 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_encoders.c	2010-04-13 02:19:00.831633056 +0000
@@ -302,7 +302,7 @@
 	}
 
 	if (ASIC_IS_DCE3(rdev) &&
-	    (radeon_encoder->active_device & (ATOM_DEVICE_DFP_SUPPORT))) {
+	    (radeon_encoder->active_device & (ATOM_DEVICE_DFP_SUPPORT | ATOM_DEVICE_LCD_SUPPORT))) {
 		struct drm_connector *connector = radeon_get_connector_for_encoder(encoder);
 		radeon_dp_set_link_config(connector, mode);
 	}
@@ -317,12 +317,8 @@
 	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
 	DAC_ENCODER_CONTROL_PS_ALLOCATION args;
-	int index = 0, num = 0;
+	int index = 0;
 	struct radeon_encoder_atom_dac *dac_info = radeon_encoder->enc_priv;
-	enum radeon_tv_std tv_std = TV_STD_NTSC;
-
-	if (dac_info->tv_std)
-		tv_std = dac_info->tv_std;
 
 	memset(&args, 0, sizeof(args));
 
@@ -330,12 +326,10 @@
 	case ENCODER_OBJECT_ID_INTERNAL_DAC1:
 	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:
 		index = GetIndexIntoMasterTable(COMMAND, DAC1EncoderControl);
-		num = 1;
 		break;
 	case ENCODER_OBJECT_ID_INTERNAL_DAC2:
 	case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:
 		index = GetIndexIntoMasterTable(COMMAND, DAC2EncoderControl);
-		num = 2;
 		break;
 	}
 
@@ -346,7 +340,7 @@
 	else if (radeon_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))
 		args.ucDacStandard = ATOM_DAC1_CV;
 	else {
-		switch (tv_std) {
+		switch (dac_info->tv_std) {
 		case TV_STD_PAL:
 		case TV_STD_PAL_M:
 		case TV_STD_SCART_PAL:
@@ -377,10 +371,6 @@
 	TV_ENCODER_CONTROL_PS_ALLOCATION args;
 	int index = 0;
 	struct radeon_encoder_atom_dac *dac_info = radeon_encoder->enc_priv;
-	enum radeon_tv_std tv_std = TV_STD_NTSC;
-
-	if (dac_info->tv_std)
-		tv_std = dac_info->tv_std;
 
 	memset(&args, 0, sizeof(args));
 
@@ -391,7 +381,7 @@
 	if (radeon_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))
 		args.sTVEncoder.ucTvStandard = ATOM_TV_CV;
 	else {
-		switch (tv_std) {
+		switch (dac_info->tv_std) {
 		case TV_STD_NTSC:
 			args.sTVEncoder.ucTvStandard = ATOM_TV_NTSC;
 			break;
@@ -519,7 +509,8 @@
 		break;
 	}
 
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev))
+		return;
 
 	switch (frev) {
 	case 1:
@@ -593,7 +584,6 @@
 	}
 
 	atom_execute_table(rdev->mode_info.atom_context, index, (uint32_t *)&args);
-	r600_hdmi_enable(encoder, hdmi_detected);
 }
 
 int
@@ -708,7 +698,7 @@
 	struct radeon_connector_atom_dig *dig_connector =
 		radeon_get_atom_connector_priv_from_encoder(encoder);
 	union dig_encoder_control args;
-	int index = 0, num = 0;
+	int index = 0;
 	uint8_t frev, crev;
 
 	if (!dig || !dig_connector)
@@ -724,9 +714,9 @@
 		else
 			index = GetIndexIntoMasterTable(COMMAND, DIG1EncoderControl);
 	}
-	num = dig->dig_encoder + 1;
 
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev))
+		return;
 
 	args.v1.ucAction = action;
 	args.v1.usPixelClock = cpu_to_le16(radeon_encoder->pixel_clock / 10);
@@ -785,7 +775,7 @@
 	struct drm_connector *connector;
 	struct radeon_connector *radeon_connector;
 	union dig_transmitter_control args;
-	int index = 0, num = 0;
+	int index = 0;
 	uint8_t frev, crev;
 	bool is_dp = false;
 	int pll_id = 0;
@@ -814,7 +804,8 @@
 		}
 	}
 
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev))
+		return;
 
 	args.v1.ucAction = action;
 	if (action == ATOM_TRANSMITTER_ACTION_INIT) {
@@ -860,15 +851,12 @@
 		switch (radeon_encoder->encoder_id) {
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
 			args.v3.acConfig.ucTransmitterSel = 0;
-			num = 0;
 			break;
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
 			args.v3.acConfig.ucTransmitterSel = 1;
-			num = 1;
 			break;
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
 			args.v3.acConfig.ucTransmitterSel = 2;
-			num = 2;
 			break;
 		}
 
@@ -879,23 +867,19 @@
 				args.v3.acConfig.fCoherentMode = 1;
 		}
 	} else if (ASIC_IS_DCE32(rdev)) {
-		if (dig->dig_encoder == 1)
-			args.v2.acConfig.ucEncoderSel = 1;
+		args.v2.acConfig.ucEncoderSel = dig->dig_encoder;
 		if (dig_connector->linkb)
 			args.v2.acConfig.ucLinkSel = 1;
 
 		switch (radeon_encoder->encoder_id) {
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
 			args.v2.acConfig.ucTransmitterSel = 0;
-			num = 0;
 			break;
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:
 			args.v2.acConfig.ucTransmitterSel = 1;
-			num = 1;
 			break;
 		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:
 			args.v2.acConfig.ucTransmitterSel = 2;
-			num = 2;
 			break;
 		}
 
@@ -913,31 +897,25 @@
 		else
 			args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_DIG1_ENCODER;
 
-		switch (radeon_encoder->encoder_id) {
-		case ENCODER_OBJECT_ID_INTERNAL_UNIPHY:
-			if (rdev->flags & RADEON_IS_IGP) {
-				if (radeon_encoder->pixel_clock > 165000) {
-					if (dig_connector->igp_lane_info & 0x3)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_7;
-					else if (dig_connector->igp_lane_info & 0xc)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_15;
-				} else {
-					if (dig_connector->igp_lane_info & 0x1)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_3;
-					else if (dig_connector->igp_lane_info & 0x2)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_4_7;
-					else if (dig_connector->igp_lane_info & 0x4)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_11;
-					else if (dig_connector->igp_lane_info & 0x8)
-						args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_12_15;
-				}
+		if ((rdev->flags & RADEON_IS_IGP) &&
+		    (radeon_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_UNIPHY)) {
+			if (is_dp || (radeon_encoder->pixel_clock <= 165000)) {
+				if (dig_connector->igp_lane_info & 0x1)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_3;
+				else if (dig_connector->igp_lane_info & 0x2)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_4_7;
+				else if (dig_connector->igp_lane_info & 0x4)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_11;
+				else if (dig_connector->igp_lane_info & 0x8)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_12_15;
+			} else {
+				if (dig_connector->igp_lane_info & 0x3)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_7;
+				else if (dig_connector->igp_lane_info & 0xc)
+					args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_15;
 			}
-			break;
 		}
 
-		if (radeon_encoder->pixel_clock > 165000)
-			args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_8LANE_LINK;
-
 		if (dig_connector->linkb)
 			args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LINKB;
 		else
@@ -948,6 +926,8 @@
 		else if (radeon_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {
 			if (dig->coherent_mode)
 				args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_COHERENT;
+			if (radeon_encoder->pixel_clock > 165000)
+				args.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_8LANE_LINK;
 		}
 	}
 
@@ -1054,16 +1034,25 @@
 	if (is_dig) {
 		switch (mode) {
 		case DRM_MODE_DPMS_ON:
-			atombios_dig_transmitter_setup(encoder, ATOM_TRANSMITTER_ACTION_ENABLE_OUTPUT, 0, 0);
-			{
+			if (atombios_get_encoder_mode(encoder) == ATOM_ENCODER_MODE_DP) {
 				struct drm_connector *connector = radeon_get_connector_for_encoder(encoder);
+
 				dp_link_train(encoder, connector);
+				if (ASIC_IS_DCE4(rdev))
+					atombios_dig_encoder_setup(encoder, ATOM_ENCODER_CMD_DP_VIDEO_ON);
 			}
+			if (!ASIC_IS_DCE4(rdev))
+				atombios_dig_transmitter_setup(encoder, ATOM_TRANSMITTER_ACTION_ENABLE_OUTPUT, 0, 0);
 			break;
 		case DRM_MODE_DPMS_STANDBY:
 		case DRM_MODE_DPMS_SUSPEND:
 		case DRM_MODE_DPMS_OFF:
-			atombios_dig_transmitter_setup(encoder, ATOM_TRANSMITTER_ACTION_DISABLE_OUTPUT, 0, 0);
+			if (!ASIC_IS_DCE4(rdev))
+				atombios_dig_transmitter_setup(encoder, ATOM_TRANSMITTER_ACTION_DISABLE_OUTPUT, 0, 0);
+			if (atombios_get_encoder_mode(encoder) == ATOM_ENCODER_MODE_DP) {
+				if (ASIC_IS_DCE4(rdev))
+					atombios_dig_encoder_setup(encoder, ATOM_ENCODER_CMD_DP_VIDEO_OFF);
+			}
 			break;
 		}
 	} else {
@@ -1104,7 +1093,8 @@
 
 	memset(&args, 0, sizeof(args));
 
-	atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev);
+	if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev))
+		return;
 
 	switch (frev) {
 	case 1:
@@ -1216,6 +1206,9 @@
 	}
 
 	atom_execute_table(rdev->mode_info.atom_context, index, (uint32_t *)&args);
+
+	/* update scratch regs with new routing */
+	radeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);
 }
 
 static void
@@ -1326,19 +1319,9 @@
 	struct drm_device *dev = encoder->dev;
 	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
-	struct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);
 
-	if (radeon_encoder->active_device &
-	    (ATOM_DEVICE_DFP_SUPPORT | ATOM_DEVICE_LCD_SUPPORT)) {
-		struct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;
-		if (dig)
-			dig->dig_encoder = radeon_atom_pick_dig_encoder(encoder);
-	}
 	radeon_encoder->pixel_clock = adjusted_mode->clock;
 
-	radeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);
-	atombios_set_encoder_crtc_source(encoder);
-
 	if (ASIC_IS_AVIVO(rdev)) {
 		if (radeon_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT | ATOM_DEVICE_TV_SUPPORT))
 			atombios_yuv_setup(encoder, true);
@@ -1396,9 +1379,10 @@
 	}
 	atombios_apply_encoder_quirks(encoder, adjusted_mode);
 
-	/* XXX */
-	if (!ASIC_IS_DCE4(rdev))
+	if (atombios_get_encoder_mode(encoder) == ATOM_ENCODER_MODE_HDMI) {
+		r600_hdmi_enable(encoder);
 		r600_hdmi_setmode(encoder, adjusted_mode);
+	}
 }
 
 static bool
@@ -1418,7 +1402,8 @@
 
 		memset(&args, 0, sizeof(args));
 
-		atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev);
+		if (!atom_parse_cmd_header(rdev->mode_info.atom_context, index, &frev, &crev))
+			return false;
 
 		args.sDacload.ucMisc = 0;
 
@@ -1492,8 +1477,20 @@
 
 static void radeon_atom_encoder_prepare(struct drm_encoder *encoder)
 {
+	struct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);
+
+	if (radeon_encoder->active_device &
+	    (ATOM_DEVICE_DFP_SUPPORT | ATOM_DEVICE_LCD_SUPPORT)) {
+		struct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;
+		if (dig)
+			dig->dig_encoder = radeon_atom_pick_dig_encoder(encoder);
+	}
+
 	radeon_atom_output_lock(encoder, true);
 	radeon_atom_encoder_dpms(encoder, DRM_MODE_DPMS_OFF);
+
+	/* this is needed for the pll/ss setup to work correctly in some cases */
+	atombios_set_encoder_crtc_source(encoder);
 }
 
 static void radeon_atom_encoder_commit(struct drm_encoder *encoder)
@@ -1509,6 +1506,8 @@
 	radeon_atom_encoder_dpms(encoder, DRM_MODE_DPMS_OFF);
 
 	if (radeon_encoder_is_digital(encoder)) {
+		if (atombios_get_encoder_mode(encoder) == ATOM_ENCODER_MODE_HDMI)
+			r600_hdmi_disable(encoder);
 		dig = radeon_encoder->enc_priv;
 		dig->dig_encoder = -1;
 	}
@@ -1549,12 +1548,14 @@
 struct radeon_encoder_atom_dac *
 radeon_atombios_set_dac_info(struct radeon_encoder *radeon_encoder)
 {
+	struct drm_device *dev = radeon_encoder->base.dev;
+	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_encoder_atom_dac *dac = kzalloc(sizeof(struct radeon_encoder_atom_dac), GFP_KERNEL);
 
 	if (!dac)
 		return NULL;
 
-	dac->tv_std = TV_STD_NTSC;
+	dac->tv_std = radeon_atombios_get_tv_info(rdev);
 	return dac;
 }
 
@@ -1632,6 +1633,7 @@
 		break;
 	case ENCODER_OBJECT_ID_INTERNAL_DAC1:
 		drm_encoder_init(dev, encoder, &radeon_atom_enc_funcs, DRM_MODE_ENCODER_DAC);
+		radeon_encoder->enc_priv = radeon_atombios_set_dac_info(radeon_encoder);
 		drm_encoder_helper_add(encoder, &radeon_atom_dac_helper_funcs);
 		break;
 	case ENCODER_OBJECT_ID_INTERNAL_DAC2:
@@ -1659,6 +1661,4 @@
 		drm_encoder_helper_add(encoder, &radeon_atom_dig_helper_funcs);
 		break;
 	}
-
-	r600_hdmi_init(encoder);
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_fb.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_fb.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_fb.c	2010-04-13 02:18:55.709571302 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_fb.c	2010-04-13 02:19:00.831633056 +0000
@@ -28,6 +28,7 @@
      */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/fb.h>
 
 #include "drmP.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_fence.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_fence.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_fence.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_fence.c	2010-04-13 02:19:00.831633056 +0000
@@ -33,6 +33,7 @@
 #include <linux/wait.h>
 #include <linux/list.h>
 #include <linux/kref.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "drm.h"
 #include "radeon_reg.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_i2c.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_i2c.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_i2c.c	2010-04-13 02:18:55.710570476 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_i2c.c	2010-04-13 02:19:00.832633058 +0000
@@ -59,6 +59,7 @@
 	return false;
 }
 
+/* bit banging i2c */
 
 static void radeon_i2c_do_lock(struct radeon_i2c_chan *i2c, int lock_state)
 {
@@ -181,13 +182,30 @@
 	WREG32(rec->en_data_reg, val);
 }
 
+static int pre_xfer(struct i2c_adapter *i2c_adap)
+{
+	struct radeon_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);
+
+	radeon_i2c_do_lock(i2c, 1);
+
+	return 0;
+}
+
+static void post_xfer(struct i2c_adapter *i2c_adap)
+{
+	struct radeon_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);
+
+	radeon_i2c_do_lock(i2c, 0);
+}
+
+/* hw i2c */
+
 static u32 radeon_get_i2c_prescale(struct radeon_device *rdev)
 {
-	struct radeon_pll *spll = &rdev->clock.spll;
 	u32 sclk = radeon_get_engine_clock(rdev);
 	u32 prescale = 0;
-	u32 n, m;
-	u8 loop;
+	u32 nm;
+	u8 n, m, loop;
 	int i2c_clock;
 
 	switch (rdev->family) {
@@ -203,13 +221,15 @@
 	case CHIP_R300:
 	case CHIP_R350:
 	case CHIP_RV350:
-		n = (spll->reference_freq) / (4 * 6);
+		i2c_clock = 60;
+		nm = (sclk * 10) / (i2c_clock * 4);
 		for (loop = 1; loop < 255; loop++) {
-			if ((loop * (loop - 1)) > n)
+			if ((nm / loop) < loop)
 				break;
 		}
-		m = loop - 1;
-		prescale = m | (loop << 8);
+		n = loop - 1;
+		m = loop - 2;
+		prescale = m | (n << 8);
 		break;
 	case CHIP_RV380:
 	case CHIP_RS400:
@@ -217,7 +237,6 @@
 	case CHIP_R420:
 	case CHIP_R423:
 	case CHIP_RV410:
-		sclk = radeon_get_engine_clock(rdev);
 		prescale = (((sclk * 10)/(4 * 128 * 100) + 1) << 8) + 128;
 		break;
 	case CHIP_RS600:
@@ -232,7 +251,6 @@
 	case CHIP_RV570:
 	case CHIP_R580:
 		i2c_clock = 50;
-		sclk = radeon_get_engine_clock(rdev);
 		if (rdev->family == CHIP_R520)
 			prescale = (127 << 8) + ((sclk * 10) / (4 * 127 * i2c_clock));
 		else
@@ -291,6 +309,7 @@
 	prescale = radeon_get_i2c_prescale(rdev);
 
 	reg = ((prescale << RADEON_I2C_PRESCALE_SHIFT) |
+	       RADEON_I2C_DRIVE_EN |
 	       RADEON_I2C_START |
 	       RADEON_I2C_STOP |
 	       RADEON_I2C_GO);
@@ -757,26 +776,13 @@
 	return ret;
 }
 
-static int radeon_sw_i2c_xfer(struct i2c_adapter *i2c_adap,
+static int radeon_hw_i2c_xfer(struct i2c_adapter *i2c_adap,
 			      struct i2c_msg *msgs, int num)
 {
 	struct radeon_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);
-	int ret;
-
-	radeon_i2c_do_lock(i2c, 1);
-	ret = i2c_transfer(&i2c->algo.radeon.bit_adapter, msgs, num);
-	radeon_i2c_do_lock(i2c, 0);
-
-	return ret;
-}
-
-static int radeon_i2c_xfer(struct i2c_adapter *i2c_adap,
-			   struct i2c_msg *msgs, int num)
-{
-	struct radeon_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);
 	struct radeon_device *rdev = i2c->dev->dev_private;
 	struct radeon_i2c_bus_rec *rec = &i2c->rec;
-	int ret;
+	int ret = 0;
 
 	switch (rdev->family) {
 	case CHIP_R100:
@@ -797,16 +803,12 @@
 	case CHIP_RV410:
 	case CHIP_RS400:
 	case CHIP_RS480:
-		if (rec->hw_capable)
-			ret = r100_hw_i2c_xfer(i2c_adap, msgs, num);
-		else
-			ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
+		ret = r100_hw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	case CHIP_RS600:
 	case CHIP_RS690:
 	case CHIP_RS740:
 		/* XXX fill in hw i2c implementation */
-		ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	case CHIP_RV515:
 	case CHIP_R520:
@@ -814,20 +816,16 @@
 	case CHIP_RV560:
 	case CHIP_RV570:
 	case CHIP_R580:
-		if (rec->hw_capable) {
-			if (rec->mm_i2c)
-				ret = r100_hw_i2c_xfer(i2c_adap, msgs, num);
-			else
-				ret = r500_hw_i2c_xfer(i2c_adap, msgs, num);
-		} else
-			ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
+		if (rec->mm_i2c)
+			ret = r100_hw_i2c_xfer(i2c_adap, msgs, num);
+		else
+			ret = r500_hw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	case CHIP_R600:
 	case CHIP_RV610:
 	case CHIP_RV630:
 	case CHIP_RV670:
 		/* XXX fill in hw i2c implementation */
-		ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	case CHIP_RV620:
 	case CHIP_RV635:
@@ -838,7 +836,6 @@
 	case CHIP_RV710:
 	case CHIP_RV740:
 		/* XXX fill in hw i2c implementation */
-		ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	case CHIP_CEDAR:
 	case CHIP_REDWOOD:
@@ -846,7 +843,6 @@
 	case CHIP_CYPRESS:
 	case CHIP_HEMLOCK:
 		/* XXX fill in hw i2c implementation */
-		ret = radeon_sw_i2c_xfer(i2c_adap, msgs, num);
 		break;
 	default:
 		DRM_ERROR("i2c: unhandled radeon chip\n");
@@ -857,20 +853,21 @@
 	return ret;
 }
 
-static u32 radeon_i2c_func(struct i2c_adapter *adap)
+static u32 radeon_hw_i2c_func(struct i2c_adapter *adap)
 {
 	return I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;
 }
 
 static const struct i2c_algorithm radeon_i2c_algo = {
-	.master_xfer = radeon_i2c_xfer,
-	.functionality = radeon_i2c_func,
+	.master_xfer = radeon_hw_i2c_xfer,
+	.functionality = radeon_hw_i2c_func,
 };
 
 struct radeon_i2c_chan *radeon_i2c_create(struct drm_device *dev,
 					  struct radeon_i2c_bus_rec *rec,
 					  const char *name)
 {
+	struct radeon_device *rdev = dev->dev_private;
 	struct radeon_i2c_chan *i2c;
 	int ret;
 
@@ -878,37 +875,43 @@
 	if (i2c == NULL)
 		return NULL;
 
-	/* set the internal bit adapter */
-	i2c->algo.radeon.bit_adapter.owner = THIS_MODULE;
-	i2c_set_adapdata(&i2c->algo.radeon.bit_adapter, i2c);
-	sprintf(i2c->algo.radeon.bit_adapter.name, "Radeon internal i2c bit bus %s", name);
-	i2c->algo.radeon.bit_adapter.algo_data = &i2c->algo.radeon.bit_data;
-	i2c->algo.radeon.bit_data.setsda = set_data;
-	i2c->algo.radeon.bit_data.setscl = set_clock;
-	i2c->algo.radeon.bit_data.getsda = get_data;
-	i2c->algo.radeon.bit_data.getscl = get_clock;
-	i2c->algo.radeon.bit_data.udelay = 20;
-	/* vesa says 2.2 ms is enough, 1 jiffy doesn't seem to always
-	 * make this, 2 jiffies is a lot more reliable */
-	i2c->algo.radeon.bit_data.timeout = 2;
-	i2c->algo.radeon.bit_data.data = i2c;
-	ret = i2c_bit_add_bus(&i2c->algo.radeon.bit_adapter);
-	if (ret) {
-		DRM_ERROR("Failed to register internal bit i2c %s\n", name);
-		goto out_free;
-	}
-	/* set the radeon i2c adapter */
-	i2c->dev = dev;
 	i2c->rec = *rec;
 	i2c->adapter.owner = THIS_MODULE;
+	i2c->dev = dev;
 	i2c_set_adapdata(&i2c->adapter, i2c);
-	sprintf(i2c->adapter.name, "Radeon i2c %s", name);
-	i2c->adapter.algo_data = &i2c->algo.radeon;
-	i2c->adapter.algo = &radeon_i2c_algo;
-	ret = i2c_add_adapter(&i2c->adapter);
-	if (ret) {
-		DRM_ERROR("Failed to register i2c %s\n", name);
-		goto out_free;
+	if (rec->mm_i2c ||
+	    (rec->hw_capable &&
+	     radeon_hw_i2c &&
+	     ((rdev->family <= CHIP_RS480) ||
+	      ((rdev->family >= CHIP_RV515) && (rdev->family <= CHIP_R580))))) {
+		/* set the radeon hw i2c adapter */
+		sprintf(i2c->adapter.name, "Radeon i2c hw bus %s", name);
+		i2c->adapter.algo = &radeon_i2c_algo;
+		ret = i2c_add_adapter(&i2c->adapter);
+		if (ret) {
+			DRM_ERROR("Failed to register hw i2c %s\n", name);
+			goto out_free;
+		}
+	} else {
+		/* set the radeon bit adapter */
+		sprintf(i2c->adapter.name, "Radeon i2c bit bus %s", name);
+		i2c->adapter.algo_data = &i2c->algo.bit;
+		i2c->algo.bit.pre_xfer = pre_xfer;
+		i2c->algo.bit.post_xfer = post_xfer;
+		i2c->algo.bit.setsda = set_data;
+		i2c->algo.bit.setscl = set_clock;
+		i2c->algo.bit.getsda = get_data;
+		i2c->algo.bit.getscl = get_clock;
+		i2c->algo.bit.udelay = 20;
+		/* vesa says 2.2 ms is enough, 1 jiffy doesn't seem to always
+		 * make this, 2 jiffies is a lot more reliable */
+		i2c->algo.bit.timeout = 2;
+		i2c->algo.bit.data = i2c;
+		ret = i2c_bit_add_bus(&i2c->adapter);
+		if (ret) {
+			DRM_ERROR("Failed to register bit i2c %s\n", name);
+			goto out_free;
+		}
 	}
 
 	return i2c;
@@ -953,16 +956,6 @@
 {
 	if (!i2c)
 		return;
-	i2c_del_adapter(&i2c->algo.radeon.bit_adapter);
-	i2c_del_adapter(&i2c->adapter);
-	kfree(i2c);
-}
-
-void radeon_i2c_destroy_dp(struct radeon_i2c_chan *i2c)
-{
-	if (!i2c)
-		return;
-
 	i2c_del_adapter(&i2c->adapter);
 	kfree(i2c);
 }
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_irq_kms.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_irq_kms.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_irq_kms.c	2010-04-13 02:18:55.710570476 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_irq_kms.c	2010-04-13 02:19:00.832633058 +0000
@@ -67,9 +67,10 @@
 
 	/* Disable *all* interrupts */
 	rdev->irq.sw_int = false;
-	for (i = 0; i < 2; i++) {
+	for (i = 0; i < rdev->num_crtc; i++)
 		rdev->irq.crtc_vblank_int[i] = false;
-	}
+	for (i = 0; i < 6; i++)
+		rdev->irq.hpd[i] = false;
 	radeon_irq_set(rdev);
 	/* Clear bits */
 	radeon_irq_process(rdev);
@@ -95,28 +96,29 @@
 	}
 	/* Disable *all* interrupts */
 	rdev->irq.sw_int = false;
-	for (i = 0; i < 2; i++) {
+	for (i = 0; i < rdev->num_crtc; i++)
 		rdev->irq.crtc_vblank_int[i] = false;
+	for (i = 0; i < 6; i++)
 		rdev->irq.hpd[i] = false;
-	}
 	radeon_irq_set(rdev);
 }
 
 int radeon_irq_kms_init(struct radeon_device *rdev)
 {
 	int r = 0;
-	int num_crtc = 2;
 
-	if (rdev->flags & RADEON_SINGLE_CRTC)
-		num_crtc = 1;
 	spin_lock_init(&rdev->irq.sw_lock);
-	r = drm_vblank_init(rdev->ddev, num_crtc);
+	r = drm_vblank_init(rdev->ddev, rdev->num_crtc);
 	if (r) {
 		return r;
 	}
 	/* enable msi */
 	rdev->msi_enabled = 0;
-	if (rdev->family >= CHIP_RV380) {
+	/* MSIs don't seem to work reliably on all IGP
+	 * chips.  Disable MSI on them for now.
+	 */
+	if ((rdev->family >= CHIP_RV380) &&
+	    (!(rdev->flags & RADEON_IS_IGP))) {
 		int ret = pci_enable_msi(rdev->pdev);
 		if (!ret) {
 			rdev->msi_enabled = 1;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_kms.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_kms.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_kms.c	2010-04-13 02:18:55.710570476 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_kms.c	2010-04-13 02:19:00.832633058 +0000
@@ -31,6 +31,7 @@
 #include "radeon_drm.h"
 
 #include <linux/vga_switcheroo.h>
+#include <linux/slab.h>
 
 int radeon_driver_unload_kms(struct drm_device *dev)
 {
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_crtc.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_crtc.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_crtc.c	2010-04-13 02:18:55.710570476 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_crtc.c	2010-04-13 02:19:00.833633054 +0000
@@ -603,6 +603,10 @@
 				      ? RADEON_CRTC2_INTERLACE_EN
 				      : 0));
 
+		/* rs4xx chips seem to like to have the crtc enabled when the timing is set */
+		if ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))
+			crtc2_gen_cntl |= RADEON_CRTC2_EN;
+
 		disp2_merge_cntl = RREG32(RADEON_DISP2_MERGE_CNTL);
 		disp2_merge_cntl &= ~RADEON_DISP2_RGB_OFFSET_EN;
 
@@ -630,6 +634,10 @@
 				    ? RADEON_CRTC_INTERLACE_EN
 				    : 0));
 
+		/* rs4xx chips seem to like to have the crtc enabled when the timing is set */
+		if ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))
+			crtc_gen_cntl |= RADEON_CRTC_EN;
+
 		crtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);
 		crtc_ext_cntl |= (RADEON_XCRT_CNT_EN |
 				  RADEON_CRTC_VSYNC_DIS |
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_encoders.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_encoders.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_encoders.c	2010-04-13 02:18:55.710570476 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_encoders.c	2010-04-13 02:19:00.833633054 +0000
@@ -830,8 +830,8 @@
 				crtc2_gen_cntl &= ~RADEON_CRTC2_CRT2_ON;
 
 			if (rdev->family == CHIP_R420 ||
-					rdev->family == CHIP_R423 ||
-					rdev->family == CHIP_RV410)
+			    rdev->family == CHIP_R423 ||
+			    rdev->family == CHIP_RV410)
 				tv_dac_cntl |= (R420_TV_DAC_RDACPD |
 						R420_TV_DAC_GDACPD |
 						R420_TV_DAC_BDACPD |
@@ -907,35 +907,43 @@
 	if (rdev->family != CHIP_R200) {
 		tv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);
 		if (rdev->family == CHIP_R420 ||
-				rdev->family == CHIP_R423 ||
-				rdev->family == CHIP_RV410) {
+		    rdev->family == CHIP_R423 ||
+		    rdev->family == CHIP_RV410) {
 			tv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |
-					RADEON_TV_DAC_BGADJ_MASK |
-					R420_TV_DAC_DACADJ_MASK |
-					R420_TV_DAC_RDACPD |
-					R420_TV_DAC_GDACPD |
-					R420_TV_DAC_BDACPD |
-					R420_TV_DAC_TVENABLE);
+					 RADEON_TV_DAC_BGADJ_MASK |
+					 R420_TV_DAC_DACADJ_MASK |
+					 R420_TV_DAC_RDACPD |
+					 R420_TV_DAC_GDACPD |
+					 R420_TV_DAC_BDACPD |
+					 R420_TV_DAC_TVENABLE);
 		} else {
 			tv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |
-					RADEON_TV_DAC_BGADJ_MASK |
-					RADEON_TV_DAC_DACADJ_MASK |
-					RADEON_TV_DAC_RDACPD |
-					RADEON_TV_DAC_GDACPD |
-					RADEON_TV_DAC_BDACPD);
+					 RADEON_TV_DAC_BGADJ_MASK |
+					 RADEON_TV_DAC_DACADJ_MASK |
+					 RADEON_TV_DAC_RDACPD |
+					 RADEON_TV_DAC_GDACPD |
+					 RADEON_TV_DAC_BDACPD);
 		}
 
-		/*  FIXME TV */
-		if (tv_dac) {
-			struct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;
-			tv_dac_cntl |= (RADEON_TV_DAC_NBLANK |
-					RADEON_TV_DAC_NHOLD |
-					RADEON_TV_DAC_STD_PS2 |
-					tv_dac->ps2_tvdac_adj);
+		tv_dac_cntl |= RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD;
+
+		if (is_tv) {
+			if (tv_dac->tv_std == TV_STD_NTSC ||
+			    tv_dac->tv_std == TV_STD_NTSC_J ||
+			    tv_dac->tv_std == TV_STD_PAL_M ||
+			    tv_dac->tv_std == TV_STD_PAL_60)
+				tv_dac_cntl |= tv_dac->ntsc_tvdac_adj;
+			else
+				tv_dac_cntl |= tv_dac->pal_tvdac_adj;
+
+			if (tv_dac->tv_std == TV_STD_NTSC ||
+			    tv_dac->tv_std == TV_STD_NTSC_J)
+				tv_dac_cntl |= RADEON_TV_DAC_STD_NTSC;
+			else
+				tv_dac_cntl |= RADEON_TV_DAC_STD_PAL;
 		} else
-			tv_dac_cntl |= (RADEON_TV_DAC_NBLANK |
-					RADEON_TV_DAC_NHOLD |
-					RADEON_TV_DAC_STD_PS2);
+			tv_dac_cntl |= (RADEON_TV_DAC_STD_PS2 |
+					tv_dac->ps2_tvdac_adj);
 
 		WREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);
 	}
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_tv.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_tv.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_legacy_tv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_legacy_tv.c	2010-04-13 02:19:00.833633054 +0000
@@ -57,6 +57,10 @@
 #define NTSC_TV_PLL_N_14 693
 #define NTSC_TV_PLL_P_14 7
 
+#define PAL_TV_PLL_M_14 19
+#define PAL_TV_PLL_N_14 353
+#define PAL_TV_PLL_P_14 5
+
 #define VERT_LEAD_IN_LINES 2
 #define FRAC_BITS 0xe
 #define FRAC_MASK 0x3fff
@@ -205,9 +209,24 @@
 		630627,             /* defRestart */
 		347,                /* crtcPLL_N */
 		14,                 /* crtcPLL_M */
-			8,                  /* crtcPLL_postDiv */
+		8,                  /* crtcPLL_postDiv */
 		1022,               /* pixToTV */
 	},
+	{ /* PAL timing for 14 Mhz ref clk */
+		800,                /* horResolution */
+		600,                /* verResolution */
+		TV_STD_PAL,         /* standard */
+		1131,               /* horTotal */
+		742,                /* verTotal */
+		813,                /* horStart */
+		840,                /* horSyncStart */
+		633,                /* verSyncStart */
+		708369,             /* defRestart */
+		211,                /* crtcPLL_N */
+		9,                  /* crtcPLL_M */
+		8,                  /* crtcPLL_postDiv */
+		759,                /* pixToTV */
+	},
 };
 
 #define N_AVAILABLE_MODES ARRAY_SIZE(available_tv_modes)
@@ -242,7 +261,7 @@
 		if (pll->reference_freq == 2700)
 			const_ptr = &available_tv_modes[1];
 		else
-			const_ptr = &available_tv_modes[1]; /* FIX ME */
+			const_ptr = &available_tv_modes[3];
 	}
 	return const_ptr;
 }
@@ -685,9 +704,9 @@
 			n = PAL_TV_PLL_N_27;
 			p = PAL_TV_PLL_P_27;
 		} else {
-			m = PAL_TV_PLL_M_27;
-			n = PAL_TV_PLL_N_27;
-			p = PAL_TV_PLL_P_27;
+			m = PAL_TV_PLL_M_14;
+			n = PAL_TV_PLL_N_14;
+			p = PAL_TV_PLL_P_14;
 		}
 	}
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_mode.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_mode.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_mode.h	2010-04-13 02:18:55.711570586 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_mode.h	2010-04-13 02:19:00.833633054 +0000
@@ -129,6 +129,7 @@
 #define RADEON_PLL_USE_FRAC_FB_DIV      (1 << 10)
 #define RADEON_PLL_PREFER_CLOSEST_LOWER (1 << 11)
 #define RADEON_PLL_USE_POST_DIV         (1 << 12)
+#define RADEON_PLL_IS_LCD               (1 << 13)
 
 /* pll algo */
 enum radeon_pll_algo {
@@ -149,6 +150,8 @@
 	uint32_t pll_in_max;
 	uint32_t pll_out_min;
 	uint32_t pll_out_max;
+	uint32_t lcd_pll_out_min;
+	uint32_t lcd_pll_out_max;
 	uint32_t best_vco;
 
 	/* divider limits */
@@ -170,17 +173,12 @@
 	enum radeon_pll_algo algo;
 };
 
-struct i2c_algo_radeon_data {
-	struct i2c_adapter bit_adapter;
-	struct i2c_algo_bit_data bit_data;
-};
-
 struct radeon_i2c_chan {
 	struct i2c_adapter adapter;
 	struct drm_device *dev;
 	union {
+		struct i2c_algo_bit_data bit;
 		struct i2c_algo_dp_aux_data dp;
-		struct i2c_algo_radeon_data radeon;
 	} algo;
 	struct radeon_i2c_bus_rec rec;
 };
@@ -342,6 +340,7 @@
 	struct drm_display_mode native_mode;
 	void *enc_priv;
 	int hdmi_offset;
+	int hdmi_config_offset;
 	int hdmi_audio_workaround;
 	int hdmi_buffer_status;
 };
@@ -431,7 +430,6 @@
 						 struct radeon_i2c_bus_rec *rec,
 						 const char *name);
 extern void radeon_i2c_destroy(struct radeon_i2c_chan *i2c);
-extern void radeon_i2c_destroy_dp(struct radeon_i2c_chan *i2c);
 extern void radeon_i2c_get_byte(struct radeon_i2c_chan *i2c_bus,
 				u8 slave_addr,
 				u8 addr,
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_object.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_object.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_object.c	2010-04-13 02:18:55.711570586 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_object.c	2010-04-13 02:19:00.834633074 +0000
@@ -30,6 +30,7 @@
  *    Dave Airlie
  */
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <drm/drmP.h>
 #include "radeon_drm.h"
 #include "radeon.h"
@@ -185,8 +186,10 @@
 		return 0;
 	}
 	radeon_ttm_placement_from_domain(bo, domain);
-	/* force to pin into visible video ram */
-	bo->placement.lpfn = bo->rdev->mc.visible_vram_size >> PAGE_SHIFT;
+	if (domain == RADEON_GEM_DOMAIN_VRAM) {
+		/* force to pin into visible video ram */
+		bo->placement.lpfn = bo->rdev->mc.visible_vram_size >> PAGE_SHIFT;
+	}
 	for (i = 0; i < bo->placement.num_placement; i++)
 		bo->placements[i] |= TTM_PL_FLAG_NO_EVICT;
 	r = ttm_bo_validate(&bo->tbo, &bo->placement, false, false);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_pm.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_pm.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_pm.c	2010-04-13 02:18:55.711570586 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_pm.c	2010-04-13 02:19:00.834633074 +0000
@@ -28,6 +28,7 @@
 #define RADEON_RECLOCK_DELAY_MS 200
 #define RADEON_WAIT_VBLANK_TIMEOUT 200
 
+static bool radeon_pm_debug_check_in_vbl(struct radeon_device *rdev, bool finish);
 static void radeon_pm_set_clocks_locked(struct radeon_device *rdev);
 static void radeon_pm_set_clocks(struct radeon_device *rdev);
 static void radeon_pm_idle_work_handler(struct work_struct *work);
@@ -179,6 +180,16 @@
 		 rdev->pm.requested_power_state->non_clock_info.pcie_lanes);
 }
 
+static inline void radeon_sync_with_vblank(struct radeon_device *rdev)
+{
+	if (rdev->pm.active_crtcs) {
+		rdev->pm.vblank_sync = false;
+		wait_event_timeout(
+			rdev->irq.vblank_queue, rdev->pm.vblank_sync,
+			msecs_to_jiffies(RADEON_WAIT_VBLANK_TIMEOUT));
+	}
+}
+
 static void radeon_set_power_state(struct radeon_device *rdev)
 {
 	/* if *_clock_mode are the same, *_power_state are as well */
@@ -189,11 +200,28 @@
 		 rdev->pm.requested_clock_mode->sclk,
 		 rdev->pm.requested_clock_mode->mclk,
 		 rdev->pm.requested_power_state->non_clock_info.pcie_lanes);
+
 	/* set pcie lanes */
+	/* TODO */
+
 	/* set voltage */
+	/* TODO */
+
 	/* set engine clock */
+	radeon_sync_with_vblank(rdev);
+	radeon_pm_debug_check_in_vbl(rdev, false);
 	radeon_set_engine_clock(rdev, rdev->pm.requested_clock_mode->sclk);
+	radeon_pm_debug_check_in_vbl(rdev, true);
+
+#if 0
 	/* set memory clock */
+	if (rdev->asic->set_memory_clock) {
+		radeon_sync_with_vblank(rdev);
+		radeon_pm_debug_check_in_vbl(rdev, false);
+		radeon_set_memory_clock(rdev, rdev->pm.requested_clock_mode->mclk);
+		radeon_pm_debug_check_in_vbl(rdev, true);
+	}
+#endif
 
 	rdev->pm.current_power_state = rdev->pm.requested_power_state;
 	rdev->pm.current_clock_mode = rdev->pm.requested_clock_mode;
@@ -229,6 +257,12 @@
 	return 0;
 }
 
+void radeon_pm_fini(struct radeon_device *rdev)
+{
+	if (rdev->pm.i2c_bus)
+		radeon_i2c_destroy(rdev->pm.i2c_bus);
+}
+
 void radeon_pm_compute_clocks(struct radeon_device *rdev)
 {
 	struct drm_device *ddev = rdev->ddev;
@@ -245,7 +279,8 @@
 	list_for_each_entry(connector,
 		&ddev->mode_config.connector_list, head) {
 		if (connector->encoder &&
-			connector->dpms != DRM_MODE_DPMS_OFF) {
+		    connector->encoder->crtc &&
+		    connector->dpms != DRM_MODE_DPMS_OFF) {
 			radeon_crtc = to_radeon_crtc(connector->encoder->crtc);
 			rdev->pm.active_crtcs |= (1 << radeon_crtc->crtc_id);
 			++count;
@@ -333,10 +368,7 @@
 		break;
 	}
 
-	/* check if we are in vblank */
-	radeon_pm_debug_check_in_vbl(rdev, false);
 	radeon_set_power_state(rdev);
-	radeon_pm_debug_check_in_vbl(rdev, true);
 	rdev->pm.planned_action = PM_ACTION_NONE;
 }
 
@@ -353,10 +385,7 @@
 		rdev->pm.req_vblank |= (1 << 1);
 		drm_vblank_get(rdev->ddev, 1);
 	}
-	if (rdev->pm.active_crtcs)
-		wait_event_interruptible_timeout(
-			rdev->irq.vblank_queue, 0,
-			msecs_to_jiffies(RADEON_WAIT_VBLANK_TIMEOUT));
+	radeon_pm_set_clocks_locked(rdev);
 	if (rdev->pm.req_vblank & (1 << 0)) {
 		rdev->pm.req_vblank &= ~(1 << 0);
 		drm_vblank_put(rdev->ddev, 0);
@@ -366,7 +395,6 @@
 		drm_vblank_put(rdev->ddev, 1);
 	}
 
-	radeon_pm_set_clocks_locked(rdev);
 	mutex_unlock(&rdev->cp.mutex);
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_reg.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_reg.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_reg.h	2010-04-13 02:18:55.712633050 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_reg.h	2010-04-13 02:19:00.834633074 +0000
@@ -346,6 +346,7 @@
 #       define RADEON_TVPLL_PWRMGT_OFF      (1 << 30)
 #       define RADEON_TVCLK_TURNOFF         (1 << 31)
 #define RADEON_PLL_PWRMGT_CNTL              0x0015 /* PLL */
+#	define RADEON_PM_MODE_SEL           (1 << 13)
 #       define RADEON_TCL_BYPASS_DISABLE    (1 << 20)
 #define RADEON_CLR_CMP_CLR_3D               0x1a24
 #define RADEON_CLR_CMP_CLR_DST              0x15c8
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_ring.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_ring.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_ring.c	2010-04-13 02:18:55.712633050 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_ring.c	2010-04-13 02:19:00.835633025 +0000
@@ -26,6 +26,7 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "radeon_drm.h"
 #include "radeon_reg.h"
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_ttm.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_ttm.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/radeon_ttm.c	2010-04-13 02:18:55.713633100 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/radeon_ttm.c	2010-04-13 02:19:00.836633030 +0000
@@ -36,6 +36,7 @@
 #include <drm/drmP.h>
 #include <drm/radeon_drm.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "radeon_reg.h"
 #include "radeon.h"
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/reg_srcs/r600 linux-2.6.34-rc4/drivers/gpu/drm/radeon/reg_srcs/r600
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/reg_srcs/r600	2010-04-13 02:18:55.713633100 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/reg_srcs/r600	2010-04-13 02:19:00.836633030 +0000
@@ -26,20 +26,16 @@
 0x00028408 VGT_INDX_OFFSET
 0x00028AA0 VGT_INSTANCE_STEP_RATE_0
 0x00028AA4 VGT_INSTANCE_STEP_RATE_1
-0x000088C0 VGT_LAST_COPY_STATE
 0x00028400 VGT_MAX_VTX_INDX
-0x000088D8 VGT_MC_LAT_CNTL
 0x00028404 VGT_MIN_VTX_INDX
 0x00028A94 VGT_MULTI_PRIM_IB_RESET_EN
 0x0002840C VGT_MULTI_PRIM_IB_RESET_INDX
 0x00008970 VGT_NUM_INDICES
 0x00008974 VGT_NUM_INSTANCES
 0x00028A10 VGT_OUTPUT_PATH_CNTL
-0x00028C5C VGT_OUT_DEALLOC_CNTL
 0x00028A84 VGT_PRIMITIVEID_EN
 0x00008958 VGT_PRIMITIVE_TYPE
 0x00028AB4 VGT_REUSE_OFF
-0x00028C58 VGT_VERTEX_REUSE_BLOCK_CNTL
 0x00028AB8 VGT_VTX_CNT_EN
 0x000088B0 VGT_VTX_VECT_EJECT_REG
 0x00028810 PA_CL_CLIP_CNTL
@@ -280,7 +276,6 @@
 0x00028E00 PA_SU_POLY_OFFSET_FRONT_SCALE
 0x00028814 PA_SU_SC_MODE_CNTL
 0x00028C08 PA_SU_VTX_CNTL
-0x00008C00 SQ_CONFIG
 0x00008C04 SQ_GPR_RESOURCE_MGMT_1
 0x00008C08 SQ_GPR_RESOURCE_MGMT_2
 0x00008C10 SQ_STACK_RESOURCE_MGMT_1
@@ -320,18 +315,6 @@
 0x000283FC SQ_VTX_SEMANTIC_31
 0x000288E0 SQ_VTX_SEMANTIC_CLEAR
 0x0003CFF4 SQ_VTX_START_INST_LOC
-0x0003C000 SQ_TEX_SAMPLER_WORD0_0
-0x0003C004 SQ_TEX_SAMPLER_WORD1_0
-0x0003C008 SQ_TEX_SAMPLER_WORD2_0
-0x00030000 SQ_ALU_CONSTANT0_0
-0x00030004 SQ_ALU_CONSTANT1_0
-0x00030008 SQ_ALU_CONSTANT2_0
-0x0003000C SQ_ALU_CONSTANT3_0
-0x0003E380 SQ_BOOL_CONST_0
-0x0003E384 SQ_BOOL_CONST_1
-0x0003E388 SQ_BOOL_CONST_2
-0x0003E200 SQ_LOOP_CONST_0
-0x0003E200 SQ_LOOP_CONST_DX10_0
 0x000281C0 SQ_ALU_CONST_BUFFER_SIZE_GS_0
 0x000281C4 SQ_ALU_CONST_BUFFER_SIZE_GS_1
 0x000281C8 SQ_ALU_CONST_BUFFER_SIZE_GS_2
@@ -380,54 +363,6 @@
 0x000281B4 SQ_ALU_CONST_BUFFER_SIZE_VS_13
 0x000281B8 SQ_ALU_CONST_BUFFER_SIZE_VS_14
 0x000281BC SQ_ALU_CONST_BUFFER_SIZE_VS_15
-0x000289C0 SQ_ALU_CONST_CACHE_GS_0
-0x000289C4 SQ_ALU_CONST_CACHE_GS_1
-0x000289C8 SQ_ALU_CONST_CACHE_GS_2
-0x000289CC SQ_ALU_CONST_CACHE_GS_3
-0x000289D0 SQ_ALU_CONST_CACHE_GS_4
-0x000289D4 SQ_ALU_CONST_CACHE_GS_5
-0x000289D8 SQ_ALU_CONST_CACHE_GS_6
-0x000289DC SQ_ALU_CONST_CACHE_GS_7
-0x000289E0 SQ_ALU_CONST_CACHE_GS_8
-0x000289E4 SQ_ALU_CONST_CACHE_GS_9
-0x000289E8 SQ_ALU_CONST_CACHE_GS_10
-0x000289EC SQ_ALU_CONST_CACHE_GS_11
-0x000289F0 SQ_ALU_CONST_CACHE_GS_12
-0x000289F4 SQ_ALU_CONST_CACHE_GS_13
-0x000289F8 SQ_ALU_CONST_CACHE_GS_14
-0x000289FC SQ_ALU_CONST_CACHE_GS_15
-0x00028940 SQ_ALU_CONST_CACHE_PS_0
-0x00028944 SQ_ALU_CONST_CACHE_PS_1
-0x00028948 SQ_ALU_CONST_CACHE_PS_2
-0x0002894C SQ_ALU_CONST_CACHE_PS_3
-0x00028950 SQ_ALU_CONST_CACHE_PS_4
-0x00028954 SQ_ALU_CONST_CACHE_PS_5
-0x00028958 SQ_ALU_CONST_CACHE_PS_6
-0x0002895C SQ_ALU_CONST_CACHE_PS_7
-0x00028960 SQ_ALU_CONST_CACHE_PS_8
-0x00028964 SQ_ALU_CONST_CACHE_PS_9
-0x00028968 SQ_ALU_CONST_CACHE_PS_10
-0x0002896C SQ_ALU_CONST_CACHE_PS_11
-0x00028970 SQ_ALU_CONST_CACHE_PS_12
-0x00028974 SQ_ALU_CONST_CACHE_PS_13
-0x00028978 SQ_ALU_CONST_CACHE_PS_14
-0x0002897C SQ_ALU_CONST_CACHE_PS_15
-0x00028980 SQ_ALU_CONST_CACHE_VS_0
-0x00028984 SQ_ALU_CONST_CACHE_VS_1
-0x00028988 SQ_ALU_CONST_CACHE_VS_2
-0x0002898C SQ_ALU_CONST_CACHE_VS_3
-0x00028990 SQ_ALU_CONST_CACHE_VS_4
-0x00028994 SQ_ALU_CONST_CACHE_VS_5
-0x00028998 SQ_ALU_CONST_CACHE_VS_6
-0x0002899C SQ_ALU_CONST_CACHE_VS_7
-0x000289A0 SQ_ALU_CONST_CACHE_VS_8
-0x000289A4 SQ_ALU_CONST_CACHE_VS_9
-0x000289A8 SQ_ALU_CONST_CACHE_VS_10
-0x000289AC SQ_ALU_CONST_CACHE_VS_11
-0x000289B0 SQ_ALU_CONST_CACHE_VS_12
-0x000289B4 SQ_ALU_CONST_CACHE_VS_13
-0x000289B8 SQ_ALU_CONST_CACHE_VS_14
-0x000289BC SQ_ALU_CONST_CACHE_VS_15
 0x000288D8 SQ_PGM_CF_OFFSET_ES
 0x000288DC SQ_PGM_CF_OFFSET_FS
 0x000288D4 SQ_PGM_CF_OFFSET_GS
@@ -494,12 +429,7 @@
 0x00028438 SX_ALPHA_REF
 0x00028410 SX_ALPHA_TEST_CONTROL
 0x00028350 SX_MISC
-0x0000A020 SMX_DC_CTL0
-0x0000A024 SMX_DC_CTL1
-0x0000A028 SMX_DC_CTL2
-0x00009608 TC_CNTL
 0x00009604 TC_INVALIDATE
-0x00009490 TD_CNTL
 0x00009400 TD_FILTER4
 0x00009404 TD_FILTER4_1
 0x00009408 TD_FILTER4_2
@@ -824,14 +754,9 @@
 0x00028428 CB_FOG_GREEN
 0x00028424 CB_FOG_RED
 0x00008040 WAIT_UNTIL
-0x00008950 CC_GC_SHADER_PIPE_CONFIG
-0x00008954 GC_USER_SHADER_PIPE_CONFIG
 0x00009714 VC_ENHANCE
 0x00009830 DB_DEBUG
 0x00009838 DB_WATERMARKS
 0x00028D28 DB_SRESULTS_COMPARE_STATE0
 0x00028D44 DB_ALPHA_TO_MASK
-0x00009504 TA_CNTL
 0x00009700 VC_CNTL
-0x00009718 VC_CONFIG
-0x0000A02C SMX_DC_MC_INTF_CTL
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs400.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs400.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs400.c	2010-04-13 02:18:55.713633100 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs400.c	2010-04-13 02:19:00.836633030 +0000
@@ -26,8 +26,10 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <drm/drmP.h>
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "rs400d.h"
 
 /* This files gather functions specifics to : rs400,rs480 */
@@ -202,9 +204,9 @@
 
 void rs400_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	rs400_gart_disable(rdev);
 	radeon_gart_table_ram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 int rs400_gart_set_page(struct radeon_device *rdev, int i, uint64_t addr)
@@ -264,6 +266,7 @@
 	base = (RREG32(RADEON_NB_TOM) & 0xffff) << 16;
 	radeon_vram_location(rdev, &rdev->mc, base);
 	radeon_gtt_location(rdev, &rdev->mc);
+	radeon_update_bandwidth_info(rdev);
 }
 
 uint32_t rs400_mc_rreg(struct radeon_device *rdev, uint32_t reg)
@@ -388,6 +391,8 @@
 {
 	int r;
 
+	r100_set_common_regs(rdev);
+
 	rs400_mc_program(rdev);
 	/* Resume clock */
 	r300_clock_startup(rdev);
@@ -453,6 +458,7 @@
 
 void rs400_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs600.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs600.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs600.c	2010-04-13 02:18:55.714633075 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs600.c	2010-04-13 02:19:00.837633068 +0000
@@ -37,6 +37,7 @@
  */
 #include "drmP.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "atom.h"
 #include "rs600d.h"
 
@@ -267,9 +268,9 @@
 
 void rs600_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	rs600_gart_disable(rdev);
 	radeon_gart_table_vram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 #define R600_PTE_VALID     (1 << 0)
@@ -392,10 +393,12 @@
 		/* Vertical blank interrupts */
 		if (G_007EDC_LB_D1_VBLANK_INTERRUPT(r500_disp_int)) {
 			drm_handle_vblank(rdev->ddev, 0);
+			rdev->pm.vblank_sync = true;
 			wake_up(&rdev->irq.vblank_queue);
 		}
 		if (G_007EDC_LB_D2_VBLANK_INTERRUPT(r500_disp_int)) {
 			drm_handle_vblank(rdev->ddev, 1);
+			rdev->pm.vblank_sync = true;
 			wake_up(&rdev->irq.vblank_queue);
 		}
 		if (G_007EDC_DC_HOT_PLUG_DETECT1_INTERRUPT(r500_disp_int)) {
@@ -472,13 +475,38 @@
 	rdev->mc.igp_sideport_enabled = radeon_atombios_sideport_present(rdev);
 	base = RREG32_MC(R_000004_MC_FB_LOCATION);
 	base = G_000004_MC_FB_START(base) << 16;
+	rdev->mc.igp_sideport_enabled = radeon_atombios_sideport_present(rdev);
 	radeon_vram_location(rdev, &rdev->mc, base);
 	radeon_gtt_location(rdev, &rdev->mc);
+	radeon_update_bandwidth_info(rdev);
 }
 
 void rs600_bandwidth_update(struct radeon_device *rdev)
 {
-	/* FIXME: implement, should this be like rs690 ? */
+	struct drm_display_mode *mode0 = NULL;
+	struct drm_display_mode *mode1 = NULL;
+	u32 d1mode_priority_a_cnt, d2mode_priority_a_cnt;
+	/* FIXME: implement full support */
+
+	radeon_update_display_priority(rdev);
+
+	if (rdev->mode_info.crtcs[0]->base.enabled)
+		mode0 = &rdev->mode_info.crtcs[0]->base.mode;
+	if (rdev->mode_info.crtcs[1]->base.enabled)
+		mode1 = &rdev->mode_info.crtcs[1]->base.mode;
+
+	rs690_line_buffer_adjust(rdev, mode0, mode1);
+
+	if (rdev->disp_priority == 2) {
+		d1mode_priority_a_cnt = RREG32(R_006548_D1MODE_PRIORITY_A_CNT);
+		d2mode_priority_a_cnt = RREG32(R_006D48_D2MODE_PRIORITY_A_CNT);
+		d1mode_priority_a_cnt |= S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(1);
+		d2mode_priority_a_cnt |= S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(1);
+		WREG32(R_006548_D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);
+		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT, d1mode_priority_a_cnt);
+		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);
+		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, d2mode_priority_a_cnt);
+	}
 }
 
 uint32_t rs600_mc_rreg(struct radeon_device *rdev, uint32_t reg)
@@ -598,6 +626,7 @@
 
 void rs600_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs600d.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs600d.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs600d.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs600d.h	2010-04-13 02:19:00.837633068 +0000
@@ -535,4 +535,57 @@
 #define   G_00016C_INVALIDATE_L1_TLB(x)                (((x) >> 20) & 0x1)
 #define   C_00016C_INVALIDATE_L1_TLB                   0xFFEFFFFF
 
+#define R_006548_D1MODE_PRIORITY_A_CNT               0x006548
+#define   S_006548_D1MODE_PRIORITY_MARK_A(x)           (((x) & 0x7FFF) << 0)
+#define   G_006548_D1MODE_PRIORITY_MARK_A(x)           (((x) >> 0) & 0x7FFF)
+#define   C_006548_D1MODE_PRIORITY_MARK_A              0xFFFF8000
+#define   S_006548_D1MODE_PRIORITY_A_OFF(x)            (((x) & 0x1) << 16)
+#define   G_006548_D1MODE_PRIORITY_A_OFF(x)            (((x) >> 16) & 0x1)
+#define   C_006548_D1MODE_PRIORITY_A_OFF               0xFFFEFFFF
+#define   S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) & 0x1) << 20)
+#define   G_006548_D1MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) >> 20) & 0x1)
+#define   C_006548_D1MODE_PRIORITY_A_ALWAYS_ON         0xFFEFFFFF
+#define   S_006548_D1MODE_PRIORITY_A_FORCE_MASK(x)     (((x) & 0x1) << 24)
+#define   G_006548_D1MODE_PRIORITY_A_FORCE_MASK(x)     (((x) >> 24) & 0x1)
+#define   C_006548_D1MODE_PRIORITY_A_FORCE_MASK        0xFEFFFFFF
+#define R_00654C_D1MODE_PRIORITY_B_CNT               0x00654C
+#define   S_00654C_D1MODE_PRIORITY_MARK_B(x)           (((x) & 0x7FFF) << 0)
+#define   G_00654C_D1MODE_PRIORITY_MARK_B(x)           (((x) >> 0) & 0x7FFF)
+#define   C_00654C_D1MODE_PRIORITY_MARK_B              0xFFFF8000
+#define   S_00654C_D1MODE_PRIORITY_B_OFF(x)            (((x) & 0x1) << 16)
+#define   G_00654C_D1MODE_PRIORITY_B_OFF(x)            (((x) >> 16) & 0x1)
+#define   C_00654C_D1MODE_PRIORITY_B_OFF               0xFFFEFFFF
+#define   S_00654C_D1MODE_PRIORITY_B_ALWAYS_ON(x)      (((x) & 0x1) << 20)
+#define   G_00654C_D1MODE_PRIORITY_B_ALWAYS_ON(x)      (((x) >> 20) & 0x1)
+#define   C_00654C_D1MODE_PRIORITY_B_ALWAYS_ON         0xFFEFFFFF
+#define   S_00654C_D1MODE_PRIORITY_B_FORCE_MASK(x)     (((x) & 0x1) << 24)
+#define   G_00654C_D1MODE_PRIORITY_B_FORCE_MASK(x)     (((x) >> 24) & 0x1)
+#define   C_00654C_D1MODE_PRIORITY_B_FORCE_MASK        0xFEFFFFFF
+#define R_006D48_D2MODE_PRIORITY_A_CNT               0x006D48
+#define   S_006D48_D2MODE_PRIORITY_MARK_A(x)           (((x) & 0x7FFF) << 0)
+#define   G_006D48_D2MODE_PRIORITY_MARK_A(x)           (((x) >> 0) & 0x7FFF)
+#define   C_006D48_D2MODE_PRIORITY_MARK_A              0xFFFF8000
+#define   S_006D48_D2MODE_PRIORITY_A_OFF(x)            (((x) & 0x1) << 16)
+#define   G_006D48_D2MODE_PRIORITY_A_OFF(x)            (((x) >> 16) & 0x1)
+#define   C_006D48_D2MODE_PRIORITY_A_OFF               0xFFFEFFFF
+#define   S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) & 0x1) << 20)
+#define   G_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) >> 20) & 0x1)
+#define   C_006D48_D2MODE_PRIORITY_A_ALWAYS_ON         0xFFEFFFFF
+#define   S_006D48_D2MODE_PRIORITY_A_FORCE_MASK(x)     (((x) & 0x1) << 24)
+#define   G_006D48_D2MODE_PRIORITY_A_FORCE_MASK(x)     (((x) >> 24) & 0x1)
+#define   C_006D48_D2MODE_PRIORITY_A_FORCE_MASK        0xFEFFFFFF
+#define R_006D4C_D2MODE_PRIORITY_B_CNT               0x006D4C
+#define   S_006D4C_D2MODE_PRIORITY_MARK_B(x)           (((x) & 0x7FFF) << 0)
+#define   G_006D4C_D2MODE_PRIORITY_MARK_B(x)           (((x) >> 0) & 0x7FFF)
+#define   C_006D4C_D2MODE_PRIORITY_MARK_B              0xFFFF8000
+#define   S_006D4C_D2MODE_PRIORITY_B_OFF(x)            (((x) & 0x1) << 16)
+#define   G_006D4C_D2MODE_PRIORITY_B_OFF(x)            (((x) >> 16) & 0x1)
+#define   C_006D4C_D2MODE_PRIORITY_B_OFF               0xFFFEFFFF
+#define   S_006D4C_D2MODE_PRIORITY_B_ALWAYS_ON(x)      (((x) & 0x1) << 20)
+#define   G_006D4C_D2MODE_PRIORITY_B_ALWAYS_ON(x)      (((x) >> 20) & 0x1)
+#define   C_006D4C_D2MODE_PRIORITY_B_ALWAYS_ON         0xFFEFFFFF
+#define   S_006D4C_D2MODE_PRIORITY_B_FORCE_MASK(x)     (((x) & 0x1) << 24)
+#define   G_006D4C_D2MODE_PRIORITY_B_FORCE_MASK(x)     (((x) >> 24) & 0x1)
+#define   C_006D4C_D2MODE_PRIORITY_B_FORCE_MASK        0xFEFFFFFF
+
 #endif
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs690.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs690.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs690.c	2010-04-13 02:18:55.714633075 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs690.c	2010-04-13 02:19:00.837633068 +0000
@@ -27,6 +27,7 @@
  */
 #include "drmP.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "atom.h"
 #include "rs690d.h"
 
@@ -57,42 +58,57 @@
 	}
 }
 
+union igp_info {
+	struct _ATOM_INTEGRATED_SYSTEM_INFO info;
+	struct _ATOM_INTEGRATED_SYSTEM_INFO_V2 info_v2;
+};
+
 void rs690_pm_info(struct radeon_device *rdev)
 {
 	int index = GetIndexIntoMasterTable(DATA, IntegratedSystemInfo);
-	struct _ATOM_INTEGRATED_SYSTEM_INFO *info;
-	struct _ATOM_INTEGRATED_SYSTEM_INFO_V2 *info_v2;
-	void *ptr;
+	union igp_info *info;
 	uint16_t data_offset;
 	uint8_t frev, crev;
 	fixed20_12 tmp;
 
-	atom_parse_data_header(rdev->mode_info.atom_context, index, NULL,
-			       &frev, &crev, &data_offset);
-	ptr = rdev->mode_info.atom_context->bios + data_offset;
-	info = (struct _ATOM_INTEGRATED_SYSTEM_INFO *)ptr;
-	info_v2 = (struct _ATOM_INTEGRATED_SYSTEM_INFO_V2 *)ptr;
-	/* Get various system informations from bios */
-	switch (crev) {
-	case 1:
-		tmp.full = rfixed_const(100);
-		rdev->pm.igp_sideport_mclk.full = rfixed_const(info->ulBootUpMemoryClock);
-		rdev->pm.igp_sideport_mclk.full = rfixed_div(rdev->pm.igp_sideport_mclk, tmp);
-		rdev->pm.igp_system_mclk.full = rfixed_const(le16_to_cpu(info->usK8MemoryClock));
-		rdev->pm.igp_ht_link_clk.full = rfixed_const(le16_to_cpu(info->usFSBClock));
-		rdev->pm.igp_ht_link_width.full = rfixed_const(info->ucHTLinkWidth);
-		break;
-	case 2:
-		tmp.full = rfixed_const(100);
-		rdev->pm.igp_sideport_mclk.full = rfixed_const(info_v2->ulBootUpSidePortClock);
-		rdev->pm.igp_sideport_mclk.full = rfixed_div(rdev->pm.igp_sideport_mclk, tmp);
-		rdev->pm.igp_system_mclk.full = rfixed_const(info_v2->ulBootUpUMAClock);
-		rdev->pm.igp_system_mclk.full = rfixed_div(rdev->pm.igp_system_mclk, tmp);
-		rdev->pm.igp_ht_link_clk.full = rfixed_const(info_v2->ulHTLinkFreq);
-		rdev->pm.igp_ht_link_clk.full = rfixed_div(rdev->pm.igp_ht_link_clk, tmp);
-		rdev->pm.igp_ht_link_width.full = rfixed_const(le16_to_cpu(info_v2->usMinHTLinkWidth));
-		break;
-	default:
+	if (atom_parse_data_header(rdev->mode_info.atom_context, index, NULL,
+				   &frev, &crev, &data_offset)) {
+		info = (union igp_info *)(rdev->mode_info.atom_context->bios + data_offset);
+
+		/* Get various system informations from bios */
+		switch (crev) {
+		case 1:
+			tmp.full = rfixed_const(100);
+			rdev->pm.igp_sideport_mclk.full = rfixed_const(info->info.ulBootUpMemoryClock);
+			rdev->pm.igp_sideport_mclk.full = rfixed_div(rdev->pm.igp_sideport_mclk, tmp);
+			rdev->pm.igp_system_mclk.full = rfixed_const(le16_to_cpu(info->info.usK8MemoryClock));
+			rdev->pm.igp_ht_link_clk.full = rfixed_const(le16_to_cpu(info->info.usFSBClock));
+			rdev->pm.igp_ht_link_width.full = rfixed_const(info->info.ucHTLinkWidth);
+			break;
+		case 2:
+			tmp.full = rfixed_const(100);
+			rdev->pm.igp_sideport_mclk.full = rfixed_const(info->info_v2.ulBootUpSidePortClock);
+			rdev->pm.igp_sideport_mclk.full = rfixed_div(rdev->pm.igp_sideport_mclk, tmp);
+			rdev->pm.igp_system_mclk.full = rfixed_const(info->info_v2.ulBootUpUMAClock);
+			rdev->pm.igp_system_mclk.full = rfixed_div(rdev->pm.igp_system_mclk, tmp);
+			rdev->pm.igp_ht_link_clk.full = rfixed_const(info->info_v2.ulHTLinkFreq);
+			rdev->pm.igp_ht_link_clk.full = rfixed_div(rdev->pm.igp_ht_link_clk, tmp);
+			rdev->pm.igp_ht_link_width.full = rfixed_const(le16_to_cpu(info->info_v2.usMinHTLinkWidth));
+			break;
+		default:
+			tmp.full = rfixed_const(100);
+			/* We assume the slower possible clock ie worst case */
+			/* DDR 333Mhz */
+			rdev->pm.igp_sideport_mclk.full = rfixed_const(333);
+			/* FIXME: system clock ? */
+			rdev->pm.igp_system_mclk.full = rfixed_const(100);
+			rdev->pm.igp_system_mclk.full = rfixed_div(rdev->pm.igp_system_mclk, tmp);
+			rdev->pm.igp_ht_link_clk.full = rfixed_const(200);
+			rdev->pm.igp_ht_link_width.full = rfixed_const(8);
+			DRM_ERROR("No integrated system info for your GPU, using safe default\n");
+			break;
+		}
+	} else {
 		tmp.full = rfixed_const(100);
 		/* We assume the slower possible clock ie worst case */
 		/* DDR 333Mhz */
@@ -103,7 +119,6 @@
 		rdev->pm.igp_ht_link_clk.full = rfixed_const(200);
 		rdev->pm.igp_ht_link_width.full = rfixed_const(8);
 		DRM_ERROR("No integrated system info for your GPU, using safe default\n");
-		break;
 	}
 	/* Compute various bandwidth */
 	/* k8_bandwidth = (memory_clk / 2) * 2 * 8 * 0.5 = memory_clk * 4  */
@@ -131,7 +146,6 @@
 
 void rs690_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 	u64 base;
 
 	rs400_gart_adjust_size(rdev);
@@ -145,18 +159,10 @@
 	base = RREG32_MC(R_000100_MCCFG_FB_LOCATION);
 	base = G_000100_MC_FB_START(base) << 16;
 	rs690_pm_info(rdev);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
-	a.full = rfixed_const(16);
-	/* core_bandwidth = sclk(Mhz) * 16 */
-	rdev->pm.core_bandwidth.full = rfixed_div(rdev->pm.sclk, a);
 	rdev->mc.igp_sideport_enabled = radeon_atombios_sideport_present(rdev);
 	radeon_vram_location(rdev, &rdev->mc, base);
 	radeon_gtt_location(rdev, &rdev->mc);
+	radeon_update_bandwidth_info(rdev);
 }
 
 void rs690_line_buffer_adjust(struct radeon_device *rdev,
@@ -394,10 +400,12 @@
 	struct drm_display_mode *mode1 = NULL;
 	struct rs690_watermark wm0;
 	struct rs690_watermark wm1;
-	u32 tmp;
+	u32 tmp, d1mode_priority_a_cnt, d2mode_priority_a_cnt;
 	fixed20_12 priority_mark02, priority_mark12, fill_rate;
 	fixed20_12 a, b;
 
+	radeon_update_display_priority(rdev);
+
 	if (rdev->mode_info.crtcs[0]->base.enabled)
 		mode0 = &rdev->mode_info.crtcs[0]->base.mode;
 	if (rdev->mode_info.crtcs[1]->base.enabled)
@@ -407,7 +415,8 @@
 	 * modes if the user specifies HIGH for displaypriority
 	 * option.
 	 */
-	if (rdev->disp_priority == 2) {
+	if ((rdev->disp_priority == 2) &&
+	    ((rdev->family == CHIP_RS690) || (rdev->family == CHIP_RS740))) {
 		tmp = RREG32_MC(R_000104_MC_INIT_MISC_LAT_TIMER);
 		tmp &= C_000104_MC_DISP0R_INIT_LAT;
 		tmp &= C_000104_MC_DISP1R_INIT_LAT;
@@ -482,10 +491,16 @@
 			priority_mark12.full = 0;
 		if (wm1.priority_mark_max.full > priority_mark12.full)
 			priority_mark12.full = wm1.priority_mark_max.full;
-		WREG32(R_006548_D1MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark02));
-		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark02));
-		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark12));
-		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark12));
+		d1mode_priority_a_cnt = rfixed_trunc(priority_mark02);
+		d2mode_priority_a_cnt = rfixed_trunc(priority_mark12);
+		if (rdev->disp_priority == 2) {
+			d1mode_priority_a_cnt |= S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(1);
+			d2mode_priority_a_cnt |= S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(1);
+		}
+		WREG32(R_006548_D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);
+		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT, d1mode_priority_a_cnt);
+		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);
+		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, d2mode_priority_a_cnt);
 	} else if (mode0) {
 		if (rfixed_trunc(wm0.dbpp) > 64)
 			a.full = rfixed_mul(wm0.dbpp, wm0.num_line_pair);
@@ -512,8 +527,11 @@
 			priority_mark02.full = 0;
 		if (wm0.priority_mark_max.full > priority_mark02.full)
 			priority_mark02.full = wm0.priority_mark_max.full;
-		WREG32(R_006548_D1MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark02));
-		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark02));
+		d1mode_priority_a_cnt = rfixed_trunc(priority_mark02);
+		if (rdev->disp_priority == 2)
+			d1mode_priority_a_cnt |= S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(1);
+		WREG32(R_006548_D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);
+		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT, d1mode_priority_a_cnt);
 		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT,
 			S_006D48_D2MODE_PRIORITY_A_OFF(1));
 		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT,
@@ -544,12 +562,15 @@
 			priority_mark12.full = 0;
 		if (wm1.priority_mark_max.full > priority_mark12.full)
 			priority_mark12.full = wm1.priority_mark_max.full;
+		d2mode_priority_a_cnt = rfixed_trunc(priority_mark12);
+		if (rdev->disp_priority == 2)
+			d2mode_priority_a_cnt |= S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(1);
 		WREG32(R_006548_D1MODE_PRIORITY_A_CNT,
 			S_006548_D1MODE_PRIORITY_A_OFF(1));
 		WREG32(R_00654C_D1MODE_PRIORITY_B_CNT,
 			S_00654C_D1MODE_PRIORITY_B_OFF(1));
-		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark12));
-		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark12));
+		WREG32(R_006D48_D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);
+		WREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, d2mode_priority_a_cnt);
 	}
 }
 
@@ -657,6 +678,7 @@
 
 void rs690_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs690d.h linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs690d.h
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rs690d.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rs690d.h	2010-04-13 02:19:00.837633068 +0000
@@ -182,6 +182,9 @@
 #define   S_006548_D1MODE_PRIORITY_A_OFF(x)            (((x) & 0x1) << 16)
 #define   G_006548_D1MODE_PRIORITY_A_OFF(x)            (((x) >> 16) & 0x1)
 #define   C_006548_D1MODE_PRIORITY_A_OFF               0xFFFEFFFF
+#define   S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) & 0x1) << 20)
+#define   G_006548_D1MODE_PRIORITY_A_ALWAYS_ON(x)      (((x) >> 20) & 0x1)
+#define   C_006548_D1MODE_PRIORITY_A_ALWAYS_ON         0xFFEFFFFF
 #define   S_006548_D1MODE_PRIORITY_A_FORCE_MASK(x)     (((x) & 0x1) << 24)
 #define   G_006548_D1MODE_PRIORITY_A_FORCE_MASK(x)     (((x) >> 24) & 0x1)
 #define   C_006548_D1MODE_PRIORITY_A_FORCE_MASK        0xFEFFFFFF
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rv515.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/rv515.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rv515.c	2010-04-13 02:18:55.714633075 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rv515.c	2010-04-13 02:19:00.837633068 +0000
@@ -26,9 +26,11 @@
  *          Jerome Glisse
  */
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "rv515d.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "atom.h"
 #include "rv515_reg_safe.h"
 
@@ -279,19 +281,13 @@
 
 void rv515_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 
 	rv515_vram_get_type(rdev);
 	r100_vram_init_sizes(rdev);
 	radeon_vram_location(rdev, &rdev->mc, 0);
 	if (!(rdev->flags & RADEON_IS_AGP))
 		radeon_gtt_location(rdev, &rdev->mc);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+	radeon_update_bandwidth_info(rdev);
 }
 
 uint32_t rv515_mc_rreg(struct radeon_device *rdev, uint32_t reg)
@@ -539,6 +535,7 @@
 
 void rv515_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r100_cp_fini(rdev);
 	r100_wb_fini(rdev);
 	r100_ib_fini(rdev);
@@ -1020,7 +1017,7 @@
 	struct drm_display_mode *mode1 = NULL;
 	struct rv515_watermark wm0;
 	struct rv515_watermark wm1;
-	u32 tmp;
+	u32 tmp, d1mode_priority_a_cnt, d2mode_priority_a_cnt;
 	fixed20_12 priority_mark02, priority_mark12, fill_rate;
 	fixed20_12 a, b;
 
@@ -1088,10 +1085,16 @@
 			priority_mark12.full = 0;
 		if (wm1.priority_mark_max.full > priority_mark12.full)
 			priority_mark12.full = wm1.priority_mark_max.full;
-		WREG32(D1MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark02));
-		WREG32(D1MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark02));
-		WREG32(D2MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark12));
-		WREG32(D2MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark12));
+		d1mode_priority_a_cnt = rfixed_trunc(priority_mark02);
+		d2mode_priority_a_cnt = rfixed_trunc(priority_mark12);
+		if (rdev->disp_priority == 2) {
+			d1mode_priority_a_cnt |= MODE_PRIORITY_ALWAYS_ON;
+			d2mode_priority_a_cnt |= MODE_PRIORITY_ALWAYS_ON;
+		}
+		WREG32(D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);
+		WREG32(D1MODE_PRIORITY_B_CNT, d1mode_priority_a_cnt);
+		WREG32(D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);
+		WREG32(D2MODE_PRIORITY_B_CNT, d2mode_priority_a_cnt);
 	} else if (mode0) {
 		if (rfixed_trunc(wm0.dbpp) > 64)
 			a.full = rfixed_div(wm0.dbpp, wm0.num_line_pair);
@@ -1118,8 +1121,11 @@
 			priority_mark02.full = 0;
 		if (wm0.priority_mark_max.full > priority_mark02.full)
 			priority_mark02.full = wm0.priority_mark_max.full;
-		WREG32(D1MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark02));
-		WREG32(D1MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark02));
+		d1mode_priority_a_cnt = rfixed_trunc(priority_mark02);
+		if (rdev->disp_priority == 2)
+			d1mode_priority_a_cnt |= MODE_PRIORITY_ALWAYS_ON;
+		WREG32(D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);
+		WREG32(D1MODE_PRIORITY_B_CNT, d1mode_priority_a_cnt);
 		WREG32(D2MODE_PRIORITY_A_CNT, MODE_PRIORITY_OFF);
 		WREG32(D2MODE_PRIORITY_B_CNT, MODE_PRIORITY_OFF);
 	} else {
@@ -1148,10 +1154,13 @@
 			priority_mark12.full = 0;
 		if (wm1.priority_mark_max.full > priority_mark12.full)
 			priority_mark12.full = wm1.priority_mark_max.full;
+		d2mode_priority_a_cnt = rfixed_trunc(priority_mark12);
+		if (rdev->disp_priority == 2)
+			d2mode_priority_a_cnt |= MODE_PRIORITY_ALWAYS_ON;
 		WREG32(D1MODE_PRIORITY_A_CNT, MODE_PRIORITY_OFF);
 		WREG32(D1MODE_PRIORITY_B_CNT, MODE_PRIORITY_OFF);
-		WREG32(D2MODE_PRIORITY_A_CNT, rfixed_trunc(priority_mark12));
-		WREG32(D2MODE_PRIORITY_B_CNT, rfixed_trunc(priority_mark12));
+		WREG32(D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);
+		WREG32(D2MODE_PRIORITY_B_CNT, d2mode_priority_a_cnt);
 	}
 }
 
@@ -1161,6 +1170,8 @@
 	struct drm_display_mode *mode0 = NULL;
 	struct drm_display_mode *mode1 = NULL;
 
+	radeon_update_display_priority(rdev);
+
 	if (rdev->mode_info.crtcs[0]->base.enabled)
 		mode0 = &rdev->mode_info.crtcs[0]->base.mode;
 	if (rdev->mode_info.crtcs[1]->base.enabled)
@@ -1170,7 +1181,8 @@
 	 * modes if the user specifies HIGH for displaypriority
 	 * option.
 	 */
-	if (rdev->disp_priority == 2) {
+	if ((rdev->disp_priority == 2) &&
+	    (rdev->family == CHIP_RV515)) {
 		tmp = RREG32_MC(MC_MISC_LAT_TIMER);
 		tmp &= ~MC_DISP1R_INIT_LAT_MASK;
 		tmp &= ~MC_DISP0R_INIT_LAT_MASK;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/radeon/rv770.c linux-2.6.34-rc4/drivers/gpu/drm/radeon/rv770.c
--- linux-2.6.34-rc3/drivers/gpu/drm/radeon/rv770.c	2010-04-13 02:18:55.714633075 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/radeon/rv770.c	2010-04-13 02:19:00.838633010 +0000
@@ -27,8 +27,10 @@
  */
 #include <linux/firmware.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include "drmP.h"
 #include "radeon.h"
+#include "radeon_asic.h"
 #include "radeon_drm.h"
 #include "rv770d.h"
 #include "atom.h"
@@ -125,9 +127,9 @@
 
 void rv770_pcie_gart_fini(struct radeon_device *rdev)
 {
+	radeon_gart_fini(rdev);
 	rv770_pcie_gart_disable(rdev);
 	radeon_gart_table_vram_free(rdev);
-	radeon_gart_fini(rdev);
 }
 
 
@@ -647,10 +649,13 @@
 
 	WREG32(CC_RB_BACKEND_DISABLE,      cc_rb_backend_disable);
 	WREG32(CC_GC_SHADER_PIPE_CONFIG,   cc_gc_shader_pipe_config);
+	WREG32(GC_USER_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);
 	WREG32(CC_SYS_RB_BACKEND_DISABLE,  cc_rb_backend_disable);
 
 	WREG32(CGTS_SYS_TCC_DISABLE, 0);
 	WREG32(CGTS_TCC_DISABLE, 0);
+	WREG32(CGTS_USER_SYS_TCC_DISABLE, 0);
+	WREG32(CGTS_USER_TCC_DISABLE, 0);
 
 	num_qd_pipes =
 		R7XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & INACTIVE_QD_PIPES_MASK) >> 8);
@@ -864,7 +869,6 @@
 
 int rv770_mc_init(struct radeon_device *rdev)
 {
-	fixed20_12 a;
 	u32 tmp;
 	int chansize, numchan;
 
@@ -908,12 +912,8 @@
 		rdev->mc.real_vram_size = rdev->mc.aper_size;
 	}
 	r600_vram_gtt_location(rdev, &rdev->mc);
-	/* FIXME: we should enforce default clock in case GPU is not in
-	 * default setup
-	 */
-	a.full = rfixed_const(100);
-	rdev->pm.sclk.full = rfixed_const(rdev->clock.default_sclk);
-	rdev->pm.sclk.full = rfixed_div(rdev->pm.sclk, a);
+	radeon_update_bandwidth_info(rdev);
+
 	return 0;
 }
 
@@ -1013,6 +1013,13 @@
 		DRM_ERROR("radeon: failled testing IB (%d).\n", r);
 		return r;
 	}
+
+	r = r600_audio_init(rdev);
+	if (r) {
+		dev_err(rdev->dev, "radeon: audio init failed\n");
+		return r;
+	}
+
 	return r;
 
 }
@@ -1021,6 +1028,7 @@
 {
 	int r;
 
+	r600_audio_fini(rdev);
 	/* FIXME: we should wait for ring to be empty */
 	r700_cp_stop(rdev);
 	rdev->cp.ready = false;
@@ -1144,11 +1152,19 @@
 			}
 		}
 	}
+
+	r = r600_audio_init(rdev);
+	if (r) {
+		dev_err(rdev->dev, "radeon: audio init failed\n");
+		return r;
+	}
+
 	return 0;
 }
 
 void rv770_fini(struct radeon_device *rdev)
 {
+	radeon_pm_fini(rdev);
 	r600_blit_fini(rdev);
 	r600_cp_fini(rdev);
 	r600_wb_fini(rdev);
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_agp_backend.c linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_agp_backend.c
--- linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_agp_backend.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_agp_backend.c	2010-04-13 02:19:00.838633010 +0000
@@ -35,6 +35,7 @@
 #include "ttm/ttm_placement.h"
 #include <linux/agp_backend.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <asm/agp.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_bo.c linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_bo.c
--- linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_bo.c	2010-04-13 02:18:55.715633038 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_bo.c	2010-04-13 02:19:00.838633010 +0000
@@ -1425,8 +1425,8 @@
 
 	atomic_set(&glob->bo_count, 0);
 
-	kobject_init(&glob->kobj, &ttm_bo_glob_kobj_type);
-	ret = kobject_add(&glob->kobj, ttm_get_kobj(), "buffer_objects");
+	ret = kobject_init_and_add(
+		&glob->kobj, &ttm_bo_glob_kobj_type, ttm_get_kobj(), "buffer_objects");
 	if (unlikely(ret != 0))
 		kobject_put(&glob->kobj);
 	return ret;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_bo_util.c linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_bo_util.c
--- linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_bo_util.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_bo_util.c	2010-04-13 02:19:00.838633010 +0000
@@ -33,6 +33,7 @@
 #include <linux/io.h>
 #include <linux/highmem.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/module.h>
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_memory.c linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_memory.c
--- linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_memory.c	2010-04-13 02:18:55.715633038 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_memory.c	2010-04-13 02:19:00.839633036 +0000
@@ -32,6 +32,7 @@
 #include <linux/wait.h>
 #include <linux/mm.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #define TTM_MEMORY_ALLOC_RETRIES 4
 
@@ -260,8 +261,8 @@
 	zone->used_mem = 0;
 	zone->glob = glob;
 	glob->zone_kernel = zone;
-	kobject_init(&zone->kobj, &ttm_mem_zone_kobj_type);
-	ret = kobject_add(&zone->kobj, &glob->kobj, zone->name);
+	ret = kobject_init_and_add(
+		&zone->kobj, &ttm_mem_zone_kobj_type, &glob->kobj, zone->name);
 	if (unlikely(ret != 0)) {
 		kobject_put(&zone->kobj);
 		return ret;
@@ -296,8 +297,8 @@
 	zone->used_mem = 0;
 	zone->glob = glob;
 	glob->zone_highmem = zone;
-	kobject_init(&zone->kobj, &ttm_mem_zone_kobj_type);
-	ret = kobject_add(&zone->kobj, &glob->kobj, zone->name);
+	ret = kobject_init_and_add(
+		&zone->kobj, &ttm_mem_zone_kobj_type, &glob->kobj, zone->name);
 	if (unlikely(ret != 0)) {
 		kobject_put(&zone->kobj);
 		return ret;
@@ -343,8 +344,8 @@
 	zone->used_mem = 0;
 	zone->glob = glob;
 	glob->zone_dma32 = zone;
-	kobject_init(&zone->kobj, &ttm_mem_zone_kobj_type);
-	ret = kobject_add(&zone->kobj, &glob->kobj, zone->name);
+	ret = kobject_init_and_add(
+		&zone->kobj, &ttm_mem_zone_kobj_type, &glob->kobj, zone->name);
 	if (unlikely(ret != 0)) {
 		kobject_put(&zone->kobj);
 		return ret;
@@ -365,10 +366,8 @@
 	glob->swap_queue = create_singlethread_workqueue("ttm_swap");
 	INIT_WORK(&glob->work, ttm_shrink_work);
 	init_waitqueue_head(&glob->queue);
-	kobject_init(&glob->kobj, &ttm_mem_glob_kobj_type);
-	ret = kobject_add(&glob->kobj,
-			  ttm_get_kobj(),
-			  "memory_accounting");
+	ret = kobject_init_and_add(
+		&glob->kobj, &ttm_mem_glob_kobj_type, ttm_get_kobj(), "memory_accounting");
 	if (unlikely(ret != 0)) {
 		kobject_put(&glob->kobj);
 		return ret;
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_tt.c linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_tt.c
--- linux-2.6.34-rc3/drivers/gpu/drm/ttm/ttm_tt.c	2010-04-13 02:18:55.715633038 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/ttm/ttm_tt.c	2010-04-13 02:19:00.839633036 +0000
@@ -28,13 +28,14 @@
  * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>
  */
 
-#include <linux/vmalloc.h>
 #include <linux/sched.h>
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/file.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 #include "drm_cache.h"
+#include "drm_mem_util.h"
 #include "ttm/ttm_module.h"
 #include "ttm/ttm_bo_driver.h"
 #include "ttm/ttm_placement.h"
@@ -43,32 +44,15 @@
 
 /**
  * Allocates storage for pointers to the pages that back the ttm.
- *
- * Uses kmalloc if possible. Otherwise falls back to vmalloc.
  */
 static void ttm_tt_alloc_page_directory(struct ttm_tt *ttm)
 {
-	unsigned long size = ttm->num_pages * sizeof(*ttm->pages);
-	ttm->pages = NULL;
-
-	if (size <= PAGE_SIZE)
-		ttm->pages = kzalloc(size, GFP_KERNEL);
-
-	if (!ttm->pages) {
-		ttm->pages = vmalloc_user(size);
-		if (ttm->pages)
-			ttm->page_flags |= TTM_PAGE_FLAG_VMALLOC;
-	}
+	ttm->pages = drm_calloc_large(ttm->num_pages, sizeof(*ttm->pages));
 }
 
 static void ttm_tt_free_page_directory(struct ttm_tt *ttm)
 {
-	if (ttm->page_flags & TTM_PAGE_FLAG_VMALLOC) {
-		vfree(ttm->pages);
-		ttm->page_flags &= ~TTM_PAGE_FLAG_VMALLOC;
-	} else {
-		kfree(ttm->pages);
-	}
+	drm_free_large(ttm->pages);
 	ttm->pages = NULL;
 }
 
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/via/via_dmablit.c linux-2.6.34-rc4/drivers/gpu/drm/via/via_dmablit.c
--- linux-2.6.34-rc3/drivers/gpu/drm/via/via_dmablit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/via/via_dmablit.c	2010-04-13 02:19:00.839633036 +0000
@@ -40,6 +40,7 @@
 #include "via_dmablit.h"
 
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 
 #define VIA_PGDN(x)	     (((unsigned long)(x)) & PAGE_MASK)
 #define VIA_PGOFF(x)	    (((unsigned long)(x)) & ~PAGE_MASK)
diff -urN linux-2.6.34-rc3/drivers/gpu/drm/vmwgfx/Kconfig linux-2.6.34-rc4/drivers/gpu/drm/vmwgfx/Kconfig
--- linux-2.6.34-rc3/drivers/gpu/drm/vmwgfx/Kconfig	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/gpu/drm/vmwgfx/Kconfig	2010-04-13 02:19:00.839633036 +0000
@@ -1,6 +1,6 @@
 config DRM_VMWGFX
 	tristate "DRM driver for VMware Virtual GPU"
-	depends on DRM && PCI
+	depends on DRM && PCI && FB
 	select FB_DEFERRED_IO
 	select FB_CFB_FILLRECT
 	select FB_CFB_COPYAREA
diff -urN linux-2.6.34-rc3/drivers/gpu/vga/vgaarb.c linux-2.6.34-rc4/drivers/gpu/vga/vgaarb.c
--- linux-2.6.34-rc3/drivers/gpu/vga/vgaarb.c	2010-04-13 02:18:55.716633016 +0000
+++ linux-2.6.34-rc4/drivers/gpu/vga/vgaarb.c	2010-04-13 02:19:00.840633083 +0000
@@ -20,6 +20,7 @@
 #include <linux/spinlock.h>
 #include <linux/poll.h>
 #include <linux/miscdevice.h>
+#include <linux/slab.h>
 
 #include <linux/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-3m-pct.c linux-2.6.34-rc4/drivers/hid/hid-3m-pct.c
--- linux-2.6.34-rc3/drivers/hid/hid-3m-pct.c	2010-04-13 02:18:55.716633016 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-3m-pct.c	2010-04-13 02:19:00.840633083 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 MODULE_AUTHOR("Stephane Chatty <chatty@enac.fr>");
diff -urN linux-2.6.34-rc3/drivers/hid/hid-a4tech.c linux-2.6.34-rc4/drivers/hid/hid-a4tech.c
--- linux-2.6.34-rc3/drivers/hid/hid-a4tech.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-a4tech.c	2010-04-13 02:19:00.840633083 +0000
@@ -20,6 +20,7 @@
 #include <linux/input.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "hid-ids.h"
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-apple.c linux-2.6.34-rc4/drivers/hid/hid-apple.c
--- linux-2.6.34-rc3/drivers/hid/hid-apple.c	2010-04-13 02:18:55.716633016 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-apple.c	2010-04-13 02:19:00.840633083 +0000
@@ -19,6 +19,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-debug.c linux-2.6.34-rc4/drivers/hid/hid-debug.c
--- linux-2.6.34-rc3/drivers/hid/hid-debug.c	2010-04-13 02:18:55.717633075 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-debug.c	2010-04-13 02:19:00.841633070 +0000
@@ -29,6 +29,7 @@
 #include <linux/debugfs.h>
 #include <linux/seq_file.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/poll.h>
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-drff.c linux-2.6.34-rc4/drivers/hid/hid-drff.c
--- linux-2.6.34-rc3/drivers/hid/hid-drff.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-drff.c	2010-04-13 02:19:00.841633070 +0000
@@ -28,6 +28,7 @@
  */
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/hid.h>
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-gaff.c linux-2.6.34-rc4/drivers/hid/hid-gaff.c
--- linux-2.6.34-rc3/drivers/hid/hid-gaff.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-gaff.c	2010-04-13 02:19:00.841633070 +0000
@@ -28,6 +28,7 @@
  */
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/hid.h>
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-gyration.c linux-2.6.34-rc4/drivers/hid/hid-gyration.c
--- linux-2.6.34-rc3/drivers/hid/hid-gyration.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-gyration.c	2010-04-13 02:19:00.841633070 +0000
@@ -53,10 +53,13 @@
 static int gyration_event(struct hid_device *hdev, struct hid_field *field,
 		struct hid_usage *usage, __s32 value)
 {
-	struct input_dev *input = field->hidinput->input;
+
+	if (!(hdev->claimed & HID_CLAIMED_INPUT) || !field->hidinput)
+		return 0;
 
 	if ((usage->hid & HID_USAGE_PAGE) == HID_UP_GENDESK &&
 			(usage->hid & 0xff) == 0x82) {
+		struct input_dev *input = field->hidinput->input;
 		input_event(input, usage->type, usage->code, 1);
 		input_sync(input);
 		input_event(input, usage->type, usage->code, 0);
diff -urN linux-2.6.34-rc3/drivers/hid/hid-lg2ff.c linux-2.6.34-rc4/drivers/hid/hid-lg2ff.c
--- linux-2.6.34-rc3/drivers/hid/hid-lg2ff.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-lg2ff.c	2010-04-13 02:19:00.842633036 +0000
@@ -22,6 +22,7 @@
 
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/hid.h>
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-magicmouse.c linux-2.6.34-rc4/drivers/hid/hid-magicmouse.c
--- linux-2.6.34-rc3/drivers/hid/hid-magicmouse.c	2010-04-13 02:18:55.718633080 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-magicmouse.c	2010-04-13 02:19:00.842633036 +0000
@@ -14,6 +14,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-mosart.c linux-2.6.34-rc4/drivers/hid/hid-mosart.c
--- linux-2.6.34-rc3/drivers/hid/hid-mosart.c	2010-04-13 02:18:55.718633080 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-mosart.c	2010-04-13 02:19:00.842633036 +0000
@@ -16,6 +16,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include "usbhid/usbhid.h"
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-ntrig.c linux-2.6.34-rc4/drivers/hid/hid-ntrig.c
--- linux-2.6.34-rc3/drivers/hid/hid-ntrig.c	2010-04-13 02:18:55.718633080 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-ntrig.c	2010-04-13 02:19:00.843633005 +0000
@@ -16,6 +16,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "hid-ids.h"
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-pl.c linux-2.6.34-rc4/drivers/hid/hid-pl.c
--- linux-2.6.34-rc3/drivers/hid/hid-pl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-pl.c	2010-04-13 02:19:00.843633005 +0000
@@ -39,6 +39,7 @@
 #define debug(format, arg...) pr_debug("hid-plff: " format "\n" , ## arg)
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/hid.h>
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-quanta.c linux-2.6.34-rc4/drivers/hid/hid-quanta.c
--- linux-2.6.34-rc3/drivers/hid/hid-quanta.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-quanta.c	2010-04-13 02:19:00.843633005 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Stephane Chatty <chatty@enac.fr>");
 MODULE_DESCRIPTION("Quanta dual-touch panel");
diff -urN linux-2.6.34-rc3/drivers/hid/hid-sjoy.c linux-2.6.34-rc4/drivers/hid/hid-sjoy.c
--- linux-2.6.34-rc3/drivers/hid/hid-sjoy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-sjoy.c	2010-04-13 02:19:00.843633005 +0000
@@ -27,6 +27,7 @@
 /* #define DEBUG */
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/hid.h>
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-sony.c linux-2.6.34-rc4/drivers/hid/hid-sony.c
--- linux-2.6.34-rc3/drivers/hid/hid-sony.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-sony.c	2010-04-13 02:19:00.843633005 +0000
@@ -19,6 +19,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-stantum.c linux-2.6.34-rc4/drivers/hid/hid-stantum.c
--- linux-2.6.34-rc3/drivers/hid/hid-stantum.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-stantum.c	2010-04-13 02:19:00.843633005 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Stephane Chatty <chatty@enac.fr>");
 MODULE_DESCRIPTION("Stantum HID multitouch panels");
diff -urN linux-2.6.34-rc3/drivers/hid/hid-tmff.c linux-2.6.34-rc4/drivers/hid/hid-tmff.c
--- linux-2.6.34-rc3/drivers/hid/hid-tmff.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-tmff.c	2010-04-13 02:19:00.843633005 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/hid.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hid-wacom.c linux-2.6.34-rc4/drivers/hid/hid-wacom.c
--- linux-2.6.34-rc3/drivers/hid/hid-wacom.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-wacom.c	2010-04-13 02:19:00.844633072 +0000
@@ -21,6 +21,7 @@
 #include <linux/device.h>
 #include <linux/hid.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "hid-ids.h"
 
diff -urN linux-2.6.34-rc3/drivers/hid/hid-zpff.c linux-2.6.34-rc4/drivers/hid/hid-zpff.c
--- linux-2.6.34-rc3/drivers/hid/hid-zpff.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/hid-zpff.c	2010-04-13 02:19:00.844633072 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/hid.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "hid-ids.h"
diff -urN linux-2.6.34-rc3/drivers/hid/hidraw.c linux-2.6.34-rc4/drivers/hid/hidraw.c
--- linux-2.6.34-rc3/drivers/hid/hidraw.c	2010-04-13 02:18:55.719571307 +0000
+++ linux-2.6.34-rc4/drivers/hid/hidraw.c	2010-04-13 02:19:00.844633072 +0000
@@ -28,6 +28,7 @@
 #include <linux/poll.h>
 #include <linux/device.h>
 #include <linux/major.h>
+#include <linux/slab.h>
 #include <linux/hid.h>
 #include <linux/mutex.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/hid/usbhid/hid-pidff.c linux-2.6.34-rc4/drivers/hid/usbhid/hid-pidff.c
--- linux-2.6.34-rc3/drivers/hid/usbhid/hid-pidff.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hid/usbhid/hid-pidff.c	2010-04-13 02:19:00.844633072 +0000
@@ -25,6 +25,7 @@
 #define debug(format, arg...) pr_debug("hid-pidff: " format "\n" , ## arg)
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include <linux/hid.h>
diff -urN linux-2.6.34-rc3/drivers/hid/usbhid/hid-quirks.c linux-2.6.34-rc4/drivers/hid/usbhid/hid-quirks.c
--- linux-2.6.34-rc3/drivers/hid/usbhid/hid-quirks.c	2010-04-13 02:18:55.720570394 +0000
+++ linux-2.6.34-rc4/drivers/hid/usbhid/hid-quirks.c	2010-04-13 02:19:00.844633072 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/hid.h>
+#include <linux/slab.h>
 
 #include "../hid-ids.h"
 
@@ -60,6 +61,7 @@
 	{ USB_VENDOR_ID_DMI, USB_DEVICE_ID_DMI_ENC, HID_QUIRK_NOGET },
 	{ USB_VENDOR_ID_ELO, USB_DEVICE_ID_ELO_TS2700, HID_QUIRK_NOGET },
 	{ USB_VENDOR_ID_PRODIGE, USB_DEVICE_ID_PRODIGE_CORDLESS, HID_QUIRK_NOGET },
+	{ USB_VENDOR_ID_QUANTA, USB_DEVICE_ID_PIXART_IMAGING_INC_OPTICAL_TOUCH_SCREEN, HID_QUIRK_NOGET },
 	{ USB_VENDOR_ID_SUN, USB_DEVICE_ID_RARITAN_KVM_DONGLE, HID_QUIRK_NOGET },
 	{ USB_VENDOR_ID_TURBOX, USB_DEVICE_ID_TURBOX_KEYBOARD, HID_QUIRK_NOGET },
 	{ USB_VENDOR_ID_UCLOGIC, USB_DEVICE_ID_UCLOGIC_TABLET_PF1209, HID_QUIRK_MULTI_INPUT },
diff -urN linux-2.6.34-rc3/drivers/hwmon/ad7414.c linux-2.6.34-rc4/drivers/hwmon/ad7414.c
--- linux-2.6.34-rc3/drivers/hwmon/ad7414.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/ad7414.c	2010-04-13 02:19:00.845633082 +0000
@@ -27,6 +27,7 @@
 #include <linux/err.h>
 #include <linux/mutex.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 
 
 /* AD7414 registers */
diff -urN linux-2.6.34-rc3/drivers/hwmon/ad7418.c linux-2.6.34-rc4/drivers/hwmon/ad7418.c
--- linux-2.6.34-rc3/drivers/hwmon/ad7418.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/ad7418.c	2010-04-13 02:19:00.845633082 +0000
@@ -20,6 +20,7 @@
 #include <linux/err.h>
 #include <linux/mutex.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "lm75.h"
 
diff -urN linux-2.6.34-rc3/drivers/hwmon/adcxx.c linux-2.6.34-rc4/drivers/hwmon/adcxx.c
--- linux-2.6.34-rc3/drivers/hwmon/adcxx.c	2010-04-13 02:18:55.720570394 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/adcxx.c	2010-04-13 02:19:00.845633082 +0000
@@ -37,6 +37,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/err.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/hwmon/adt7411.c linux-2.6.34-rc4/drivers/hwmon/adt7411.c
--- linux-2.6.34-rc3/drivers/hwmon/adt7411.c	2010-04-13 02:18:55.720570394 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/adt7411.c	2010-04-13 02:19:00.845633082 +0000
@@ -21,6 +21,7 @@
 #include <linux/i2c.h>
 #include <linux/hwmon.h>
 #include <linux/hwmon-sysfs.h>
+#include <linux/slab.h>
 
 #define ADT7411_REG_INT_TEMP_VDD_LSB		0x03
 #define ADT7411_REG_EXT_TEMP_AIN14_LSB		0x04
diff -urN linux-2.6.34-rc3/drivers/hwmon/adt7462.c linux-2.6.34-rc4/drivers/hwmon/adt7462.c
--- linux-2.6.34-rc3/drivers/hwmon/adt7462.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/adt7462.c	2010-04-13 02:19:00.846633051 +0000
@@ -28,6 +28,7 @@
 #include <linux/mutex.h>
 #include <linux/delay.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 /* Addresses to scan */
 static const unsigned short normal_i2c[] = { 0x58, 0x5C, I2C_CLIENT_END };
diff -urN linux-2.6.34-rc3/drivers/hwmon/adt7470.c linux-2.6.34-rc4/drivers/hwmon/adt7470.c
--- linux-2.6.34-rc3/drivers/hwmon/adt7470.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/adt7470.c	2010-04-13 02:19:00.846633051 +0000
@@ -29,6 +29,7 @@
 #include <linux/delay.h>
 #include <linux/log2.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 /* Addresses to scan */
 static const unsigned short normal_i2c[] = { 0x2C, 0x2E, 0x2F, I2C_CLIENT_END };
diff -urN linux-2.6.34-rc3/drivers/hwmon/asus_atk0110.c linux-2.6.34-rc4/drivers/hwmon/asus_atk0110.c
--- linux-2.6.34-rc3/drivers/hwmon/asus_atk0110.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/asus_atk0110.c	2010-04-13 02:19:00.848633062 +0000
@@ -10,6 +10,7 @@
 #include <linux/hwmon.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <acpi/acpi.h>
 #include <acpi/acpixf.h>
diff -urN linux-2.6.34-rc3/drivers/hwmon/atxp1.c linux-2.6.34-rc4/drivers/hwmon/atxp1.c
--- linux-2.6.34-rc3/drivers/hwmon/atxp1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/atxp1.c	2010-04-13 02:19:00.849633067 +0000
@@ -28,6 +28,7 @@
 #include <linux/err.h>
 #include <linux/mutex.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("System voltages control via Attansic ATXP1");
diff -urN linux-2.6.34-rc3/drivers/hwmon/f75375s.c linux-2.6.34-rc4/drivers/hwmon/f75375s.c
--- linux-2.6.34-rc3/drivers/hwmon/f75375s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/f75375s.c	2010-04-13 02:19:00.849633067 +0000
@@ -35,6 +35,7 @@
 #include <linux/err.h>
 #include <linux/mutex.h>
 #include <linux/f75375s.h>
+#include <linux/slab.h>
 
 /* Addresses to scan */
 static const unsigned short normal_i2c[] = { 0x2d, 0x2e, I2C_CLIENT_END };
diff -urN linux-2.6.34-rc3/drivers/hwmon/i5k_amb.c linux-2.6.34-rc4/drivers/hwmon/i5k_amb.c
--- linux-2.6.34-rc3/drivers/hwmon/i5k_amb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/i5k_amb.c	2010-04-13 02:19:00.849633067 +0000
@@ -30,6 +30,7 @@
 #include <linux/log2.h>
 #include <linux/pci.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #define DRVNAME "i5k_amb"
 
diff -urN linux-2.6.34-rc3/drivers/hwmon/ibmaem.c linux-2.6.34-rc4/drivers/hwmon/ibmaem.c
--- linux-2.6.34-rc3/drivers/hwmon/ibmaem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/ibmaem.c	2010-04-13 02:19:00.850633074 +0000
@@ -29,6 +29,7 @@
 #include <linux/kdev_t.h>
 #include <linux/spinlock.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/platform_device.h>
 #include <linux/math64.h>
diff -urN linux-2.6.34-rc3/drivers/hwmon/ibmpex.c linux-2.6.34-rc4/drivers/hwmon/ibmpex.c
--- linux-2.6.34-rc3/drivers/hwmon/ibmpex.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/ibmpex.c	2010-04-13 02:19:00.850633074 +0000
@@ -25,6 +25,7 @@
 #include <linux/hwmon-sysfs.h>
 #include <linux/jiffies.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #define REFRESH_INTERVAL	(2 * HZ)
 #define DRVNAME			"ibmpex"
diff -urN linux-2.6.34-rc3/drivers/hwmon/lm70.c linux-2.6.34-rc4/drivers/hwmon/lm70.c
--- linux-2.6.34-rc3/drivers/hwmon/lm70.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/lm70.c	2010-04-13 02:19:00.851575890 +0000
@@ -34,6 +34,7 @@
 #include <linux/mutex.h>
 #include <linux/mod_devicetable.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 
 #define DRVNAME		"lm70"
diff -urN linux-2.6.34-rc3/drivers/hwmon/lm73.c linux-2.6.34-rc4/drivers/hwmon/lm73.c
--- linux-2.6.34-rc3/drivers/hwmon/lm73.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/lm73.c	2010-04-13 02:19:00.851575890 +0000
@@ -16,7 +16,6 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/hwmon.h>
 #include <linux/hwmon-sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/hwmon/max1111.c linux-2.6.34-rc4/drivers/hwmon/max1111.c
--- linux-2.6.34-rc3/drivers/hwmon/max1111.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/max1111.c	2010-04-13 02:19:00.851575890 +0000
@@ -20,6 +20,7 @@
 #include <linux/hwmon.h>
 #include <linux/hwmon-sysfs.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 #define MAX1111_TX_BUF_SIZE	1
 #define MAX1111_RX_BUF_SIZE	2
diff -urN linux-2.6.34-rc3/drivers/hwmon/mc13783-adc.c linux-2.6.34-rc4/drivers/hwmon/mc13783-adc.c
--- linux-2.6.34-rc3/drivers/hwmon/mc13783-adc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/mc13783-adc.c	2010-04-13 02:19:00.851575890 +0000
@@ -24,6 +24,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/hwmon.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/err.h>
 
diff -urN linux-2.6.34-rc3/drivers/hwmon/sht15.c linux-2.6.34-rc4/drivers/hwmon/sht15.c
--- linux-2.6.34-rc3/drivers/hwmon/sht15.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/sht15.c	2010-04-13 02:19:00.851575890 +0000
@@ -36,6 +36,7 @@
 #include <linux/err.h>
 #include <linux/sht15.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 
 #define SHT15_MEASURE_TEMP	3
diff -urN linux-2.6.34-rc3/drivers/hwmon/wm831x-hwmon.c linux-2.6.34-rc4/drivers/hwmon/wm831x-hwmon.c
--- linux-2.6.34-rc3/drivers/hwmon/wm831x-hwmon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/hwmon/wm831x-hwmon.c	2010-04-13 02:19:00.852570474 +0000
@@ -24,6 +24,7 @@
 #include <linux/err.h>
 #include <linux/hwmon.h>
 #include <linux/hwmon-sysfs.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/auxadc.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/algos/i2c-algo-bit.c linux-2.6.34-rc4/drivers/i2c/algos/i2c-algo-bit.c
--- linux-2.6.34-rc3/drivers/i2c/algos/i2c-algo-bit.c	2010-04-13 02:18:55.726633081 +0000
+++ linux-2.6.34-rc4/drivers/i2c/algos/i2c-algo-bit.c	2010-04-13 02:19:00.853633051 +0000
@@ -24,7 +24,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/algos/i2c-algo-pcf.c linux-2.6.34-rc4/drivers/i2c/algos/i2c-algo-pcf.c
--- linux-2.6.34-rc3/drivers/i2c/algos/i2c-algo-pcf.c	2010-04-13 02:18:55.726633081 +0000
+++ linux-2.6.34-rc4/drivers/i2c/algos/i2c-algo-pcf.c	2010-04-13 02:19:00.853633051 +0000
@@ -29,7 +29,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-amd8111.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-amd8111.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-amd8111.c	2010-04-13 02:18:55.727633062 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-amd8111.c	2010-04-13 02:19:00.854633151 +0000
@@ -17,6 +17,7 @@
 #include <linux/i2c.h>
 #include <linux/delay.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-bfin-twi.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-bfin-twi.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-bfin-twi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-bfin-twi.c	2010-04-13 02:19:00.854633151 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/mm.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-davinci.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-davinci.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-davinci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-davinci.c	2010-04-13 02:19:00.854633151 +0000
@@ -35,6 +35,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-designware.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-designware.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-designware.c	2010-04-13 02:18:55.727633062 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-designware.c	2010-04-13 02:19:00.854633151 +0000
@@ -36,6 +36,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /*
  * Registers offset
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-elektor.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-elektor.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-elektor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-elektor.c	2010-04-13 02:19:00.854633151 +0000
@@ -29,7 +29,6 @@
 #include <linux/ioport.h>
 #include <linux/module.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-gpio.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-gpio.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-gpio.c	2010-04-13 02:19:00.855633030 +0000
@@ -12,6 +12,7 @@
 #include <linux/i2c-gpio.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 
 #include <asm/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-highlander.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-highlander.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-highlander.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-highlander.c	2010-04-13 02:19:00.855633030 +0000
@@ -19,6 +19,7 @@
 #include <linux/completion.h>
 #include <linux/io.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #define SMCR		0x00
 #define SMCR_START	(1 << 0)
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-imx.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-imx.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-imx.c	2010-04-13 02:18:55.728633052 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-imx.c	2010-04-13 02:19:00.855633030 +0000
@@ -47,6 +47,7 @@
 #include <linux/sched.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <mach/irqs.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-ixp2000.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-ixp2000.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-ixp2000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-ixp2000.c	2010-04-13 02:19:00.855633030 +0000
@@ -32,6 +32,7 @@
 #include <linux/module.h>
 #include <linux/i2c.h>
 #include <linux/i2c-algo-bit.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>	/* Pick up IXP2000-specific bits */
 #include <mach/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-mpc.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-mpc.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-mpc.c	2010-04-13 02:18:55.728633052 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-mpc.c	2010-04-13 02:19:00.856633103 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/of_platform.h>
 #include <linux/of_i2c.h>
+#include <linux/slab.h>
 
 #include <linux/io.h>
 #include <linux/fsl_devices.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-mv64xxx.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-mv64xxx.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-mv64xxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-mv64xxx.c	2010-04-13 02:19:00.856633103 +0000
@@ -10,6 +10,7 @@
  * or implied.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-nforce2.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-nforce2.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-nforce2.c	2010-04-13 02:18:55.728633052 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-nforce2.c	2010-04-13 02:19:00.856633103 +0000
@@ -56,6 +56,7 @@
 #include <linux/delay.h>
 #include <linux/dmi.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-nomadik.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-nomadik.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-nomadik.c	2010-04-13 02:18:55.729571306 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-nomadik.c	2010-04-13 02:19:00.856633103 +0000
@@ -16,6 +16,7 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
 #include <linux/err.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-ocores.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-ocores.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-ocores.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-ocores.c	2010-04-13 02:19:00.857633056 +0000
@@ -18,6 +18,7 @@
 #include <linux/interrupt.h>
 #include <linux/wait.h>
 #include <linux/i2c-ocores.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 struct ocores_i2c {
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-octeon.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-octeon.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-octeon.c	2010-04-13 02:18:55.729571306 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-octeon.c	2010-04-13 02:19:00.857633056 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-omap.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-omap.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-omap.c	2010-04-13 02:18:55.729571306 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-omap.c	2010-04-13 02:19:00.857633056 +0000
@@ -37,6 +37,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /* I2C controller revisions */
 #define OMAP_I2C_REV_2			0x20
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-parport.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-parport.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-parport.c	2010-04-13 02:18:55.729571306 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-parport.c	2010-04-13 02:19:00.857633056 +0000
@@ -32,6 +32,7 @@
 #include <linux/i2c.h>
 #include <linux/i2c-algo-bit.h>
 #include <linux/i2c-smbus.h>
+#include <linux/slab.h>
 #include "i2c-parport.h"
 
 /* ----- Device list ------------------------------------------------------ */
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-pasemi.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-pasemi.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-pasemi.c	2010-04-13 02:18:55.730570453 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-pasemi.c	2010-04-13 02:19:00.858633052 +0000
@@ -24,6 +24,7 @@
 #include <linux/sched.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 static struct pci_driver pasemi_smb_driver;
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-pnx.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-pnx.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-pnx.c	2010-04-13 02:18:55.730570453 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-pnx.c	2010-04-13 02:19:00.858633052 +0000
@@ -22,6 +22,7 @@
 #include <linux/io.h>
 #include <linux/err.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-pxa.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-pxa.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-pxa.c	2010-04-13 02:18:55.731570641 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-pxa.c	2010-04-13 02:19:00.859633053 +0000
@@ -33,6 +33,7 @@
 #include <linux/platform_device.h>
 #include <linux/err.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-s3c2410.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-s3c2410.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-s3c2410.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-s3c2410.c	2010-04-13 02:19:00.859633053 +0000
@@ -34,6 +34,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-sh_mobile.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-sh_mobile.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-sh_mobile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-sh_mobile.c	2010-04-13 02:19:00.859633053 +0000
@@ -31,6 +31,7 @@
 #include <linux/pm_runtime.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /* Transmit operation:                                                      */
 /*                                                                          */
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-simtec.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-simtec.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-simtec.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-simtec.c	2010-04-13 02:19:00.859633053 +0000
@@ -23,6 +23,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <linux/i2c.h>
 #include <linux/i2c-algo-bit.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-stu300.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-stu300.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-stu300.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-stu300.c	2010-04-13 02:19:00.860633054 +0000
@@ -16,6 +16,7 @@
 #include <linux/interrupt.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /* the name of this kernel module */
 #define NAME "stu300"
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-tiny-usb.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-tiny-usb.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-tiny-usb.c	2010-04-13 02:18:55.731570641 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-tiny-usb.c	2010-04-13 02:19:00.860633054 +0000
@@ -13,6 +13,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 /* include interfaces to usb layer */
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-versatile.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-versatile.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-versatile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-versatile.c	2010-04-13 02:19:00.860633054 +0000
@@ -14,6 +14,7 @@
 #include <linux/i2c-algo-bit.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/i2c-xiic.c linux-2.6.34-rc4/drivers/i2c/busses/i2c-xiic.c
--- linux-2.6.34-rc3/drivers/i2c/busses/i2c-xiic.c	2010-04-13 02:18:55.732633069 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/i2c-xiic.c	2010-04-13 02:19:00.860633054 +0000
@@ -39,6 +39,7 @@
 #include <linux/wait.h>
 #include <linux/i2c-xiic.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "xiic-i2c"
 
diff -urN linux-2.6.34-rc3/drivers/i2c/busses/scx200_acb.c linux-2.6.34-rc4/drivers/i2c/busses/scx200_acb.c
--- linux-2.6.34-rc3/drivers/i2c/busses/scx200_acb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/busses/scx200_acb.c	2010-04-13 02:19:00.861633046 +0000
@@ -31,6 +31,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include <linux/scx200.h>
diff -urN linux-2.6.34-rc3/drivers/i2c/i2c-boardinfo.c linux-2.6.34-rc4/drivers/i2c/i2c-boardinfo.c
--- linux-2.6.34-rc3/drivers/i2c/i2c-boardinfo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/i2c/i2c-boardinfo.c	2010-04-13 02:19:00.862633021 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/kernel.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/rwsem.h>
 
 #include "i2c-core.h"
diff -urN linux-2.6.34-rc3/drivers/i2c/i2c-smbus.c linux-2.6.34-rc4/drivers/i2c/i2c-smbus.c
--- linux-2.6.34-rc3/drivers/i2c/i2c-smbus.c	2010-04-13 02:18:55.733633050 +0000
+++ linux-2.6.34-rc4/drivers/i2c/i2c-smbus.c	2010-04-13 02:19:00.862633021 +0000
@@ -26,6 +26,7 @@
 #include <linux/workqueue.h>
 #include <linux/i2c.h>
 #include <linux/i2c-smbus.h>
+#include <linux/slab.h>
 
 struct i2c_smbus_alert {
 	unsigned int		alert_edge_triggered:1;
diff -urN linux-2.6.34-rc3/drivers/ide/hpt366.c linux-2.6.34-rc4/drivers/ide/hpt366.c
--- linux-2.6.34-rc3/drivers/ide/hpt366.c	2010-04-13 02:18:55.735633039 +0000
+++ linux-2.6.34-rc4/drivers/ide/hpt366.c	2010-04-13 02:19:00.864633059 +0000
@@ -128,6 +128,7 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/ide.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/ide/ide-acpi.c linux-2.6.34-rc4/drivers/ide/ide-acpi.c
--- linux-2.6.34-rc3/drivers/ide/ide-acpi.c	2010-04-13 02:18:55.736633050 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-acpi.c	2010-04-13 02:19:00.865633067 +0000
@@ -12,6 +12,7 @@
 #include <linux/device.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <acpi/acpi.h>
 #include <linux/ide.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/ide/ide-atapi.c linux-2.6.34-rc4/drivers/ide/ide-atapi.c
--- linux-2.6.34-rc3/drivers/ide/ide-atapi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-atapi.c	2010-04-13 02:19:00.865633067 +0000
@@ -7,6 +7,7 @@
 #include <linux/delay.h>
 #include <linux/ide.h>
 #include <linux/scatterlist.h>
+#include <linux/gfp.h>
 
 #include <scsi/scsi.h>
 
@@ -263,8 +264,8 @@
 	 * of it.  The failed command will be retried after sense data
 	 * is acquired.
 	 */
-	blk_requeue_request(failed_rq->q, failed_rq);
 	drive->hwif->rq = NULL;
+	ide_requeue_and_plug(drive, failed_rq);
 	if (ide_queue_sense_rq(drive, pc)) {
 		blk_start_request(failed_rq);
 		ide_complete_rq(drive, -EIO, blk_rq_bytes(failed_rq));
diff -urN linux-2.6.34-rc3/drivers/ide/ide-cd_ioctl.c linux-2.6.34-rc4/drivers/ide/ide-cd_ioctl.c
--- linux-2.6.34-rc3/drivers/ide/ide-cd_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-cd_ioctl.c	2010-04-13 02:19:00.865633067 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/kernel.h>
 #include <linux/cdrom.h>
+#include <linux/gfp.h>
 #include <linux/ide.h>
 #include <scsi/scsi.h>
 
diff -urN linux-2.6.34-rc3/drivers/ide/ide-devsets.c linux-2.6.34-rc4/drivers/ide/ide-devsets.c
--- linux-2.6.34-rc3/drivers/ide/ide-devsets.c	2010-04-13 02:18:55.736633050 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-devsets.c	2010-04-13 02:19:00.865633067 +0000
@@ -1,5 +1,6 @@
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/ide.h>
 
 DEFINE_MUTEX(ide_setting_mtx);
diff -urN linux-2.6.34-rc3/drivers/ide/ide-disk_proc.c linux-2.6.34-rc4/drivers/ide/ide-disk_proc.c
--- linux-2.6.34-rc3/drivers/ide/ide-disk_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-disk_proc.c	2010-04-13 02:19:00.866633038 +0000
@@ -1,5 +1,6 @@
 #include <linux/kernel.h>
 #include <linux/ide.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 
 #include "ide-disk.h"
diff -urN linux-2.6.34-rc3/drivers/ide/ide-dma.c linux-2.6.34-rc4/drivers/ide/ide-dma.c
--- linux-2.6.34-rc3/drivers/ide/ide-dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-dma.c	2010-04-13 02:19:00.866633038 +0000
@@ -29,6 +29,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/ide.h>
 #include <linux/scatterlist.h>
@@ -492,6 +493,7 @@
 	if (rq) {
 		hwif->rq = NULL;
 		rq->errors = 0;
+		ide_requeue_and_plug(drive, rq);
 	}
 	return ret;
 }
diff -urN linux-2.6.34-rc3/drivers/ide/ide-floppy.c linux-2.6.34-rc4/drivers/ide/ide-floppy.c
--- linux-2.6.34-rc3/drivers/ide/ide-floppy.c	2010-04-13 02:18:55.736633050 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-floppy.c	2010-04-13 02:19:00.866633038 +0000
@@ -25,7 +25,6 @@
 #include <linux/major.h>
 #include <linux/errno.h>
 #include <linux/genhd.h>
-#include <linux/slab.h>
 #include <linux/cdrom.h>
 #include <linux/ide.h>
 #include <linux/hdreg.h>
diff -urN linux-2.6.34-rc3/drivers/ide/ide-gd.c linux-2.6.34-rc4/drivers/ide/ide-gd.c
--- linux-2.6.34-rc3/drivers/ide/ide-gd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-gd.c	2010-04-13 02:19:00.866633038 +0000
@@ -8,6 +8,7 @@
 #include <linux/ide.h>
 #include <linux/hdreg.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #if !defined(CONFIG_DEBUG_BLOCK_EXT_DEVT)
 #define IDE_DISK_MINORS		(1 << PARTN_BITS)
diff -urN linux-2.6.34-rc3/drivers/ide/ide-io.c linux-2.6.34-rc4/drivers/ide/ide-io.c
--- linux-2.6.34-rc3/drivers/ide/ide-io.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-io.c	2010-04-13 02:19:00.866633038 +0000
@@ -566,7 +566,7 @@
 		blk_plug_device(q);
 }
 
-static void ide_requeue_and_plug(ide_drive_t *drive, struct request *rq)
+void ide_requeue_and_plug(ide_drive_t *drive, struct request *rq)
 {
 	struct request_queue *q = drive->queue;
 	unsigned long flags;
diff -urN linux-2.6.34-rc3/drivers/ide/ide-ioctls.c linux-2.6.34-rc4/drivers/ide/ide-ioctls.c
--- linux-2.6.34-rc3/drivers/ide/ide-ioctls.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-ioctls.c	2010-04-13 02:19:00.866633038 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/hdreg.h>
 #include <linux/ide.h>
+#include <linux/slab.h>
 
 static const struct ide_ioctl_devset ide_ioctl_settings[] = {
 { HDIO_GET_32BIT,	 HDIO_SET_32BIT,	&ide_devset_io_32bit  },
diff -urN linux-2.6.34-rc3/drivers/ide/ide-park.c linux-2.6.34-rc4/drivers/ide/ide-park.c
--- linux-2.6.34-rc3/drivers/ide/ide-park.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-park.c	2010-04-13 02:19:00.866633038 +0000
@@ -1,4 +1,5 @@
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/ide.h>
 #include <linux/jiffies.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/ide/ide-pm.c linux-2.6.34-rc4/drivers/ide/ide-pm.c
--- linux-2.6.34-rc3/drivers/ide/ide-pm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-pm.c	2010-04-13 02:19:00.866633038 +0000
@@ -1,4 +1,5 @@
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/ide.h>
 
 int generic_ide_suspend(struct device *dev, pm_message_t mesg)
diff -urN linux-2.6.34-rc3/drivers/ide/ide-proc.c linux-2.6.34-rc4/drivers/ide/ide-proc.c
--- linux-2.6.34-rc3/drivers/ide/ide-proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-proc.c	2010-04-13 02:19:00.867633045 +0000
@@ -25,6 +25,7 @@
 #include <linux/ctype.h>
 #include <linux/ide.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/ide/ide-taskfile.c linux-2.6.34-rc4/drivers/ide/ide-taskfile.c
--- linux-2.6.34-rc3/drivers/ide/ide-taskfile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide-taskfile.c	2010-04-13 02:19:00.867633045 +0000
@@ -428,13 +428,11 @@
 {
 	struct request *rq;
 	int error;
+	int rw = !(cmd->tf_flags & IDE_TFLAG_WRITE) ? READ : WRITE;
 
-	rq = blk_get_request(drive->queue, READ, __GFP_WAIT);
+	rq = blk_get_request(drive->queue, rw, __GFP_WAIT);
 	rq->cmd_type = REQ_TYPE_ATA_TASKFILE;
 
-	if (cmd->tf_flags & IDE_TFLAG_WRITE)
-		rq->cmd_flags |= REQ_RW;
-
 	/*
 	 * (ks) We transfer currently only whole sectors.
 	 * This is suffient for now.  But, it would be great,
diff -urN linux-2.6.34-rc3/drivers/ide/ide.c linux-2.6.34-rc4/drivers/ide/ide.c
--- linux-2.6.34-rc3/drivers/ide/ide.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/ide.c	2010-04-13 02:19:00.868633071 +0000
@@ -52,7 +52,6 @@
 #include <linux/major.h>
 #include <linux/errno.h>
 #include <linux/genhd.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/ide.h>
diff -urN linux-2.6.34-rc3/drivers/ide/it821x.c linux-2.6.34-rc4/drivers/ide/it821x.c
--- linux-2.6.34-rc3/drivers/ide/it821x.c	2010-04-13 02:18:55.738633066 +0000
+++ linux-2.6.34-rc4/drivers/ide/it821x.c	2010-04-13 02:19:00.868633071 +0000
@@ -61,6 +61,7 @@
 
 #include <linux/types.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/ide.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/ide/pmac.c linux-2.6.34-rc4/drivers/ide/pmac.c
--- linux-2.6.34-rc3/drivers/ide/pmac.c	2010-04-13 02:18:55.739571809 +0000
+++ linux-2.6.34-rc4/drivers/ide/pmac.c	2010-04-13 02:19:00.869633099 +0000
@@ -33,6 +33,7 @@
 #include <linux/adb.h>
 #include <linux/pmu.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include <asm/prom.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/ide/rapide.c linux-2.6.34-rc4/drivers/ide/rapide.c
--- linux-2.6.34-rc3/drivers/ide/rapide.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ide/rapide.c	2010-04-13 02:19:00.869633099 +0000
@@ -3,7 +3,6 @@
  */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/errno.h>
 #include <linux/ide.h>
diff -urN linux-2.6.34-rc3/drivers/ide/sc1200.c linux-2.6.34-rc4/drivers/ide/sc1200.c
--- linux-2.6.34-rc3/drivers/ide/sc1200.c	2010-04-13 02:18:55.739571809 +0000
+++ linux-2.6.34-rc4/drivers/ide/sc1200.c	2010-04-13 02:19:00.869633099 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/ide.h>
diff -urN linux-2.6.34-rc3/drivers/ide/via82cxxx.c linux-2.6.34-rc4/drivers/ide/via82cxxx.c
--- linux-2.6.34-rc3/drivers/ide/via82cxxx.c	2010-04-13 02:18:55.741570460 +0000
+++ linux-2.6.34-rc4/drivers/ide/via82cxxx.c	2010-04-13 02:19:00.871633075 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/ide.h>
diff -urN linux-2.6.34-rc3/drivers/idle/i7300_idle.c linux-2.6.34-rc4/drivers/idle/i7300_idle.c
--- linux-2.6.34-rc3/drivers/idle/i7300_idle.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/idle/i7300_idle.c	2010-04-13 02:19:00.871633075 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/notifier.h>
 #include <linux/cpumask.h>
diff -urN linux-2.6.34-rc3/drivers/ieee1394/dma.c linux-2.6.34-rc4/drivers/ieee1394/dma.c
--- linux-2.6.34-rc3/drivers/ieee1394/dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ieee1394/dma.c	2010-04-13 02:19:00.871633075 +0000
@@ -10,7 +10,6 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/scatterlist.h>
 
diff -urN linux-2.6.34-rc3/drivers/ieee1394/sbp2.c linux-2.6.34-rc4/drivers/ieee1394/sbp2.c
--- linux-2.6.34-rc3/drivers/ieee1394/sbp2.c	2010-04-13 02:18:55.742633071 +0000
+++ linux-2.6.34-rc4/drivers/ieee1394/sbp2.c	2010-04-13 02:19:00.872633049 +0000
@@ -56,7 +56,6 @@
 #include <linux/delay.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
-#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/addr.c linux-2.6.34-rc4/drivers/infiniband/core/addr.c
--- linux-2.6.34-rc3/drivers/infiniband/core/addr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/addr.c	2010-04-13 02:19:00.873633101 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/mutex.h>
 #include <linux/inetdevice.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <net/arp.h>
 #include <net/neighbour.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/cm.c linux-2.6.34-rc4/drivers/infiniband/core/cm.c
--- linux-2.6.34-rc3/drivers/infiniband/core/cm.c	2010-04-13 02:18:55.742633071 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/cm.c	2010-04-13 02:19:00.873633101 +0000
@@ -42,6 +42,7 @@
 #include <linux/random.h>
 #include <linux/rbtree.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/sysfs.h>
 #include <linux/workqueue.h>
 #include <linux/kdev_t.h>
@@ -3693,7 +3694,7 @@
 	cm_dev->device = device_create(&cm_class, &ib_device->dev,
 				       MKDEV(0, 0), NULL,
 				       "%s", ib_device->name);
-	if (!cm_dev->device) {
+	if (IS_ERR(cm_dev->device)) {
 		kfree(cm_dev);
 		return;
 	}
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/cma.c linux-2.6.34-rc4/drivers/infiniband/core/cma.c
--- linux-2.6.34-rc3/drivers/infiniband/core/cma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/cma.c	2010-04-13 02:19:00.873633101 +0000
@@ -40,6 +40,7 @@
 #include <linux/random.h>
 #include <linux/idr.h>
 #include <linux/inetdevice.h>
+#include <linux/slab.h>
 
 #include <net/tcp.h>
 #include <net/ipv6.h>
@@ -1683,6 +1684,7 @@
 	}
 
 	memcpy(id->route.path_rec, path_rec, sizeof *path_rec * num_paths);
+	id->route.num_paths = num_paths;
 	return 0;
 err:
 	cma_comp_exch(id_priv, CMA_ROUTE_RESOLVED, CMA_ADDR_RESOLVED);
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/iwcm.c linux-2.6.34-rc4/drivers/infiniband/core/iwcm.c
--- linux-2.6.34-rc3/drivers/infiniband/core/iwcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/iwcm.c	2010-04-13 02:19:00.874633192 +0000
@@ -44,6 +44,7 @@
 #include <linux/spinlock.h>
 #include <linux/workqueue.h>
 #include <linux/completion.h>
+#include <linux/slab.h>
 
 #include <rdma/iw_cm.h>
 #include <rdma/ib_addr.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/mad.c linux-2.6.34-rc4/drivers/infiniband/core/mad.c
--- linux-2.6.34-rc3/drivers/infiniband/core/mad.c	2010-04-13 02:18:55.743633028 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/mad.c	2010-04-13 02:19:00.874633192 +0000
@@ -34,6 +34,7 @@
  *
  */
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <rdma/ib_cache.h>
 
 #include "mad_priv.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/mad_rmpp.c linux-2.6.34-rc4/drivers/infiniband/core/mad_rmpp.c
--- linux-2.6.34-rc3/drivers/infiniband/core/mad_rmpp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/mad_rmpp.c	2010-04-13 02:19:00.874633192 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "mad_priv.h"
 #include "mad_rmpp.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/multicast.c linux-2.6.34-rc4/drivers/infiniband/core/multicast.c
--- linux-2.6.34-rc3/drivers/infiniband/core/multicast.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/multicast.c	2010-04-13 02:19:00.874633192 +0000
@@ -34,6 +34,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/err.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/bitops.h>
 #include <linux/random.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/ucm.c linux-2.6.34-rc4/drivers/infiniband/core/ucm.c
--- linux-2.6.34-rc3/drivers/infiniband/core/ucm.c	2010-04-13 02:18:55.743633028 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/ucm.c	2010-04-13 02:19:00.875633044 +0000
@@ -44,6 +44,7 @@
 #include <linux/cdev.h>
 #include <linux/idr.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/ucma.c linux-2.6.34-rc4/drivers/infiniband/core/ucma.c
--- linux-2.6.34-rc3/drivers/infiniband/core/ucma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/ucma.c	2010-04-13 02:19:00.875633044 +0000
@@ -39,6 +39,7 @@
 #include <linux/in.h>
 #include <linux/in6.h>
 #include <linux/miscdevice.h>
+#include <linux/slab.h>
 
 #include <rdma/rdma_user_cm.h>
 #include <rdma/ib_marshall.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/umem.c linux-2.6.34-rc4/drivers/infiniband/core/umem.c
--- linux-2.6.34-rc3/drivers/infiniband/core/umem.c	2010-04-13 02:18:55.743633028 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/umem.c	2010-04-13 02:19:00.875633044 +0000
@@ -37,6 +37,7 @@
 #include <linux/sched.h>
 #include <linux/hugetlb.h>
 #include <linux/dma-attrs.h>
+#include <linux/slab.h>
 
 #include "uverbs.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/user_mad.c linux-2.6.34-rc4/drivers/infiniband/core/user_mad.c
--- linux-2.6.34-rc3/drivers/infiniband/core/user_mad.c	2010-04-13 02:18:55.744633024 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/user_mad.c	2010-04-13 02:19:00.876633063 +0000
@@ -46,6 +46,7 @@
 #include <linux/compat.h>
 #include <linux/sched.h>
 #include <linux/semaphore.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/uverbs_cmd.c linux-2.6.34-rc4/drivers/infiniband/core/uverbs_cmd.c
--- linux-2.6.34-rc3/drivers/infiniband/core/uverbs_cmd.c	2010-04-13 02:18:55.744633024 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/uverbs_cmd.c	2010-04-13 02:19:00.876633063 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/file.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/core/uverbs_main.c linux-2.6.34-rc4/drivers/infiniband/core/uverbs_main.c
--- linux-2.6.34-rc3/drivers/infiniband/core/uverbs_main.c	2010-04-13 02:18:55.744633024 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/core/uverbs_main.c	2010-04-13 02:19:00.876633063 +0000
@@ -44,6 +44,7 @@
 #include <linux/file.h>
 #include <linux/cdev.h>
 #include <linux/anon_inodes.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2.c	2010-04-13 02:19:00.877633061 +0000
@@ -46,6 +46,7 @@
 #include <linux/tcp.h>
 #include <linux/init.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_alloc.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_alloc.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_alloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_alloc.c	2010-04-13 02:19:00.877633061 +0000
@@ -32,7 +32,6 @@
  */
 
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/bitmap.h>
 
 #include "c2.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_cm.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_cm.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_cm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_cm.c	2010-04-13 02:19:00.877633061 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  *
  */
+#include <linux/slab.h>
+
 #include "c2.h"
 #include "c2_wr.h"
 #include "c2_vq.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_cq.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_cq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_cq.c	2010-04-13 02:19:00.877633061 +0000
@@ -35,6 +35,8 @@
  * SOFTWARE.
  *
  */
+#include <linux/gfp.h>
+
 #include "c2.h"
 #include "c2_vq.h"
 #include "c2_status.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_mm.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_mm.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_mm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_mm.c	2010-04-13 02:19:00.877633061 +0000
@@ -30,6 +30,8 @@
  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  * SOFTWARE.
  */
+#include <linux/slab.h>
+
 #include "c2.h"
 #include "c2_vq.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_pd.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_pd.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_pd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_pd.c	2010-04-13 02:19:00.877633061 +0000
@@ -34,6 +34,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 
 #include "c2.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_provider.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_provider.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_provider.c	2010-04-13 02:19:00.877633061 +0000
@@ -50,6 +50,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/if_arp.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_qp.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_qp.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_qp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_qp.c	2010-04-13 02:19:00.877633061 +0000
@@ -36,6 +36,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include "c2.h"
 #include "c2_vq.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_rnic.c linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_rnic.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/amso1100/c2_rnic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/amso1100/c2_rnic.c	2010-04-13 02:19:00.878633075 +0000
@@ -51,6 +51,7 @@
 #include <linux/mm.h>
 #include <linux/inet.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include <linux/route.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/cxio_dbg.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/cxio_dbg.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/cxio_dbg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/cxio_dbg.c	2010-04-13 02:19:00.878633075 +0000
@@ -31,6 +31,7 @@
  */
 #ifdef DEBUG
 #include <linux/types.h>
+#include <linux/slab.h>
 #include "common.h"
 #include "cxgb3_ioctl.h"
 #include "cxio_hal.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/cxio_hal.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/cxio_hal.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/cxio_hal.c	2010-04-13 02:18:55.745633066 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/cxio_hal.c	2010-04-13 02:19:00.878633075 +0000
@@ -37,6 +37,7 @@
 #include <linux/spinlock.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 
 #include "cxio_resource.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_cm.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_cm.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_cm.c	2010-04-13 02:18:55.745633066 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_cm.c	2010-04-13 02:19:00.879633049 +0000
@@ -31,6 +31,7 @@
  */
 #include <linux/module.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/skbuff.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_ev.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_ev.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_ev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_ev.c	2010-04-13 02:19:00.879633049 +0000
@@ -29,7 +29,7 @@
  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  * SOFTWARE.
  */
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/mman.h>
 #include <net/sock.h>
 #include "iwch_provider.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_mem.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_mem.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_mem.c	2010-04-13 02:19:00.879633049 +0000
@@ -29,6 +29,7 @@
  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  * SOFTWARE.
  */
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 
 #include <rdma/iw_cm.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_provider.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_provider.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_provider.c	2010-04-13 02:18:55.746633134 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_provider.c	2010-04-13 02:19:00.879633049 +0000
@@ -42,6 +42,7 @@
 #include <linux/ethtool.h>
 #include <linux/rtnetlink.h>
 #include <linux/inetdevice.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_qp.c linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_qp.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/cxgb3/iwch_qp.c	2010-04-13 02:18:55.746633134 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/cxgb3/iwch_qp.c	2010-04-13 02:19:00.879633049 +0000
@@ -30,6 +30,7 @@
  * SOFTWARE.
  */
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include "iwch_provider.h"
 #include "iwch.h"
 #include "iwch_cm.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_av.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_av.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_av.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_av.c	2010-04-13 02:19:00.879633049 +0000
@@ -41,6 +41,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_tools.h"
 #include "ehca_iverbs.h"
 #include "hcp_if.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_cq.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_cq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_cq.c	2010-04-13 02:19:00.880633074 +0000
@@ -43,6 +43,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_iverbs.h"
 #include "ehca_classes.h"
 #include "ehca_irq.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_hca.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_hca.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_hca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_hca.c	2010-04-13 02:19:00.880633074 +0000
@@ -39,6 +39,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/gfp.h>
+
 #include "ehca_tools.h"
 #include "ehca_iverbs.h"
 #include "hcp_if.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_irq.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_irq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_irq.c	2010-04-13 02:18:55.746633134 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_irq.c	2010-04-13 02:19:00.880633074 +0000
@@ -41,6 +41,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_classes.h"
 #include "ehca_irq.h"
 #include "ehca_iverbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_mrmw.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_mrmw.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_mrmw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_mrmw.c	2010-04-13 02:19:00.880633074 +0000
@@ -40,6 +40,7 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
 #include <rdma/ib_umem.h>
 
 #include "ehca_iverbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_pd.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_pd.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_pd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_pd.c	2010-04-13 02:19:00.880633074 +0000
@@ -38,6 +38,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_tools.h"
 #include "ehca_iverbs.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_qp.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_qp.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_qp.c	2010-04-13 02:18:55.746633134 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_qp.c	2010-04-13 02:19:00.881633043 +0000
@@ -43,6 +43,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_classes.h"
 #include "ehca_tools.h"
 #include "ehca_qes.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_uverbs.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_uverbs.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ehca_uverbs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ehca_uverbs.c	2010-04-13 02:19:00.881633043 +0000
@@ -40,6 +40,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_classes.h"
 #include "ehca_iverbs.h"
 #include "ehca_mrmw.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ipz_pt_fn.c linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ipz_pt_fn.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ehca/ipz_pt_fn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ehca/ipz_pt_fn.c	2010-04-13 02:19:00.881633043 +0000
@@ -38,6 +38,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include "ehca_tools.h"
 #include "ipz_pt_fn.h"
 #include "ehca_classes.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_cq.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_cq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_cq.c	2010-04-13 02:19:00.881633043 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_dma.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_dma.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_dma.c	2010-04-13 02:19:00.881633043 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/scatterlist.h>
+#include <linux/gfp.h>
 #include <rdma/ib_verbs.h>
 
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_driver.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_driver.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_driver.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_driver.c	2010-04-13 02:19:00.882633026 +0000
@@ -40,6 +40,7 @@
 #include <linux/netdevice.h>
 #include <linux/vmalloc.h>
 #include <linux/bitmap.h>
+#include <linux/slab.h>
 
 #include "ipath_kernel.h"
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_file_ops.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_file_ops.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_file_ops.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_file_ops.c	2010-04-13 02:19:00.882633026 +0000
@@ -36,6 +36,7 @@
 #include <linux/cdev.h>
 #include <linux/swap.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/io.h>
 #include <linux/jiffies.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_fs.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_fs.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_fs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_fs.c	2010-04-13 02:19:00.882633026 +0000
@@ -37,6 +37,7 @@
 #include <linux/pagemap.h>
 #include <linux/init.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 
 #include "ipath_kernel.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_init_chip.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_init_chip.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_init_chip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_init_chip.c	2010-04-13 02:19:00.882633026 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/pci.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "ipath_kernel.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_mmap.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_mmap.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_mmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_mmap.c	2010-04-13 02:19:00.882633026 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/module.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/errno.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_mr.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_mr.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_mr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_mr.c	2010-04-13 02:19:00.883633081 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include <rdma/ib_umem.h>
 #include <rdma/ib_pack.h>
 #include <rdma/ib_smi.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_qp.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_qp.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_qp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_qp.c	2010-04-13 02:19:00.883633081 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/err.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_sdma.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_sdma.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_sdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_sdma.c	2010-04-13 02:19:00.883633081 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/spinlock.h>
+#include <linux/gfp.h>
 
 #include "ipath_kernel.h"
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_srq.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_srq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_srq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_srq.c	2010-04-13 02:19:00.883633081 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "ipath_verbs.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_user_pages.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_user_pages.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_user_pages.c	2010-04-13 02:18:55.747633097 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_user_pages.c	2010-04-13 02:19:00.883633081 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/mm.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include "ipath_kernel.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_verbs.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_verbs.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_verbs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_verbs.c	2010-04-13 02:19:00.883633081 +0000
@@ -34,6 +34,7 @@
 #include <rdma/ib_mad.h>
 #include <rdma/ib_user_verbs.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/utsname.h>
 #include <linux/rculist.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_verbs_mcast.c linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_verbs_mcast.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/ipath/ipath_verbs_mcast.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/ipath/ipath_verbs_mcast.c	2010-04-13 02:19:00.883633081 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/rculist.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "ipath_verbs.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/ah.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/ah.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/ah.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/ah.c	2010-04-13 02:19:00.884633044 +0000
@@ -30,6 +30,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "mlx4_ib.h"
 
 struct ib_ah *mlx4_ib_create_ah(struct ib_pd *pd, struct ib_ah_attr *ah_attr)
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/cq.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/cq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/cq.c	2010-04-13 02:19:00.884633044 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/mlx4/cq.h>
 #include <linux/mlx4/qp.h>
+#include <linux/slab.h>
 
 #include "mlx4_ib.h"
 #include "user.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/mad.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/mad.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/mad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/mad.c	2010-04-13 02:19:00.884633044 +0000
@@ -34,6 +34,7 @@
 #include <rdma/ib_smi.h>
 
 #include <linux/mlx4/cmd.h>
+#include <linux/gfp.h>
 
 #include "mlx4_ib.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/main.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/main.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/main.c	2010-04-13 02:19:00.884633044 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 
 #include <rdma/ib_smi.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/mr.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/mr.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/mr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/mr.c	2010-04-13 02:19:00.884633044 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "mlx4_ib.h"
 
 static u32 convert_access(int acc)
@@ -238,7 +240,7 @@
 	mfrpl->mapped_page_list = dma_alloc_coherent(&dev->dev->pdev->dev,
 						     size, &mfrpl->map,
 						     GFP_KERNEL);
-	if (!mfrpl->ibfrpl.page_list)
+	if (!mfrpl->mapped_page_list)
 		goto err_free;
 
 	WARN_ON(mfrpl->map & 0x3f);
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/qp.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/qp.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/qp.c	2010-04-13 02:18:55.747633097 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/qp.c	2010-04-13 02:19:00.884633044 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 #include <rdma/ib_cache.h>
 #include <rdma/ib_pack.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/srq.c linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/srq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mlx4/srq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mlx4/srq.c	2010-04-13 02:19:00.884633044 +0000
@@ -33,6 +33,7 @@
 
 #include <linux/mlx4/qp.h>
 #include <linux/mlx4/srq.h>
+#include <linux/slab.h>
 
 #include "mlx4_ib.h"
 #include "user.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_cmd.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_cmd.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_cmd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_cmd.c	2010-04-13 02:19:00.885633030 +0000
@@ -36,6 +36,7 @@
 #include <linux/pci.h>
 #include <linux/errno.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <rdma/ib_mad.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_cq.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_cq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_cq.c	2010-04-13 02:19:00.885633030 +0000
@@ -34,6 +34,7 @@
  * SOFTWARE.
  */
 
+#include <linux/gfp.h>
 #include <linux/hardirq.h>
 #include <linux/sched.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_eq.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_eq.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_eq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_eq.c	2010-04-13 02:19:00.885633030 +0000
@@ -34,6 +34,7 @@
 #include <linux/errno.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "mthca_dev.h"
 #include "mthca_cmd.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_main.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_main.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_main.c	2010-04-13 02:19:00.885633030 +0000
@@ -37,6 +37,7 @@
 #include <linux/errno.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
+#include <linux/gfp.h>
 
 #include "mthca_dev.h"
 #include "mthca_config_reg.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_mcg.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_mcg.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_mcg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_mcg.c	2010-04-13 02:19:00.885633030 +0000
@@ -31,7 +31,7 @@
  */
 
 #include <linux/string.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 
 #include "mthca_dev.h"
 #include "mthca_cmd.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_memfree.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_memfree.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_memfree.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_memfree.c	2010-04-13 02:19:00.886633019 +0000
@@ -35,6 +35,7 @@
 #include <linux/mm.h>
 #include <linux/scatterlist.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_provider.c linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_provider.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/mthca/mthca_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/mthca/mthca_provider.c	2010-04-13 02:19:00.886633019 +0000
@@ -39,6 +39,7 @@
 #include <rdma/ib_user_verbs.h>
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 
 #include "mthca_dev.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes.c	2010-04-13 02:18:55.748633060 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes.c	2010-04-13 02:19:00.886633019 +0000
@@ -44,6 +44,7 @@
 #include <linux/init.h>
 #include <linux/if_arp.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/byteorder.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_cm.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_cm.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_cm.c	2010-04-13 02:18:55.748633060 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_cm.c	2010-04-13 02:19:00.887633066 +0000
@@ -53,6 +53,7 @@
 #include <linux/list.h>
 #include <linux/threads.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/neighbour.h>
 #include <net/route.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_hw.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_hw.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_hw.c	2010-04-13 02:18:55.749571575 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_hw.c	2010-04-13 02:19:00.888633070 +0000
@@ -39,6 +39,7 @@
 #include <linux/tcp.h>
 #include <linux/if_vlan.h>
 #include <linux/inet_lro.h>
+#include <linux/slab.h>
 
 #include "nes.h"
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_nic.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_nic.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_nic.c	2010-04-13 02:18:55.750570470 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_nic.c	2010-04-13 02:19:00.888633070 +0000
@@ -40,6 +40,7 @@
 #include <linux/if_arp.h>
 #include <linux/if_vlan.h>
 #include <linux/ethtool.h>
+#include <linux/slab.h>
 #include <net/tcp.h>
 
 #include <net/inet_common.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_utils.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_utils.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_utils.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_utils.c	2010-04-13 02:19:00.889633035 +0000
@@ -38,6 +38,7 @@
 #include <linux/ethtool.h>
 #include <linux/mii.h>
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 #include <linux/crc32.h>
 #include <linux/in.h>
 #include <linux/ip.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_verbs.c linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_verbs.c
--- linux-2.6.34-rc3/drivers/infiniband/hw/nes/nes_verbs.c	2010-04-13 02:18:55.750570470 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/hw/nes/nes_verbs.c	2010-04-13 02:19:00.889633035 +0000
@@ -35,6 +35,7 @@
 #include <linux/moduleparam.h>
 #include <linux/random.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 
 #include <rdma/ib_verbs.h>
@@ -2820,11 +2821,10 @@
 	attr->cap.max_send_wr = nesqp->hwqp.sq_size;
 	attr->cap.max_recv_wr = nesqp->hwqp.rq_size;
 	attr->cap.max_recv_sge = 1;
-	if (nes_drv_opt & NES_DRV_OPT_NO_INLINE_DATA) {
-		init_attr->cap.max_inline_data = 0;
-	} else {
-		init_attr->cap.max_inline_data = 64;
-	}
+	if (nes_drv_opt & NES_DRV_OPT_NO_INLINE_DATA)
+		attr->cap.max_inline_data = 0;
+	else
+		attr->cap.max_inline_data = 64;
 
 	init_attr->event_handler = nesqp->ibqp.event_handler;
 	init_attr->qp_context = nesqp->ibqp.qp_context;
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_cm.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_cm.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_cm.c	2010-04-13 02:18:55.751570658 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_cm.c	2010-04-13 02:19:00.889633035 +0000
@@ -35,6 +35,7 @@
 #include <net/icmp.h>
 #include <linux/icmpv6.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "ipoib.h"
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_fs.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_fs.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_fs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_fs.c	2010-04-13 02:19:00.890633030 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/err.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 struct file_operations;
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_ib.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_ib.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_ib.c	2010-04-13 02:18:55.751570658 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_ib.c	2010-04-13 02:19:00.890633030 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <linux/ip.h>
 #include <linux/tcp.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_multicast.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_multicast.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_multicast.c	2010-04-13 02:18:55.751570658 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_multicast.c	2010-04-13 02:19:00.890633030 +0000
@@ -40,6 +40,7 @@
 #include <linux/inetdevice.h>
 #include <linux/delay.h>
 #include <linux/completion.h>
+#include <linux/slab.h>
 
 #include <net/dst.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_verbs.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_verbs.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_verbs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_verbs.c	2010-04-13 02:19:00.890633030 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "ipoib.h"
 
 int ipoib_mcast_attach(struct net_device *dev, u16 mlid, union ib_gid *mgid, int set_qkey)
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_vlan.c linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/ipoib/ipoib_vlan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/ipoib/ipoib_vlan.c	2010-04-13 02:19:00.890633030 +0000
@@ -33,7 +33,6 @@
 #include <linux/module.h>
 
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/seq_file.h>
 
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/iser/iscsi_iser.c linux-2.6.34-rc4/drivers/infiniband/ulp/iser/iscsi_iser.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/iser/iscsi_iser.c	2010-04-13 02:18:55.751570658 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/iser/iscsi_iser.c	2010-04-13 02:19:00.890633030 +0000
@@ -56,6 +56,7 @@
 #include <linux/net.h>
 #include <linux/scatterlist.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 
diff -urN linux-2.6.34-rc3/drivers/infiniband/ulp/iser/iser_verbs.c linux-2.6.34-rc4/drivers/infiniband/ulp/iser/iser_verbs.c
--- linux-2.6.34-rc3/drivers/infiniband/ulp/iser/iser_verbs.c	2010-04-13 02:18:55.752633050 +0000
+++ linux-2.6.34-rc4/drivers/infiniband/ulp/iser/iser_verbs.c	2010-04-13 02:19:00.892633043 +0000
@@ -32,6 +32,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "iscsi_iser.h"
diff -urN linux-2.6.34-rc3/drivers/input/ff-core.c linux-2.6.34-rc4/drivers/input/ff-core.c
--- linux-2.6.34-rc3/drivers/input/ff-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/ff-core.c	2010-04-13 02:19:00.892633043 +0000
@@ -29,6 +29,7 @@
 #include <linux/module.h>
 #include <linux/mutex.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 /*
  * Check that the effect_id is a valid effect and whether the user
diff -urN linux-2.6.34-rc3/drivers/input/ff-memless.c linux-2.6.34-rc4/drivers/input/ff-memless.c
--- linux-2.6.34-rc3/drivers/input/ff-memless.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/ff-memless.c	2010-04-13 02:19:00.893633104 +0000
@@ -25,6 +25,7 @@
 
 #define debug(format, arg...) pr_debug("ff-memless: " format "\n", ## arg)
 
+#include <linux/slab.h>
 #include <linux/input.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/input/gameport/lightning.c linux-2.6.34-rc4/drivers/input/gameport/lightning.c
--- linux-2.6.34-rc3/drivers/input/gameport/lightning.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/gameport/lightning.c	2010-04-13 02:19:00.893633104 +0000
@@ -34,7 +34,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/gameport.h>
-#include <linux/slab.h>
 
 #define L4_PORT			0x201
 #define L4_SELECT_ANALOG	0xa4
diff -urN linux-2.6.34-rc3/drivers/input/input-polldev.c linux-2.6.34-rc4/drivers/input/input-polldev.c
--- linux-2.6.34-rc3/drivers/input/input-polldev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/input-polldev.c	2010-04-13 02:19:00.893633104 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/input-polldev.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/input.c linux-2.6.34-rc4/drivers/input/input.c
--- linux-2.6.34-rc3/drivers/input/input.c	2010-04-13 02:18:55.754633033 +0000
+++ linux-2.6.34-rc4/drivers/input/input.c	2010-04-13 02:19:00.894633021 +0000
@@ -14,6 +14,7 @@
 #include <linux/types.h>
 #include <linux/input.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/major.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/input/joystick/db9.c linux-2.6.34-rc4/drivers/input/joystick/db9.c
--- linux-2.6.34-rc3/drivers/input/joystick/db9.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/joystick/db9.c	2010-04-13 02:19:00.894633021 +0000
@@ -36,6 +36,7 @@
 #include <linux/parport.h>
 #include <linux/input.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Vojtech Pavlik <vojtech@ucw.cz>");
 MODULE_DESCRIPTION("Atari, Amstrad, Commodore, Amiga, Sega, etc. joystick driver");
diff -urN linux-2.6.34-rc3/drivers/input/joystick/gamecon.c linux-2.6.34-rc4/drivers/input/joystick/gamecon.c
--- linux-2.6.34-rc3/drivers/input/joystick/gamecon.c	2010-04-13 02:18:55.755633059 +0000
+++ linux-2.6.34-rc4/drivers/input/joystick/gamecon.c	2010-04-13 02:19:00.895633060 +0000
@@ -39,6 +39,7 @@
 #include <linux/parport.h>
 #include <linux/input.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Vojtech Pavlik <vojtech@ucw.cz>");
 MODULE_DESCRIPTION("NES, SNES, N64, MultiSystem, PSX gamepad driver");
diff -urN linux-2.6.34-rc3/drivers/input/joystick/turbografx.c linux-2.6.34-rc4/drivers/input/joystick/turbografx.c
--- linux-2.6.34-rc3/drivers/input/joystick/turbografx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/joystick/turbografx.c	2010-04-13 02:19:00.895633060 +0000
@@ -35,6 +35,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Vojtech Pavlik <vojtech@ucw.cz>");
 MODULE_DESCRIPTION("TurboGraFX parallel port interface driver");
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/adp5520-keys.c linux-2.6.34-rc4/drivers/input/keyboard/adp5520-keys.c
--- linux-2.6.34-rc3/drivers/input/keyboard/adp5520-keys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/adp5520-keys.c	2010-04-13 02:19:00.896633061 +0000
@@ -12,6 +12,7 @@
 #include <linux/platform_device.h>
 #include <linux/input.h>
 #include <linux/mfd/adp5520.h>
+#include <linux/slab.h>
 
 struct adp5520_keys {
 	struct input_dev *input;
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/adp5588-keys.c linux-2.6.34-rc4/drivers/input/keyboard/adp5588-keys.c
--- linux-2.6.34-rc3/drivers/input/keyboard/adp5588-keys.c	2010-04-13 02:18:55.756599530 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/adp5588-keys.c	2010-04-13 02:19:00.896633061 +0000
@@ -19,6 +19,7 @@
 #include <linux/platform_device.h>
 #include <linux/input.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include <linux/i2c/adp5588.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/bf54x-keys.c linux-2.6.34-rc4/drivers/input/keyboard/bf54x-keys.c
--- linux-2.6.34-rc3/drivers/input/keyboard/bf54x-keys.c	2010-04-13 02:18:55.756599530 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/bf54x-keys.c	2010-04-13 02:19:00.896633061 +0000
@@ -34,6 +34,7 @@
 #include <linux/fs.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/pm.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/davinci_keyscan.c linux-2.6.34-rc4/drivers/input/keyboard/davinci_keyscan.c
--- linux-2.6.34-rc3/drivers/input/keyboard/davinci_keyscan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/davinci_keyscan.c	2010-04-13 02:19:00.897633091 +0000
@@ -30,6 +30,7 @@
 #include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/ep93xx_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/ep93xx_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/ep93xx_keypad.c	2010-04-13 02:18:55.757633054 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/ep93xx_keypad.c	2010-04-13 02:19:00.897633091 +0000
@@ -25,6 +25,7 @@
 #include <linux/clk.h>
 #include <linux/io.h>
 #include <linux/input/matrix_keypad.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/ep93xx_keypad.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/gpio_keys.c linux-2.6.34-rc4/drivers/input/keyboard/gpio_keys.c
--- linux-2.6.34-rc3/drivers/input/keyboard/gpio_keys.c	2010-04-13 02:18:55.757633054 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/gpio_keys.c	2010-04-13 02:19:00.897633091 +0000
@@ -16,6 +16,7 @@
 #include <linux/irq.h>
 #include <linux/sched.h>
 #include <linux/pm.h>
+#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/proc_fs.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/imx_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/imx_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/imx_keypad.c	2010-04-13 02:18:55.757633054 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/imx_keypad.c	2010-04-13 02:19:00.897633091 +0000
@@ -21,6 +21,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 
 /*
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/jornada680_kbd.c linux-2.6.34-rc4/drivers/input/keyboard/jornada680_kbd.c
--- linux-2.6.34-rc3/drivers/input/keyboard/jornada680_kbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/jornada680_kbd.c	2010-04-13 02:19:00.897633091 +0000
@@ -24,6 +24,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/jornada720_kbd.c linux-2.6.34-rc4/drivers/input/keyboard/jornada720_kbd.c
--- linux-2.6.34-rc3/drivers/input/keyboard/jornada720_kbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/jornada720_kbd.c	2010-04-13 02:19:00.898633044 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <mach/jornada720.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/lm8323.c linux-2.6.34-rc4/drivers/input/keyboard/lm8323.c
--- linux-2.6.34-rc3/drivers/input/keyboard/lm8323.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/lm8323.c	2010-04-13 02:19:00.898633044 +0000
@@ -31,6 +31,7 @@
 #include <linux/input.h>
 #include <linux/leds.h>
 #include <linux/i2c/lm8323.h>
+#include <linux/slab.h>
 
 /* Commands to send to the chip. */
 #define LM8323_CMD_READ_ID		0x80 /* Read chip ID. */
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/matrix_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/matrix_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/matrix_keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/matrix_keypad.c	2010-04-13 02:19:00.898633044 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/gpio.h>
 #include <linux/input/matrix_keypad.h>
+#include <linux/slab.h>
 
 struct matrix_keypad {
 	const struct matrix_keypad_platform_data *pdata;
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/max7359_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/max7359_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/max7359_keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/max7359_keypad.c	2010-04-13 02:19:00.898633044 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/module.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/input.h>
 #include <linux/input/matrix_keypad.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/omap-keypad.c linux-2.6.34-rc4/drivers/input/keyboard/omap-keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/omap-keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/omap-keypad.c	2010-04-13 02:19:00.898633044 +0000
@@ -34,6 +34,7 @@
 #include <linux/platform_device.h>
 #include <linux/mutex.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <mach/gpio.h>
 #include <plat/keypad.h>
 #include <plat/menelaus.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/opencores-kbd.c linux-2.6.34-rc4/drivers/input/keyboard/opencores-kbd.c
--- linux-2.6.34-rc3/drivers/input/keyboard/opencores-kbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/opencores-kbd.c	2010-04-13 02:19:00.898633044 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 struct opencores_kbd {
 	struct input_dev *input;
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/pxa27x_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/pxa27x_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/pxa27x_keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/pxa27x_keypad.c	2010-04-13 02:19:00.898633044 +0000
@@ -26,6 +26,7 @@
 #include <linux/clk.h>
 #include <linux/err.h>
 #include <linux/input/matrix_keypad.h>
+#include <linux/slab.h>
 
 #include <asm/mach/arch.h>
 #include <asm/mach/map.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/pxa930_rotary.c linux-2.6.34-rc4/drivers/input/keyboard/pxa930_rotary.c
--- linux-2.6.34-rc3/drivers/input/keyboard/pxa930_rotary.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/pxa930_rotary.c	2010-04-13 02:19:00.898633044 +0000
@@ -13,6 +13,7 @@
 #include <linux/input.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/pxa930_rotary.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/sh_keysc.c linux-2.6.34-rc4/drivers/input/keyboard/sh_keysc.c
--- linux-2.6.34-rc3/drivers/input/keyboard/sh_keysc.c	2010-04-13 02:18:55.758633074 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/sh_keysc.c	2010-04-13 02:19:00.899633039 +0000
@@ -22,6 +22,7 @@
 #include <linux/bitmap.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 static const struct {
 	unsigned char kymd, keyout, keyin;
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/tosakbd.c linux-2.6.34-rc4/drivers/input/keyboard/tosakbd.c
--- linux-2.6.34-rc3/drivers/input/keyboard/tosakbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/tosakbd.c	2010-04-13 02:19:00.899633039 +0000
@@ -18,6 +18,7 @@
 #include <linux/input.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include <mach/gpio.h>
 #include <mach/tosa.h>
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/twl4030_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/twl4030_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/twl4030_keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/twl4030_keypad.c	2010-04-13 02:19:00.899633039 +0000
@@ -32,6 +32,7 @@
 #include <linux/input.h>
 #include <linux/platform_device.h>
 #include <linux/i2c/twl.h>
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/drivers/input/keyboard/w90p910_keypad.c linux-2.6.34-rc4/drivers/input/keyboard/w90p910_keypad.c
--- linux-2.6.34-rc3/drivers/input/keyboard/w90p910_keypad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/keyboard/w90p910_keypad.c	2010-04-13 02:19:00.899633039 +0000
@@ -19,6 +19,7 @@
 #include <linux/clk.h>
 #include <linux/err.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/w90p910_keypad.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/88pm860x_onkey.c linux-2.6.34-rc4/drivers/input/misc/88pm860x_onkey.c
--- linux-2.6.34-rc3/drivers/input/misc/88pm860x_onkey.c	2010-04-13 02:18:55.758633074 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/88pm860x_onkey.c	2010-04-13 02:19:00.899633039 +0000
@@ -25,6 +25,7 @@
 #include <linux/input.h>
 #include <linux/interrupt.h>
 #include <linux/mfd/88pm860x.h>
+#include <linux/slab.h>
 
 #define PM8607_WAKEUP		0x0b
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/ati_remote2.c linux-2.6.34-rc4/drivers/input/misc/ati_remote2.c
--- linux-2.6.34-rc3/drivers/input/misc/ati_remote2.c	2010-04-13 02:18:55.758633074 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/ati_remote2.c	2010-04-13 02:19:00.900633078 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/usb/input.h>
+#include <linux/slab.h>
 
 #define DRIVER_DESC    "ATI/Philips USB RF remote driver"
 #define DRIVER_VERSION "0.3"
diff -urN linux-2.6.34-rc3/drivers/input/misc/bfin_rotary.c linux-2.6.34-rc4/drivers/input/misc/bfin_rotary.c
--- linux-2.6.34-rc3/drivers/input/misc/bfin_rotary.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/bfin_rotary.c	2010-04-13 02:19:00.900633078 +0000
@@ -13,6 +13,7 @@
 #include <linux/pm.h>
 #include <linux/platform_device.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include <asm/portmux.h>
 #include <asm/bfin_rotary.h>
diff -urN linux-2.6.34-rc3/drivers/input/misc/cobalt_btns.c linux-2.6.34-rc4/drivers/input/misc/cobalt_btns.c
--- linux-2.6.34-rc3/drivers/input/misc/cobalt_btns.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/cobalt_btns.c	2010-04-13 02:19:00.900633078 +0000
@@ -22,6 +22,7 @@
 #include <linux/ioport.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #define BUTTONS_POLL_INTERVAL	30	/* msec */
 #define BUTTONS_COUNT_THRESHOLD	3
diff -urN linux-2.6.34-rc3/drivers/input/misc/dm355evm_keys.c linux-2.6.34-rc4/drivers/input/misc/dm355evm_keys.c
--- linux-2.6.34-rc3/drivers/input/misc/dm355evm_keys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/dm355evm_keys.c	2010-04-13 02:19:00.900633078 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/input.h>
 #include <linux/input/sparse-keymap.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/input/misc/pcap_keys.c linux-2.6.34-rc4/drivers/input/misc/pcap_keys.c
--- linux-2.6.34-rc3/drivers/input/misc/pcap_keys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/pcap_keys.c	2010-04-13 02:19:00.900633078 +0000
@@ -17,6 +17,7 @@
 #include <linux/platform_device.h>
 #include <linux/input.h>
 #include <linux/mfd/ezx-pcap.h>
+#include <linux/slab.h>
 
 struct pcap_keys {
 	struct pcap_chip *pcap;
diff -urN linux-2.6.34-rc3/drivers/input/misc/pcf50633-input.c linux-2.6.34-rc4/drivers/input/misc/pcf50633-input.c
--- linux-2.6.34-rc3/drivers/input/misc/pcf50633-input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/pcf50633-input.c	2010-04-13 02:19:00.900633078 +0000
@@ -20,6 +20,7 @@
 #include <linux/device.h>
 #include <linux/platform_device.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/pcf50633/core.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/rotary_encoder.c linux-2.6.34-rc4/drivers/input/misc/rotary_encoder.c
--- linux-2.6.34-rc3/drivers/input/misc/rotary_encoder.c	2010-04-13 02:18:55.758633074 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/rotary_encoder.c	2010-04-13 02:19:00.900633078 +0000
@@ -22,6 +22,7 @@
 #include <linux/platform_device.h>
 #include <linux/gpio.h>
 #include <linux/rotary_encoder.h>
+#include <linux/slab.h>
 
 #define DRV_NAME "rotary-encoder"
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/sgi_btns.c linux-2.6.34-rc4/drivers/input/misc/sgi_btns.c
--- linux-2.6.34-rc3/drivers/input/misc/sgi_btns.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/sgi_btns.c	2010-04-13 02:19:00.900633078 +0000
@@ -22,6 +22,7 @@
 #include <linux/ioport.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_SGI_IP22
 #include <asm/sgi/ioc.h>
diff -urN linux-2.6.34-rc3/drivers/input/misc/sparcspkr.c linux-2.6.34-rc4/drivers/input/misc/sparcspkr.c
--- linux-2.6.34-rc3/drivers/input/misc/sparcspkr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/sparcspkr.c	2010-04-13 02:19:00.900633078 +0000
@@ -9,6 +9,7 @@
 #include <linux/init.h>
 #include <linux/input.h>
 #include <linux/of_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/twl4030-vibra.c linux-2.6.34-rc4/drivers/input/misc/twl4030-vibra.c
--- linux-2.6.34-rc3/drivers/input/misc/twl4030-vibra.c	2010-04-13 02:18:55.759571298 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/twl4030-vibra.c	2010-04-13 02:19:00.901633064 +0000
@@ -30,6 +30,7 @@
 #include <linux/i2c/twl.h>
 #include <linux/mfd/twl4030-codec.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 /* MODULE ID2 */
 #define LEDEN		0x00
diff -urN linux-2.6.34-rc3/drivers/input/misc/winbond-cir.c linux-2.6.34-rc4/drivers/input/misc/winbond-cir.c
--- linux-2.6.34-rc3/drivers/input/misc/winbond-cir.c	2010-04-13 02:18:55.759571298 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/winbond-cir.c	2010-04-13 02:19:00.901633064 +0000
@@ -56,6 +56,7 @@
 #include <linux/io.h>
 #include <linux/bitrev.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #define DRVNAME "winbond-cir"
 
diff -urN linux-2.6.34-rc3/drivers/input/misc/wistron_btns.c linux-2.6.34-rc4/drivers/input/misc/wistron_btns.c
--- linux-2.6.34-rc3/drivers/input/misc/wistron_btns.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/wistron_btns.c	2010-04-13 02:19:00.901633064 +0000
@@ -29,6 +29,7 @@
 #include <linux/module.h>
 #include <linux/preempt.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/platform_device.h>
 #include <linux/leds.h>
diff -urN linux-2.6.34-rc3/drivers/input/misc/wm831x-on.c linux-2.6.34-rc4/drivers/input/misc/wm831x-on.c
--- linux-2.6.34-rc3/drivers/input/misc/wm831x-on.c	2010-04-13 02:18:55.759571298 +0000
+++ linux-2.6.34-rc4/drivers/input/misc/wm831x-on.c	2010-04-13 02:19:00.901633064 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/input.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/alps.c linux-2.6.34-rc4/drivers/input/mouse/alps.c
--- linux-2.6.34-rc3/drivers/input/mouse/alps.c	2010-04-13 02:18:55.759571298 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/alps.c	2010-04-13 02:19:00.902633100 +0000
@@ -15,6 +15,7 @@
  * the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <linux/input.h>
 #include <linux/serio.h>
 #include <linux/libps2.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/elantech.c linux-2.6.34-rc4/drivers/input/mouse/elantech.c
--- linux-2.6.34-rc3/drivers/input/mouse/elantech.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/elantech.c	2010-04-13 02:19:00.902633100 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/input.h>
 #include <linux/serio.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/hgpk.c linux-2.6.34-rc4/drivers/input/mouse/hgpk.c
--- linux-2.6.34-rc3/drivers/input/mouse/hgpk.c	2010-04-13 02:18:55.760570469 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/hgpk.c	2010-04-13 02:19:00.902633100 +0000
@@ -30,6 +30,7 @@
  */
 
 #define DEBUG
+#include <linux/slab.h>
 #include <linux/input.h>
 #include <linux/serio.h>
 #include <linux/libps2.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/lifebook.c linux-2.6.34-rc4/drivers/input/mouse/lifebook.c
--- linux-2.6.34-rc3/drivers/input/mouse/lifebook.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/lifebook.c	2010-04-13 02:19:00.902633100 +0000
@@ -16,6 +16,7 @@
 #include <linux/serio.h>
 #include <linux/libps2.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #include "psmouse.h"
 #include "lifebook.h"
diff -urN linux-2.6.34-rc3/drivers/input/mouse/pxa930_trkball.c linux-2.6.34-rc4/drivers/input/mouse/pxa930_trkball.c
--- linux-2.6.34-rc3/drivers/input/mouse/pxa930_trkball.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/pxa930_trkball.c	2010-04-13 02:19:00.902633100 +0000
@@ -18,6 +18,7 @@
 #include <linux/platform_device.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/pxa930_trkball.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/sentelic.c linux-2.6.34-rc4/drivers/input/mouse/sentelic.c
--- linux-2.6.34-rc3/drivers/input/mouse/sentelic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/sentelic.c	2010-04-13 02:19:00.903633053 +0000
@@ -26,6 +26,7 @@
 #include <linux/libps2.h>
 #include <linux/serio.h>
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 
 #include "psmouse.h"
 #include "sentelic.h"
diff -urN linux-2.6.34-rc3/drivers/input/mouse/synaptics.c linux-2.6.34-rc4/drivers/input/mouse/synaptics.c
--- linux-2.6.34-rc3/drivers/input/mouse/synaptics.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/synaptics.c	2010-04-13 02:19:00.903633053 +0000
@@ -28,6 +28,7 @@
 #include <linux/input.h>
 #include <linux/serio.h>
 #include <linux/libps2.h>
+#include <linux/slab.h>
 #include "psmouse.h"
 #include "synaptics.h"
 
diff -urN linux-2.6.34-rc3/drivers/input/mouse/synaptics_i2c.c linux-2.6.34-rc4/drivers/input/mouse/synaptics_i2c.c
--- linux-2.6.34-rc3/drivers/input/mouse/synaptics_i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/synaptics_i2c.c	2010-04-13 02:19:00.903633053 +0000
@@ -17,6 +17,7 @@
 #include <linux/input.h>
 #include <linux/delay.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME		"synaptics_i2c"
 /* maximum product id is 15 characters */
diff -urN linux-2.6.34-rc3/drivers/input/mouse/touchkit_ps2.c linux-2.6.34-rc4/drivers/input/mouse/touchkit_ps2.c
--- linux-2.6.34-rc3/drivers/input/mouse/touchkit_ps2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/touchkit_ps2.c	2010-04-13 02:19:00.903633053 +0000
@@ -26,7 +26,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 
 #include <linux/input.h>
 #include <linux/serio.h>
diff -urN linux-2.6.34-rc3/drivers/input/mouse/trackpoint.c linux-2.6.34-rc4/drivers/input/mouse/trackpoint.c
--- linux-2.6.34-rc3/drivers/input/mouse/trackpoint.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/mouse/trackpoint.c	2010-04-13 02:19:00.903633053 +0000
@@ -8,6 +8,7 @@
  * Trademarks are the property of their respective owners.
  */
 
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/serio.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/altera_ps2.c linux-2.6.34-rc4/drivers/input/serio/altera_ps2.c
--- linux-2.6.34-rc3/drivers/input/serio/altera_ps2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/altera_ps2.c	2010-04-13 02:19:00.903633053 +0000
@@ -18,6 +18,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define DRV_NAME "altera_ps2"
 
diff -urN linux-2.6.34-rc3/drivers/input/serio/at32psif.c linux-2.6.34-rc4/drivers/input/serio/at32psif.c
--- linux-2.6.34-rc3/drivers/input/serio/at32psif.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/at32psif.c	2010-04-13 02:19:00.903633053 +0000
@@ -18,6 +18,7 @@
 #include <linux/io.h>
 #include <linux/clk.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 /* PSIF register offsets */
 #define PSIF_CR				0x00
diff -urN linux-2.6.34-rc3/drivers/input/serio/ct82c710.c linux-2.6.34-rc4/drivers/input/serio/ct82c710.c
--- linux-2.6.34-rc3/drivers/input/serio/ct82c710.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/ct82c710.c	2010-04-13 02:19:00.903633053 +0000
@@ -35,6 +35,7 @@
 #include <linux/errno.h>
 #include <linux/err.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/serio/gscps2.c linux-2.6.34-rc4/drivers/input/serio/gscps2.c
--- linux-2.6.34-rc3/drivers/input/serio/gscps2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/gscps2.c	2010-04-13 02:19:00.904633069 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/serio.h>
 #include <linux/input.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/hil_mlc.c linux-2.6.34-rc4/drivers/input/serio/hil_mlc.c
--- linux-2.6.34-rc3/drivers/input/serio/hil_mlc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/hil_mlc.c	2010-04-13 02:19:00.904633069 +0000
@@ -58,6 +58,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/list.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/serio/i8042.c linux-2.6.34-rc4/drivers/input/serio/i8042.c
--- linux-2.6.34-rc3/drivers/input/serio/i8042.c	2010-04-13 02:18:55.760570469 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/i8042.c	2010-04-13 02:19:00.904633069 +0000
@@ -21,6 +21,7 @@
 #include <linux/rcupdate.h>
 #include <linux/platform_device.h>
 #include <linux/i8042.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/serio/libps2.c linux-2.6.34-rc4/drivers/input/serio/libps2.c
--- linux-2.6.34-rc3/drivers/input/serio/libps2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/libps2.c	2010-04-13 02:19:00.904633069 +0000
@@ -14,7 +14,6 @@
 #include <linux/delay.h>
 #include <linux/module.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/input.h>
 #include <linux/serio.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/parkbd.c linux-2.6.34-rc4/drivers/input/serio/parkbd.c
--- linux-2.6.34-rc3/drivers/input/serio/parkbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/parkbd.c	2010-04-13 02:19:00.904633069 +0000
@@ -46,6 +46,7 @@
 
 #include <linux/module.h>
 #include <linux/parport.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/serio.h>
 
diff -urN linux-2.6.34-rc3/drivers/input/serio/pcips2.c linux-2.6.34-rc4/drivers/input/serio/pcips2.c
--- linux-2.6.34-rc3/drivers/input/serio/pcips2.c	2010-04-13 02:18:55.760570469 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/pcips2.c	2010-04-13 02:19:00.904633069 +0000
@@ -15,6 +15,7 @@
 #include <linux/ioport.h>
 #include <linux/input.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/serio.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/q40kbd.c linux-2.6.34-rc4/drivers/input/serio/q40kbd.c
--- linux-2.6.34-rc3/drivers/input/serio/q40kbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/q40kbd.c	2010-04-13 02:19:00.904633069 +0000
@@ -36,6 +36,7 @@
 #include <linux/err.h>
 #include <linux/bitops.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/rpckbd.c linux-2.6.34-rc4/drivers/input/serio/rpckbd.c
--- linux-2.6.34-rc3/drivers/input/serio/rpckbd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/rpckbd.c	2010-04-13 02:19:00.905633110 +0000
@@ -34,6 +34,7 @@
 #include <linux/err.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/input/serio/xilinx_ps2.c linux-2.6.34-rc4/drivers/input/serio/xilinx_ps2.c
--- linux-2.6.34-rc3/drivers/input/serio/xilinx_ps2.c	2010-04-13 02:18:55.761570468 +0000
+++ linux-2.6.34-rc4/drivers/input/serio/xilinx_ps2.c	2010-04-13 02:19:00.905633110 +0000
@@ -19,6 +19,7 @@
 #include <linux/serio.h>
 #include <linux/interrupt.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/input/sparse-keymap.c linux-2.6.34-rc4/drivers/input/sparse-keymap.c
--- linux-2.6.34-rc3/drivers/input/sparse-keymap.c	2010-04-13 02:18:55.761570468 +0000
+++ linux-2.6.34-rc4/drivers/input/sparse-keymap.c	2010-04-13 02:19:00.905633110 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/input.h>
 #include <linux/input/sparse-keymap.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Dmitry Torokhov <dtor@mail.ru>");
 MODULE_DESCRIPTION("Generic support for sparse keymaps");
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/88pm860x-ts.c linux-2.6.34-rc4/drivers/input/touchscreen/88pm860x-ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/88pm860x-ts.c	2010-04-13 02:18:55.763633087 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/88pm860x-ts.c	2010-04-13 02:19:00.907633032 +0000
@@ -14,6 +14,7 @@
 #include <linux/i2c.h>
 #include <linux/input.h>
 #include <linux/mfd/88pm860x.h>
+#include <linux/slab.h>
 
 #define MEAS_LEN		(8)
 #define ACCURATE_BIT		(12)
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/atmel-wm97xx.c linux-2.6.34-rc4/drivers/input/touchscreen/atmel-wm97xx.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/atmel-wm97xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/atmel-wm97xx.c	2010-04-13 02:19:00.908633095 +0000
@@ -19,6 +19,7 @@
 #include <linux/timer.h>
 #include <linux/gpio.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define AC97C_ICA		0x10
 #define AC97C_CBRHR		0x30
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/da9034-ts.c linux-2.6.34-rc4/drivers/input/touchscreen/da9034-ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/da9034-ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/da9034-ts.c	2010-04-13 02:19:00.908633095 +0000
@@ -19,6 +19,7 @@
 #include <linux/input.h>
 #include <linux/workqueue.h>
 #include <linux/mfd/da903x.h>
+#include <linux/slab.h>
 
 #define DA9034_MANUAL_CTRL	0x50
 #define DA9034_LDO_ADC_EN	(1 << 4)
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/eeti_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/eeti_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/eeti_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/eeti_ts.c	2010-04-13 02:19:00.908633095 +0000
@@ -33,6 +33,7 @@
 #include <linux/timer.h>
 #include <linux/gpio.h>
 #include <linux/input/eeti_ts.h>
+#include <linux/slab.h>
 
 static int flip_x;
 module_param(flip_x, bool, 0644);
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/jornada720_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/jornada720_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/jornada720_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/jornada720_ts.c	2010-04-13 02:19:00.908633095 +0000
@@ -18,6 +18,7 @@
 #include <linux/input.h>
 #include <linux/interrupt.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/jornada720.h>
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/mc13783_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/mc13783_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/mc13783_ts.c	2010-04-13 02:18:55.764633038 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/mc13783_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -17,6 +17,7 @@
 #include <linux/module.h>
 #include <linux/input.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #define MC13783_TS_NAME	"mc13783-ts"
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/mcs5000_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/mcs5000_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/mcs5000_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/mcs5000_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -20,6 +20,7 @@
 #include <linux/interrupt.h>
 #include <linux/input.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 /* Registers */
 #define MCS5000_TS_STATUS		0x00
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/migor_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/migor_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/migor_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/migor_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/input.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/i2c.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/pcap_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/pcap_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/pcap_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/pcap_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -14,6 +14,7 @@
 #include <linux/init.h>
 #include <linux/fs.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/pm.h>
 #include <linux/timer.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/s3c2410_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/s3c2410_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/s3c2410_ts.c	2010-04-13 02:18:55.764633038 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/s3c2410_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -26,7 +26,6 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/input.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/ucb1400_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/ucb1400_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/ucb1400_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/ucb1400_ts.c	2010-04-13 02:19:00.909633043 +0000
@@ -26,7 +26,6 @@
 #include <linux/device.h>
 #include <linux/interrupt.h>
 #include <linux/suspend.h>
-#include <linux/slab.h>
 #include <linux/kthread.h>
 #include <linux/freezer.h>
 #include <linux/ucb1400.h>
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/w90p910_ts.c linux-2.6.34-rc4/drivers/input/touchscreen/w90p910_ts.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/w90p910_ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/w90p910_ts.c	2010-04-13 02:19:00.910633036 +0000
@@ -16,6 +16,7 @@
 #include <linux/clk.h>
 #include <linux/input.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 /* ADC controller bit defines */
 #define ADC_DELAY	0xf00
diff -urN linux-2.6.34-rc3/drivers/input/touchscreen/wm97xx-core.c linux-2.6.34-rc4/drivers/input/touchscreen/wm97xx-core.c
--- linux-2.6.34-rc3/drivers/input/touchscreen/wm97xx-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/input/touchscreen/wm97xx-core.c	2010-04-13 02:19:00.910633036 +0000
@@ -48,6 +48,7 @@
 #include <linux/wm97xx.h>
 #include <linux/uaccess.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define TS_NAME			"wm97xx"
 #define WM_CORE_VERSION		"1.00"
diff -urN linux-2.6.34-rc3/drivers/input/xen-kbdfront.c linux-2.6.34-rc4/drivers/input/xen-kbdfront.c
--- linux-2.6.34-rc3/drivers/input/xen-kbdfront.c	2010-04-13 02:18:55.765633064 +0000
+++ linux-2.6.34-rc4/drivers/input/xen-kbdfront.c	2010-04-13 02:19:00.910633036 +0000
@@ -21,6 +21,7 @@
 #include <linux/errno.h>
 #include <linux/module.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include <asm/xen/hypervisor.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/act2000/module.c linux-2.6.34-rc4/drivers/isdn/act2000/module.c
--- linux-2.6.34-rc3/drivers/isdn/act2000/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/act2000/module.c	2010-04-13 02:19:00.910633036 +0000
@@ -16,6 +16,7 @@
 #include "act2000_isa.h"
 #include "capi.h"
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 static unsigned short act2000_isa_ports[] =
diff -urN linux-2.6.34-rc3/drivers/isdn/capi/capifs.c linux-2.6.34-rc4/drivers/isdn/capi/capifs.c
--- linux-2.6.34-rc3/drivers/isdn/capi/capifs.c	2010-04-13 02:18:55.766633048 +0000
+++ linux-2.6.34-rc4/drivers/isdn/capi/capifs.c	2010-04-13 02:19:00.912577686 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/fs.h>
 #include <linux/mount.h>
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/capi/capilib.c linux-2.6.34-rc4/drivers/isdn/capi/capilib.c
--- linux-2.6.34-rc3/drivers/isdn/capi/capilib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/capi/capilib.c	2010-04-13 02:19:00.912577686 +0000
@@ -1,4 +1,5 @@
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/isdn/capilli.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/capi/capiutil.c linux-2.6.34-rc4/drivers/isdn/capi/capiutil.c
--- linux-2.6.34-rc3/drivers/isdn/capi/capiutil.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/capi/capiutil.c	2010-04-13 02:19:00.912577686 +0000
@@ -18,6 +18,7 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/isdn/capiutil.h>
+#include <linux/slab.h>
 
 /* from CAPI2.0 DDK AVM Berlin GmbH */
 
diff -urN linux-2.6.34-rc3/drivers/isdn/capi/kcapi.c linux-2.6.34-rc4/drivers/isdn/capi/kcapi.c
--- linux-2.6.34-rc3/drivers/isdn/capi/kcapi.c	2010-04-13 02:18:55.767633017 +0000
+++ linux-2.6.34-rc4/drivers/isdn/capi/kcapi.c	2010-04-13 02:19:00.914570756 +0000
@@ -27,6 +27,7 @@
 #include <linux/init.h>
 #include <linux/moduleparam.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/isdn/capicmd.h>
 #include <linux/isdn/capiutil.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/divert/divert_procfs.c linux-2.6.34-rc4/drivers/isdn/divert/divert_procfs.c
--- linux-2.6.34-rc3/drivers/isdn/divert/divert_procfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/divert/divert_procfs.c	2010-04-13 02:19:00.914570756 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #ifdef CONFIG_PROC_FS
 #include <linux/proc_fs.h>
 #else
diff -urN linux-2.6.34-rc3/drivers/isdn/divert/isdn_divert.c linux-2.6.34-rc4/drivers/isdn/divert/isdn_divert.c
--- linux-2.6.34-rc3/drivers/isdn/divert/isdn_divert.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/divert/isdn_divert.c	2010-04-13 02:19:00.914570756 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/jiffies.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/gigaset/capi.c linux-2.6.34-rc4/drivers/isdn/gigaset/capi.c
--- linux-2.6.34-rc3/drivers/isdn/gigaset/capi.c	2010-04-13 02:18:55.769571567 +0000
+++ linux-2.6.34-rc4/drivers/isdn/gigaset/capi.c	2010-04-13 02:19:00.915633082 +0000
@@ -12,6 +12,7 @@
  */
 
 #include "gigaset.h"
+#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/gigaset/common.c linux-2.6.34-rc4/drivers/isdn/gigaset/common.c
--- linux-2.6.34-rc3/drivers/isdn/gigaset/common.c	2010-04-13 02:18:55.769571567 +0000
+++ linux-2.6.34-rc4/drivers/isdn/gigaset/common.c	2010-04-13 02:19:00.915633082 +0000
@@ -17,6 +17,7 @@
 #include <linux/ctype.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 
 /* Version Information */
 #define DRIVER_AUTHOR "Hansjoerg Lipp <hjlipp@web.de>, Tilman Schmidt <tilman@imap.cc>, Stefan Eilers"
diff -urN linux-2.6.34-rc3/drivers/isdn/gigaset/gigaset.h linux-2.6.34-rc4/drivers/isdn/gigaset/gigaset.h
--- linux-2.6.34-rc3/drivers/isdn/gigaset/gigaset.h	2010-04-13 02:18:55.770570468 +0000
+++ linux-2.6.34-rc4/drivers/isdn/gigaset/gigaset.h	2010-04-13 02:19:00.916633070 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/compiler.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/usb.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/gigaset/i4l.c linux-2.6.34-rc4/drivers/isdn/gigaset/i4l.c
--- linux-2.6.34-rc3/drivers/isdn/gigaset/i4l.c	2010-04-13 02:18:55.770570468 +0000
+++ linux-2.6.34-rc4/drivers/isdn/gigaset/i4l.c	2010-04-13 02:19:00.916633070 +0000
@@ -15,6 +15,7 @@
 
 #include "gigaset.h"
 #include <linux/isdnif.h>
+#include <linux/slab.h>
 
 #define HW_HDR_LEN	2	/* Header size used to store ack info */
 
diff -urN linux-2.6.34-rc3/drivers/isdn/gigaset/ser-gigaset.c linux-2.6.34-rc4/drivers/isdn/gigaset/ser-gigaset.c
--- linux-2.6.34-rc3/drivers/isdn/gigaset/ser-gigaset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/gigaset/ser-gigaset.c	2010-04-13 02:19:00.917633076 +0000
@@ -17,6 +17,7 @@
 #include <linux/platform_device.h>
 #include <linux/tty.h>
 #include <linux/completion.h>
+#include <linux/slab.h>
 
 /* Version Information */
 #define DRIVER_AUTHOR "Tilman Schmidt"
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/avm/b1.c linux-2.6.34-rc4/drivers/isdn/hardware/avm/b1.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/avm/b1.c	2010-04-13 02:18:55.771570617 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/avm/b1.c	2010-04-13 02:19:00.917633076 +0000
@@ -21,6 +21,7 @@
 #include <linux/ioport.h>
 #include <linux/capi.h>
 #include <linux/kernelcapi.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/avm/b1dma.c linux-2.6.34-rc4/drivers/isdn/hardware/avm/b1dma.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/avm/b1dma.c	2010-04-13 02:18:55.771570617 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/avm/b1dma.c	2010-04-13 02:19:00.918633043 +0000
@@ -20,6 +20,7 @@
 #include <linux/ioport.h>
 #include <linux/capi.h>
 #include <linux/kernelcapi.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/avm/c4.c linux-2.6.34-rc4/drivers/isdn/hardware/avm/c4.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/avm/c4.c	2010-04-13 02:18:55.772570460 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/avm/c4.c	2010-04-13 02:19:00.918633043 +0000
@@ -22,6 +22,7 @@
 #include <linux/capi.h>
 #include <linux/kernelcapi.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/avm/t1isa.c linux-2.6.34-rc4/drivers/isdn/hardware/avm/t1isa.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/avm/t1isa.c	2010-04-13 02:18:55.772570460 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/avm/t1isa.c	2010-04-13 02:19:00.918633043 +0000
@@ -21,6 +21,7 @@
 #include <linux/kernelcapi.h>
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <linux/isdn/capicmd.h>
 #include <linux/isdn/capiutil.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/eicon/capimain.c linux-2.6.34-rc4/drivers/isdn/hardware/eicon/capimain.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/eicon/capimain.c	2010-04-13 02:18:55.772570460 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/eicon/capimain.c	2010-04-13 02:19:00.919633009 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/avmfritz.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/avmfritz.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/avmfritz.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/avmfritz.c	2010-04-13 02:19:00.922633006 +0000
@@ -24,6 +24,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "ipac.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcmulti.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcmulti.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcmulti.c	2010-04-13 02:18:55.775633021 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcmulti.c	2010-04-13 02:19:00.922633006 +0000
@@ -153,6 +153,7 @@
 #define HFC_MULTI_VERSION	"2.03"
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcpci.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcpci.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcpci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcpci.c	2010-04-13 02:19:00.923633029 +0000
@@ -48,6 +48,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 
 #include "hfc_pci.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcsusb.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcsusb.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/hfcsusb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/hfcsusb.c	2010-04-13 02:19:00.923633029 +0000
@@ -33,6 +33,7 @@
 #include <linux/delay.h>
 #include <linux/usb.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 #include "hfcsusb.h"
 
 static const char *hfcsusb_rev = "Revision: 0.3.3 (socket), 2008-11-05";
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNinfineon.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNinfineon.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNinfineon.c	2010-04-13 02:18:55.776633101 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNinfineon.c	2010-04-13 02:19:00.923633029 +0000
@@ -42,6 +42,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 #include "ipac.h"
 
 #define INFINEON_REV	"1.0"
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNipac.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNipac.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNipac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNipac.c	2010-04-13 02:19:00.924633065 +0000
@@ -20,6 +20,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/mISDNhw.h>
 #include "ipac.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNisar.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNisar.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/mISDNisar.c	2010-04-13 02:18:55.776633101 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/mISDNisar.c	2010-04-13 02:19:00.924633065 +0000
@@ -25,6 +25,7 @@
  */
 /* #define DEBUG */
 
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/vmalloc.h>
 #include <linux/mISDNhw.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/netjet.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/netjet.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/netjet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/netjet.c	2010-04-13 02:19:00.924633065 +0000
@@ -24,6 +24,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 #include "ipac.h"
 #include "iohelper.h"
 #include "netjet.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/speedfax.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/speedfax.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/speedfax.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/speedfax.c	2010-04-13 02:19:00.924633065 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/w6692.c linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/w6692.c
--- linux-2.6.34-rc3/drivers/isdn/hardware/mISDN/w6692.c	2010-04-13 02:18:55.776633101 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hardware/mISDN/w6692.c	2010-04-13 02:19:00.924633065 +0000
@@ -25,6 +25,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/mISDNhw.h>
+#include <linux/slab.h>
 #include "w6692.h"
 
 #define W6692_REV	"2.0"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/amd7930_fn.c linux-2.6.34-rc4/drivers/isdn/hisax/amd7930_fn.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/amd7930_fn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/amd7930_fn.c	2010-04-13 02:19:00.925633164 +0000
@@ -59,6 +59,7 @@
 #include "amd7930_fn.h"
 #include <linux/interrupt.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 
 static void Amd7930_new_ph(struct IsdnCardState *cs);
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/avm_pci.c linux-2.6.34-rc4/drivers/isdn/hisax/avm_pci.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/avm_pci.c	2010-04-13 02:18:55.776633101 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/avm_pci.c	2010-04-13 02:19:00.925633164 +0000
@@ -17,6 +17,7 @@
 #include "isac.h"
 #include "isdnl1.h"
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/isapnp.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/callc.c linux-2.6.34-rc4/drivers/isdn/hisax/callc.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/callc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/callc.c	2010-04-13 02:19:00.925633164 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include "hisax.h"
 #include <linux/isdn/capicmd.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/config.c linux-2.6.34-rc4/drivers/isdn/hisax/config.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/config.c	2010-04-13 02:19:00.926633055 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel_stat.h>
 #include <linux/workqueue.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #define HISAX_STATUS_BUFSIZE 4096
 
 /*
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/elsa.c linux-2.6.34-rc4/drivers/isdn/hisax/elsa.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/elsa.c	2010-04-13 02:18:55.777633040 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/elsa.c	2010-04-13 02:19:00.926633055 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include "hisax.h"
 #include "arcofi.h"
 #include "isac.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/elsa_ser.c linux-2.6.34-rc4/drivers/isdn/hisax/elsa_ser.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/elsa_ser.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/elsa_ser.c	2010-04-13 02:19:00.926633055 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/serial.h>
 #include <linux/serial_reg.h>
+#include <linux/slab.h>
 
 #define MAX_MODEM_BUF	256
 #define WAKEUP_CHARS	(MAX_MODEM_BUF/2)
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/fsm.c linux-2.6.34-rc4/drivers/isdn/hisax/fsm.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/fsm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/fsm.c	2010-04-13 02:19:00.927633034 +0000
@@ -15,6 +15,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include "hisax.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hfc4s8s_l1.c linux-2.6.34-rc4/drivers/isdn/hisax/hfc4s8s_l1.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hfc4s8s_l1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hfc4s8s_l1.c	2010-04-13 02:19:00.927633034 +0000
@@ -25,6 +25,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/skbuff.h>
 #include <linux/wait.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hfc_2bds0.c linux-2.6.34-rc4/drivers/isdn/hisax/hfc_2bds0.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hfc_2bds0.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hfc_2bds0.c	2010-04-13 02:19:00.927633034 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/init.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "hisax.h"
 #include "hfc_2bds0.h"
 #include "isdnl1.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hfc_2bs0.c linux-2.6.34-rc4/drivers/isdn/hisax/hfc_2bs0.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hfc_2bs0.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hfc_2bs0.c	2010-04-13 02:19:00.927633034 +0000
@@ -16,6 +16,7 @@
 #include "isac.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 static inline int
 WaitForBusy(struct IsdnCardState *cs)
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hfc_sx.c linux-2.6.34-rc4/drivers/isdn/hisax/hfc_sx.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hfc_sx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hfc_sx.c	2010-04-13 02:19:00.928633058 +0000
@@ -17,6 +17,7 @@
 #include "isdnl1.h"
 #include <linux/interrupt.h>
 #include <linux/isapnp.h>
+#include <linux/slab.h>
 
 static const char *hfcsx_revision = "$Revision: 1.12.2.5 $";
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hfc_usb.c linux-2.6.34-rc4/drivers/isdn/hisax/hfc_usb.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hfc_usb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hfc_usb.c	2010-04-13 02:19:00.928633058 +0000
@@ -39,6 +39,7 @@
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include "hisax.h"
 #include "hisax_if.h"
 #include "hfc_usb.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hisax_isac.c linux-2.6.34-rc4/drivers/isdn/hisax/hisax_isac.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hisax_isac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hisax_isac.c	2010-04-13 02:19:00.928633058 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/netdevice.h>
 #include "hisax_isac.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/hscx.c linux-2.6.34-rc4/drivers/isdn/hisax/hscx.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/hscx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/hscx.c	2010-04-13 02:19:00.928633058 +0000
@@ -16,6 +16,7 @@
 #include "isac.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 static char *HSCXVer[] =
 {"A1", "?1", "A2", "?3", "A3", "V2.1", "?6", "?7",
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/icc.c linux-2.6.34-rc4/drivers/isdn/hisax/icc.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/icc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/icc.c	2010-04-13 02:19:00.929633079 +0000
@@ -20,6 +20,7 @@
 // #include "arcofi.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #define DBUSY_TIMER_VALUE 80
 #define ARCOFI_USE 0
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/ipacx.c linux-2.6.34-rc4/drivers/isdn/hisax/ipacx.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/ipacx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/ipacx.c	2010-04-13 02:19:00.929633079 +0000
@@ -10,6 +10,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include "hisax_if.h"
 #include "hisax.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/isac.c linux-2.6.34-rc4/drivers/isdn/hisax/isac.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/isac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/isac.c	2010-04-13 02:19:00.929633079 +0000
@@ -18,6 +18,7 @@
 #include "arcofi.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #define DBUSY_TIMER_VALUE 80
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/isar.c linux-2.6.34-rc4/drivers/isdn/hisax/isar.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/isar.c	2010-04-13 02:18:55.778633054 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/isar.c	2010-04-13 02:19:00.929633079 +0000
@@ -13,6 +13,7 @@
 #include "isar.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #define DBG_LOADFIRM	0
 #define DUMP_MBOXFRAME	2
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/isdnl1.c linux-2.6.34-rc4/drivers/isdn/hisax/isdnl1.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/isdnl1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/isdnl1.c	2010-04-13 02:19:00.929633079 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include "hisax.h"
 #include "isdnl1.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/isdnl2.c linux-2.6.34-rc4/drivers/isdn/hisax/isdnl2.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/isdnl2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/isdnl2.c	2010-04-13 02:19:00.930633033 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include "hisax.h"
 #include "isdnl2.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/isdnl3.c linux-2.6.34-rc4/drivers/isdn/hisax/isdnl3.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/isdnl3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/isdnl3.c	2010-04-13 02:19:00.930633033 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include "hisax.h"
 #include "isdnl3.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/jade.c linux-2.6.34-rc4/drivers/isdn/hisax/jade.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/jade.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/jade.c	2010-04-13 02:19:00.930633033 +0000
@@ -17,6 +17,7 @@
 #include "jade.h"
 #include "isdnl1.h"
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 
 int
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/l3dss1.c linux-2.6.34-rc4/drivers/isdn/hisax/l3dss1.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/l3dss1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/l3dss1.c	2010-04-13 02:19:00.930633033 +0000
@@ -23,6 +23,7 @@
 #include "isdnl3.h"
 #include "l3dss1.h"
 #include <linux/ctype.h>
+#include <linux/slab.h>
 
 extern char *HiSax_getrev(const char *revision);
 static const char *dss1_revision = "$Revision: 2.32.2.3 $";
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/l3ni1.c linux-2.6.34-rc4/drivers/isdn/hisax/l3ni1.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/l3ni1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/l3ni1.c	2010-04-13 02:19:00.931572572 +0000
@@ -22,6 +22,7 @@
 #include "isdnl3.h"
 #include "l3ni1.h"
 #include <linux/ctype.h>
+#include <linux/slab.h>
 
 extern char *HiSax_getrev(const char *revision);
 static const char *ni1_revision = "$Revision: 2.8.2.3 $";
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/netjet.c linux-2.6.34-rc4/drivers/isdn/hisax/netjet.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/netjet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/netjet.c	2010-04-13 02:19:00.931572572 +0000
@@ -21,6 +21,7 @@
 #include "isdnl1.h"
 #include <linux/interrupt.h>
 #include <linux/ppp_defs.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include "netjet.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/st5481_b.c linux-2.6.34-rc4/drivers/isdn/hisax/st5481_b.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/st5481_b.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/st5481_b.c	2010-04-13 02:19:00.932570472 +0000
@@ -11,8 +11,8 @@
  */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/usb.h>
-#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/bitrev.h>
 #include "st5481.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/st5481_d.c linux-2.6.34-rc4/drivers/isdn/hisax/st5481_d.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/st5481_d.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/st5481_d.c	2010-04-13 02:19:00.932570472 +0000
@@ -11,8 +11,8 @@
  */
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/usb.h>
-#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include "st5481.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/tei.c linux-2.6.34-rc4/drivers/isdn/hisax/tei.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/tei.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/tei.c	2010-04-13 02:19:00.932570472 +0000
@@ -17,6 +17,7 @@
 
 #include "hisax.h"
 #include "isdnl2.h"
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/random.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hisax/w6692.c linux-2.6.34-rc4/drivers/isdn/hisax/w6692.c
--- linux-2.6.34-rc3/drivers/isdn/hisax/w6692.c	2010-04-13 02:18:55.779571509 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hisax/w6692.c	2010-04-13 02:19:00.932570472 +0000
@@ -16,6 +16,7 @@
 #include "isdnl1.h"
 #include <linux/interrupt.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 /* table entry in the PCI devices list */
 typedef struct {
diff -urN linux-2.6.34-rc3/drivers/isdn/hysdn/hycapi.c linux-2.6.34-rc4/drivers/isdn/hysdn/hycapi.c
--- linux-2.6.34-rc3/drivers/isdn/hysdn/hycapi.c	2010-04-13 02:18:55.780570458 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hysdn/hycapi.c	2010-04-13 02:19:00.932570472 +0000
@@ -17,6 +17,7 @@
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #define	VER_DRIVER	0
 #define	VER_CARDTYPE	1
diff -urN linux-2.6.34-rc3/drivers/isdn/hysdn/hysdn_procconf.c linux-2.6.34-rc4/drivers/isdn/hysdn/hysdn_procconf.c
--- linux-2.6.34-rc3/drivers/isdn/hysdn/hysdn_procconf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hysdn/hysdn_procconf.c	2010-04-13 02:19:00.933570487 +0000
@@ -16,6 +16,7 @@
 #include <linux/poll.h>
 #include <linux/proc_fs.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <net/net_namespace.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/hysdn/hysdn_proclog.c linux-2.6.34-rc4/drivers/isdn/hysdn/hysdn_proclog.c
--- linux-2.6.34-rc3/drivers/isdn/hysdn/hysdn_proclog.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/hysdn/hysdn_proclog.c	2010-04-13 02:19:00.933570487 +0000
@@ -14,6 +14,7 @@
 #include <linux/poll.h>
 #include <linux/proc_fs.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 
 #include "hysdn_defs.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_audio.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_audio.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_audio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_audio.c	2010-04-13 02:19:00.933570487 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/isdn.h>
+#include <linux/slab.h>
 #include "isdn_audio.h"
 #include "isdn_common.h"
 
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_common.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_common.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_common.c	2010-04-13 02:18:55.780570458 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_common.c	2010-04-13 02:19:00.933570487 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/isdn.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_net.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_net.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_net.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_net.c	2010-04-13 02:19:00.934633773 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/isdn.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/dst.h>
 #include <net/pkt_sched.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_ppp.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_ppp.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_ppp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_ppp.c	2010-04-13 02:19:00.934633773 +0000
@@ -12,6 +12,7 @@
 #include <linux/isdn.h>
 #include <linux/poll.h>
 #include <linux/ppp-comp.h>
+#include <linux/slab.h>
 #ifdef CONFIG_IPPP_FILTER
 #include <linux/filter.h>
 #endif
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_tty.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_tty.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_tty.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_tty.c	2010-04-13 02:19:00.935633152 +0000
@@ -12,6 +12,7 @@
 #undef ISDN_TTY_STAT_DEBUG
 
 #include <linux/isdn.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/smp_lock.h>
 #include "isdn_common.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/i4l/isdn_x25iface.c linux-2.6.34-rc4/drivers/isdn/i4l/isdn_x25iface.c
--- linux-2.6.34-rc3/drivers/isdn/i4l/isdn_x25iface.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/i4l/isdn_x25iface.c	2010-04-13 02:19:00.935633152 +0000
@@ -20,6 +20,7 @@
 /* #include <linux/isdn.h> */
 #include <linux/netdevice.h>
 #include <linux/concap.h>
+#include <linux/slab.h>
 #include <linux/wanrouter.h>
 #include <net/x25device.h>
 #include "isdn_x25iface.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/icn/icn.c linux-2.6.34-rc4/drivers/isdn/icn/icn.c
--- linux-2.6.34-rc3/drivers/isdn/icn/icn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/icn/icn.c	2010-04-13 02:19:00.935633152 +0000
@@ -12,6 +12,7 @@
 #include "icn.h"
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 static int portbase = ICN_BASEADDR;
diff -urN linux-2.6.34-rc3/drivers/isdn/isdnloop/isdnloop.c linux-2.6.34-rc4/drivers/isdn/isdnloop/isdnloop.c
--- linux-2.6.34-rc3/drivers/isdn/isdnloop/isdnloop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/isdnloop/isdnloop.c	2010-04-13 02:19:00.935633152 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include "isdnloop.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/clock.c linux-2.6.34-rc4/drivers/isdn/mISDN/clock.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/clock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/clock.c	2010-04-13 02:19:00.935633152 +0000
@@ -33,6 +33,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/stddef.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/core.c linux-2.6.34-rc4/drivers/isdn/mISDN/core.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/core.c	2010-04-13 02:19:00.935633152 +0000
@@ -12,6 +12,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/stddef.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_cmx.c linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_cmx.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_cmx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_cmx.c	2010-04-13 02:19:00.936633098 +0000
@@ -124,6 +124,7 @@
 
 /* delay.h is required for hw_lock.h */
 
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/mISDNif.h>
 #include <linux/mISDNdsp.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_core.c linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_core.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_core.c	2010-04-13 02:18:55.780570458 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_core.c	2010-04-13 02:19:00.936633098 +0000
@@ -154,6 +154,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/mISDNif.h>
 #include <linux/mISDNdsp.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_pipeline.c linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_pipeline.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_pipeline.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_pipeline.c	2010-04-13 02:19:00.936633098 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/string.h>
 #include <linux/mISDNif.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_tones.c linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_tones.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/dsp_tones.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/dsp_tones.c	2010-04-13 02:19:00.936633098 +0000
@@ -8,6 +8,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/mISDNif.h>
 #include <linux/mISDNdsp.h>
 #include "core.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/hwchannel.c linux-2.6.34-rc4/drivers/isdn/mISDN/hwchannel.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/hwchannel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/hwchannel.c	2010-04-13 02:19:00.936633098 +0000
@@ -15,6 +15,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/mISDNhw.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/l1oip_core.c linux-2.6.34-rc4/drivers/isdn/mISDN/l1oip_core.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/l1oip_core.c	2010-04-13 02:18:55.780570458 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/l1oip_core.c	2010-04-13 02:19:00.936633098 +0000
@@ -233,6 +233,7 @@
 #include <linux/inet.h>
 #include <linux/workqueue.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include "core.h"
 #include "l1oip.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/layer1.c linux-2.6.34-rc4/drivers/isdn/mISDN/layer1.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/layer1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/layer1.c	2010-04-13 02:19:00.936633098 +0000
@@ -16,6 +16,7 @@
  */
 
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/mISDNhw.h>
 #include "core.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/layer2.c linux-2.6.34-rc4/drivers/isdn/mISDN/layer2.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/layer2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/layer2.c	2010-04-13 02:19:00.937633065 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/mISDNif.h>
+#include <linux/slab.h>
 #include "core.h"
 #include "fsm.h"
 #include "layer2.h"
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/socket.c linux-2.6.34-rc4/drivers/isdn/mISDN/socket.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/socket.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/socket.c	2010-04-13 02:19:00.937633065 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/mISDNif.h>
+#include <linux/slab.h>
 #include "core.h"
 
 static u_int	*debug;
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/stack.c linux-2.6.34-rc4/drivers/isdn/mISDN/stack.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/stack.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/stack.c	2010-04-13 02:19:00.937633065 +0000
@@ -15,6 +15,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/mISDNif.h>
 #include <linux/kthread.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/tei.c linux-2.6.34-rc4/drivers/isdn/mISDN/tei.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/tei.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/tei.c	2010-04-13 02:19:00.937633065 +0000
@@ -16,6 +16,7 @@
  */
 #include "layer2.h"
 #include <linux/random.h>
+#include <linux/slab.h>
 #include "core.h"
 
 #define ID_REQUEST	1
diff -urN linux-2.6.34-rc3/drivers/isdn/mISDN/timerdev.c linux-2.6.34-rc4/drivers/isdn/mISDN/timerdev.c
--- linux-2.6.34-rc3/drivers/isdn/mISDN/timerdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/mISDN/timerdev.c	2010-04-13 02:19:00.937633065 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/poll.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/miscdevice.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/isdn/pcbit/callbacks.c linux-2.6.34-rc4/drivers/isdn/pcbit/callbacks.c
--- linux-2.6.34-rc3/drivers/isdn/pcbit/callbacks.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/pcbit/callbacks.c	2010-04-13 02:19:00.937633065 +0000
@@ -19,7 +19,6 @@
 #include <linux/kernel.h>
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/skbuff.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/pcbit/edss1.c linux-2.6.34-rc4/drivers/isdn/pcbit/edss1.c
--- linux-2.6.34-rc3/drivers/isdn/pcbit/edss1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/pcbit/edss1.c	2010-04-13 02:19:00.938633070 +0000
@@ -19,7 +19,6 @@
 #include <linux/kernel.h>
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/skbuff.h>
 
diff -urN linux-2.6.34-rc3/drivers/isdn/sc/init.c linux-2.6.34-rc4/drivers/isdn/sc/init.c
--- linux-2.6.34-rc3/drivers/isdn/sc/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/isdn/sc/init.c	2010-04-13 02:19:00.938633070 +0000
@@ -9,6 +9,7 @@
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "includes.h"
 #include "hardware.h"
 #include "card.h"
diff -urN linux-2.6.34-rc3/drivers/leds/dell-led.c linux-2.6.34-rc4/drivers/leds/dell-led.c
--- linux-2.6.34-rc3/drivers/leds/dell-led.c	2010-04-13 02:18:55.781570928 +0000
+++ linux-2.6.34-rc4/drivers/leds/dell-led.c	2010-04-13 02:19:00.939633043 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/acpi.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Louis Davis/Jim Dailey");
 MODULE_DESCRIPTION("Dell LED Control Driver");
diff -urN linux-2.6.34-rc3/drivers/leds/led-triggers.c linux-2.6.34-rc4/drivers/leds/led-triggers.c
--- linux-2.6.34-rc3/drivers/leds/led-triggers.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/led-triggers.c	2010-04-13 02:19:00.939633043 +0000
@@ -21,6 +21,7 @@
 #include <linux/timer.h>
 #include <linux/rwsem.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 #include "leds.h"
 
 /*
diff -urN linux-2.6.34-rc3/drivers/leds/leds-88pm860x.c linux-2.6.34-rc4/drivers/leds/leds-88pm860x.c
--- linux-2.6.34-rc3/drivers/leds/leds-88pm860x.c	2010-04-13 02:18:55.781570928 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-88pm860x.c	2010-04-13 02:19:00.939633043 +0000
@@ -15,6 +15,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/mfd/88pm860x.h>
 
diff -urN linux-2.6.34-rc3/drivers/leds/leds-adp5520.c linux-2.6.34-rc4/drivers/leds/leds-adp5520.c
--- linux-2.6.34-rc3/drivers/leds/leds-adp5520.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-adp5520.c	2010-04-13 02:19:00.939633043 +0000
@@ -20,6 +20,7 @@
 #include <linux/leds.h>
 #include <linux/workqueue.h>
 #include <linux/mfd/adp5520.h>
+#include <linux/slab.h>
 
 struct adp5520_led {
 	struct led_classdev	cdev;
diff -urN linux-2.6.34-rc3/drivers/leds/leds-atmel-pwm.c linux-2.6.34-rc4/drivers/leds/leds-atmel-pwm.c
--- linux-2.6.34-rc3/drivers/leds/leds-atmel-pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-atmel-pwm.c	2010-04-13 02:19:00.939633043 +0000
@@ -3,6 +3,7 @@
 #include <linux/leds.h>
 #include <linux/io.h>
 #include <linux/atmel_pwm.h>
+#include <linux/slab.h>
 
 
 struct pwmled {
diff -urN linux-2.6.34-rc3/drivers/leds/leds-bd2802.c linux-2.6.34-rc4/drivers/leds/leds-bd2802.c
--- linux-2.6.34-rc3/drivers/leds/leds-bd2802.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-bd2802.c	2010-04-13 02:19:00.939633043 +0000
@@ -18,6 +18,7 @@
 #include <linux/delay.h>
 #include <linux/leds.h>
 #include <linux/leds-bd2802.h>
+#include <linux/slab.h>
 
 
 #define LED_CTL(rgb2en, rgb1en) ((rgb2en) << 4 | ((rgb1en) << 0))
diff -urN linux-2.6.34-rc3/drivers/leds/leds-da903x.c linux-2.6.34-rc4/drivers/leds/leds-da903x.c
--- linux-2.6.34-rc3/drivers/leds/leds-da903x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-da903x.c	2010-04-13 02:19:00.940633067 +0000
@@ -19,6 +19,7 @@
 #include <linux/leds.h>
 #include <linux/workqueue.h>
 #include <linux/mfd/da903x.h>
+#include <linux/slab.h>
 
 #define DA9030_LED1_CONTROL	0x20
 #define DA9030_LED2_CONTROL	0x21
diff -urN linux-2.6.34-rc3/drivers/leds/leds-dac124s085.c linux-2.6.34-rc4/drivers/leds/leds-dac124s085.c
--- linux-2.6.34-rc3/drivers/leds/leds-dac124s085.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-dac124s085.c	2010-04-13 02:19:00.940633067 +0000
@@ -9,7 +9,6 @@
  * LED driver for the DAC124S085 SPI DAC
  */
 
-#include <linux/gfp.h>
 #include <linux/leds.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-gpio.c linux-2.6.34-rc4/drivers/leds/leds-gpio.c
--- linux-2.6.34-rc3/drivers/leds/leds-gpio.c	2010-04-13 02:18:55.781570928 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-gpio.c	2010-04-13 02:19:00.940633067 +0000
@@ -14,6 +14,7 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 
 #include <asm/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-lp3944.c linux-2.6.34-rc4/drivers/leds/leds-lp3944.c
--- linux-2.6.34-rc3/drivers/leds/leds-lp3944.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-lp3944.c	2010-04-13 02:19:00.940633067 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/leds.h>
 #include <linux/mutex.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-lt3593.c linux-2.6.34-rc4/drivers/leds/leds-lt3593.c
--- linux-2.6.34-rc3/drivers/leds/leds-lt3593.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-lt3593.c	2010-04-13 02:19:00.940633067 +0000
@@ -23,6 +23,7 @@
 #include <linux/workqueue.h>
 #include <linux/delay.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 struct lt3593_led_data {
 	struct led_classdev cdev;
diff -urN linux-2.6.34-rc3/drivers/leds/leds-pca9532.c linux-2.6.34-rc4/drivers/leds/leds-pca9532.c
--- linux-2.6.34-rc3/drivers/leds/leds-pca9532.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-pca9532.c	2010-04-13 02:19:00.940633067 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/module.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/leds.h>
 #include <linux/input.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-pca955x.c linux-2.6.34-rc4/drivers/leds/leds-pca955x.c
--- linux-2.6.34-rc3/drivers/leds/leds-pca955x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-pca955x.c	2010-04-13 02:19:00.940633067 +0000
@@ -48,6 +48,7 @@
 #include <linux/err.h>
 #include <linux/i2c.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 /* LED select registers determine the source that drives LED outputs */
 #define PCA955X_LS_LED_ON	0x0	/* Output LOW */
diff -urN linux-2.6.34-rc3/drivers/leds/leds-pwm.c linux-2.6.34-rc4/drivers/leds/leds-pwm.c
--- linux-2.6.34-rc3/drivers/leds/leds-pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-pwm.c	2010-04-13 02:19:00.940633067 +0000
@@ -21,6 +21,7 @@
 #include <linux/err.h>
 #include <linux/pwm.h>
 #include <linux/leds_pwm.h>
+#include <linux/slab.h>
 
 struct led_pwm_data {
 	struct led_classdev	cdev;
diff -urN linux-2.6.34-rc3/drivers/leds/leds-regulator.c linux-2.6.34-rc4/drivers/leds/leds-regulator.c
--- linux-2.6.34-rc3/drivers/leds/leds-regulator.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-regulator.c	2010-04-13 02:19:00.940633067 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/module.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/leds.h>
 #include <linux/leds-regulator.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-s3c24xx.c linux-2.6.34-rc4/drivers/leds/leds-s3c24xx.c
--- linux-2.6.34-rc3/drivers/leds/leds-s3c24xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-s3c24xx.c	2010-04-13 02:19:00.940633067 +0000
@@ -16,6 +16,7 @@
 #include <linux/platform_device.h>
 #include <linux/leds.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <mach/regs-gpio.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-sunfire.c linux-2.6.34-rc4/drivers/leds/leds-sunfire.c
--- linux-2.6.34-rc3/drivers/leds/leds-sunfire.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-sunfire.c	2010-04-13 02:19:00.941633049 +0000
@@ -9,6 +9,7 @@
 #include <linux/leds.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/fhc.h>
 #include <asm/upa.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-wm831x-status.c linux-2.6.34-rc4/drivers/leds/leds-wm831x-status.c
--- linux-2.6.34-rc3/drivers/leds/leds-wm831x-status.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-wm831x-status.c	2010-04-13 02:19:00.941633049 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/leds.h>
 #include <linux/err.h>
 #include <linux/mfd/wm831x/core.h>
diff -urN linux-2.6.34-rc3/drivers/leds/leds-wm8350.c linux-2.6.34-rc4/drivers/leds/leds-wm8350.c
--- linux-2.6.34-rc3/drivers/leds/leds-wm8350.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/leds-wm8350.c	2010-04-13 02:19:00.941633049 +0000
@@ -16,6 +16,7 @@
 #include <linux/err.h>
 #include <linux/mfd/wm8350/pmic.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 
 /* Microamps */
 static const int isink_cur[] = {
diff -urN linux-2.6.34-rc3/drivers/leds/ledtrig-backlight.c linux-2.6.34-rc4/drivers/leds/ledtrig-backlight.c
--- linux-2.6.34-rc3/drivers/leds/ledtrig-backlight.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/ledtrig-backlight.c	2010-04-13 02:19:00.941633049 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/fb.h>
 #include <linux/leds.h>
diff -urN linux-2.6.34-rc3/drivers/leds/ledtrig-gpio.c linux-2.6.34-rc4/drivers/leds/ledtrig-gpio.c
--- linux-2.6.34-rc3/drivers/leds/ledtrig-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/ledtrig-gpio.c	2010-04-13 02:19:00.941633049 +0000
@@ -16,6 +16,7 @@
 #include <linux/interrupt.h>
 #include <linux/workqueue.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 #include "leds.h"
 
 struct gpio_trig_data {
diff -urN linux-2.6.34-rc3/drivers/leds/ledtrig-heartbeat.c linux-2.6.34-rc4/drivers/leds/ledtrig-heartbeat.c
--- linux-2.6.34-rc3/drivers/leds/ledtrig-heartbeat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/ledtrig-heartbeat.c	2010-04-13 02:19:00.941633049 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/sched.h>
 #include <linux/leds.h>
diff -urN linux-2.6.34-rc3/drivers/leds/ledtrig-timer.c linux-2.6.34-rc4/drivers/leds/ledtrig-timer.c
--- linux-2.6.34-rc3/drivers/leds/ledtrig-timer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/leds/ledtrig-timer.c	2010-04-13 02:19:00.941633049 +0000
@@ -22,6 +22,7 @@
 #include <linux/timer.h>
 #include <linux/ctype.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 #include "leds.h"
 
 struct timer_trig_data {
diff -urN linux-2.6.34-rc3/drivers/lguest/core.c linux-2.6.34-rc4/drivers/lguest/core.c
--- linux-2.6.34-rc3/drivers/lguest/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/lguest/core.c	2010-04-13 02:19:00.941633049 +0000
@@ -12,6 +12,7 @@
 #include <linux/cpu.h>
 #include <linux/freezer.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <asm/paravirt.h>
 #include <asm/pgtable.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/lguest/lg.h linux-2.6.34-rc4/drivers/lguest/lg.h
--- linux-2.6.34-rc3/drivers/lguest/lg.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/lguest/lg.h	2010-04-13 02:19:00.941633049 +0000
@@ -10,6 +10,7 @@
 #include <linux/wait.h>
 #include <linux/hrtimer.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <asm/lguest.h>
 
diff -urN linux-2.6.34-rc3/drivers/lguest/lguest_device.c linux-2.6.34-rc4/drivers/lguest/lguest_device.c
--- linux-2.6.34-rc3/drivers/lguest/lguest_device.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/lguest/lguest_device.c	2010-04-13 02:19:00.941633049 +0000
@@ -15,6 +15,7 @@
 #include <linux/interrupt.h>
 #include <linux/virtio_ring.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/paravirt.h>
 #include <asm/lguest_hcall.h>
diff -urN linux-2.6.34-rc3/drivers/lguest/lguest_user.c linux-2.6.34-rc4/drivers/lguest/lguest_user.c
--- linux-2.6.34-rc3/drivers/lguest/lguest_user.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/lguest/lguest_user.c	2010-04-13 02:19:00.941633049 +0000
@@ -10,6 +10,7 @@
 #include <linux/sched.h>
 #include <linux/eventfd.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 #include "lg.h"
 
 /*L:056
diff -urN linux-2.6.34-rc3/drivers/lguest/page_tables.c linux-2.6.34-rc4/drivers/lguest/page_tables.c
--- linux-2.6.34-rc3/drivers/lguest/page_tables.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/lguest/page_tables.c	2010-04-13 02:19:00.942633081 +0000
@@ -10,6 +10,7 @@
 /* Copyright (C) Rusty Russell IBM Corporation 2006.
  * GPL v2 and any later version */
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include <linux/types.h>
 #include <linux/spinlock.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/drivers/macintosh/mac_hid.c linux-2.6.34-rc4/drivers/macintosh/mac_hid.c
--- linux-2.6.34-rc3/drivers/macintosh/mac_hid.c	2010-04-13 02:18:55.782570498 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/mac_hid.c	2010-04-13 02:19:00.942633081 +0000
@@ -13,6 +13,7 @@
 #include <linux/sysctl.h>
 #include <linux/input.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 
diff -urN linux-2.6.34-rc3/drivers/macintosh/rack-meter.c linux-2.6.34-rc4/drivers/macintosh/rack-meter.c
--- linux-2.6.34-rc3/drivers/macintosh/rack-meter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/rack-meter.c	2010-04-13 02:19:00.942633081 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/interrupt.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/macintosh/smu.c linux-2.6.34-rc4/drivers/macintosh/smu.c
--- linux-2.6.34-rc3/drivers/macintosh/smu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/smu.c	2010-04-13 02:19:00.942633081 +0000
@@ -38,6 +38,7 @@
 #include <linux/mutex.h>
 #include <linux/of_device.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 
 #include <asm/byteorder.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/macintosh/therm_pm72.c linux-2.6.34-rc4/drivers/macintosh/therm_pm72.c
--- linux-2.6.34-rc3/drivers/macintosh/therm_pm72.c	2010-04-13 02:18:55.782570498 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/therm_pm72.c	2010-04-13 02:19:00.943633033 +0000
@@ -114,7 +114,6 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/spinlock.h>
 #include <linux/wait.h>
diff -urN linux-2.6.34-rc3/drivers/macintosh/therm_windtunnel.c linux-2.6.34-rc4/drivers/macintosh/therm_windtunnel.c
--- linux-2.6.34-rc3/drivers/macintosh/therm_windtunnel.c	2010-04-13 02:18:55.783633016 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/therm_windtunnel.c	2010-04-13 02:19:00.943633033 +0000
@@ -34,7 +34,6 @@
 #include <linux/delay.h>
 #include <linux/sched.h>
 #include <linux/i2c.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kthread.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/macintosh/via-pmu68k.c linux-2.6.34-rc4/drivers/macintosh/via-pmu68k.c
--- linux-2.6.34-rc3/drivers/macintosh/via-pmu68k.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/via-pmu68k.c	2010-04-13 02:19:00.944570859 +0000
@@ -25,7 +25,6 @@
 #include <linux/miscdevice.h>
 #include <linux/blkdev.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/macintosh/windfarm_core.c linux-2.6.34-rc4/drivers/macintosh/windfarm_core.c
--- linux-2.6.34-rc3/drivers/macintosh/windfarm_core.c	2010-04-13 02:18:55.784633283 +0000
+++ linux-2.6.34-rc4/drivers/macintosh/windfarm_core.c	2010-04-13 02:19:00.944570859 +0000
@@ -25,6 +25,7 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/spinlock.h>
 #include <linux/kthread.h>
@@ -209,6 +210,7 @@
 	kref_init(&new_ct->ref);
 	list_add(&new_ct->link, &wf_controls);
 
+	sysfs_attr_init(&new_ct->attr.attr);
 	new_ct->attr.attr.name = new_ct->name;
 	new_ct->attr.attr.mode = 0644;
 	new_ct->attr.show = wf_show_control;
diff -urN linux-2.6.34-rc3/drivers/md/dm-log-userspace-base.c linux-2.6.34-rc4/drivers/md/dm-log-userspace-base.c
--- linux-2.6.34-rc3/drivers/md/dm-log-userspace-base.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/dm-log-userspace-base.c	2010-04-13 02:19:00.946570495 +0000
@@ -5,6 +5,7 @@
  */
 
 #include <linux/bio.h>
+#include <linux/slab.h>
 #include <linux/dm-dirty-log.h>
 #include <linux/device-mapper.h>
 #include <linux/dm-log-userspace.h>
diff -urN linux-2.6.34-rc3/drivers/md/dm-log-userspace-transfer.c linux-2.6.34-rc4/drivers/md/dm-log-userspace-transfer.c
--- linux-2.6.34-rc3/drivers/md/dm-log-userspace-transfer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/dm-log-userspace-transfer.c	2010-04-13 02:19:00.946570495 +0000
@@ -6,6 +6,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/workqueue.h>
 #include <linux/connector.h>
diff -urN linux-2.6.34-rc3/drivers/md/dm-region-hash.c linux-2.6.34-rc4/drivers/md/dm-region-hash.c
--- linux-2.6.34-rc3/drivers/md/dm-region-hash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/dm-region-hash.c	2010-04-13 02:19:00.947633053 +0000
@@ -11,6 +11,7 @@
 #include <linux/ctype.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "dm.h"
diff -urN linux-2.6.34-rc3/drivers/md/dm-service-time.c linux-2.6.34-rc4/drivers/md/dm-service-time.c
--- linux-2.6.34-rc3/drivers/md/dm-service-time.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/dm-service-time.c	2010-04-13 02:19:00.947633053 +0000
@@ -11,6 +11,8 @@
 #include "dm.h"
 #include "dm-path-selector.h"
 
+#include <linux/slab.h>
+
 #define DM_MSG_PREFIX	"multipath service-time"
 #define ST_MIN_IO	1
 #define ST_MAX_RELATIVE_THROUGHPUT	100
diff -urN linux-2.6.34-rc3/drivers/md/dm-target.c linux-2.6.34-rc4/drivers/md/dm-target.c
--- linux-2.6.34-rc3/drivers/md/dm-target.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/dm-target.c	2010-04-13 02:19:00.948633116 +0000
@@ -10,7 +10,6 @@
 #include <linux/init.h>
 #include <linux/kmod.h>
 #include <linux/bio.h>
-#include <linux/slab.h>
 
 #define DM_MSG_PREFIX "target"
 
diff -urN linux-2.6.34-rc3/drivers/md/faulty.c linux-2.6.34-rc4/drivers/md/faulty.c
--- linux-2.6.34-rc3/drivers/md/faulty.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/faulty.c	2010-04-13 02:19:00.949633074 +0000
@@ -64,6 +64,7 @@
 #define MaxFault	50
 #include <linux/blkdev.h>
 #include <linux/raid/md_u.h>
+#include <linux/slab.h>
 #include "md.h"
 #include <linux/seq_file.h>
 
diff -urN linux-2.6.34-rc3/drivers/md/linear.c linux-2.6.34-rc4/drivers/md/linear.c
--- linux-2.6.34-rc3/drivers/md/linear.c	2010-04-13 02:18:55.788633036 +0000
+++ linux-2.6.34-rc4/drivers/md/linear.c	2010-04-13 02:19:00.949633074 +0000
@@ -19,6 +19,7 @@
 #include <linux/blkdev.h>
 #include <linux/raid/md_u.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "md.h"
 #include "linear.h"
 
diff -urN linux-2.6.34-rc3/drivers/md/md.c linux-2.6.34-rc4/drivers/md/md.c
--- linux-2.6.34-rc3/drivers/md/md.c	2010-04-13 02:18:55.789571725 +0000
+++ linux-2.6.34-rc4/drivers/md/md.c	2010-04-13 02:19:00.950633037 +0000
@@ -49,6 +49,7 @@
 #include <linux/delay.h>
 #include <linux/raid/md_p.h>
 #include <linux/raid/md_u.h>
+#include <linux/slab.h>
 #include "md.h"
 #include "bitmap.h"
 
diff -urN linux-2.6.34-rc3/drivers/md/multipath.c linux-2.6.34-rc4/drivers/md/multipath.c
--- linux-2.6.34-rc3/drivers/md/multipath.c	2010-04-13 02:18:55.789571725 +0000
+++ linux-2.6.34-rc4/drivers/md/multipath.c	2010-04-13 02:19:00.950633037 +0000
@@ -22,6 +22,7 @@
 #include <linux/blkdev.h>
 #include <linux/raid/md_u.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "md.h"
 #include "multipath.h"
 
diff -urN linux-2.6.34-rc3/drivers/md/raid0.c linux-2.6.34-rc4/drivers/md/raid0.c
--- linux-2.6.34-rc3/drivers/md/raid0.c	2010-04-13 02:18:55.789571725 +0000
+++ linux-2.6.34-rc4/drivers/md/raid0.c	2010-04-13 02:19:00.950633037 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/blkdev.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "md.h"
 #include "raid0.h"
 
diff -urN linux-2.6.34-rc3/drivers/md/raid1.c linux-2.6.34-rc4/drivers/md/raid1.c
--- linux-2.6.34-rc3/drivers/md/raid1.c	2010-04-13 02:18:55.789571725 +0000
+++ linux-2.6.34-rc4/drivers/md/raid1.c	2010-04-13 02:19:00.950633037 +0000
@@ -31,6 +31,7 @@
  * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/blkdev.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/md/raid10.c linux-2.6.34-rc4/drivers/md/raid10.c
--- linux-2.6.34-rc3/drivers/md/raid10.c	2010-04-13 02:18:55.790570536 +0000
+++ linux-2.6.34-rc4/drivers/md/raid10.c	2010-04-13 02:19:00.951633031 +0000
@@ -18,6 +18,7 @@
  * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/blkdev.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/md/raid5.c linux-2.6.34-rc4/drivers/md/raid5.c
--- linux-2.6.34-rc3/drivers/md/raid5.c	2010-04-13 02:18:55.790570536 +0000
+++ linux-2.6.34-rc4/drivers/md/raid5.c	2010-04-13 02:19:00.951633031 +0000
@@ -50,6 +50,7 @@
 #include <linux/async.h>
 #include <linux/seq_file.h>
 #include <linux/cpu.h>
+#include <linux/slab.h>
 #include "md.h"
 #include "raid5.h"
 #include "bitmap.h"
diff -urN linux-2.6.34-rc3/drivers/md/raid6algos.c linux-2.6.34-rc4/drivers/md/raid6algos.c
--- linux-2.6.34-rc3/drivers/md/raid6algos.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/md/raid6algos.c	2010-04-13 02:19:00.952633046 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/raid/pq.h>
+#include <linux/gfp.h>
 #ifndef __KERNEL__
 #include <sys/mman.h>
 #include <stdio.h>
diff -urN linux-2.6.34-rc3/drivers/media/IR/ir-keytable.c linux-2.6.34-rc4/drivers/media/IR/ir-keytable.c
--- linux-2.6.34-rc3/drivers/media/IR/ir-keytable.c	2010-04-13 02:18:55.791633054 +0000
+++ linux-2.6.34-rc4/drivers/media/IR/ir-keytable.c	2010-04-13 02:19:00.952633046 +0000
@@ -14,6 +14,7 @@
 
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <media/ir-common.h>
 
 #define IR_TAB_MIN_SIZE	32
diff -urN linux-2.6.34-rc3/drivers/media/IR/ir-sysfs.c linux-2.6.34-rc4/drivers/media/IR/ir-sysfs.c
--- linux-2.6.34-rc3/drivers/media/IR/ir-sysfs.c	2010-04-13 02:18:55.791633054 +0000
+++ linux-2.6.34-rc4/drivers/media/IR/ir-sysfs.c	2010-04-13 02:19:00.953633033 +0000
@@ -12,6 +12,7 @@
  *  GNU General Public License for more details.
  */
 
+#include <linux/slab.h>
 #include <linux/input.h>
 #include <linux/device.h>
 #include <media/ir-core.h>
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/max2165.c linux-2.6.34-rc4/drivers/media/common/tuners/max2165.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/max2165.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/max2165.c	2010-04-13 02:19:00.953633033 +0000
@@ -25,6 +25,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/mc44s803.c linux-2.6.34-rc4/drivers/media/common/tuners/mc44s803.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/mc44s803.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/mc44s803.c	2010-04-13 02:19:00.953633033 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/mt2060.c linux-2.6.34-rc4/drivers/media/common/tuners/mt2060.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/mt2060.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/mt2060.c	2010-04-13 02:19:00.953633033 +0000
@@ -25,6 +25,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/mt20xx.c linux-2.6.34-rc4/drivers/media/common/tuners/mt20xx.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/mt20xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/mt20xx.c	2010-04-13 02:19:00.953633033 +0000
@@ -6,6 +6,7 @@
  */
 #include <linux/delay.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include "tuner-i2c.h"
 #include "mt20xx.h"
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/mt2131.c linux-2.6.34-rc4/drivers/media/common/tuners/mt2131.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/mt2131.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/mt2131.c	2010-04-13 02:19:00.953633033 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/mt2266.c linux-2.6.34-rc4/drivers/media/common/tuners/mt2266.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/mt2266.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/mt2266.c	2010-04-13 02:19:00.953633033 +0000
@@ -18,6 +18,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 #include "mt2266.h"
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tda827x.c linux-2.6.34-rc4/drivers/media/common/tuners/tda827x.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tda827x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tda827x.c	2010-04-13 02:19:00.954633012 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/types.h>
 #include <linux/dvb/frontend.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tda8290.c linux-2.6.34-rc4/drivers/media/common/tuners/tda8290.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tda8290.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tda8290.c	2010-04-13 02:19:00.954633012 +0000
@@ -21,6 +21,7 @@
 */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
 #include "tuner-i2c.h"
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tda9887.c linux-2.6.34-rc4/drivers/media/common/tuners/tda9887.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tda9887.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tda9887.c	2010-04-13 02:19:00.954633012 +0000
@@ -4,7 +4,6 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tea5761.c linux-2.6.34-rc4/drivers/media/common/tuners/tea5761.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tea5761.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tea5761.c	2010-04-13 02:19:00.954633012 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
 #include <media/tuner.h>
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tea5767.c linux-2.6.34-rc4/drivers/media/common/tuners/tea5767.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tea5767.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tea5767.c	2010-04-13 02:19:00.954633012 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
 #include "tuner-i2c.h"
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tuner-i2c.h linux-2.6.34-rc4/drivers/media/common/tuners/tuner-i2c.h
--- linux-2.6.34-rc3/drivers/media/common/tuners/tuner-i2c.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tuner-i2c.h	2010-04-13 02:19:00.954633012 +0000
@@ -22,6 +22,7 @@
 #define __TUNER_I2C_H__
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 struct tuner_i2c_props {
 	u8 addr;
diff -urN linux-2.6.34-rc3/drivers/media/common/tuners/tuner-xc2028.c linux-2.6.34-rc4/drivers/media/common/tuners/tuner-xc2028.c
--- linux-2.6.34-rc3/drivers/media/common/tuners/tuner-xc2028.c	2010-04-13 02:18:55.792633005 +0000
+++ linux-2.6.34-rc4/drivers/media/common/tuners/tuner-xc2028.c	2010-04-13 02:19:00.955633051 +0000
@@ -15,6 +15,7 @@
 #include <linux/delay.h>
 #include <media/tuner.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "tuner-i2c.h"
 #include "tuner-xc2028.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/bt8xx/dst_ca.c linux-2.6.34-rc4/drivers/media/dvb/bt8xx/dst_ca.c
--- linux-2.6.34-rc3/drivers/media/dvb/bt8xx/dst_ca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/bt8xx/dst_ca.c	2010-04-13 02:19:00.955633051 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/smp_lock.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/dm1105/dm1105.c linux-2.6.34-rc4/drivers/media/dvb/dm1105/dm1105.c
--- linux-2.6.34-rc3/drivers/media/dvb/dm1105/dm1105.c	2010-04-13 02:18:55.793633076 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/dm1105/dm1105.c	2010-04-13 02:19:00.956633039 +0000
@@ -27,6 +27,7 @@
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <media/ir-common.h>
 
 #include "demux.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/dvb-core/dmxdev.h linux-2.6.34-rc4/drivers/media/dvb/dvb-core/dmxdev.h
--- linux-2.6.34-rc3/drivers/media/dvb/dvb-core/dmxdev.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/dvb-core/dmxdev.h	2010-04-13 02:19:00.956633039 +0000
@@ -31,6 +31,7 @@
 #include <linux/fs.h>
 #include <linux/string.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <linux/dvb/dmx.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/dvb-core/dvb_frontend.h linux-2.6.34-rc4/drivers/media/dvb/dvb-core/dvb_frontend.h
--- linux-2.6.34-rc3/drivers/media/dvb/dvb-core/dvb_frontend.h	2010-04-13 02:18:55.794633072 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/dvb-core/dvb_frontend.h	2010-04-13 02:19:00.957633068 +0000
@@ -36,6 +36,7 @@
 #include <linux/errno.h>
 #include <linux/delay.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <linux/dvb/frontend.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/dvb-usb/af9015.c linux-2.6.34-rc4/drivers/media/dvb/dvb-usb/af9015.c
--- linux-2.6.34-rc3/drivers/media/dvb/dvb-usb/af9015.c	2010-04-13 02:18:55.795633053 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/dvb-usb/af9015.c	2010-04-13 02:19:00.958633044 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/hash.h>
+#include <linux/slab.h>
 
 #include "af9015.h"
 #include "af9013.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/dvb-usb/cxusb.c linux-2.6.34-rc4/drivers/media/dvb/dvb-usb/cxusb.c
--- linux-2.6.34-rc3/drivers/media/dvb/dvb-usb/cxusb.c	2010-04-13 02:18:55.796633034 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/dvb-usb/cxusb.c	2010-04-13 02:19:00.959633047 +0000
@@ -25,6 +25,7 @@
  */
 #include <media/tuner.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include "cxusb.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/firewire/firedtv-1394.c linux-2.6.34-rc4/drivers/media/dvb/firewire/firedtv-1394.c
--- linux-2.6.34-rc3/drivers/media/dvb/firewire/firedtv-1394.c	2010-04-13 02:18:55.798633071 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/firewire/firedtv-1394.c	2010-04-13 02:19:00.961633076 +0000
@@ -15,6 +15,7 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/types.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/firewire/firedtv-rc.c linux-2.6.34-rc4/drivers/media/dvb/firewire/firedtv-rc.c
--- linux-2.6.34-rc3/drivers/media/dvb/firewire/firedtv-rc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/firewire/firedtv-rc.c	2010-04-13 02:19:00.962633046 +0000
@@ -12,6 +12,7 @@
 #include <linux/bitops.h>
 #include <linux/input.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/types.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/au8522_dig.c linux-2.6.34-rc4/drivers/media/dvb/frontends/au8522_dig.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/au8522_dig.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/au8522_dig.c	2010-04-13 02:19:00.962633046 +0000
@@ -23,7 +23,6 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include "dvb_frontend.h"
 #include "au8522.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib0070.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib0070.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib0070.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib0070.c	2010-04-13 02:19:00.962633046 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib0090.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib0090.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib0090.c	2010-04-13 02:18:55.799571538 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib0090.c	2010-04-13 02:19:00.963633025 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib3000mc.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib3000mc.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib3000mc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib3000mc.c	2010-04-13 02:19:00.963633025 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib7000m.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib7000m.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib7000m.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib7000m.c	2010-04-13 02:19:00.963633025 +0000
@@ -9,6 +9,7 @@
  *	published by the Free Software Foundation, version 2.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib7000p.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib7000p.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib7000p.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib7000p.c	2010-04-13 02:19:00.963633025 +0000
@@ -8,6 +8,7 @@
  *	published by the Free Software Foundation, version 2.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 
 #include "dvb_math.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dib8000.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dib8000.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dib8000.c	2010-04-13 02:18:55.799571538 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dib8000.c	2010-04-13 02:19:00.964633058 +0000
@@ -8,6 +8,7 @@
  *  published by the Free Software Foundation, version 2.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include "dvb_math.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/drx397xD.c linux-2.6.34-rc4/drivers/media/dvb/frontends/drx397xD.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/drx397xD.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/drx397xD.c	2010-04-13 02:19:00.964633058 +0000
@@ -26,6 +26,7 @@
 #include <linux/delay.h>
 #include <linux/string.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <asm/div64.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/dvb-pll.c linux-2.6.34-rc4/drivers/media/dvb/frontends/dvb-pll.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/dvb-pll.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/dvb-pll.c	2010-04-13 02:19:00.964633058 +0000
@@ -18,6 +18,7 @@
  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/itd1000.c linux-2.6.34-rc4/drivers/media/dvb/frontends/itd1000.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/itd1000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/itd1000.c	2010-04-13 02:19:00.964633058 +0000
@@ -24,6 +24,7 @@
 #include <linux/delay.h>
 #include <linux/dvb/frontend.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/lgdt3304.c linux-2.6.34-rc4/drivers/media/dvb/frontends/lgdt3304.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/lgdt3304.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/lgdt3304.c	2010-04-13 02:19:00.964633058 +0000
@@ -7,6 +7,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "dvb_frontend.h"
 #include "lgdt3304.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/lgdt3305.c linux-2.6.34-rc4/drivers/media/dvb/frontends/lgdt3305.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/lgdt3305.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/lgdt3305.c	2010-04-13 02:19:00.964633058 +0000
@@ -21,6 +21,7 @@
 
 #include <asm/div64.h>
 #include <linux/dvb/frontend.h>
+#include <linux/slab.h>
 #include "dvb_math.h"
 #include "lgdt3305.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/mb86a16.c linux-2.6.34-rc4/drivers/media/dvb/frontends/mb86a16.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/mb86a16.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/mb86a16.c	2010-04-13 02:19:00.965633084 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 #include "mb86a16.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/s921_module.c linux-2.6.34-rc4/drivers/media/dvb/frontends/s921_module.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/s921_module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/s921_module.c	2010-04-13 02:19:00.965633084 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "dvb_frontend.h"
 #include "s921_module.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stb0899_drv.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stb0899_drv.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stb0899_drv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stb0899_drv.c	2010-04-13 02:19:00.965633084 +0000
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #include <linux/dvb/frontend.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stb6000.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stb6000.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stb6000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stb6000.c	2010-04-13 02:19:00.965633084 +0000
@@ -20,6 +20,7 @@
 
   */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stb6100.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stb6100.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stb6100.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stb6100.c	2010-04-13 02:19:00.965633084 +0000
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stv090x.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stv090x.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stv090x.c	2010-04-13 02:18:55.803570391 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stv090x.c	2010-04-13 02:19:00.968633075 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 
 #include <linux/dvb/frontend.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stv6110.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stv6110.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stv6110.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stv6110.c	2010-04-13 02:19:00.968633075 +0000
@@ -22,6 +22,7 @@
  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/stv6110x.c linux-2.6.34-rc4/drivers/media/dvb/frontends/stv6110x.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/stv6110x.c	2010-04-13 02:18:55.803570391 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/stv6110x.c	2010-04-13 02:19:00.969633062 +0000
@@ -23,6 +23,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #include "dvb_frontend.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/tda665x.c linux-2.6.34-rc4/drivers/media/dvb/frontends/tda665x.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/tda665x.c	2010-04-13 02:18:55.803570391 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/tda665x.c	2010-04-13 02:19:00.969633062 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 #include "tda665x.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/tda8261.c linux-2.6.34-rc4/drivers/media/dvb/frontends/tda8261.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/tda8261.c	2010-04-13 02:18:55.803570391 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/tda8261.c	2010-04-13 02:19:00.969633062 +0000
@@ -21,6 +21,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "dvb_frontend.h"
 #include "tda8261.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/tda826x.c linux-2.6.34-rc4/drivers/media/dvb/frontends/tda826x.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/tda826x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/tda826x.c	2010-04-13 02:19:00.969633062 +0000
@@ -20,6 +20,7 @@
 
   */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/tua6100.c linux-2.6.34-rc4/drivers/media/dvb/frontends/tua6100.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/tua6100.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/tua6100.c	2010-04-13 02:19:00.969633062 +0000
@@ -28,6 +28,7 @@
  * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/frontends/zl10036.c linux-2.6.34-rc4/drivers/media/dvb/frontends/zl10036.c
--- linux-2.6.34-rc3/drivers/media/dvb/frontends/zl10036.c	2010-04-13 02:18:55.804570495 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/frontends/zl10036.c	2010-04-13 02:19:00.969633062 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/module.h>
 #include <linux/dvb/frontend.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include "zl10036.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/mantis/hopper_cards.c linux-2.6.34-rc4/drivers/media/dvb/mantis/hopper_cards.c
--- linux-2.6.34-rc3/drivers/media/dvb/mantis/hopper_cards.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/mantis/hopper_cards.c	2010-04-13 02:19:00.970633053 +0000
@@ -22,6 +22,7 @@
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <asm/irq.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/mantis/mantis_ca.c linux-2.6.34-rc4/drivers/media/dvb/mantis/mantis_ca.c
--- linux-2.6.34-rc3/drivers/media/dvb/mantis/mantis_ca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/mantis/mantis_ca.c	2010-04-13 02:19:00.970633053 +0000
@@ -19,6 +19,7 @@
 */
 
 #include <linux/signal.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/mantis/mantis_cards.c linux-2.6.34-rc4/drivers/media/dvb/mantis/mantis_cards.c
--- linux-2.6.34-rc3/drivers/media/dvb/mantis/mantis_cards.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/mantis/mantis_cards.c	2010-04-13 02:19:00.970633053 +0000
@@ -22,6 +22,7 @@
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <asm/irq.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/ngene/ngene-core.c linux-2.6.34-rc4/drivers/media/dvb/ngene/ngene-core.c
--- linux-2.6.34-rc3/drivers/media/dvb/ngene/ngene-core.c	2010-04-13 02:18:55.805633040 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/ngene/ngene-core.c	2010-04-13 02:19:00.971633071 +0000
@@ -30,7 +30,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/poll.h>
 #include <linux/io.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/pluto2/pluto2.c linux-2.6.34-rc4/drivers/media/dvb/pluto2/pluto2.c
--- linux-2.6.34-rc3/drivers/media/dvb/pluto2/pluto2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/pluto2/pluto2.c	2010-04-13 02:19:00.972633032 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include "demux.h"
 #include "dmxdev.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/pt1/pt1.c linux-2.6.34-rc4/drivers/media/dvb/pt1/pt1.c
--- linux-2.6.34-rc3/drivers/media/dvb/pt1/pt1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/pt1/pt1.c	2010-04-13 02:19:00.972633032 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/pci.h>
 #include <linux/kthread.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/siano/smscoreapi.c linux-2.6.34-rc4/drivers/media/dvb/siano/smscoreapi.c
--- linux-2.6.34-rc3/drivers/media/dvb/siano/smscoreapi.c	2010-04-13 02:18:55.806633012 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/siano/smscoreapi.c	2010-04-13 02:19:00.972633032 +0000
@@ -28,6 +28,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/firmware.h>
 #include <linux/wait.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/siano/smsdvb.c linux-2.6.34-rc4/drivers/media/dvb/siano/smsdvb.c
--- linux-2.6.34-rc3/drivers/media/dvb/siano/smsdvb.c	2010-04-13 02:18:55.806633012 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/siano/smsdvb.c	2010-04-13 02:19:00.973633019 +0000
@@ -20,6 +20,7 @@
 ****************************************************************/
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #include "dmxdev.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/siano/smssdio.c linux-2.6.34-rc4/drivers/media/dvb/siano/smssdio.c
--- linux-2.6.34-rc3/drivers/media/dvb/siano/smssdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/siano/smssdio.c	2010-04-13 02:19:00.973633019 +0000
@@ -33,6 +33,7 @@
  */
 
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/delay.h>
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/media/dvb/siano/smsusb.c linux-2.6.34-rc4/drivers/media/dvb/siano/smsusb.c
--- linux-2.6.34-rc3/drivers/media/dvb/siano/smsusb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/siano/smsusb.c	2010-04-13 02:19:00.973633019 +0000
@@ -23,6 +23,7 @@
 #include <linux/init.h>
 #include <linux/usb.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include "smscoreapi.h"
 #include "sms-cards.h"
diff -urN linux-2.6.34-rc3/drivers/media/dvb/ttpci/av7110.c linux-2.6.34-rc4/drivers/media/dvb/ttpci/av7110.c
--- linux-2.6.34-rc3/drivers/media/dvb/ttpci/av7110.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/ttpci/av7110.c	2010-04-13 02:19:00.973633019 +0000
@@ -49,6 +49,7 @@
 #include <linux/crc32.h>
 #include <linux/i2c.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include <asm/byteorder.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/dvb/ttpci/av7110_ca.c linux-2.6.34-rc4/drivers/media/dvb/ttpci/av7110_ca.c
--- linux-2.6.34-rc3/drivers/media/dvb/ttpci/av7110_ca.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/dvb/ttpci/av7110_ca.c	2010-04-13 02:19:00.974633010 +0000
@@ -34,6 +34,7 @@
 #include <linux/fs.h>
 #include <linux/timer.h>
 #include <linux/poll.h>
+#include <linux/gfp.h>
 
 #include "av7110.h"
 #include "av7110_hw.h"
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-gemtek-pci.c linux-2.6.34-rc4/drivers/media/radio/radio-gemtek-pci.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-gemtek-pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-gemtek-pci.c	2010-04-13 02:19:00.974633010 +0000
@@ -48,6 +48,7 @@
 #include <linux/errno.h>
 #include <linux/version.h>      /* for KERNEL_VERSION MACRO     */
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-maestro.c linux-2.6.34-rc4/drivers/media/radio/radio-maestro.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-maestro.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-maestro.c	2010-04-13 02:19:00.975633037 +0000
@@ -26,6 +26,7 @@
 #include <linux/pci.h>
 #include <linux/videodev2.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-maxiradio.c linux-2.6.34-rc4/drivers/media/radio/radio-maxiradio.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-maxiradio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-maxiradio.c	2010-04-13 02:19:00.975633037 +0000
@@ -42,6 +42,7 @@
 #include <linux/videodev2.h>
 #include <linux/version.h>      /* for KERNEL_VERSION MACRO     */
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-si4713.c linux-2.6.34-rc4/drivers/media/radio/radio-si4713.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-si4713.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-si4713.c	2010-04-13 02:19:00.975633037 +0000
@@ -27,6 +27,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-tea5764.c linux-2.6.34-rc4/drivers/media/radio/radio-tea5764.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-tea5764.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-tea5764.c	2010-04-13 02:19:00.975633037 +0000
@@ -32,6 +32,7 @@
  *  add RDS support
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/init.h>			/* Initdata			*/
 #include <linux/videodev2.h>		/* kernel radio structs		*/
diff -urN linux-2.6.34-rc3/drivers/media/radio/radio-timb.c linux-2.6.34-rc4/drivers/media/radio/radio-timb.c
--- linux-2.6.34-rc3/drivers/media/radio/radio-timb.c	2010-04-13 02:18:55.807633077 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/radio-timb.c	2010-04-13 02:19:00.975633037 +0000
@@ -22,6 +22,7 @@
 #include <media/v4l2-device.h>
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <media/timb_radio.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/saa7706h.c linux-2.6.34-rc4/drivers/media/radio/saa7706h.c
--- linux-2.6.34-rc3/drivers/media/radio/saa7706h.c	2010-04-13 02:18:55.807633077 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/saa7706h.c	2010-04-13 02:19:00.975633037 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/si470x/radio-si470x-i2c.c linux-2.6.34-rc4/drivers/media/radio/si470x/radio-si470x-i2c.c
--- linux-2.6.34-rc3/drivers/media/radio/si470x/radio-si470x-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/si470x/radio-si470x-i2c.c	2010-04-13 02:19:00.976633205 +0000
@@ -31,6 +31,7 @@
 
 /* kernel includes */
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/si470x/radio-si470x-usb.c linux-2.6.34-rc4/drivers/media/radio/si470x/radio-si470x-usb.c
--- linux-2.6.34-rc3/drivers/media/radio/si470x/radio-si470x-usb.c	2010-04-13 02:18:55.808633043 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/si470x/radio-si470x-usb.c	2010-04-13 02:19:00.976633205 +0000
@@ -37,6 +37,7 @@
 /* kernel includes */
 #include <linux/usb.h>
 #include <linux/hid.h>
+#include <linux/slab.h>
 
 #include "radio-si470x.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/radio/si4713-i2c.c linux-2.6.34-rc4/drivers/media/radio/si4713-i2c.c
--- linux-2.6.34-rc3/drivers/media/radio/si4713-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/si4713-i2c.c	2010-04-13 02:19:00.976633205 +0000
@@ -26,6 +26,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/radio/tef6862.c linux-2.6.34-rc4/drivers/media/radio/tef6862.c
--- linux-2.6.34-rc3/drivers/media/radio/tef6862.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/radio/tef6862.c	2010-04-13 02:19:00.976633205 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
 #include <linux/i2c-id.h>
+#include <linux/slab.h>
 #include <media/v4l2-ioctl.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/adv7170.c linux-2.6.34-rc4/drivers/media/video/adv7170.c
--- linux-2.6.34-rc3/drivers/media/video/adv7170.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/adv7170.c	2010-04-13 02:19:00.977633102 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/adv7175.c linux-2.6.34-rc4/drivers/media/video/adv7175.c
--- linux-2.6.34-rc3/drivers/media/video/adv7175.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/adv7175.c	2010-04-13 02:19:00.977633102 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/adv7180.c linux-2.6.34-rc4/drivers/media/video/adv7180.c
--- linux-2.6.34-rc3/drivers/media/video/adv7180.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/adv7180.c	2010-04-13 02:19:00.977633102 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
 #include <linux/i2c-id.h>
+#include <linux/slab.h>
 #include <media/v4l2-ioctl.h>
 #include <linux/videodev2.h>
 #include <media/v4l2-device.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/adv7343.c linux-2.6.34-rc4/drivers/media/video/adv7343.c
--- linux-2.6.34-rc3/drivers/media/video/adv7343.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/adv7343.c	2010-04-13 02:19:00.977633102 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/device.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/au0828/au0828-core.c linux-2.6.34-rc4/drivers/media/video/au0828/au0828-core.c
--- linux-2.6.34-rc3/drivers/media/video/au0828/au0828-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/au0828/au0828-core.c	2010-04-13 02:19:00.977633102 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/au0828/au0828-dvb.c linux-2.6.34-rc4/drivers/media/video/au0828/au0828-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/au0828/au0828-dvb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/au0828/au0828-dvb.c	2010-04-13 02:19:00.977633102 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/device.h>
 #include <linux/suspend.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/au0828/au0828-video.c linux-2.6.34-rc4/drivers/media/video/au0828/au0828-video.c
--- linux-2.6.34-rc3/drivers/media/video/au0828/au0828-video.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/au0828/au0828-video.c	2010-04-13 02:19:00.977633102 +0000
@@ -29,6 +29,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/device.h>
 #include <linux/suspend.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/bt819.c linux-2.6.34-rc4/drivers/media/video/bt819.c
--- linux-2.6.34-rc3/drivers/media/video/bt819.c	2010-04-13 02:18:55.808633043 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt819.c	2010-04-13 02:19:00.978633093 +0000
@@ -35,6 +35,7 @@
 #include <linux/i2c.h>
 #include <linux/i2c-id.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/bt856.c linux-2.6.34-rc4/drivers/media/video/bt856.c
--- linux-2.6.34-rc3/drivers/media/video/bt856.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt856.c	2010-04-13 02:19:00.978633093 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/bt866.c linux-2.6.34-rc4/drivers/media/video/bt866.c
--- linux-2.6.34-rc3/drivers/media/video/bt866.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt866.c	2010-04-13 02:19:00.978633093 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-driver.c linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-driver.c
--- linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-driver.c	2010-04-13 02:18:55.809571537 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-driver.c	2010-04-13 02:19:00.979633054 +0000
@@ -37,6 +37,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/fs.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-gpio.c linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-gpio.c
--- linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-gpio.c	2010-04-13 02:19:00.979633054 +0000
@@ -30,6 +30,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include "bttvp.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-input.c linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-input.c
--- linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-input.c	2010-04-13 02:18:55.810570486 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-input.c	2010-04-13 02:19:00.979633054 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include "bttv.h"
 #include "bttvp.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-risc.c linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-risc.c
--- linux-2.6.34-rc3/drivers/media/video/bt8xx/bttv-risc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/bt8xx/bttv-risc.c	2010-04-13 02:19:00.979633054 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/vmalloc.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cafe_ccic.c linux-2.6.34-rc4/drivers/media/video/cafe_ccic.c
--- linux-2.6.34-rc3/drivers/media/video/cafe_ccic.c	2010-04-13 02:18:55.810570486 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cafe_ccic.c	2010-04-13 02:19:00.980633047 +0000
@@ -31,6 +31,7 @@
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cpia_pp.c linux-2.6.34-rc4/drivers/media/video/cpia_pp.c
--- linux-2.6.34-rc3/drivers/media/video/cpia_pp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cpia_pp.c	2010-04-13 02:19:00.980633047 +0000
@@ -35,6 +35,7 @@
 #include <linux/delay.h>
 #include <linux/workqueue.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <linux/kmod.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/cs5345.c linux-2.6.34-rc4/drivers/media/video/cs5345.c
--- linux-2.6.34-rc3/drivers/media/video/cs5345.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cs5345.c	2010-04-13 02:19:00.980633047 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cs53l32a.c linux-2.6.34-rc4/drivers/media/video/cs53l32a.c
--- linux-2.6.34-rc3/drivers/media/video/cs53l32a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cs53l32a.c	2010-04-13 02:19:00.981633065 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx18/cx18-alsa-main.c linux-2.6.34-rc4/drivers/media/video/cx18/cx18-alsa-main.c
--- linux-2.6.34-rc3/drivers/media/video/cx18/cx18-alsa-main.c	2010-04-13 02:18:55.811570452 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx18/cx18-alsa-main.c	2010-04-13 02:19:00.981633065 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx18/cx18-controls.c linux-2.6.34-rc4/drivers/media/video/cx18/cx18-controls.c
--- linux-2.6.34-rc3/drivers/media/video/cx18/cx18-controls.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx18/cx18-controls.c	2010-04-13 02:19:00.982633023 +0000
@@ -21,6 +21,7 @@
  *  02111-1307  USA
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "cx18-driver.h"
 #include "cx18-cards.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/cx18/cx18-driver.h linux-2.6.34-rc4/drivers/media/video/cx18/cx18-driver.h
--- linux-2.6.34-rc3/drivers/media/video/cx18/cx18-driver.h	2010-04-13 02:18:55.812633045 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx18/cx18-driver.h	2010-04-13 02:19:00.982633023 +0000
@@ -42,6 +42,7 @@
 #include <linux/pagemap.h>
 #include <linux/workqueue.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 
 #include <linux/dvb/video.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-cards.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-cards.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-cards.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-cards.c	2010-04-13 02:19:00.984633061 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/i2c.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-core.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-core.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-core.c	2010-04-13 02:19:00.984633061 +0000
@@ -23,6 +23,7 @@
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/vmalloc.h>
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-dvb.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-dvb.c	2010-04-13 02:18:55.813633047 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-dvb.c	2010-04-13 02:19:00.984633061 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "cx231xx.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-input.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-input.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-input.c	2010-04-13 02:18:55.814633106 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-input.c	2010-04-13 02:19:00.984633061 +0000
@@ -27,6 +27,7 @@
 #include <linux/interrupt.h>
 #include <linux/input.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "cx231xx.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-vbi.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-vbi.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-vbi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-vbi.c	2010-04-13 02:19:00.984633061 +0000
@@ -28,6 +28,7 @@
 #include <linux/i2c.h>
 #include <linux/mm.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-video.c linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-video.c
--- linux-2.6.34-rc3/drivers/media/video/cx231xx/cx231xx-video.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx231xx/cx231xx-video.c	2010-04-13 02:19:00.985633115 +0000
@@ -32,6 +32,7 @@
 #include <linux/version.h>
 #include <linux/mm.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-417.c linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-417.c
--- linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-417.c	2010-04-13 02:18:55.814633106 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-417.c	2010-04-13 02:19:00.985633115 +0000
@@ -32,6 +32,7 @@
 #include <linux/device.h>
 #include <linux/firmware.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
 #include <media/cx2341x.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-input.c linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-input.c
--- linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-input.c	2010-04-13 02:18:55.814633106 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-input.c	2010-04-13 02:19:00.986633010 +0000
@@ -36,6 +36,7 @@
  */
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <media/ir-common.h>
 #include <media/v4l2-subdev.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-vbi.c linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-vbi.c
--- linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885-vbi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885-vbi.c	2010-04-13 02:19:00.986633010 +0000
@@ -23,7 +23,6 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 
 #include "cx23885.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885.h linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885.h
--- linux-2.6.34-rc3/drivers/media/video/cx23885/cx23885.h	2010-04-13 02:18:55.815633000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx23885/cx23885.h	2010-04-13 02:19:00.986633010 +0000
@@ -23,6 +23,7 @@
 #include <linux/i2c.h>
 #include <linux/i2c-algo-bit.h>
 #include <linux/kdev_t.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-device.h>
 #include <media/tuner.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx23885/cx23888-ir.c linux-2.6.34-rc4/drivers/media/video/cx23885/cx23888-ir.c
--- linux-2.6.34-rc3/drivers/media/video/cx23885/cx23888-ir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx23885/cx23888-ir.c	2010-04-13 02:19:00.986633010 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/kfifo.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-alsa.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-alsa.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-alsa.c	2010-04-13 02:18:55.815633000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-alsa.c	2010-04-13 02:19:00.987633049 +0000
@@ -31,6 +31,7 @@
 #include <linux/vmalloc.h>
 #include <linux/dma-mapping.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-blackbird.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-blackbird.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-blackbird.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-blackbird.c	2010-04-13 02:19:00.987633049 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/delay.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-cards.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-cards.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-cards.c	2010-04-13 02:18:55.816633038 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-cards.c	2010-04-13 02:19:00.987633049 +0000
@@ -24,6 +24,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "cx88.h"
 #include "tea5767.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-dsp.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-dsp.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-dsp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-dsp.c	2010-04-13 02:19:00.988571522 +0000
@@ -19,6 +19,7 @@
  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/jiffies.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-input.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-input.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-input.c	2010-04-13 02:18:55.816633038 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-input.c	2010-04-13 02:19:00.988571522 +0000
@@ -26,6 +26,7 @@
 #include <linux/hrtimer.h>
 #include <linux/input.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "cx88.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-mpeg.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-mpeg.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-mpeg.c	2010-04-13 02:18:55.816633038 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-mpeg.c	2010-04-13 02:19:00.988571522 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-tvaudio.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-tvaudio.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-tvaudio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-tvaudio.c	2010-04-13 02:19:00.988571522 +0000
@@ -39,7 +39,6 @@
 #include <linux/errno.h>
 #include <linux/freezer.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/poll.h>
 #include <linux/signal.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-vbi.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-vbi.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-vbi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-vbi.c	2010-04-13 02:19:00.988571522 +0000
@@ -3,7 +3,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 
 #include "cx88.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/cx88/cx88-vp3054-i2c.c linux-2.6.34-rc4/drivers/media/video/cx88/cx88-vp3054-i2c.c
--- linux-2.6.34-rc3/drivers/media/video/cx88/cx88-vp3054-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/cx88/cx88-vp3054-i2c.c	2010-04-13 02:19:00.988571522 +0000
@@ -23,6 +23,7 @@
 */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/davinci/dm644x_ccdc.c linux-2.6.34-rc4/drivers/media/video/davinci/dm644x_ccdc.c
--- linux-2.6.34-rc3/drivers/media/video/davinci/dm644x_ccdc.c	2010-04-13 02:18:55.818633057 +0000
+++ linux-2.6.34-rc4/drivers/media/video/davinci/dm644x_ccdc.c	2010-04-13 02:19:00.990633003 +0000
@@ -37,6 +37,7 @@
 #include <linux/platform_device.h>
 #include <linux/uaccess.h>
 #include <linux/videodev2.h>
+#include <linux/gfp.h>
 #include <linux/clk.h>
 #include <linux/err.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/davinci/vpfe_capture.c linux-2.6.34-rc4/drivers/media/video/davinci/vpfe_capture.c
--- linux-2.6.34-rc3/drivers/media/video/davinci/vpfe_capture.c	2010-04-13 02:18:55.819571329 +0000
+++ linux-2.6.34-rc4/drivers/media/video/davinci/vpfe_capture.c	2010-04-13 02:19:00.991633039 +0000
@@ -67,6 +67,7 @@
  *		- Support for control ioctls
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/davinci/vpif_capture.c linux-2.6.34-rc4/drivers/media/video/davinci/vpif_capture.c
--- linux-2.6.34-rc3/drivers/media/video/davinci/vpif_capture.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/davinci/vpif_capture.c	2010-04-13 02:19:00.991633039 +0000
@@ -34,6 +34,7 @@
 #include <linux/platform_device.h>
 #include <linux/io.h>
 #include <linux/version.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-ioctl.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/davinci/vpif_display.c linux-2.6.34-rc4/drivers/media/video/davinci/vpif_display.c
--- linux-2.6.34-rc3/drivers/media/video/davinci/vpif_display.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/davinci/vpif_display.c	2010-04-13 02:19:00.992633020 +0000
@@ -30,6 +30,7 @@
 #include <linux/platform_device.h>
 #include <linux/io.h>
 #include <linux/version.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-cards.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-cards.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-cards.c	2010-04-13 02:18:55.820570416 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-cards.c	2010-04-13 02:19:00.992633020 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/i2c.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-core.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-core.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-core.c	2010-04-13 02:18:55.820570416 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-core.c	2010-04-13 02:19:00.993633077 +0000
@@ -24,6 +24,7 @@
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/vmalloc.h>
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-dvb.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-dvb.c	2010-04-13 02:18:55.820570416 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-dvb.c	2010-04-13 02:19:00.993633077 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "em28xx.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-input.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-input.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-input.c	2010-04-13 02:18:55.820570416 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-input.c	2010-04-13 02:19:00.993633077 +0000
@@ -27,6 +27,7 @@
 #include <linux/interrupt.h>
 #include <linux/input.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "em28xx.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-vbi.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-vbi.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-vbi.c	2010-04-13 02:18:55.820570416 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-vbi.c	2010-04-13 02:19:00.993633077 +0000
@@ -24,7 +24,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 
 #include "em28xx.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-video.c linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-video.c
--- linux-2.6.34-rc3/drivers/media/video/em28xx/em28xx-video.c	2010-04-13 02:18:55.821633072 +0000
+++ linux-2.6.34-rc4/drivers/media/video/em28xx/em28xx-video.c	2010-04-13 02:19:00.994633035 +0000
@@ -35,6 +35,7 @@
 #include <linux/version.h>
 #include <linux/mm.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include "em28xx.h"
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/gspca.h linux-2.6.34-rc4/drivers/media/video/gspca/gspca.h
--- linux-2.6.34-rc3/drivers/media/video/gspca/gspca.h	2010-04-13 02:18:55.824633094 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/gspca.h	2010-04-13 02:19:00.997633253 +0000
@@ -7,6 +7,7 @@
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 /* compilation option */
 #define GSPCA_DEBUG 1
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/jeilinj.c linux-2.6.34-rc4/drivers/media/video/gspca/jeilinj.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/jeilinj.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/jeilinj.c	2010-04-13 02:19:00.997633253 +0000
@@ -24,6 +24,7 @@
 #define MODULE_NAME "jeilinj"
 
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include "gspca.h"
 #include "jpeg.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/m5602/m5602_s5k83a.c linux-2.6.34-rc4/drivers/media/video/gspca/m5602/m5602_s5k83a.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/m5602/m5602_s5k83a.c	2010-04-13 02:18:55.825633072 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/m5602/m5602_s5k83a.c	2010-04-13 02:19:00.998629101 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include "m5602_s5k83a.h"
 
 static int s5k83a_set_gain(struct gspca_dev *gspca_dev, __s32 val);
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/sn9c20x.c linux-2.6.34-rc4/drivers/media/video/gspca/sn9c20x.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/sn9c20x.c	2010-04-13 02:18:55.830570443 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/sn9c20x.c	2010-04-13 02:19:01.003633039 +0000
@@ -23,6 +23,7 @@
 #include <linux/freezer.h>
 #include <linux/usb/input.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #endif
 
 #include "gspca.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/sonixj.c linux-2.6.34-rc4/drivers/media/video/gspca/sonixj.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/sonixj.c	2010-04-13 02:18:55.831633006 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/sonixj.c	2010-04-13 02:19:01.004633062 +0000
@@ -22,6 +22,7 @@
 #define MODULE_NAME "sonixj"
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include "gspca.h"
 #include "jpeg.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/sq905.c linux-2.6.34-rc4/drivers/media/video/gspca/sq905.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/sq905.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/sq905.c	2010-04-13 02:19:01.005633077 +0000
@@ -36,6 +36,7 @@
 #define MODULE_NAME "sq905"
 
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include "gspca.h"
 
 MODULE_AUTHOR("Adam Baker <linux@baker-net.org.uk>, "
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/sq905c.c linux-2.6.34-rc4/drivers/media/video/gspca/sq905c.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/sq905c.c	2010-04-13 02:18:55.832633020 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/sq905c.c	2010-04-13 02:19:01.005633077 +0000
@@ -30,6 +30,7 @@
 #define MODULE_NAME "sq905c"
 
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include "gspca.h"
 
 MODULE_AUTHOR("Theodore Kilgore <kilgota@auburn.edu>");
diff -urN linux-2.6.34-rc3/drivers/media/video/gspca/zc3xx.c linux-2.6.34-rc4/drivers/media/video/gspca/zc3xx.c
--- linux-2.6.34-rc3/drivers/media/video/gspca/zc3xx.c	2010-04-13 02:18:55.836633061 +0000
+++ linux-2.6.34-rc4/drivers/media/video/gspca/zc3xx.c	2010-04-13 02:19:01.010633073 +0000
@@ -22,6 +22,7 @@
 #define MODULE_NAME "zc3xx"
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include "gspca.h"
 #include "jpeg.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/hdpvr/hdpvr-i2c.c linux-2.6.34-rc4/drivers/media/video/hdpvr/hdpvr-i2c.c
--- linux-2.6.34-rc3/drivers/media/video/hdpvr/hdpvr-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/hdpvr/hdpvr-i2c.c	2010-04-13 02:19:01.010633073 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 
 #include "hdpvr.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/ivtv/ivtv-controls.c linux-2.6.34-rc4/drivers/media/video/ivtv/ivtv-controls.c
--- linux-2.6.34-rc3/drivers/media/video/ivtv/ivtv-controls.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ivtv/ivtv-controls.c	2010-04-13 02:19:01.011633054 +0000
@@ -18,6 +18,7 @@
     Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "ivtv-driver.h"
 #include "ivtv-cards.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/ivtv/ivtv-driver.h linux-2.6.34-rc4/drivers/media/video/ivtv/ivtv-driver.h
--- linux-2.6.34-rc3/drivers/media/video/ivtv/ivtv-driver.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ivtv/ivtv-driver.h	2010-04-13 02:19:01.011633054 +0000
@@ -53,6 +53,7 @@
 #include <linux/scatterlist.h>
 #include <linux/workqueue.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
 #include <asm/byteorder.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/ivtv/ivtvfb.c linux-2.6.34-rc4/drivers/media/video/ivtv/ivtvfb.c
--- linux-2.6.34-rc3/drivers/media/video/ivtv/ivtvfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ivtv/ivtvfb.c	2010-04-13 02:19:01.012633051 +0000
@@ -42,6 +42,7 @@
 #include <linux/kernel.h>
 #include <linux/fb.h>
 #include <linux/ivtvfb.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_MTRR
 #include <asm/mtrr.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/ks0127.c linux-2.6.34-rc4/drivers/media/video/ks0127.c
--- linux-2.6.34-rc3/drivers/media/video/ks0127.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ks0127.c	2010-04-13 02:19:01.012633051 +0000
@@ -40,6 +40,7 @@
 #include <linux/kernel.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/m52790.c linux-2.6.34-rc4/drivers/media/video/m52790.c
--- linux-2.6.34-rc3/drivers/media/video/m52790.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/m52790.c	2010-04-13 02:19:01.013633069 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/meye.c linux-2.6.34-rc4/drivers/media/video/meye.c
--- linux-2.6.34-rc3/drivers/media/video/meye.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/meye.c	2010-04-13 02:19:01.013633069 +0000
@@ -31,6 +31,7 @@
 #include <linux/sched.h>
 #include <linux/init.h>
 #include <linux/videodev.h>
+#include <linux/gfp.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/msp3400-kthreads.c linux-2.6.34-rc4/drivers/media/video/msp3400-kthreads.c
--- linux-2.6.34-rc3/drivers/media/video/msp3400-kthreads.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/msp3400-kthreads.c	2010-04-13 02:19:01.013633069 +0000
@@ -22,7 +22,6 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/freezer.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/mt9v011.c linux-2.6.34-rc4/drivers/media/video/mt9v011.c
--- linux-2.6.34-rc3/drivers/media/video/mt9v011.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/mt9v011.c	2010-04-13 02:19:01.013633069 +0000
@@ -6,6 +6,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <linux/delay.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/mx1_camera.c linux-2.6.34-rc4/drivers/media/video/mx1_camera.c
--- linux-2.6.34-rc3/drivers/media/video/mx1_camera.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/mx1_camera.c	2010-04-13 02:19:01.013633069 +0000
@@ -29,6 +29,7 @@
 #include <linux/mutex.h>
 #include <linux/platform_device.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/version.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/omap24xxcam.c linux-2.6.34-rc4/drivers/media/video/omap24xxcam.c
--- linux-2.6.34-rc3/drivers/media/video/omap24xxcam.c	2010-04-13 02:18:55.839571385 +0000
+++ linux-2.6.34-rc4/drivers/media/video/omap24xxcam.c	2010-04-13 02:19:01.014633015 +0000
@@ -35,6 +35,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/ov7670.c linux-2.6.34-rc4/drivers/media/video/ov7670.c
--- linux-2.6.34-rc3/drivers/media/video/ov7670.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ov7670.c	2010-04-13 02:19:01.014633015 +0000
@@ -12,6 +12,7 @@
  */
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/pms.c linux-2.6.34-rc4/drivers/media/video/pms.c
--- linux-2.6.34-rc3/drivers/media/video/pms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pms.c	2010-04-13 02:19:01.015633053 +0000
@@ -25,7 +25,6 @@
 #include <linux/errno.h>
 #include <linux/fs.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-cs53l32a.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-cs53l32a.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-cs53l32a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-cs53l32a.c	2010-04-13 02:19:01.015633053 +0000
@@ -34,7 +34,6 @@
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 
 struct routing_scheme {
 	const int *def;
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-cx2584x-v4l.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-cx2584x-v4l.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-cx2584x-v4l.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-cx2584x-v4l.c	2010-04-13 02:19:01.015633053 +0000
@@ -36,7 +36,6 @@
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 
 
 struct routing_scheme_item {
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-debugifc.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-debugifc.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-debugifc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-debugifc.c	2010-04-13 02:19:01.015633053 +0000
@@ -19,7 +19,6 @@
  */
 
 #include <linux/string.h>
-#include <linux/slab.h>
 #include "pvrusb2-debugifc.h"
 #include "pvrusb2-hdw.h"
 #include "pvrusb2-debug.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-dvb.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-dvb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-dvb.c	2010-04-13 02:19:01.015633053 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/kthread.h>
 #include <linux/freezer.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include "dvbdev.h"
 #include "pvrusb2-debug.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-eeprom.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-eeprom.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-eeprom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-eeprom.c	2010-04-13 02:19:01.015633053 +0000
@@ -19,6 +19,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include "pvrusb2-eeprom.h"
 #include "pvrusb2-hdw-internal.h"
 #include "pvrusb2-debug.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-main.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-main.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-main.c	2010-04-13 02:19:01.016633098 +0000
@@ -21,7 +21,6 @@
 
 #include <linux/kernel.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/usb.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-sysfs.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-sysfs.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-sysfs.c	2010-04-13 02:19:01.016633098 +0000
@@ -423,10 +423,12 @@
 
 	dip = kzalloc(sizeof(*dip),GFP_KERNEL);
 	if (!dip) return;
+	sysfs_attr_init(&dip->attr_debugcmd.attr);
 	dip->attr_debugcmd.attr.name = "debugcmd";
 	dip->attr_debugcmd.attr.mode = S_IRUGO|S_IWUSR|S_IWGRP;
 	dip->attr_debugcmd.show = debugcmd_show;
 	dip->attr_debugcmd.store = debugcmd_store;
+	sysfs_attr_init(&dip->attr_debuginfo.attr);
 	dip->attr_debuginfo.attr.name = "debuginfo";
 	dip->attr_debuginfo.attr.mode = S_IRUGO;
 	dip->attr_debuginfo.show = debuginfo_show;
@@ -644,6 +646,7 @@
 		return;
 	}
 
+	sysfs_attr_init(&sfp->attr_v4l_minor_number.attr);
 	sfp->attr_v4l_minor_number.attr.name = "v4l_minor_number";
 	sfp->attr_v4l_minor_number.attr.mode = S_IRUGO;
 	sfp->attr_v4l_minor_number.show = v4l_minor_number_show;
@@ -658,6 +661,7 @@
 		sfp->v4l_minor_number_created_ok = !0;
 	}
 
+	sysfs_attr_init(&sfp->attr_v4l_radio_minor_number.attr);
 	sfp->attr_v4l_radio_minor_number.attr.name = "v4l_radio_minor_number";
 	sfp->attr_v4l_radio_minor_number.attr.mode = S_IRUGO;
 	sfp->attr_v4l_radio_minor_number.show = v4l_radio_minor_number_show;
@@ -672,6 +676,7 @@
 		sfp->v4l_radio_minor_number_created_ok = !0;
 	}
 
+	sysfs_attr_init(&sfp->attr_unit_number.attr);
 	sfp->attr_unit_number.attr.name = "unit_number";
 	sfp->attr_unit_number.attr.mode = S_IRUGO;
 	sfp->attr_unit_number.show = unit_number_show;
@@ -685,6 +690,7 @@
 		sfp->unit_number_created_ok = !0;
 	}
 
+	sysfs_attr_init(&sfp->attr_bus_info.attr);
 	sfp->attr_bus_info.attr.name = "bus_info_str";
 	sfp->attr_bus_info.attr.mode = S_IRUGO;
 	sfp->attr_bus_info.show = bus_info_show;
@@ -699,6 +705,7 @@
 		sfp->bus_info_created_ok = !0;
 	}
 
+	sysfs_attr_init(&sfp->attr_hdw_name.attr);
 	sfp->attr_hdw_name.attr.name = "device_hardware_type";
 	sfp->attr_hdw_name.attr.mode = S_IRUGO;
 	sfp->attr_hdw_name.show = hdw_name_show;
@@ -713,6 +720,7 @@
 		sfp->hdw_name_created_ok = !0;
 	}
 
+	sysfs_attr_init(&sfp->attr_hdw_desc.attr);
 	sfp->attr_hdw_desc.attr.name = "device_hardware_description";
 	sfp->attr_hdw_desc.attr.mode = S_IRUGO;
 	sfp->attr_hdw_desc.show = hdw_desc_show;
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-v4l2.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-v4l2.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-v4l2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-v4l2.c	2010-04-13 02:19:01.016633098 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include "pvrusb2-context.h"
 #include "pvrusb2-hdw.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-video-v4l.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-video-v4l.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-video-v4l.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-video-v4l.c	2010-04-13 02:19:01.017633062 +0000
@@ -37,7 +37,6 @@
 #include <media/v4l2-common.h>
 #include <media/saa7115.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 
 struct routing_scheme {
 	const int *def;
diff -urN linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-wm8775.c linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-wm8775.c
--- linux-2.6.34-rc3/drivers/media/video/pvrusb2/pvrusb2-wm8775.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pvrusb2/pvrusb2-wm8775.c	2010-04-13 02:19:01.017633062 +0000
@@ -34,7 +34,6 @@
 #include <linux/videodev2.h>
 #include <media/v4l2-common.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 
 void pvr2_wm8775_subdev_update(struct pvr2_hdw *hdw, struct v4l2_subdev *sd)
 {
diff -urN linux-2.6.34-rc3/drivers/media/video/pwc/pwc-dec23.c linux-2.6.34-rc4/drivers/media/video/pwc/pwc-dec23.c
--- linux-2.6.34-rc3/drivers/media/video/pwc/pwc-dec23.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pwc/pwc-dec23.c	2010-04-13 02:19:01.017633062 +0000
@@ -30,6 +30,7 @@
 #include <media/pwc-ioctl.h>
 
 #include <linux/string.h>
+#include <linux/slab.h>
 
 /*
  * USE_LOOKUP_TABLE_TO_CLAMP
diff -urN linux-2.6.34-rc3/drivers/media/video/pwc/pwc-v4l.c linux-2.6.34-rc4/drivers/media/video/pwc/pwc-v4l.c
--- linux-2.6.34-rc3/drivers/media/video/pwc/pwc-v4l.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pwc/pwc-v4l.c	2010-04-13 02:19:01.017633062 +0000
@@ -30,7 +30,6 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/poll.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/pwc/pwc.h linux-2.6.34-rc4/drivers/media/video/pwc/pwc.h
--- linux-2.6.34-rc3/drivers/media/video/pwc/pwc.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pwc/pwc.h	2010-04-13 02:19:01.017633062 +0000
@@ -32,6 +32,7 @@
 #include <linux/version.h>
 #include <linux/mutex.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <asm/errno.h>
 #include <linux/videodev.h>
 #include <media/v4l2-common.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/pxa_camera.c linux-2.6.34-rc4/drivers/media/video/pxa_camera.c
--- linux-2.6.34-rc3/drivers/media/video/pxa_camera.c	2010-04-13 02:18:55.840570475 +0000
+++ linux-2.6.34-rc4/drivers/media/video/pxa_camera.c	2010-04-13 02:19:01.017633062 +0000
@@ -27,6 +27,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-common.h>
 #include <media/v4l2-dev.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/s2255drv.c linux-2.6.34-rc4/drivers/media/video/s2255drv.c
--- linux-2.6.34-rc3/drivers/media/video/s2255drv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/s2255drv.c	2010-04-13 02:19:01.018633083 +0000
@@ -45,6 +45,7 @@
 #include <linux/firmware.h>
 #include <linux/kernel.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <linux/version.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa5246a.c linux-2.6.34-rc4/drivers/media/video/saa5246a.c
--- linux-2.6.34-rc3/drivers/media/video/saa5246a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa5246a.c	2010-04-13 02:19:01.018633083 +0000
@@ -43,6 +43,7 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/videotext.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa5249.c linux-2.6.34-rc4/drivers/media/video/saa5249.c
--- linux-2.6.34-rc3/drivers/media/video/saa5249.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa5249.c	2010-04-13 02:19:01.018633083 +0000
@@ -50,6 +50,7 @@
 #include <linux/delay.h>
 #include <linux/videotext.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-dvb.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-dvb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-dvb.c	2010-04-13 02:19:01.020633061 +0000
@@ -24,7 +24,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/kthread.h>
 #include <linux/suspend.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-empress.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-empress.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-empress.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-empress.c	2010-04-13 02:19:01.020633061 +0000
@@ -21,7 +21,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-i2c.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-i2c.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-i2c.c	2010-04-13 02:19:01.020633061 +0000
@@ -24,7 +24,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "saa7134-reg.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-input.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-input.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-input.c	2010-04-13 02:18:55.842633072 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-input.c	2010-04-13 02:19:01.020633061 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include "saa7134-reg.h"
 #include "saa7134.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-ts.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-ts.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-ts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-ts.c	2010-04-13 02:19:01.021633088 +0000
@@ -24,7 +24,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "saa7134-reg.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-tvaudio.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-tvaudio.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-tvaudio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-tvaudio.c	2010-04-13 02:19:01.021633088 +0000
@@ -25,7 +25,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/kthread.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/freezer.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-vbi.c linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-vbi.c
--- linux-2.6.34-rc3/drivers/media/video/saa7134/saa7134-vbi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7134/saa7134-vbi.c	2010-04-13 02:19:01.021633088 +0000
@@ -24,7 +24,6 @@
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 
 #include "saa7134-reg.h"
 #include "saa7134.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-api.c linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-api.c
--- linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-api.c	2010-04-13 02:18:55.843633032 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-api.c	2010-04-13 02:19:01.021633088 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/wait.h>
+#include <linux/slab.h>
 
 #include "saa7164.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-buffer.c linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-buffer.c
--- linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-buffer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-buffer.c	2010-04-13 02:19:01.022633064 +0000
@@ -19,6 +19,8 @@
  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
+
 #include "saa7164.h"
 
 /* The PCI address space for buffer handling looks like this:
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-fw.c linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-fw.c
--- linux-2.6.34-rc3/drivers/media/video/saa7164/saa7164-fw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7164/saa7164-fw.c	2010-04-13 02:19:01.022633064 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include "saa7164.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/saa717x.c linux-2.6.34-rc4/drivers/media/video/saa717x.c
--- linux-2.6.34-rc3/drivers/media/video/saa717x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa717x.c	2010-04-13 02:19:01.022633064 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/saa7185.c linux-2.6.34-rc4/drivers/media/video/saa7185.c
--- linux-2.6.34-rc3/drivers/media/video/saa7185.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/saa7185.c	2010-04-13 02:19:01.022633064 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/sh_mobile_ceu_camera.c linux-2.6.34-rc4/drivers/media/video/sh_mobile_ceu_camera.c
--- linux-2.6.34-rc3/drivers/media/video/sh_mobile_ceu_camera.c	2010-04-13 02:18:55.843633032 +0000
+++ linux-2.6.34-rc4/drivers/media/video/sh_mobile_ceu_camera.c	2010-04-13 02:19:01.022633064 +0000
@@ -27,6 +27,7 @@
 #include <linux/moduleparam.h>
 #include <linux/time.h>
 #include <linux/version.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/platform_device.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/soc_camera.c linux-2.6.34-rc4/drivers/media/video/soc_camera.c
--- linux-2.6.34-rc3/drivers/media/video/soc_camera.c	2010-04-13 02:18:55.844633078 +0000
+++ linux-2.6.34-rc4/drivers/media/video/soc_camera.c	2010-04-13 02:19:01.023633012 +0000
@@ -24,6 +24,7 @@
 #include <linux/mutex.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include <media/soc_camera.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tda9840.c linux-2.6.34-rc4/drivers/media/video/tda9840.c
--- linux-2.6.34-rc3/drivers/media/video/tda9840.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tda9840.c	2010-04-13 02:19:01.023633012 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tea6415c.c linux-2.6.34-rc4/drivers/media/video/tea6415c.c
--- linux-2.6.34-rc3/drivers/media/video/tea6415c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tea6415c.c	2010-04-13 02:19:01.023633012 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/module.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tea6420.c linux-2.6.34-rc4/drivers/media/video/tea6420.c
--- linux-2.6.34-rc3/drivers/media/video/tea6420.c	2010-04-13 02:18:55.844633078 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tea6420.c	2010-04-13 02:19:01.023633012 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/module.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/ths7303.c linux-2.6.34-rc4/drivers/media/video/ths7303.c
--- linux-2.6.34-rc3/drivers/media/video/ths7303.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/ths7303.c	2010-04-13 02:19:01.023633012 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/device.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-alsa.c linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-alsa.c
--- linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-alsa.c	2010-04-13 02:18:55.844633078 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-alsa.c	2010-04-13 02:19:01.024633075 +0000
@@ -4,10 +4,10 @@
 #include <linux/sound.h>
 #include <linux/spinlock.h>
 #include <linux/soundcard.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/proc_fs.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-dvb.c linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-dvb.c	2010-04-13 02:18:55.845633037 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-dvb.c	2010-04-13 02:19:01.024633075 +0000
@@ -3,6 +3,7 @@
 #include <linux/usb.h>
 #include <linux/dvb/dmx.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include "vendorcmds.h"
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-video.c linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-video.c
--- linux-2.6.34-rc3/drivers/media/video/tlg2300/pd-video.c	2010-04-13 02:18:55.846633063 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tlg2300/pd-video.c	2010-04-13 02:19:01.025633096 +0000
@@ -4,6 +4,7 @@
 #include <linux/usb.h>
 #include <linux/mm.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <media/v4l2-ioctl.h>
 #include <media/v4l2-dev.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tlv320aic23b.c linux-2.6.34-rc4/drivers/media/video/tlv320aic23b.c
--- linux-2.6.34-rc3/drivers/media/video/tlv320aic23b.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tlv320aic23b.c	2010-04-13 02:19:01.026633045 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tvp514x.c linux-2.6.34-rc4/drivers/media/video/tvp514x.c
--- linux-2.6.34-rc3/drivers/media/video/tvp514x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tvp514x.c	2010-04-13 02:19:01.026633045 +0000
@@ -29,6 +29,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/videodev2.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/tvp5150.c linux-2.6.34-rc4/drivers/media/video/tvp5150.c
--- linux-2.6.34-rc3/drivers/media/video/tvp5150.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tvp5150.c	2010-04-13 02:19:01.026633045 +0000
@@ -6,6 +6,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <linux/delay.h>
 #include <media/v4l2-device.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/tvp7002.c linux-2.6.34-rc4/drivers/media/video/tvp7002.c
--- linux-2.6.34-rc3/drivers/media/video/tvp7002.c	2010-04-13 02:18:55.847633232 +0000
+++ linux-2.6.34-rc4/drivers/media/video/tvp7002.c	2010-04-13 02:19:01.027633047 +0000
@@ -26,6 +26,7 @@
  */
 #include <linux/delay.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <media/tvp7002.h>
 #include <media/v4l2-device.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/upd64031a.c linux-2.6.34-rc4/drivers/media/video/upd64031a.c
--- linux-2.6.34-rc3/drivers/media/video/upd64031a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/upd64031a.c	2010-04-13 02:19:01.027633047 +0000
@@ -25,6 +25,7 @@
 #include <linux/kernel.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/upd64083.c linux-2.6.34-rc4/drivers/media/video/upd64083.c
--- linux-2.6.34-rc3/drivers/media/video/upd64083.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/upd64083.c	2010-04-13 02:19:01.027633047 +0000
@@ -25,6 +25,7 @@
 #include <linux/kernel.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-chip-ident.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/usbvideo/konicawc.c linux-2.6.34-rc4/drivers/media/video/usbvideo/konicawc.c
--- linux-2.6.34-rc3/drivers/media/video/usbvideo/konicawc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/usbvideo/konicawc.c	2010-04-13 02:19:01.028633050 +0000
@@ -16,6 +16,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/usb/input.h>
+#include <linux/gfp.h>
 
 #include "usbvideo.h"
 
diff -urN linux-2.6.34-rc3/drivers/media/video/usbvideo/quickcam_messenger.c linux-2.6.34-rc4/drivers/media/video/usbvideo/quickcam_messenger.c
--- linux-2.6.34-rc3/drivers/media/video/usbvideo/quickcam_messenger.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/usbvideo/quickcam_messenger.c	2010-04-13 02:19:01.028633050 +0000
@@ -34,6 +34,7 @@
 #include <linux/init.h>
 #include <linux/input.h>
 #include <linux/usb/input.h>
+#include <linux/slab.h>
 
 #include "usbvideo.h"
 #include "quickcam_messenger.h"
diff -urN linux-2.6.34-rc3/drivers/media/video/usbvision/usbvision-core.c linux-2.6.34-rc4/drivers/media/video/usbvision/usbvision-core.c
--- linux-2.6.34-rc3/drivers/media/video/usbvision/usbvision-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/usbvision/usbvision-core.c	2010-04-13 02:19:01.028633050 +0000
@@ -26,7 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/timer.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/highmem.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/usbvision/usbvision-i2c.c linux-2.6.34-rc4/drivers/media/video/usbvision/usbvision-i2c.c
--- linux-2.6.34-rc3/drivers/media/video/usbvision/usbvision-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/usbvision/usbvision-i2c.c	2010-04-13 02:19:01.028633050 +0000
@@ -27,7 +27,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/uvc/uvc_ctrl.c linux-2.6.34-rc4/drivers/media/video/uvc/uvc_ctrl.c
--- linux-2.6.34-rc3/drivers/media/video/uvc/uvc_ctrl.c	2010-04-13 02:18:55.848633047 +0000
+++ linux-2.6.34-rc4/drivers/media/video/uvc/uvc_ctrl.c	2010-04-13 02:19:01.029633101 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/usb.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/uvc/uvc_driver.c linux-2.6.34-rc4/drivers/media/video/uvc/uvc_driver.c
--- linux-2.6.34-rc3/drivers/media/video/uvc/uvc_driver.c	2010-04-13 02:18:55.848633047 +0000
+++ linux-2.6.34-rc4/drivers/media/video/uvc/uvc_driver.c	2010-04-13 02:19:01.029633101 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/videodev2.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/uvc/uvc_status.c linux-2.6.34-rc4/drivers/media/video/uvc/uvc_status.c
--- linux-2.6.34-rc3/drivers/media/video/uvc/uvc_status.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/uvc/uvc_status.c	2010-04-13 02:19:01.029633101 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/kernel.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/input.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/uvc/uvc_v4l2.c linux-2.6.34-rc4/drivers/media/video/uvc/uvc_v4l2.c
--- linux-2.6.34-rc3/drivers/media/video/uvc/uvc_v4l2.c	2010-04-13 02:18:55.849571289 +0000
+++ linux-2.6.34-rc4/drivers/media/video/uvc/uvc_v4l2.c	2010-04-13 02:19:01.030633050 +0000
@@ -15,6 +15,7 @@
 #include <linux/version.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/videodev2.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/uvc/uvc_video.c linux-2.6.34-rc4/drivers/media/video/uvc/uvc_video.c
--- linux-2.6.34-rc3/drivers/media/video/uvc/uvc_video.c	2010-04-13 02:18:55.849571289 +0000
+++ linux-2.6.34-rc4/drivers/media/video/uvc/uvc_video.c	2010-04-13 02:19:01.030633050 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/videodev2.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/v4l2-ioctl.c linux-2.6.34-rc4/drivers/media/video/v4l2-ioctl.c
--- linux-2.6.34-rc3/drivers/media/video/v4l2-ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/v4l2-ioctl.c	2010-04-13 02:19:01.031633067 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/videobuf-dma-contig.c linux-2.6.34-rc4/drivers/media/video/videobuf-dma-contig.c
--- linux-2.6.34-rc3/drivers/media/video/videobuf-dma-contig.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/videobuf-dma-contig.c	2010-04-13 02:19:01.031633067 +0000
@@ -20,6 +20,7 @@
 #include <linux/pagemap.h>
 #include <linux/dma-mapping.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <media/videobuf-dma-contig.h>
 
 struct videobuf_dma_contig_memory {
diff -urN linux-2.6.34-rc3/drivers/media/video/videobuf-dvb.c linux-2.6.34-rc4/drivers/media/video/videobuf-dvb.c
--- linux-2.6.34-rc3/drivers/media/video/videobuf-dvb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/videobuf-dvb.c	2010-04-13 02:19:01.031633067 +0000
@@ -19,6 +19,7 @@
 #include <linux/fs.h>
 #include <linux/kthread.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 
 #include <linux/freezer.h>
 
diff -urN linux-2.6.34-rc3/drivers/media/video/vino.c linux-2.6.34-rc4/drivers/media/video/vino.c
--- linux-2.6.34-rc3/drivers/media/video/vino.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/vino.c	2010-04-13 02:19:01.032633082 +0000
@@ -33,6 +33,7 @@
 #include <linux/fs.h>
 #include <linux/interrupt.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/time.h>
 #include <linux/version.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/vp27smpx.c linux-2.6.34-rc4/drivers/media/video/vp27smpx.c
--- linux-2.6.34-rc3/drivers/media/video/vp27smpx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/vp27smpx.c	2010-04-13 02:19:01.032633082 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/vpx3220.c linux-2.6.34-rc4/drivers/media/video/vpx3220.c
--- linux-2.6.34-rc3/drivers/media/video/vpx3220.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/vpx3220.c	2010-04-13 02:19:01.032633082 +0000
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/w9966.c linux-2.6.34-rc4/drivers/media/video/w9966.c
--- linux-2.6.34-rc3/drivers/media/video/w9966.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/w9966.c	2010-04-13 02:19:01.032633082 +0000
@@ -58,6 +58,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/videodev.h>
+#include <linux/slab.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
 #include <linux/parport.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/wm8739.c linux-2.6.34-rc4/drivers/media/video/wm8739.c
--- linux-2.6.34-rc3/drivers/media/video/wm8739.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/wm8739.c	2010-04-13 02:19:01.032633082 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/wm8775.c linux-2.6.34-rc4/drivers/media/video/wm8775.c
--- linux-2.6.34-rc3/drivers/media/video/wm8775.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/wm8775.c	2010-04-13 02:19:01.032633082 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <asm/uaccess.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/media/video/zoran/zoran_card.c linux-2.6.34-rc4/drivers/media/video/zoran/zoran_card.c
--- linux-2.6.34-rc3/drivers/media/video/zoran/zoran_card.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/media/video/zoran/zoran_card.c	2010-04-13 02:19:01.033570599 +0000
@@ -34,6 +34,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include <linux/proc_fs.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/memstick/core/memstick.c linux-2.6.34-rc4/drivers/memstick/core/memstick.c
--- linux-2.6.34-rc3/drivers/memstick/core/memstick.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/memstick/core/memstick.c	2010-04-13 02:19:01.034570478 +0000
@@ -16,6 +16,7 @@
 #include <linux/idr.h>
 #include <linux/fs.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "memstick"
 
diff -urN linux-2.6.34-rc3/drivers/memstick/core/mspro_block.c linux-2.6.34-rc4/drivers/memstick/core/mspro_block.c
--- linux-2.6.34-rc3/drivers/memstick/core/mspro_block.c	2010-04-13 02:18:55.851570595 +0000
+++ linux-2.6.34-rc4/drivers/memstick/core/mspro_block.c	2010-04-13 02:19:01.034570478 +0000
@@ -17,6 +17,7 @@
 #include <linux/hdreg.h>
 #include <linux/kthread.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/memstick.h>
 
 #define DRIVER_NAME "mspro_block"
diff -urN linux-2.6.34-rc3/drivers/memstick/host/jmb38x_ms.c linux-2.6.34-rc4/drivers/memstick/host/jmb38x_ms.c
--- linux-2.6.34-rc3/drivers/memstick/host/jmb38x_ms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/memstick/host/jmb38x_ms.c	2010-04-13 02:19:01.034570478 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/highmem.h>
 #include <linux/memstick.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "jmb38x_ms"
 
diff -urN linux-2.6.34-rc3/drivers/message/fusion/mptfc.c linux-2.6.34-rc4/drivers/message/fusion/mptfc.c
--- linux-2.6.34-rc3/drivers/message/fusion/mptfc.c	2010-04-13 02:18:55.853633087 +0000
+++ linux-2.6.34-rc4/drivers/message/fusion/mptfc.c	2010-04-13 02:19:01.036633060 +0000
@@ -54,6 +54,7 @@
 #include <linux/reboot.h>	/* notifier code */
 #include <linux/workqueue.h>
 #include <linux/sort.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/message/fusion/mptlan.c linux-2.6.34-rc4/drivers/message/fusion/mptlan.c
--- linux-2.6.34-rc3/drivers/message/fusion/mptlan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/message/fusion/mptlan.c	2010-04-13 02:19:01.036633060 +0000
@@ -57,6 +57,7 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #define my_VERSION	MPT_LINUX_VERSION_COMMON
 #define MYNAM		"mptlan"
diff -urN linux-2.6.34-rc3/drivers/message/fusion/mptsas.c linux-2.6.34-rc4/drivers/message/fusion/mptsas.c
--- linux-2.6.34-rc3/drivers/message/fusion/mptsas.c	2010-04-13 02:18:55.854633037 +0000
+++ linux-2.6.34-rc4/drivers/message/fusion/mptsas.c	2010-04-13 02:19:01.037633066 +0000
@@ -45,6 +45,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/jiffies.h>
diff -urN linux-2.6.34-rc3/drivers/message/fusion/mptscsih.c linux-2.6.34-rc4/drivers/message/fusion/mptscsih.c
--- linux-2.6.34-rc3/drivers/message/fusion/mptscsih.c	2010-04-13 02:18:55.854633037 +0000
+++ linux-2.6.34-rc4/drivers/message/fusion/mptscsih.c	2010-04-13 02:19:01.037633066 +0000
@@ -46,6 +46,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/kdev_t.h>
diff -urN linux-2.6.34-rc3/drivers/message/fusion/mptspi.c linux-2.6.34-rc4/drivers/message/fusion/mptspi.c
--- linux-2.6.34-rc3/drivers/message/fusion/mptspi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/message/fusion/mptspi.c	2010-04-13 02:19:01.038633044 +0000
@@ -46,6 +46,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/kdev_t.h>
diff -urN linux-2.6.34-rc3/drivers/message/i2o/i2o_block.c linux-2.6.34-rc4/drivers/message/i2o/i2o_block.c
--- linux-2.6.34-rc3/drivers/message/i2o/i2o_block.c	2010-04-13 02:18:55.854633037 +0000
+++ linux-2.6.34-rc4/drivers/message/i2o/i2o_block.c	2010-04-13 02:19:01.038633044 +0000
@@ -51,6 +51,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/i2o.h>
 
 #include <linux/mempool.h>
diff -urN linux-2.6.34-rc3/drivers/message/i2o/i2o_config.c linux-2.6.34-rc4/drivers/message/i2o/i2o_config.c
--- linux-2.6.34-rc3/drivers/message/i2o/i2o_config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/message/i2o/i2o_config.c	2010-04-13 02:19:01.038633044 +0000
@@ -33,6 +33,7 @@
 #include <linux/miscdevice.h>
 #include <linux/smp_lock.h>
 #include <linux/compat.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/message/i2o/i2o_proc.c linux-2.6.34-rc4/drivers/message/i2o/i2o_proc.c
--- linux-2.6.34-rc3/drivers/message/i2o/i2o_proc.c	2010-04-13 02:18:55.855633209 +0000
+++ linux-2.6.34-rc4/drivers/message/i2o/i2o_proc.c	2010-04-13 02:19:01.038633044 +0000
@@ -40,6 +40,7 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/i2o.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/message/i2o/iop.c linux-2.6.34-rc4/drivers/message/i2o/iop.c
--- linux-2.6.34-rc3/drivers/message/i2o/iop.c	2010-04-13 02:18:55.855633209 +0000
+++ linux-2.6.34-rc4/drivers/message/i2o/iop.c	2010-04-13 02:19:01.039633041 +0000
@@ -29,6 +29,7 @@
 #include <linux/i2o.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "core.h"
 
 #define OSM_NAME	"i2o"
diff -urN linux-2.6.34-rc3/drivers/message/i2o/pci.c linux-2.6.34-rc4/drivers/message/i2o/pci.c
--- linux-2.6.34-rc3/drivers/message/i2o/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/message/i2o/pci.c	2010-04-13 02:19:01.039633041 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/pci.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/i2o.h>
 #include "core.h"
 
diff -urN linux-2.6.34-rc3/drivers/mfd/88pm860x-i2c.c linux-2.6.34-rc4/drivers/mfd/88pm860x-i2c.c
--- linux-2.6.34-rc3/drivers/mfd/88pm860x-i2c.c	2010-04-13 02:18:55.857633077 +0000
+++ linux-2.6.34-rc4/drivers/mfd/88pm860x-i2c.c	2010-04-13 02:19:01.040633734 +0000
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/mfd/88pm860x.h>
+#include <linux/slab.h>
 
 static inline int pm860x_read_device(struct i2c_client *i2c,
 				     int reg, int bytes, void *dest)
diff -urN linux-2.6.34-rc3/drivers/mfd/ab3100-core.c linux-2.6.34-rc4/drivers/mfd/ab3100-core.c
--- linux-2.6.34-rc3/drivers/mfd/ab3100-core.c	2010-04-13 02:18:55.857633077 +0000
+++ linux-2.6.34-rc4/drivers/mfd/ab3100-core.c	2010-04-13 02:19:01.041633131 +0000
@@ -10,6 +10,7 @@
 #include <linux/mutex.h>
 #include <linux/list.h>
 #include <linux/notifier.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/platform_device.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/ab3100-otp.c linux-2.6.34-rc4/drivers/mfd/ab3100-otp.c
--- linux-2.6.34-rc3/drivers/mfd/ab3100-otp.c	2010-04-13 02:18:55.857633077 +0000
+++ linux-2.6.34-rc4/drivers/mfd/ab3100-otp.c	2010-04-13 02:19:01.041633131 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/mfd/ab3100.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/ab4500-core.c linux-2.6.34-rc4/drivers/mfd/ab4500-core.c
--- linux-2.6.34-rc3/drivers/mfd/ab4500-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/ab4500-core.c	2010-04-13 02:19:01.041633131 +0000
@@ -15,6 +15,7 @@
  * Interrupt management to be added - TODO.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/adp5520.c linux-2.6.34-rc4/drivers/mfd/adp5520.c
--- linux-2.6.34-rc3/drivers/mfd/adp5520.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/adp5520.c	2010-04-13 02:19:01.041633131 +0000
@@ -21,6 +21,7 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
 #include <linux/err.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/asic3.c linux-2.6.34-rc4/drivers/mfd/asic3.c
--- linux-2.6.34-rc3/drivers/mfd/asic3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/asic3.c	2010-04-13 02:19:01.041633131 +0000
@@ -21,6 +21,7 @@
 #include <linux/irq.h>
 #include <linux/gpio.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/platform_device.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/da903x.c linux-2.6.34-rc4/drivers/mfd/da903x.c
--- linux-2.6.34-rc3/drivers/mfd/da903x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/da903x.c	2010-04-13 02:19:01.041633131 +0000
@@ -18,6 +18,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/mfd/da903x.h>
+#include <linux/slab.h>
 
 #define DA9030_CHIP_ID		0x00
 #define DA9030_EVENT_A		0x01
diff -urN linux-2.6.34-rc3/drivers/mfd/ezx-pcap.c linux-2.6.34-rc4/drivers/mfd/ezx-pcap.c
--- linux-2.6.34-rc3/drivers/mfd/ezx-pcap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/ezx-pcap.c	2010-04-13 02:19:01.041633131 +0000
@@ -18,6 +18,7 @@
 #include <linux/mfd/ezx-pcap.h>
 #include <linux/spi/spi.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #define PCAP_ADC_MAXQ		8
 struct pcap_adc_request {
diff -urN linux-2.6.34-rc3/drivers/mfd/htc-egpio.c linux-2.6.34-rc4/drivers/mfd/htc-egpio.c
--- linux-2.6.34-rc3/drivers/mfd/htc-egpio.c	2010-04-13 02:18:55.857633077 +0000
+++ linux-2.6.34-rc4/drivers/mfd/htc-egpio.c	2010-04-13 02:19:01.042633097 +0000
@@ -15,6 +15,7 @@
 #include <linux/io.h>
 #include <linux/spinlock.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/mfd/htc-egpio.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/htc-i2cpld.c linux-2.6.34-rc4/drivers/mfd/htc-i2cpld.c
--- linux-2.6.34-rc3/drivers/mfd/htc-i2cpld.c	2010-04-13 02:18:55.858633027 +0000
+++ linux-2.6.34-rc4/drivers/mfd/htc-i2cpld.c	2010-04-13 02:19:01.042633097 +0000
@@ -35,6 +35,7 @@
 #include <linux/spinlock.h>
 #include <linux/htcpld.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 struct htcpld_chip {
 	spinlock_t              lock;
diff -urN linux-2.6.34-rc3/drivers/mfd/htc-pasic3.c linux-2.6.34-rc4/drivers/mfd/htc-pasic3.c
--- linux-2.6.34-rc3/drivers/mfd/htc-pasic3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/htc-pasic3.c	2010-04-13 02:19:01.042633097 +0000
@@ -19,6 +19,7 @@
 #include <linux/mfd/core.h>
 #include <linux/mfd/ds1wm.h>
 #include <linux/mfd/htc-pasic3.h>
+#include <linux/slab.h>
 
 struct pasic3_data {
 	void __iomem *mapping;
diff -urN linux-2.6.34-rc3/drivers/mfd/max8925-i2c.c linux-2.6.34-rc4/drivers/mfd/max8925-i2c.c
--- linux-2.6.34-rc3/drivers/mfd/max8925-i2c.c	2010-04-13 02:18:55.858633027 +0000
+++ linux-2.6.34-rc4/drivers/mfd/max8925-i2c.c	2010-04-13 02:19:01.043633028 +0000
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/mfd/max8925.h>
+#include <linux/slab.h>
 
 #define RTC_I2C_ADDR		0x68
 #define ADC_I2C_ADDR		0x47
diff -urN linux-2.6.34-rc3/drivers/mfd/mc13783-core.c linux-2.6.34-rc4/drivers/mfd/mc13783-core.c
--- linux-2.6.34-rc3/drivers/mfd/mc13783-core.c	2010-04-13 02:18:55.858633027 +0000
+++ linux-2.6.34-rc4/drivers/mfd/mc13783-core.c	2010-04-13 02:19:01.043633028 +0000
@@ -9,6 +9,7 @@
  * the terms of the GNU General Public License version 2 as published by the
  * Free Software Foundation.
  */
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/spi/spi.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/mcp-sa11x0.c linux-2.6.34-rc4/drivers/mfd/mcp-sa11x0.c
--- linux-2.6.34-rc3/drivers/mfd/mcp-sa11x0.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/mcp-sa11x0.c	2010-04-13 02:19:01.043633028 +0000
@@ -17,7 +17,6 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 #include <linux/spinlock.h>
-#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/mfd/mcp.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/menelaus.c linux-2.6.34-rc4/drivers/mfd/menelaus.c
--- linux-2.6.34-rc3/drivers/mfd/menelaus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/menelaus.c	2010-04-13 02:19:01.043633028 +0000
@@ -40,6 +40,7 @@
 #include <linux/delay.h>
 #include <linux/rtc.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #include <asm/mach/irq.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/mfd-core.c linux-2.6.34-rc4/drivers/mfd/mfd-core.c
--- linux-2.6.34-rc3/drivers/mfd/mfd-core.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/mfd-core.c	2010-04-13 02:19:01.043633028 +0000
@@ -15,6 +15,7 @@
 #include <linux/platform_device.h>
 #include <linux/acpi.h>
 #include <linux/mfd/core.h>
+#include <linux/slab.h>
 
 static int mfd_add_device(struct device *parent, int id,
 			  const struct mfd_cell *cell,
diff -urN linux-2.6.34-rc3/drivers/mfd/pcf50633-adc.c linux-2.6.34-rc4/drivers/mfd/pcf50633-adc.c
--- linux-2.6.34-rc3/drivers/mfd/pcf50633-adc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/pcf50633-adc.c	2010-04-13 02:19:01.043633028 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/pcf50633-core.c linux-2.6.34-rc4/drivers/mfd/pcf50633-core.c
--- linux-2.6.34-rc3/drivers/mfd/pcf50633-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/pcf50633-core.c	2010-04-13 02:19:01.043633028 +0000
@@ -22,6 +22,7 @@
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/pcf50633/core.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/sh_mobile_sdhi.c linux-2.6.34-rc4/drivers/mfd/sh_mobile_sdhi.c
--- linux-2.6.34-rc3/drivers/mfd/sh_mobile_sdhi.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/sh_mobile_sdhi.c	2010-04-13 02:19:01.043633028 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/kernel.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/mmc/host.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/sm501.c linux-2.6.34-rc4/drivers/mfd/sm501.c
--- linux-2.6.34-rc3/drivers/mfd/sm501.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/sm501.c	2010-04-13 02:19:01.044571730 +0000
@@ -20,6 +20,7 @@
 #include <linux/platform_device.h>
 #include <linux/pci.h>
 #include <linux/i2c-gpio.h>
+#include <linux/slab.h>
 
 #include <linux/sm501.h>
 #include <linux/sm501-regs.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/t7l66xb.c linux-2.6.34-rc4/drivers/mfd/t7l66xb.c
--- linux-2.6.34-rc3/drivers/mfd/t7l66xb.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/t7l66xb.c	2010-04-13 02:19:01.044571730 +0000
@@ -26,6 +26,7 @@
 #include <linux/module.h>
 #include <linux/err.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/irq.h>
 #include <linux/clk.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/tc6387xb.c linux-2.6.34-rc4/drivers/mfd/tc6387xb.c
--- linux-2.6.34-rc3/drivers/mfd/tc6387xb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/tc6387xb.c	2010-04-13 02:19:01.044571730 +0000
@@ -17,6 +17,7 @@
 #include <linux/mfd/core.h>
 #include <linux/mfd/tmio.h>
 #include <linux/mfd/tc6387xb.h>
+#include <linux/slab.h>
 
 enum {
 	TC6387XB_CELL_MMC,
diff -urN linux-2.6.34-rc3/drivers/mfd/tc6393xb.c linux-2.6.34-rc4/drivers/mfd/tc6393xb.c
--- linux-2.6.34-rc3/drivers/mfd/tc6393xb.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/tc6393xb.c	2010-04-13 02:19:01.044571730 +0000
@@ -25,6 +25,7 @@
 #include <linux/mfd/tmio.h>
 #include <linux/mfd/tc6393xb.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #define SCR_REVID	0x08		/* b Revision ID	*/
 #define SCR_ISR		0x50		/* b Interrupt Status	*/
diff -urN linux-2.6.34-rc3/drivers/mfd/timberdale.c linux-2.6.34-rc4/drivers/mfd/timberdale.c
--- linux-2.6.34-rc3/drivers/mfd/timberdale.c	2010-04-13 02:18:55.859571698 +0000
+++ linux-2.6.34-rc4/drivers/mfd/timberdale.c	2010-04-13 02:19:01.044571730 +0000
@@ -25,6 +25,7 @@
 #include <linux/pci.h>
 #include <linux/msi.h>
 #include <linux/mfd/core.h>
+#include <linux/slab.h>
 
 #include <linux/timb_gpio.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/twl4030-codec.c linux-2.6.34-rc4/drivers/mfd/twl4030-codec.c
--- linux-2.6.34-rc3/drivers/mfd/twl4030-codec.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/twl4030-codec.c	2010-04-13 02:19:01.045570476 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/fs.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/twl4030-irq.c linux-2.6.34-rc4/drivers/mfd/twl4030-irq.c
--- linux-2.6.34-rc3/drivers/mfd/twl4030-irq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/twl4030-irq.c	2010-04-13 02:19:01.045570476 +0000
@@ -31,6 +31,7 @@
 #include <linux/interrupt.h>
 #include <linux/irq.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include <linux/i2c/twl.h>
 
diff -urN linux-2.6.34-rc3/drivers/mfd/ucb1400_core.c linux-2.6.34-rc4/drivers/mfd/ucb1400_core.c
--- linux-2.6.34-rc3/drivers/mfd/ucb1400_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/ucb1400_core.c	2010-04-13 02:19:01.045570476 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/ucb1400.h>
 
 unsigned int ucb1400_adc_read(struct snd_ac97 *ac97, u16 adc_channel,
diff -urN linux-2.6.34-rc3/drivers/mfd/wm831x-core.c linux-2.6.34-rc4/drivers/mfd/wm831x-core.c
--- linux-2.6.34-rc3/drivers/mfd/wm831x-core.c	2010-04-13 02:18:55.860570541 +0000
+++ linux-2.6.34-rc4/drivers/mfd/wm831x-core.c	2010-04-13 02:19:01.046570508 +0000
@@ -18,6 +18,7 @@
 #include <linux/bcd.h>
 #include <linux/delay.h>
 #include <linux/mfd/core.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/pdata.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/wm8350-core.c linux-2.6.34-rc4/drivers/mfd/wm8350-core.c
--- linux-2.6.34-rc3/drivers/mfd/wm8350-core.c	2010-04-13 02:18:55.860570541 +0000
+++ linux-2.6.34-rc4/drivers/mfd/wm8350-core.c	2010-04-13 02:19:01.046570508 +0000
@@ -15,6 +15,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/bug.h>
 #include <linux/device.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/mfd/wm8350-i2c.c linux-2.6.34-rc4/drivers/mfd/wm8350-i2c.c
--- linux-2.6.34-rc3/drivers/mfd/wm8350-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/wm8350-i2c.c	2010-04-13 02:19:01.046570508 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/mfd/wm8350/core.h>
+#include <linux/slab.h>
 
 static int wm8350_i2c_read_device(struct wm8350 *wm8350, char reg,
 				  int bytes, void *dest)
diff -urN linux-2.6.34-rc3/drivers/mfd/wm8400-core.c linux-2.6.34-rc4/drivers/mfd/wm8400-core.c
--- linux-2.6.34-rc3/drivers/mfd/wm8400-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mfd/wm8400-core.c	2010-04-13 02:19:01.046570508 +0000
@@ -18,6 +18,7 @@
 #include <linux/mfd/core.h>
 #include <linux/mfd/wm8400-private.h>
 #include <linux/mfd/wm8400-audio.h>
+#include <linux/slab.h>
 
 static struct {
 	u16  readable;    /* Mask of readable bits */
diff -urN linux-2.6.34-rc3/drivers/mfd/wm8994-core.c linux-2.6.34-rc4/drivers/mfd/wm8994-core.c
--- linux-2.6.34-rc3/drivers/mfd/wm8994-core.c	2010-04-13 02:18:55.861633049 +0000
+++ linux-2.6.34-rc4/drivers/mfd/wm8994-core.c	2010-04-13 02:19:01.047633051 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
 #include <linux/mfd/core.h>
diff -urN linux-2.6.34-rc3/drivers/misc/atmel-ssc.c linux-2.6.34-rc4/drivers/misc/atmel-ssc.c
--- linux-2.6.34-rc3/drivers/misc/atmel-ssc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/atmel-ssc.c	2010-04-13 02:19:01.047633051 +0000
@@ -15,6 +15,7 @@
 #include <linux/io.h>
 #include <linux/spinlock.h>
 #include <linux/atmel-ssc.h>
+#include <linux/slab.h>
 
 /* Serialize access to ssc_list and user count */
 static DEFINE_SPINLOCK(user_lock);
diff -urN linux-2.6.34-rc3/drivers/misc/atmel_pwm.c linux-2.6.34-rc4/drivers/misc/atmel_pwm.c
--- linux-2.6.34-rc3/drivers/misc/atmel_pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/atmel_pwm.c	2010-04-13 02:19:01.047633051 +0000
@@ -1,6 +1,7 @@
 #include <linux/module.h>
 #include <linux/clk.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/misc/atmel_tclib.c linux-2.6.34-rc4/drivers/misc/atmel_tclib.c
--- linux-2.6.34-rc3/drivers/misc/atmel_tclib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/atmel_tclib.c	2010-04-13 02:19:01.047633051 +0000
@@ -6,6 +6,7 @@
 #include <linux/ioport.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 /* Number of bytes to reserve for the iomem resource */
 #define ATMEL_TC_IOMEM_SIZE	256
diff -urN linux-2.6.34-rc3/drivers/misc/c2port/core.c linux-2.6.34-rc4/drivers/misc/c2port/core.c
--- linux-2.6.34-rc3/drivers/misc/c2port/core.c	2010-04-13 02:18:55.861633049 +0000
+++ linux-2.6.34-rc4/drivers/misc/c2port/core.c	2010-04-13 02:19:01.047633051 +0000
@@ -20,6 +20,7 @@
 #include <linux/delay.h>
 #include <linux/idr.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <linux/c2port.h>
 
diff -urN linux-2.6.34-rc3/drivers/misc/cb710/core.c linux-2.6.34-rc4/drivers/misc/cb710/core.c
--- linux-2.6.34-rc3/drivers/misc/cb710/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/cb710/core.c	2010-04-13 02:19:01.047633051 +0000
@@ -9,11 +9,11 @@
  */
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/spinlock.h>
 #include <linux/idr.h>
 #include <linux/cb710.h>
+#include <linux/gfp.h>
 
 static DEFINE_IDA(cb710_ida);
 static DEFINE_SPINLOCK(cb710_ida_lock);
diff -urN linux-2.6.34-rc3/drivers/misc/cb710/debug.c linux-2.6.34-rc4/drivers/misc/cb710/debug.c
--- linux-2.6.34-rc3/drivers/misc/cb710/debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/cb710/debug.c	2010-04-13 02:19:01.047633051 +0000
@@ -10,7 +10,6 @@
 #include <linux/cb710.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 
 #define CB710_REG_COUNT		0x80
 
diff -urN linux-2.6.34-rc3/drivers/misc/cs5535-mfgpt.c linux-2.6.34-rc4/drivers/misc/cs5535-mfgpt.c
--- linux-2.6.34-rc3/drivers/misc/cs5535-mfgpt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/cs5535-mfgpt.c	2010-04-13 02:19:01.047633051 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/cs5535.h>
+#include <linux/slab.h>
 
 #define DRV_NAME "cs5535-mfgpt"
 #define MFGPT_BAR 2
diff -urN linux-2.6.34-rc3/drivers/misc/ds1682.c linux-2.6.34-rc4/drivers/misc/ds1682.c
--- linux-2.6.34-rc3/drivers/misc/ds1682.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ds1682.c	2010-04-13 02:19:01.048633090 +0000
@@ -33,7 +33,6 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/string.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/drivers/misc/enclosure.c linux-2.6.34-rc4/drivers/misc/enclosure.c
--- linux-2.6.34-rc3/drivers/misc/enclosure.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/enclosure.c	2010-04-13 02:19:01.048633090 +0000
@@ -27,6 +27,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 static LIST_HEAD(container_list);
 static DEFINE_MUTEX(container_list_lock);
diff -urN linux-2.6.34-rc3/drivers/misc/ep93xx_pwm.c linux-2.6.34-rc4/drivers/misc/ep93xx_pwm.c
--- linux-2.6.34-rc3/drivers/misc/ep93xx_pwm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ep93xx_pwm.c	2010-04-13 02:19:01.048633090 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/clk.h>
 #include <linux/err.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/misc/hpilo.c linux-2.6.34-rc4/drivers/misc/hpilo.c
--- linux-2.6.34-rc3/drivers/misc/hpilo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/hpilo.c	2010-04-13 02:19:01.049633558 +0000
@@ -25,6 +25,7 @@
 #include <linux/io.h>
 #include <linux/wait.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include "hpilo.h"
 
 static struct class *ilo_class;
diff -urN linux-2.6.34-rc3/drivers/misc/ibmasm/command.c linux-2.6.34-rc4/drivers/misc/ibmasm/command.c
--- linux-2.6.34-rc3/drivers/misc/ibmasm/command.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ibmasm/command.c	2010-04-13 02:19:01.049633558 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "ibmasm.h"
 #include "lowlevel.h"
 
diff -urN linux-2.6.34-rc3/drivers/misc/ibmasm/event.c linux-2.6.34-rc4/drivers/misc/ibmasm/event.c
--- linux-2.6.34-rc3/drivers/misc/ibmasm/event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ibmasm/event.c	2010-04-13 02:19:01.049633558 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "ibmasm.h"
 #include "lowlevel.h"
 
diff -urN linux-2.6.34-rc3/drivers/misc/ibmasm/ibmasmfs.c linux-2.6.34-rc4/drivers/misc/ibmasm/ibmasmfs.c
--- linux-2.6.34-rc3/drivers/misc/ibmasm/ibmasmfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ibmasm/ibmasmfs.c	2010-04-13 02:19:01.049633558 +0000
@@ -75,6 +75,7 @@
 
 #include <linux/fs.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/io.h>
 #include "ibmasm.h"
diff -urN linux-2.6.34-rc3/drivers/misc/ibmasm/module.c linux-2.6.34-rc4/drivers/misc/ibmasm/module.c
--- linux-2.6.34-rc3/drivers/misc/ibmasm/module.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ibmasm/module.c	2010-04-13 02:19:01.049633558 +0000
@@ -52,6 +52,7 @@
 
 #include <linux/pci.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include "ibmasm.h"
 #include "lowlevel.h"
 #include "remote.h"
diff -urN linux-2.6.34-rc3/drivers/misc/ics932s401.c linux-2.6.34-rc4/drivers/misc/ics932s401.c
--- linux-2.6.34-rc3/drivers/misc/ics932s401.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ics932s401.c	2010-04-13 02:19:01.049633558 +0000
@@ -26,6 +26,7 @@
 #include <linux/mutex.h>
 #include <linux/delay.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 /* Addresses to scan */
 static const unsigned short normal_i2c[] = { 0x69, I2C_CLIENT_END };
diff -urN linux-2.6.34-rc3/drivers/misc/ioc4.c linux-2.6.34-rc4/drivers/misc/ioc4.c
--- linux-2.6.34-rc3/drivers/misc/ioc4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/ioc4.c	2010-04-13 02:19:01.049633558 +0000
@@ -30,6 +30,7 @@
 #include <linux/pci.h>
 #include <linux/ioc4.h>
 #include <linux/ktime.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/time.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/misc/iwmc3200top/debugfs.c linux-2.6.34-rc4/drivers/misc/iwmc3200top/debugfs.c
--- linux-2.6.34-rc3/drivers/misc/iwmc3200top/debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/iwmc3200top/debugfs.c	2010-04-13 02:19:01.049633558 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/ctype.h>
 #include <linux/mmc/sdio_func.h>
diff -urN linux-2.6.34-rc3/drivers/misc/iwmc3200top/fw-download.c linux-2.6.34-rc4/drivers/misc/iwmc3200top/fw-download.c
--- linux-2.6.34-rc3/drivers/misc/iwmc3200top/fw-download.c	2010-04-13 02:18:55.862633075 +0000
+++ linux-2.6.34-rc4/drivers/misc/iwmc3200top/fw-download.c	2010-04-13 02:19:01.049633558 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/firmware.h>
 #include <linux/mmc/sdio_func.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include "iwmc3200top.h"
diff -urN linux-2.6.34-rc3/drivers/misc/iwmc3200top/log.c linux-2.6.34-rc4/drivers/misc/iwmc3200top/log.c
--- linux-2.6.34-rc3/drivers/misc/iwmc3200top/log.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/iwmc3200top/log.c	2010-04-13 02:19:01.050633083 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/kernel.h>
 #include <linux/mmc/sdio_func.h>
+#include <linux/slab.h>
 #include <linux/ctype.h>
 #include "fw-msg.h"
 #include "iwmc3200top.h"
diff -urN linux-2.6.34-rc3/drivers/misc/iwmc3200top/main.c linux-2.6.34-rc4/drivers/misc/iwmc3200top/main.c
--- linux-2.6.34-rc3/drivers/misc/iwmc3200top/main.c	2010-04-13 02:18:55.862633075 +0000
+++ linux-2.6.34-rc4/drivers/misc/iwmc3200top/main.c	2010-04-13 02:19:01.050633083 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/drivers/misc/kgdbts.c linux-2.6.34-rc4/drivers/misc/kgdbts.c
--- linux-2.6.34-rc3/drivers/misc/kgdbts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/kgdbts.c	2010-04-13 02:19:01.050633083 +0000
@@ -295,6 +295,10 @@
 	/* On x86 a breakpoint stop requires it to be decremented */
 	if (addr + 1 == kgdbts_regs.ip)
 		offset = -1;
+#elif defined(CONFIG_SUPERH)
+	/* On SUPERH a breakpoint stop requires it to be decremented */
+	if (addr + 2 == kgdbts_regs.pc)
+		offset = -2;
 #endif
 	if (strcmp(arg, "silent") &&
 		instruction_pointer(&kgdbts_regs) + offset != addr) {
@@ -305,6 +309,8 @@
 #ifdef CONFIG_X86
 	/* On x86 adjust the instruction pointer if needed */
 	kgdbts_regs.ip += offset;
+#elif defined(CONFIG_SUPERH)
+	kgdbts_regs.pc += offset;
 #endif
 	return 0;
 }
diff -urN linux-2.6.34-rc3/drivers/misc/lkdtm.c linux-2.6.34-rc4/drivers/misc/lkdtm.c
--- linux-2.6.34-rc3/drivers/misc/lkdtm.c	2010-04-13 02:18:55.862633075 +0000
+++ linux-2.6.34-rc4/drivers/misc/lkdtm.c	2010-04-13 02:19:01.050633083 +0000
@@ -40,6 +40,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/hrtimer.h>
+#include <linux/slab.h>
 #include <scsi/scsi_cmnd.h>
 #include <linux/debugfs.h>
 
diff -urN linux-2.6.34-rc3/drivers/misc/phantom.c linux-2.6.34-rc4/drivers/misc/phantom.c
--- linux-2.6.34-rc3/drivers/misc/phantom.c	2010-04-13 02:18:55.863633028 +0000
+++ linux-2.6.34-rc4/drivers/misc/phantom.c	2010-04-13 02:19:01.051633068 +0000
@@ -21,6 +21,7 @@
 #include <linux/poll.h>
 #include <linux/interrupt.h>
 #include <linux/cdev.h>
+#include <linux/slab.h>
 #include <linux/phantom.h>
 #include <linux/sched.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_main.c linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_main.c
--- linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_main.c	2010-04-13 02:19:01.051633068 +0000
@@ -44,6 +44,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/device.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_partition.c linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_partition.c
--- linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_partition.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_partition.c	2010-04-13 02:19:01.051633068 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/device.h>
 #include <linux/hardirq.h>
+#include <linux/slab.h>
 #include "xpc.h"
 #include <asm/uv/uv_hub.h>
 
diff -urN linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_sn2.c linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_sn2.c
--- linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_sn2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_sn2.c	2010-04-13 02:19:01.051633068 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/uncached.h>
 #include <asm/sn/mspec.h>
 #include <asm/sn/sn_sal.h>
diff -urN linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_uv.c linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_uv.c
--- linux-2.6.34-rc3/drivers/misc/sgi-xp/xpc_uv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/sgi-xp/xpc_uv.c	2010-04-13 02:19:01.052633086 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/device.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <asm/uv/uv_hub.h>
 #if defined CONFIG_X86_64
 #include <asm/uv/bios.h>
diff -urN linux-2.6.34-rc3/drivers/misc/sgi-xp/xpnet.c linux-2.6.34-rc4/drivers/misc/sgi-xp/xpnet.c
--- linux-2.6.34-rc3/drivers/misc/sgi-xp/xpnet.c	2010-04-13 02:18:55.863633028 +0000
+++ linux-2.6.34-rc4/drivers/misc/sgi-xp/xpnet.c	2010-04-13 02:19:01.052633086 +0000
@@ -20,6 +20,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/misc/tifm_core.c linux-2.6.34-rc4/drivers/misc/tifm_core.c
--- linux-2.6.34-rc3/drivers/misc/tifm_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/misc/tifm_core.c	2010-04-13 02:19:01.052633086 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/tifm.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/idr.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/card/block.c linux-2.6.34-rc4/drivers/mmc/card/block.c
--- linux-2.6.34-rc3/drivers/mmc/card/block.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/card/block.c	2010-04-13 02:19:01.052633086 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/kernel.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/hdreg.h>
 #include <linux/kdev_t.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/card/mmc_test.c linux-2.6.34-rc4/drivers/mmc/card/mmc_test.c
--- linux-2.6.34-rc3/drivers/mmc/card/mmc_test.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/card/mmc_test.c	2010-04-13 02:19:01.052633086 +0000
@@ -13,6 +13,7 @@
 #include <linux/mmc/card.h>
 #include <linux/mmc/host.h>
 #include <linux/mmc/mmc.h>
+#include <linux/slab.h>
 
 #include <linux/scatterlist.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/card/queue.c linux-2.6.34-rc4/drivers/mmc/card/queue.c
--- linux-2.6.34-rc3/drivers/mmc/card/queue.c	2010-04-13 02:18:55.863633028 +0000
+++ linux-2.6.34-rc4/drivers/mmc/card/queue.c	2010-04-13 02:19:01.053633065 +0000
@@ -9,6 +9,7 @@
  * published by the Free Software Foundation.
  *
  */
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/blkdev.h>
 #include <linux/freezer.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/card/sdio_uart.c linux-2.6.34-rc4/drivers/mmc/card/sdio_uart.c
--- linux-2.6.34-rc3/drivers/mmc/card/sdio_uart.c	2010-04-13 02:18:55.864633020 +0000
+++ linux-2.6.34-rc4/drivers/mmc/card/sdio_uart.c	2010-04-13 02:19:01.053633065 +0000
@@ -34,10 +34,10 @@
 #include <linux/seq_file.h>
 #include <linux/serial_reg.h>
 #include <linux/circ_buf.h>
-#include <linux/gfp.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
 #include <linux/kfifo.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/core.h>
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/bus.c linux-2.6.34-rc4/drivers/mmc/core/bus.c
--- linux-2.6.34-rc3/drivers/mmc/core/bus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/bus.c	2010-04-13 02:19:01.053633065 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/device.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/card.h>
 #include <linux/mmc/host.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/debugfs.c linux-2.6.34-rc4/drivers/mmc/core/debugfs.c
--- linux-2.6.34-rc3/drivers/mmc/core/debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/debugfs.c	2010-04-13 02:19:01.053633065 +0000
@@ -10,6 +10,7 @@
 #include <linux/debugfs.h>
 #include <linux/fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/host.c linux-2.6.34-rc4/drivers/mmc/core/host.c
--- linux-2.6.34-rc3/drivers/mmc/core/host.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/host.c	2010-04-13 02:19:01.053633065 +0000
@@ -16,6 +16,7 @@
 #include <linux/idr.h>
 #include <linux/pagemap.h>
 #include <linux/leds.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/host.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/core/mmc.c linux-2.6.34-rc4/drivers/mmc/core/mmc.c
--- linux-2.6.34-rc3/drivers/mmc/core/mmc.c	2010-04-13 02:18:55.864633020 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/mmc.c	2010-04-13 02:19:01.054633079 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/host.h>
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/mmc_ops.c linux-2.6.34-rc4/drivers/mmc/core/mmc_ops.c
--- linux-2.6.34-rc3/drivers/mmc/core/mmc_ops.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/mmc_ops.c	2010-04-13 02:19:01.054633079 +0000
@@ -9,6 +9,7 @@
  * your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/scatterlist.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/core/sd.c linux-2.6.34-rc4/drivers/mmc/core/sd.c
--- linux-2.6.34-rc3/drivers/mmc/core/sd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/sd.c	2010-04-13 02:19:01.054633079 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/host.h>
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/sdio_bus.c linux-2.6.34-rc4/drivers/mmc/core/sdio_bus.c
--- linux-2.6.34-rc3/drivers/mmc/core/sdio_bus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/sdio_bus.c	2010-04-13 02:19:01.054633079 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/device.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/card.h>
 #include <linux/mmc/sdio_func.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/core/sdio_cis.c linux-2.6.34-rc4/drivers/mmc/core/sdio_cis.c
--- linux-2.6.34-rc3/drivers/mmc/core/sdio_cis.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/core/sdio_cis.c	2010-04-13 02:19:01.054633079 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/host.h>
 #include <linux/mmc/card.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/at91_mci.c linux-2.6.34-rc4/drivers/mmc/host/at91_mci.c
--- linux-2.6.34-rc3/drivers/mmc/host/at91_mci.c	2010-04-13 02:18:55.865633058 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/at91_mci.c	2010-04-13 02:19:01.055633016 +0000
@@ -65,6 +65,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/clk.h>
 #include <linux/atmel_pdc.h>
+#include <linux/gfp.h>
 
 #include <linux/mmc/host.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/host/atmel-mci.c linux-2.6.34-rc4/drivers/mmc/host/atmel-mci.c
--- linux-2.6.34-rc3/drivers/mmc/host/atmel-mci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/atmel-mci.c	2010-04-13 02:19:01.055633016 +0000
@@ -22,6 +22,7 @@
 #include <linux/platform_device.h>
 #include <linux/scatterlist.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 
 #include <linux/mmc/host.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/au1xmmc.c linux-2.6.34-rc4/drivers/mmc/host/au1xmmc.c
--- linux-2.6.34-rc3/drivers/mmc/host/au1xmmc.c	2010-04-13 02:18:55.865633058 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/au1xmmc.c	2010-04-13 02:19:01.056633130 +0000
@@ -41,6 +41,7 @@
 #include <linux/scatterlist.h>
 #include <linux/leds.h>
 #include <linux/mmc/host.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/mach-au1x00/au1000.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/bfin_sdh.c linux-2.6.34-rc4/drivers/mmc/host/bfin_sdh.c
--- linux-2.6.34-rc3/drivers/mmc/host/bfin_sdh.c	2010-04-13 02:18:55.865633058 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/bfin_sdh.c	2010-04-13 02:19:01.056633130 +0000
@@ -17,6 +17,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/mmc/host.h>
 #include <linux/proc_fs.h>
+#include <linux/gfp.h>
 
 #include <asm/cacheflush.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/cb710-mmc.c linux-2.6.34-rc4/drivers/mmc/host/cb710-mmc.c
--- linux-2.6.34-rc3/drivers/mmc/host/cb710-mmc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/cb710-mmc.c	2010-04-13 02:19:01.056633130 +0000
@@ -9,7 +9,6 @@
  */
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include "cb710-mmc.h"
diff -urN linux-2.6.34-rc3/drivers/mmc/host/mmc_spi.c linux-2.6.34-rc4/drivers/mmc/host/mmc_spi.c
--- linux-2.6.34-rc3/drivers/mmc/host/mmc_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/mmc_spi.c	2010-04-13 02:19:01.056633130 +0000
@@ -26,6 +26,7 @@
  */
 #include <linux/sched.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/bio.h>
 #include <linux/dma-mapping.h>
 #include <linux/crc7.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/msm_sdcc.c linux-2.6.34-rc4/drivers/mmc/host/msm_sdcc.c
--- linux-2.6.34-rc3/drivers/mmc/host/msm_sdcc.c	2010-04-13 02:18:55.866571692 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/msm_sdcc.c	2010-04-13 02:19:01.057633079 +0000
@@ -33,6 +33,7 @@
 #include <linux/debugfs.h>
 #include <linux/io.h>
 #include <linux/memory.h>
+#include <linux/gfp.h>
 
 #include <asm/cacheflush.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/of_mmc_spi.c linux-2.6.34-rc4/drivers/mmc/host/of_mmc_spi.c
--- linux-2.6.34-rc3/drivers/mmc/host/of_mmc_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/of_mmc_spi.c	2010-04-13 02:19:01.057633079 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/of.h>
 #include <linux/of_gpio.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/omap.c linux-2.6.34-rc4/drivers/mmc/host/omap.c
--- linux-2.6.34-rc3/drivers/mmc/host/omap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/omap.c	2010-04-13 02:19:01.057633079 +0000
@@ -26,6 +26,7 @@
 #include <linux/clk.h>
 #include <linux/scatterlist.h>
 #include <linux/i2c/tps65010.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/omap_hsmmc.c linux-2.6.34-rc4/drivers/mmc/host/omap_hsmmc.c
--- linux-2.6.34-rc3/drivers/mmc/host/omap_hsmmc.c	2010-04-13 02:18:55.867570556 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/omap_hsmmc.c	2010-04-13 02:19:01.058633066 +0000
@@ -1179,15 +1179,10 @@
 		carddetect = -ENOSYS;
 	}
 
-	if (carddetect) {
+	if (carddetect)
 		mmc_detect_change(host->mmc, (HZ * 200) / 1000);
-	} else {
-		mmc_host_enable(host->mmc);
-		omap_hsmmc_reset_controller_fsm(host, SRD);
-		mmc_host_lazy_disable(host->mmc);
-
+	else
 		mmc_detect_change(host->mmc, (HZ * 50) / 1000);
-	}
 }
 
 /*
diff -urN linux-2.6.34-rc3/drivers/mmc/host/pxamci.c linux-2.6.34-rc4/drivers/mmc/host/pxamci.c
--- linux-2.6.34-rc3/drivers/mmc/host/pxamci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/pxamci.c	2010-04-13 02:19:01.058633066 +0000
@@ -29,6 +29,7 @@
 #include <linux/io.h>
 #include <linux/regulator/consumer.h>
 #include <linux/gpio.h>
+#include <linux/gfp.h>
 
 #include <asm/sizes.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/host/sdhci-pci.c linux-2.6.34-rc4/drivers/mmc/host/sdhci-pci.c
--- linux-2.6.34-rc3/drivers/mmc/host/sdhci-pci.c	2010-04-13 02:18:55.868633071 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/sdhci-pci.c	2010-04-13 02:19:01.059633063 +0000
@@ -16,6 +16,7 @@
 #include <linux/highmem.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <linux/mmc/host.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/host/sdhci-s3c.c linux-2.6.34-rc4/drivers/mmc/host/sdhci-s3c.c
--- linux-2.6.34-rc3/drivers/mmc/host/sdhci-s3c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/sdhci-s3c.c	2010-04-13 02:19:01.059633063 +0000
@@ -15,6 +15,7 @@
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/clk.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/mmc/host/sdhci.c linux-2.6.34-rc4/drivers/mmc/host/sdhci.c
--- linux-2.6.34-rc3/drivers/mmc/host/sdhci.c	2010-04-13 02:18:55.868633071 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/sdhci.c	2010-04-13 02:19:01.060633087 +0000
@@ -17,6 +17,7 @@
 #include <linux/highmem.h>
 #include <linux/io.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/scatterlist.h>
 
 #include <linux/leds.h>
diff -urN linux-2.6.34-rc3/drivers/mmc/host/wbsd.c linux-2.6.34-rc4/drivers/mmc/host/wbsd.c
--- linux-2.6.34-rc3/drivers/mmc/host/wbsd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mmc/host/wbsd.c	2010-04-13 02:19:01.060633087 +0000
@@ -34,6 +34,7 @@
 #include <linux/highmem.h>
 #include <linux/mmc/host.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/devices/block2mtd.c linux-2.6.34-rc4/drivers/mtd/devices/block2mtd.c
--- linux-2.6.34-rc3/drivers/mtd/devices/block2mtd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/devices/block2mtd.c	2010-04-13 02:19:01.061633063 +0000
@@ -17,6 +17,7 @@
 #include <linux/buffer_head.h>
 #include <linux/mutex.h>
 #include <linux/mount.h>
+#include <linux/slab.h>
 
 #define ERROR(fmt, args...) printk(KERN_ERR "block2mtd: " fmt "\n" , ## args)
 #define INFO(fmt, args...) printk(KERN_INFO "block2mtd: " fmt "\n" , ## args)
diff -urN linux-2.6.34-rc3/drivers/mtd/devices/m25p80.c linux-2.6.34-rc4/drivers/mtd/devices/m25p80.c
--- linux-2.6.34-rc3/drivers/mtd/devices/m25p80.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/devices/m25p80.c	2010-04-13 02:19:01.061633063 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/mutex.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/mod_devicetable.h>
 
diff -urN linux-2.6.34-rc3/drivers/mtd/devices/sst25l.c linux-2.6.34-rc4/drivers/mtd/devices/sst25l.c
--- linux-2.6.34-rc3/drivers/mtd/devices/sst25l.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/devices/sst25l.c	2010-04-13 02:19:01.061633063 +0000
@@ -20,6 +20,7 @@
 #include <linux/device.h>
 #include <linux/mutex.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include <linux/mtd/mtd.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/lpddr/lpddr_cmds.c linux-2.6.34-rc4/drivers/mtd/lpddr/lpddr_cmds.c
--- linux-2.6.34-rc3/drivers/mtd/lpddr/lpddr_cmds.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/lpddr/lpddr_cmds.c	2010-04-13 02:19:01.061633063 +0000
@@ -26,6 +26,7 @@
  */
 #include <linux/mtd/pfow.h>
 #include <linux/mtd/qinfo.h>
+#include <linux/slab.h>
 
 static int lpddr_read(struct mtd_info *mtd, loff_t adr, size_t len,
 					size_t *retlen, u_char *buf);
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/amd76xrom.c linux-2.6.34-rc4/drivers/mtd/maps/amd76xrom.c
--- linux-2.6.34-rc3/drivers/mtd/maps/amd76xrom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/amd76xrom.c	2010-04-13 02:19:01.062633062 +0000
@@ -8,6 +8,7 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/map.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/bfin-async-flash.c linux-2.6.34-rc4/drivers/mtd/maps/bfin-async-flash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/bfin-async-flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/bfin-async-flash.c	2010-04-13 02:19:01.062633062 +0000
@@ -22,6 +22,7 @@
 #include <linux/mtd/partitions.h>
 #include <linux/mtd/physmap.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include <asm/blackfin.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/ck804xrom.c linux-2.6.34-rc4/drivers/mtd/maps/ck804xrom.c
--- linux-2.6.34-rc3/drivers/mtd/maps/ck804xrom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/ck804xrom.c	2010-04-13 02:19:01.062633062 +0000
@@ -11,6 +11,7 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/map.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/esb2rom.c linux-2.6.34-rc4/drivers/mtd/maps/esb2rom.c
--- linux-2.6.34-rc3/drivers/mtd/maps/esb2rom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/esb2rom.c	2010-04-13 02:19:01.062633062 +0000
@@ -14,6 +14,7 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/map.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/gpio-addr-flash.c linux-2.6.34-rc4/drivers/mtd/maps/gpio-addr-flash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/gpio-addr-flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/gpio-addr-flash.c	2010-04-13 02:19:01.062633062 +0000
@@ -23,6 +23,7 @@
 #include <linux/mtd/partitions.h>
 #include <linux/mtd/physmap.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #define pr_devinit(fmt, args...) ({ static const __devinitconst char __fmt[] = fmt; printk(__fmt, ## args); })
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/ichxrom.c linux-2.6.34-rc4/drivers/mtd/maps/ichxrom.c
--- linux-2.6.34-rc3/drivers/mtd/maps/ichxrom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/ichxrom.c	2010-04-13 02:19:01.062633062 +0000
@@ -8,6 +8,7 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/map.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/intel_vr_nor.c linux-2.6.34-rc4/drivers/mtd/maps/intel_vr_nor.c
--- linux-2.6.34-rc3/drivers/mtd/maps/intel_vr_nor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/intel_vr_nor.c	2010-04-13 02:19:01.062633062 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/mtd/mtd.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/octagon-5066.c linux-2.6.34-rc4/drivers/mtd/maps/octagon-5066.c
--- linux-2.6.34-rc3/drivers/mtd/maps/octagon-5066.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/octagon-5066.c	2010-04-13 02:19:01.062633062 +0000
@@ -24,7 +24,6 @@
    ##################################################################### */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/physmap_of.c linux-2.6.34-rc4/drivers/mtd/maps/physmap_of.c
--- linux-2.6.34-rc3/drivers/mtd/maps/physmap_of.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/physmap_of.c	2010-04-13 02:19:01.063633110 +0000
@@ -23,6 +23,7 @@
 #include <linux/mtd/concat.h>
 #include <linux/of.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 
 struct of_flash_list {
 	struct mtd_info *mtd;
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/pismo.c linux-2.6.34-rc4/drivers/mtd/maps/pismo.c
--- linux-2.6.34-rc3/drivers/mtd/maps/pismo.c	2010-04-13 02:18:55.870570527 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/pismo.c	2010-04-13 02:19:01.063633110 +0000
@@ -10,6 +10,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/spinlock.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/pmcmsp-flash.c linux-2.6.34-rc4/drivers/mtd/maps/pmcmsp-flash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/pmcmsp-flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/pmcmsp-flash.c	2010-04-13 02:19:01.063633110 +0000
@@ -28,6 +28,7 @@
  *  675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/pxa2xx-flash.c linux-2.6.34-rc4/drivers/mtd/maps/pxa2xx-flash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/pxa2xx-flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/pxa2xx-flash.c	2010-04-13 02:19:01.063633110 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/sbc_gxx.c linux-2.6.34-rc4/drivers/mtd/maps/sbc_gxx.c
--- linux-2.6.34-rc3/drivers/mtd/maps/sbc_gxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/sbc_gxx.c	2010-04-13 02:19:01.063633110 +0000
@@ -45,7 +45,6 @@
 // Includes
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/sun_uflash.c linux-2.6.34-rc4/drivers/mtd/maps/sun_uflash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/sun_uflash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/sun_uflash.c	2010-04-13 02:19:01.063633110 +0000
@@ -15,6 +15,7 @@
 #include <linux/ioport.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/vmax301.c linux-2.6.34-rc4/drivers/mtd/maps/vmax301.c
--- linux-2.6.34-rc3/drivers/mtd/maps/vmax301.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/vmax301.c	2010-04-13 02:19:01.063633110 +0000
@@ -16,7 +16,6 @@
    ##################################################################### */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/maps/vmu-flash.c linux-2.6.34-rc4/drivers/mtd/maps/vmu-flash.c
--- linux-2.6.34-rc3/drivers/mtd/maps/vmu-flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/maps/vmu-flash.c	2010-04-13 02:19:01.063633110 +0000
@@ -8,6 +8,7 @@
  * GNU General Public Licence
  */
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/delay.h>
 #include <linux/maple.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/mtdcore.c linux-2.6.34-rc4/drivers/mtd/mtdcore.c
--- linux-2.6.34-rc3/drivers/mtd/mtdcore.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/mtdcore.c	2010-04-13 02:19:01.064633080 +0000
@@ -7,7 +7,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/major.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/bcm_umi_nand.c linux-2.6.34-rc4/drivers/mtd/nand/bcm_umi_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/bcm_umi_nand.c	2010-04-13 02:18:55.870570527 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/bcm_umi_nand.c	2010-04-13 02:19:01.064633080 +0000
@@ -18,6 +18,7 @@
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/ioport.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/cafe_nand.c linux-2.6.34-rc4/drivers/mtd/nand/cafe_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/cafe_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/cafe_nand.c	2010-04-13 02:19:01.064633080 +0000
@@ -20,6 +20,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #define CAFE_NAND_CTRL1		0x00
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/cmx270_nand.c linux-2.6.34-rc4/drivers/mtd/nand/cmx270_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/cmx270_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/cmx270_nand.c	2010-04-13 02:19:01.064633080 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/mtd/nand.h>
 #include <linux/mtd/partitions.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/davinci_nand.c linux-2.6.34-rc4/drivers/mtd/nand/davinci_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/davinci_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/davinci_nand.c	2010-04-13 02:19:01.064633080 +0000
@@ -32,6 +32,7 @@
 #include <linux/io.h>
 #include <linux/mtd/nand.h>
 #include <linux/mtd/partitions.h>
+#include <linux/slab.h>
 
 #include <mach/nand.h>
 
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/diskonchip.c linux-2.6.34-rc4/drivers/mtd/nand/diskonchip.c
--- linux-2.6.34-rc3/drivers/mtd/nand/diskonchip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/diskonchip.c	2010-04-13 02:19:01.065633064 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/rslib.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include <linux/mtd/mtd.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/fsl_upm.c linux-2.6.34-rc4/drivers/mtd/nand/fsl_upm.c
--- linux-2.6.34-rc3/drivers/mtd/nand/fsl_upm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/fsl_upm.c	2010-04-13 02:19:01.065633064 +0000
@@ -21,6 +21,7 @@
 #include <linux/of_platform.h>
 #include <linux/of_gpio.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/fsl_lbc.h>
 
 #define FSL_UPM_WAIT_RUN_PATTERN  0x1
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/ndfc.c linux-2.6.34-rc4/drivers/mtd/nand/ndfc.c
--- linux-2.6.34-rc3/drivers/mtd/nand/ndfc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/ndfc.c	2010-04-13 02:19:01.065633064 +0000
@@ -28,6 +28,7 @@
 #include <linux/mtd/nand_ecc.h>
 #include <linux/mtd/partitions.h>
 #include <linux/mtd/ndfc.h>
+#include <linux/slab.h>
 #include <linux/mtd/mtd.h>
 #include <linux/of_platform.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/nomadik_nand.c linux-2.6.34-rc4/drivers/mtd/nand/nomadik_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/nomadik_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/nomadik_nand.c	2010-04-13 02:19:01.065633064 +0000
@@ -30,6 +30,7 @@
 #include <linux/platform_device.h>
 #include <linux/mtd/partitions.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <mach/nand.h>
 #include <mach/fsmc.h>
 
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/omap2.c linux-2.6.34-rc4/drivers/mtd/nand/omap2.c
--- linux-2.6.34-rc3/drivers/mtd/nand/omap2.c	2010-04-13 02:18:55.870570527 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/omap2.c	2010-04-13 02:19:01.065633064 +0000
@@ -17,6 +17,7 @@
 #include <linux/mtd/nand.h>
 #include <linux/mtd/partitions.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <plat/dma.h>
 #include <plat/gpmc.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/pxa3xx_nand.c linux-2.6.34-rc4/drivers/mtd/nand/pxa3xx_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/pxa3xx_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/pxa3xx_nand.c	2010-04-13 02:19:01.066633046 +0000
@@ -21,6 +21,7 @@
 #include <linux/mtd/partitions.h>
 #include <linux/io.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 #include <mach/dma.h>
 #include <plat/pxa3xx_nand.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/sh_flctl.c linux-2.6.34-rc4/drivers/mtd/nand/sh_flctl.c
--- linux-2.6.34-rc3/drivers/mtd/nand/sh_flctl.c	2010-04-13 02:18:55.871570561 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/sh_flctl.c	2010-04-13 02:19:01.066633046 +0000
@@ -26,6 +26,7 @@
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/nand.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/nand/tmio_nand.c linux-2.6.34-rc4/drivers/mtd/nand/tmio_nand.c
--- linux-2.6.34-rc3/drivers/mtd/nand/tmio_nand.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/nand/tmio_nand.c	2010-04-13 02:19:01.066633046 +0000
@@ -37,6 +37,7 @@
 #include <linux/mtd/nand.h>
 #include <linux/mtd/nand_ecc.h>
 #include <linux/mtd/partitions.h>
+#include <linux/slab.h>
 
 /*--------------------------------------------------------------------------*/
 
diff -urN linux-2.6.34-rc3/drivers/mtd/ofpart.c linux-2.6.34-rc4/drivers/mtd/ofpart.c
--- linux-2.6.34-rc3/drivers/mtd/ofpart.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ofpart.c	2010-04-13 02:19:01.066633046 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/of.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/mtd/partitions.h>
 
 int __devinit of_mtd_parse_partitions(struct device *dev,
diff -urN linux-2.6.34-rc3/drivers/mtd/onenand/omap2.c linux-2.6.34-rc4/drivers/mtd/onenand/omap2.c
--- linux-2.6.34-rc3/drivers/mtd/onenand/omap2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/onenand/omap2.c	2010-04-13 02:19:01.066633046 +0000
@@ -34,6 +34,7 @@
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/mach/flash.h>
 #include <plat/gpmc.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/onenand/onenand_base.c linux-2.6.34-rc4/drivers/mtd/onenand/onenand_base.c
--- linux-2.6.34-rc3/drivers/mtd/onenand/onenand_base.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/onenand/onenand_base.c	2010-04-13 02:19:01.067633139 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/onenand/onenand_sim.c linux-2.6.34-rc4/drivers/mtd/onenand/onenand_sim.c
--- linux-2.6.34-rc3/drivers/mtd/onenand/onenand_sim.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/onenand/onenand_sim.c	2010-04-13 02:19:01.067633139 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_nandecctest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_nandecctest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_nandecctest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_nandecctest.c	2010-04-13 02:19:01.067633139 +0000
@@ -1,7 +1,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/list.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/string.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_oobtest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_oobtest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_oobtest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_oobtest.c	2010-04-13 02:19:01.067633139 +0000
@@ -25,6 +25,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_oobtest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_pagetest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_pagetest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_pagetest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_pagetest.c	2010-04-13 02:19:01.067633139 +0000
@@ -25,6 +25,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_pagetest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_readtest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_readtest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_readtest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_readtest.c	2010-04-13 02:19:01.067633139 +0000
@@ -24,6 +24,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_readtest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_speedtest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_speedtest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_speedtest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_speedtest.c	2010-04-13 02:19:01.067633139 +0000
@@ -24,6 +24,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_speedtest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_stresstest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_stresstest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_stresstest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_stresstest.c	2010-04-13 02:19:01.068633043 +0000
@@ -24,6 +24,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/vmalloc.h>
 
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_subpagetest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_subpagetest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_subpagetest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_subpagetest.c	2010-04-13 02:19:01.068633043 +0000
@@ -24,6 +24,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_subpagetest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/tests/mtd_torturetest.c linux-2.6.34-rc4/drivers/mtd/tests/mtd_torturetest.c
--- linux-2.6.34-rc3/drivers/mtd/tests/mtd_torturetest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/tests/mtd_torturetest.c	2010-04-13 02:19:01.068633043 +0000
@@ -28,6 +28,7 @@
 #include <linux/moduleparam.h>
 #include <linux/err.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #define PRINT_PREF KERN_INFO "mtd_torturetest: "
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/build.c linux-2.6.34-rc4/drivers/mtd/ubi/build.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/build.c	2010-04-13 02:18:55.871570561 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/build.c	2010-04-13 02:19:01.068633043 +0000
@@ -44,6 +44,7 @@
 #include <linux/kthread.h>
 #include <linux/reboot.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include "ubi.h"
 
 /* Maximum length of the 'mtd=' parameter */
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/cdev.c linux-2.6.34-rc4/drivers/mtd/ubi/cdev.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/cdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/cdev.c	2010-04-13 02:19:01.068633043 +0000
@@ -37,6 +37,7 @@
 
 #include <linux/module.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/ioctl.h>
 #include <linux/capability.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/gluebi.c linux-2.6.34-rc4/drivers/mtd/ubi/gluebi.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/gluebi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/gluebi.c	2010-04-13 02:19:01.069633111 +0000
@@ -31,6 +31,7 @@
 
 #include <linux/err.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/math64.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/io.c linux-2.6.34-rc4/drivers/mtd/ubi/io.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/io.c	2010-04-13 02:18:55.871570561 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/io.c	2010-04-13 02:19:01.069633111 +0000
@@ -88,6 +88,7 @@
 
 #include <linux/crc32.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include "ubi.h"
 
 #ifdef CONFIG_MTD_UBI_DEBUG_PARANOID
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/kapi.c linux-2.6.34-rc4/drivers/mtd/ubi/kapi.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/kapi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/kapi.c	2010-04-13 02:19:01.069633111 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/fs.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/scan.c linux-2.6.34-rc4/drivers/mtd/ubi/scan.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/scan.c	2010-04-13 02:18:55.872570500 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/scan.c	2010-04-13 02:19:01.069633111 +0000
@@ -41,6 +41,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/crc32.h>
 #include <linux/math64.h>
 #include "ubi.h"
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/ubi.h linux-2.6.34-rc4/drivers/mtd/ubi/ubi.h
--- linux-2.6.34-rc3/drivers/mtd/ubi/ubi.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/ubi.h	2010-04-13 02:19:01.069633111 +0000
@@ -34,6 +34,7 @@
 #include <linux/fs.h>
 #include <linux/cdev.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/vmalloc.h>
 #include <linux/notifier.h>
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/vmt.c linux-2.6.34-rc4/drivers/mtd/ubi/vmt.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/vmt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/vmt.c	2010-04-13 02:19:01.070633099 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/err.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 #include "ubi.h"
 
 #ifdef CONFIG_MTD_UBI_DEBUG_PARANOID
diff -urN linux-2.6.34-rc3/drivers/mtd/ubi/vtbl.c linux-2.6.34-rc4/drivers/mtd/ubi/vtbl.c
--- linux-2.6.34-rc3/drivers/mtd/ubi/vtbl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/mtd/ubi/vtbl.c	2010-04-13 02:19:01.070633099 +0000
@@ -58,6 +58,7 @@
 
 #include <linux/crc32.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <asm/div64.h>
 #include "ubi.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/3c501.c linux-2.6.34-rc4/drivers/net/3c501.c
--- linux-2.6.34-rc3/drivers/net/3c501.c	2010-04-13 02:18:55.872570500 +0000
+++ linux-2.6.34-rc4/drivers/net/3c501.c	2010-04-13 02:19:01.070633099 +0000
@@ -117,7 +117,6 @@
 #include <linux/fcntl.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/net/3c505.c linux-2.6.34-rc4/drivers/net/3c505.c
--- linux-2.6.34-rc3/drivers/net/3c505.c	2010-04-13 02:18:55.873570492 +0000
+++ linux-2.6.34-rc4/drivers/net/3c505.c	2010-04-13 02:19:01.070633099 +0000
@@ -102,12 +102,12 @@
 #include <linux/interrupt.h>
 #include <linux/errno.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/spinlock.h>
 #include <linux/ethtool.h>
 #include <linux/delay.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/3c507.c linux-2.6.34-rc4/drivers/net/3c507.c
--- linux-2.6.34-rc3/drivers/net/3c507.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/3c507.c	2010-04-13 02:19:01.071633042 +0000
@@ -58,7 +58,6 @@
 #include <linux/etherdevice.h>
 #include <linux/if_ether.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/3c509.c linux-2.6.34-rc4/drivers/net/3c509.c
--- linux-2.6.34-rc3/drivers/net/3c509.c	2010-04-13 02:18:55.873570492 +0000
+++ linux-2.6.34-rc4/drivers/net/3c509.c	2010-04-13 02:19:01.071633042 +0000
@@ -76,7 +76,6 @@
 #include <linux/interrupt.h>
 #include <linux/errno.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/3c515.c linux-2.6.34-rc4/drivers/net/3c515.c
--- linux-2.6.34-rc3/drivers/net/3c515.c	2010-04-13 02:18:55.873570492 +0000
+++ linux-2.6.34-rc4/drivers/net/3c515.c	2010-04-13 02:19:01.071633042 +0000
@@ -65,7 +65,6 @@
 #include <linux/errno.h>
 #include <linux/in.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/etherdevice.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/net/3c523.c linux-2.6.34-rc4/drivers/net/3c523.c
--- linux-2.6.34-rc3/drivers/net/3c523.c	2010-04-13 02:18:55.873570492 +0000
+++ linux-2.6.34-rc4/drivers/net/3c523.c	2010-04-13 02:19:01.071633042 +0000
@@ -99,7 +99,6 @@
 #include <linux/errno.h>
 #include <linux/ioport.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/mca-legacy.h>
diff -urN linux-2.6.34-rc3/drivers/net/3c59x.c linux-2.6.34-rc4/drivers/net/3c59x.c
--- linux-2.6.34-rc3/drivers/net/3c59x.c	2010-04-13 02:18:55.874633063 +0000
+++ linux-2.6.34-rc4/drivers/net/3c59x.c	2010-04-13 02:19:01.072633066 +0000
@@ -77,7 +77,6 @@
 #include <linux/errno.h>
 #include <linux/in.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/mii.h>
@@ -90,6 +89,7 @@
 #include <linux/eisa.h>
 #include <linux/bitops.h>
 #include <linux/jiffies.h>
+#include <linux/gfp.h>
 #include <asm/irq.h>			/* For nr_irqs only. */
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/7990.c linux-2.6.34-rc4/drivers/net/7990.c
--- linux-2.6.34-rc3/drivers/net/7990.c	2010-04-13 02:18:55.874633063 +0000
+++ linux-2.6.34-rc4/drivers/net/7990.c	2010-04-13 02:19:01.072633066 +0000
@@ -26,7 +26,6 @@
 #include <linux/ioport.h>
 #include <linux/in.h>
 #include <linux/route.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/skbuff.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/net/8139cp.c linux-2.6.34-rc4/drivers/net/8139cp.c
--- linux-2.6.34-rc3/drivers/net/8139cp.c	2010-04-13 02:18:55.875633041 +0000
+++ linux-2.6.34-rc4/drivers/net/8139cp.c	2010-04-13 02:19:01.073633059 +0000
@@ -64,6 +64,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
 #include <linux/ethtool.h>
+#include <linux/gfp.h>
 #include <linux/mii.h>
 #include <linux/if_vlan.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/8139too.c linux-2.6.34-rc4/drivers/net/8139too.c
--- linux-2.6.34-rc3/drivers/net/8139too.c	2010-04-13 02:18:55.875633041 +0000
+++ linux-2.6.34-rc4/drivers/net/8139too.c	2010-04-13 02:19:01.073633059 +0000
@@ -110,6 +110,7 @@
 #include <linux/crc32.h>
 #include <linux/io.h>
 #include <linux/uaccess.h>
+#include <linux/gfp.h>
 #include <asm/irq.h>
 
 #define RTL8139_DRIVER_NAME   DRV_NAME " Fast Ethernet driver " DRV_VERSION
diff -urN linux-2.6.34-rc3/drivers/net/82596.c linux-2.6.34-rc4/drivers/net/82596.c
--- linux-2.6.34-rc3/drivers/net/82596.c	2010-04-13 02:18:55.875633041 +0000
+++ linux-2.6.34-rc4/drivers/net/82596.c	2010-04-13 02:19:01.074633056 +0000
@@ -45,7 +45,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
@@ -53,6 +52,7 @@
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/Kconfig linux-2.6.34-rc4/drivers/net/Kconfig
--- linux-2.6.34-rc3/drivers/net/Kconfig	2010-04-13 02:18:55.876633027 +0000
+++ linux-2.6.34-rc4/drivers/net/Kconfig	2010-04-13 02:19:01.074633056 +0000
@@ -2582,6 +2582,31 @@
 	  To compile this driver as a module, choose M here: the module
 	  will be called cxgb3.
 
+config CHELSIO_T4_DEPENDS
+	tristate
+	depends on PCI && INET
+	default y
+
+config CHELSIO_T4
+	tristate "Chelsio Communications T4 Ethernet support"
+	depends on CHELSIO_T4_DEPENDS
+	select FW_LOADER
+	select MDIO
+	help
+	  This driver supports Chelsio T4-based gigabit and 10Gb Ethernet
+	  adapters.
+
+	  For general information about Chelsio and our products, visit
+	  our website at <http://www.chelsio.com>.
+
+	  For customer support, please visit our customer support page at
+	  <http://www.chelsio.com/support.htm>.
+
+	  Please send feedback to <linux-bugs@chelsio.com>.
+
+	  To compile this driver as a module choose M here; the module
+	  will be called cxgb4.
+
 config EHEA
 	tristate "eHEA Ethernet support"
 	depends on IBMEBUS && INET && SPARSEMEM
diff -urN linux-2.6.34-rc3/drivers/net/Makefile linux-2.6.34-rc4/drivers/net/Makefile
--- linux-2.6.34-rc3/drivers/net/Makefile	2010-04-13 02:18:55.876633027 +0000
+++ linux-2.6.34-rc4/drivers/net/Makefile	2010-04-13 02:19:01.074633056 +0000
@@ -19,6 +19,7 @@
 obj-$(CONFIG_IP1000) += ipg.o
 obj-$(CONFIG_CHELSIO_T1) += chelsio/
 obj-$(CONFIG_CHELSIO_T3) += cxgb3/
+obj-$(CONFIG_CHELSIO_T4) += cxgb4/
 obj-$(CONFIG_EHEA) += ehea/
 obj-$(CONFIG_CAN) += can/
 obj-$(CONFIG_BONDING) += bonding/
diff -urN linux-2.6.34-rc3/drivers/net/a2065.c linux-2.6.34-rc4/drivers/net/a2065.c
--- linux-2.6.34-rc3/drivers/net/a2065.c	2010-04-13 02:18:55.876633027 +0000
+++ linux-2.6.34-rc4/drivers/net/a2065.c	2010-04-13 02:19:01.075633047 +0000
@@ -46,7 +46,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/acenic.c linux-2.6.34-rc4/drivers/net/acenic.c
--- linux-2.6.34-rc3/drivers/net/acenic.c	2010-04-13 02:18:55.877633076 +0000
+++ linux-2.6.34-rc4/drivers/net/acenic.c	2010-04-13 02:19:01.075633047 +0000
@@ -67,6 +67,7 @@
 #include <linux/highmem.h>
 #include <linux/sockios.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)
 #include <linux/if_vlan.h>
diff -urN linux-2.6.34-rc3/drivers/net/amd8111e.c linux-2.6.34-rc4/drivers/net/amd8111e.c
--- linux-2.6.34-rc3/drivers/net/amd8111e.c	2010-04-13 02:18:55.877633076 +0000
+++ linux-2.6.34-rc4/drivers/net/amd8111e.c	2010-04-13 02:19:01.075633047 +0000
@@ -73,7 +73,6 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/compiler.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/net/appletalk/cops.c linux-2.6.34-rc4/drivers/net/appletalk/cops.c
--- linux-2.6.34-rc3/drivers/net/appletalk/cops.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/appletalk/cops.c	2010-04-13 02:19:01.076633089 +0000
@@ -56,7 +56,6 @@
 #include <linux/ptrace.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/appletalk/ipddp.c linux-2.6.34-rc4/drivers/net/appletalk/ipddp.c
--- linux-2.6.34-rc3/drivers/net/appletalk/ipddp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/appletalk/ipddp.c	2010-04-13 02:19:01.076633089 +0000
@@ -31,6 +31,7 @@
 #include <linux/ip.h>
 #include <linux/atalk.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/route.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/appletalk/ltpc.c linux-2.6.34-rc4/drivers/net/appletalk/ltpc.c
--- linux-2.6.34-rc3/drivers/net/appletalk/ltpc.c	2010-04-13 02:18:55.877633076 +0000
+++ linux-2.6.34-rc4/drivers/net/appletalk/ltpc.c	2010-04-13 02:19:01.076633089 +0000
@@ -215,7 +215,6 @@
 #include <linux/ioport.h>
 #include <linux/spinlock.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
@@ -228,6 +227,7 @@
 #include <linux/timer.h>
 #include <linux/atalk.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/arc-rawmode.c linux-2.6.34-rc4/drivers/net/arcnet/arc-rawmode.c
--- linux-2.6.34-rc3/drivers/net/arcnet/arc-rawmode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/arc-rawmode.c	2010-04-13 02:19:01.076633089 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/if_arp.h>
 #include <net/arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/arc-rimi.c linux-2.6.34-rc4/drivers/net/arcnet/arc-rimi.c
--- linux-2.6.34-rc3/drivers/net/arcnet/arc-rimi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/arc-rimi.c	2010-04-13 02:19:01.076633089 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
 #include <linux/bootmem.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/capmode.c linux-2.6.34-rc4/drivers/net/arcnet/capmode.c
--- linux-2.6.34-rc3/drivers/net/arcnet/capmode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/capmode.c	2010-04-13 02:19:01.076633089 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/if_arp.h>
 #include <net/arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/com20020-isa.c linux-2.6.34-rc4/drivers/net/arcnet/com20020-isa.c
--- linux-2.6.34-rc3/drivers/net/arcnet/com20020-isa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/com20020-isa.c	2010-04-13 02:19:01.076633089 +0000
@@ -30,7 +30,6 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/com20020-pci.c linux-2.6.34-rc4/drivers/net/arcnet/com20020-pci.c
--- linux-2.6.34-rc3/drivers/net/arcnet/com20020-pci.c	2010-04-13 02:18:55.877633076 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/com20020-pci.c	2010-04-13 02:19:01.076633089 +0000
@@ -31,7 +31,6 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/com20020.c linux-2.6.34-rc4/drivers/net/arcnet/com20020.c
--- linux-2.6.34-rc3/drivers/net/arcnet/com20020.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/com20020.c	2010-04-13 02:19:01.076633089 +0000
@@ -29,7 +29,6 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/com90io.c linux-2.6.34-rc4/drivers/net/arcnet/com90io.c
--- linux-2.6.34-rc3/drivers/net/arcnet/com90io.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/com90io.c	2010-04-13 02:19:01.077633097 +0000
@@ -29,7 +29,6 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
 #include <linux/bootmem.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/com90xx.c linux-2.6.34-rc4/drivers/net/arcnet/com90xx.c
--- linux-2.6.34-rc3/drivers/net/arcnet/com90xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/com90xx.c	2010-04-13 02:19:01.077633097 +0000
@@ -30,6 +30,7 @@
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/arcdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/rfc1051.c linux-2.6.34-rc4/drivers/net/arcnet/rfc1051.c
--- linux-2.6.34-rc3/drivers/net/arcnet/rfc1051.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/rfc1051.c	2010-04-13 02:19:01.077633097 +0000
@@ -24,6 +24,7 @@
  * **********************
  */
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/if_arp.h>
 #include <net/arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/arcnet/rfc1201.c linux-2.6.34-rc4/drivers/net/arcnet/rfc1201.c
--- linux-2.6.34-rc3/drivers/net/arcnet/rfc1201.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arcnet/rfc1201.c	2010-04-13 02:19:01.077633097 +0000
@@ -23,6 +23,7 @@
  *
  * **********************
  */
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/ariadne.c linux-2.6.34-rc4/drivers/net/ariadne.c
--- linux-2.6.34-rc3/drivers/net/ariadne.c	2010-04-13 02:18:55.878633054 +0000
+++ linux-2.6.34-rc4/drivers/net/ariadne.c	2010-04-13 02:19:01.077633097 +0000
@@ -40,7 +40,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/net/arm/at91_ether.c linux-2.6.34-rc4/drivers/net/arm/at91_ether.c
--- linux-2.6.34-rc3/drivers/net/arm/at91_ether.c	2010-04-13 02:18:55.878633054 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/at91_ether.c	2010-04-13 02:19:01.077633097 +0000
@@ -27,6 +27,7 @@
 #include <linux/ethtool.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/arm/ep93xx_eth.c linux-2.6.34-rc4/drivers/net/arm/ep93xx_eth.c
--- linux-2.6.34-rc3/drivers/net/arm/ep93xx_eth.c	2010-04-13 02:18:55.878633054 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/ep93xx_eth.c	2010-04-13 02:19:01.078633058 +0000
@@ -23,6 +23,7 @@
 #include <linux/platform_device.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/arm/etherh.c linux-2.6.34-rc4/drivers/net/arm/etherh.c
--- linux-2.6.34-rc3/drivers/net/arm/etherh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/etherh.c	2010-04-13 02:19:01.078633058 +0000
@@ -33,7 +33,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/arm/ixp4xx_eth.c linux-2.6.34-rc4/drivers/net/arm/ixp4xx_eth.c
--- linux-2.6.34-rc3/drivers/net/arm/ixp4xx_eth.c	2010-04-13 02:18:55.879571334 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/ixp4xx_eth.c	2010-04-13 02:19:01.078633058 +0000
@@ -32,6 +32,7 @@
 #include <linux/kernel.h>
 #include <linux/phy.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <mach/npe.h>
 #include <mach/qmgr.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/arm/ks8695net.c linux-2.6.34-rc4/drivers/net/arm/ks8695net.c
--- linux-2.6.34-rc3/drivers/net/arm/ks8695net.c	2010-04-13 02:18:55.879571334 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/ks8695net.c	2010-04-13 02:19:01.079633058 +0000
@@ -30,6 +30,7 @@
 #include <linux/platform_device.h>
 #include <linux/irq.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/arm/w90p910_ether.c linux-2.6.34-rc4/drivers/net/arm/w90p910_ether.c
--- linux-2.6.34-rc3/drivers/net/arm/w90p910_ether.c	2010-04-13 02:18:55.879571334 +0000
+++ linux-2.6.34-rc4/drivers/net/arm/w90p910_ether.c	2010-04-13 02:19:01.079633058 +0000
@@ -18,6 +18,7 @@
 #include <linux/ethtool.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
+#include <linux/gfp.h>
 
 #define DRV_MODULE_NAME		"w90p910-emc"
 #define DRV_MODULE_VERSION	"0.1"
diff -urN linux-2.6.34-rc3/drivers/net/at1700.c linux-2.6.34-rc4/drivers/net/at1700.c
--- linux-2.6.34-rc3/drivers/net/at1700.c	2010-04-13 02:18:55.879571334 +0000
+++ linux-2.6.34-rc4/drivers/net/at1700.c	2010-04-13 02:19:01.079633058 +0000
@@ -47,7 +47,6 @@
 #include <linux/ioport.h>
 #include <linux/in.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/atarilance.c linux-2.6.34-rc4/drivers/net/atarilance.c
--- linux-2.6.34-rc3/drivers/net/atarilance.c	2010-04-13 02:18:55.879571334 +0000
+++ linux-2.6.34-rc4/drivers/net/atarilance.c	2010-04-13 02:19:01.079633058 +0000
@@ -53,7 +53,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/net/atl1c/atl1c_ethtool.c linux-2.6.34-rc4/drivers/net/atl1c/atl1c_ethtool.c
--- linux-2.6.34-rc3/drivers/net/atl1c/atl1c_ethtool.c	2010-04-13 02:18:55.880570504 +0000
+++ linux-2.6.34-rc4/drivers/net/atl1c/atl1c_ethtool.c	2010-04-13 02:19:01.079633058 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
+#include <linux/slab.h>
 
 #include "atl1c.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/atl1e/atl1e_ethtool.c linux-2.6.34-rc4/drivers/net/atl1e/atl1e_ethtool.c
--- linux-2.6.34-rc3/drivers/net/atl1e/atl1e_ethtool.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/atl1e/atl1e_ethtool.c	2010-04-13 02:19:01.080633067 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
+#include <linux/slab.h>
 
 #include "atl1e.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/atlx/atl2.c linux-2.6.34-rc4/drivers/net/atlx/atl2.c
--- linux-2.6.34-rc3/drivers/net/atlx/atl2.c	2010-04-13 02:18:55.882633080 +0000
+++ linux-2.6.34-rc4/drivers/net/atlx/atl2.c	2010-04-13 02:19:01.082633060 +0000
@@ -39,6 +39,7 @@
 #include <linux/pci_ids.h>
 #include <linux/pm.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/tcp.h>
diff -urN linux-2.6.34-rc3/drivers/net/atp.c linux-2.6.34-rc4/drivers/net/atp.c
--- linux-2.6.34-rc3/drivers/net/atp.c	2010-04-13 02:18:55.883633018 +0000
+++ linux-2.6.34-rc4/drivers/net/atp.c	2010-04-13 02:19:01.083633075 +0000
@@ -129,7 +129,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/ax88796.c linux-2.6.34-rc4/drivers/net/ax88796.c
--- linux-2.6.34-rc3/drivers/net/ax88796.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ax88796.c	2010-04-13 02:19:01.084633039 +0000
@@ -25,6 +25,7 @@
 #include <linux/ethtool.h>
 #include <linux/mii.h>
 #include <linux/eeprom_93cx6.h>
+#include <linux/slab.h>
 
 #include <net/ax88796.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/b44.c linux-2.6.34-rc4/drivers/net/b44.c
--- linux-2.6.34-rc3/drivers/net/b44.c	2010-04-13 02:18:55.884633091 +0000
+++ linux-2.6.34-rc4/drivers/net/b44.c	2010-04-13 02:19:01.084633039 +0000
@@ -27,6 +27,7 @@
 #include <linux/init.h>
 #include <linux/dma-mapping.h>
 #include <linux/ssb/ssb.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/bcm63xx_enet.c linux-2.6.34-rc4/drivers/net/bcm63xx_enet.c
--- linux-2.6.34-rc3/drivers/net/bcm63xx_enet.c	2010-04-13 02:18:55.884633091 +0000
+++ linux-2.6.34-rc4/drivers/net/bcm63xx_enet.c	2010-04-13 02:19:01.084633039 +0000
@@ -21,6 +21,7 @@
 #include <linux/module.h>
 #include <linux/clk.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/ethtool.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/benet/be.h linux-2.6.34-rc4/drivers/net/benet/be.h
--- linux-2.6.34-rc3/drivers/net/benet/be.h	2010-04-13 02:18:55.884633091 +0000
+++ linux-2.6.34-rc4/drivers/net/benet/be.h	2010-04-13 02:19:01.085633047 +0000
@@ -29,6 +29,7 @@
 #include <linux/workqueue.h>
 #include <linux/interrupt.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include "be_hw.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/benet/be_cmds.c linux-2.6.34-rc4/drivers/net/benet/be_cmds.c
--- linux-2.6.34-rc3/drivers/net/benet/be_cmds.c	2010-04-13 02:18:55.885633063 +0000
+++ linux-2.6.34-rc4/drivers/net/benet/be_cmds.c	2010-04-13 02:19:01.085633047 +0000
@@ -1464,8 +1464,8 @@
 
 	req->params.op_type = cpu_to_le32(IMG_TYPE_REDBOOT);
 	req->params.op_code = cpu_to_le32(FLASHROM_OPER_REPORT);
-	req->params.offset = offset;
-	req->params.data_buf_size = 0x4;
+	req->params.offset = cpu_to_le32(offset);
+	req->params.data_buf_size = cpu_to_le32(0x4);
 
 	status = be_mcc_notify_wait(adapter);
 	if (!status)
diff -urN linux-2.6.34-rc3/drivers/net/benet/be_main.c linux-2.6.34-rc4/drivers/net/benet/be_main.c
--- linux-2.6.34-rc3/drivers/net/benet/be_main.c	2010-04-13 02:18:55.886633028 +0000
+++ linux-2.6.34-rc4/drivers/net/benet/be_main.c	2010-04-13 02:19:01.086633044 +0000
@@ -807,7 +807,7 @@
 			return;
 		}
 		vid = AMAP_GET_BITS(struct amap_eth_rx_compl, vlan_tag, rxcp);
-		vid = be16_to_cpu(vid);
+		vid = swab16(vid);
 		vlan_hwaccel_receive_skb(skb, adapter->vlan_grp, vid);
 	} else {
 		netif_receive_skb(skb);
@@ -884,7 +884,7 @@
 		napi_gro_frags(&eq_obj->napi);
 	} else {
 		vid = AMAP_GET_BITS(struct amap_eth_rx_compl, vlan_tag, rxcp);
-		vid = be16_to_cpu(vid);
+		vid = swab16(vid);
 
 		if (!adapter->vlan_grp || adapter->vlans_added == 0)
 			return;
@@ -1855,7 +1855,7 @@
 	p += crc_offset;
 
 	status = be_cmd_get_flash_crc(adapter, flashed_crc,
-			(img_start + image_size - 4));
+			(image_size - 4));
 	if (status) {
 		dev_err(&adapter->pdev->dev,
 		"could not get crc from flash, not flashing redboot\n");
@@ -1991,7 +1991,7 @@
 	struct flash_file_hdr_g3 *fhdr3;
 	struct image_hdr *img_hdr_ptr = NULL;
 	struct be_dma_mem flash_cmd;
-	int status, i = 0;
+	int status, i = 0, num_imgs = 0;
 	const u8 *p;
 
 	strcpy(fw_file, func);
@@ -2017,15 +2017,14 @@
 	if ((adapter->generation == BE_GEN3) &&
 			(get_ufigen_type(fhdr) == BE_GEN3)) {
 		fhdr3 = (struct flash_file_hdr_g3 *) fw->data;
-		for (i = 0; i < fhdr3->num_imgs; i++) {
+		num_imgs = le32_to_cpu(fhdr3->num_imgs);
+		for (i = 0; i < num_imgs; i++) {
 			img_hdr_ptr = (struct image_hdr *) (fw->data +
 					(sizeof(struct flash_file_hdr_g3) +
-					i * sizeof(struct image_hdr)));
-			if (img_hdr_ptr->imageid == 1) {
-				status = be_flash_data(adapter, fw,
-						&flash_cmd, fhdr3->num_imgs);
-			}
-
+					 i * sizeof(struct image_hdr)));
+			if (le32_to_cpu(img_hdr_ptr->imageid) == 1)
+				status = be_flash_data(adapter, fw, &flash_cmd,
+							num_imgs);
 		}
 	} else if ((adapter->generation == BE_GEN2) &&
 			(get_ufigen_type(fhdr) == BE_GEN2)) {
diff -urN linux-2.6.34-rc3/drivers/net/bmac.c linux-2.6.34-rc4/drivers/net/bmac.c
--- linux-2.6.34-rc3/drivers/net/bmac.c	2010-04-13 02:18:55.887613845 +0000
+++ linux-2.6.34-rc4/drivers/net/bmac.c	2010-04-13 02:19:01.087633092 +0000
@@ -20,6 +20,7 @@
 #include <linux/crc32.h>
 #include <linux/bitrev.h>
 #include <linux/ethtool.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include <asm/dbdma.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/bonding/bond_main.c linux-2.6.34-rc4/drivers/net/bonding/bond_main.c
--- linux-2.6.34-rc3/drivers/net/bonding/bond_main.c	2010-04-13 02:18:55.894633047 +0000
+++ linux-2.6.34-rc4/drivers/net/bonding/bond_main.c	2010-04-13 02:19:01.094633051 +0000
@@ -4156,7 +4156,7 @@
 	 * send the join/membership reports.  The curr_active_slave found
 	 * will send all of this type of traffic.
 	 */
-	if ((iph->protocol == htons(IPPROTO_IGMP)) &&
+	if ((iph->protocol == IPPROTO_IGMP) &&
 	    (skb->protocol == htons(ETH_P_IP))) {
 
 		read_lock(&bond->curr_slave_lock);
@@ -4450,6 +4450,14 @@
 	.ndo_vlan_rx_kill_vid	= bond_vlan_rx_kill_vid,
 };
 
+static void bond_destructor(struct net_device *bond_dev)
+{
+	struct bonding *bond = netdev_priv(bond_dev);
+	if (bond->wq)
+		destroy_workqueue(bond->wq);
+	free_netdev(bond_dev);
+}
+
 static void bond_setup(struct net_device *bond_dev)
 {
 	struct bonding *bond = netdev_priv(bond_dev);
@@ -4470,7 +4478,7 @@
 	bond_dev->ethtool_ops = &bond_ethtool_ops;
 	bond_set_mode_ops(bond, bond->params.mode);
 
-	bond_dev->destructor = free_netdev;
+	bond_dev->destructor = bond_destructor;
 
 	/* Initialize the device options */
 	bond_dev->tx_queue_len = 0;
@@ -4542,9 +4550,6 @@
 
 	bond_remove_proc_entry(bond);
 
-	if (bond->wq)
-		destroy_workqueue(bond->wq);
-
 	netif_addr_lock_bh(bond_dev);
 	bond_mc_list_destroy(bond);
 	netif_addr_unlock_bh(bond_dev);
@@ -4956,8 +4961,8 @@
 				bond_setup);
 	if (!bond_dev) {
 		pr_err("%s: eek! can't alloc netdev!\n", name);
-		res = -ENOMEM;
-		goto out;
+		rtnl_unlock();
+		return -ENOMEM;
 	}
 
 	dev_net_set(bond_dev, net);
@@ -4966,19 +4971,16 @@
 	if (!name) {
 		res = dev_alloc_name(bond_dev, "bond%d");
 		if (res < 0)
-			goto out_netdev;
+			goto out;
 	}
 
 	res = register_netdevice(bond_dev);
-	if (res < 0)
-		goto out_netdev;
 
 out:
 	rtnl_unlock();
+	if (res < 0)
+		bond_destructor(bond_dev);
 	return res;
-out_netdev:
-	free_netdev(bond_dev);
-	goto out;
 }
 
 static int __net_init bond_net_init(struct net *net)
diff -urN linux-2.6.34-rc3/drivers/net/can/dev.c linux-2.6.34-rc4/drivers/net/can/dev.c
--- linux-2.6.34-rc3/drivers/net/can/dev.c	2010-04-13 02:18:55.895633041 +0000
+++ linux-2.6.34-rc4/drivers/net/can/dev.c	2010-04-13 02:19:01.095599103 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/if_arp.h>
 #include <linux/can.h>
diff -urN linux-2.6.34-rc3/drivers/net/can/mcp251x.c linux-2.6.34-rc4/drivers/net/can/mcp251x.c
--- linux-2.6.34-rc3/drivers/net/can/mcp251x.c	2010-04-13 02:18:55.895633041 +0000
+++ linux-2.6.34-rc4/drivers/net/can/mcp251x.c	2010-04-13 02:19:01.096633086 +0000
@@ -73,6 +73,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/spi/spi.h>
 #include <linux/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/can/sja1000/ems_pci.c linux-2.6.34-rc4/drivers/net/can/sja1000/ems_pci.c
--- linux-2.6.34-rc3/drivers/net/can/sja1000/ems_pci.c	2010-04-13 02:18:55.896571168 +0000
+++ linux-2.6.34-rc4/drivers/net/can/sja1000/ems_pci.c	2010-04-13 02:19:01.097633092 +0000
@@ -22,6 +22,7 @@
 #include <linux/interrupt.h>
 #include <linux/netdevice.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/can.h>
 #include <linux/can/dev.h>
diff -urN linux-2.6.34-rc3/drivers/net/can/sja1000/plx_pci.c linux-2.6.34-rc4/drivers/net/can/sja1000/plx_pci.c
--- linux-2.6.34-rc3/drivers/net/can/sja1000/plx_pci.c	2010-04-13 02:18:55.897570494 +0000
+++ linux-2.6.34-rc4/drivers/net/can/sja1000/plx_pci.c	2010-04-13 02:19:01.097633092 +0000
@@ -25,6 +25,7 @@
 #include <linux/interrupt.h>
 #include <linux/netdevice.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/can.h>
 #include <linux/can/dev.h>
diff -urN linux-2.6.34-rc3/drivers/net/can/vcan.c linux-2.6.34-rc4/drivers/net/can/vcan.c
--- linux-2.6.34-rc3/drivers/net/can/vcan.c	2010-04-13 02:18:55.897570494 +0000
+++ linux-2.6.34-rc4/drivers/net/can/vcan.c	2010-04-13 02:19:01.098633110 +0000
@@ -48,6 +48,7 @@
 #include <linux/if_ether.h>
 #include <linux/can.h>
 #include <linux/can/dev.h>
+#include <linux/slab.h>
 #include <net/rtnetlink.h>
 
 static __initdata const char banner[] =
diff -urN linux-2.6.34-rc3/drivers/net/chelsio/common.h linux-2.6.34-rc4/drivers/net/chelsio/common.h
--- linux-2.6.34-rc3/drivers/net/chelsio/common.h	2010-04-13 02:18:55.899571437 +0000
+++ linux-2.6.34-rc4/drivers/net/chelsio/common.h	2010-04-13 02:19:01.099633029 +0000
@@ -51,6 +51,7 @@
 #include <linux/mdio.h>
 #include <linux/crc32.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/pci_ids.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/chelsio/pm3393.c linux-2.6.34-rc4/drivers/net/chelsio/pm3393.c
--- linux-2.6.34-rc3/drivers/net/chelsio/pm3393.c	2010-04-13 02:18:55.899571437 +0000
+++ linux-2.6.34-rc4/drivers/net/chelsio/pm3393.c	2010-04-13 02:19:01.100633121 +0000
@@ -44,6 +44,7 @@
 #include "suni1x10gexp_regs.h"
 
 #include <linux/crc32.h>
+#include <linux/slab.h>
 
 #define OFFSET(REG_ADDR)    ((REG_ADDR) << 2)
 
diff -urN linux-2.6.34-rc3/drivers/net/chelsio/sge.c linux-2.6.34-rc4/drivers/net/chelsio/sge.c
--- linux-2.6.34-rc3/drivers/net/chelsio/sge.c	2010-04-13 02:18:55.900570667 +0000
+++ linux-2.6.34-rc4/drivers/net/chelsio/sge.c	2010-04-13 02:19:01.100633121 +0000
@@ -53,6 +53,7 @@
 #include <linux/ip.h>
 #include <linux/in.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 
 #include "cpl5_cmd.h"
 #include "sge.h"
diff -urN linux-2.6.34-rc3/drivers/net/cris/eth_v10.c linux-2.6.34-rc4/drivers/net/cris/eth_v10.c
--- linux-2.6.34-rc3/drivers/net/cris/eth_v10.c	2010-04-13 02:18:55.902633037 +0000
+++ linux-2.6.34-rc4/drivers/net/cris/eth_v10.c	2010-04-13 02:19:01.102570461 +0000
@@ -18,7 +18,6 @@
 #include <linux/ptrace.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/spinlock.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/cs89x0.c linux-2.6.34-rc4/drivers/net/cs89x0.c
--- linux-2.6.34-rc3/drivers/net/cs89x0.c	2010-04-13 02:18:55.902633037 +0000
+++ linux-2.6.34-rc4/drivers/net/cs89x0.c	2010-04-13 02:19:01.103633109 +0000
@@ -138,12 +138,12 @@
 #include <linux/ioport.h>
 #include <linux/in.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/cxgb3/cxgb3_main.c linux-2.6.34-rc4/drivers/net/cxgb3/cxgb3_main.c
--- linux-2.6.34-rc3/drivers/net/cxgb3/cxgb3_main.c	2010-04-13 02:18:55.903633082 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb3/cxgb3_main.c	2010-04-13 02:19:01.104633051 +0000
@@ -46,6 +46,7 @@
 #include <linux/log2.h>
 #include <linux/stringify.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #include "common.h"
diff -urN linux-2.6.34-rc3/drivers/net/cxgb3/cxgb3_offload.c linux-2.6.34-rc4/drivers/net/cxgb3/cxgb3_offload.c
--- linux-2.6.34-rc3/drivers/net/cxgb3/cxgb3_offload.c	2010-04-13 02:18:55.903633082 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb3/cxgb3_offload.c	2010-04-13 02:19:01.104633051 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/neighbour.h>
 #include <linux/notifier.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/net/cxgb3/l2t.c linux-2.6.34-rc4/drivers/net/cxgb3/l2t.c
--- linux-2.6.34-rc3/drivers/net/cxgb3/l2t.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb3/l2t.c	2010-04-13 02:19:01.104633051 +0000
@@ -34,6 +34,7 @@
 #include <linux/if.h>
 #include <linux/if_vlan.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 #include <net/neighbour.h>
 #include "common.h"
 #include "t3cdev.h"
diff -urN linux-2.6.34-rc3/drivers/net/cxgb3/sge.c linux-2.6.34-rc4/drivers/net/cxgb3/sge.c
--- linux-2.6.34-rc3/drivers/net/cxgb3/sge.c	2010-04-13 02:18:55.904633016 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb3/sge.c	2010-04-13 02:19:01.105633063 +0000
@@ -36,6 +36,7 @@
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include "common.h"
 #include "regs.h"
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/Makefile linux-2.6.34-rc4/drivers/net/cxgb4/Makefile
--- linux-2.6.34-rc3/drivers/net/cxgb4/Makefile	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/Makefile	2010-04-13 02:19:01.106633066 +0000
@@ -0,0 +1,7 @@
+#
+# Chelsio T4 driver
+#
+
+obj-$(CONFIG_CHELSIO_T4) += cxgb4.o
+
+cxgb4-objs := cxgb4_main.o l2t.o t4_hw.o sge.o
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4.h linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4.h	2010-04-13 02:19:01.106633066 +0000
@@ -0,0 +1,741 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __CXGB4_H__
+#define __CXGB4_H__
+
+#include <linux/bitops.h>
+#include <linux/cache.h>
+#include <linux/interrupt.h>
+#include <linux/list.h>
+#include <linux/netdevice.h>
+#include <linux/pci.h>
+#include <linux/spinlock.h>
+#include <linux/timer.h>
+#include <asm/io.h>
+#include "cxgb4_uld.h"
+#include "t4_hw.h"
+
+#define FW_VERSION_MAJOR 1
+#define FW_VERSION_MINOR 1
+#define FW_VERSION_MICRO 0
+
+enum {
+	MAX_NPORTS = 4,     /* max # of ports */
+	SERNUM_LEN = 16,    /* Serial # length */
+	EC_LEN     = 16,    /* E/C length */
+	ID_LEN     = 16,    /* ID length */
+};
+
+enum {
+	MEM_EDC0,
+	MEM_EDC1,
+	MEM_MC
+};
+
+enum dev_master {
+	MASTER_CANT,
+	MASTER_MAY,
+	MASTER_MUST
+};
+
+enum dev_state {
+	DEV_STATE_UNINIT,
+	DEV_STATE_INIT,
+	DEV_STATE_ERR
+};
+
+enum {
+	PAUSE_RX      = 1 << 0,
+	PAUSE_TX      = 1 << 1,
+	PAUSE_AUTONEG = 1 << 2
+};
+
+struct port_stats {
+	u64 tx_octets;            /* total # of octets in good frames */
+	u64 tx_frames;            /* all good frames */
+	u64 tx_bcast_frames;      /* all broadcast frames */
+	u64 tx_mcast_frames;      /* all multicast frames */
+	u64 tx_ucast_frames;      /* all unicast frames */
+	u64 tx_error_frames;      /* all error frames */
+
+	u64 tx_frames_64;         /* # of Tx frames in a particular range */
+	u64 tx_frames_65_127;
+	u64 tx_frames_128_255;
+	u64 tx_frames_256_511;
+	u64 tx_frames_512_1023;
+	u64 tx_frames_1024_1518;
+	u64 tx_frames_1519_max;
+
+	u64 tx_drop;              /* # of dropped Tx frames */
+	u64 tx_pause;             /* # of transmitted pause frames */
+	u64 tx_ppp0;              /* # of transmitted PPP prio 0 frames */
+	u64 tx_ppp1;              /* # of transmitted PPP prio 1 frames */
+	u64 tx_ppp2;              /* # of transmitted PPP prio 2 frames */
+	u64 tx_ppp3;              /* # of transmitted PPP prio 3 frames */
+	u64 tx_ppp4;              /* # of transmitted PPP prio 4 frames */
+	u64 tx_ppp5;              /* # of transmitted PPP prio 5 frames */
+	u64 tx_ppp6;              /* # of transmitted PPP prio 6 frames */
+	u64 tx_ppp7;              /* # of transmitted PPP prio 7 frames */
+
+	u64 rx_octets;            /* total # of octets in good frames */
+	u64 rx_frames;            /* all good frames */
+	u64 rx_bcast_frames;      /* all broadcast frames */
+	u64 rx_mcast_frames;      /* all multicast frames */
+	u64 rx_ucast_frames;      /* all unicast frames */
+	u64 rx_too_long;          /* # of frames exceeding MTU */
+	u64 rx_jabber;            /* # of jabber frames */
+	u64 rx_fcs_err;           /* # of received frames with bad FCS */
+	u64 rx_len_err;           /* # of received frames with length error */
+	u64 rx_symbol_err;        /* symbol errors */
+	u64 rx_runt;              /* # of short frames */
+
+	u64 rx_frames_64;         /* # of Rx frames in a particular range */
+	u64 rx_frames_65_127;
+	u64 rx_frames_128_255;
+	u64 rx_frames_256_511;
+	u64 rx_frames_512_1023;
+	u64 rx_frames_1024_1518;
+	u64 rx_frames_1519_max;
+
+	u64 rx_pause;             /* # of received pause frames */
+	u64 rx_ppp0;              /* # of received PPP prio 0 frames */
+	u64 rx_ppp1;              /* # of received PPP prio 1 frames */
+	u64 rx_ppp2;              /* # of received PPP prio 2 frames */
+	u64 rx_ppp3;              /* # of received PPP prio 3 frames */
+	u64 rx_ppp4;              /* # of received PPP prio 4 frames */
+	u64 rx_ppp5;              /* # of received PPP prio 5 frames */
+	u64 rx_ppp6;              /* # of received PPP prio 6 frames */
+	u64 rx_ppp7;              /* # of received PPP prio 7 frames */
+
+	u64 rx_ovflow0;           /* drops due to buffer-group 0 overflows */
+	u64 rx_ovflow1;           /* drops due to buffer-group 1 overflows */
+	u64 rx_ovflow2;           /* drops due to buffer-group 2 overflows */
+	u64 rx_ovflow3;           /* drops due to buffer-group 3 overflows */
+	u64 rx_trunc0;            /* buffer-group 0 truncated packets */
+	u64 rx_trunc1;            /* buffer-group 1 truncated packets */
+	u64 rx_trunc2;            /* buffer-group 2 truncated packets */
+	u64 rx_trunc3;            /* buffer-group 3 truncated packets */
+};
+
+struct lb_port_stats {
+	u64 octets;
+	u64 frames;
+	u64 bcast_frames;
+	u64 mcast_frames;
+	u64 ucast_frames;
+	u64 error_frames;
+
+	u64 frames_64;
+	u64 frames_65_127;
+	u64 frames_128_255;
+	u64 frames_256_511;
+	u64 frames_512_1023;
+	u64 frames_1024_1518;
+	u64 frames_1519_max;
+
+	u64 drop;
+
+	u64 ovflow0;
+	u64 ovflow1;
+	u64 ovflow2;
+	u64 ovflow3;
+	u64 trunc0;
+	u64 trunc1;
+	u64 trunc2;
+	u64 trunc3;
+};
+
+struct tp_tcp_stats {
+	u32 tcpOutRsts;
+	u64 tcpInSegs;
+	u64 tcpOutSegs;
+	u64 tcpRetransSegs;
+};
+
+struct tp_err_stats {
+	u32 macInErrs[4];
+	u32 hdrInErrs[4];
+	u32 tcpInErrs[4];
+	u32 tnlCongDrops[4];
+	u32 ofldChanDrops[4];
+	u32 tnlTxDrops[4];
+	u32 ofldVlanDrops[4];
+	u32 tcp6InErrs[4];
+	u32 ofldNoNeigh;
+	u32 ofldCongDefer;
+};
+
+struct tp_params {
+	unsigned int ntxchan;        /* # of Tx channels */
+	unsigned int tre;            /* log2 of core clocks per TP tick */
+};
+
+struct vpd_params {
+	unsigned int cclk;
+	u8 ec[EC_LEN + 1];
+	u8 sn[SERNUM_LEN + 1];
+	u8 id[ID_LEN + 1];
+};
+
+struct pci_params {
+	unsigned char speed;
+	unsigned char width;
+};
+
+struct adapter_params {
+	struct tp_params  tp;
+	struct vpd_params vpd;
+	struct pci_params pci;
+
+	unsigned int fw_vers;
+	unsigned int tp_vers;
+	u8 api_vers[7];
+
+	unsigned short mtus[NMTUS];
+	unsigned short a_wnd[NCCTRL_WIN];
+	unsigned short b_wnd[NCCTRL_WIN];
+
+	unsigned char nports;             /* # of ethernet ports */
+	unsigned char portvec;
+	unsigned char rev;                /* chip revision */
+	unsigned char offload;
+
+	unsigned int ofldq_wr_cred;
+};
+
+struct trace_params {
+	u32 data[TRACE_LEN / 4];
+	u32 mask[TRACE_LEN / 4];
+	unsigned short snap_len;
+	unsigned short min_len;
+	unsigned char skip_ofst;
+	unsigned char skip_len;
+	unsigned char invert;
+	unsigned char port;
+};
+
+struct link_config {
+	unsigned short supported;        /* link capabilities */
+	unsigned short advertising;      /* advertised capabilities */
+	unsigned short requested_speed;  /* speed user has requested */
+	unsigned short speed;            /* actual link speed */
+	unsigned char  requested_fc;     /* flow control user has requested */
+	unsigned char  fc;               /* actual link flow control */
+	unsigned char  autoneg;          /* autonegotiating? */
+	unsigned char  link_ok;          /* link up? */
+};
+
+#define FW_LEN16(fw_struct) FW_CMD_LEN16(sizeof(fw_struct) / 16)
+
+enum {
+	MAX_ETH_QSETS = 32,           /* # of Ethernet Tx/Rx queue sets */
+	MAX_OFLD_QSETS = 16,          /* # of offload Tx/Rx queue sets */
+	MAX_CTRL_QUEUES = NCHAN,      /* # of control Tx queues */
+	MAX_RDMA_QUEUES = NCHAN,      /* # of streaming RDMA Rx queues */
+};
+
+enum {
+	MAX_EGRQ = 128,         /* max # of egress queues, including FLs */
+	MAX_INGQ = 64           /* max # of interrupt-capable ingress queues */
+};
+
+struct adapter;
+struct vlan_group;
+struct sge_rspq;
+
+struct port_info {
+	struct adapter *adapter;
+	struct vlan_group *vlan_grp;
+	u16    viid;
+	s16    xact_addr_filt;        /* index of exact MAC address filter */
+	u16    rss_size;              /* size of VI's RSS table slice */
+	s8     mdio_addr;
+	u8     port_type;
+	u8     mod_type;
+	u8     port_id;
+	u8     tx_chan;
+	u8     lport;                 /* associated offload logical port */
+	u8     rx_offload;            /* CSO, etc */
+	u8     nqsets;                /* # of qsets */
+	u8     first_qset;            /* index of first qset */
+	struct link_config link_cfg;
+};
+
+/* port_info.rx_offload flags */
+enum {
+	RX_CSO = 1 << 0,
+};
+
+struct dentry;
+struct work_struct;
+
+enum {                                 /* adapter flags */
+	FULL_INIT_DONE     = (1 << 0),
+	USING_MSI          = (1 << 1),
+	USING_MSIX         = (1 << 2),
+	QUEUES_BOUND       = (1 << 3),
+	FW_OK              = (1 << 4),
+};
+
+struct rx_sw_desc;
+
+struct sge_fl {                     /* SGE free-buffer queue state */
+	unsigned int avail;         /* # of available Rx buffers */
+	unsigned int pend_cred;     /* new buffers since last FL DB ring */
+	unsigned int cidx;          /* consumer index */
+	unsigned int pidx;          /* producer index */
+	unsigned long alloc_failed; /* # of times buffer allocation failed */
+	unsigned long large_alloc_failed;
+	unsigned long starving;
+	/* RO fields */
+	unsigned int cntxt_id;      /* SGE context id for the free list */
+	unsigned int size;          /* capacity of free list */
+	struct rx_sw_desc *sdesc;   /* address of SW Rx descriptor ring */
+	__be64 *desc;               /* address of HW Rx descriptor ring */
+	dma_addr_t addr;            /* bus address of HW ring start */
+};
+
+/* A packet gather list */
+struct pkt_gl {
+	skb_frag_t frags[MAX_SKB_FRAGS];
+	void *va;                         /* virtual address of first byte */
+	unsigned int nfrags;              /* # of fragments */
+	unsigned int tot_len;             /* total length of fragments */
+};
+
+typedef int (*rspq_handler_t)(struct sge_rspq *q, const __be64 *rsp,
+			      const struct pkt_gl *gl);
+
+struct sge_rspq {                   /* state for an SGE response queue */
+	struct napi_struct napi;
+	const __be64 *cur_desc;     /* current descriptor in queue */
+	unsigned int cidx;          /* consumer index */
+	u8 gen;                     /* current generation bit */
+	u8 intr_params;             /* interrupt holdoff parameters */
+	u8 next_intr_params;        /* holdoff params for next interrupt */
+	u8 pktcnt_idx;              /* interrupt packet threshold */
+	u8 uld;                     /* ULD handling this queue */
+	u8 idx;                     /* queue index within its group */
+	int offset;                 /* offset into current Rx buffer */
+	u16 cntxt_id;               /* SGE context id for the response q */
+	u16 abs_id;                 /* absolute SGE id for the response q */
+	__be64 *desc;               /* address of HW response ring */
+	dma_addr_t phys_addr;       /* physical address of the ring */
+	unsigned int iqe_len;       /* entry size */
+	unsigned int size;          /* capacity of response queue */
+	struct adapter *adap;
+	struct net_device *netdev;  /* associated net device */
+	rspq_handler_t handler;
+};
+
+struct sge_eth_stats {              /* Ethernet queue statistics */
+	unsigned long pkts;         /* # of ethernet packets */
+	unsigned long lro_pkts;     /* # of LRO super packets */
+	unsigned long lro_merged;   /* # of wire packets merged by LRO */
+	unsigned long rx_cso;       /* # of Rx checksum offloads */
+	unsigned long vlan_ex;      /* # of Rx VLAN extractions */
+	unsigned long rx_drops;     /* # of packets dropped due to no mem */
+};
+
+struct sge_eth_rxq {                /* SW Ethernet Rx queue */
+	struct sge_rspq rspq;
+	struct sge_fl fl;
+	struct sge_eth_stats stats;
+} ____cacheline_aligned_in_smp;
+
+struct sge_ofld_stats {             /* offload queue statistics */
+	unsigned long pkts;         /* # of packets */
+	unsigned long imm;          /* # of immediate-data packets */
+	unsigned long an;           /* # of asynchronous notifications */
+	unsigned long nomem;        /* # of responses deferred due to no mem */
+};
+
+struct sge_ofld_rxq {               /* SW offload Rx queue */
+	struct sge_rspq rspq;
+	struct sge_fl fl;
+	struct sge_ofld_stats stats;
+} ____cacheline_aligned_in_smp;
+
+struct tx_desc {
+	__be64 flit[8];
+};
+
+struct tx_sw_desc;
+
+struct sge_txq {
+	unsigned int  in_use;       /* # of in-use Tx descriptors */
+	unsigned int  size;         /* # of descriptors */
+	unsigned int  cidx;         /* SW consumer index */
+	unsigned int  pidx;         /* producer index */
+	unsigned long stops;        /* # of times q has been stopped */
+	unsigned long restarts;     /* # of queue restarts */
+	unsigned int  cntxt_id;     /* SGE context id for the Tx q */
+	struct tx_desc *desc;       /* address of HW Tx descriptor ring */
+	struct tx_sw_desc *sdesc;   /* address of SW Tx descriptor ring */
+	struct sge_qstat *stat;     /* queue status entry */
+	dma_addr_t    phys_addr;    /* physical address of the ring */
+};
+
+struct sge_eth_txq {                /* state for an SGE Ethernet Tx queue */
+	struct sge_txq q;
+	struct netdev_queue *txq;   /* associated netdev TX queue */
+	unsigned long tso;          /* # of TSO requests */
+	unsigned long tx_cso;       /* # of Tx checksum offloads */
+	unsigned long vlan_ins;     /* # of Tx VLAN insertions */
+	unsigned long mapping_err;  /* # of I/O MMU packet mapping errors */
+} ____cacheline_aligned_in_smp;
+
+struct sge_ofld_txq {               /* state for an SGE offload Tx queue */
+	struct sge_txq q;
+	struct adapter *adap;
+	struct sk_buff_head sendq;  /* list of backpressured packets */
+	struct tasklet_struct qresume_tsk; /* restarts the queue */
+	u8 full;                    /* the Tx ring is full */
+	unsigned long mapping_err;  /* # of I/O MMU packet mapping errors */
+} ____cacheline_aligned_in_smp;
+
+struct sge_ctrl_txq {               /* state for an SGE control Tx queue */
+	struct sge_txq q;
+	struct adapter *adap;
+	struct sk_buff_head sendq;  /* list of backpressured packets */
+	struct tasklet_struct qresume_tsk; /* restarts the queue */
+	u8 full;                    /* the Tx ring is full */
+} ____cacheline_aligned_in_smp;
+
+struct sge {
+	struct sge_eth_txq ethtxq[MAX_ETH_QSETS];
+	struct sge_ofld_txq ofldtxq[MAX_OFLD_QSETS];
+	struct sge_ctrl_txq ctrlq[MAX_CTRL_QUEUES];
+
+	struct sge_eth_rxq ethrxq[MAX_ETH_QSETS];
+	struct sge_ofld_rxq ofldrxq[MAX_OFLD_QSETS];
+	struct sge_ofld_rxq rdmarxq[MAX_RDMA_QUEUES];
+	struct sge_rspq fw_evtq ____cacheline_aligned_in_smp;
+
+	struct sge_rspq intrq ____cacheline_aligned_in_smp;
+	spinlock_t intrq_lock;
+
+	u16 max_ethqsets;           /* # of available Ethernet queue sets */
+	u16 ethqsets;               /* # of active Ethernet queue sets */
+	u16 ethtxq_rover;           /* Tx queue to clean up next */
+	u16 ofldqsets;              /* # of active offload queue sets */
+	u16 rdmaqs;                 /* # of available RDMA Rx queues */
+	u16 ofld_rxq[MAX_OFLD_QSETS];
+	u16 rdma_rxq[NCHAN];
+	u16 timer_val[SGE_NTIMERS];
+	u8 counter_val[SGE_NCOUNTERS];
+	unsigned int starve_thres;
+	u8 idma_state[2];
+	void *egr_map[MAX_EGRQ];    /* qid->queue egress queue map */
+	struct sge_rspq *ingr_map[MAX_INGQ]; /* qid->queue ingress queue map */
+	DECLARE_BITMAP(starving_fl, MAX_EGRQ);
+	DECLARE_BITMAP(txq_maperr, MAX_EGRQ);
+	struct timer_list rx_timer; /* refills starving FLs */
+	struct timer_list tx_timer; /* checks Tx queues */
+};
+
+#define for_each_ethrxq(sge, i) for (i = 0; i < (sge)->ethqsets; i++)
+#define for_each_ofldrxq(sge, i) for (i = 0; i < (sge)->ofldqsets; i++)
+#define for_each_rdmarxq(sge, i) for (i = 0; i < (sge)->rdmaqs; i++)
+
+struct l2t_data;
+
+struct adapter {
+	void __iomem *regs;
+	struct pci_dev *pdev;
+	struct device *pdev_dev;
+	unsigned long registered_device_map;
+	unsigned long open_device_map;
+	unsigned long flags;
+
+	const char *name;
+	int msg_enable;
+
+	struct adapter_params params;
+	struct cxgb4_virt_res vres;
+	unsigned int swintr;
+
+	unsigned int wol;
+
+	struct {
+		unsigned short vec;
+		char desc[14];
+	} msix_info[MAX_INGQ + 1];
+
+	struct sge sge;
+
+	struct net_device *port[MAX_NPORTS];
+	u8 chan_map[NCHAN];                   /* channel -> port map */
+
+	struct l2t_data *l2t;
+	void *uld_handle[CXGB4_ULD_MAX];
+	struct list_head list_node;
+
+	struct tid_info tids;
+	void **tid_release_head;
+	spinlock_t tid_release_lock;
+	struct work_struct tid_release_task;
+	bool tid_release_task_busy;
+
+	struct dentry *debugfs_root;
+
+	spinlock_t stats_lock;
+};
+
+static inline u32 t4_read_reg(struct adapter *adap, u32 reg_addr)
+{
+	return readl(adap->regs + reg_addr);
+}
+
+static inline void t4_write_reg(struct adapter *adap, u32 reg_addr, u32 val)
+{
+	writel(val, adap->regs + reg_addr);
+}
+
+#ifndef readq
+static inline u64 readq(const volatile void __iomem *addr)
+{
+	return readl(addr) + ((u64)readl(addr + 4) << 32);
+}
+
+static inline void writeq(u64 val, volatile void __iomem *addr)
+{
+	writel(val, addr);
+	writel(val >> 32, addr + 4);
+}
+#endif
+
+static inline u64 t4_read_reg64(struct adapter *adap, u32 reg_addr)
+{
+	return readq(adap->regs + reg_addr);
+}
+
+static inline void t4_write_reg64(struct adapter *adap, u32 reg_addr, u64 val)
+{
+	writeq(val, adap->regs + reg_addr);
+}
+
+/**
+ * netdev2pinfo - return the port_info structure associated with a net_device
+ * @dev: the netdev
+ *
+ * Return the struct port_info associated with a net_device
+ */
+static inline struct port_info *netdev2pinfo(const struct net_device *dev)
+{
+	return netdev_priv(dev);
+}
+
+/**
+ * adap2pinfo - return the port_info of a port
+ * @adap: the adapter
+ * @idx: the port index
+ *
+ * Return the port_info structure for the port of the given index.
+ */
+static inline struct port_info *adap2pinfo(struct adapter *adap, int idx)
+{
+	return netdev_priv(adap->port[idx]);
+}
+
+/**
+ * netdev2adap - return the adapter structure associated with a net_device
+ * @dev: the netdev
+ *
+ * Return the struct adapter associated with a net_device
+ */
+static inline struct adapter *netdev2adap(const struct net_device *dev)
+{
+	return netdev2pinfo(dev)->adapter;
+}
+
+void t4_os_portmod_changed(const struct adapter *adap, int port_id);
+void t4_os_link_changed(struct adapter *adap, int port_id, int link_stat);
+
+void *t4_alloc_mem(size_t size);
+void t4_free_mem(void *addr);
+
+void t4_free_sge_resources(struct adapter *adap);
+irq_handler_t t4_intr_handler(struct adapter *adap);
+netdev_tx_t t4_eth_xmit(struct sk_buff *skb, struct net_device *dev);
+int t4_ethrx_handler(struct sge_rspq *q, const __be64 *rsp,
+		     const struct pkt_gl *gl);
+int t4_mgmt_tx(struct adapter *adap, struct sk_buff *skb);
+int t4_ofld_send(struct adapter *adap, struct sk_buff *skb);
+int t4_sge_alloc_rxq(struct adapter *adap, struct sge_rspq *iq, bool fwevtq,
+		     struct net_device *dev, int intr_idx,
+		     struct sge_fl *fl, rspq_handler_t hnd);
+int t4_sge_alloc_eth_txq(struct adapter *adap, struct sge_eth_txq *txq,
+			 struct net_device *dev, struct netdev_queue *netdevq,
+			 unsigned int iqid);
+int t4_sge_alloc_ctrl_txq(struct adapter *adap, struct sge_ctrl_txq *txq,
+			  struct net_device *dev, unsigned int iqid,
+			  unsigned int cmplqid);
+int t4_sge_alloc_ofld_txq(struct adapter *adap, struct sge_ofld_txq *txq,
+			  struct net_device *dev, unsigned int iqid);
+irqreturn_t t4_sge_intr_msix(int irq, void *cookie);
+void t4_sge_init(struct adapter *adap);
+void t4_sge_start(struct adapter *adap);
+void t4_sge_stop(struct adapter *adap);
+
+#define for_each_port(adapter, iter) \
+	for (iter = 0; iter < (adapter)->params.nports; ++iter)
+
+static inline unsigned int core_ticks_per_usec(const struct adapter *adap)
+{
+	return adap->params.vpd.cclk / 1000;
+}
+
+static inline unsigned int us_to_core_ticks(const struct adapter *adap,
+					    unsigned int us)
+{
+	return (us * adap->params.vpd.cclk) / 1000;
+}
+
+void t4_set_reg_field(struct adapter *adap, unsigned int addr, u32 mask,
+		      u32 val);
+
+int t4_wr_mbox_meat(struct adapter *adap, int mbox, const void *cmd, int size,
+		    void *rpl, bool sleep_ok);
+
+static inline int t4_wr_mbox(struct adapter *adap, int mbox, const void *cmd,
+			     int size, void *rpl)
+{
+	return t4_wr_mbox_meat(adap, mbox, cmd, size, rpl, true);
+}
+
+static inline int t4_wr_mbox_ns(struct adapter *adap, int mbox, const void *cmd,
+				int size, void *rpl)
+{
+	return t4_wr_mbox_meat(adap, mbox, cmd, size, rpl, false);
+}
+
+void t4_intr_enable(struct adapter *adapter);
+void t4_intr_disable(struct adapter *adapter);
+void t4_intr_clear(struct adapter *adapter);
+int t4_slow_intr_handler(struct adapter *adapter);
+
+int t4_link_start(struct adapter *adap, unsigned int mbox, unsigned int port,
+		  struct link_config *lc);
+int t4_restart_aneg(struct adapter *adap, unsigned int mbox, unsigned int port);
+int t4_seeprom_wp(struct adapter *adapter, bool enable);
+int t4_read_flash(struct adapter *adapter, unsigned int addr,
+		  unsigned int nwords, u32 *data, int byte_oriented);
+int t4_load_fw(struct adapter *adapter, const u8 *fw_data, unsigned int size);
+int t4_check_fw_version(struct adapter *adapter);
+int t4_prep_adapter(struct adapter *adapter);
+int t4_port_init(struct adapter *adap, int mbox, int pf, int vf);
+void t4_fatal_err(struct adapter *adapter);
+void t4_set_vlan_accel(struct adapter *adapter, unsigned int ports, int on);
+int t4_set_trace_filter(struct adapter *adapter, const struct trace_params *tp,
+			int filter_index, int enable);
+void t4_get_trace_filter(struct adapter *adapter, struct trace_params *tp,
+			 int filter_index, int *enabled);
+int t4_config_rss_range(struct adapter *adapter, int mbox, unsigned int viid,
+			int start, int n, const u16 *rspq, unsigned int nrspq);
+int t4_config_glbl_rss(struct adapter *adapter, int mbox, unsigned int mode,
+		       unsigned int flags);
+int t4_read_rss(struct adapter *adapter, u16 *entries);
+int t4_mc_read(struct adapter *adap, u32 addr, __be32 *data, u64 *parity);
+int t4_edc_read(struct adapter *adap, int idx, u32 addr, __be32 *data,
+		u64 *parity);
+
+void t4_get_port_stats(struct adapter *adap, int idx, struct port_stats *p);
+void t4_get_lb_stats(struct adapter *adap, int idx, struct lb_port_stats *p);
+
+void t4_read_mtu_tbl(struct adapter *adap, u16 *mtus, u8 *mtu_log);
+void t4_tp_get_err_stats(struct adapter *adap, struct tp_err_stats *st);
+void t4_tp_get_tcp_stats(struct adapter *adap, struct tp_tcp_stats *v4,
+			 struct tp_tcp_stats *v6);
+void t4_load_mtus(struct adapter *adap, const unsigned short *mtus,
+		  const unsigned short *alpha, const unsigned short *beta);
+
+void t4_wol_magic_enable(struct adapter *adap, unsigned int port,
+			 const u8 *addr);
+int t4_wol_pat_enable(struct adapter *adap, unsigned int port, unsigned int map,
+		      u64 mask0, u64 mask1, unsigned int crc, bool enable);
+
+int t4_fw_hello(struct adapter *adap, unsigned int mbox, unsigned int evt_mbox,
+		enum dev_master master, enum dev_state *state);
+int t4_fw_bye(struct adapter *adap, unsigned int mbox);
+int t4_early_init(struct adapter *adap, unsigned int mbox);
+int t4_fw_reset(struct adapter *adap, unsigned int mbox, int reset);
+int t4_query_params(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int nparams, const u32 *params,
+		    u32 *val);
+int t4_set_params(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		  unsigned int vf, unsigned int nparams, const u32 *params,
+		  const u32 *val);
+int t4_cfg_pfvf(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		unsigned int vf, unsigned int txq, unsigned int txq_eth_ctrl,
+		unsigned int rxqi, unsigned int rxq, unsigned int tc,
+		unsigned int vi, unsigned int cmask, unsigned int pmask,
+		unsigned int nexact, unsigned int rcaps, unsigned int wxcaps);
+int t4_alloc_vi(struct adapter *adap, unsigned int mbox, unsigned int port,
+		unsigned int pf, unsigned int vf, unsigned int nmac, u8 *mac,
+		unsigned int *rss_size);
+int t4_free_vi(struct adapter *adap, unsigned int mbox, unsigned int pf,
+	       unsigned int vf, unsigned int viid);
+int t4_set_rxmode(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		int mtu, int promisc, int all_multi, int bcast, bool sleep_ok);
+int t4_alloc_mac_filt(struct adapter *adap, unsigned int mbox,
+		      unsigned int viid, bool free, unsigned int naddr,
+		      const u8 **addr, u16 *idx, u64 *hash, bool sleep_ok);
+int t4_change_mac(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		  int idx, const u8 *addr, bool persist, bool add_smt);
+int t4_set_addr_hash(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		     bool ucast, u64 vec, bool sleep_ok);
+int t4_enable_vi(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		 bool rx_en, bool tx_en);
+int t4_identify_port(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		     unsigned int nblinks);
+int t4_mdio_rd(struct adapter *adap, unsigned int mbox, unsigned int phy_addr,
+	       unsigned int mmd, unsigned int reg, u16 *valp);
+int t4_mdio_wr(struct adapter *adap, unsigned int mbox, unsigned int phy_addr,
+	       unsigned int mmd, unsigned int reg, u16 val);
+int t4_iq_start_stop(struct adapter *adap, unsigned int mbox, bool start,
+		     unsigned int pf, unsigned int vf, unsigned int iqid,
+		     unsigned int fl0id, unsigned int fl1id);
+int t4_iq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+	       unsigned int vf, unsigned int iqtype, unsigned int iqid,
+	       unsigned int fl0id, unsigned int fl1id);
+int t4_eth_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		   unsigned int vf, unsigned int eqid);
+int t4_ctrl_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int eqid);
+int t4_ofld_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int eqid);
+int t4_handle_fw_rpl(struct adapter *adap, const __be64 *rpl);
+#endif /* __CXGB4_H__ */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4_main.c linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4_main.c
--- linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4_main.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4_main.c	2010-04-13 02:19:01.107633078 +0000
@@ -0,0 +1,3388 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
+
+#include <linux/bitmap.h>
+#include <linux/crc32.h>
+#include <linux/ctype.h>
+#include <linux/debugfs.h>
+#include <linux/err.h>
+#include <linux/etherdevice.h>
+#include <linux/firmware.h>
+#include <linux/if_vlan.h>
+#include <linux/init.h>
+#include <linux/log2.h>
+#include <linux/mdio.h>
+#include <linux/module.h>
+#include <linux/moduleparam.h>
+#include <linux/mutex.h>
+#include <linux/netdevice.h>
+#include <linux/pci.h>
+#include <linux/aer.h>
+#include <linux/rtnetlink.h>
+#include <linux/sched.h>
+#include <linux/seq_file.h>
+#include <linux/sockios.h>
+#include <linux/vmalloc.h>
+#include <linux/workqueue.h>
+#include <net/neighbour.h>
+#include <net/netevent.h>
+#include <asm/uaccess.h>
+
+#include "cxgb4.h"
+#include "t4_regs.h"
+#include "t4_msg.h"
+#include "t4fw_api.h"
+#include "l2t.h"
+
+#define DRV_VERSION "1.0.0-ko"
+#define DRV_DESC "Chelsio T4 Network Driver"
+
+/*
+ * Max interrupt hold-off timer value in us.  Queues fall back to this value
+ * under extreme memory pressure so it's largish to give the system time to
+ * recover.
+ */
+#define MAX_SGE_TIMERVAL 200U
+
+enum {
+	MEMWIN0_APERTURE = 65536,
+	MEMWIN0_BASE     = 0x30000,
+	MEMWIN1_APERTURE = 32768,
+	MEMWIN1_BASE     = 0x28000,
+	MEMWIN2_APERTURE = 2048,
+	MEMWIN2_BASE     = 0x1b800,
+};
+
+enum {
+	MAX_TXQ_ENTRIES      = 16384,
+	MAX_CTRL_TXQ_ENTRIES = 1024,
+	MAX_RSPQ_ENTRIES     = 16384,
+	MAX_RX_BUFFERS       = 16384,
+	MIN_TXQ_ENTRIES      = 32,
+	MIN_CTRL_TXQ_ENTRIES = 32,
+	MIN_RSPQ_ENTRIES     = 128,
+	MIN_FL_ENTRIES       = 16
+};
+
+#define DFLT_MSG_ENABLE (NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_LINK | \
+			 NETIF_MSG_TIMER | NETIF_MSG_IFDOWN | NETIF_MSG_IFUP |\
+			 NETIF_MSG_RX_ERR | NETIF_MSG_TX_ERR)
+
+#define CH_DEVICE(devid) { PCI_VDEVICE(CHELSIO, devid), 0 }
+
+static DEFINE_PCI_DEVICE_TABLE(cxgb4_pci_tbl) = {
+	CH_DEVICE(0xa000),  /* PE10K */
+	{ 0, }
+};
+
+#define FW_FNAME "cxgb4/t4fw.bin"
+
+MODULE_DESCRIPTION(DRV_DESC);
+MODULE_AUTHOR("Chelsio Communications");
+MODULE_LICENSE("Dual BSD/GPL");
+MODULE_VERSION(DRV_VERSION);
+MODULE_DEVICE_TABLE(pci, cxgb4_pci_tbl);
+MODULE_FIRMWARE(FW_FNAME);
+
+static int dflt_msg_enable = DFLT_MSG_ENABLE;
+
+module_param(dflt_msg_enable, int, 0644);
+MODULE_PARM_DESC(dflt_msg_enable, "Chelsio T4 default message enable bitmap");
+
+/*
+ * The driver uses the best interrupt scheme available on a platform in the
+ * order MSI-X, MSI, legacy INTx interrupts.  This parameter determines which
+ * of these schemes the driver may consider as follows:
+ *
+ * msi = 2: choose from among all three options
+ * msi = 1: only consider MSI and INTx interrupts
+ * msi = 0: force INTx interrupts
+ */
+static int msi = 2;
+
+module_param(msi, int, 0644);
+MODULE_PARM_DESC(msi, "whether to use INTx (0), MSI (1) or MSI-X (2)");
+
+/*
+ * Queue interrupt hold-off timer values.  Queues default to the first of these
+ * upon creation.
+ */
+static unsigned int intr_holdoff[SGE_NTIMERS - 1] = { 5, 10, 20, 50, 100 };
+
+module_param_array(intr_holdoff, uint, NULL, 0644);
+MODULE_PARM_DESC(intr_holdoff, "values for queue interrupt hold-off timers "
+		 "0..4 in microseconds");
+
+static unsigned int intr_cnt[SGE_NCOUNTERS - 1] = { 4, 8, 16 };
+
+module_param_array(intr_cnt, uint, NULL, 0644);
+MODULE_PARM_DESC(intr_cnt,
+		 "thresholds 1..3 for queue interrupt packet counters");
+
+static int vf_acls;
+
+#ifdef CONFIG_PCI_IOV
+module_param(vf_acls, bool, 0644);
+MODULE_PARM_DESC(vf_acls, "if set enable virtualization L2 ACL enforcement");
+
+static unsigned int num_vf[4];
+
+module_param_array(num_vf, uint, NULL, 0644);
+MODULE_PARM_DESC(num_vf, "number of VFs for each of PFs 0-3");
+#endif
+
+static struct dentry *cxgb4_debugfs_root;
+
+static LIST_HEAD(adapter_list);
+static DEFINE_MUTEX(uld_mutex);
+static struct cxgb4_uld_info ulds[CXGB4_ULD_MAX];
+static const char *uld_str[] = { "RDMA", "iSCSI" };
+
+static void link_report(struct net_device *dev)
+{
+	if (!netif_carrier_ok(dev))
+		netdev_info(dev, "link down\n");
+	else {
+		static const char *fc[] = { "no", "Rx", "Tx", "Tx/Rx" };
+
+		const char *s = "10Mbps";
+		const struct port_info *p = netdev_priv(dev);
+
+		switch (p->link_cfg.speed) {
+		case SPEED_10000:
+			s = "10Gbps";
+			break;
+		case SPEED_1000:
+			s = "1000Mbps";
+			break;
+		case SPEED_100:
+			s = "100Mbps";
+			break;
+		}
+
+		netdev_info(dev, "link up, %s, full-duplex, %s PAUSE\n", s,
+			    fc[p->link_cfg.fc]);
+	}
+}
+
+void t4_os_link_changed(struct adapter *adapter, int port_id, int link_stat)
+{
+	struct net_device *dev = adapter->port[port_id];
+
+	/* Skip changes from disabled ports. */
+	if (netif_running(dev) && link_stat != netif_carrier_ok(dev)) {
+		if (link_stat)
+			netif_carrier_on(dev);
+		else
+			netif_carrier_off(dev);
+
+		link_report(dev);
+	}
+}
+
+void t4_os_portmod_changed(const struct adapter *adap, int port_id)
+{
+	static const char *mod_str[] = {
+		NULL, "LR", "SR", "ER", "passive DA", "active DA"
+	};
+
+	const struct net_device *dev = adap->port[port_id];
+	const struct port_info *pi = netdev_priv(dev);
+
+	if (pi->mod_type == FW_PORT_MOD_TYPE_NONE)
+		netdev_info(dev, "port module unplugged\n");
+	else
+		netdev_info(dev, "%s module inserted\n", mod_str[pi->mod_type]);
+}
+
+/*
+ * Configure the exact and hash address filters to handle a port's multicast
+ * and secondary unicast MAC addresses.
+ */
+static int set_addr_filters(const struct net_device *dev, bool sleep)
+{
+	u64 mhash = 0;
+	u64 uhash = 0;
+	bool free = true;
+	u16 filt_idx[7];
+	const u8 *addr[7];
+	int ret, naddr = 0;
+	const struct dev_addr_list *d;
+	const struct netdev_hw_addr *ha;
+	int uc_cnt = netdev_uc_count(dev);
+	const struct port_info *pi = netdev_priv(dev);
+
+	/* first do the secondary unicast addresses */
+	netdev_for_each_uc_addr(ha, dev) {
+		addr[naddr++] = ha->addr;
+		if (--uc_cnt == 0 || naddr >= ARRAY_SIZE(addr)) {
+			ret = t4_alloc_mac_filt(pi->adapter, 0, pi->viid, free,
+					naddr, addr, filt_idx, &uhash, sleep);
+			if (ret < 0)
+				return ret;
+
+			free = false;
+			naddr = 0;
+		}
+	}
+
+	/* next set up the multicast addresses */
+	netdev_for_each_mc_addr(d, dev) {
+		addr[naddr++] = d->dmi_addr;
+		if (naddr >= ARRAY_SIZE(addr) || d->next == NULL) {
+			ret = t4_alloc_mac_filt(pi->adapter, 0, pi->viid, free,
+					naddr, addr, filt_idx, &mhash, sleep);
+			if (ret < 0)
+				return ret;
+
+			free = false;
+			naddr = 0;
+		}
+	}
+
+	return t4_set_addr_hash(pi->adapter, 0, pi->viid, uhash != 0,
+				uhash | mhash, sleep);
+}
+
+/*
+ * Set Rx properties of a port, such as promiscruity, address filters, and MTU.
+ * If @mtu is -1 it is left unchanged.
+ */
+static int set_rxmode(struct net_device *dev, int mtu, bool sleep_ok)
+{
+	int ret;
+	struct port_info *pi = netdev_priv(dev);
+
+	ret = set_addr_filters(dev, sleep_ok);
+	if (ret == 0)
+		ret = t4_set_rxmode(pi->adapter, 0, pi->viid, mtu,
+				    (dev->flags & IFF_PROMISC) ? 1 : 0,
+				    (dev->flags & IFF_ALLMULTI) ? 1 : 0, 1,
+				    sleep_ok);
+	return ret;
+}
+
+/**
+ *	link_start - enable a port
+ *	@dev: the port to enable
+ *
+ *	Performs the MAC and PHY actions needed to enable a port.
+ */
+static int link_start(struct net_device *dev)
+{
+	int ret;
+	struct port_info *pi = netdev_priv(dev);
+
+	/*
+	 * We do not set address filters and promiscuity here, the stack does
+	 * that step explicitly.
+	 */
+	ret = t4_set_rxmode(pi->adapter, 0, pi->viid, dev->mtu, -1, -1, -1,
+			    true);
+	if (ret == 0) {
+		ret = t4_change_mac(pi->adapter, 0, pi->viid,
+				    pi->xact_addr_filt, dev->dev_addr, true,
+				    false);
+		if (ret >= 0) {
+			pi->xact_addr_filt = ret;
+			ret = 0;
+		}
+	}
+	if (ret == 0)
+		ret = t4_link_start(pi->adapter, 0, pi->tx_chan, &pi->link_cfg);
+	if (ret == 0)
+		ret = t4_enable_vi(pi->adapter, 0, pi->viid, true, true);
+	return ret;
+}
+
+/*
+ * Response queue handler for the FW event queue.
+ */
+static int fwevtq_handler(struct sge_rspq *q, const __be64 *rsp,
+			  const struct pkt_gl *gl)
+{
+	u8 opcode = ((const struct rss_header *)rsp)->opcode;
+
+	rsp++;                                          /* skip RSS header */
+	if (likely(opcode == CPL_SGE_EGR_UPDATE)) {
+		const struct cpl_sge_egr_update *p = (void *)rsp;
+		unsigned int qid = EGR_QID(ntohl(p->opcode_qid));
+		struct sge_txq *txq = q->adap->sge.egr_map[qid];
+
+		txq->restarts++;
+		if ((u8 *)txq < (u8 *)q->adap->sge.ethrxq) {
+			struct sge_eth_txq *eq;
+
+			eq = container_of(txq, struct sge_eth_txq, q);
+			netif_tx_wake_queue(eq->txq);
+		} else {
+			struct sge_ofld_txq *oq;
+
+			oq = container_of(txq, struct sge_ofld_txq, q);
+			tasklet_schedule(&oq->qresume_tsk);
+		}
+	} else if (opcode == CPL_FW6_MSG || opcode == CPL_FW4_MSG) {
+		const struct cpl_fw6_msg *p = (void *)rsp;
+
+		if (p->type == 0)
+			t4_handle_fw_rpl(q->adap, p->data);
+	} else if (opcode == CPL_L2T_WRITE_RPL) {
+		const struct cpl_l2t_write_rpl *p = (void *)rsp;
+
+		do_l2t_write_rpl(q->adap, p);
+	} else
+		dev_err(q->adap->pdev_dev,
+			"unexpected CPL %#x on FW event queue\n", opcode);
+	return 0;
+}
+
+/**
+ *	uldrx_handler - response queue handler for ULD queues
+ *	@q: the response queue that received the packet
+ *	@rsp: the response queue descriptor holding the offload message
+ *	@gl: the gather list of packet fragments
+ *
+ *	Deliver an ingress offload packet to a ULD.  All processing is done by
+ *	the ULD, we just maintain statistics.
+ */
+static int uldrx_handler(struct sge_rspq *q, const __be64 *rsp,
+			 const struct pkt_gl *gl)
+{
+	struct sge_ofld_rxq *rxq = container_of(q, struct sge_ofld_rxq, rspq);
+
+	if (ulds[q->uld].rx_handler(q->adap->uld_handle[q->uld], rsp, gl)) {
+		rxq->stats.nomem++;
+		return -1;
+	}
+	if (gl == NULL)
+		rxq->stats.imm++;
+	else if (gl == CXGB4_MSG_AN)
+		rxq->stats.an++;
+	else
+		rxq->stats.pkts++;
+	return 0;
+}
+
+static void disable_msi(struct adapter *adapter)
+{
+	if (adapter->flags & USING_MSIX) {
+		pci_disable_msix(adapter->pdev);
+		adapter->flags &= ~USING_MSIX;
+	} else if (adapter->flags & USING_MSI) {
+		pci_disable_msi(adapter->pdev);
+		adapter->flags &= ~USING_MSI;
+	}
+}
+
+/*
+ * Interrupt handler for non-data events used with MSI-X.
+ */
+static irqreturn_t t4_nondata_intr(int irq, void *cookie)
+{
+	struct adapter *adap = cookie;
+
+	u32 v = t4_read_reg(adap, MYPF_REG(PL_PF_INT_CAUSE));
+	if (v & PFSW) {
+		adap->swintr = 1;
+		t4_write_reg(adap, MYPF_REG(PL_PF_INT_CAUSE), v);
+	}
+	t4_slow_intr_handler(adap);
+	return IRQ_HANDLED;
+}
+
+/*
+ * Name the MSI-X interrupts.
+ */
+static void name_msix_vecs(struct adapter *adap)
+{
+	int i, j, msi_idx = 2, n = sizeof(adap->msix_info[0].desc) - 1;
+
+	/* non-data interrupts */
+	snprintf(adap->msix_info[0].desc, n, "%s", adap->name);
+	adap->msix_info[0].desc[n] = 0;
+
+	/* FW events */
+	snprintf(adap->msix_info[1].desc, n, "%s-FWeventq", adap->name);
+	adap->msix_info[1].desc[n] = 0;
+
+	/* Ethernet queues */
+	for_each_port(adap, j) {
+		struct net_device *d = adap->port[j];
+		const struct port_info *pi = netdev_priv(d);
+
+		for (i = 0; i < pi->nqsets; i++, msi_idx++) {
+			snprintf(adap->msix_info[msi_idx].desc, n, "%s-Rx%d",
+				 d->name, i);
+			adap->msix_info[msi_idx].desc[n] = 0;
+		}
+	}
+
+	/* offload queues */
+	for_each_ofldrxq(&adap->sge, i) {
+		snprintf(adap->msix_info[msi_idx].desc, n, "%s-ofld%d",
+			 adap->name, i);
+		adap->msix_info[msi_idx++].desc[n] = 0;
+	}
+	for_each_rdmarxq(&adap->sge, i) {
+		snprintf(adap->msix_info[msi_idx].desc, n, "%s-rdma%d",
+			 adap->name, i);
+		adap->msix_info[msi_idx++].desc[n] = 0;
+	}
+}
+
+static int request_msix_queue_irqs(struct adapter *adap)
+{
+	struct sge *s = &adap->sge;
+	int err, ethqidx, ofldqidx = 0, rdmaqidx = 0, msi = 2;
+
+	err = request_irq(adap->msix_info[1].vec, t4_sge_intr_msix, 0,
+			  adap->msix_info[1].desc, &s->fw_evtq);
+	if (err)
+		return err;
+
+	for_each_ethrxq(s, ethqidx) {
+		err = request_irq(adap->msix_info[msi].vec, t4_sge_intr_msix, 0,
+				  adap->msix_info[msi].desc,
+				  &s->ethrxq[ethqidx].rspq);
+		if (err)
+			goto unwind;
+		msi++;
+	}
+	for_each_ofldrxq(s, ofldqidx) {
+		err = request_irq(adap->msix_info[msi].vec, t4_sge_intr_msix, 0,
+				  adap->msix_info[msi].desc,
+				  &s->ofldrxq[ofldqidx].rspq);
+		if (err)
+			goto unwind;
+		msi++;
+	}
+	for_each_rdmarxq(s, rdmaqidx) {
+		err = request_irq(adap->msix_info[msi].vec, t4_sge_intr_msix, 0,
+				  adap->msix_info[msi].desc,
+				  &s->rdmarxq[rdmaqidx].rspq);
+		if (err)
+			goto unwind;
+		msi++;
+	}
+	return 0;
+
+unwind:
+	while (--rdmaqidx >= 0)
+		free_irq(adap->msix_info[--msi].vec,
+			 &s->rdmarxq[rdmaqidx].rspq);
+	while (--ofldqidx >= 0)
+		free_irq(adap->msix_info[--msi].vec,
+			 &s->ofldrxq[ofldqidx].rspq);
+	while (--ethqidx >= 0)
+		free_irq(adap->msix_info[--msi].vec, &s->ethrxq[ethqidx].rspq);
+	free_irq(adap->msix_info[1].vec, &s->fw_evtq);
+	return err;
+}
+
+static void free_msix_queue_irqs(struct adapter *adap)
+{
+	int i, msi = 2;
+	struct sge *s = &adap->sge;
+
+	free_irq(adap->msix_info[1].vec, &s->fw_evtq);
+	for_each_ethrxq(s, i)
+		free_irq(adap->msix_info[msi++].vec, &s->ethrxq[i].rspq);
+	for_each_ofldrxq(s, i)
+		free_irq(adap->msix_info[msi++].vec, &s->ofldrxq[i].rspq);
+	for_each_rdmarxq(s, i)
+		free_irq(adap->msix_info[msi++].vec, &s->rdmarxq[i].rspq);
+}
+
+/**
+ *	setup_rss - configure RSS
+ *	@adap: the adapter
+ *
+ *	Sets up RSS to distribute packets to multiple receive queues.  We
+ *	configure the RSS CPU lookup table to distribute to the number of HW
+ *	receive queues, and the response queue lookup table to narrow that
+ *	down to the response queues actually configured for each port.
+ *	We always configure the RSS mapping for all ports since the mapping
+ *	table has plenty of entries.
+ */
+static int setup_rss(struct adapter *adap)
+{
+	int i, j, err;
+	u16 rss[MAX_ETH_QSETS];
+
+	for_each_port(adap, i) {
+		const struct port_info *pi = adap2pinfo(adap, i);
+		const struct sge_eth_rxq *q = &adap->sge.ethrxq[pi->first_qset];
+
+		for (j = 0; j < pi->nqsets; j++)
+			rss[j] = q[j].rspq.abs_id;
+
+		err = t4_config_rss_range(adap, 0, pi->viid, 0, pi->rss_size,
+					  rss, pi->nqsets);
+		if (err)
+			return err;
+	}
+	return 0;
+}
+
+/*
+ * Wait until all NAPI handlers are descheduled.
+ */
+static void quiesce_rx(struct adapter *adap)
+{
+	int i;
+
+	for (i = 0; i < ARRAY_SIZE(adap->sge.ingr_map); i++) {
+		struct sge_rspq *q = adap->sge.ingr_map[i];
+
+		if (q && q->handler)
+			napi_disable(&q->napi);
+	}
+}
+
+/*
+ * Enable NAPI scheduling and interrupt generation for all Rx queues.
+ */
+static void enable_rx(struct adapter *adap)
+{
+	int i;
+
+	for (i = 0; i < ARRAY_SIZE(adap->sge.ingr_map); i++) {
+		struct sge_rspq *q = adap->sge.ingr_map[i];
+
+		if (!q)
+			continue;
+		if (q->handler)
+			napi_enable(&q->napi);
+		/* 0-increment GTS to start the timer and enable interrupts */
+		t4_write_reg(adap, MYPF_REG(SGE_PF_GTS),
+			     SEINTARM(q->intr_params) |
+			     INGRESSQID(q->cntxt_id));
+	}
+}
+
+/**
+ *	setup_sge_queues - configure SGE Tx/Rx/response queues
+ *	@adap: the adapter
+ *
+ *	Determines how many sets of SGE queues to use and initializes them.
+ *	We support multiple queue sets per port if we have MSI-X, otherwise
+ *	just one queue set per port.
+ */
+static int setup_sge_queues(struct adapter *adap)
+{
+	int err, msi_idx, i, j;
+	struct sge *s = &adap->sge;
+
+	bitmap_zero(s->starving_fl, MAX_EGRQ);
+	bitmap_zero(s->txq_maperr, MAX_EGRQ);
+
+	if (adap->flags & USING_MSIX)
+		msi_idx = 1;         /* vector 0 is for non-queue interrupts */
+	else {
+		err = t4_sge_alloc_rxq(adap, &s->intrq, false, adap->port[0], 0,
+				       NULL, NULL);
+		if (err)
+			return err;
+		msi_idx = -((int)s->intrq.abs_id + 1);
+	}
+
+	err = t4_sge_alloc_rxq(adap, &s->fw_evtq, true, adap->port[0],
+			       msi_idx, NULL, fwevtq_handler);
+	if (err) {
+freeout:	t4_free_sge_resources(adap);
+		return err;
+	}
+
+	for_each_port(adap, i) {
+		struct net_device *dev = adap->port[i];
+		struct port_info *pi = netdev_priv(dev);
+		struct sge_eth_rxq *q = &s->ethrxq[pi->first_qset];
+		struct sge_eth_txq *t = &s->ethtxq[pi->first_qset];
+
+		for (j = 0; j < pi->nqsets; j++, q++) {
+			if (msi_idx > 0)
+				msi_idx++;
+			err = t4_sge_alloc_rxq(adap, &q->rspq, false, dev,
+					       msi_idx, &q->fl,
+					       t4_ethrx_handler);
+			if (err)
+				goto freeout;
+			q->rspq.idx = j;
+			memset(&q->stats, 0, sizeof(q->stats));
+		}
+		for (j = 0; j < pi->nqsets; j++, t++) {
+			err = t4_sge_alloc_eth_txq(adap, t, dev,
+					netdev_get_tx_queue(dev, j),
+					s->fw_evtq.cntxt_id);
+			if (err)
+				goto freeout;
+		}
+	}
+
+	j = s->ofldqsets / adap->params.nports; /* ofld queues per channel */
+	for_each_ofldrxq(s, i) {
+		struct sge_ofld_rxq *q = &s->ofldrxq[i];
+		struct net_device *dev = adap->port[i / j];
+
+		if (msi_idx > 0)
+			msi_idx++;
+		err = t4_sge_alloc_rxq(adap, &q->rspq, false, dev, msi_idx,
+				       &q->fl, uldrx_handler);
+		if (err)
+			goto freeout;
+		memset(&q->stats, 0, sizeof(q->stats));
+		s->ofld_rxq[i] = q->rspq.abs_id;
+		err = t4_sge_alloc_ofld_txq(adap, &s->ofldtxq[i], dev,
+					    s->fw_evtq.cntxt_id);
+		if (err)
+			goto freeout;
+	}
+
+	for_each_rdmarxq(s, i) {
+		struct sge_ofld_rxq *q = &s->rdmarxq[i];
+
+		if (msi_idx > 0)
+			msi_idx++;
+		err = t4_sge_alloc_rxq(adap, &q->rspq, false, adap->port[i],
+				       msi_idx, &q->fl, uldrx_handler);
+		if (err)
+			goto freeout;
+		memset(&q->stats, 0, sizeof(q->stats));
+		s->rdma_rxq[i] = q->rspq.abs_id;
+	}
+
+	for_each_port(adap, i) {
+		/*
+		 * Note that ->rdmarxq[i].rspq.cntxt_id below is 0 if we don't
+		 * have RDMA queues, and that's the right value.
+		 */
+		err = t4_sge_alloc_ctrl_txq(adap, &s->ctrlq[i], adap->port[i],
+					    s->fw_evtq.cntxt_id,
+					    s->rdmarxq[i].rspq.cntxt_id);
+		if (err)
+			goto freeout;
+	}
+
+	t4_write_reg(adap, MPS_TRC_RSS_CONTROL,
+		     RSSCONTROL(netdev2pinfo(adap->port[0])->tx_chan) |
+		     QUEUENUMBER(s->ethrxq[0].rspq.abs_id));
+	return 0;
+}
+
+/*
+ * Returns 0 if new FW was successfully loaded, a positive errno if a load was
+ * started but failed, and a negative errno if flash load couldn't start.
+ */
+static int upgrade_fw(struct adapter *adap)
+{
+	int ret;
+	u32 vers;
+	const struct fw_hdr *hdr;
+	const struct firmware *fw;
+	struct device *dev = adap->pdev_dev;
+
+	ret = request_firmware(&fw, FW_FNAME, dev);
+	if (ret < 0) {
+		dev_err(dev, "unable to load firmware image " FW_FNAME
+			", error %d\n", ret);
+		return ret;
+	}
+
+	hdr = (const struct fw_hdr *)fw->data;
+	vers = ntohl(hdr->fw_ver);
+	if (FW_HDR_FW_VER_MAJOR_GET(vers) != FW_VERSION_MAJOR) {
+		ret = -EINVAL;              /* wrong major version, won't do */
+		goto out;
+	}
+
+	/*
+	 * If the flash FW is unusable or we found something newer, load it.
+	 */
+	if (FW_HDR_FW_VER_MAJOR_GET(adap->params.fw_vers) != FW_VERSION_MAJOR ||
+	    vers > adap->params.fw_vers) {
+		ret = -t4_load_fw(adap, fw->data, fw->size);
+		if (!ret)
+			dev_info(dev, "firmware upgraded to version %pI4 from "
+				 FW_FNAME "\n", &hdr->fw_ver);
+	}
+out:	release_firmware(fw);
+	return ret;
+}
+
+/*
+ * Allocate a chunk of memory using kmalloc or, if that fails, vmalloc.
+ * The allocated memory is cleared.
+ */
+void *t4_alloc_mem(size_t size)
+{
+	void *p = kmalloc(size, GFP_KERNEL);
+
+	if (!p)
+		p = vmalloc(size);
+	if (p)
+		memset(p, 0, size);
+	return p;
+}
+
+/*
+ * Free memory allocated through alloc_mem().
+ */
+void t4_free_mem(void *addr)
+{
+	if (is_vmalloc_addr(addr))
+		vfree(addr);
+	else
+		kfree(addr);
+}
+
+static inline int is_offload(const struct adapter *adap)
+{
+	return adap->params.offload;
+}
+
+/*
+ * Implementation of ethtool operations.
+ */
+
+static u32 get_msglevel(struct net_device *dev)
+{
+	return netdev2adap(dev)->msg_enable;
+}
+
+static void set_msglevel(struct net_device *dev, u32 val)
+{
+	netdev2adap(dev)->msg_enable = val;
+}
+
+static char stats_strings[][ETH_GSTRING_LEN] = {
+	"TxOctetsOK         ",
+	"TxFramesOK         ",
+	"TxBroadcastFrames  ",
+	"TxMulticastFrames  ",
+	"TxUnicastFrames    ",
+	"TxErrorFrames      ",
+
+	"TxFrames64         ",
+	"TxFrames65To127    ",
+	"TxFrames128To255   ",
+	"TxFrames256To511   ",
+	"TxFrames512To1023  ",
+	"TxFrames1024To1518 ",
+	"TxFrames1519ToMax  ",
+
+	"TxFramesDropped    ",
+	"TxPauseFrames      ",
+	"TxPPP0Frames       ",
+	"TxPPP1Frames       ",
+	"TxPPP2Frames       ",
+	"TxPPP3Frames       ",
+	"TxPPP4Frames       ",
+	"TxPPP5Frames       ",
+	"TxPPP6Frames       ",
+	"TxPPP7Frames       ",
+
+	"RxOctetsOK         ",
+	"RxFramesOK         ",
+	"RxBroadcastFrames  ",
+	"RxMulticastFrames  ",
+	"RxUnicastFrames    ",
+
+	"RxFramesTooLong    ",
+	"RxJabberErrors     ",
+	"RxFCSErrors        ",
+	"RxLengthErrors     ",
+	"RxSymbolErrors     ",
+	"RxRuntFrames       ",
+
+	"RxFrames64         ",
+	"RxFrames65To127    ",
+	"RxFrames128To255   ",
+	"RxFrames256To511   ",
+	"RxFrames512To1023  ",
+	"RxFrames1024To1518 ",
+	"RxFrames1519ToMax  ",
+
+	"RxPauseFrames      ",
+	"RxPPP0Frames       ",
+	"RxPPP1Frames       ",
+	"RxPPP2Frames       ",
+	"RxPPP3Frames       ",
+	"RxPPP4Frames       ",
+	"RxPPP5Frames       ",
+	"RxPPP6Frames       ",
+	"RxPPP7Frames       ",
+
+	"RxBG0FramesDropped ",
+	"RxBG1FramesDropped ",
+	"RxBG2FramesDropped ",
+	"RxBG3FramesDropped ",
+	"RxBG0FramesTrunc   ",
+	"RxBG1FramesTrunc   ",
+	"RxBG2FramesTrunc   ",
+	"RxBG3FramesTrunc   ",
+
+	"TSO                ",
+	"TxCsumOffload      ",
+	"RxCsumGood         ",
+	"VLANextractions    ",
+	"VLANinsertions     ",
+};
+
+static int get_sset_count(struct net_device *dev, int sset)
+{
+	switch (sset) {
+	case ETH_SS_STATS:
+		return ARRAY_SIZE(stats_strings);
+	default:
+		return -EOPNOTSUPP;
+	}
+}
+
+#define T4_REGMAP_SIZE (160 * 1024)
+
+static int get_regs_len(struct net_device *dev)
+{
+	return T4_REGMAP_SIZE;
+}
+
+static int get_eeprom_len(struct net_device *dev)
+{
+	return EEPROMSIZE;
+}
+
+static void get_drvinfo(struct net_device *dev, struct ethtool_drvinfo *info)
+{
+	struct adapter *adapter = netdev2adap(dev);
+
+	strcpy(info->driver, KBUILD_MODNAME);
+	strcpy(info->version, DRV_VERSION);
+	strcpy(info->bus_info, pci_name(adapter->pdev));
+
+	if (!adapter->params.fw_vers)
+		strcpy(info->fw_version, "N/A");
+	else
+		snprintf(info->fw_version, sizeof(info->fw_version),
+			"%u.%u.%u.%u, TP %u.%u.%u.%u",
+			FW_HDR_FW_VER_MAJOR_GET(adapter->params.fw_vers),
+			FW_HDR_FW_VER_MINOR_GET(adapter->params.fw_vers),
+			FW_HDR_FW_VER_MICRO_GET(adapter->params.fw_vers),
+			FW_HDR_FW_VER_BUILD_GET(adapter->params.fw_vers),
+			FW_HDR_FW_VER_MAJOR_GET(adapter->params.tp_vers),
+			FW_HDR_FW_VER_MINOR_GET(adapter->params.tp_vers),
+			FW_HDR_FW_VER_MICRO_GET(adapter->params.tp_vers),
+			FW_HDR_FW_VER_BUILD_GET(adapter->params.tp_vers));
+}
+
+static void get_strings(struct net_device *dev, u32 stringset, u8 *data)
+{
+	if (stringset == ETH_SS_STATS)
+		memcpy(data, stats_strings, sizeof(stats_strings));
+}
+
+/*
+ * port stats maintained per queue of the port.  They should be in the same
+ * order as in stats_strings above.
+ */
+struct queue_port_stats {
+	u64 tso;
+	u64 tx_csum;
+	u64 rx_csum;
+	u64 vlan_ex;
+	u64 vlan_ins;
+};
+
+static void collect_sge_port_stats(const struct adapter *adap,
+		const struct port_info *p, struct queue_port_stats *s)
+{
+	int i;
+	const struct sge_eth_txq *tx = &adap->sge.ethtxq[p->first_qset];
+	const struct sge_eth_rxq *rx = &adap->sge.ethrxq[p->first_qset];
+
+	memset(s, 0, sizeof(*s));
+	for (i = 0; i < p->nqsets; i++, rx++, tx++) {
+		s->tso += tx->tso;
+		s->tx_csum += tx->tx_cso;
+		s->rx_csum += rx->stats.rx_cso;
+		s->vlan_ex += rx->stats.vlan_ex;
+		s->vlan_ins += tx->vlan_ins;
+	}
+}
+
+static void get_stats(struct net_device *dev, struct ethtool_stats *stats,
+		      u64 *data)
+{
+	struct port_info *pi = netdev_priv(dev);
+	struct adapter *adapter = pi->adapter;
+
+	t4_get_port_stats(adapter, pi->tx_chan, (struct port_stats *)data);
+
+	data += sizeof(struct port_stats) / sizeof(u64);
+	collect_sge_port_stats(adapter, pi, (struct queue_port_stats *)data);
+}
+
+/*
+ * Return a version number to identify the type of adapter.  The scheme is:
+ * - bits 0..9: chip version
+ * - bits 10..15: chip revision
+ */
+static inline unsigned int mk_adap_vers(const struct adapter *ap)
+{
+	return 4 | (ap->params.rev << 10);
+}
+
+static void reg_block_dump(struct adapter *ap, void *buf, unsigned int start,
+			   unsigned int end)
+{
+	u32 *p = buf + start;
+
+	for ( ; start <= end; start += sizeof(u32))
+		*p++ = t4_read_reg(ap, start);
+}
+
+static void get_regs(struct net_device *dev, struct ethtool_regs *regs,
+		     void *buf)
+{
+	static const unsigned int reg_ranges[] = {
+		0x1008, 0x1108,
+		0x1180, 0x11b4,
+		0x11fc, 0x123c,
+		0x1300, 0x173c,
+		0x1800, 0x18fc,
+		0x3000, 0x30d8,
+		0x30e0, 0x5924,
+		0x5960, 0x59d4,
+		0x5a00, 0x5af8,
+		0x6000, 0x6098,
+		0x6100, 0x6150,
+		0x6200, 0x6208,
+		0x6240, 0x6248,
+		0x6280, 0x6338,
+		0x6370, 0x638c,
+		0x6400, 0x643c,
+		0x6500, 0x6524,
+		0x6a00, 0x6a38,
+		0x6a60, 0x6a78,
+		0x6b00, 0x6b84,
+		0x6bf0, 0x6c84,
+		0x6cf0, 0x6d84,
+		0x6df0, 0x6e84,
+		0x6ef0, 0x6f84,
+		0x6ff0, 0x7084,
+		0x70f0, 0x7184,
+		0x71f0, 0x7284,
+		0x72f0, 0x7384,
+		0x73f0, 0x7450,
+		0x7500, 0x7530,
+		0x7600, 0x761c,
+		0x7680, 0x76cc,
+		0x7700, 0x7798,
+		0x77c0, 0x77fc,
+		0x7900, 0x79fc,
+		0x7b00, 0x7c38,
+		0x7d00, 0x7efc,
+		0x8dc0, 0x8e1c,
+		0x8e30, 0x8e78,
+		0x8ea0, 0x8f6c,
+		0x8fc0, 0x9074,
+		0x90fc, 0x90fc,
+		0x9400, 0x9458,
+		0x9600, 0x96bc,
+		0x9800, 0x9808,
+		0x9820, 0x983c,
+		0x9850, 0x9864,
+		0x9c00, 0x9c6c,
+		0x9c80, 0x9cec,
+		0x9d00, 0x9d6c,
+		0x9d80, 0x9dec,
+		0x9e00, 0x9e6c,
+		0x9e80, 0x9eec,
+		0x9f00, 0x9f6c,
+		0x9f80, 0x9fec,
+		0xd004, 0xd03c,
+		0xdfc0, 0xdfe0,
+		0xe000, 0xea7c,
+		0xf000, 0x11190,
+		0x19040, 0x19124,
+		0x19150, 0x191b0,
+		0x191d0, 0x191e8,
+		0x19238, 0x1924c,
+		0x193f8, 0x19474,
+		0x19490, 0x194f8,
+		0x19800, 0x19f30,
+		0x1a000, 0x1a06c,
+		0x1a0b0, 0x1a120,
+		0x1a128, 0x1a138,
+		0x1a190, 0x1a1c4,
+		0x1a1fc, 0x1a1fc,
+		0x1e040, 0x1e04c,
+		0x1e240, 0x1e28c,
+		0x1e2c0, 0x1e2c0,
+		0x1e2e0, 0x1e2e0,
+		0x1e300, 0x1e384,
+		0x1e3c0, 0x1e3c8,
+		0x1e440, 0x1e44c,
+		0x1e640, 0x1e68c,
+		0x1e6c0, 0x1e6c0,
+		0x1e6e0, 0x1e6e0,
+		0x1e700, 0x1e784,
+		0x1e7c0, 0x1e7c8,
+		0x1e840, 0x1e84c,
+		0x1ea40, 0x1ea8c,
+		0x1eac0, 0x1eac0,
+		0x1eae0, 0x1eae0,
+		0x1eb00, 0x1eb84,
+		0x1ebc0, 0x1ebc8,
+		0x1ec40, 0x1ec4c,
+		0x1ee40, 0x1ee8c,
+		0x1eec0, 0x1eec0,
+		0x1eee0, 0x1eee0,
+		0x1ef00, 0x1ef84,
+		0x1efc0, 0x1efc8,
+		0x1f040, 0x1f04c,
+		0x1f240, 0x1f28c,
+		0x1f2c0, 0x1f2c0,
+		0x1f2e0, 0x1f2e0,
+		0x1f300, 0x1f384,
+		0x1f3c0, 0x1f3c8,
+		0x1f440, 0x1f44c,
+		0x1f640, 0x1f68c,
+		0x1f6c0, 0x1f6c0,
+		0x1f6e0, 0x1f6e0,
+		0x1f700, 0x1f784,
+		0x1f7c0, 0x1f7c8,
+		0x1f840, 0x1f84c,
+		0x1fa40, 0x1fa8c,
+		0x1fac0, 0x1fac0,
+		0x1fae0, 0x1fae0,
+		0x1fb00, 0x1fb84,
+		0x1fbc0, 0x1fbc8,
+		0x1fc40, 0x1fc4c,
+		0x1fe40, 0x1fe8c,
+		0x1fec0, 0x1fec0,
+		0x1fee0, 0x1fee0,
+		0x1ff00, 0x1ff84,
+		0x1ffc0, 0x1ffc8,
+		0x20000, 0x2002c,
+		0x20100, 0x2013c,
+		0x20190, 0x201c8,
+		0x20200, 0x20318,
+		0x20400, 0x20528,
+		0x20540, 0x20614,
+		0x21000, 0x21040,
+		0x2104c, 0x21060,
+		0x210c0, 0x210ec,
+		0x21200, 0x21268,
+		0x21270, 0x21284,
+		0x212fc, 0x21388,
+		0x21400, 0x21404,
+		0x21500, 0x21518,
+		0x2152c, 0x2153c,
+		0x21550, 0x21554,
+		0x21600, 0x21600,
+		0x21608, 0x21628,
+		0x21630, 0x2163c,
+		0x21700, 0x2171c,
+		0x21780, 0x2178c,
+		0x21800, 0x21c38,
+		0x21c80, 0x21d7c,
+		0x21e00, 0x21e04,
+		0x22000, 0x2202c,
+		0x22100, 0x2213c,
+		0x22190, 0x221c8,
+		0x22200, 0x22318,
+		0x22400, 0x22528,
+		0x22540, 0x22614,
+		0x23000, 0x23040,
+		0x2304c, 0x23060,
+		0x230c0, 0x230ec,
+		0x23200, 0x23268,
+		0x23270, 0x23284,
+		0x232fc, 0x23388,
+		0x23400, 0x23404,
+		0x23500, 0x23518,
+		0x2352c, 0x2353c,
+		0x23550, 0x23554,
+		0x23600, 0x23600,
+		0x23608, 0x23628,
+		0x23630, 0x2363c,
+		0x23700, 0x2371c,
+		0x23780, 0x2378c,
+		0x23800, 0x23c38,
+		0x23c80, 0x23d7c,
+		0x23e00, 0x23e04,
+		0x24000, 0x2402c,
+		0x24100, 0x2413c,
+		0x24190, 0x241c8,
+		0x24200, 0x24318,
+		0x24400, 0x24528,
+		0x24540, 0x24614,
+		0x25000, 0x25040,
+		0x2504c, 0x25060,
+		0x250c0, 0x250ec,
+		0x25200, 0x25268,
+		0x25270, 0x25284,
+		0x252fc, 0x25388,
+		0x25400, 0x25404,
+		0x25500, 0x25518,
+		0x2552c, 0x2553c,
+		0x25550, 0x25554,
+		0x25600, 0x25600,
+		0x25608, 0x25628,
+		0x25630, 0x2563c,
+		0x25700, 0x2571c,
+		0x25780, 0x2578c,
+		0x25800, 0x25c38,
+		0x25c80, 0x25d7c,
+		0x25e00, 0x25e04,
+		0x26000, 0x2602c,
+		0x26100, 0x2613c,
+		0x26190, 0x261c8,
+		0x26200, 0x26318,
+		0x26400, 0x26528,
+		0x26540, 0x26614,
+		0x27000, 0x27040,
+		0x2704c, 0x27060,
+		0x270c0, 0x270ec,
+		0x27200, 0x27268,
+		0x27270, 0x27284,
+		0x272fc, 0x27388,
+		0x27400, 0x27404,
+		0x27500, 0x27518,
+		0x2752c, 0x2753c,
+		0x27550, 0x27554,
+		0x27600, 0x27600,
+		0x27608, 0x27628,
+		0x27630, 0x2763c,
+		0x27700, 0x2771c,
+		0x27780, 0x2778c,
+		0x27800, 0x27c38,
+		0x27c80, 0x27d7c,
+		0x27e00, 0x27e04
+	};
+
+	int i;
+	struct adapter *ap = netdev2adap(dev);
+
+	regs->version = mk_adap_vers(ap);
+
+	memset(buf, 0, T4_REGMAP_SIZE);
+	for (i = 0; i < ARRAY_SIZE(reg_ranges); i += 2)
+		reg_block_dump(ap, buf, reg_ranges[i], reg_ranges[i + 1]);
+}
+
+static int restart_autoneg(struct net_device *dev)
+{
+	struct port_info *p = netdev_priv(dev);
+
+	if (!netif_running(dev))
+		return -EAGAIN;
+	if (p->link_cfg.autoneg != AUTONEG_ENABLE)
+		return -EINVAL;
+	t4_restart_aneg(p->adapter, 0, p->tx_chan);
+	return 0;
+}
+
+static int identify_port(struct net_device *dev, u32 data)
+{
+	if (data == 0)
+		data = 2;     /* default to 2 seconds */
+
+	return t4_identify_port(netdev2adap(dev), 0, netdev2pinfo(dev)->viid,
+				data * 5);
+}
+
+static unsigned int from_fw_linkcaps(unsigned int type, unsigned int caps)
+{
+	unsigned int v = 0;
+
+	if (type == FW_PORT_TYPE_BT_SGMII || type == FW_PORT_TYPE_BT_XAUI) {
+		v |= SUPPORTED_TP;
+		if (caps & FW_PORT_CAP_SPEED_100M)
+			v |= SUPPORTED_100baseT_Full;
+		if (caps & FW_PORT_CAP_SPEED_1G)
+			v |= SUPPORTED_1000baseT_Full;
+		if (caps & FW_PORT_CAP_SPEED_10G)
+			v |= SUPPORTED_10000baseT_Full;
+	} else if (type == FW_PORT_TYPE_KX4 || type == FW_PORT_TYPE_KX) {
+		v |= SUPPORTED_Backplane;
+		if (caps & FW_PORT_CAP_SPEED_1G)
+			v |= SUPPORTED_1000baseKX_Full;
+		if (caps & FW_PORT_CAP_SPEED_10G)
+			v |= SUPPORTED_10000baseKX4_Full;
+	} else if (type == FW_PORT_TYPE_KR)
+		v |= SUPPORTED_Backplane | SUPPORTED_10000baseKR_Full;
+	else if (type == FW_PORT_TYPE_FIBER)
+		v |= SUPPORTED_FIBRE;
+
+	if (caps & FW_PORT_CAP_ANEG)
+		v |= SUPPORTED_Autoneg;
+	return v;
+}
+
+static unsigned int to_fw_linkcaps(unsigned int caps)
+{
+	unsigned int v = 0;
+
+	if (caps & ADVERTISED_100baseT_Full)
+		v |= FW_PORT_CAP_SPEED_100M;
+	if (caps & ADVERTISED_1000baseT_Full)
+		v |= FW_PORT_CAP_SPEED_1G;
+	if (caps & ADVERTISED_10000baseT_Full)
+		v |= FW_PORT_CAP_SPEED_10G;
+	return v;
+}
+
+static int get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
+{
+	const struct port_info *p = netdev_priv(dev);
+
+	if (p->port_type == FW_PORT_TYPE_BT_SGMII ||
+	    p->port_type == FW_PORT_TYPE_BT_XAUI)
+		cmd->port = PORT_TP;
+	else if (p->port_type == FW_PORT_TYPE_FIBER)
+		cmd->port = PORT_FIBRE;
+	else if (p->port_type == FW_PORT_TYPE_TWINAX)
+		cmd->port = PORT_DA;
+	else
+		cmd->port = PORT_OTHER;
+
+	if (p->mdio_addr >= 0) {
+		cmd->phy_address = p->mdio_addr;
+		cmd->transceiver = XCVR_EXTERNAL;
+		cmd->mdio_support = p->port_type == FW_PORT_TYPE_BT_SGMII ?
+			MDIO_SUPPORTS_C22 : MDIO_SUPPORTS_C45;
+	} else {
+		cmd->phy_address = 0;  /* not really, but no better option */
+		cmd->transceiver = XCVR_INTERNAL;
+		cmd->mdio_support = 0;
+	}
+
+	cmd->supported = from_fw_linkcaps(p->port_type, p->link_cfg.supported);
+	cmd->advertising = from_fw_linkcaps(p->port_type,
+					    p->link_cfg.advertising);
+	cmd->speed = netif_carrier_ok(dev) ? p->link_cfg.speed : 0;
+	cmd->duplex = DUPLEX_FULL;
+	cmd->autoneg = p->link_cfg.autoneg;
+	cmd->maxtxpkt = 0;
+	cmd->maxrxpkt = 0;
+	return 0;
+}
+
+static unsigned int speed_to_caps(int speed)
+{
+	if (speed == SPEED_100)
+		return FW_PORT_CAP_SPEED_100M;
+	if (speed == SPEED_1000)
+		return FW_PORT_CAP_SPEED_1G;
+	if (speed == SPEED_10000)
+		return FW_PORT_CAP_SPEED_10G;
+	return 0;
+}
+
+static int set_settings(struct net_device *dev, struct ethtool_cmd *cmd)
+{
+	unsigned int cap;
+	struct port_info *p = netdev_priv(dev);
+	struct link_config *lc = &p->link_cfg;
+
+	if (cmd->duplex != DUPLEX_FULL)     /* only full-duplex supported */
+		return -EINVAL;
+
+	if (!(lc->supported & FW_PORT_CAP_ANEG)) {
+		/*
+		 * PHY offers a single speed.  See if that's what's
+		 * being requested.
+		 */
+		if (cmd->autoneg == AUTONEG_DISABLE &&
+		    (lc->supported & speed_to_caps(cmd->speed)))
+				return 0;
+		return -EINVAL;
+	}
+
+	if (cmd->autoneg == AUTONEG_DISABLE) {
+		cap = speed_to_caps(cmd->speed);
+
+		if (!(lc->supported & cap) || cmd->speed == SPEED_1000 ||
+		    cmd->speed == SPEED_10000)
+			return -EINVAL;
+		lc->requested_speed = cap;
+		lc->advertising = 0;
+	} else {
+		cap = to_fw_linkcaps(cmd->advertising);
+		if (!(lc->supported & cap))
+			return -EINVAL;
+		lc->requested_speed = 0;
+		lc->advertising = cap | FW_PORT_CAP_ANEG;
+	}
+	lc->autoneg = cmd->autoneg;
+
+	if (netif_running(dev))
+		return t4_link_start(p->adapter, 0, p->tx_chan, lc);
+	return 0;
+}
+
+static void get_pauseparam(struct net_device *dev,
+			   struct ethtool_pauseparam *epause)
+{
+	struct port_info *p = netdev_priv(dev);
+
+	epause->autoneg = (p->link_cfg.requested_fc & PAUSE_AUTONEG) != 0;
+	epause->rx_pause = (p->link_cfg.fc & PAUSE_RX) != 0;
+	epause->tx_pause = (p->link_cfg.fc & PAUSE_TX) != 0;
+}
+
+static int set_pauseparam(struct net_device *dev,
+			  struct ethtool_pauseparam *epause)
+{
+	struct port_info *p = netdev_priv(dev);
+	struct link_config *lc = &p->link_cfg;
+
+	if (epause->autoneg == AUTONEG_DISABLE)
+		lc->requested_fc = 0;
+	else if (lc->supported & FW_PORT_CAP_ANEG)
+		lc->requested_fc = PAUSE_AUTONEG;
+	else
+		return -EINVAL;
+
+	if (epause->rx_pause)
+		lc->requested_fc |= PAUSE_RX;
+	if (epause->tx_pause)
+		lc->requested_fc |= PAUSE_TX;
+	if (netif_running(dev))
+		return t4_link_start(p->adapter, 0, p->tx_chan, lc);
+	return 0;
+}
+
+static u32 get_rx_csum(struct net_device *dev)
+{
+	struct port_info *p = netdev_priv(dev);
+
+	return p->rx_offload & RX_CSO;
+}
+
+static int set_rx_csum(struct net_device *dev, u32 data)
+{
+	struct port_info *p = netdev_priv(dev);
+
+	if (data)
+		p->rx_offload |= RX_CSO;
+	else
+		p->rx_offload &= ~RX_CSO;
+	return 0;
+}
+
+static void get_sge_param(struct net_device *dev, struct ethtool_ringparam *e)
+{
+	const struct port_info *pi = netdev_priv(dev);
+	const struct sge *s = &pi->adapter->sge;
+
+	e->rx_max_pending = MAX_RX_BUFFERS;
+	e->rx_mini_max_pending = MAX_RSPQ_ENTRIES;
+	e->rx_jumbo_max_pending = 0;
+	e->tx_max_pending = MAX_TXQ_ENTRIES;
+
+	e->rx_pending = s->ethrxq[pi->first_qset].fl.size - 8;
+	e->rx_mini_pending = s->ethrxq[pi->first_qset].rspq.size;
+	e->rx_jumbo_pending = 0;
+	e->tx_pending = s->ethtxq[pi->first_qset].q.size;
+}
+
+static int set_sge_param(struct net_device *dev, struct ethtool_ringparam *e)
+{
+	int i;
+	const struct port_info *pi = netdev_priv(dev);
+	struct adapter *adapter = pi->adapter;
+	struct sge *s = &adapter->sge;
+
+	if (e->rx_pending > MAX_RX_BUFFERS || e->rx_jumbo_pending ||
+	    e->tx_pending > MAX_TXQ_ENTRIES ||
+	    e->rx_mini_pending > MAX_RSPQ_ENTRIES ||
+	    e->rx_mini_pending < MIN_RSPQ_ENTRIES ||
+	    e->rx_pending < MIN_FL_ENTRIES || e->tx_pending < MIN_TXQ_ENTRIES)
+		return -EINVAL;
+
+	if (adapter->flags & FULL_INIT_DONE)
+		return -EBUSY;
+
+	for (i = 0; i < pi->nqsets; ++i) {
+		s->ethtxq[pi->first_qset + i].q.size = e->tx_pending;
+		s->ethrxq[pi->first_qset + i].fl.size = e->rx_pending + 8;
+		s->ethrxq[pi->first_qset + i].rspq.size = e->rx_mini_pending;
+	}
+	return 0;
+}
+
+static int closest_timer(const struct sge *s, int time)
+{
+	int i, delta, match = 0, min_delta = INT_MAX;
+
+	for (i = 0; i < ARRAY_SIZE(s->timer_val); i++) {
+		delta = time - s->timer_val[i];
+		if (delta < 0)
+			delta = -delta;
+		if (delta < min_delta) {
+			min_delta = delta;
+			match = i;
+		}
+	}
+	return match;
+}
+
+static int closest_thres(const struct sge *s, int thres)
+{
+	int i, delta, match = 0, min_delta = INT_MAX;
+
+	for (i = 0; i < ARRAY_SIZE(s->counter_val); i++) {
+		delta = thres - s->counter_val[i];
+		if (delta < 0)
+			delta = -delta;
+		if (delta < min_delta) {
+			min_delta = delta;
+			match = i;
+		}
+	}
+	return match;
+}
+
+/*
+ * Return a queue's interrupt hold-off time in us.  0 means no timer.
+ */
+static unsigned int qtimer_val(const struct adapter *adap,
+			       const struct sge_rspq *q)
+{
+	unsigned int idx = q->intr_params >> 1;
+
+	return idx < SGE_NTIMERS ? adap->sge.timer_val[idx] : 0;
+}
+
+/**
+ *	set_rxq_intr_params - set a queue's interrupt holdoff parameters
+ *	@adap: the adapter
+ *	@q: the Rx queue
+ *	@us: the hold-off time in us, or 0 to disable timer
+ *	@cnt: the hold-off packet count, or 0 to disable counter
+ *
+ *	Sets an Rx queue's interrupt hold-off time and packet count.  At least
+ *	one of the two needs to be enabled for the queue to generate interrupts.
+ */
+static int set_rxq_intr_params(struct adapter *adap, struct sge_rspq *q,
+			       unsigned int us, unsigned int cnt)
+{
+	if ((us | cnt) == 0)
+		cnt = 1;
+
+	if (cnt) {
+		int err;
+		u32 v, new_idx;
+
+		new_idx = closest_thres(&adap->sge, cnt);
+		if (q->desc && q->pktcnt_idx != new_idx) {
+			/* the queue has already been created, update it */
+			v = FW_PARAMS_MNEM(FW_PARAMS_MNEM_DMAQ) |
+			    FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_DMAQ_IQ_INTCNTTHRESH) |
+			    FW_PARAMS_PARAM_YZ(q->cntxt_id);
+			err = t4_set_params(adap, 0, 0, 0, 1, &v, &new_idx);
+			if (err)
+				return err;
+		}
+		q->pktcnt_idx = new_idx;
+	}
+
+	us = us == 0 ? 6 : closest_timer(&adap->sge, us);
+	q->intr_params = QINTR_TIMER_IDX(us) | (cnt > 0 ? QINTR_CNT_EN : 0);
+	return 0;
+}
+
+static int set_coalesce(struct net_device *dev, struct ethtool_coalesce *c)
+{
+	const struct port_info *pi = netdev_priv(dev);
+	struct adapter *adap = pi->adapter;
+
+	return set_rxq_intr_params(adap, &adap->sge.ethrxq[pi->first_qset].rspq,
+			c->rx_coalesce_usecs, c->rx_max_coalesced_frames);
+}
+
+static int get_coalesce(struct net_device *dev, struct ethtool_coalesce *c)
+{
+	const struct port_info *pi = netdev_priv(dev);
+	const struct adapter *adap = pi->adapter;
+	const struct sge_rspq *rq = &adap->sge.ethrxq[pi->first_qset].rspq;
+
+	c->rx_coalesce_usecs = qtimer_val(adap, rq);
+	c->rx_max_coalesced_frames = (rq->intr_params & QINTR_CNT_EN) ?
+		adap->sge.counter_val[rq->pktcnt_idx] : 0;
+	return 0;
+}
+
+/*
+ * Translate a physical EEPROM address to virtual.  The first 1K is accessed
+ * through virtual addresses starting at 31K, the rest is accessed through
+ * virtual addresses starting at 0.  This mapping is correct only for PF0.
+ */
+static int eeprom_ptov(unsigned int phys_addr)
+{
+	if (phys_addr < 1024)
+		return phys_addr + (31 << 10);
+	if (phys_addr < EEPROMSIZE)
+		return phys_addr - 1024;
+	return -EINVAL;
+}
+
+/*
+ * The next two routines implement eeprom read/write from physical addresses.
+ * The physical->virtual translation is correct only for PF0.
+ */
+static int eeprom_rd_phys(struct adapter *adap, unsigned int phys_addr, u32 *v)
+{
+	int vaddr = eeprom_ptov(phys_addr);
+
+	if (vaddr >= 0)
+		vaddr = pci_read_vpd(adap->pdev, vaddr, sizeof(u32), v);
+	return vaddr < 0 ? vaddr : 0;
+}
+
+static int eeprom_wr_phys(struct adapter *adap, unsigned int phys_addr, u32 v)
+{
+	int vaddr = eeprom_ptov(phys_addr);
+
+	if (vaddr >= 0)
+		vaddr = pci_write_vpd(adap->pdev, vaddr, sizeof(u32), &v);
+	return vaddr < 0 ? vaddr : 0;
+}
+
+#define EEPROM_MAGIC 0x38E2F10C
+
+static int get_eeprom(struct net_device *dev, struct ethtool_eeprom *e,
+		      u8 *data)
+{
+	int i, err = 0;
+	struct adapter *adapter = netdev2adap(dev);
+
+	u8 *buf = kmalloc(EEPROMSIZE, GFP_KERNEL);
+	if (!buf)
+		return -ENOMEM;
+
+	e->magic = EEPROM_MAGIC;
+	for (i = e->offset & ~3; !err && i < e->offset + e->len; i += 4)
+		err = eeprom_rd_phys(adapter, i, (u32 *)&buf[i]);
+
+	if (!err)
+		memcpy(data, buf + e->offset, e->len);
+	kfree(buf);
+	return err;
+}
+
+static int set_eeprom(struct net_device *dev, struct ethtool_eeprom *eeprom,
+		      u8 *data)
+{
+	u8 *buf;
+	int err = 0;
+	u32 aligned_offset, aligned_len, *p;
+	struct adapter *adapter = netdev2adap(dev);
+
+	if (eeprom->magic != EEPROM_MAGIC)
+		return -EINVAL;
+
+	aligned_offset = eeprom->offset & ~3;
+	aligned_len = (eeprom->len + (eeprom->offset & 3) + 3) & ~3;
+
+	if (aligned_offset != eeprom->offset || aligned_len != eeprom->len) {
+		/*
+		 * RMW possibly needed for first or last words.
+		 */
+		buf = kmalloc(aligned_len, GFP_KERNEL);
+		if (!buf)
+			return -ENOMEM;
+		err = eeprom_rd_phys(adapter, aligned_offset, (u32 *)buf);
+		if (!err && aligned_len > 4)
+			err = eeprom_rd_phys(adapter,
+					     aligned_offset + aligned_len - 4,
+					     (u32 *)&buf[aligned_len - 4]);
+		if (err)
+			goto out;
+		memcpy(buf + (eeprom->offset & 3), data, eeprom->len);
+	} else
+		buf = data;
+
+	err = t4_seeprom_wp(adapter, false);
+	if (err)
+		goto out;
+
+	for (p = (u32 *)buf; !err && aligned_len; aligned_len -= 4, p++) {
+		err = eeprom_wr_phys(adapter, aligned_offset, *p);
+		aligned_offset += 4;
+	}
+
+	if (!err)
+		err = t4_seeprom_wp(adapter, true);
+out:
+	if (buf != data)
+		kfree(buf);
+	return err;
+}
+
+static int set_flash(struct net_device *netdev, struct ethtool_flash *ef)
+{
+	int ret;
+	const struct firmware *fw;
+	struct adapter *adap = netdev2adap(netdev);
+
+	ef->data[sizeof(ef->data) - 1] = '\0';
+	ret = request_firmware(&fw, ef->data, adap->pdev_dev);
+	if (ret < 0)
+		return ret;
+
+	ret = t4_load_fw(adap, fw->data, fw->size);
+	release_firmware(fw);
+	if (!ret)
+		dev_info(adap->pdev_dev, "loaded firmware %s\n", ef->data);
+	return ret;
+}
+
+#define WOL_SUPPORTED (WAKE_BCAST | WAKE_MAGIC)
+#define BCAST_CRC 0xa0ccc1a6
+
+static void get_wol(struct net_device *dev, struct ethtool_wolinfo *wol)
+{
+	wol->supported = WAKE_BCAST | WAKE_MAGIC;
+	wol->wolopts = netdev2adap(dev)->wol;
+	memset(&wol->sopass, 0, sizeof(wol->sopass));
+}
+
+static int set_wol(struct net_device *dev, struct ethtool_wolinfo *wol)
+{
+	int err = 0;
+	struct port_info *pi = netdev_priv(dev);
+
+	if (wol->wolopts & ~WOL_SUPPORTED)
+		return -EINVAL;
+	t4_wol_magic_enable(pi->adapter, pi->tx_chan,
+			    (wol->wolopts & WAKE_MAGIC) ? dev->dev_addr : NULL);
+	if (wol->wolopts & WAKE_BCAST) {
+		err = t4_wol_pat_enable(pi->adapter, pi->tx_chan, 0xfe, ~0ULL,
+					~0ULL, 0, false);
+		if (!err)
+			err = t4_wol_pat_enable(pi->adapter, pi->tx_chan, 1,
+						~6ULL, ~0ULL, BCAST_CRC, true);
+	} else
+		t4_wol_pat_enable(pi->adapter, pi->tx_chan, 0, 0, 0, 0, false);
+	return err;
+}
+
+static int set_tso(struct net_device *dev, u32 value)
+{
+	if (value)
+		dev->features |= NETIF_F_TSO | NETIF_F_TSO6;
+	else
+		dev->features &= ~(NETIF_F_TSO | NETIF_F_TSO6);
+	return 0;
+}
+
+static struct ethtool_ops cxgb_ethtool_ops = {
+	.get_settings      = get_settings,
+	.set_settings      = set_settings,
+	.get_drvinfo       = get_drvinfo,
+	.get_msglevel      = get_msglevel,
+	.set_msglevel      = set_msglevel,
+	.get_ringparam     = get_sge_param,
+	.set_ringparam     = set_sge_param,
+	.get_coalesce      = get_coalesce,
+	.set_coalesce      = set_coalesce,
+	.get_eeprom_len    = get_eeprom_len,
+	.get_eeprom        = get_eeprom,
+	.set_eeprom        = set_eeprom,
+	.get_pauseparam    = get_pauseparam,
+	.set_pauseparam    = set_pauseparam,
+	.get_rx_csum       = get_rx_csum,
+	.set_rx_csum       = set_rx_csum,
+	.set_tx_csum       = ethtool_op_set_tx_ipv6_csum,
+	.set_sg            = ethtool_op_set_sg,
+	.get_link          = ethtool_op_get_link,
+	.get_strings       = get_strings,
+	.phys_id           = identify_port,
+	.nway_reset        = restart_autoneg,
+	.get_sset_count    = get_sset_count,
+	.get_ethtool_stats = get_stats,
+	.get_regs_len      = get_regs_len,
+	.get_regs          = get_regs,
+	.get_wol           = get_wol,
+	.set_wol           = set_wol,
+	.set_tso           = set_tso,
+	.flash_device      = set_flash,
+};
+
+/*
+ * debugfs support
+ */
+
+static int mem_open(struct inode *inode, struct file *file)
+{
+	file->private_data = inode->i_private;
+	return 0;
+}
+
+static ssize_t mem_read(struct file *file, char __user *buf, size_t count,
+			loff_t *ppos)
+{
+	loff_t pos = *ppos;
+	loff_t avail = file->f_path.dentry->d_inode->i_size;
+	unsigned int mem = (uintptr_t)file->private_data & 3;
+	struct adapter *adap = file->private_data - mem;
+
+	if (pos < 0)
+		return -EINVAL;
+	if (pos >= avail)
+		return 0;
+	if (count > avail - pos)
+		count = avail - pos;
+
+	while (count) {
+		size_t len;
+		int ret, ofst;
+		__be32 data[16];
+
+		if (mem == MEM_MC)
+			ret = t4_mc_read(adap, pos, data, NULL);
+		else
+			ret = t4_edc_read(adap, mem, pos, data, NULL);
+		if (ret)
+			return ret;
+
+		ofst = pos % sizeof(data);
+		len = min(count, sizeof(data) - ofst);
+		if (copy_to_user(buf, (u8 *)data + ofst, len))
+			return -EFAULT;
+
+		buf += len;
+		pos += len;
+		count -= len;
+	}
+	count = pos - *ppos;
+	*ppos = pos;
+	return count;
+}
+
+static const struct file_operations mem_debugfs_fops = {
+	.owner   = THIS_MODULE,
+	.open    = mem_open,
+	.read    = mem_read,
+};
+
+static void __devinit add_debugfs_mem(struct adapter *adap, const char *name,
+				      unsigned int idx, unsigned int size_mb)
+{
+	struct dentry *de;
+
+	de = debugfs_create_file(name, S_IRUSR, adap->debugfs_root,
+				 (void *)adap + idx, &mem_debugfs_fops);
+	if (de && de->d_inode)
+		de->d_inode->i_size = size_mb << 20;
+}
+
+static int __devinit setup_debugfs(struct adapter *adap)
+{
+	int i;
+
+	if (IS_ERR_OR_NULL(adap->debugfs_root))
+		return -1;
+
+	i = t4_read_reg(adap, MA_TARGET_MEM_ENABLE);
+	if (i & EDRAM0_ENABLE)
+		add_debugfs_mem(adap, "edc0", MEM_EDC0, 5);
+	if (i & EDRAM1_ENABLE)
+		add_debugfs_mem(adap, "edc1", MEM_EDC1, 5);
+	if (i & EXT_MEM_ENABLE)
+		add_debugfs_mem(adap, "mc", MEM_MC,
+			EXT_MEM_SIZE_GET(t4_read_reg(adap, MA_EXT_MEMORY_BAR)));
+	if (adap->l2t)
+		debugfs_create_file("l2t", S_IRUSR, adap->debugfs_root, adap,
+				    &t4_l2t_fops);
+	return 0;
+}
+
+/*
+ * upper-layer driver support
+ */
+
+/*
+ * Allocate an active-open TID and set it to the supplied value.
+ */
+int cxgb4_alloc_atid(struct tid_info *t, void *data)
+{
+	int atid = -1;
+
+	spin_lock_bh(&t->atid_lock);
+	if (t->afree) {
+		union aopen_entry *p = t->afree;
+
+		atid = p - t->atid_tab;
+		t->afree = p->next;
+		p->data = data;
+		t->atids_in_use++;
+	}
+	spin_unlock_bh(&t->atid_lock);
+	return atid;
+}
+EXPORT_SYMBOL(cxgb4_alloc_atid);
+
+/*
+ * Release an active-open TID.
+ */
+void cxgb4_free_atid(struct tid_info *t, unsigned int atid)
+{
+	union aopen_entry *p = &t->atid_tab[atid];
+
+	spin_lock_bh(&t->atid_lock);
+	p->next = t->afree;
+	t->afree = p;
+	t->atids_in_use--;
+	spin_unlock_bh(&t->atid_lock);
+}
+EXPORT_SYMBOL(cxgb4_free_atid);
+
+/*
+ * Allocate a server TID and set it to the supplied value.
+ */
+int cxgb4_alloc_stid(struct tid_info *t, int family, void *data)
+{
+	int stid;
+
+	spin_lock_bh(&t->stid_lock);
+	if (family == PF_INET) {
+		stid = find_first_zero_bit(t->stid_bmap, t->nstids);
+		if (stid < t->nstids)
+			__set_bit(stid, t->stid_bmap);
+		else
+			stid = -1;
+	} else {
+		stid = bitmap_find_free_region(t->stid_bmap, t->nstids, 2);
+		if (stid < 0)
+			stid = -1;
+	}
+	if (stid >= 0) {
+		t->stid_tab[stid].data = data;
+		stid += t->stid_base;
+		t->stids_in_use++;
+	}
+	spin_unlock_bh(&t->stid_lock);
+	return stid;
+}
+EXPORT_SYMBOL(cxgb4_alloc_stid);
+
+/*
+ * Release a server TID.
+ */
+void cxgb4_free_stid(struct tid_info *t, unsigned int stid, int family)
+{
+	stid -= t->stid_base;
+	spin_lock_bh(&t->stid_lock);
+	if (family == PF_INET)
+		__clear_bit(stid, t->stid_bmap);
+	else
+		bitmap_release_region(t->stid_bmap, stid, 2);
+	t->stid_tab[stid].data = NULL;
+	t->stids_in_use--;
+	spin_unlock_bh(&t->stid_lock);
+}
+EXPORT_SYMBOL(cxgb4_free_stid);
+
+/*
+ * Populate a TID_RELEASE WR.  Caller must properly size the skb.
+ */
+static void mk_tid_release(struct sk_buff *skb, unsigned int chan,
+			   unsigned int tid)
+{
+	struct cpl_tid_release *req;
+
+	set_wr_txq(skb, CPL_PRIORITY_SETUP, chan);
+	req = (struct cpl_tid_release *)__skb_put(skb, sizeof(*req));
+	INIT_TP_WR(req, tid);
+	OPCODE_TID(req) = htonl(MK_OPCODE_TID(CPL_TID_RELEASE, tid));
+}
+
+/*
+ * Queue a TID release request and if necessary schedule a work queue to
+ * process it.
+ */
+void cxgb4_queue_tid_release(struct tid_info *t, unsigned int chan,
+			     unsigned int tid)
+{
+	void **p = &t->tid_tab[tid];
+	struct adapter *adap = container_of(t, struct adapter, tids);
+
+	spin_lock_bh(&adap->tid_release_lock);
+	*p = adap->tid_release_head;
+	/* Low 2 bits encode the Tx channel number */
+	adap->tid_release_head = (void **)((uintptr_t)p | chan);
+	if (!adap->tid_release_task_busy) {
+		adap->tid_release_task_busy = true;
+		schedule_work(&adap->tid_release_task);
+	}
+	spin_unlock_bh(&adap->tid_release_lock);
+}
+EXPORT_SYMBOL(cxgb4_queue_tid_release);
+
+/*
+ * Process the list of pending TID release requests.
+ */
+static void process_tid_release_list(struct work_struct *work)
+{
+	struct sk_buff *skb;
+	struct adapter *adap;
+
+	adap = container_of(work, struct adapter, tid_release_task);
+
+	spin_lock_bh(&adap->tid_release_lock);
+	while (adap->tid_release_head) {
+		void **p = adap->tid_release_head;
+		unsigned int chan = (uintptr_t)p & 3;
+		p = (void *)p - chan;
+
+		adap->tid_release_head = *p;
+		*p = NULL;
+		spin_unlock_bh(&adap->tid_release_lock);
+
+		while (!(skb = alloc_skb(sizeof(struct cpl_tid_release),
+					 GFP_KERNEL)))
+			schedule_timeout_uninterruptible(1);
+
+		mk_tid_release(skb, chan, p - adap->tids.tid_tab);
+		t4_ofld_send(adap, skb);
+		spin_lock_bh(&adap->tid_release_lock);
+	}
+	adap->tid_release_task_busy = false;
+	spin_unlock_bh(&adap->tid_release_lock);
+}
+
+/*
+ * Release a TID and inform HW.  If we are unable to allocate the release
+ * message we defer to a work queue.
+ */
+void cxgb4_remove_tid(struct tid_info *t, unsigned int chan, unsigned int tid)
+{
+	void *old;
+	struct sk_buff *skb;
+	struct adapter *adap = container_of(t, struct adapter, tids);
+
+	old = t->tid_tab[tid];
+	skb = alloc_skb(sizeof(struct cpl_tid_release), GFP_ATOMIC);
+	if (likely(skb)) {
+		t->tid_tab[tid] = NULL;
+		mk_tid_release(skb, chan, tid);
+		t4_ofld_send(adap, skb);
+	} else
+		cxgb4_queue_tid_release(t, chan, tid);
+	if (old)
+		atomic_dec(&t->tids_in_use);
+}
+EXPORT_SYMBOL(cxgb4_remove_tid);
+
+/*
+ * Allocate and initialize the TID tables.  Returns 0 on success.
+ */
+static int tid_init(struct tid_info *t)
+{
+	size_t size;
+	unsigned int natids = t->natids;
+
+	size = t->ntids * sizeof(*t->tid_tab) + natids * sizeof(*t->atid_tab) +
+	       t->nstids * sizeof(*t->stid_tab) +
+	       BITS_TO_LONGS(t->nstids) * sizeof(long);
+	t->tid_tab = t4_alloc_mem(size);
+	if (!t->tid_tab)
+		return -ENOMEM;
+
+	t->atid_tab = (union aopen_entry *)&t->tid_tab[t->ntids];
+	t->stid_tab = (struct serv_entry *)&t->atid_tab[natids];
+	t->stid_bmap = (unsigned long *)&t->stid_tab[t->nstids];
+	spin_lock_init(&t->stid_lock);
+	spin_lock_init(&t->atid_lock);
+
+	t->stids_in_use = 0;
+	t->afree = NULL;
+	t->atids_in_use = 0;
+	atomic_set(&t->tids_in_use, 0);
+
+	/* Setup the free list for atid_tab and clear the stid bitmap. */
+	if (natids) {
+		while (--natids)
+			t->atid_tab[natids - 1].next = &t->atid_tab[natids];
+		t->afree = t->atid_tab;
+	}
+	bitmap_zero(t->stid_bmap, t->nstids);
+	return 0;
+}
+
+/**
+ *	cxgb4_create_server - create an IP server
+ *	@dev: the device
+ *	@stid: the server TID
+ *	@sip: local IP address to bind server to
+ *	@sport: the server's TCP port
+ *	@queue: queue to direct messages from this server to
+ *
+ *	Create an IP server for the given port and address.
+ *	Returns <0 on error and one of the %NET_XMIT_* values on success.
+ */
+int cxgb4_create_server(const struct net_device *dev, unsigned int stid,
+			__be32 sip, __be16 sport, unsigned int queue)
+{
+	unsigned int chan;
+	struct sk_buff *skb;
+	struct adapter *adap;
+	struct cpl_pass_open_req *req;
+
+	skb = alloc_skb(sizeof(*req), GFP_KERNEL);
+	if (!skb)
+		return -ENOMEM;
+
+	adap = netdev2adap(dev);
+	req = (struct cpl_pass_open_req *)__skb_put(skb, sizeof(*req));
+	INIT_TP_WR(req, 0);
+	OPCODE_TID(req) = htonl(MK_OPCODE_TID(CPL_PASS_OPEN_REQ, stid));
+	req->local_port = sport;
+	req->peer_port = htons(0);
+	req->local_ip = sip;
+	req->peer_ip = htonl(0);
+	chan = netdev2pinfo(adap->sge.ingr_map[queue]->netdev)->tx_chan;
+	req->opt0 = cpu_to_be64(TX_CHAN(chan));
+	req->opt1 = cpu_to_be64(CONN_POLICY_ASK |
+				SYN_RSS_ENABLE | SYN_RSS_QUEUE(queue));
+	return t4_mgmt_tx(adap, skb);
+}
+EXPORT_SYMBOL(cxgb4_create_server);
+
+/**
+ *	cxgb4_create_server6 - create an IPv6 server
+ *	@dev: the device
+ *	@stid: the server TID
+ *	@sip: local IPv6 address to bind server to
+ *	@sport: the server's TCP port
+ *	@queue: queue to direct messages from this server to
+ *
+ *	Create an IPv6 server for the given port and address.
+ *	Returns <0 on error and one of the %NET_XMIT_* values on success.
+ */
+int cxgb4_create_server6(const struct net_device *dev, unsigned int stid,
+			 const struct in6_addr *sip, __be16 sport,
+			 unsigned int queue)
+{
+	unsigned int chan;
+	struct sk_buff *skb;
+	struct adapter *adap;
+	struct cpl_pass_open_req6 *req;
+
+	skb = alloc_skb(sizeof(*req), GFP_KERNEL);
+	if (!skb)
+		return -ENOMEM;
+
+	adap = netdev2adap(dev);
+	req = (struct cpl_pass_open_req6 *)__skb_put(skb, sizeof(*req));
+	INIT_TP_WR(req, 0);
+	OPCODE_TID(req) = htonl(MK_OPCODE_TID(CPL_PASS_OPEN_REQ6, stid));
+	req->local_port = sport;
+	req->peer_port = htons(0);
+	req->local_ip_hi = *(__be64 *)(sip->s6_addr);
+	req->local_ip_lo = *(__be64 *)(sip->s6_addr + 8);
+	req->peer_ip_hi = cpu_to_be64(0);
+	req->peer_ip_lo = cpu_to_be64(0);
+	chan = netdev2pinfo(adap->sge.ingr_map[queue]->netdev)->tx_chan;
+	req->opt0 = cpu_to_be64(TX_CHAN(chan));
+	req->opt1 = cpu_to_be64(CONN_POLICY_ASK |
+				SYN_RSS_ENABLE | SYN_RSS_QUEUE(queue));
+	return t4_mgmt_tx(adap, skb);
+}
+EXPORT_SYMBOL(cxgb4_create_server6);
+
+/**
+ *	cxgb4_best_mtu - find the entry in the MTU table closest to an MTU
+ *	@mtus: the HW MTU table
+ *	@mtu: the target MTU
+ *	@idx: index of selected entry in the MTU table
+ *
+ *	Returns the index and the value in the HW MTU table that is closest to
+ *	but does not exceed @mtu, unless @mtu is smaller than any value in the
+ *	table, in which case that smallest available value is selected.
+ */
+unsigned int cxgb4_best_mtu(const unsigned short *mtus, unsigned short mtu,
+			    unsigned int *idx)
+{
+	unsigned int i = 0;
+
+	while (i < NMTUS - 1 && mtus[i + 1] <= mtu)
+		++i;
+	if (idx)
+		*idx = i;
+	return mtus[i];
+}
+EXPORT_SYMBOL(cxgb4_best_mtu);
+
+/**
+ *	cxgb4_port_chan - get the HW channel of a port
+ *	@dev: the net device for the port
+ *
+ *	Return the HW Tx channel of the given port.
+ */
+unsigned int cxgb4_port_chan(const struct net_device *dev)
+{
+	return netdev2pinfo(dev)->tx_chan;
+}
+EXPORT_SYMBOL(cxgb4_port_chan);
+
+/**
+ *	cxgb4_port_viid - get the VI id of a port
+ *	@dev: the net device for the port
+ *
+ *	Return the VI id of the given port.
+ */
+unsigned int cxgb4_port_viid(const struct net_device *dev)
+{
+	return netdev2pinfo(dev)->viid;
+}
+EXPORT_SYMBOL(cxgb4_port_viid);
+
+/**
+ *	cxgb4_port_idx - get the index of a port
+ *	@dev: the net device for the port
+ *
+ *	Return the index of the given port.
+ */
+unsigned int cxgb4_port_idx(const struct net_device *dev)
+{
+	return netdev2pinfo(dev)->port_id;
+}
+EXPORT_SYMBOL(cxgb4_port_idx);
+
+/**
+ *	cxgb4_netdev_by_hwid - return the net device of a HW port
+ *	@pdev: identifies the adapter
+ *	@id: the HW port id
+ *
+ *	Return the net device associated with the interface with the given HW
+ *	id.
+ */
+struct net_device *cxgb4_netdev_by_hwid(struct pci_dev *pdev, unsigned int id)
+{
+	const struct adapter *adap = pci_get_drvdata(pdev);
+
+	if (!adap || id >= NCHAN)
+		return NULL;
+	id = adap->chan_map[id];
+	return id < MAX_NPORTS ? adap->port[id] : NULL;
+}
+EXPORT_SYMBOL(cxgb4_netdev_by_hwid);
+
+void cxgb4_get_tcp_stats(struct pci_dev *pdev, struct tp_tcp_stats *v4,
+			 struct tp_tcp_stats *v6)
+{
+	struct adapter *adap = pci_get_drvdata(pdev);
+
+	spin_lock(&adap->stats_lock);
+	t4_tp_get_tcp_stats(adap, v4, v6);
+	spin_unlock(&adap->stats_lock);
+}
+EXPORT_SYMBOL(cxgb4_get_tcp_stats);
+
+void cxgb4_iscsi_init(struct net_device *dev, unsigned int tag_mask,
+		      const unsigned int *pgsz_order)
+{
+	struct adapter *adap = netdev2adap(dev);
+
+	t4_write_reg(adap, ULP_RX_ISCSI_TAGMASK, tag_mask);
+	t4_write_reg(adap, ULP_RX_ISCSI_PSZ, HPZ0(pgsz_order[0]) |
+		     HPZ1(pgsz_order[1]) | HPZ2(pgsz_order[2]) |
+		     HPZ3(pgsz_order[3]));
+}
+EXPORT_SYMBOL(cxgb4_iscsi_init);
+
+static struct pci_driver cxgb4_driver;
+
+static void check_neigh_update(struct neighbour *neigh)
+{
+	const struct device *parent;
+	const struct net_device *netdev = neigh->dev;
+
+	if (netdev->priv_flags & IFF_802_1Q_VLAN)
+		netdev = vlan_dev_real_dev(netdev);
+	parent = netdev->dev.parent;
+	if (parent && parent->driver == &cxgb4_driver.driver)
+		t4_l2t_update(dev_get_drvdata(parent), neigh);
+}
+
+static int netevent_cb(struct notifier_block *nb, unsigned long event,
+		       void *data)
+{
+	switch (event) {
+	case NETEVENT_NEIGH_UPDATE:
+		check_neigh_update(data);
+		break;
+	case NETEVENT_PMTU_UPDATE:
+	case NETEVENT_REDIRECT:
+	default:
+		break;
+	}
+	return 0;
+}
+
+static bool netevent_registered;
+static struct notifier_block cxgb4_netevent_nb = {
+	.notifier_call = netevent_cb
+};
+
+static void uld_attach(struct adapter *adap, unsigned int uld)
+{
+	void *handle;
+	struct cxgb4_lld_info lli;
+
+	lli.pdev = adap->pdev;
+	lli.l2t = adap->l2t;
+	lli.tids = &adap->tids;
+	lli.ports = adap->port;
+	lli.vr = &adap->vres;
+	lli.mtus = adap->params.mtus;
+	if (uld == CXGB4_ULD_RDMA) {
+		lli.rxq_ids = adap->sge.rdma_rxq;
+		lli.nrxq = adap->sge.rdmaqs;
+	} else if (uld == CXGB4_ULD_ISCSI) {
+		lli.rxq_ids = adap->sge.ofld_rxq;
+		lli.nrxq = adap->sge.ofldqsets;
+	}
+	lli.ntxq = adap->sge.ofldqsets;
+	lli.nchan = adap->params.nports;
+	lli.nports = adap->params.nports;
+	lli.wr_cred = adap->params.ofldq_wr_cred;
+	lli.adapter_type = adap->params.rev;
+	lli.iscsi_iolen = MAXRXDATA_GET(t4_read_reg(adap, TP_PARA_REG2));
+	lli.udb_density = 1 << QUEUESPERPAGEPF0_GET(
+			t4_read_reg(adap, SGE_EGRESS_QUEUES_PER_PAGE_PF));
+	lli.ucq_density = 1 << QUEUESPERPAGEPF0_GET(
+			t4_read_reg(adap, SGE_INGRESS_QUEUES_PER_PAGE_PF));
+	lli.gts_reg = adap->regs + MYPF_REG(SGE_PF_GTS);
+	lli.db_reg = adap->regs + MYPF_REG(SGE_PF_KDOORBELL);
+	lli.fw_vers = adap->params.fw_vers;
+
+	handle = ulds[uld].add(&lli);
+	if (IS_ERR(handle)) {
+		dev_warn(adap->pdev_dev,
+			 "could not attach to the %s driver, error %ld\n",
+			 uld_str[uld], PTR_ERR(handle));
+		return;
+	}
+
+	adap->uld_handle[uld] = handle;
+
+	if (!netevent_registered) {
+		register_netevent_notifier(&cxgb4_netevent_nb);
+		netevent_registered = true;
+	}
+}
+
+static void attach_ulds(struct adapter *adap)
+{
+	unsigned int i;
+
+	mutex_lock(&uld_mutex);
+	list_add_tail(&adap->list_node, &adapter_list);
+	for (i = 0; i < CXGB4_ULD_MAX; i++)
+		if (ulds[i].add)
+			uld_attach(adap, i);
+	mutex_unlock(&uld_mutex);
+}
+
+static void detach_ulds(struct adapter *adap)
+{
+	unsigned int i;
+
+	mutex_lock(&uld_mutex);
+	list_del(&adap->list_node);
+	for (i = 0; i < CXGB4_ULD_MAX; i++)
+		if (adap->uld_handle[i]) {
+			ulds[i].state_change(adap->uld_handle[i],
+					     CXGB4_STATE_DETACH);
+			adap->uld_handle[i] = NULL;
+		}
+	if (netevent_registered && list_empty(&adapter_list)) {
+		unregister_netevent_notifier(&cxgb4_netevent_nb);
+		netevent_registered = false;
+	}
+	mutex_unlock(&uld_mutex);
+}
+
+static void notify_ulds(struct adapter *adap, enum cxgb4_state new_state)
+{
+	unsigned int i;
+
+	mutex_lock(&uld_mutex);
+	for (i = 0; i < CXGB4_ULD_MAX; i++)
+		if (adap->uld_handle[i])
+			ulds[i].state_change(adap->uld_handle[i], new_state);
+	mutex_unlock(&uld_mutex);
+}
+
+/**
+ *	cxgb4_register_uld - register an upper-layer driver
+ *	@type: the ULD type
+ *	@p: the ULD methods
+ *
+ *	Registers an upper-layer driver with this driver and notifies the ULD
+ *	about any presently available devices that support its type.  Returns
+ *	%-EBUSY if a ULD of the same type is already registered.
+ */
+int cxgb4_register_uld(enum cxgb4_uld type, const struct cxgb4_uld_info *p)
+{
+	int ret = 0;
+	struct adapter *adap;
+
+	if (type >= CXGB4_ULD_MAX)
+		return -EINVAL;
+	mutex_lock(&uld_mutex);
+	if (ulds[type].add) {
+		ret = -EBUSY;
+		goto out;
+	}
+	ulds[type] = *p;
+	list_for_each_entry(adap, &adapter_list, list_node)
+		uld_attach(adap, type);
+out:	mutex_unlock(&uld_mutex);
+	return ret;
+}
+EXPORT_SYMBOL(cxgb4_register_uld);
+
+/**
+ *	cxgb4_unregister_uld - unregister an upper-layer driver
+ *	@type: the ULD type
+ *
+ *	Unregisters an existing upper-layer driver.
+ */
+int cxgb4_unregister_uld(enum cxgb4_uld type)
+{
+	struct adapter *adap;
+
+	if (type >= CXGB4_ULD_MAX)
+		return -EINVAL;
+	mutex_lock(&uld_mutex);
+	list_for_each_entry(adap, &adapter_list, list_node)
+		adap->uld_handle[type] = NULL;
+	ulds[type].add = NULL;
+	mutex_unlock(&uld_mutex);
+	return 0;
+}
+EXPORT_SYMBOL(cxgb4_unregister_uld);
+
+/**
+ *	cxgb_up - enable the adapter
+ *	@adap: adapter being enabled
+ *
+ *	Called when the first port is enabled, this function performs the
+ *	actions necessary to make an adapter operational, such as completing
+ *	the initialization of HW modules, and enabling interrupts.
+ *
+ *	Must be called with the rtnl lock held.
+ */
+static int cxgb_up(struct adapter *adap)
+{
+	int err = 0;
+
+	if (!(adap->flags & FULL_INIT_DONE)) {
+		err = setup_sge_queues(adap);
+		if (err)
+			goto out;
+		err = setup_rss(adap);
+		if (err) {
+			t4_free_sge_resources(adap);
+			goto out;
+		}
+		if (adap->flags & USING_MSIX)
+			name_msix_vecs(adap);
+		adap->flags |= FULL_INIT_DONE;
+	}
+
+	if (adap->flags & USING_MSIX) {
+		err = request_irq(adap->msix_info[0].vec, t4_nondata_intr, 0,
+				  adap->msix_info[0].desc, adap);
+		if (err)
+			goto irq_err;
+
+		err = request_msix_queue_irqs(adap);
+		if (err) {
+			free_irq(adap->msix_info[0].vec, adap);
+			goto irq_err;
+		}
+	} else {
+		err = request_irq(adap->pdev->irq, t4_intr_handler(adap),
+				  (adap->flags & USING_MSI) ? 0 : IRQF_SHARED,
+				  adap->name, adap);
+		if (err)
+			goto irq_err;
+	}
+	enable_rx(adap);
+	t4_sge_start(adap);
+	t4_intr_enable(adap);
+	notify_ulds(adap, CXGB4_STATE_UP);
+ out:
+	return err;
+ irq_err:
+	dev_err(adap->pdev_dev, "request_irq failed, err %d\n", err);
+	goto out;
+}
+
+static void cxgb_down(struct adapter *adapter)
+{
+	t4_intr_disable(adapter);
+	cancel_work_sync(&adapter->tid_release_task);
+	adapter->tid_release_task_busy = false;
+
+	if (adapter->flags & USING_MSIX) {
+		free_msix_queue_irqs(adapter);
+		free_irq(adapter->msix_info[0].vec, adapter);
+	} else
+		free_irq(adapter->pdev->irq, adapter);
+	quiesce_rx(adapter);
+}
+
+/*
+ * net_device operations
+ */
+static int cxgb_open(struct net_device *dev)
+{
+	int err;
+	struct port_info *pi = netdev_priv(dev);
+	struct adapter *adapter = pi->adapter;
+
+	if (!adapter->open_device_map && (err = cxgb_up(adapter)) < 0)
+		return err;
+
+	dev->real_num_tx_queues = pi->nqsets;
+	set_bit(pi->tx_chan, &adapter->open_device_map);
+	link_start(dev);
+	netif_tx_start_all_queues(dev);
+	return 0;
+}
+
+static int cxgb_close(struct net_device *dev)
+{
+	int ret;
+	struct port_info *pi = netdev_priv(dev);
+	struct adapter *adapter = pi->adapter;
+
+	netif_tx_stop_all_queues(dev);
+	netif_carrier_off(dev);
+	ret = t4_enable_vi(adapter, 0, pi->viid, false, false);
+
+	clear_bit(pi->tx_chan, &adapter->open_device_map);
+
+	if (!adapter->open_device_map)
+		cxgb_down(adapter);
+	return 0;
+}
+
+static struct net_device_stats *cxgb_get_stats(struct net_device *dev)
+{
+	struct port_stats stats;
+	struct port_info *p = netdev_priv(dev);
+	struct adapter *adapter = p->adapter;
+	struct net_device_stats *ns = &dev->stats;
+
+	spin_lock(&adapter->stats_lock);
+	t4_get_port_stats(adapter, p->tx_chan, &stats);
+	spin_unlock(&adapter->stats_lock);
+
+	ns->tx_bytes   = stats.tx_octets;
+	ns->tx_packets = stats.tx_frames;
+	ns->rx_bytes   = stats.rx_octets;
+	ns->rx_packets = stats.rx_frames;
+	ns->multicast  = stats.rx_mcast_frames;
+
+	/* detailed rx_errors */
+	ns->rx_length_errors = stats.rx_jabber + stats.rx_too_long +
+			       stats.rx_runt;
+	ns->rx_over_errors   = 0;
+	ns->rx_crc_errors    = stats.rx_fcs_err;
+	ns->rx_frame_errors  = stats.rx_symbol_err;
+	ns->rx_fifo_errors   = stats.rx_ovflow0 + stats.rx_ovflow1 +
+			       stats.rx_ovflow2 + stats.rx_ovflow3 +
+			       stats.rx_trunc0 + stats.rx_trunc1 +
+			       stats.rx_trunc2 + stats.rx_trunc3;
+	ns->rx_missed_errors = 0;
+
+	/* detailed tx_errors */
+	ns->tx_aborted_errors   = 0;
+	ns->tx_carrier_errors   = 0;
+	ns->tx_fifo_errors      = 0;
+	ns->tx_heartbeat_errors = 0;
+	ns->tx_window_errors    = 0;
+
+	ns->tx_errors = stats.tx_error_frames;
+	ns->rx_errors = stats.rx_symbol_err + stats.rx_fcs_err +
+		ns->rx_length_errors + stats.rx_len_err + ns->rx_fifo_errors;
+	return ns;
+}
+
+static int cxgb_ioctl(struct net_device *dev, struct ifreq *req, int cmd)
+{
+	int ret = 0, prtad, devad;
+	struct port_info *pi = netdev_priv(dev);
+	struct mii_ioctl_data *data = (struct mii_ioctl_data *)&req->ifr_data;
+
+	switch (cmd) {
+	case SIOCGMIIPHY:
+		if (pi->mdio_addr < 0)
+			return -EOPNOTSUPP;
+		data->phy_id = pi->mdio_addr;
+		break;
+	case SIOCGMIIREG:
+	case SIOCSMIIREG:
+		if (mdio_phy_id_is_c45(data->phy_id)) {
+			prtad = mdio_phy_id_prtad(data->phy_id);
+			devad = mdio_phy_id_devad(data->phy_id);
+		} else if (data->phy_id < 32) {
+			prtad = data->phy_id;
+			devad = 0;
+			data->reg_num &= 0x1f;
+		} else
+			return -EINVAL;
+
+		if (cmd == SIOCGMIIREG)
+			ret = t4_mdio_rd(pi->adapter, 0, prtad, devad,
+					 data->reg_num, &data->val_out);
+		else
+			ret = t4_mdio_wr(pi->adapter, 0, prtad, devad,
+					 data->reg_num, data->val_in);
+		break;
+	default:
+		return -EOPNOTSUPP;
+	}
+	return ret;
+}
+
+static void cxgb_set_rxmode(struct net_device *dev)
+{
+	/* unfortunately we can't return errors to the stack */
+	set_rxmode(dev, -1, false);
+}
+
+static int cxgb_change_mtu(struct net_device *dev, int new_mtu)
+{
+	int ret;
+	struct port_info *pi = netdev_priv(dev);
+
+	if (new_mtu < 81 || new_mtu > MAX_MTU)         /* accommodate SACK */
+		return -EINVAL;
+	ret = t4_set_rxmode(pi->adapter, 0, pi->viid, new_mtu, -1, -1, -1,
+			    true);
+	if (!ret)
+		dev->mtu = new_mtu;
+	return ret;
+}
+
+static int cxgb_set_mac_addr(struct net_device *dev, void *p)
+{
+	int ret;
+	struct sockaddr *addr = p;
+	struct port_info *pi = netdev_priv(dev);
+
+	if (!is_valid_ether_addr(addr->sa_data))
+		return -EINVAL;
+
+	ret = t4_change_mac(pi->adapter, 0, pi->viid, pi->xact_addr_filt,
+			    addr->sa_data, true, true);
+	if (ret < 0)
+		return ret;
+
+	memcpy(dev->dev_addr, addr->sa_data, dev->addr_len);
+	pi->xact_addr_filt = ret;
+	return 0;
+}
+
+static void vlan_rx_register(struct net_device *dev, struct vlan_group *grp)
+{
+	struct port_info *pi = netdev_priv(dev);
+
+	pi->vlan_grp = grp;
+	t4_set_vlan_accel(pi->adapter, 1 << pi->tx_chan, grp != NULL);
+}
+
+#ifdef CONFIG_NET_POLL_CONTROLLER
+static void cxgb_netpoll(struct net_device *dev)
+{
+	struct port_info *pi = netdev_priv(dev);
+	struct adapter *adap = pi->adapter;
+
+	if (adap->flags & USING_MSIX) {
+		int i;
+		struct sge_eth_rxq *rx = &adap->sge.ethrxq[pi->first_qset];
+
+		for (i = pi->nqsets; i; i--, rx++)
+			t4_sge_intr_msix(0, &rx->rspq);
+	} else
+		t4_intr_handler(adap)(0, adap);
+}
+#endif
+
+static const struct net_device_ops cxgb4_netdev_ops = {
+	.ndo_open             = cxgb_open,
+	.ndo_stop             = cxgb_close,
+	.ndo_start_xmit       = t4_eth_xmit,
+	.ndo_get_stats        = cxgb_get_stats,
+	.ndo_set_rx_mode      = cxgb_set_rxmode,
+	.ndo_set_mac_address  = cxgb_set_mac_addr,
+	.ndo_validate_addr    = eth_validate_addr,
+	.ndo_do_ioctl         = cxgb_ioctl,
+	.ndo_change_mtu       = cxgb_change_mtu,
+	.ndo_vlan_rx_register = vlan_rx_register,
+#ifdef CONFIG_NET_POLL_CONTROLLER
+	.ndo_poll_controller  = cxgb_netpoll,
+#endif
+};
+
+void t4_fatal_err(struct adapter *adap)
+{
+	t4_set_reg_field(adap, SGE_CONTROL, GLOBALENABLE, 0);
+	t4_intr_disable(adap);
+	dev_alert(adap->pdev_dev, "encountered fatal error, adapter stopped\n");
+}
+
+static void setup_memwin(struct adapter *adap)
+{
+	u32 bar0;
+
+	bar0 = pci_resource_start(adap->pdev, 0);  /* truncation intentional */
+	t4_write_reg(adap, PCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN, 0),
+		     (bar0 + MEMWIN0_BASE) | BIR(0) |
+		     WINDOW(ilog2(MEMWIN0_APERTURE) - 10));
+	t4_write_reg(adap, PCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN, 1),
+		     (bar0 + MEMWIN1_BASE) | BIR(0) |
+		     WINDOW(ilog2(MEMWIN1_APERTURE) - 10));
+	t4_write_reg(adap, PCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN, 2),
+		     (bar0 + MEMWIN2_BASE) | BIR(0) |
+		     WINDOW(ilog2(MEMWIN2_APERTURE) - 10));
+}
+
+/*
+ * Max # of ATIDs.  The absolute HW max is 16K but we keep it lower.
+ */
+#define MAX_ATIDS 8192U
+
+/*
+ * Phase 0 of initialization: contact FW, obtain config, perform basic init.
+ */
+static int adap_init0(struct adapter *adap)
+{
+	int ret;
+	u32 v, port_vec;
+	enum dev_state state;
+	u32 params[7], val[7];
+	struct fw_caps_config_cmd c;
+
+	ret = t4_check_fw_version(adap);
+	if (ret == -EINVAL || ret > 0) {
+		if (upgrade_fw(adap) >= 0)             /* recache FW version */
+			ret = t4_check_fw_version(adap);
+	}
+	if (ret < 0)
+		return ret;
+
+	/* contact FW, request master */
+	ret = t4_fw_hello(adap, 0, 0, MASTER_MUST, &state);
+	if (ret < 0) {
+		dev_err(adap->pdev_dev, "could not connect to FW, error %d\n",
+			ret);
+		return ret;
+	}
+
+	/* reset device */
+	ret = t4_fw_reset(adap, 0, PIORSTMODE | PIORST);
+	if (ret < 0)
+		goto bye;
+
+	/* get device capabilities */
+	memset(&c, 0, sizeof(c));
+	c.op_to_write = htonl(FW_CMD_OP(FW_CAPS_CONFIG_CMD) |
+			      FW_CMD_REQUEST | FW_CMD_READ);
+	c.retval_len16 = htonl(FW_LEN16(c));
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), &c);
+	if (ret < 0)
+		goto bye;
+
+	/* select capabilities we'll be using */
+	if (c.niccaps & htons(FW_CAPS_CONFIG_NIC_VM)) {
+		if (!vf_acls)
+			c.niccaps ^= htons(FW_CAPS_CONFIG_NIC_VM);
+		else
+			c.niccaps = htons(FW_CAPS_CONFIG_NIC_VM);
+	} else if (vf_acls) {
+		dev_err(adap->pdev_dev, "virtualization ACLs not supported");
+		goto bye;
+	}
+	c.op_to_write = htonl(FW_CMD_OP(FW_CAPS_CONFIG_CMD) |
+			      FW_CMD_REQUEST | FW_CMD_WRITE);
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), NULL);
+	if (ret < 0)
+		goto bye;
+
+	ret = t4_config_glbl_rss(adap, 0,
+				 FW_RSS_GLB_CONFIG_CMD_MODE_BASICVIRTUAL,
+				 FW_RSS_GLB_CONFIG_CMD_TNLMAPEN |
+				 FW_RSS_GLB_CONFIG_CMD_TNLALLLKP);
+	if (ret < 0)
+		goto bye;
+
+	ret = t4_cfg_pfvf(adap, 0, 0, 0, 64, 64, 64, 0, 0, 4, 0xf, 0xf, 16,
+			  FW_CMD_CAP_PF, FW_CMD_CAP_PF);
+	if (ret < 0)
+		goto bye;
+
+	for (v = 0; v < SGE_NTIMERS - 1; v++)
+		adap->sge.timer_val[v] = min(intr_holdoff[v], MAX_SGE_TIMERVAL);
+	adap->sge.timer_val[SGE_NTIMERS - 1] = MAX_SGE_TIMERVAL;
+	adap->sge.counter_val[0] = 1;
+	for (v = 1; v < SGE_NCOUNTERS; v++)
+		adap->sge.counter_val[v] = min(intr_cnt[v - 1],
+					       THRESHOLD_3_MASK);
+	t4_sge_init(adap);
+
+	/* get basic stuff going */
+	ret = t4_early_init(adap, 0);
+	if (ret < 0)
+		goto bye;
+
+#define FW_PARAM_DEV(param) \
+	(FW_PARAMS_MNEM(FW_PARAMS_MNEM_DEV) | \
+	 FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_DEV_##param))
+
+#define FW_PARAM_PFVF(param) \
+	(FW_PARAMS_MNEM(FW_PARAMS_MNEM_PFVF) | \
+	 FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_PFVF_##param))
+
+	params[0] = FW_PARAM_DEV(PORTVEC);
+	params[1] = FW_PARAM_PFVF(L2T_START);
+	params[2] = FW_PARAM_PFVF(L2T_END);
+	params[3] = FW_PARAM_PFVF(FILTER_START);
+	params[4] = FW_PARAM_PFVF(FILTER_END);
+	ret = t4_query_params(adap, 0, 0, 0, 5, params, val);
+	if (ret < 0)
+		goto bye;
+	port_vec = val[0];
+	adap->tids.ftid_base = val[3];
+	adap->tids.nftids = val[4] - val[3] + 1;
+
+	if (c.ofldcaps) {
+		/* query offload-related parameters */
+		params[0] = FW_PARAM_DEV(NTID);
+		params[1] = FW_PARAM_PFVF(SERVER_START);
+		params[2] = FW_PARAM_PFVF(SERVER_END);
+		params[3] = FW_PARAM_PFVF(TDDP_START);
+		params[4] = FW_PARAM_PFVF(TDDP_END);
+		params[5] = FW_PARAM_DEV(FLOWC_BUFFIFO_SZ);
+		ret = t4_query_params(adap, 0, 0, 0, 6, params, val);
+		if (ret < 0)
+			goto bye;
+		adap->tids.ntids = val[0];
+		adap->tids.natids = min(adap->tids.ntids / 2, MAX_ATIDS);
+		adap->tids.stid_base = val[1];
+		adap->tids.nstids = val[2] - val[1] + 1;
+		adap->vres.ddp.start = val[3];
+		adap->vres.ddp.size = val[4] - val[3] + 1;
+		adap->params.ofldq_wr_cred = val[5];
+		adap->params.offload = 1;
+	}
+	if (c.rdmacaps) {
+		params[0] = FW_PARAM_PFVF(STAG_START);
+		params[1] = FW_PARAM_PFVF(STAG_END);
+		params[2] = FW_PARAM_PFVF(RQ_START);
+		params[3] = FW_PARAM_PFVF(RQ_END);
+		params[4] = FW_PARAM_PFVF(PBL_START);
+		params[5] = FW_PARAM_PFVF(PBL_END);
+		ret = t4_query_params(adap, 0, 0, 0, 6, params, val);
+		if (ret < 0)
+			goto bye;
+		adap->vres.stag.start = val[0];
+		adap->vres.stag.size = val[1] - val[0] + 1;
+		adap->vres.rq.start = val[2];
+		adap->vres.rq.size = val[3] - val[2] + 1;
+		adap->vres.pbl.start = val[4];
+		adap->vres.pbl.size = val[5] - val[4] + 1;
+	}
+	if (c.iscsicaps) {
+		params[0] = FW_PARAM_PFVF(ISCSI_START);
+		params[1] = FW_PARAM_PFVF(ISCSI_END);
+		ret = t4_query_params(adap, 0, 0, 0, 2, params, val);
+		if (ret < 0)
+			goto bye;
+		adap->vres.iscsi.start = val[0];
+		adap->vres.iscsi.size = val[1] - val[0] + 1;
+	}
+#undef FW_PARAM_PFVF
+#undef FW_PARAM_DEV
+
+	adap->params.nports = hweight32(port_vec);
+	adap->params.portvec = port_vec;
+	adap->flags |= FW_OK;
+
+	/* These are finalized by FW initialization, load their values now */
+	v = t4_read_reg(adap, TP_TIMER_RESOLUTION);
+	adap->params.tp.tre = TIMERRESOLUTION_GET(v);
+	t4_read_mtu_tbl(adap, adap->params.mtus, NULL);
+	t4_load_mtus(adap, adap->params.mtus, adap->params.a_wnd,
+		     adap->params.b_wnd);
+
+	/* tweak some settings */
+	t4_write_reg(adap, TP_SHIFT_CNT, 0x64f8849);
+	t4_write_reg(adap, ULP_RX_TDDP_PSZ, HPZ0(PAGE_SHIFT - 12));
+	t4_write_reg(adap, TP_PIO_ADDR, TP_INGRESS_CONFIG);
+	v = t4_read_reg(adap, TP_PIO_DATA);
+	t4_write_reg(adap, TP_PIO_DATA, v & ~CSUM_HAS_PSEUDO_HDR);
+	setup_memwin(adap);
+	return 0;
+
+	/*
+	 * If a command timed out or failed with EIO FW does not operate within
+	 * its spec or something catastrophic happened to HW/FW, stop issuing
+	 * commands.
+	 */
+bye:	if (ret != -ETIMEDOUT && ret != -EIO)
+		t4_fw_bye(adap, 0);
+	return ret;
+}
+
+static inline bool is_10g_port(const struct link_config *lc)
+{
+	return (lc->supported & FW_PORT_CAP_SPEED_10G) != 0;
+}
+
+static inline void init_rspq(struct sge_rspq *q, u8 timer_idx, u8 pkt_cnt_idx,
+			     unsigned int size, unsigned int iqe_size)
+{
+	q->intr_params = QINTR_TIMER_IDX(timer_idx) |
+			 (pkt_cnt_idx < SGE_NCOUNTERS ? QINTR_CNT_EN : 0);
+	q->pktcnt_idx = pkt_cnt_idx < SGE_NCOUNTERS ? pkt_cnt_idx : 0;
+	q->iqe_len = iqe_size;
+	q->size = size;
+}
+
+/*
+ * Perform default configuration of DMA queues depending on the number and type
+ * of ports we found and the number of available CPUs.  Most settings can be
+ * modified by the admin prior to actual use.
+ */
+static void __devinit cfg_queues(struct adapter *adap)
+{
+	struct sge *s = &adap->sge;
+	int i, q10g = 0, n10g = 0, qidx = 0;
+
+	for_each_port(adap, i)
+		n10g += is_10g_port(&adap2pinfo(adap, i)->link_cfg);
+
+	/*
+	 * We default to 1 queue per non-10G port and up to # of cores queues
+	 * per 10G port.
+	 */
+	if (n10g)
+		q10g = (MAX_ETH_QSETS - (adap->params.nports - n10g)) / n10g;
+	if (q10g > num_online_cpus())
+		q10g = num_online_cpus();
+
+	for_each_port(adap, i) {
+		struct port_info *pi = adap2pinfo(adap, i);
+
+		pi->first_qset = qidx;
+		pi->nqsets = is_10g_port(&pi->link_cfg) ? q10g : 1;
+		qidx += pi->nqsets;
+	}
+
+	s->ethqsets = qidx;
+	s->max_ethqsets = qidx;   /* MSI-X may lower it later */
+
+	if (is_offload(adap)) {
+		/*
+		 * For offload we use 1 queue/channel if all ports are up to 1G,
+		 * otherwise we divide all available queues amongst the channels
+		 * capped by the number of available cores.
+		 */
+		if (n10g) {
+			i = min_t(int, ARRAY_SIZE(s->ofldrxq),
+				  num_online_cpus());
+			s->ofldqsets = roundup(i, adap->params.nports);
+		} else
+			s->ofldqsets = adap->params.nports;
+		/* For RDMA one Rx queue per channel suffices */
+		s->rdmaqs = adap->params.nports;
+	}
+
+	for (i = 0; i < ARRAY_SIZE(s->ethrxq); i++) {
+		struct sge_eth_rxq *r = &s->ethrxq[i];
+
+		init_rspq(&r->rspq, 0, 0, 1024, 64);
+		r->fl.size = 72;
+	}
+
+	for (i = 0; i < ARRAY_SIZE(s->ethtxq); i++)
+		s->ethtxq[i].q.size = 1024;
+
+	for (i = 0; i < ARRAY_SIZE(s->ctrlq); i++)
+		s->ctrlq[i].q.size = 512;
+
+	for (i = 0; i < ARRAY_SIZE(s->ofldtxq); i++)
+		s->ofldtxq[i].q.size = 1024;
+
+	for (i = 0; i < ARRAY_SIZE(s->ofldrxq); i++) {
+		struct sge_ofld_rxq *r = &s->ofldrxq[i];
+
+		init_rspq(&r->rspq, 0, 0, 1024, 64);
+		r->rspq.uld = CXGB4_ULD_ISCSI;
+		r->fl.size = 72;
+	}
+
+	for (i = 0; i < ARRAY_SIZE(s->rdmarxq); i++) {
+		struct sge_ofld_rxq *r = &s->rdmarxq[i];
+
+		init_rspq(&r->rspq, 0, 0, 511, 64);
+		r->rspq.uld = CXGB4_ULD_RDMA;
+		r->fl.size = 72;
+	}
+
+	init_rspq(&s->fw_evtq, 6, 0, 512, 64);
+	init_rspq(&s->intrq, 6, 0, 2 * MAX_INGQ, 64);
+}
+
+/*
+ * Reduce the number of Ethernet queues across all ports to at most n.
+ * n provides at least one queue per port.
+ */
+static void __devinit reduce_ethqs(struct adapter *adap, int n)
+{
+	int i;
+	struct port_info *pi;
+
+	while (n < adap->sge.ethqsets)
+		for_each_port(adap, i) {
+			pi = adap2pinfo(adap, i);
+			if (pi->nqsets > 1) {
+				pi->nqsets--;
+				adap->sge.ethqsets--;
+				if (adap->sge.ethqsets <= n)
+					break;
+			}
+		}
+
+	n = 0;
+	for_each_port(adap, i) {
+		pi = adap2pinfo(adap, i);
+		pi->first_qset = n;
+		n += pi->nqsets;
+	}
+}
+
+/* 2 MSI-X vectors needed for the FW queue and non-data interrupts */
+#define EXTRA_VECS 2
+
+static int __devinit enable_msix(struct adapter *adap)
+{
+	int ofld_need = 0;
+	int i, err, want, need;
+	struct sge *s = &adap->sge;
+	unsigned int nchan = adap->params.nports;
+	struct msix_entry entries[MAX_INGQ + 1];
+
+	for (i = 0; i < ARRAY_SIZE(entries); ++i)
+		entries[i].entry = i;
+
+	want = s->max_ethqsets + EXTRA_VECS;
+	if (is_offload(adap)) {
+		want += s->rdmaqs + s->ofldqsets;
+		/* need nchan for each possible ULD */
+		ofld_need = 2 * nchan;
+	}
+	need = adap->params.nports + EXTRA_VECS + ofld_need;
+
+	while ((err = pci_enable_msix(adap->pdev, entries, want)) >= need)
+		want = err;
+
+	if (!err) {
+		/*
+		 * Distribute available vectors to the various queue groups.
+		 * Every group gets its minimum requirement and NIC gets top
+		 * priority for leftovers.
+		 */
+		i = want - EXTRA_VECS - ofld_need;
+		if (i < s->max_ethqsets) {
+			s->max_ethqsets = i;
+			if (i < s->ethqsets)
+				reduce_ethqs(adap, i);
+		}
+		if (is_offload(adap)) {
+			i = want - EXTRA_VECS - s->max_ethqsets;
+			i -= ofld_need - nchan;
+			s->ofldqsets = (i / nchan) * nchan;  /* round down */
+		}
+		for (i = 0; i < want; ++i)
+			adap->msix_info[i].vec = entries[i].vector;
+	} else if (err > 0)
+		dev_info(adap->pdev_dev,
+			 "only %d MSI-X vectors left, not using MSI-X\n", err);
+	return err;
+}
+
+#undef EXTRA_VECS
+
+static void __devinit print_port_info(struct adapter *adap)
+{
+	static const char *base[] = {
+		"R", "KX4", "T", "KX", "T", "KR", "CX4"
+	};
+
+	int i;
+	char buf[80];
+
+	for_each_port(adap, i) {
+		struct net_device *dev = adap->port[i];
+		const struct port_info *pi = netdev_priv(dev);
+		char *bufp = buf;
+
+		if (!test_bit(i, &adap->registered_device_map))
+			continue;
+
+		if (pi->link_cfg.supported & FW_PORT_CAP_SPEED_100M)
+			bufp += sprintf(bufp, "100/");
+		if (pi->link_cfg.supported & FW_PORT_CAP_SPEED_1G)
+			bufp += sprintf(bufp, "1000/");
+		if (pi->link_cfg.supported & FW_PORT_CAP_SPEED_10G)
+			bufp += sprintf(bufp, "10G/");
+		if (bufp != buf)
+			--bufp;
+		sprintf(bufp, "BASE-%s", base[pi->port_type]);
+
+		netdev_info(dev, "Chelsio %s rev %d %s %sNIC PCIe x%d%s\n",
+			    adap->params.vpd.id, adap->params.rev,
+			    buf, is_offload(adap) ? "R" : "",
+			    adap->params.pci.width,
+			    (adap->flags & USING_MSIX) ? " MSI-X" :
+			    (adap->flags & USING_MSI) ? " MSI" : "");
+		if (adap->name == dev->name)
+			netdev_info(dev, "S/N: %s, E/C: %s\n",
+				    adap->params.vpd.sn, adap->params.vpd.ec);
+	}
+}
+
+#define VLAN_FEAT (NETIF_F_SG | NETIF_F_IP_CSUM | NETIF_F_TSO | NETIF_F_TSO6 |\
+		   NETIF_F_IPV6_CSUM | NETIF_F_HIGHDMA)
+
+static int __devinit init_one(struct pci_dev *pdev,
+			      const struct pci_device_id *ent)
+{
+	int func, i, err;
+	struct port_info *pi;
+	unsigned int highdma = 0;
+	struct adapter *adapter = NULL;
+
+	printk_once(KERN_INFO "%s - version %s\n", DRV_DESC, DRV_VERSION);
+
+	err = pci_request_regions(pdev, KBUILD_MODNAME);
+	if (err) {
+		/* Just info, some other driver may have claimed the device. */
+		dev_info(&pdev->dev, "cannot obtain PCI resources\n");
+		return err;
+	}
+
+	/* We control everything through PF 0 */
+	func = PCI_FUNC(pdev->devfn);
+	if (func > 0)
+		goto sriov;
+
+	err = pci_enable_device(pdev);
+	if (err) {
+		dev_err(&pdev->dev, "cannot enable PCI device\n");
+		goto out_release_regions;
+	}
+
+	if (!pci_set_dma_mask(pdev, DMA_BIT_MASK(64))) {
+		highdma = NETIF_F_HIGHDMA;
+		err = pci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(64));
+		if (err) {
+			dev_err(&pdev->dev, "unable to obtain 64-bit DMA for "
+				"coherent allocations\n");
+			goto out_disable_device;
+		}
+	} else {
+		err = pci_set_dma_mask(pdev, DMA_BIT_MASK(32));
+		if (err) {
+			dev_err(&pdev->dev, "no usable DMA configuration\n");
+			goto out_disable_device;
+		}
+	}
+
+	pci_enable_pcie_error_reporting(pdev);
+	pci_set_master(pdev);
+	pci_save_state(pdev);
+
+	adapter = kzalloc(sizeof(*adapter), GFP_KERNEL);
+	if (!adapter) {
+		err = -ENOMEM;
+		goto out_disable_device;
+	}
+
+	adapter->regs = pci_ioremap_bar(pdev, 0);
+	if (!adapter->regs) {
+		dev_err(&pdev->dev, "cannot map device registers\n");
+		err = -ENOMEM;
+		goto out_free_adapter;
+	}
+
+	adapter->pdev = pdev;
+	adapter->pdev_dev = &pdev->dev;
+	adapter->name = pci_name(pdev);
+	adapter->msg_enable = dflt_msg_enable;
+	memset(adapter->chan_map, 0xff, sizeof(adapter->chan_map));
+
+	spin_lock_init(&adapter->stats_lock);
+	spin_lock_init(&adapter->tid_release_lock);
+
+	INIT_WORK(&adapter->tid_release_task, process_tid_release_list);
+
+	err = t4_prep_adapter(adapter);
+	if (err)
+		goto out_unmap_bar;
+	err = adap_init0(adapter);
+	if (err)
+		goto out_unmap_bar;
+
+	for_each_port(adapter, i) {
+		struct net_device *netdev;
+
+		netdev = alloc_etherdev_mq(sizeof(struct port_info),
+					   MAX_ETH_QSETS);
+		if (!netdev) {
+			err = -ENOMEM;
+			goto out_free_dev;
+		}
+
+		SET_NETDEV_DEV(netdev, &pdev->dev);
+
+		adapter->port[i] = netdev;
+		pi = netdev_priv(netdev);
+		pi->adapter = adapter;
+		pi->xact_addr_filt = -1;
+		pi->rx_offload = RX_CSO;
+		pi->port_id = i;
+		netif_carrier_off(netdev);
+		netif_tx_stop_all_queues(netdev);
+		netdev->irq = pdev->irq;
+
+		netdev->features |= NETIF_F_SG | NETIF_F_TSO | NETIF_F_TSO6;
+		netdev->features |= NETIF_F_IP_CSUM | NETIF_F_IPV6_CSUM;
+		netdev->features |= NETIF_F_GRO | highdma;
+		netdev->features |= NETIF_F_HW_VLAN_TX | NETIF_F_HW_VLAN_RX;
+		netdev->vlan_features = netdev->features & VLAN_FEAT;
+
+		netdev->netdev_ops = &cxgb4_netdev_ops;
+		SET_ETHTOOL_OPS(netdev, &cxgb_ethtool_ops);
+	}
+
+	pci_set_drvdata(pdev, adapter);
+
+	if (adapter->flags & FW_OK) {
+		err = t4_port_init(adapter, 0, 0, 0);
+		if (err)
+			goto out_free_dev;
+	}
+
+	/*
+	 * Configure queues and allocate tables now, they can be needed as
+	 * soon as the first register_netdev completes.
+	 */
+	cfg_queues(adapter);
+
+	adapter->l2t = t4_init_l2t();
+	if (!adapter->l2t) {
+		/* We tolerate a lack of L2T, giving up some functionality */
+		dev_warn(&pdev->dev, "could not allocate L2T, continuing\n");
+		adapter->params.offload = 0;
+	}
+
+	if (is_offload(adapter) && tid_init(&adapter->tids) < 0) {
+		dev_warn(&pdev->dev, "could not allocate TID table, "
+			 "continuing\n");
+		adapter->params.offload = 0;
+	}
+
+	/*
+	 * The card is now ready to go.  If any errors occur during device
+	 * registration we do not fail the whole card but rather proceed only
+	 * with the ports we manage to register successfully.  However we must
+	 * register at least one net device.
+	 */
+	for_each_port(adapter, i) {
+		err = register_netdev(adapter->port[i]);
+		if (err)
+			dev_warn(&pdev->dev,
+				 "cannot register net device %s, skipping\n",
+				 adapter->port[i]->name);
+		else {
+			/*
+			 * Change the name we use for messages to the name of
+			 * the first successfully registered interface.
+			 */
+			if (!adapter->registered_device_map)
+				adapter->name = adapter->port[i]->name;
+
+			__set_bit(i, &adapter->registered_device_map);
+			adapter->chan_map[adap2pinfo(adapter, i)->tx_chan] = i;
+		}
+	}
+	if (!adapter->registered_device_map) {
+		dev_err(&pdev->dev, "could not register any net devices\n");
+		goto out_free_dev;
+	}
+
+	if (cxgb4_debugfs_root) {
+		adapter->debugfs_root = debugfs_create_dir(pci_name(pdev),
+							   cxgb4_debugfs_root);
+		setup_debugfs(adapter);
+	}
+
+	/* See what interrupts we'll be using */
+	if (msi > 1 && enable_msix(adapter) == 0)
+		adapter->flags |= USING_MSIX;
+	else if (msi > 0 && pci_enable_msi(pdev) == 0)
+		adapter->flags |= USING_MSI;
+
+	if (is_offload(adapter))
+		attach_ulds(adapter);
+
+	print_port_info(adapter);
+
+sriov:
+#ifdef CONFIG_PCI_IOV
+	if (func < ARRAY_SIZE(num_vf) && num_vf[func] > 0)
+		if (pci_enable_sriov(pdev, num_vf[func]) == 0)
+			dev_info(&pdev->dev,
+				 "instantiated %u virtual functions\n",
+				 num_vf[func]);
+#endif
+	return 0;
+
+ out_free_dev:
+	t4_free_mem(adapter->tids.tid_tab);
+	t4_free_mem(adapter->l2t);
+	for_each_port(adapter, i)
+		if (adapter->port[i])
+			free_netdev(adapter->port[i]);
+	if (adapter->flags & FW_OK)
+		t4_fw_bye(adapter, 0);
+ out_unmap_bar:
+	iounmap(adapter->regs);
+ out_free_adapter:
+	kfree(adapter);
+ out_disable_device:
+	pci_disable_pcie_error_reporting(pdev);
+	pci_disable_device(pdev);
+ out_release_regions:
+	pci_release_regions(pdev);
+	pci_set_drvdata(pdev, NULL);
+	return err;
+}
+
+static void __devexit remove_one(struct pci_dev *pdev)
+{
+	struct adapter *adapter = pci_get_drvdata(pdev);
+
+	pci_disable_sriov(pdev);
+
+	if (adapter) {
+		int i;
+
+		if (is_offload(adapter))
+			detach_ulds(adapter);
+
+		for_each_port(adapter, i)
+			if (test_bit(i, &adapter->registered_device_map))
+				unregister_netdev(adapter->port[i]);
+
+		if (adapter->debugfs_root)
+			debugfs_remove_recursive(adapter->debugfs_root);
+
+		t4_sge_stop(adapter);
+		t4_free_sge_resources(adapter);
+		t4_free_mem(adapter->l2t);
+		t4_free_mem(adapter->tids.tid_tab);
+		disable_msi(adapter);
+
+		for_each_port(adapter, i)
+			if (adapter->port[i])
+				free_netdev(adapter->port[i]);
+
+		if (adapter->flags & FW_OK)
+			t4_fw_bye(adapter, 0);
+		iounmap(adapter->regs);
+		kfree(adapter);
+		pci_disable_pcie_error_reporting(pdev);
+		pci_disable_device(pdev);
+		pci_release_regions(pdev);
+		pci_set_drvdata(pdev, NULL);
+	} else if (PCI_FUNC(pdev->devfn) > 0)
+		pci_release_regions(pdev);
+}
+
+static struct pci_driver cxgb4_driver = {
+	.name     = KBUILD_MODNAME,
+	.id_table = cxgb4_pci_tbl,
+	.probe    = init_one,
+	.remove   = __devexit_p(remove_one),
+};
+
+static int __init cxgb4_init_module(void)
+{
+	int ret;
+
+	/* Debugfs support is optional, just warn if this fails */
+	cxgb4_debugfs_root = debugfs_create_dir(KBUILD_MODNAME, NULL);
+	if (!cxgb4_debugfs_root)
+		pr_warning("could not create debugfs entry, continuing\n");
+
+	ret = pci_register_driver(&cxgb4_driver);
+	if (ret < 0)
+		debugfs_remove(cxgb4_debugfs_root);
+	return ret;
+}
+
+static void __exit cxgb4_cleanup_module(void)
+{
+	pci_unregister_driver(&cxgb4_driver);
+	debugfs_remove(cxgb4_debugfs_root);  /* NULL ok */
+}
+
+module_init(cxgb4_init_module);
+module_exit(cxgb4_cleanup_module);
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4_uld.h linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4_uld.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/cxgb4_uld.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/cxgb4_uld.h	2010-04-13 02:19:01.108633083 +0000
@@ -0,0 +1,239 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __CXGB4_OFLD_H
+#define __CXGB4_OFLD_H
+
+#include <linux/cache.h>
+#include <linux/spinlock.h>
+#include <linux/skbuff.h>
+#include <asm/atomic.h>
+
+/* CPL message priority levels */
+enum {
+	CPL_PRIORITY_DATA     = 0,  /* data messages */
+	CPL_PRIORITY_SETUP    = 1,  /* connection setup messages */
+	CPL_PRIORITY_TEARDOWN = 0,  /* connection teardown messages */
+	CPL_PRIORITY_LISTEN   = 1,  /* listen start/stop messages */
+	CPL_PRIORITY_ACK      = 1,  /* RX ACK messages */
+	CPL_PRIORITY_CONTROL  = 1   /* control messages */
+};
+
+#define INIT_TP_WR(w, tid) do { \
+	(w)->wr.wr_hi = htonl(FW_WR_OP(FW_TP_WR) | \
+			      FW_WR_IMMDLEN(sizeof(*w) - sizeof(w->wr))); \
+	(w)->wr.wr_mid = htonl(FW_WR_LEN16(DIV_ROUND_UP(sizeof(*w), 16)) | \
+			       FW_WR_FLOWID(tid)); \
+	(w)->wr.wr_lo = cpu_to_be64(0); \
+} while (0)
+
+#define INIT_TP_WR_CPL(w, cpl, tid) do { \
+	INIT_TP_WR(w, tid); \
+	OPCODE_TID(w) = htonl(MK_OPCODE_TID(cpl, tid)); \
+} while (0)
+
+#define INIT_ULPTX_WR(w, wrlen, atomic, tid) do { \
+	(w)->wr.wr_hi = htonl(FW_WR_OP(FW_ULPTX_WR) | FW_WR_ATOMIC(atomic)); \
+	(w)->wr.wr_mid = htonl(FW_WR_LEN16(DIV_ROUND_UP(wrlen, 16)) | \
+			       FW_WR_FLOWID(tid)); \
+	(w)->wr.wr_lo = cpu_to_be64(0); \
+} while (0)
+
+/* Special asynchronous notification message */
+#define CXGB4_MSG_AN ((void *)1)
+
+struct serv_entry {
+	void *data;
+};
+
+union aopen_entry {
+	void *data;
+	union aopen_entry *next;
+};
+
+/*
+ * Holds the size, base address, free list start, etc of the TID, server TID,
+ * and active-open TID tables.  The tables themselves are allocated dynamically.
+ */
+struct tid_info {
+	void **tid_tab;
+	unsigned int ntids;
+
+	struct serv_entry *stid_tab;
+	unsigned long *stid_bmap;
+	unsigned int nstids;
+	unsigned int stid_base;
+
+	union aopen_entry *atid_tab;
+	unsigned int natids;
+
+	unsigned int nftids;
+	unsigned int ftid_base;
+
+	spinlock_t atid_lock ____cacheline_aligned_in_smp;
+	union aopen_entry *afree;
+	unsigned int atids_in_use;
+
+	spinlock_t stid_lock;
+	unsigned int stids_in_use;
+
+	atomic_t tids_in_use;
+};
+
+static inline void *lookup_tid(const struct tid_info *t, unsigned int tid)
+{
+	return tid < t->ntids ? t->tid_tab[tid] : NULL;
+}
+
+static inline void *lookup_atid(const struct tid_info *t, unsigned int atid)
+{
+	return atid < t->natids ? t->atid_tab[atid].data : NULL;
+}
+
+static inline void *lookup_stid(const struct tid_info *t, unsigned int stid)
+{
+	stid -= t->stid_base;
+	return stid < t->nstids ? t->stid_tab[stid].data : NULL;
+}
+
+static inline void cxgb4_insert_tid(struct tid_info *t, void *data,
+				    unsigned int tid)
+{
+	t->tid_tab[tid] = data;
+	atomic_inc(&t->tids_in_use);
+}
+
+int cxgb4_alloc_atid(struct tid_info *t, void *data);
+int cxgb4_alloc_stid(struct tid_info *t, int family, void *data);
+void cxgb4_free_atid(struct tid_info *t, unsigned int atid);
+void cxgb4_free_stid(struct tid_info *t, unsigned int stid, int family);
+void cxgb4_remove_tid(struct tid_info *t, unsigned int qid, unsigned int tid);
+void cxgb4_queue_tid_release(struct tid_info *t, unsigned int chan,
+			     unsigned int tid);
+
+struct in6_addr;
+
+int cxgb4_create_server(const struct net_device *dev, unsigned int stid,
+			__be32 sip, __be16 sport, unsigned int queue);
+int cxgb4_create_server6(const struct net_device *dev, unsigned int stid,
+			 const struct in6_addr *sip, __be16 sport,
+			 unsigned int queue);
+
+static inline void set_wr_txq(struct sk_buff *skb, int prio, int queue)
+{
+	skb_set_queue_mapping(skb, (queue << 1) | prio);
+}
+
+enum cxgb4_uld {
+	CXGB4_ULD_RDMA,
+	CXGB4_ULD_ISCSI,
+	CXGB4_ULD_MAX
+};
+
+enum cxgb4_state {
+	CXGB4_STATE_UP,
+	CXGB4_STATE_START_RECOVERY,
+	CXGB4_STATE_DOWN,
+	CXGB4_STATE_DETACH
+};
+
+struct pci_dev;
+struct l2t_data;
+struct net_device;
+struct pkt_gl;
+struct tp_tcp_stats;
+
+struct cxgb4_range {
+	unsigned int start;
+	unsigned int size;
+};
+
+struct cxgb4_virt_res {                      /* virtualized HW resources */
+	struct cxgb4_range ddp;
+	struct cxgb4_range iscsi;
+	struct cxgb4_range stag;
+	struct cxgb4_range rq;
+	struct cxgb4_range pbl;
+};
+
+/*
+ * Block of information the LLD provides to ULDs attaching to a device.
+ */
+struct cxgb4_lld_info {
+	struct pci_dev *pdev;                /* associated PCI device */
+	struct l2t_data *l2t;                /* L2 table */
+	struct tid_info *tids;               /* TID table */
+	struct net_device **ports;           /* device ports */
+	const struct cxgb4_virt_res *vr;     /* assorted HW resources */
+	const unsigned short *mtus;          /* MTU table */
+	const unsigned short *rxq_ids;       /* the ULD's Rx queue ids */
+	unsigned short nrxq;                 /* # of Rx queues */
+	unsigned short ntxq;                 /* # of Tx queues */
+	unsigned char nchan:4;               /* # of channels */
+	unsigned char nports:4;              /* # of ports */
+	unsigned char wr_cred;               /* WR 16-byte credits */
+	unsigned char adapter_type;          /* type of adapter */
+	unsigned char fw_api_ver;            /* FW API version */
+	unsigned int fw_vers;                /* FW version */
+	unsigned int iscsi_iolen;            /* iSCSI max I/O length */
+	unsigned short udb_density;          /* # of user DB/page */
+	unsigned short ucq_density;          /* # of user CQs/page */
+	void __iomem *gts_reg;               /* address of GTS register */
+	void __iomem *db_reg;                /* address of kernel doorbell */
+};
+
+struct cxgb4_uld_info {
+	const char *name;
+	void *(*add)(const struct cxgb4_lld_info *p);
+	int (*rx_handler)(void *handle, const __be64 *rsp,
+			  const struct pkt_gl *gl);
+	int (*state_change)(void *handle, enum cxgb4_state new_state);
+};
+
+int cxgb4_register_uld(enum cxgb4_uld type, const struct cxgb4_uld_info *p);
+int cxgb4_unregister_uld(enum cxgb4_uld type);
+int cxgb4_ofld_send(struct net_device *dev, struct sk_buff *skb);
+unsigned int cxgb4_port_chan(const struct net_device *dev);
+unsigned int cxgb4_port_viid(const struct net_device *dev);
+unsigned int cxgb4_port_idx(const struct net_device *dev);
+struct net_device *cxgb4_netdev_by_hwid(struct pci_dev *pdev, unsigned int id);
+unsigned int cxgb4_best_mtu(const unsigned short *mtus, unsigned short mtu,
+			    unsigned int *idx);
+void cxgb4_get_tcp_stats(struct pci_dev *pdev, struct tp_tcp_stats *v4,
+			 struct tp_tcp_stats *v6);
+void cxgb4_iscsi_init(struct net_device *dev, unsigned int tag_mask,
+		      const unsigned int *pgsz_order);
+struct sk_buff *cxgb4_pktgl_to_skb(const struct pkt_gl *gl,
+				   unsigned int skb_len, unsigned int pull_len);
+#endif  /* !__CXGB4_OFLD_H */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/l2t.c linux-2.6.34-rc4/drivers/net/cxgb4/l2t.c
--- linux-2.6.34-rc3/drivers/net/cxgb4/l2t.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/l2t.c	2010-04-13 02:19:01.108633083 +0000
@@ -0,0 +1,624 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#include <linux/skbuff.h>
+#include <linux/netdevice.h>
+#include <linux/if.h>
+#include <linux/if_vlan.h>
+#include <linux/jhash.h>
+#include <net/neighbour.h>
+#include "cxgb4.h"
+#include "l2t.h"
+#include "t4_msg.h"
+#include "t4fw_api.h"
+
+#define VLAN_NONE 0xfff
+
+/* identifies sync vs async L2T_WRITE_REQs */
+#define F_SYNC_WR    (1 << 12)
+
+enum {
+	L2T_STATE_VALID,      /* entry is up to date */
+	L2T_STATE_STALE,      /* entry may be used but needs revalidation */
+	L2T_STATE_RESOLVING,  /* entry needs address resolution */
+	L2T_STATE_SYNC_WRITE, /* synchronous write of entry underway */
+
+	/* when state is one of the below the entry is not hashed */
+	L2T_STATE_SWITCHING,  /* entry is being used by a switching filter */
+	L2T_STATE_UNUSED      /* entry not in use */
+};
+
+struct l2t_data {
+	rwlock_t lock;
+	atomic_t nfree;             /* number of free entries */
+	struct l2t_entry *rover;    /* starting point for next allocation */
+	struct l2t_entry l2tab[L2T_SIZE];
+};
+
+static inline unsigned int vlan_prio(const struct l2t_entry *e)
+{
+	return e->vlan >> 13;
+}
+
+static inline void l2t_hold(struct l2t_data *d, struct l2t_entry *e)
+{
+	if (atomic_add_return(1, &e->refcnt) == 1)  /* 0 -> 1 transition */
+		atomic_dec(&d->nfree);
+}
+
+/*
+ * To avoid having to check address families we do not allow v4 and v6
+ * neighbors to be on the same hash chain.  We keep v4 entries in the first
+ * half of available hash buckets and v6 in the second.
+ */
+enum {
+	L2T_SZ_HALF = L2T_SIZE / 2,
+	L2T_HASH_MASK = L2T_SZ_HALF - 1
+};
+
+static inline unsigned int arp_hash(const u32 *key, int ifindex)
+{
+	return jhash_2words(*key, ifindex, 0) & L2T_HASH_MASK;
+}
+
+static inline unsigned int ipv6_hash(const u32 *key, int ifindex)
+{
+	u32 xor = key[0] ^ key[1] ^ key[2] ^ key[3];
+
+	return L2T_SZ_HALF + (jhash_2words(xor, ifindex, 0) & L2T_HASH_MASK);
+}
+
+static unsigned int addr_hash(const u32 *addr, int addr_len, int ifindex)
+{
+	return addr_len == 4 ? arp_hash(addr, ifindex) :
+			       ipv6_hash(addr, ifindex);
+}
+
+/*
+ * Checks if an L2T entry is for the given IP/IPv6 address.  It does not check
+ * whether the L2T entry and the address are of the same address family.
+ * Callers ensure an address is only checked against L2T entries of the same
+ * family, something made trivial by the separation of IP and IPv6 hash chains
+ * mentioned above.  Returns 0 if there's a match,
+ */
+static int addreq(const struct l2t_entry *e, const u32 *addr)
+{
+	if (e->v6)
+		return (e->addr[0] ^ addr[0]) | (e->addr[1] ^ addr[1]) |
+		       (e->addr[2] ^ addr[2]) | (e->addr[3] ^ addr[3]);
+	return e->addr[0] ^ addr[0];
+}
+
+static void neigh_replace(struct l2t_entry *e, struct neighbour *n)
+{
+	neigh_hold(n);
+	if (e->neigh)
+		neigh_release(e->neigh);
+	e->neigh = n;
+}
+
+/*
+ * Write an L2T entry.  Must be called with the entry locked.
+ * The write may be synchronous or asynchronous.
+ */
+static int write_l2e(struct adapter *adap, struct l2t_entry *e, int sync)
+{
+	struct sk_buff *skb;
+	struct cpl_l2t_write_req *req;
+
+	skb = alloc_skb(sizeof(*req), GFP_ATOMIC);
+	if (!skb)
+		return -ENOMEM;
+
+	req = (struct cpl_l2t_write_req *)__skb_put(skb, sizeof(*req));
+	INIT_TP_WR(req, 0);
+
+	OPCODE_TID(req) = htonl(MK_OPCODE_TID(CPL_L2T_WRITE_REQ,
+					e->idx | (sync ? F_SYNC_WR : 0) |
+					TID_QID(adap->sge.fw_evtq.abs_id)));
+	req->params = htons(L2T_W_PORT(e->lport) | L2T_W_NOREPLY(!sync));
+	req->l2t_idx = htons(e->idx);
+	req->vlan = htons(e->vlan);
+	if (e->neigh)
+		memcpy(e->dmac, e->neigh->ha, sizeof(e->dmac));
+	memcpy(req->dst_mac, e->dmac, sizeof(req->dst_mac));
+
+	set_wr_txq(skb, CPL_PRIORITY_CONTROL, 0);
+	t4_ofld_send(adap, skb);
+
+	if (sync && e->state != L2T_STATE_SWITCHING)
+		e->state = L2T_STATE_SYNC_WRITE;
+	return 0;
+}
+
+/*
+ * Send packets waiting in an L2T entry's ARP queue.  Must be called with the
+ * entry locked.
+ */
+static void send_pending(struct adapter *adap, struct l2t_entry *e)
+{
+	while (e->arpq_head) {
+		struct sk_buff *skb = e->arpq_head;
+
+		e->arpq_head = skb->next;
+		skb->next = NULL;
+		t4_ofld_send(adap, skb);
+	}
+	e->arpq_tail = NULL;
+}
+
+/*
+ * Process a CPL_L2T_WRITE_RPL.  Wake up the ARP queue if it completes a
+ * synchronous L2T_WRITE.  Note that the TID in the reply is really the L2T
+ * index it refers to.
+ */
+void do_l2t_write_rpl(struct adapter *adap, const struct cpl_l2t_write_rpl *rpl)
+{
+	unsigned int tid = GET_TID(rpl);
+	unsigned int idx = tid & (L2T_SIZE - 1);
+
+	if (unlikely(rpl->status != CPL_ERR_NONE)) {
+		dev_err(adap->pdev_dev,
+			"Unexpected L2T_WRITE_RPL status %u for entry %u\n",
+			rpl->status, idx);
+		return;
+	}
+
+	if (tid & F_SYNC_WR) {
+		struct l2t_entry *e = &adap->l2t->l2tab[idx];
+
+		spin_lock(&e->lock);
+		if (e->state != L2T_STATE_SWITCHING) {
+			send_pending(adap, e);
+			e->state = (e->neigh->nud_state & NUD_STALE) ?
+					L2T_STATE_STALE : L2T_STATE_VALID;
+		}
+		spin_unlock(&e->lock);
+	}
+}
+
+/*
+ * Add a packet to an L2T entry's queue of packets awaiting resolution.
+ * Must be called with the entry's lock held.
+ */
+static inline void arpq_enqueue(struct l2t_entry *e, struct sk_buff *skb)
+{
+	skb->next = NULL;
+	if (e->arpq_head)
+		e->arpq_tail->next = skb;
+	else
+		e->arpq_head = skb;
+	e->arpq_tail = skb;
+}
+
+int cxgb4_l2t_send(struct net_device *dev, struct sk_buff *skb,
+		   struct l2t_entry *e)
+{
+	struct adapter *adap = netdev2adap(dev);
+
+again:
+	switch (e->state) {
+	case L2T_STATE_STALE:     /* entry is stale, kick off revalidation */
+		neigh_event_send(e->neigh, NULL);
+		spin_lock_bh(&e->lock);
+		if (e->state == L2T_STATE_STALE)
+			e->state = L2T_STATE_VALID;
+		spin_unlock_bh(&e->lock);
+	case L2T_STATE_VALID:     /* fast-path, send the packet on */
+		return t4_ofld_send(adap, skb);
+	case L2T_STATE_RESOLVING:
+	case L2T_STATE_SYNC_WRITE:
+		spin_lock_bh(&e->lock);
+		if (e->state != L2T_STATE_SYNC_WRITE &&
+		    e->state != L2T_STATE_RESOLVING) {
+			spin_unlock_bh(&e->lock);
+			goto again;
+		}
+		arpq_enqueue(e, skb);
+		spin_unlock_bh(&e->lock);
+
+		if (e->state == L2T_STATE_RESOLVING &&
+		    !neigh_event_send(e->neigh, NULL)) {
+			spin_lock_bh(&e->lock);
+			if (e->state == L2T_STATE_RESOLVING && e->arpq_head)
+				write_l2e(adap, e, 1);
+			spin_unlock_bh(&e->lock);
+		}
+	}
+	return 0;
+}
+EXPORT_SYMBOL(cxgb4_l2t_send);
+
+/*
+ * Allocate a free L2T entry.  Must be called with l2t_data.lock held.
+ */
+static struct l2t_entry *alloc_l2e(struct l2t_data *d)
+{
+	struct l2t_entry *end, *e, **p;
+
+	if (!atomic_read(&d->nfree))
+		return NULL;
+
+	/* there's definitely a free entry */
+	for (e = d->rover, end = &d->l2tab[L2T_SIZE]; e != end; ++e)
+		if (atomic_read(&e->refcnt) == 0)
+			goto found;
+
+	for (e = d->l2tab; atomic_read(&e->refcnt); ++e)
+		;
+found:
+	d->rover = e + 1;
+	atomic_dec(&d->nfree);
+
+	/*
+	 * The entry we found may be an inactive entry that is
+	 * presently in the hash table.  We need to remove it.
+	 */
+	if (e->state < L2T_STATE_SWITCHING)
+		for (p = &d->l2tab[e->hash].first; *p; p = &(*p)->next)
+			if (*p == e) {
+				*p = e->next;
+				e->next = NULL;
+				break;
+			}
+
+	e->state = L2T_STATE_UNUSED;
+	return e;
+}
+
+/*
+ * Called when an L2T entry has no more users.
+ */
+static void t4_l2e_free(struct l2t_entry *e)
+{
+	struct l2t_data *d;
+
+	spin_lock_bh(&e->lock);
+	if (atomic_read(&e->refcnt) == 0) {  /* hasn't been recycled */
+		if (e->neigh) {
+			neigh_release(e->neigh);
+			e->neigh = NULL;
+		}
+	}
+	spin_unlock_bh(&e->lock);
+
+	d = container_of(e, struct l2t_data, l2tab[e->idx]);
+	atomic_inc(&d->nfree);
+}
+
+void cxgb4_l2t_release(struct l2t_entry *e)
+{
+	if (atomic_dec_and_test(&e->refcnt))
+		t4_l2e_free(e);
+}
+EXPORT_SYMBOL(cxgb4_l2t_release);
+
+/*
+ * Update an L2T entry that was previously used for the same next hop as neigh.
+ * Must be called with softirqs disabled.
+ */
+static void reuse_entry(struct l2t_entry *e, struct neighbour *neigh)
+{
+	unsigned int nud_state;
+
+	spin_lock(&e->lock);                /* avoid race with t4_l2t_free */
+	if (neigh != e->neigh)
+		neigh_replace(e, neigh);
+	nud_state = neigh->nud_state;
+	if (memcmp(e->dmac, neigh->ha, sizeof(e->dmac)) ||
+	    !(nud_state & NUD_VALID))
+		e->state = L2T_STATE_RESOLVING;
+	else if (nud_state & NUD_CONNECTED)
+		e->state = L2T_STATE_VALID;
+	else
+		e->state = L2T_STATE_STALE;
+	spin_unlock(&e->lock);
+}
+
+struct l2t_entry *cxgb4_l2t_get(struct l2t_data *d, struct neighbour *neigh,
+				const struct net_device *physdev,
+				unsigned int priority)
+{
+	u8 lport;
+	u16 vlan;
+	struct l2t_entry *e;
+	int addr_len = neigh->tbl->key_len;
+	u32 *addr = (u32 *)neigh->primary_key;
+	int ifidx = neigh->dev->ifindex;
+	int hash = addr_hash(addr, addr_len, ifidx);
+
+	if (neigh->dev->flags & IFF_LOOPBACK)
+		lport = netdev2pinfo(physdev)->tx_chan + 4;
+	else
+		lport = netdev2pinfo(physdev)->lport;
+
+	if (neigh->dev->priv_flags & IFF_802_1Q_VLAN)
+		vlan = vlan_dev_vlan_id(neigh->dev);
+	else
+		vlan = VLAN_NONE;
+
+	write_lock_bh(&d->lock);
+	for (e = d->l2tab[hash].first; e; e = e->next)
+		if (!addreq(e, addr) && e->ifindex == ifidx &&
+		    e->vlan == vlan && e->lport == lport) {
+			l2t_hold(d, e);
+			if (atomic_read(&e->refcnt) == 1)
+				reuse_entry(e, neigh);
+			goto done;
+		}
+
+	/* Need to allocate a new entry */
+	e = alloc_l2e(d);
+	if (e) {
+		spin_lock(&e->lock);          /* avoid race with t4_l2t_free */
+		e->state = L2T_STATE_RESOLVING;
+		memcpy(e->addr, addr, addr_len);
+		e->ifindex = ifidx;
+		e->hash = hash;
+		e->lport = lport;
+		e->v6 = addr_len == 16;
+		atomic_set(&e->refcnt, 1);
+		neigh_replace(e, neigh);
+		e->vlan = vlan;
+		e->next = d->l2tab[hash].first;
+		d->l2tab[hash].first = e;
+		spin_unlock(&e->lock);
+	}
+done:
+	write_unlock_bh(&d->lock);
+	return e;
+}
+EXPORT_SYMBOL(cxgb4_l2t_get);
+
+/*
+ * Called when address resolution fails for an L2T entry to handle packets
+ * on the arpq head.  If a packet specifies a failure handler it is invoked,
+ * otherwise the packet is sent to the device.
+ */
+static void handle_failed_resolution(struct adapter *adap, struct sk_buff *arpq)
+{
+	while (arpq) {
+		struct sk_buff *skb = arpq;
+		const struct l2t_skb_cb *cb = L2T_SKB_CB(skb);
+
+		arpq = skb->next;
+		skb->next = NULL;
+		if (cb->arp_err_handler)
+			cb->arp_err_handler(cb->handle, skb);
+		else
+			t4_ofld_send(adap, skb);
+	}
+}
+
+/*
+ * Called when the host's neighbor layer makes a change to some entry that is
+ * loaded into the HW L2 table.
+ */
+void t4_l2t_update(struct adapter *adap, struct neighbour *neigh)
+{
+	struct l2t_entry *e;
+	struct sk_buff *arpq = NULL;
+	struct l2t_data *d = adap->l2t;
+	int addr_len = neigh->tbl->key_len;
+	u32 *addr = (u32 *) neigh->primary_key;
+	int ifidx = neigh->dev->ifindex;
+	int hash = addr_hash(addr, addr_len, ifidx);
+
+	read_lock_bh(&d->lock);
+	for (e = d->l2tab[hash].first; e; e = e->next)
+		if (!addreq(e, addr) && e->ifindex == ifidx) {
+			spin_lock(&e->lock);
+			if (atomic_read(&e->refcnt))
+				goto found;
+			spin_unlock(&e->lock);
+			break;
+		}
+	read_unlock_bh(&d->lock);
+	return;
+
+ found:
+	read_unlock(&d->lock);
+
+	if (neigh != e->neigh)
+		neigh_replace(e, neigh);
+
+	if (e->state == L2T_STATE_RESOLVING) {
+		if (neigh->nud_state & NUD_FAILED) {
+			arpq = e->arpq_head;
+			e->arpq_head = e->arpq_tail = NULL;
+		} else if ((neigh->nud_state & (NUD_CONNECTED | NUD_STALE)) &&
+			   e->arpq_head) {
+			write_l2e(adap, e, 1);
+		}
+	} else {
+		e->state = neigh->nud_state & NUD_CONNECTED ?
+			L2T_STATE_VALID : L2T_STATE_STALE;
+		if (memcmp(e->dmac, neigh->ha, sizeof(e->dmac)))
+			write_l2e(adap, e, 0);
+	}
+
+	spin_unlock_bh(&e->lock);
+
+	if (arpq)
+		handle_failed_resolution(adap, arpq);
+}
+
+/*
+ * Allocate an L2T entry for use by a switching rule.  Such entries need to be
+ * explicitly freed and while busy they are not on any hash chain, so normal
+ * address resolution updates do not see them.
+ */
+struct l2t_entry *t4_l2t_alloc_switching(struct l2t_data *d)
+{
+	struct l2t_entry *e;
+
+	write_lock_bh(&d->lock);
+	e = alloc_l2e(d);
+	if (e) {
+		spin_lock(&e->lock);          /* avoid race with t4_l2t_free */
+		e->state = L2T_STATE_SWITCHING;
+		atomic_set(&e->refcnt, 1);
+		spin_unlock(&e->lock);
+	}
+	write_unlock_bh(&d->lock);
+	return e;
+}
+
+/*
+ * Sets/updates the contents of a switching L2T entry that has been allocated
+ * with an earlier call to @t4_l2t_alloc_switching.
+ */
+int t4_l2t_set_switching(struct adapter *adap, struct l2t_entry *e, u16 vlan,
+			 u8 port, u8 *eth_addr)
+{
+	e->vlan = vlan;
+	e->lport = port;
+	memcpy(e->dmac, eth_addr, ETH_ALEN);
+	return write_l2e(adap, e, 0);
+}
+
+struct l2t_data *t4_init_l2t(void)
+{
+	int i;
+	struct l2t_data *d;
+
+	d = t4_alloc_mem(sizeof(*d));
+	if (!d)
+		return NULL;
+
+	d->rover = d->l2tab;
+	atomic_set(&d->nfree, L2T_SIZE);
+	rwlock_init(&d->lock);
+
+	for (i = 0; i < L2T_SIZE; ++i) {
+		d->l2tab[i].idx = i;
+		d->l2tab[i].state = L2T_STATE_UNUSED;
+		spin_lock_init(&d->l2tab[i].lock);
+		atomic_set(&d->l2tab[i].refcnt, 0);
+	}
+	return d;
+}
+
+#include <linux/module.h>
+#include <linux/debugfs.h>
+#include <linux/seq_file.h>
+
+static inline void *l2t_get_idx(struct seq_file *seq, loff_t pos)
+{
+	struct l2t_entry *l2tab = seq->private;
+
+	return pos >= L2T_SIZE ? NULL : &l2tab[pos];
+}
+
+static void *l2t_seq_start(struct seq_file *seq, loff_t *pos)
+{
+	return *pos ? l2t_get_idx(seq, *pos - 1) : SEQ_START_TOKEN;
+}
+
+static void *l2t_seq_next(struct seq_file *seq, void *v, loff_t *pos)
+{
+	v = l2t_get_idx(seq, *pos);
+	if (v)
+		++*pos;
+	return v;
+}
+
+static void l2t_seq_stop(struct seq_file *seq, void *v)
+{
+}
+
+static char l2e_state(const struct l2t_entry *e)
+{
+	switch (e->state) {
+	case L2T_STATE_VALID: return 'V';
+	case L2T_STATE_STALE: return 'S';
+	case L2T_STATE_SYNC_WRITE: return 'W';
+	case L2T_STATE_RESOLVING: return e->arpq_head ? 'A' : 'R';
+	case L2T_STATE_SWITCHING: return 'X';
+	default:
+		return 'U';
+	}
+}
+
+static int l2t_seq_show(struct seq_file *seq, void *v)
+{
+	if (v == SEQ_START_TOKEN)
+		seq_puts(seq, " Idx IP address                "
+			 "Ethernet address  VLAN/P LP State Users Port\n");
+	else {
+		char ip[60];
+		struct l2t_entry *e = v;
+
+		spin_lock_bh(&e->lock);
+		if (e->state == L2T_STATE_SWITCHING)
+			ip[0] = '\0';
+		else
+			sprintf(ip, e->v6 ? "%pI6c" : "%pI4", e->addr);
+		seq_printf(seq, "%4u %-25s %17pM %4d %u %2u   %c   %5u %s\n",
+			   e->idx, ip, e->dmac,
+			   e->vlan & VLAN_VID_MASK, vlan_prio(e), e->lport,
+			   l2e_state(e), atomic_read(&e->refcnt),
+			   e->neigh ? e->neigh->dev->name : "");
+		spin_unlock_bh(&e->lock);
+	}
+	return 0;
+}
+
+static const struct seq_operations l2t_seq_ops = {
+	.start = l2t_seq_start,
+	.next = l2t_seq_next,
+	.stop = l2t_seq_stop,
+	.show = l2t_seq_show
+};
+
+static int l2t_seq_open(struct inode *inode, struct file *file)
+{
+	int rc = seq_open(file, &l2t_seq_ops);
+
+	if (!rc) {
+		struct adapter *adap = inode->i_private;
+		struct seq_file *seq = file->private_data;
+
+		seq->private = adap->l2t->l2tab;
+	}
+	return rc;
+}
+
+const struct file_operations t4_l2t_fops = {
+	.owner = THIS_MODULE,
+	.open = l2t_seq_open,
+	.read = seq_read,
+	.llseek = seq_lseek,
+	.release = seq_release,
+};
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/l2t.h linux-2.6.34-rc4/drivers/net/cxgb4/l2t.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/l2t.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/l2t.h	2010-04-13 02:19:01.108633083 +0000
@@ -0,0 +1,110 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __CXGB4_L2T_H
+#define __CXGB4_L2T_H
+
+#include <linux/spinlock.h>
+#include <linux/if_ether.h>
+#include <asm/atomic.h>
+
+struct adapter;
+struct l2t_data;
+struct neighbour;
+struct net_device;
+struct file_operations;
+struct cpl_l2t_write_rpl;
+
+/*
+ * Each L2T entry plays multiple roles.  First of all, it keeps state for the
+ * corresponding entry of the HW L2 table and maintains a queue of offload
+ * packets awaiting address resolution.  Second, it is a node of a hash table
+ * chain, where the nodes of the chain are linked together through their next
+ * pointer.  Finally, each node is a bucket of a hash table, pointing to the
+ * first element in its chain through its first pointer.
+ */
+struct l2t_entry {
+	u16 state;                  /* entry state */
+	u16 idx;                    /* entry index */
+	u32 addr[4];                /* next hop IP or IPv6 address */
+	int ifindex;                /* neighbor's net_device's ifindex */
+	struct neighbour *neigh;    /* associated neighbour */
+	struct l2t_entry *first;    /* start of hash chain */
+	struct l2t_entry *next;     /* next l2t_entry on chain */
+	struct sk_buff *arpq_head;  /* queue of packets awaiting resolution */
+	struct sk_buff *arpq_tail;
+	spinlock_t lock;
+	atomic_t refcnt;            /* entry reference count */
+	u16 hash;                   /* hash bucket the entry is on */
+	u16 vlan;                   /* VLAN TCI (id: bits 0-11, prio: 13-15 */
+	u8 v6;                      /* whether entry is for IPv6 */
+	u8 lport;                   /* associated offload logical interface */
+	u8 dmac[ETH_ALEN];          /* neighbour's MAC address */
+};
+
+typedef void (*arp_err_handler_t)(void *handle, struct sk_buff *skb);
+
+/*
+ * Callback stored in an skb to handle address resolution failure.
+ */
+struct l2t_skb_cb {
+	void *handle;
+	arp_err_handler_t arp_err_handler;
+};
+
+#define L2T_SKB_CB(skb) ((struct l2t_skb_cb *)(skb)->cb)
+
+static inline void t4_set_arp_err_handler(struct sk_buff *skb, void *handle,
+					  arp_err_handler_t handler)
+{
+	L2T_SKB_CB(skb)->handle = handle;
+	L2T_SKB_CB(skb)->arp_err_handler = handler;
+}
+
+void cxgb4_l2t_release(struct l2t_entry *e);
+int cxgb4_l2t_send(struct net_device *dev, struct sk_buff *skb,
+		   struct l2t_entry *e);
+struct l2t_entry *cxgb4_l2t_get(struct l2t_data *d, struct neighbour *neigh,
+				const struct net_device *physdev,
+				unsigned int priority);
+
+void t4_l2t_update(struct adapter *adap, struct neighbour *neigh);
+struct l2t_entry *t4_l2t_alloc_switching(struct l2t_data *d);
+int t4_l2t_set_switching(struct adapter *adap, struct l2t_entry *e, u16 vlan,
+			 u8 port, u8 *eth_addr);
+struct l2t_data *t4_init_l2t(void);
+void do_l2t_write_rpl(struct adapter *p, const struct cpl_l2t_write_rpl *rpl);
+
+extern const struct file_operations t4_l2t_fops;
+#endif  /* __CXGB4_L2T_H */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/sge.c linux-2.6.34-rc4/drivers/net/cxgb4/sge.c
--- linux-2.6.34-rc3/drivers/net/cxgb4/sge.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/sge.c	2010-04-13 02:19:01.109633062 +0000
@@ -0,0 +1,2431 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#include <linux/skbuff.h>
+#include <linux/netdevice.h>
+#include <linux/etherdevice.h>
+#include <linux/if_vlan.h>
+#include <linux/ip.h>
+#include <linux/dma-mapping.h>
+#include <linux/jiffies.h>
+#include <net/ipv6.h>
+#include <net/tcp.h>
+#include "cxgb4.h"
+#include "t4_regs.h"
+#include "t4_msg.h"
+#include "t4fw_api.h"
+
+/*
+ * Rx buffer size.  We use largish buffers if possible but settle for single
+ * pages under memory shortage.
+ */
+#if PAGE_SHIFT >= 16
+# define FL_PG_ORDER 0
+#else
+# define FL_PG_ORDER (16 - PAGE_SHIFT)
+#endif
+
+/* RX_PULL_LEN should be <= RX_COPY_THRES */
+#define RX_COPY_THRES    256
+#define RX_PULL_LEN      128
+
+/*
+ * Main body length for sk_buffs used for Rx Ethernet packets with fragments.
+ * Should be >= RX_PULL_LEN but possibly bigger to give pskb_may_pull some room.
+ */
+#define RX_PKT_SKB_LEN   512
+
+/* Ethernet header padding prepended to RX_PKTs */
+#define RX_PKT_PAD 2
+
+/*
+ * Max number of Tx descriptors we clean up at a time.  Should be modest as
+ * freeing skbs isn't cheap and it happens while holding locks.  We just need
+ * to free packets faster than they arrive, we eventually catch up and keep
+ * the amortized cost reasonable.  Must be >= 2 * TXQ_STOP_THRES.
+ */
+#define MAX_TX_RECLAIM 16
+
+/*
+ * Max number of Rx buffers we replenish at a time.  Again keep this modest,
+ * allocating buffers isn't cheap either.
+ */
+#define MAX_RX_REFILL 16U
+
+/*
+ * Period of the Rx queue check timer.  This timer is infrequent as it has
+ * something to do only when the system experiences severe memory shortage.
+ */
+#define RX_QCHECK_PERIOD (HZ / 2)
+
+/*
+ * Period of the Tx queue check timer.
+ */
+#define TX_QCHECK_PERIOD (HZ / 2)
+
+/*
+ * Max number of Tx descriptors to be reclaimed by the Tx timer.
+ */
+#define MAX_TIMER_TX_RECLAIM 100
+
+/*
+ * Timer index used when backing off due to memory shortage.
+ */
+#define NOMEM_TMR_IDX (SGE_NTIMERS - 1)
+
+/*
+ * An FL with <= FL_STARVE_THRES buffers is starving and a periodic timer will
+ * attempt to refill it.
+ */
+#define FL_STARVE_THRES 4
+
+/*
+ * Suspend an Ethernet Tx queue with fewer available descriptors than this.
+ * This is the same as calc_tx_descs() for a TSO packet with
+ * nr_frags == MAX_SKB_FRAGS.
+ */
+#define ETHTXQ_STOP_THRES \
+	(1 + DIV_ROUND_UP((3 * MAX_SKB_FRAGS) / 2 + (MAX_SKB_FRAGS & 1), 8))
+
+/*
+ * Suspension threshold for non-Ethernet Tx queues.  We require enough room
+ * for a full sized WR.
+ */
+#define TXQ_STOP_THRES (SGE_MAX_WR_LEN / sizeof(struct tx_desc))
+
+/*
+ * Max Tx descriptor space we allow for an Ethernet packet to be inlined
+ * into a WR.
+ */
+#define MAX_IMM_TX_PKT_LEN 128
+
+/*
+ * Max size of a WR sent through a control Tx queue.
+ */
+#define MAX_CTRL_WR_LEN SGE_MAX_WR_LEN
+
+enum {
+	/* packet alignment in FL buffers */
+	FL_ALIGN = L1_CACHE_BYTES < 32 ? 32 : L1_CACHE_BYTES,
+	/* egress status entry size */
+	STAT_LEN = L1_CACHE_BYTES > 64 ? 128 : 64
+};
+
+struct tx_sw_desc {                /* SW state per Tx descriptor */
+	struct sk_buff *skb;
+	struct ulptx_sgl *sgl;
+};
+
+struct rx_sw_desc {                /* SW state per Rx descriptor */
+	struct page *page;
+	dma_addr_t dma_addr;
+};
+
+/*
+ * The low bits of rx_sw_desc.dma_addr have special meaning.
+ */
+enum {
+	RX_LARGE_BUF    = 1 << 0, /* buffer is larger than PAGE_SIZE */
+	RX_UNMAPPED_BUF = 1 << 1, /* buffer is not mapped */
+};
+
+static inline dma_addr_t get_buf_addr(const struct rx_sw_desc *d)
+{
+	return d->dma_addr & ~(dma_addr_t)(RX_LARGE_BUF | RX_UNMAPPED_BUF);
+}
+
+static inline bool is_buf_mapped(const struct rx_sw_desc *d)
+{
+	return !(d->dma_addr & RX_UNMAPPED_BUF);
+}
+
+/**
+ *	txq_avail - return the number of available slots in a Tx queue
+ *	@q: the Tx queue
+ *
+ *	Returns the number of descriptors in a Tx queue available to write new
+ *	packets.
+ */
+static inline unsigned int txq_avail(const struct sge_txq *q)
+{
+	return q->size - 1 - q->in_use;
+}
+
+/**
+ *	fl_cap - return the capacity of a free-buffer list
+ *	@fl: the FL
+ *
+ *	Returns the capacity of a free-buffer list.  The capacity is less than
+ *	the size because one descriptor needs to be left unpopulated, otherwise
+ *	HW will think the FL is empty.
+ */
+static inline unsigned int fl_cap(const struct sge_fl *fl)
+{
+	return fl->size - 8;   /* 1 descriptor = 8 buffers */
+}
+
+static inline bool fl_starving(const struct sge_fl *fl)
+{
+	return fl->avail - fl->pend_cred <= FL_STARVE_THRES;
+}
+
+static int map_skb(struct device *dev, const struct sk_buff *skb,
+		   dma_addr_t *addr)
+{
+	const skb_frag_t *fp, *end;
+	const struct skb_shared_info *si;
+
+	*addr = dma_map_single(dev, skb->data, skb_headlen(skb), DMA_TO_DEVICE);
+	if (dma_mapping_error(dev, *addr))
+		goto out_err;
+
+	si = skb_shinfo(skb);
+	end = &si->frags[si->nr_frags];
+
+	for (fp = si->frags; fp < end; fp++) {
+		*++addr = dma_map_page(dev, fp->page, fp->page_offset, fp->size,
+				       DMA_TO_DEVICE);
+		if (dma_mapping_error(dev, *addr))
+			goto unwind;
+	}
+	return 0;
+
+unwind:
+	while (fp-- > si->frags)
+		dma_unmap_page(dev, *--addr, fp->size, DMA_TO_DEVICE);
+
+	dma_unmap_single(dev, addr[-1], skb_headlen(skb), DMA_TO_DEVICE);
+out_err:
+	return -ENOMEM;
+}
+
+#ifdef CONFIG_NEED_DMA_MAP_STATE
+static void unmap_skb(struct device *dev, const struct sk_buff *skb,
+		      const dma_addr_t *addr)
+{
+	const skb_frag_t *fp, *end;
+	const struct skb_shared_info *si;
+
+	dma_unmap_single(dev, *addr++, skb_headlen(skb), DMA_TO_DEVICE);
+
+	si = skb_shinfo(skb);
+	end = &si->frags[si->nr_frags];
+	for (fp = si->frags; fp < end; fp++)
+		dma_unmap_page(dev, *addr++, fp->size, DMA_TO_DEVICE);
+}
+
+/**
+ *	deferred_unmap_destructor - unmap a packet when it is freed
+ *	@skb: the packet
+ *
+ *	This is the packet destructor used for Tx packets that need to remain
+ *	mapped until they are freed rather than until their Tx descriptors are
+ *	freed.
+ */
+static void deferred_unmap_destructor(struct sk_buff *skb)
+{
+	unmap_skb(skb->dev->dev.parent, skb, (dma_addr_t *)skb->head);
+}
+#endif
+
+static void unmap_sgl(struct device *dev, const struct sk_buff *skb,
+		      const struct ulptx_sgl *sgl, const struct sge_txq *q)
+{
+	const struct ulptx_sge_pair *p;
+	unsigned int nfrags = skb_shinfo(skb)->nr_frags;
+
+	if (likely(skb_headlen(skb)))
+		dma_unmap_single(dev, be64_to_cpu(sgl->addr0), ntohl(sgl->len0),
+				 DMA_TO_DEVICE);
+	else {
+		dma_unmap_page(dev, be64_to_cpu(sgl->addr0), ntohl(sgl->len0),
+			       DMA_TO_DEVICE);
+		nfrags--;
+	}
+
+	/*
+	 * the complexity below is because of the possibility of a wrap-around
+	 * in the middle of an SGL
+	 */
+	for (p = sgl->sge; nfrags >= 2; nfrags -= 2) {
+		if (likely((u8 *)(p + 1) <= (u8 *)q->stat)) {
+unmap:			dma_unmap_page(dev, be64_to_cpu(p->addr[0]),
+				       ntohl(p->len[0]), DMA_TO_DEVICE);
+			dma_unmap_page(dev, be64_to_cpu(p->addr[1]),
+				       ntohl(p->len[1]), DMA_TO_DEVICE);
+			p++;
+		} else if ((u8 *)p == (u8 *)q->stat) {
+			p = (const struct ulptx_sge_pair *)q->desc;
+			goto unmap;
+		} else if ((u8 *)p + 8 == (u8 *)q->stat) {
+			const __be64 *addr = (const __be64 *)q->desc;
+
+			dma_unmap_page(dev, be64_to_cpu(addr[0]),
+				       ntohl(p->len[0]), DMA_TO_DEVICE);
+			dma_unmap_page(dev, be64_to_cpu(addr[1]),
+				       ntohl(p->len[1]), DMA_TO_DEVICE);
+			p = (const struct ulptx_sge_pair *)&addr[2];
+		} else {
+			const __be64 *addr = (const __be64 *)q->desc;
+
+			dma_unmap_page(dev, be64_to_cpu(p->addr[0]),
+				       ntohl(p->len[0]), DMA_TO_DEVICE);
+			dma_unmap_page(dev, be64_to_cpu(addr[0]),
+				       ntohl(p->len[1]), DMA_TO_DEVICE);
+			p = (const struct ulptx_sge_pair *)&addr[1];
+		}
+	}
+	if (nfrags) {
+		__be64 addr;
+
+		if ((u8 *)p == (u8 *)q->stat)
+			p = (const struct ulptx_sge_pair *)q->desc;
+		addr = (u8 *)p + 16 <= (u8 *)q->stat ? p->addr[0] :
+						       *(const __be64 *)q->desc;
+		dma_unmap_page(dev, be64_to_cpu(addr), ntohl(p->len[0]),
+			       DMA_TO_DEVICE);
+	}
+}
+
+/**
+ *	free_tx_desc - reclaims Tx descriptors and their buffers
+ *	@adapter: the adapter
+ *	@q: the Tx queue to reclaim descriptors from
+ *	@n: the number of descriptors to reclaim
+ *	@unmap: whether the buffers should be unmapped for DMA
+ *
+ *	Reclaims Tx descriptors from an SGE Tx queue and frees the associated
+ *	Tx buffers.  Called with the Tx queue lock held.
+ */
+static void free_tx_desc(struct adapter *adap, struct sge_txq *q,
+			 unsigned int n, bool unmap)
+{
+	struct tx_sw_desc *d;
+	unsigned int cidx = q->cidx;
+	struct device *dev = adap->pdev_dev;
+
+	d = &q->sdesc[cidx];
+	while (n--) {
+		if (d->skb) {                       /* an SGL is present */
+			if (unmap)
+				unmap_sgl(dev, d->skb, d->sgl, q);
+			kfree_skb(d->skb);
+			d->skb = NULL;
+		}
+		++d;
+		if (++cidx == q->size) {
+			cidx = 0;
+			d = q->sdesc;
+		}
+	}
+	q->cidx = cidx;
+}
+
+/*
+ * Return the number of reclaimable descriptors in a Tx queue.
+ */
+static inline int reclaimable(const struct sge_txq *q)
+{
+	int hw_cidx = ntohs(q->stat->cidx);
+	hw_cidx -= q->cidx;
+	return hw_cidx < 0 ? hw_cidx + q->size : hw_cidx;
+}
+
+/**
+ *	reclaim_completed_tx - reclaims completed Tx descriptors
+ *	@adap: the adapter
+ *	@q: the Tx queue to reclaim completed descriptors from
+ *	@unmap: whether the buffers should be unmapped for DMA
+ *
+ *	Reclaims Tx descriptors that the SGE has indicated it has processed,
+ *	and frees the associated buffers if possible.  Called with the Tx
+ *	queue locked.
+ */
+static inline void reclaim_completed_tx(struct adapter *adap, struct sge_txq *q,
+					bool unmap)
+{
+	int avail = reclaimable(q);
+
+	if (avail) {
+		/*
+		 * Limit the amount of clean up work we do at a time to keep
+		 * the Tx lock hold time O(1).
+		 */
+		if (avail > MAX_TX_RECLAIM)
+			avail = MAX_TX_RECLAIM;
+
+		free_tx_desc(adap, q, avail, unmap);
+		q->in_use -= avail;
+	}
+}
+
+static inline int get_buf_size(const struct rx_sw_desc *d)
+{
+#if FL_PG_ORDER > 0
+	return (d->dma_addr & RX_LARGE_BUF) ? (PAGE_SIZE << FL_PG_ORDER) :
+					      PAGE_SIZE;
+#else
+	return PAGE_SIZE;
+#endif
+}
+
+/**
+ *	free_rx_bufs - free the Rx buffers on an SGE free list
+ *	@adap: the adapter
+ *	@q: the SGE free list to free buffers from
+ *	@n: how many buffers to free
+ *
+ *	Release the next @n buffers on an SGE free-buffer Rx queue.   The
+ *	buffers must be made inaccessible to HW before calling this function.
+ */
+static void free_rx_bufs(struct adapter *adap, struct sge_fl *q, int n)
+{
+	while (n--) {
+		struct rx_sw_desc *d = &q->sdesc[q->cidx];
+
+		if (is_buf_mapped(d))
+			dma_unmap_page(adap->pdev_dev, get_buf_addr(d),
+				       get_buf_size(d), PCI_DMA_FROMDEVICE);
+		put_page(d->page);
+		d->page = NULL;
+		if (++q->cidx == q->size)
+			q->cidx = 0;
+		q->avail--;
+	}
+}
+
+/**
+ *	unmap_rx_buf - unmap the current Rx buffer on an SGE free list
+ *	@adap: the adapter
+ *	@q: the SGE free list
+ *
+ *	Unmap the current buffer on an SGE free-buffer Rx queue.   The
+ *	buffer must be made inaccessible to HW before calling this function.
+ *
+ *	This is similar to @free_rx_bufs above but does not free the buffer.
+ *	Do note that the FL still loses any further access to the buffer.
+ */
+static void unmap_rx_buf(struct adapter *adap, struct sge_fl *q)
+{
+	struct rx_sw_desc *d = &q->sdesc[q->cidx];
+
+	if (is_buf_mapped(d))
+		dma_unmap_page(adap->pdev_dev, get_buf_addr(d),
+			       get_buf_size(d), PCI_DMA_FROMDEVICE);
+	d->page = NULL;
+	if (++q->cidx == q->size)
+		q->cidx = 0;
+	q->avail--;
+}
+
+static inline void ring_fl_db(struct adapter *adap, struct sge_fl *q)
+{
+	if (q->pend_cred >= 8) {
+		wmb();
+		t4_write_reg(adap, MYPF_REG(SGE_PF_KDOORBELL), DBPRIO |
+			     QID(q->cntxt_id) | PIDX(q->pend_cred / 8));
+		q->pend_cred &= 7;
+	}
+}
+
+static inline void set_rx_sw_desc(struct rx_sw_desc *sd, struct page *pg,
+				  dma_addr_t mapping)
+{
+	sd->page = pg;
+	sd->dma_addr = mapping;      /* includes size low bits */
+}
+
+/**
+ *	refill_fl - refill an SGE Rx buffer ring
+ *	@adap: the adapter
+ *	@q: the ring to refill
+ *	@n: the number of new buffers to allocate
+ *	@gfp: the gfp flags for the allocations
+ *
+ *	(Re)populate an SGE free-buffer queue with up to @n new packet buffers,
+ *	allocated with the supplied gfp flags.  The caller must assure that
+ *	@n does not exceed the queue's capacity.  If afterwards the queue is
+ *	found critically low mark it as starving in the bitmap of starving FLs.
+ *
+ *	Returns the number of buffers allocated.
+ */
+static unsigned int refill_fl(struct adapter *adap, struct sge_fl *q, int n,
+			      gfp_t gfp)
+{
+	struct page *pg;
+	dma_addr_t mapping;
+	unsigned int cred = q->avail;
+	__be64 *d = &q->desc[q->pidx];
+	struct rx_sw_desc *sd = &q->sdesc[q->pidx];
+
+	gfp |= __GFP_NOWARN;         /* failures are expected */
+
+#if FL_PG_ORDER > 0
+	/*
+	 * Prefer large buffers
+	 */
+	while (n) {
+		pg = alloc_pages(gfp | __GFP_COMP, FL_PG_ORDER);
+		if (unlikely(!pg)) {
+			q->large_alloc_failed++;
+			break;       /* fall back to single pages */
+		}
+
+		mapping = dma_map_page(adap->pdev_dev, pg, 0,
+				       PAGE_SIZE << FL_PG_ORDER,
+				       PCI_DMA_FROMDEVICE);
+		if (unlikely(dma_mapping_error(adap->pdev_dev, mapping))) {
+			__free_pages(pg, FL_PG_ORDER);
+			goto out;   /* do not try small pages for this error */
+		}
+		mapping |= RX_LARGE_BUF;
+		*d++ = cpu_to_be64(mapping);
+
+		set_rx_sw_desc(sd, pg, mapping);
+		sd++;
+
+		q->avail++;
+		if (++q->pidx == q->size) {
+			q->pidx = 0;
+			sd = q->sdesc;
+			d = q->desc;
+		}
+		n--;
+	}
+#endif
+
+	while (n--) {
+		pg = __netdev_alloc_page(adap->port[0], gfp);
+		if (unlikely(!pg)) {
+			q->alloc_failed++;
+			break;
+		}
+
+		mapping = dma_map_page(adap->pdev_dev, pg, 0, PAGE_SIZE,
+				       PCI_DMA_FROMDEVICE);
+		if (unlikely(dma_mapping_error(adap->pdev_dev, mapping))) {
+			netdev_free_page(adap->port[0], pg);
+			goto out;
+		}
+		*d++ = cpu_to_be64(mapping);
+
+		set_rx_sw_desc(sd, pg, mapping);
+		sd++;
+
+		q->avail++;
+		if (++q->pidx == q->size) {
+			q->pidx = 0;
+			sd = q->sdesc;
+			d = q->desc;
+		}
+	}
+
+out:	cred = q->avail - cred;
+	q->pend_cred += cred;
+	ring_fl_db(adap, q);
+
+	if (unlikely(fl_starving(q))) {
+		smp_wmb();
+		set_bit(q->cntxt_id, adap->sge.starving_fl);
+	}
+
+	return cred;
+}
+
+static inline void __refill_fl(struct adapter *adap, struct sge_fl *fl)
+{
+	refill_fl(adap, fl, min(MAX_RX_REFILL, fl_cap(fl) - fl->avail),
+		  GFP_ATOMIC);
+}
+
+/**
+ *	alloc_ring - allocate resources for an SGE descriptor ring
+ *	@dev: the PCI device's core device
+ *	@nelem: the number of descriptors
+ *	@elem_size: the size of each descriptor
+ *	@sw_size: the size of the SW state associated with each ring element
+ *	@phys: the physical address of the allocated ring
+ *	@metadata: address of the array holding the SW state for the ring
+ *	@stat_size: extra space in HW ring for status information
+ *
+ *	Allocates resources for an SGE descriptor ring, such as Tx queues,
+ *	free buffer lists, or response queues.  Each SGE ring requires
+ *	space for its HW descriptors plus, optionally, space for the SW state
+ *	associated with each HW entry (the metadata).  The function returns
+ *	three values: the virtual address for the HW ring (the return value
+ *	of the function), the bus address of the HW ring, and the address
+ *	of the SW ring.
+ */
+static void *alloc_ring(struct device *dev, size_t nelem, size_t elem_size,
+			size_t sw_size, dma_addr_t *phys, void *metadata,
+			size_t stat_size)
+{
+	size_t len = nelem * elem_size + stat_size;
+	void *s = NULL;
+	void *p = dma_alloc_coherent(dev, len, phys, GFP_KERNEL);
+
+	if (!p)
+		return NULL;
+	if (sw_size) {
+		s = kcalloc(nelem, sw_size, GFP_KERNEL);
+
+		if (!s) {
+			dma_free_coherent(dev, len, p, *phys);
+			return NULL;
+		}
+	}
+	if (metadata)
+		*(void **)metadata = s;
+	memset(p, 0, len);
+	return p;
+}
+
+/**
+ *	sgl_len - calculates the size of an SGL of the given capacity
+ *	@n: the number of SGL entries
+ *
+ *	Calculates the number of flits needed for a scatter/gather list that
+ *	can hold the given number of entries.
+ */
+static inline unsigned int sgl_len(unsigned int n)
+{
+	n--;
+	return (3 * n) / 2 + (n & 1) + 2;
+}
+
+/**
+ *	flits_to_desc - returns the num of Tx descriptors for the given flits
+ *	@n: the number of flits
+ *
+ *	Returns the number of Tx descriptors needed for the supplied number
+ *	of flits.
+ */
+static inline unsigned int flits_to_desc(unsigned int n)
+{
+	BUG_ON(n > SGE_MAX_WR_LEN / 8);
+	return DIV_ROUND_UP(n, 8);
+}
+
+/**
+ *	is_eth_imm - can an Ethernet packet be sent as immediate data?
+ *	@skb: the packet
+ *
+ *	Returns whether an Ethernet packet is small enough to fit as
+ *	immediate data.
+ */
+static inline int is_eth_imm(const struct sk_buff *skb)
+{
+	return skb->len <= MAX_IMM_TX_PKT_LEN - sizeof(struct cpl_tx_pkt);
+}
+
+/**
+ *	calc_tx_flits - calculate the number of flits for a packet Tx WR
+ *	@skb: the packet
+ *
+ *	Returns the number of flits needed for a Tx WR for the given Ethernet
+ *	packet, including the needed WR and CPL headers.
+ */
+static inline unsigned int calc_tx_flits(const struct sk_buff *skb)
+{
+	unsigned int flits;
+
+	if (is_eth_imm(skb))
+		return DIV_ROUND_UP(skb->len + sizeof(struct cpl_tx_pkt), 8);
+
+	flits = sgl_len(skb_shinfo(skb)->nr_frags + 1) + 4;
+	if (skb_shinfo(skb)->gso_size)
+		flits += 2;
+	return flits;
+}
+
+/**
+ *	calc_tx_descs - calculate the number of Tx descriptors for a packet
+ *	@skb: the packet
+ *
+ *	Returns the number of Tx descriptors needed for the given Ethernet
+ *	packet, including the needed WR and CPL headers.
+ */
+static inline unsigned int calc_tx_descs(const struct sk_buff *skb)
+{
+	return flits_to_desc(calc_tx_flits(skb));
+}
+
+/**
+ *	write_sgl - populate a scatter/gather list for a packet
+ *	@skb: the packet
+ *	@q: the Tx queue we are writing into
+ *	@sgl: starting location for writing the SGL
+ *	@end: points right after the end of the SGL
+ *	@start: start offset into skb main-body data to include in the SGL
+ *	@addr: the list of bus addresses for the SGL elements
+ *
+ *	Generates a gather list for the buffers that make up a packet.
+ *	The caller must provide adequate space for the SGL that will be written.
+ *	The SGL includes all of the packet's page fragments and the data in its
+ *	main body except for the first @start bytes.  @sgl must be 16-byte
+ *	aligned and within a Tx descriptor with available space.  @end points
+ *	right after the end of the SGL but does not account for any potential
+ *	wrap around, i.e., @end > @sgl.
+ */
+static void write_sgl(const struct sk_buff *skb, struct sge_txq *q,
+		      struct ulptx_sgl *sgl, u64 *end, unsigned int start,
+		      const dma_addr_t *addr)
+{
+	unsigned int i, len;
+	struct ulptx_sge_pair *to;
+	const struct skb_shared_info *si = skb_shinfo(skb);
+	unsigned int nfrags = si->nr_frags;
+	struct ulptx_sge_pair buf[MAX_SKB_FRAGS / 2 + 1];
+
+	len = skb_headlen(skb) - start;
+	if (likely(len)) {
+		sgl->len0 = htonl(len);
+		sgl->addr0 = cpu_to_be64(addr[0] + start);
+		nfrags++;
+	} else {
+		sgl->len0 = htonl(si->frags[0].size);
+		sgl->addr0 = cpu_to_be64(addr[1]);
+	}
+
+	sgl->cmd_nsge = htonl(ULPTX_CMD(ULP_TX_SC_DSGL) | ULPTX_NSGE(nfrags));
+	if (likely(--nfrags == 0))
+		return;
+	/*
+	 * Most of the complexity below deals with the possibility we hit the
+	 * end of the queue in the middle of writing the SGL.  For this case
+	 * only we create the SGL in a temporary buffer and then copy it.
+	 */
+	to = (u8 *)end > (u8 *)q->stat ? buf : sgl->sge;
+
+	for (i = (nfrags != si->nr_frags); nfrags >= 2; nfrags -= 2, to++) {
+		to->len[0] = cpu_to_be32(si->frags[i].size);
+		to->len[1] = cpu_to_be32(si->frags[++i].size);
+		to->addr[0] = cpu_to_be64(addr[i]);
+		to->addr[1] = cpu_to_be64(addr[++i]);
+	}
+	if (nfrags) {
+		to->len[0] = cpu_to_be32(si->frags[i].size);
+		to->len[1] = cpu_to_be32(0);
+		to->addr[0] = cpu_to_be64(addr[i + 1]);
+	}
+	if (unlikely((u8 *)end > (u8 *)q->stat)) {
+		unsigned int part0 = (u8 *)q->stat - (u8 *)sgl->sge, part1;
+
+		if (likely(part0))
+			memcpy(sgl->sge, buf, part0);
+		part1 = (u8 *)end - (u8 *)q->stat;
+		memcpy(q->desc, (u8 *)buf + part0, part1);
+		end = (void *)q->desc + part1;
+	}
+	if ((uintptr_t)end & 8)           /* 0-pad to multiple of 16 */
+		*(u64 *)end = 0;
+}
+
+/**
+ *	ring_tx_db - check and potentially ring a Tx queue's doorbell
+ *	@adap: the adapter
+ *	@q: the Tx queue
+ *	@n: number of new descriptors to give to HW
+ *
+ *	Ring the doorbel for a Tx queue.
+ */
+static inline void ring_tx_db(struct adapter *adap, struct sge_txq *q, int n)
+{
+	wmb();            /* write descriptors before telling HW */
+	t4_write_reg(adap, MYPF_REG(SGE_PF_KDOORBELL),
+		     QID(q->cntxt_id) | PIDX(n));
+}
+
+/**
+ *	inline_tx_skb - inline a packet's data into Tx descriptors
+ *	@skb: the packet
+ *	@q: the Tx queue where the packet will be inlined
+ *	@pos: starting position in the Tx queue where to inline the packet
+ *
+ *	Inline a packet's contents directly into Tx descriptors, starting at
+ *	the given position within the Tx DMA ring.
+ *	Most of the complexity of this operation is dealing with wrap arounds
+ *	in the middle of the packet we want to inline.
+ */
+static void inline_tx_skb(const struct sk_buff *skb, const struct sge_txq *q,
+			  void *pos)
+{
+	u64 *p;
+	int left = (void *)q->stat - pos;
+
+	if (likely(skb->len <= left)) {
+		if (likely(!skb->data_len))
+			skb_copy_from_linear_data(skb, pos, skb->len);
+		else
+			skb_copy_bits(skb, 0, pos, skb->len);
+		pos += skb->len;
+	} else {
+		skb_copy_bits(skb, 0, pos, left);
+		skb_copy_bits(skb, left, q->desc, skb->len - left);
+		pos = (void *)q->desc + (skb->len - left);
+	}
+
+	/* 0-pad to multiple of 16 */
+	p = PTR_ALIGN(pos, 8);
+	if ((uintptr_t)p & 8)
+		*p = 0;
+}
+
+/*
+ * Figure out what HW csum a packet wants and return the appropriate control
+ * bits.
+ */
+static u64 hwcsum(const struct sk_buff *skb)
+{
+	int csum_type;
+	const struct iphdr *iph = ip_hdr(skb);
+
+	if (iph->version == 4) {
+		if (iph->protocol == IPPROTO_TCP)
+			csum_type = TX_CSUM_TCPIP;
+		else if (iph->protocol == IPPROTO_UDP)
+			csum_type = TX_CSUM_UDPIP;
+		else {
+nocsum:			/*
+			 * unknown protocol, disable HW csum
+			 * and hope a bad packet is detected
+			 */
+			return TXPKT_L4CSUM_DIS;
+		}
+	} else {
+		/*
+		 * this doesn't work with extension headers
+		 */
+		const struct ipv6hdr *ip6h = (const struct ipv6hdr *)iph;
+
+		if (ip6h->nexthdr == IPPROTO_TCP)
+			csum_type = TX_CSUM_TCPIP6;
+		else if (ip6h->nexthdr == IPPROTO_UDP)
+			csum_type = TX_CSUM_UDPIP6;
+		else
+			goto nocsum;
+	}
+
+	if (likely(csum_type >= TX_CSUM_TCPIP))
+		return TXPKT_CSUM_TYPE(csum_type) |
+			TXPKT_IPHDR_LEN(skb_network_header_len(skb)) |
+			TXPKT_ETHHDR_LEN(skb_network_offset(skb) - ETH_HLEN);
+	else {
+		int start = skb_transport_offset(skb);
+
+		return TXPKT_CSUM_TYPE(csum_type) | TXPKT_CSUM_START(start) |
+			TXPKT_CSUM_LOC(start + skb->csum_offset);
+	}
+}
+
+static void eth_txq_stop(struct sge_eth_txq *q)
+{
+	netif_tx_stop_queue(q->txq);
+	q->q.stops++;
+}
+
+static inline void txq_advance(struct sge_txq *q, unsigned int n)
+{
+	q->in_use += n;
+	q->pidx += n;
+	if (q->pidx >= q->size)
+		q->pidx -= q->size;
+}
+
+/**
+ *	t4_eth_xmit - add a packet to an Ethernet Tx queue
+ *	@skb: the packet
+ *	@dev: the egress net device
+ *
+ *	Add a packet to an SGE Ethernet Tx queue.  Runs with softirqs disabled.
+ */
+netdev_tx_t t4_eth_xmit(struct sk_buff *skb, struct net_device *dev)
+{
+	u32 wr_mid;
+	u64 cntrl, *end;
+	int qidx, credits;
+	unsigned int flits, ndesc;
+	struct adapter *adap;
+	struct sge_eth_txq *q;
+	const struct port_info *pi;
+	struct fw_eth_tx_pkt_wr *wr;
+	struct cpl_tx_pkt_core *cpl;
+	const struct skb_shared_info *ssi;
+	dma_addr_t addr[MAX_SKB_FRAGS + 1];
+
+	/*
+	 * The chip min packet length is 10 octets but play safe and reject
+	 * anything shorter than an Ethernet header.
+	 */
+	if (unlikely(skb->len < ETH_HLEN)) {
+out_free:	dev_kfree_skb(skb);
+		return NETDEV_TX_OK;
+	}
+
+	pi = netdev_priv(dev);
+	adap = pi->adapter;
+	qidx = skb_get_queue_mapping(skb);
+	q = &adap->sge.ethtxq[qidx + pi->first_qset];
+
+	reclaim_completed_tx(adap, &q->q, true);
+
+	flits = calc_tx_flits(skb);
+	ndesc = flits_to_desc(flits);
+	credits = txq_avail(&q->q) - ndesc;
+
+	if (unlikely(credits < 0)) {
+		eth_txq_stop(q);
+		dev_err(adap->pdev_dev,
+			"%s: Tx ring %u full while queue awake!\n",
+			dev->name, qidx);
+		return NETDEV_TX_BUSY;
+	}
+
+	if (!is_eth_imm(skb) &&
+	    unlikely(map_skb(adap->pdev_dev, skb, addr) < 0)) {
+		q->mapping_err++;
+		goto out_free;
+	}
+
+	wr_mid = FW_WR_LEN16(DIV_ROUND_UP(flits, 2));
+	if (unlikely(credits < ETHTXQ_STOP_THRES)) {
+		eth_txq_stop(q);
+		wr_mid |= FW_WR_EQUEQ | FW_WR_EQUIQ;
+	}
+
+	wr = (void *)&q->q.desc[q->q.pidx];
+	wr->equiq_to_len16 = htonl(wr_mid);
+	wr->r3 = cpu_to_be64(0);
+	end = (u64 *)wr + flits;
+
+	ssi = skb_shinfo(skb);
+	if (ssi->gso_size) {
+		struct cpl_tx_pkt_lso *lso = (void *)wr;
+		bool v6 = (ssi->gso_type & SKB_GSO_TCPV6) != 0;
+		int l3hdr_len = skb_network_header_len(skb);
+		int eth_xtra_len = skb_network_offset(skb) - ETH_HLEN;
+
+		wr->op_immdlen = htonl(FW_WR_OP(FW_ETH_TX_PKT_WR) |
+				       FW_WR_IMMDLEN(sizeof(*lso)));
+		lso->lso_ctrl = htonl(LSO_OPCODE(CPL_TX_PKT_LSO) |
+				      LSO_FIRST_SLICE | LSO_LAST_SLICE |
+				      LSO_IPV6(v6) |
+				      LSO_ETHHDR_LEN(eth_xtra_len / 4) |
+				      LSO_IPHDR_LEN(l3hdr_len / 4) |
+				      LSO_TCPHDR_LEN(tcp_hdr(skb)->doff));
+		lso->ipid_ofst = htons(0);
+		lso->mss = htons(ssi->gso_size);
+		lso->seqno_offset = htonl(0);
+		lso->len = htonl(skb->len);
+		cpl = (void *)(lso + 1);
+		cntrl = TXPKT_CSUM_TYPE(v6 ? TX_CSUM_TCPIP6 : TX_CSUM_TCPIP) |
+			TXPKT_IPHDR_LEN(l3hdr_len) |
+			TXPKT_ETHHDR_LEN(eth_xtra_len);
+		q->tso++;
+		q->tx_cso += ssi->gso_segs;
+	} else {
+		int len;
+
+		len = is_eth_imm(skb) ? skb->len + sizeof(*cpl) : sizeof(*cpl);
+		wr->op_immdlen = htonl(FW_WR_OP(FW_ETH_TX_PKT_WR) |
+				       FW_WR_IMMDLEN(len));
+		cpl = (void *)(wr + 1);
+		if (skb->ip_summed == CHECKSUM_PARTIAL) {
+			cntrl = hwcsum(skb) | TXPKT_IPCSUM_DIS;
+			q->tx_cso++;
+		} else
+			cntrl = TXPKT_L4CSUM_DIS | TXPKT_IPCSUM_DIS;
+	}
+
+	if (vlan_tx_tag_present(skb)) {
+		q->vlan_ins++;
+		cntrl |= TXPKT_VLAN_VLD | TXPKT_VLAN(vlan_tx_tag_get(skb));
+	}
+
+	cpl->ctrl0 = htonl(TXPKT_OPCODE(CPL_TX_PKT_XT) |
+			   TXPKT_INTF(pi->tx_chan) | TXPKT_PF(0));
+	cpl->pack = htons(0);
+	cpl->len = htons(skb->len);
+	cpl->ctrl1 = cpu_to_be64(cntrl);
+
+	if (is_eth_imm(skb)) {
+		inline_tx_skb(skb, &q->q, cpl + 1);
+		dev_kfree_skb(skb);
+	} else {
+		int last_desc;
+
+		write_sgl(skb, &q->q, (struct ulptx_sgl *)(cpl + 1), end, 0,
+			  addr);
+		skb_orphan(skb);
+
+		last_desc = q->q.pidx + ndesc - 1;
+		if (last_desc >= q->q.size)
+			last_desc -= q->q.size;
+		q->q.sdesc[last_desc].skb = skb;
+		q->q.sdesc[last_desc].sgl = (struct ulptx_sgl *)(cpl + 1);
+	}
+
+	txq_advance(&q->q, ndesc);
+
+	ring_tx_db(adap, &q->q, ndesc);
+	return NETDEV_TX_OK;
+}
+
+/**
+ *	reclaim_completed_tx_imm - reclaim completed control-queue Tx descs
+ *	@q: the SGE control Tx queue
+ *
+ *	This is a variant of reclaim_completed_tx() that is used for Tx queues
+ *	that send only immediate data (presently just the control queues) and
+ *	thus do not have any sk_buffs to release.
+ */
+static inline void reclaim_completed_tx_imm(struct sge_txq *q)
+{
+	int hw_cidx = ntohs(q->stat->cidx);
+	int reclaim = hw_cidx - q->cidx;
+
+	if (reclaim < 0)
+		reclaim += q->size;
+
+	q->in_use -= reclaim;
+	q->cidx = hw_cidx;
+}
+
+/**
+ *	is_imm - check whether a packet can be sent as immediate data
+ *	@skb: the packet
+ *
+ *	Returns true if a packet can be sent as a WR with immediate data.
+ */
+static inline int is_imm(const struct sk_buff *skb)
+{
+	return skb->len <= MAX_CTRL_WR_LEN;
+}
+
+/**
+ *	ctrlq_check_stop - check if a control queue is full and should stop
+ *	@q: the queue
+ *	@wr: most recent WR written to the queue
+ *
+ *	Check if a control queue has become full and should be stopped.
+ *	We clean up control queue descriptors very lazily, only when we are out.
+ *	If the queue is still full after reclaiming any completed descriptors
+ *	we suspend it and have the last WR wake it up.
+ */
+static void ctrlq_check_stop(struct sge_ctrl_txq *q, struct fw_wr_hdr *wr)
+{
+	reclaim_completed_tx_imm(&q->q);
+	if (unlikely(txq_avail(&q->q) < TXQ_STOP_THRES)) {
+		wr->lo |= htonl(FW_WR_EQUEQ | FW_WR_EQUIQ);
+		q->q.stops++;
+		q->full = 1;
+	}
+}
+
+/**
+ *	ctrl_xmit - send a packet through an SGE control Tx queue
+ *	@q: the control queue
+ *	@skb: the packet
+ *
+ *	Send a packet through an SGE control Tx queue.  Packets sent through
+ *	a control queue must fit entirely as immediate data.
+ */
+static int ctrl_xmit(struct sge_ctrl_txq *q, struct sk_buff *skb)
+{
+	unsigned int ndesc;
+	struct fw_wr_hdr *wr;
+
+	if (unlikely(!is_imm(skb))) {
+		WARN_ON(1);
+		dev_kfree_skb(skb);
+		return NET_XMIT_DROP;
+	}
+
+	ndesc = DIV_ROUND_UP(skb->len, sizeof(struct tx_desc));
+	spin_lock(&q->sendq.lock);
+
+	if (unlikely(q->full)) {
+		skb->priority = ndesc;                  /* save for restart */
+		__skb_queue_tail(&q->sendq, skb);
+		spin_unlock(&q->sendq.lock);
+		return NET_XMIT_CN;
+	}
+
+	wr = (struct fw_wr_hdr *)&q->q.desc[q->q.pidx];
+	inline_tx_skb(skb, &q->q, wr);
+
+	txq_advance(&q->q, ndesc);
+	if (unlikely(txq_avail(&q->q) < TXQ_STOP_THRES))
+		ctrlq_check_stop(q, wr);
+
+	ring_tx_db(q->adap, &q->q, ndesc);
+	spin_unlock(&q->sendq.lock);
+
+	kfree_skb(skb);
+	return NET_XMIT_SUCCESS;
+}
+
+/**
+ *	restart_ctrlq - restart a suspended control queue
+ *	@data: the control queue to restart
+ *
+ *	Resumes transmission on a suspended Tx control queue.
+ */
+static void restart_ctrlq(unsigned long data)
+{
+	struct sk_buff *skb;
+	unsigned int written = 0;
+	struct sge_ctrl_txq *q = (struct sge_ctrl_txq *)data;
+
+	spin_lock(&q->sendq.lock);
+	reclaim_completed_tx_imm(&q->q);
+	BUG_ON(txq_avail(&q->q) < TXQ_STOP_THRES);  /* q should be empty */
+
+	while ((skb = __skb_dequeue(&q->sendq)) != NULL) {
+		struct fw_wr_hdr *wr;
+		unsigned int ndesc = skb->priority;     /* previously saved */
+
+		/*
+		 * Write descriptors and free skbs outside the lock to limit
+		 * wait times.  q->full is still set so new skbs will be queued.
+		 */
+		spin_unlock(&q->sendq.lock);
+
+		wr = (struct fw_wr_hdr *)&q->q.desc[q->q.pidx];
+		inline_tx_skb(skb, &q->q, wr);
+		kfree_skb(skb);
+
+		written += ndesc;
+		txq_advance(&q->q, ndesc);
+		if (unlikely(txq_avail(&q->q) < TXQ_STOP_THRES)) {
+			unsigned long old = q->q.stops;
+
+			ctrlq_check_stop(q, wr);
+			if (q->q.stops != old) {          /* suspended anew */
+				spin_lock(&q->sendq.lock);
+				goto ringdb;
+			}
+		}
+		if (written > 16) {
+			ring_tx_db(q->adap, &q->q, written);
+			written = 0;
+		}
+		spin_lock(&q->sendq.lock);
+	}
+	q->full = 0;
+ringdb: if (written)
+		ring_tx_db(q->adap, &q->q, written);
+	spin_unlock(&q->sendq.lock);
+}
+
+/**
+ *	t4_mgmt_tx - send a management message
+ *	@adap: the adapter
+ *	@skb: the packet containing the management message
+ *
+ *	Send a management message through control queue 0.
+ */
+int t4_mgmt_tx(struct adapter *adap, struct sk_buff *skb)
+{
+	int ret;
+
+	local_bh_disable();
+	ret = ctrl_xmit(&adap->sge.ctrlq[0], skb);
+	local_bh_enable();
+	return ret;
+}
+
+/**
+ *	is_ofld_imm - check whether a packet can be sent as immediate data
+ *	@skb: the packet
+ *
+ *	Returns true if a packet can be sent as an offload WR with immediate
+ *	data.  We currently use the same limit as for Ethernet packets.
+ */
+static inline int is_ofld_imm(const struct sk_buff *skb)
+{
+	return skb->len <= MAX_IMM_TX_PKT_LEN;
+}
+
+/**
+ *	calc_tx_flits_ofld - calculate # of flits for an offload packet
+ *	@skb: the packet
+ *
+ *	Returns the number of flits needed for the given offload packet.
+ *	These packets are already fully constructed and no additional headers
+ *	will be added.
+ */
+static inline unsigned int calc_tx_flits_ofld(const struct sk_buff *skb)
+{
+	unsigned int flits, cnt;
+
+	if (is_ofld_imm(skb))
+		return DIV_ROUND_UP(skb->len, 8);
+
+	flits = skb_transport_offset(skb) / 8U;   /* headers */
+	cnt = skb_shinfo(skb)->nr_frags;
+	if (skb->tail != skb->transport_header)
+		cnt++;
+	return flits + sgl_len(cnt);
+}
+
+/**
+ *	txq_stop_maperr - stop a Tx queue due to I/O MMU exhaustion
+ *	@adap: the adapter
+ *	@q: the queue to stop
+ *
+ *	Mark a Tx queue stopped due to I/O MMU exhaustion and resulting
+ *	inability to map packets.  A periodic timer attempts to restart
+ *	queues so marked.
+ */
+static void txq_stop_maperr(struct sge_ofld_txq *q)
+{
+	q->mapping_err++;
+	q->q.stops++;
+	set_bit(q->q.cntxt_id, q->adap->sge.txq_maperr);
+}
+
+/**
+ *	ofldtxq_stop - stop an offload Tx queue that has become full
+ *	@q: the queue to stop
+ *	@skb: the packet causing the queue to become full
+ *
+ *	Stops an offload Tx queue that has become full and modifies the packet
+ *	being written to request a wakeup.
+ */
+static void ofldtxq_stop(struct sge_ofld_txq *q, struct sk_buff *skb)
+{
+	struct fw_wr_hdr *wr = (struct fw_wr_hdr *)skb->data;
+
+	wr->lo |= htonl(FW_WR_EQUEQ | FW_WR_EQUIQ);
+	q->q.stops++;
+	q->full = 1;
+}
+
+/**
+ *	service_ofldq - restart a suspended offload queue
+ *	@q: the offload queue
+ *
+ *	Services an offload Tx queue by moving packets from its packet queue
+ *	to the HW Tx ring.  The function starts and ends with the queue locked.
+ */
+static void service_ofldq(struct sge_ofld_txq *q)
+{
+	u64 *pos;
+	int credits;
+	struct sk_buff *skb;
+	unsigned int written = 0;
+	unsigned int flits, ndesc;
+
+	while ((skb = skb_peek(&q->sendq)) != NULL && !q->full) {
+		/*
+		 * We drop the lock but leave skb on sendq, thus retaining
+		 * exclusive access to the state of the queue.
+		 */
+		spin_unlock(&q->sendq.lock);
+
+		reclaim_completed_tx(q->adap, &q->q, false);
+
+		flits = skb->priority;                /* previously saved */
+		ndesc = flits_to_desc(flits);
+		credits = txq_avail(&q->q) - ndesc;
+		BUG_ON(credits < 0);
+		if (unlikely(credits < TXQ_STOP_THRES))
+			ofldtxq_stop(q, skb);
+
+		pos = (u64 *)&q->q.desc[q->q.pidx];
+		if (is_ofld_imm(skb))
+			inline_tx_skb(skb, &q->q, pos);
+		else if (map_skb(q->adap->pdev_dev, skb,
+				 (dma_addr_t *)skb->head)) {
+			txq_stop_maperr(q);
+			spin_lock(&q->sendq.lock);
+			break;
+		} else {
+			int last_desc, hdr_len = skb_transport_offset(skb);
+
+			memcpy(pos, skb->data, hdr_len);
+			write_sgl(skb, &q->q, (void *)pos + hdr_len,
+				  pos + flits, hdr_len,
+				  (dma_addr_t *)skb->head);
+#ifdef CONFIG_NEED_DMA_MAP_STATE
+			skb->dev = q->adap->port[0];
+			skb->destructor = deferred_unmap_destructor;
+#endif
+			last_desc = q->q.pidx + ndesc - 1;
+			if (last_desc >= q->q.size)
+				last_desc -= q->q.size;
+			q->q.sdesc[last_desc].skb = skb;
+		}
+
+		txq_advance(&q->q, ndesc);
+		written += ndesc;
+		if (unlikely(written > 32)) {
+			ring_tx_db(q->adap, &q->q, written);
+			written = 0;
+		}
+
+		spin_lock(&q->sendq.lock);
+		__skb_unlink(skb, &q->sendq);
+		if (is_ofld_imm(skb))
+			kfree_skb(skb);
+	}
+	if (likely(written))
+		ring_tx_db(q->adap, &q->q, written);
+}
+
+/**
+ *	ofld_xmit - send a packet through an offload queue
+ *	@q: the Tx offload queue
+ *	@skb: the packet
+ *
+ *	Send an offload packet through an SGE offload queue.
+ */
+static int ofld_xmit(struct sge_ofld_txq *q, struct sk_buff *skb)
+{
+	skb->priority = calc_tx_flits_ofld(skb);       /* save for restart */
+	spin_lock(&q->sendq.lock);
+	__skb_queue_tail(&q->sendq, skb);
+	if (q->sendq.qlen == 1)
+		service_ofldq(q);
+	spin_unlock(&q->sendq.lock);
+	return NET_XMIT_SUCCESS;
+}
+
+/**
+ *	restart_ofldq - restart a suspended offload queue
+ *	@data: the offload queue to restart
+ *
+ *	Resumes transmission on a suspended Tx offload queue.
+ */
+static void restart_ofldq(unsigned long data)
+{
+	struct sge_ofld_txq *q = (struct sge_ofld_txq *)data;
+
+	spin_lock(&q->sendq.lock);
+	q->full = 0;            /* the queue actually is completely empty now */
+	service_ofldq(q);
+	spin_unlock(&q->sendq.lock);
+}
+
+/**
+ *	skb_txq - return the Tx queue an offload packet should use
+ *	@skb: the packet
+ *
+ *	Returns the Tx queue an offload packet should use as indicated by bits
+ *	1-15 in the packet's queue_mapping.
+ */
+static inline unsigned int skb_txq(const struct sk_buff *skb)
+{
+	return skb->queue_mapping >> 1;
+}
+
+/**
+ *	is_ctrl_pkt - return whether an offload packet is a control packet
+ *	@skb: the packet
+ *
+ *	Returns whether an offload packet should use an OFLD or a CTRL
+ *	Tx queue as indicated by bit 0 in the packet's queue_mapping.
+ */
+static inline unsigned int is_ctrl_pkt(const struct sk_buff *skb)
+{
+	return skb->queue_mapping & 1;
+}
+
+static inline int ofld_send(struct adapter *adap, struct sk_buff *skb)
+{
+	unsigned int idx = skb_txq(skb);
+
+	if (unlikely(is_ctrl_pkt(skb)))
+		return ctrl_xmit(&adap->sge.ctrlq[idx], skb);
+	return ofld_xmit(&adap->sge.ofldtxq[idx], skb);
+}
+
+/**
+ *	t4_ofld_send - send an offload packet
+ *	@adap: the adapter
+ *	@skb: the packet
+ *
+ *	Sends an offload packet.  We use the packet queue_mapping to select the
+ *	appropriate Tx queue as follows: bit 0 indicates whether the packet
+ *	should be sent as regular or control, bits 1-15 select the queue.
+ */
+int t4_ofld_send(struct adapter *adap, struct sk_buff *skb)
+{
+	int ret;
+
+	local_bh_disable();
+	ret = ofld_send(adap, skb);
+	local_bh_enable();
+	return ret;
+}
+
+/**
+ *	cxgb4_ofld_send - send an offload packet
+ *	@dev: the net device
+ *	@skb: the packet
+ *
+ *	Sends an offload packet.  This is an exported version of @t4_ofld_send,
+ *	intended for ULDs.
+ */
+int cxgb4_ofld_send(struct net_device *dev, struct sk_buff *skb)
+{
+	return t4_ofld_send(netdev2adap(dev), skb);
+}
+EXPORT_SYMBOL(cxgb4_ofld_send);
+
+static inline void copy_frags(struct skb_shared_info *ssi,
+			      const struct pkt_gl *gl, unsigned int offset)
+{
+	unsigned int n;
+
+	/* usually there's just one frag */
+	ssi->frags[0].page = gl->frags[0].page;
+	ssi->frags[0].page_offset = gl->frags[0].page_offset + offset;
+	ssi->frags[0].size = gl->frags[0].size - offset;
+	ssi->nr_frags = gl->nfrags;
+	n = gl->nfrags - 1;
+	if (n)
+		memcpy(&ssi->frags[1], &gl->frags[1], n * sizeof(skb_frag_t));
+
+	/* get a reference to the last page, we don't own it */
+	get_page(gl->frags[n].page);
+}
+
+/**
+ *	cxgb4_pktgl_to_skb - build an sk_buff from a packet gather list
+ *	@gl: the gather list
+ *	@skb_len: size of sk_buff main body if it carries fragments
+ *	@pull_len: amount of data to move to the sk_buff's main body
+ *
+ *	Builds an sk_buff from the given packet gather list.  Returns the
+ *	sk_buff or %NULL if sk_buff allocation failed.
+ */
+struct sk_buff *cxgb4_pktgl_to_skb(const struct pkt_gl *gl,
+				   unsigned int skb_len, unsigned int pull_len)
+{
+	struct sk_buff *skb;
+
+	/*
+	 * Below we rely on RX_COPY_THRES being less than the smallest Rx buffer
+	 * size, which is expected since buffers are at least PAGE_SIZEd.
+	 * In this case packets up to RX_COPY_THRES have only one fragment.
+	 */
+	if (gl->tot_len <= RX_COPY_THRES) {
+		skb = dev_alloc_skb(gl->tot_len);
+		if (unlikely(!skb))
+			goto out;
+		__skb_put(skb, gl->tot_len);
+		skb_copy_to_linear_data(skb, gl->va, gl->tot_len);
+	} else {
+		skb = dev_alloc_skb(skb_len);
+		if (unlikely(!skb))
+			goto out;
+		__skb_put(skb, pull_len);
+		skb_copy_to_linear_data(skb, gl->va, pull_len);
+
+		copy_frags(skb_shinfo(skb), gl, pull_len);
+		skb->len = gl->tot_len;
+		skb->data_len = skb->len - pull_len;
+		skb->truesize += skb->data_len;
+	}
+out:	return skb;
+}
+EXPORT_SYMBOL(cxgb4_pktgl_to_skb);
+
+/**
+ *	t4_pktgl_free - free a packet gather list
+ *	@gl: the gather list
+ *
+ *	Releases the pages of a packet gather list.  We do not own the last
+ *	page on the list and do not free it.
+ */
+void t4_pktgl_free(const struct pkt_gl *gl)
+{
+	int n;
+	const skb_frag_t *p;
+
+	for (p = gl->frags, n = gl->nfrags - 1; n--; p++)
+		put_page(p->page);
+}
+
+/*
+ * Process an MPS trace packet.  Give it an unused protocol number so it won't
+ * be delivered to anyone and send it to the stack for capture.
+ */
+static noinline int handle_trace_pkt(struct adapter *adap,
+				     const struct pkt_gl *gl)
+{
+	struct sk_buff *skb;
+	struct cpl_trace_pkt *p;
+
+	skb = cxgb4_pktgl_to_skb(gl, RX_PULL_LEN, RX_PULL_LEN);
+	if (unlikely(!skb)) {
+		t4_pktgl_free(gl);
+		return 0;
+	}
+
+	p = (struct cpl_trace_pkt *)skb->data;
+	__skb_pull(skb, sizeof(*p));
+	skb_reset_mac_header(skb);
+	skb->protocol = htons(0xffff);
+	skb->dev = adap->port[0];
+	netif_receive_skb(skb);
+	return 0;
+}
+
+static void do_gro(struct sge_eth_rxq *rxq, const struct pkt_gl *gl,
+		   const struct cpl_rx_pkt *pkt)
+{
+	int ret;
+	struct sk_buff *skb;
+
+	skb = napi_get_frags(&rxq->rspq.napi);
+	if (unlikely(!skb)) {
+		t4_pktgl_free(gl);
+		rxq->stats.rx_drops++;
+		return;
+	}
+
+	copy_frags(skb_shinfo(skb), gl, RX_PKT_PAD);
+	skb->len = gl->tot_len - RX_PKT_PAD;
+	skb->data_len = skb->len;
+	skb->truesize += skb->data_len;
+	skb->ip_summed = CHECKSUM_UNNECESSARY;
+	skb_record_rx_queue(skb, rxq->rspq.idx);
+
+	if (unlikely(pkt->vlan_ex)) {
+		struct port_info *pi = netdev_priv(rxq->rspq.netdev);
+		struct vlan_group *grp = pi->vlan_grp;
+
+		rxq->stats.vlan_ex++;
+		if (likely(grp)) {
+			ret = vlan_gro_frags(&rxq->rspq.napi, grp,
+					     ntohs(pkt->vlan));
+			goto stats;
+		}
+	}
+	ret = napi_gro_frags(&rxq->rspq.napi);
+stats:	if (ret == GRO_HELD)
+		rxq->stats.lro_pkts++;
+	else if (ret == GRO_MERGED || ret == GRO_MERGED_FREE)
+		rxq->stats.lro_merged++;
+	rxq->stats.pkts++;
+	rxq->stats.rx_cso++;
+}
+
+/**
+ *	t4_ethrx_handler - process an ingress ethernet packet
+ *	@q: the response queue that received the packet
+ *	@rsp: the response queue descriptor holding the RX_PKT message
+ *	@si: the gather list of packet fragments
+ *
+ *	Process an ingress ethernet packet and deliver it to the stack.
+ */
+int t4_ethrx_handler(struct sge_rspq *q, const __be64 *rsp,
+		     const struct pkt_gl *si)
+{
+	bool csum_ok;
+	struct sk_buff *skb;
+	struct port_info *pi;
+	const struct cpl_rx_pkt *pkt;
+	struct sge_eth_rxq *rxq = container_of(q, struct sge_eth_rxq, rspq);
+
+	if (unlikely(*(u8 *)rsp == CPL_TRACE_PKT))
+		return handle_trace_pkt(q->adap, si);
+
+	pkt = (void *)&rsp[1];
+	csum_ok = pkt->csum_calc && !pkt->err_vec;
+	if ((pkt->l2info & htonl(RXF_TCP)) &&
+	    (q->netdev->features & NETIF_F_GRO) && csum_ok && !pkt->ip_frag) {
+		do_gro(rxq, si, pkt);
+		return 0;
+	}
+
+	skb = cxgb4_pktgl_to_skb(si, RX_PKT_SKB_LEN, RX_PULL_LEN);
+	if (unlikely(!skb)) {
+		t4_pktgl_free(si);
+		rxq->stats.rx_drops++;
+		return 0;
+	}
+
+	__skb_pull(skb, RX_PKT_PAD);      /* remove ethernet header padding */
+	skb->protocol = eth_type_trans(skb, q->netdev);
+	skb_record_rx_queue(skb, q->idx);
+	pi = netdev_priv(skb->dev);
+	rxq->stats.pkts++;
+
+	if (csum_ok && (pi->rx_offload & RX_CSO) &&
+	    (pkt->l2info & htonl(RXF_UDP | RXF_TCP))) {
+		if (!pkt->ip_frag)
+			skb->ip_summed = CHECKSUM_UNNECESSARY;
+		else {
+			__sum16 c = (__force __sum16)pkt->csum;
+			skb->csum = csum_unfold(c);
+			skb->ip_summed = CHECKSUM_COMPLETE;
+		}
+		rxq->stats.rx_cso++;
+	} else
+		skb->ip_summed = CHECKSUM_NONE;
+
+	if (unlikely(pkt->vlan_ex)) {
+		struct vlan_group *grp = pi->vlan_grp;
+
+		rxq->stats.vlan_ex++;
+		if (likely(grp))
+			vlan_hwaccel_receive_skb(skb, grp, ntohs(pkt->vlan));
+		else
+			dev_kfree_skb_any(skb);
+	} else
+		netif_receive_skb(skb);
+
+	return 0;
+}
+
+/**
+ *	restore_rx_bufs - put back a packet's Rx buffers
+ *	@si: the packet gather list
+ *	@q: the SGE free list
+ *	@frags: number of FL buffers to restore
+ *
+ *	Puts back on an FL the Rx buffers associated with @si.  The buffers
+ *	have already been unmapped and are left unmapped, we mark them so to
+ *	prevent further unmapping attempts.
+ *
+ *	This function undoes a series of @unmap_rx_buf calls when we find out
+ *	that the current packet can't be processed right away afterall and we
+ *	need to come back to it later.  This is a very rare event and there's
+ *	no effort to make this particularly efficient.
+ */
+static void restore_rx_bufs(const struct pkt_gl *si, struct sge_fl *q,
+			    int frags)
+{
+	struct rx_sw_desc *d;
+
+	while (frags--) {
+		if (q->cidx == 0)
+			q->cidx = q->size - 1;
+		else
+			q->cidx--;
+		d = &q->sdesc[q->cidx];
+		d->page = si->frags[frags].page;
+		d->dma_addr |= RX_UNMAPPED_BUF;
+		q->avail++;
+	}
+}
+
+/**
+ *	is_new_response - check if a response is newly written
+ *	@r: the response descriptor
+ *	@q: the response queue
+ *
+ *	Returns true if a response descriptor contains a yet unprocessed
+ *	response.
+ */
+static inline bool is_new_response(const struct rsp_ctrl *r,
+				   const struct sge_rspq *q)
+{
+	return RSPD_GEN(r->type_gen) == q->gen;
+}
+
+/**
+ *	rspq_next - advance to the next entry in a response queue
+ *	@q: the queue
+ *
+ *	Updates the state of a response queue to advance it to the next entry.
+ */
+static inline void rspq_next(struct sge_rspq *q)
+{
+	q->cur_desc = (void *)q->cur_desc + q->iqe_len;
+	if (unlikely(++q->cidx == q->size)) {
+		q->cidx = 0;
+		q->gen ^= 1;
+		q->cur_desc = q->desc;
+	}
+}
+
+/**
+ *	process_responses - process responses from an SGE response queue
+ *	@q: the ingress queue to process
+ *	@budget: how many responses can be processed in this round
+ *
+ *	Process responses from an SGE response queue up to the supplied budget.
+ *	Responses include received packets as well as control messages from FW
+ *	or HW.
+ *
+ *	Additionally choose the interrupt holdoff time for the next interrupt
+ *	on this queue.  If the system is under memory shortage use a fairly
+ *	long delay to help recovery.
+ */
+static int process_responses(struct sge_rspq *q, int budget)
+{
+	int ret, rsp_type;
+	int budget_left = budget;
+	const struct rsp_ctrl *rc;
+	struct sge_eth_rxq *rxq = container_of(q, struct sge_eth_rxq, rspq);
+
+	while (likely(budget_left)) {
+		rc = (void *)q->cur_desc + (q->iqe_len - sizeof(*rc));
+		if (!is_new_response(rc, q))
+			break;
+
+		rmb();
+		rsp_type = RSPD_TYPE(rc->type_gen);
+		if (likely(rsp_type == RSP_TYPE_FLBUF)) {
+			skb_frag_t *fp;
+			struct pkt_gl si;
+			const struct rx_sw_desc *rsd;
+			u32 len = ntohl(rc->pldbuflen_qid), bufsz, frags;
+
+			if (len & RSPD_NEWBUF) {
+				if (likely(q->offset > 0)) {
+					free_rx_bufs(q->adap, &rxq->fl, 1);
+					q->offset = 0;
+				}
+				len &= RSPD_LEN;
+			}
+			si.tot_len = len;
+
+			/* gather packet fragments */
+			for (frags = 0, fp = si.frags; ; frags++, fp++) {
+				rsd = &rxq->fl.sdesc[rxq->fl.cidx];
+				bufsz = get_buf_size(rsd);
+				fp->page = rsd->page;
+				fp->page_offset = q->offset;
+				fp->size = min(bufsz, len);
+				len -= fp->size;
+				if (!len)
+					break;
+				unmap_rx_buf(q->adap, &rxq->fl);
+			}
+
+			/*
+			 * Last buffer remains mapped so explicitly make it
+			 * coherent for CPU access.
+			 */
+			dma_sync_single_for_cpu(q->adap->pdev_dev,
+						get_buf_addr(rsd),
+						fp->size, DMA_FROM_DEVICE);
+
+			si.va = page_address(si.frags[0].page) +
+				si.frags[0].page_offset;
+			prefetch(si.va);
+
+			si.nfrags = frags + 1;
+			ret = q->handler(q, q->cur_desc, &si);
+			if (likely(ret == 0))
+				q->offset += ALIGN(fp->size, FL_ALIGN);
+			else
+				restore_rx_bufs(&si, &rxq->fl, frags);
+		} else if (likely(rsp_type == RSP_TYPE_CPL)) {
+			ret = q->handler(q, q->cur_desc, NULL);
+		} else {
+			ret = q->handler(q, (const __be64 *)rc, CXGB4_MSG_AN);
+		}
+
+		if (unlikely(ret)) {
+			/* couldn't process descriptor, back off for recovery */
+			q->next_intr_params = QINTR_TIMER_IDX(NOMEM_TMR_IDX);
+			break;
+		}
+
+		rspq_next(q);
+		budget_left--;
+	}
+
+	if (q->offset >= 0 && rxq->fl.size - rxq->fl.avail >= 16)
+		__refill_fl(q->adap, &rxq->fl);
+	return budget - budget_left;
+}
+
+/**
+ *	napi_rx_handler - the NAPI handler for Rx processing
+ *	@napi: the napi instance
+ *	@budget: how many packets we can process in this round
+ *
+ *	Handler for new data events when using NAPI.  This does not need any
+ *	locking or protection from interrupts as data interrupts are off at
+ *	this point and other adapter interrupts do not interfere (the latter
+ *	in not a concern at all with MSI-X as non-data interrupts then have
+ *	a separate handler).
+ */
+static int napi_rx_handler(struct napi_struct *napi, int budget)
+{
+	unsigned int params;
+	struct sge_rspq *q = container_of(napi, struct sge_rspq, napi);
+	int work_done = process_responses(q, budget);
+
+	if (likely(work_done < budget)) {
+		napi_complete(napi);
+		params = q->next_intr_params;
+		q->next_intr_params = q->intr_params;
+	} else
+		params = QINTR_TIMER_IDX(7);
+
+	t4_write_reg(q->adap, MYPF_REG(SGE_PF_GTS), CIDXINC(work_done) |
+		     INGRESSQID((u32)q->cntxt_id) | SEINTARM(params));
+	return work_done;
+}
+
+/*
+ * The MSI-X interrupt handler for an SGE response queue.
+ */
+irqreturn_t t4_sge_intr_msix(int irq, void *cookie)
+{
+	struct sge_rspq *q = cookie;
+
+	napi_schedule(&q->napi);
+	return IRQ_HANDLED;
+}
+
+/*
+ * Process the indirect interrupt entries in the interrupt queue and kick off
+ * NAPI for each queue that has generated an entry.
+ */
+static unsigned int process_intrq(struct adapter *adap)
+{
+	unsigned int credits;
+	const struct rsp_ctrl *rc;
+	struct sge_rspq *q = &adap->sge.intrq;
+
+	spin_lock(&adap->sge.intrq_lock);
+	for (credits = 0; ; credits++) {
+		rc = (void *)q->cur_desc + (q->iqe_len - sizeof(*rc));
+		if (!is_new_response(rc, q))
+			break;
+
+		rmb();
+		if (RSPD_TYPE(rc->type_gen) == RSP_TYPE_INTR) {
+			unsigned int qid = ntohl(rc->pldbuflen_qid);
+
+			napi_schedule(&adap->sge.ingr_map[qid]->napi);
+		}
+
+		rspq_next(q);
+	}
+
+	t4_write_reg(adap, MYPF_REG(SGE_PF_GTS), CIDXINC(credits) |
+		     INGRESSQID(q->cntxt_id) | SEINTARM(q->intr_params));
+	spin_unlock(&adap->sge.intrq_lock);
+	return credits;
+}
+
+/*
+ * The MSI interrupt handler, which handles data events from SGE response queues
+ * as well as error and other async events as they all use the same MSI vector.
+ */
+static irqreturn_t t4_intr_msi(int irq, void *cookie)
+{
+	struct adapter *adap = cookie;
+
+	t4_slow_intr_handler(adap);
+	process_intrq(adap);
+	return IRQ_HANDLED;
+}
+
+/*
+ * Interrupt handler for legacy INTx interrupts.
+ * Handles data events from SGE response queues as well as error and other
+ * async events as they all use the same interrupt line.
+ */
+static irqreturn_t t4_intr_intx(int irq, void *cookie)
+{
+	struct adapter *adap = cookie;
+
+	t4_write_reg(adap, MYPF_REG(PCIE_PF_CLI), 0);
+	if (t4_slow_intr_handler(adap) | process_intrq(adap))
+		return IRQ_HANDLED;
+	return IRQ_NONE;             /* probably shared interrupt */
+}
+
+/**
+ *	t4_intr_handler - select the top-level interrupt handler
+ *	@adap: the adapter
+ *
+ *	Selects the top-level interrupt handler based on the type of interrupts
+ *	(MSI-X, MSI, or INTx).
+ */
+irq_handler_t t4_intr_handler(struct adapter *adap)
+{
+	if (adap->flags & USING_MSIX)
+		return t4_sge_intr_msix;
+	if (adap->flags & USING_MSI)
+		return t4_intr_msi;
+	return t4_intr_intx;
+}
+
+static void sge_rx_timer_cb(unsigned long data)
+{
+	unsigned long m;
+	unsigned int i, cnt[2];
+	struct adapter *adap = (struct adapter *)data;
+	struct sge *s = &adap->sge;
+
+	for (i = 0; i < ARRAY_SIZE(s->starving_fl); i++)
+		for (m = s->starving_fl[i]; m; m &= m - 1) {
+			struct sge_eth_rxq *rxq;
+			unsigned int id = __ffs(m) + i * BITS_PER_LONG;
+			struct sge_fl *fl = s->egr_map[id];
+
+			clear_bit(id, s->starving_fl);
+			smp_mb__after_clear_bit();
+
+			if (fl_starving(fl)) {
+				rxq = container_of(fl, struct sge_eth_rxq, fl);
+				if (napi_reschedule(&rxq->rspq.napi))
+					fl->starving++;
+				else
+					set_bit(id, s->starving_fl);
+			}
+		}
+
+	t4_write_reg(adap, SGE_DEBUG_INDEX, 13);
+	cnt[0] = t4_read_reg(adap, SGE_DEBUG_DATA_HIGH);
+	cnt[1] = t4_read_reg(adap, SGE_DEBUG_DATA_LOW);
+
+	for (i = 0; i < 2; i++)
+		if (cnt[i] >= s->starve_thres) {
+			if (s->idma_state[i] || cnt[i] == 0xffffffff)
+				continue;
+			s->idma_state[i] = 1;
+			t4_write_reg(adap, SGE_DEBUG_INDEX, 11);
+			m = t4_read_reg(adap, SGE_DEBUG_DATA_LOW) >> (i * 16);
+			dev_warn(adap->pdev_dev,
+				 "SGE idma%u starvation detected for "
+				 "queue %lu\n", i, m & 0xffff);
+		} else if (s->idma_state[i])
+			s->idma_state[i] = 0;
+
+	mod_timer(&s->rx_timer, jiffies + RX_QCHECK_PERIOD);
+}
+
+static void sge_tx_timer_cb(unsigned long data)
+{
+	unsigned long m;
+	unsigned int i, budget;
+	struct adapter *adap = (struct adapter *)data;
+	struct sge *s = &adap->sge;
+
+	for (i = 0; i < ARRAY_SIZE(s->txq_maperr); i++)
+		for (m = s->txq_maperr[i]; m; m &= m - 1) {
+			unsigned long id = __ffs(m) + i * BITS_PER_LONG;
+			struct sge_ofld_txq *txq = s->egr_map[id];
+
+			clear_bit(id, s->txq_maperr);
+			tasklet_schedule(&txq->qresume_tsk);
+		}
+
+	budget = MAX_TIMER_TX_RECLAIM;
+	i = s->ethtxq_rover;
+	do {
+		struct sge_eth_txq *q = &s->ethtxq[i];
+
+		if (q->q.in_use &&
+		    time_after_eq(jiffies, q->txq->trans_start + HZ / 100) &&
+		    __netif_tx_trylock(q->txq)) {
+			int avail = reclaimable(&q->q);
+
+			if (avail) {
+				if (avail > budget)
+					avail = budget;
+
+				free_tx_desc(adap, &q->q, avail, true);
+				q->q.in_use -= avail;
+				budget -= avail;
+			}
+			__netif_tx_unlock(q->txq);
+		}
+
+		if (++i >= s->ethqsets)
+			i = 0;
+	} while (budget && i != s->ethtxq_rover);
+	s->ethtxq_rover = i;
+	mod_timer(&s->tx_timer, jiffies + (budget ? TX_QCHECK_PERIOD : 2));
+}
+
+int t4_sge_alloc_rxq(struct adapter *adap, struct sge_rspq *iq, bool fwevtq,
+		     struct net_device *dev, int intr_idx,
+		     struct sge_fl *fl, rspq_handler_t hnd)
+{
+	int ret, flsz = 0;
+	struct fw_iq_cmd c;
+	struct port_info *pi = netdev_priv(dev);
+
+	/* Size needs to be multiple of 16, including status entry. */
+	iq->size = roundup(iq->size, 16);
+
+	iq->desc = alloc_ring(adap->pdev_dev, iq->size, iq->iqe_len, 0,
+			      &iq->phys_addr, NULL, 0);
+	if (!iq->desc)
+		return -ENOMEM;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_IQ_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_CMD_EXEC |
+			    FW_IQ_CMD_PFN(0) | FW_IQ_CMD_VFN(0));
+	c.alloc_to_len16 = htonl(FW_IQ_CMD_ALLOC | FW_IQ_CMD_IQSTART(1) |
+				 FW_LEN16(c));
+	c.type_to_iqandstindex = htonl(FW_IQ_CMD_TYPE(FW_IQ_TYPE_FL_INT_CAP) |
+		FW_IQ_CMD_IQASYNCH(fwevtq) | FW_IQ_CMD_VIID(pi->viid) |
+		FW_IQ_CMD_IQANDST(intr_idx < 0) | FW_IQ_CMD_IQANUD(1) |
+		FW_IQ_CMD_IQANDSTINDEX(intr_idx >= 0 ? intr_idx :
+							-intr_idx - 1));
+	c.iqdroprss_to_iqesize = htons(FW_IQ_CMD_IQPCIECH(pi->tx_chan) |
+		FW_IQ_CMD_IQGTSMODE |
+		FW_IQ_CMD_IQINTCNTTHRESH(iq->pktcnt_idx) |
+		FW_IQ_CMD_IQESIZE(ilog2(iq->iqe_len) - 4));
+	c.iqsize = htons(iq->size);
+	c.iqaddr = cpu_to_be64(iq->phys_addr);
+
+	if (fl) {
+		fl->size = roundup(fl->size, 8);
+		fl->desc = alloc_ring(adap->pdev_dev, fl->size, sizeof(__be64),
+				      sizeof(struct rx_sw_desc), &fl->addr,
+				      &fl->sdesc, STAT_LEN);
+		if (!fl->desc)
+			goto fl_nomem;
+
+		flsz = fl->size / 8 + STAT_LEN / sizeof(struct tx_desc);
+		c.iqns_to_fl0congen = htonl(FW_IQ_CMD_FL0PACKEN |
+					    FW_IQ_CMD_FL0PADEN);
+		c.fl0dcaen_to_fl0cidxfthresh = htons(FW_IQ_CMD_FL0FBMIN(2) |
+				FW_IQ_CMD_FL0FBMAX(3));
+		c.fl0size = htons(flsz);
+		c.fl0addr = cpu_to_be64(fl->addr);
+	}
+
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), &c);
+	if (ret)
+		goto err;
+
+	netif_napi_add(dev, &iq->napi, napi_rx_handler, 64);
+	iq->cur_desc = iq->desc;
+	iq->cidx = 0;
+	iq->gen = 1;
+	iq->next_intr_params = iq->intr_params;
+	iq->cntxt_id = ntohs(c.iqid);
+	iq->abs_id = ntohs(c.physiqid);
+	iq->size--;                           /* subtract status entry */
+	iq->adap = adap;
+	iq->netdev = dev;
+	iq->handler = hnd;
+
+	/* set offset to -1 to distinguish ingress queues without FL */
+	iq->offset = fl ? 0 : -1;
+
+	adap->sge.ingr_map[iq->cntxt_id] = iq;
+
+	if (fl) {
+		fl->cntxt_id = htons(c.fl0id);
+		fl->avail = fl->pend_cred = 0;
+		fl->pidx = fl->cidx = 0;
+		fl->alloc_failed = fl->large_alloc_failed = fl->starving = 0;
+		adap->sge.egr_map[fl->cntxt_id] = fl;
+		refill_fl(adap, fl, fl_cap(fl), GFP_KERNEL);
+	}
+	return 0;
+
+fl_nomem:
+	ret = -ENOMEM;
+err:
+	if (iq->desc) {
+		dma_free_coherent(adap->pdev_dev, iq->size * iq->iqe_len,
+				  iq->desc, iq->phys_addr);
+		iq->desc = NULL;
+	}
+	if (fl && fl->desc) {
+		kfree(fl->sdesc);
+		fl->sdesc = NULL;
+		dma_free_coherent(adap->pdev_dev, flsz * sizeof(struct tx_desc),
+				  fl->desc, fl->addr);
+		fl->desc = NULL;
+	}
+	return ret;
+}
+
+static void init_txq(struct adapter *adap, struct sge_txq *q, unsigned int id)
+{
+	q->in_use = 0;
+	q->cidx = q->pidx = 0;
+	q->stops = q->restarts = 0;
+	q->stat = (void *)&q->desc[q->size];
+	q->cntxt_id = id;
+	adap->sge.egr_map[id] = q;
+}
+
+int t4_sge_alloc_eth_txq(struct adapter *adap, struct sge_eth_txq *txq,
+			 struct net_device *dev, struct netdev_queue *netdevq,
+			 unsigned int iqid)
+{
+	int ret, nentries;
+	struct fw_eq_eth_cmd c;
+	struct port_info *pi = netdev_priv(dev);
+
+	/* Add status entries */
+	nentries = txq->q.size + STAT_LEN / sizeof(struct tx_desc);
+
+	txq->q.desc = alloc_ring(adap->pdev_dev, txq->q.size,
+			sizeof(struct tx_desc), sizeof(struct tx_sw_desc),
+			&txq->q.phys_addr, &txq->q.sdesc, STAT_LEN);
+	if (!txq->q.desc)
+		return -ENOMEM;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_ETH_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_CMD_EXEC |
+			    FW_EQ_ETH_CMD_PFN(0) | FW_EQ_ETH_CMD_VFN(0));
+	c.alloc_to_len16 = htonl(FW_EQ_ETH_CMD_ALLOC |
+				 FW_EQ_ETH_CMD_EQSTART | FW_LEN16(c));
+	c.viid_pkd = htonl(FW_EQ_ETH_CMD_VIID(pi->viid));
+	c.fetchszm_to_iqid = htonl(FW_EQ_ETH_CMD_HOSTFCMODE(2) |
+				   FW_EQ_ETH_CMD_PCIECHN(pi->tx_chan) |
+				   FW_EQ_ETH_CMD_IQID(iqid));
+	c.dcaen_to_eqsize = htonl(FW_EQ_ETH_CMD_FBMIN(2) |
+				  FW_EQ_ETH_CMD_FBMAX(3) |
+				  FW_EQ_ETH_CMD_CIDXFTHRESH(5) |
+				  FW_EQ_ETH_CMD_EQSIZE(nentries));
+	c.eqaddr = cpu_to_be64(txq->q.phys_addr);
+
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), &c);
+	if (ret) {
+		kfree(txq->q.sdesc);
+		txq->q.sdesc = NULL;
+		dma_free_coherent(adap->pdev_dev,
+				  nentries * sizeof(struct tx_desc),
+				  txq->q.desc, txq->q.phys_addr);
+		txq->q.desc = NULL;
+		return ret;
+	}
+
+	init_txq(adap, &txq->q, FW_EQ_ETH_CMD_EQID_GET(ntohl(c.eqid_pkd)));
+	txq->txq = netdevq;
+	txq->tso = txq->tx_cso = txq->vlan_ins = 0;
+	txq->mapping_err = 0;
+	return 0;
+}
+
+int t4_sge_alloc_ctrl_txq(struct adapter *adap, struct sge_ctrl_txq *txq,
+			  struct net_device *dev, unsigned int iqid,
+			  unsigned int cmplqid)
+{
+	int ret, nentries;
+	struct fw_eq_ctrl_cmd c;
+	struct port_info *pi = netdev_priv(dev);
+
+	/* Add status entries */
+	nentries = txq->q.size + STAT_LEN / sizeof(struct tx_desc);
+
+	txq->q.desc = alloc_ring(adap->pdev_dev, nentries,
+				 sizeof(struct tx_desc), 0, &txq->q.phys_addr,
+				 NULL, 0);
+	if (!txq->q.desc)
+		return -ENOMEM;
+
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_CTRL_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_CMD_EXEC |
+			    FW_EQ_CTRL_CMD_PFN(0) | FW_EQ_CTRL_CMD_VFN(0));
+	c.alloc_to_len16 = htonl(FW_EQ_CTRL_CMD_ALLOC |
+				 FW_EQ_CTRL_CMD_EQSTART | FW_LEN16(c));
+	c.cmpliqid_eqid = htonl(FW_EQ_CTRL_CMD_CMPLIQID(cmplqid));
+	c.physeqid_pkd = htonl(0);
+	c.fetchszm_to_iqid = htonl(FW_EQ_CTRL_CMD_HOSTFCMODE(2) |
+				   FW_EQ_CTRL_CMD_PCIECHN(pi->tx_chan) |
+				   FW_EQ_CTRL_CMD_IQID(iqid));
+	c.dcaen_to_eqsize = htonl(FW_EQ_CTRL_CMD_FBMIN(2) |
+				  FW_EQ_CTRL_CMD_FBMAX(3) |
+				  FW_EQ_CTRL_CMD_CIDXFTHRESH(5) |
+				  FW_EQ_CTRL_CMD_EQSIZE(nentries));
+	c.eqaddr = cpu_to_be64(txq->q.phys_addr);
+
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), &c);
+	if (ret) {
+		dma_free_coherent(adap->pdev_dev,
+				  nentries * sizeof(struct tx_desc),
+				  txq->q.desc, txq->q.phys_addr);
+		txq->q.desc = NULL;
+		return ret;
+	}
+
+	init_txq(adap, &txq->q, FW_EQ_CTRL_CMD_EQID_GET(ntohl(c.cmpliqid_eqid)));
+	txq->adap = adap;
+	skb_queue_head_init(&txq->sendq);
+	tasklet_init(&txq->qresume_tsk, restart_ctrlq, (unsigned long)txq);
+	txq->full = 0;
+	return 0;
+}
+
+int t4_sge_alloc_ofld_txq(struct adapter *adap, struct sge_ofld_txq *txq,
+			  struct net_device *dev, unsigned int iqid)
+{
+	int ret, nentries;
+	struct fw_eq_ofld_cmd c;
+	struct port_info *pi = netdev_priv(dev);
+
+	/* Add status entries */
+	nentries = txq->q.size + STAT_LEN / sizeof(struct tx_desc);
+
+	txq->q.desc = alloc_ring(adap->pdev_dev, txq->q.size,
+			sizeof(struct tx_desc), sizeof(struct tx_sw_desc),
+			&txq->q.phys_addr, &txq->q.sdesc, STAT_LEN);
+	if (!txq->q.desc)
+		return -ENOMEM;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_OFLD_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_CMD_EXEC |
+			    FW_EQ_OFLD_CMD_PFN(0) | FW_EQ_OFLD_CMD_VFN(0));
+	c.alloc_to_len16 = htonl(FW_EQ_OFLD_CMD_ALLOC |
+				 FW_EQ_OFLD_CMD_EQSTART | FW_LEN16(c));
+	c.fetchszm_to_iqid = htonl(FW_EQ_OFLD_CMD_HOSTFCMODE(2) |
+				   FW_EQ_OFLD_CMD_PCIECHN(pi->tx_chan) |
+				   FW_EQ_OFLD_CMD_IQID(iqid));
+	c.dcaen_to_eqsize = htonl(FW_EQ_OFLD_CMD_FBMIN(2) |
+				  FW_EQ_OFLD_CMD_FBMAX(3) |
+				  FW_EQ_OFLD_CMD_CIDXFTHRESH(5) |
+				  FW_EQ_OFLD_CMD_EQSIZE(nentries));
+	c.eqaddr = cpu_to_be64(txq->q.phys_addr);
+
+	ret = t4_wr_mbox(adap, 0, &c, sizeof(c), &c);
+	if (ret) {
+		kfree(txq->q.sdesc);
+		txq->q.sdesc = NULL;
+		dma_free_coherent(adap->pdev_dev,
+				  nentries * sizeof(struct tx_desc),
+				  txq->q.desc, txq->q.phys_addr);
+		txq->q.desc = NULL;
+		return ret;
+	}
+
+	init_txq(adap, &txq->q, FW_EQ_OFLD_CMD_EQID_GET(ntohl(c.eqid_pkd)));
+	txq->adap = adap;
+	skb_queue_head_init(&txq->sendq);
+	tasklet_init(&txq->qresume_tsk, restart_ofldq, (unsigned long)txq);
+	txq->full = 0;
+	txq->mapping_err = 0;
+	return 0;
+}
+
+static void free_txq(struct adapter *adap, struct sge_txq *q)
+{
+	dma_free_coherent(adap->pdev_dev,
+			  q->size * sizeof(struct tx_desc) + STAT_LEN,
+			  q->desc, q->phys_addr);
+	q->cntxt_id = 0;
+	q->sdesc = NULL;
+	q->desc = NULL;
+}
+
+static void free_rspq_fl(struct adapter *adap, struct sge_rspq *rq,
+			 struct sge_fl *fl)
+{
+	unsigned int fl_id = fl ? fl->cntxt_id : 0xffff;
+
+	adap->sge.ingr_map[rq->cntxt_id] = NULL;
+	t4_iq_free(adap, 0, 0, 0, FW_IQ_TYPE_FL_INT_CAP, rq->cntxt_id, fl_id,
+		   0xffff);
+	dma_free_coherent(adap->pdev_dev, (rq->size + 1) * rq->iqe_len,
+			  rq->desc, rq->phys_addr);
+	netif_napi_del(&rq->napi);
+	rq->netdev = NULL;
+	rq->cntxt_id = rq->abs_id = 0;
+	rq->desc = NULL;
+
+	if (fl) {
+		free_rx_bufs(adap, fl, fl->avail);
+		dma_free_coherent(adap->pdev_dev, fl->size * 8 + STAT_LEN,
+				  fl->desc, fl->addr);
+		kfree(fl->sdesc);
+		fl->sdesc = NULL;
+		fl->cntxt_id = 0;
+		fl->desc = NULL;
+	}
+}
+
+/**
+ *	t4_free_sge_resources - free SGE resources
+ *	@adap: the adapter
+ *
+ *	Frees resources used by the SGE queue sets.
+ */
+void t4_free_sge_resources(struct adapter *adap)
+{
+	int i;
+	struct sge_eth_rxq *eq = adap->sge.ethrxq;
+	struct sge_eth_txq *etq = adap->sge.ethtxq;
+	struct sge_ofld_rxq *oq = adap->sge.ofldrxq;
+
+	/* clean up Ethernet Tx/Rx queues */
+	for (i = 0; i < adap->sge.ethqsets; i++, eq++, etq++) {
+		if (eq->rspq.desc)
+			free_rspq_fl(adap, &eq->rspq, &eq->fl);
+		if (etq->q.desc) {
+			t4_eth_eq_free(adap, 0, 0, 0, etq->q.cntxt_id);
+			free_tx_desc(adap, &etq->q, etq->q.in_use, true);
+			kfree(etq->q.sdesc);
+			free_txq(adap, &etq->q);
+		}
+	}
+
+	/* clean up RDMA and iSCSI Rx queues */
+	for (i = 0; i < adap->sge.ofldqsets; i++, oq++) {
+		if (oq->rspq.desc)
+			free_rspq_fl(adap, &oq->rspq, &oq->fl);
+	}
+	for (i = 0, oq = adap->sge.rdmarxq; i < adap->sge.rdmaqs; i++, oq++) {
+		if (oq->rspq.desc)
+			free_rspq_fl(adap, &oq->rspq, &oq->fl);
+	}
+
+	/* clean up offload Tx queues */
+	for (i = 0; i < ARRAY_SIZE(adap->sge.ofldtxq); i++) {
+		struct sge_ofld_txq *q = &adap->sge.ofldtxq[i];
+
+		if (q->q.desc) {
+			tasklet_kill(&q->qresume_tsk);
+			t4_ofld_eq_free(adap, 0, 0, 0, q->q.cntxt_id);
+			free_tx_desc(adap, &q->q, q->q.in_use, false);
+			kfree(q->q.sdesc);
+			__skb_queue_purge(&q->sendq);
+			free_txq(adap, &q->q);
+		}
+	}
+
+	/* clean up control Tx queues */
+	for (i = 0; i < ARRAY_SIZE(adap->sge.ctrlq); i++) {
+		struct sge_ctrl_txq *cq = &adap->sge.ctrlq[i];
+
+		if (cq->q.desc) {
+			tasklet_kill(&cq->qresume_tsk);
+			t4_ctrl_eq_free(adap, 0, 0, 0, cq->q.cntxt_id);
+			__skb_queue_purge(&cq->sendq);
+			free_txq(adap, &cq->q);
+		}
+	}
+
+	if (adap->sge.fw_evtq.desc)
+		free_rspq_fl(adap, &adap->sge.fw_evtq, NULL);
+
+	if (adap->sge.intrq.desc)
+		free_rspq_fl(adap, &adap->sge.intrq, NULL);
+
+	/* clear the reverse egress queue map */
+	memset(adap->sge.egr_map, 0, sizeof(adap->sge.egr_map));
+}
+
+void t4_sge_start(struct adapter *adap)
+{
+	adap->sge.ethtxq_rover = 0;
+	mod_timer(&adap->sge.rx_timer, jiffies + RX_QCHECK_PERIOD);
+	mod_timer(&adap->sge.tx_timer, jiffies + TX_QCHECK_PERIOD);
+}
+
+/**
+ *	t4_sge_stop - disable SGE operation
+ *	@adap: the adapter
+ *
+ *	Stop tasklets and timers associated with the DMA engine.  Note that
+ *	this is effective only if measures have been taken to disable any HW
+ *	events that may restart them.
+ */
+void t4_sge_stop(struct adapter *adap)
+{
+	int i;
+	struct sge *s = &adap->sge;
+
+	if (in_interrupt())  /* actions below require waiting */
+		return;
+
+	if (s->rx_timer.function)
+		del_timer_sync(&s->rx_timer);
+	if (s->tx_timer.function)
+		del_timer_sync(&s->tx_timer);
+
+	for (i = 0; i < ARRAY_SIZE(s->ofldtxq); i++) {
+		struct sge_ofld_txq *q = &s->ofldtxq[i];
+
+		if (q->q.desc)
+			tasklet_kill(&q->qresume_tsk);
+	}
+	for (i = 0; i < ARRAY_SIZE(s->ctrlq); i++) {
+		struct sge_ctrl_txq *cq = &s->ctrlq[i];
+
+		if (cq->q.desc)
+			tasklet_kill(&cq->qresume_tsk);
+	}
+}
+
+/**
+ *	t4_sge_init - initialize SGE
+ *	@adap: the adapter
+ *
+ *	Performs SGE initialization needed every time after a chip reset.
+ *	We do not initialize any of the queues here, instead the driver
+ *	top-level must request them individually.
+ */
+void t4_sge_init(struct adapter *adap)
+{
+	struct sge *s = &adap->sge;
+	unsigned int fl_align_log = ilog2(FL_ALIGN);
+
+	t4_set_reg_field(adap, SGE_CONTROL, PKTSHIFT_MASK |
+			 INGPADBOUNDARY_MASK | EGRSTATUSPAGESIZE,
+			 INGPADBOUNDARY(fl_align_log - 5) | PKTSHIFT(2) |
+			 RXPKTCPLMODE |
+			 (STAT_LEN == 128 ? EGRSTATUSPAGESIZE : 0));
+	t4_set_reg_field(adap, SGE_HOST_PAGE_SIZE, HOSTPAGESIZEPF0_MASK,
+			 HOSTPAGESIZEPF0(PAGE_SHIFT - 10));
+	t4_write_reg(adap, SGE_FL_BUFFER_SIZE0, PAGE_SIZE);
+#if FL_PG_ORDER > 0
+	t4_write_reg(adap, SGE_FL_BUFFER_SIZE1, PAGE_SIZE << FL_PG_ORDER);
+#endif
+	t4_write_reg(adap, SGE_INGRESS_RX_THRESHOLD,
+		     THRESHOLD_0(s->counter_val[0]) |
+		     THRESHOLD_1(s->counter_val[1]) |
+		     THRESHOLD_2(s->counter_val[2]) |
+		     THRESHOLD_3(s->counter_val[3]));
+	t4_write_reg(adap, SGE_TIMER_VALUE_0_AND_1,
+		     TIMERVALUE0(us_to_core_ticks(adap, s->timer_val[0])) |
+		     TIMERVALUE1(us_to_core_ticks(adap, s->timer_val[1])));
+	t4_write_reg(adap, SGE_TIMER_VALUE_2_AND_3,
+		     TIMERVALUE0(us_to_core_ticks(adap, s->timer_val[2])) |
+		     TIMERVALUE1(us_to_core_ticks(adap, s->timer_val[3])));
+	t4_write_reg(adap, SGE_TIMER_VALUE_4_AND_5,
+		     TIMERVALUE0(us_to_core_ticks(adap, s->timer_val[4])) |
+		     TIMERVALUE1(us_to_core_ticks(adap, s->timer_val[5])));
+	setup_timer(&s->rx_timer, sge_rx_timer_cb, (unsigned long)adap);
+	setup_timer(&s->tx_timer, sge_tx_timer_cb, (unsigned long)adap);
+	s->starve_thres = core_ticks_per_usec(adap) * 1000000;  /* 1 s */
+	s->idma_state[0] = s->idma_state[1] = 0;
+	spin_lock_init(&s->intrq_lock);
+}
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/t4_hw.c linux-2.6.34-rc4/drivers/net/cxgb4/t4_hw.c
--- linux-2.6.34-rc3/drivers/net/cxgb4/t4_hw.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/t4_hw.c	2010-04-13 02:19:01.111633065 +0000
@@ -0,0 +1,3131 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#include <linux/init.h>
+#include <linux/delay.h>
+#include "cxgb4.h"
+#include "t4_regs.h"
+#include "t4fw_api.h"
+
+/**
+ *	t4_wait_op_done_val - wait until an operation is completed
+ *	@adapter: the adapter performing the operation
+ *	@reg: the register to check for completion
+ *	@mask: a single-bit field within @reg that indicates completion
+ *	@polarity: the value of the field when the operation is completed
+ *	@attempts: number of check iterations
+ *	@delay: delay in usecs between iterations
+ *	@valp: where to store the value of the register at completion time
+ *
+ *	Wait until an operation is completed by checking a bit in a register
+ *	up to @attempts times.  If @valp is not NULL the value of the register
+ *	at the time it indicated completion is stored there.  Returns 0 if the
+ *	operation completes and	-EAGAIN	otherwise.
+ */
+int t4_wait_op_done_val(struct adapter *adapter, int reg, u32 mask,
+			int polarity, int attempts, int delay, u32 *valp)
+{
+	while (1) {
+		u32 val = t4_read_reg(adapter, reg);
+
+		if (!!(val & mask) == polarity) {
+			if (valp)
+				*valp = val;
+			return 0;
+		}
+		if (--attempts == 0)
+			return -EAGAIN;
+		if (delay)
+			udelay(delay);
+	}
+}
+
+static inline int t4_wait_op_done(struct adapter *adapter, int reg, u32 mask,
+				  int polarity, int attempts, int delay)
+{
+	return t4_wait_op_done_val(adapter, reg, mask, polarity, attempts,
+				   delay, NULL);
+}
+
+/**
+ *	t4_set_reg_field - set a register field to a value
+ *	@adapter: the adapter to program
+ *	@addr: the register address
+ *	@mask: specifies the portion of the register to modify
+ *	@val: the new value for the register field
+ *
+ *	Sets a register field specified by the supplied mask to the
+ *	given value.
+ */
+void t4_set_reg_field(struct adapter *adapter, unsigned int addr, u32 mask,
+		      u32 val)
+{
+	u32 v = t4_read_reg(adapter, addr) & ~mask;
+
+	t4_write_reg(adapter, addr, v | val);
+	(void) t4_read_reg(adapter, addr);      /* flush */
+}
+
+/**
+ *	t4_read_indirect - read indirectly addressed registers
+ *	@adap: the adapter
+ *	@addr_reg: register holding the indirect address
+ *	@data_reg: register holding the value of the indirect register
+ *	@vals: where the read register values are stored
+ *	@nregs: how many indirect registers to read
+ *	@start_idx: index of first indirect register to read
+ *
+ *	Reads registers that are accessed indirectly through an address/data
+ *	register pair.
+ */
+void t4_read_indirect(struct adapter *adap, unsigned int addr_reg,
+		      unsigned int data_reg, u32 *vals, unsigned int nregs,
+		      unsigned int start_idx)
+{
+	while (nregs--) {
+		t4_write_reg(adap, addr_reg, start_idx);
+		*vals++ = t4_read_reg(adap, data_reg);
+		start_idx++;
+	}
+}
+
+/**
+ *	t4_write_indirect - write indirectly addressed registers
+ *	@adap: the adapter
+ *	@addr_reg: register holding the indirect addresses
+ *	@data_reg: register holding the value for the indirect registers
+ *	@vals: values to write
+ *	@nregs: how many indirect registers to write
+ *	@start_idx: address of first indirect register to write
+ *
+ *	Writes a sequential block of registers that are accessed indirectly
+ *	through an address/data register pair.
+ */
+void t4_write_indirect(struct adapter *adap, unsigned int addr_reg,
+		       unsigned int data_reg, const u32 *vals,
+		       unsigned int nregs, unsigned int start_idx)
+{
+	while (nregs--) {
+		t4_write_reg(adap, addr_reg, start_idx++);
+		t4_write_reg(adap, data_reg, *vals++);
+	}
+}
+
+/*
+ * Get the reply to a mailbox command and store it in @rpl in big-endian order.
+ */
+static void get_mbox_rpl(struct adapter *adap, __be64 *rpl, int nflit,
+			 u32 mbox_addr)
+{
+	for ( ; nflit; nflit--, mbox_addr += 8)
+		*rpl++ = cpu_to_be64(t4_read_reg64(adap, mbox_addr));
+}
+
+/*
+ * Handle a FW assertion reported in a mailbox.
+ */
+static void fw_asrt(struct adapter *adap, u32 mbox_addr)
+{
+	struct fw_debug_cmd asrt;
+
+	get_mbox_rpl(adap, (__be64 *)&asrt, sizeof(asrt) / 8, mbox_addr);
+	dev_alert(adap->pdev_dev,
+		  "FW assertion at %.16s:%u, val0 %#x, val1 %#x\n",
+		  asrt.u.assert.filename_0_7, ntohl(asrt.u.assert.line),
+		  ntohl(asrt.u.assert.x), ntohl(asrt.u.assert.y));
+}
+
+static void dump_mbox(struct adapter *adap, int mbox, u32 data_reg)
+{
+	dev_err(adap->pdev_dev,
+		"mbox %d: %llx %llx %llx %llx %llx %llx %llx %llx\n", mbox,
+		(unsigned long long)t4_read_reg64(adap, data_reg),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 8),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 16),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 24),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 32),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 40),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 48),
+		(unsigned long long)t4_read_reg64(adap, data_reg + 56));
+}
+
+/**
+ *	t4_wr_mbox_meat - send a command to FW through the given mailbox
+ *	@adap: the adapter
+ *	@mbox: index of the mailbox to use
+ *	@cmd: the command to write
+ *	@size: command length in bytes
+ *	@rpl: where to optionally store the reply
+ *	@sleep_ok: if true we may sleep while awaiting command completion
+ *
+ *	Sends the given command to FW through the selected mailbox and waits
+ *	for the FW to execute the command.  If @rpl is not %NULL it is used to
+ *	store the FW's reply to the command.  The command and its optional
+ *	reply are of the same length.  FW can take up to %FW_CMD_MAX_TIMEOUT ms
+ *	to respond.  @sleep_ok determines whether we may sleep while awaiting
+ *	the response.  If sleeping is allowed we use progressive backoff
+ *	otherwise we spin.
+ *
+ *	The return value is 0 on success or a negative errno on failure.  A
+ *	failure can happen either because we are not able to execute the
+ *	command or FW executes it but signals an error.  In the latter case
+ *	the return value is the error code indicated by FW (negated).
+ */
+int t4_wr_mbox_meat(struct adapter *adap, int mbox, const void *cmd, int size,
+		    void *rpl, bool sleep_ok)
+{
+	static int delay[] = {
+		1, 1, 3, 5, 10, 10, 20, 50, 100, 200
+	};
+
+	u32 v;
+	u64 res;
+	int i, ms, delay_idx;
+	const __be64 *p = cmd;
+	u32 data_reg = PF_REG(mbox, CIM_PF_MAILBOX_DATA);
+	u32 ctl_reg = PF_REG(mbox, CIM_PF_MAILBOX_CTRL);
+
+	if ((size & 15) || size > MBOX_LEN)
+		return -EINVAL;
+
+	v = MBOWNER_GET(t4_read_reg(adap, ctl_reg));
+	for (i = 0; v == MBOX_OWNER_NONE && i < 3; i++)
+		v = MBOWNER_GET(t4_read_reg(adap, ctl_reg));
+
+	if (v != MBOX_OWNER_DRV)
+		return v ? -EBUSY : -ETIMEDOUT;
+
+	for (i = 0; i < size; i += 8)
+		t4_write_reg64(adap, data_reg + i, be64_to_cpu(*p++));
+
+	t4_write_reg(adap, ctl_reg, MBMSGVALID | MBOWNER(MBOX_OWNER_FW));
+	t4_read_reg(adap, ctl_reg);          /* flush write */
+
+	delay_idx = 0;
+	ms = delay[0];
+
+	for (i = 0; i < FW_CMD_MAX_TIMEOUT; i += ms) {
+		if (sleep_ok) {
+			ms = delay[delay_idx];  /* last element may repeat */
+			if (delay_idx < ARRAY_SIZE(delay) - 1)
+				delay_idx++;
+			msleep(ms);
+		} else
+			mdelay(ms);
+
+		v = t4_read_reg(adap, ctl_reg);
+		if (MBOWNER_GET(v) == MBOX_OWNER_DRV) {
+			if (!(v & MBMSGVALID)) {
+				t4_write_reg(adap, ctl_reg, 0);
+				continue;
+			}
+
+			res = t4_read_reg64(adap, data_reg);
+			if (FW_CMD_OP_GET(res >> 32) == FW_DEBUG_CMD) {
+				fw_asrt(adap, data_reg);
+				res = FW_CMD_RETVAL(EIO);
+			} else if (rpl)
+				get_mbox_rpl(adap, rpl, size / 8, data_reg);
+
+			if (FW_CMD_RETVAL_GET((int)res))
+				dump_mbox(adap, mbox, data_reg);
+			t4_write_reg(adap, ctl_reg, 0);
+			return -FW_CMD_RETVAL_GET((int)res);
+		}
+	}
+
+	dump_mbox(adap, mbox, data_reg);
+	dev_err(adap->pdev_dev, "command %#x in mailbox %d timed out\n",
+		*(const u8 *)cmd, mbox);
+	return -ETIMEDOUT;
+}
+
+/**
+ *	t4_mc_read - read from MC through backdoor accesses
+ *	@adap: the adapter
+ *	@addr: address of first byte requested
+ *	@data: 64 bytes of data containing the requested address
+ *	@ecc: where to store the corresponding 64-bit ECC word
+ *
+ *	Read 64 bytes of data from MC starting at a 64-byte-aligned address
+ *	that covers the requested address @addr.  If @parity is not %NULL it
+ *	is assigned the 64-bit ECC word for the read data.
+ */
+int t4_mc_read(struct adapter *adap, u32 addr, __be32 *data, u64 *ecc)
+{
+	int i;
+
+	if (t4_read_reg(adap, MC_BIST_CMD) & START_BIST)
+		return -EBUSY;
+	t4_write_reg(adap, MC_BIST_CMD_ADDR, addr & ~0x3fU);
+	t4_write_reg(adap, MC_BIST_CMD_LEN, 64);
+	t4_write_reg(adap, MC_BIST_DATA_PATTERN, 0xc);
+	t4_write_reg(adap, MC_BIST_CMD, BIST_OPCODE(1) | START_BIST |
+		     BIST_CMD_GAP(1));
+	i = t4_wait_op_done(adap, MC_BIST_CMD, START_BIST, 0, 10, 1);
+	if (i)
+		return i;
+
+#define MC_DATA(i) MC_BIST_STATUS_REG(MC_BIST_STATUS_RDATA, i)
+
+	for (i = 15; i >= 0; i--)
+		*data++ = htonl(t4_read_reg(adap, MC_DATA(i)));
+	if (ecc)
+		*ecc = t4_read_reg64(adap, MC_DATA(16));
+#undef MC_DATA
+	return 0;
+}
+
+/**
+ *	t4_edc_read - read from EDC through backdoor accesses
+ *	@adap: the adapter
+ *	@idx: which EDC to access
+ *	@addr: address of first byte requested
+ *	@data: 64 bytes of data containing the requested address
+ *	@ecc: where to store the corresponding 64-bit ECC word
+ *
+ *	Read 64 bytes of data from EDC starting at a 64-byte-aligned address
+ *	that covers the requested address @addr.  If @parity is not %NULL it
+ *	is assigned the 64-bit ECC word for the read data.
+ */
+int t4_edc_read(struct adapter *adap, int idx, u32 addr, __be32 *data, u64 *ecc)
+{
+	int i;
+
+	idx *= EDC_STRIDE;
+	if (t4_read_reg(adap, EDC_BIST_CMD + idx) & START_BIST)
+		return -EBUSY;
+	t4_write_reg(adap, EDC_BIST_CMD_ADDR + idx, addr & ~0x3fU);
+	t4_write_reg(adap, EDC_BIST_CMD_LEN + idx, 64);
+	t4_write_reg(adap, EDC_BIST_DATA_PATTERN + idx, 0xc);
+	t4_write_reg(adap, EDC_BIST_CMD + idx,
+		     BIST_OPCODE(1) | BIST_CMD_GAP(1) | START_BIST);
+	i = t4_wait_op_done(adap, EDC_BIST_CMD + idx, START_BIST, 0, 10, 1);
+	if (i)
+		return i;
+
+#define EDC_DATA(i) (EDC_BIST_STATUS_REG(EDC_BIST_STATUS_RDATA, i) + idx)
+
+	for (i = 15; i >= 0; i--)
+		*data++ = htonl(t4_read_reg(adap, EDC_DATA(i)));
+	if (ecc)
+		*ecc = t4_read_reg64(adap, EDC_DATA(16));
+#undef EDC_DATA
+	return 0;
+}
+
+#define VPD_ENTRY(name, len) \
+	u8 name##_kword[2]; u8 name##_len; u8 name##_data[len]
+
+/*
+ * Partial EEPROM Vital Product Data structure.  Includes only the ID and
+ * VPD-R sections.
+ */
+struct t4_vpd {
+	u8  id_tag;
+	u8  id_len[2];
+	u8  id_data[ID_LEN];
+	u8  vpdr_tag;
+	u8  vpdr_len[2];
+	VPD_ENTRY(pn, 16);                     /* part number */
+	VPD_ENTRY(ec, EC_LEN);                 /* EC level */
+	VPD_ENTRY(sn, SERNUM_LEN);             /* serial number */
+	VPD_ENTRY(na, 12);                     /* MAC address base */
+	VPD_ENTRY(port_type, 8);               /* port types */
+	VPD_ENTRY(gpio, 14);                   /* GPIO usage */
+	VPD_ENTRY(cclk, 6);                    /* core clock */
+	VPD_ENTRY(port_addr, 8);               /* port MDIO addresses */
+	VPD_ENTRY(rv, 1);                      /* csum */
+	u32 pad;                  /* for multiple-of-4 sizing and alignment */
+};
+
+#define EEPROM_STAT_ADDR   0x7bfc
+#define VPD_BASE           0
+
+/**
+ *	t4_seeprom_wp - enable/disable EEPROM write protection
+ *	@adapter: the adapter
+ *	@enable: whether to enable or disable write protection
+ *
+ *	Enables or disables write protection on the serial EEPROM.
+ */
+int t4_seeprom_wp(struct adapter *adapter, bool enable)
+{
+	unsigned int v = enable ? 0xc : 0;
+	int ret = pci_write_vpd(adapter->pdev, EEPROM_STAT_ADDR, 4, &v);
+	return ret < 0 ? ret : 0;
+}
+
+/**
+ *	get_vpd_params - read VPD parameters from VPD EEPROM
+ *	@adapter: adapter to read
+ *	@p: where to store the parameters
+ *
+ *	Reads card parameters stored in VPD EEPROM.
+ */
+static int get_vpd_params(struct adapter *adapter, struct vpd_params *p)
+{
+	int ret;
+	struct t4_vpd vpd;
+	u8 *q = (u8 *)&vpd, csum;
+
+	ret = pci_read_vpd(adapter->pdev, VPD_BASE, sizeof(vpd), &vpd);
+	if (ret < 0)
+		return ret;
+
+	for (csum = 0; q <= vpd.rv_data; q++)
+		csum += *q;
+
+	if (csum) {
+		dev_err(adapter->pdev_dev,
+			"corrupted VPD EEPROM, actual csum %u\n", csum);
+		return -EINVAL;
+	}
+
+	p->cclk = simple_strtoul(vpd.cclk_data, NULL, 10);
+	memcpy(p->id, vpd.id_data, sizeof(vpd.id_data));
+	strim(p->id);
+	memcpy(p->ec, vpd.ec_data, sizeof(vpd.ec_data));
+	strim(p->ec);
+	memcpy(p->sn, vpd.sn_data, sizeof(vpd.sn_data));
+	strim(p->sn);
+	return 0;
+}
+
+/* serial flash and firmware constants */
+enum {
+	SF_ATTEMPTS = 10,             /* max retries for SF operations */
+
+	/* flash command opcodes */
+	SF_PROG_PAGE    = 2,          /* program page */
+	SF_WR_DISABLE   = 4,          /* disable writes */
+	SF_RD_STATUS    = 5,          /* read status register */
+	SF_WR_ENABLE    = 6,          /* enable writes */
+	SF_RD_DATA_FAST = 0xb,        /* read flash */
+	SF_ERASE_SECTOR = 0xd8,       /* erase sector */
+
+	FW_START_SEC = 8,             /* first flash sector for FW */
+	FW_END_SEC = 15,              /* last flash sector for FW */
+	FW_IMG_START = FW_START_SEC * SF_SEC_SIZE,
+	FW_MAX_SIZE = (FW_END_SEC - FW_START_SEC + 1) * SF_SEC_SIZE,
+};
+
+/**
+ *	sf1_read - read data from the serial flash
+ *	@adapter: the adapter
+ *	@byte_cnt: number of bytes to read
+ *	@cont: whether another operation will be chained
+ *	@lock: whether to lock SF for PL access only
+ *	@valp: where to store the read data
+ *
+ *	Reads up to 4 bytes of data from the serial flash.  The location of
+ *	the read needs to be specified prior to calling this by issuing the
+ *	appropriate commands to the serial flash.
+ */
+static int sf1_read(struct adapter *adapter, unsigned int byte_cnt, int cont,
+		    int lock, u32 *valp)
+{
+	int ret;
+
+	if (!byte_cnt || byte_cnt > 4)
+		return -EINVAL;
+	if (t4_read_reg(adapter, SF_OP) & BUSY)
+		return -EBUSY;
+	cont = cont ? SF_CONT : 0;
+	lock = lock ? SF_LOCK : 0;
+	t4_write_reg(adapter, SF_OP, lock | cont | BYTECNT(byte_cnt - 1));
+	ret = t4_wait_op_done(adapter, SF_OP, BUSY, 0, SF_ATTEMPTS, 5);
+	if (!ret)
+		*valp = t4_read_reg(adapter, SF_DATA);
+	return ret;
+}
+
+/**
+ *	sf1_write - write data to the serial flash
+ *	@adapter: the adapter
+ *	@byte_cnt: number of bytes to write
+ *	@cont: whether another operation will be chained
+ *	@lock: whether to lock SF for PL access only
+ *	@val: value to write
+ *
+ *	Writes up to 4 bytes of data to the serial flash.  The location of
+ *	the write needs to be specified prior to calling this by issuing the
+ *	appropriate commands to the serial flash.
+ */
+static int sf1_write(struct adapter *adapter, unsigned int byte_cnt, int cont,
+		     int lock, u32 val)
+{
+	if (!byte_cnt || byte_cnt > 4)
+		return -EINVAL;
+	if (t4_read_reg(adapter, SF_OP) & BUSY)
+		return -EBUSY;
+	cont = cont ? SF_CONT : 0;
+	lock = lock ? SF_LOCK : 0;
+	t4_write_reg(adapter, SF_DATA, val);
+	t4_write_reg(adapter, SF_OP, lock |
+		     cont | BYTECNT(byte_cnt - 1) | OP_WR);
+	return t4_wait_op_done(adapter, SF_OP, BUSY, 0, SF_ATTEMPTS, 5);
+}
+
+/**
+ *	flash_wait_op - wait for a flash operation to complete
+ *	@adapter: the adapter
+ *	@attempts: max number of polls of the status register
+ *	@delay: delay between polls in ms
+ *
+ *	Wait for a flash operation to complete by polling the status register.
+ */
+static int flash_wait_op(struct adapter *adapter, int attempts, int delay)
+{
+	int ret;
+	u32 status;
+
+	while (1) {
+		if ((ret = sf1_write(adapter, 1, 1, 1, SF_RD_STATUS)) != 0 ||
+		    (ret = sf1_read(adapter, 1, 0, 1, &status)) != 0)
+			return ret;
+		if (!(status & 1))
+			return 0;
+		if (--attempts == 0)
+			return -EAGAIN;
+		if (delay)
+			msleep(delay);
+	}
+}
+
+/**
+ *	t4_read_flash - read words from serial flash
+ *	@adapter: the adapter
+ *	@addr: the start address for the read
+ *	@nwords: how many 32-bit words to read
+ *	@data: where to store the read data
+ *	@byte_oriented: whether to store data as bytes or as words
+ *
+ *	Read the specified number of 32-bit words from the serial flash.
+ *	If @byte_oriented is set the read data is stored as a byte array
+ *	(i.e., big-endian), otherwise as 32-bit words in the platform's
+ *	natural endianess.
+ */
+int t4_read_flash(struct adapter *adapter, unsigned int addr,
+		  unsigned int nwords, u32 *data, int byte_oriented)
+{
+	int ret;
+
+	if (addr + nwords * sizeof(u32) > SF_SIZE || (addr & 3))
+		return -EINVAL;
+
+	addr = swab32(addr) | SF_RD_DATA_FAST;
+
+	if ((ret = sf1_write(adapter, 4, 1, 0, addr)) != 0 ||
+	    (ret = sf1_read(adapter, 1, 1, 0, data)) != 0)
+		return ret;
+
+	for ( ; nwords; nwords--, data++) {
+		ret = sf1_read(adapter, 4, nwords > 1, nwords == 1, data);
+		if (nwords == 1)
+			t4_write_reg(adapter, SF_OP, 0);    /* unlock SF */
+		if (ret)
+			return ret;
+		if (byte_oriented)
+			*data = htonl(*data);
+	}
+	return 0;
+}
+
+/**
+ *	t4_write_flash - write up to a page of data to the serial flash
+ *	@adapter: the adapter
+ *	@addr: the start address to write
+ *	@n: length of data to write in bytes
+ *	@data: the data to write
+ *
+ *	Writes up to a page of data (256 bytes) to the serial flash starting
+ *	at the given address.  All the data must be written to the same page.
+ */
+static int t4_write_flash(struct adapter *adapter, unsigned int addr,
+			  unsigned int n, const u8 *data)
+{
+	int ret;
+	u32 buf[64];
+	unsigned int i, c, left, val, offset = addr & 0xff;
+
+	if (addr >= SF_SIZE || offset + n > SF_PAGE_SIZE)
+		return -EINVAL;
+
+	val = swab32(addr) | SF_PROG_PAGE;
+
+	if ((ret = sf1_write(adapter, 1, 0, 1, SF_WR_ENABLE)) != 0 ||
+	    (ret = sf1_write(adapter, 4, 1, 1, val)) != 0)
+		goto unlock;
+
+	for (left = n; left; left -= c) {
+		c = min(left, 4U);
+		for (val = 0, i = 0; i < c; ++i)
+			val = (val << 8) + *data++;
+
+		ret = sf1_write(adapter, c, c != left, 1, val);
+		if (ret)
+			goto unlock;
+	}
+	ret = flash_wait_op(adapter, 5, 1);
+	if (ret)
+		goto unlock;
+
+	t4_write_reg(adapter, SF_OP, 0);    /* unlock SF */
+
+	/* Read the page to verify the write succeeded */
+	ret = t4_read_flash(adapter, addr & ~0xff, ARRAY_SIZE(buf), buf, 1);
+	if (ret)
+		return ret;
+
+	if (memcmp(data - n, (u8 *)buf + offset, n)) {
+		dev_err(adapter->pdev_dev,
+			"failed to correctly write the flash page at %#x\n",
+			addr);
+		return -EIO;
+	}
+	return 0;
+
+unlock:
+	t4_write_reg(adapter, SF_OP, 0);    /* unlock SF */
+	return ret;
+}
+
+/**
+ *	get_fw_version - read the firmware version
+ *	@adapter: the adapter
+ *	@vers: where to place the version
+ *
+ *	Reads the FW version from flash.
+ */
+static int get_fw_version(struct adapter *adapter, u32 *vers)
+{
+	return t4_read_flash(adapter,
+			     FW_IMG_START + offsetof(struct fw_hdr, fw_ver), 1,
+			     vers, 0);
+}
+
+/**
+ *	get_tp_version - read the TP microcode version
+ *	@adapter: the adapter
+ *	@vers: where to place the version
+ *
+ *	Reads the TP microcode version from flash.
+ */
+static int get_tp_version(struct adapter *adapter, u32 *vers)
+{
+	return t4_read_flash(adapter, FW_IMG_START + offsetof(struct fw_hdr,
+							      tp_microcode_ver),
+			     1, vers, 0);
+}
+
+/**
+ *	t4_check_fw_version - check if the FW is compatible with this driver
+ *	@adapter: the adapter
+ *
+ *	Checks if an adapter's FW is compatible with the driver.  Returns 0
+ *	if there's exact match, a negative error if the version could not be
+ *	read or there's a major version mismatch, and a positive value if the
+ *	expected major version is found but there's a minor version mismatch.
+ */
+int t4_check_fw_version(struct adapter *adapter)
+{
+	u32 api_vers[2];
+	int ret, major, minor, micro;
+
+	ret = get_fw_version(adapter, &adapter->params.fw_vers);
+	if (!ret)
+		ret = get_tp_version(adapter, &adapter->params.tp_vers);
+	if (!ret)
+		ret = t4_read_flash(adapter,
+			FW_IMG_START + offsetof(struct fw_hdr, intfver_nic),
+			2, api_vers, 1);
+	if (ret)
+		return ret;
+
+	major = FW_HDR_FW_VER_MAJOR_GET(adapter->params.fw_vers);
+	minor = FW_HDR_FW_VER_MINOR_GET(adapter->params.fw_vers);
+	micro = FW_HDR_FW_VER_MICRO_GET(adapter->params.fw_vers);
+	memcpy(adapter->params.api_vers, api_vers,
+	       sizeof(adapter->params.api_vers));
+
+	if (major != FW_VERSION_MAJOR) {            /* major mismatch - fail */
+		dev_err(adapter->pdev_dev,
+			"card FW has major version %u, driver wants %u\n",
+			major, FW_VERSION_MAJOR);
+		return -EINVAL;
+	}
+
+	if (minor == FW_VERSION_MINOR && micro == FW_VERSION_MICRO)
+		return 0;                                   /* perfect match */
+
+	/* Minor/micro version mismatch.  Report it but often it's OK. */
+	return 1;
+}
+
+/**
+ *	t4_flash_erase_sectors - erase a range of flash sectors
+ *	@adapter: the adapter
+ *	@start: the first sector to erase
+ *	@end: the last sector to erase
+ *
+ *	Erases the sectors in the given inclusive range.
+ */
+static int t4_flash_erase_sectors(struct adapter *adapter, int start, int end)
+{
+	int ret = 0;
+
+	while (start <= end) {
+		if ((ret = sf1_write(adapter, 1, 0, 1, SF_WR_ENABLE)) != 0 ||
+		    (ret = sf1_write(adapter, 4, 0, 1,
+				     SF_ERASE_SECTOR | (start << 8))) != 0 ||
+		    (ret = flash_wait_op(adapter, 5, 500)) != 0) {
+			dev_err(adapter->pdev_dev,
+				"erase of flash sector %d failed, error %d\n",
+				start, ret);
+			break;
+		}
+		start++;
+	}
+	t4_write_reg(adapter, SF_OP, 0);    /* unlock SF */
+	return ret;
+}
+
+/**
+ *	t4_load_fw - download firmware
+ *	@adap: the adapter
+ *	@fw_data: the firmware image to write
+ *	@size: image size
+ *
+ *	Write the supplied firmware image to the card's serial flash.
+ */
+int t4_load_fw(struct adapter *adap, const u8 *fw_data, unsigned int size)
+{
+	u32 csum;
+	int ret, addr;
+	unsigned int i;
+	u8 first_page[SF_PAGE_SIZE];
+	const u32 *p = (const u32 *)fw_data;
+	const struct fw_hdr *hdr = (const struct fw_hdr *)fw_data;
+
+	if (!size) {
+		dev_err(adap->pdev_dev, "FW image has no data\n");
+		return -EINVAL;
+	}
+	if (size & 511) {
+		dev_err(adap->pdev_dev,
+			"FW image size not multiple of 512 bytes\n");
+		return -EINVAL;
+	}
+	if (ntohs(hdr->len512) * 512 != size) {
+		dev_err(adap->pdev_dev,
+			"FW image size differs from size in FW header\n");
+		return -EINVAL;
+	}
+	if (size > FW_MAX_SIZE) {
+		dev_err(adap->pdev_dev, "FW image too large, max is %u bytes\n",
+			FW_MAX_SIZE);
+		return -EFBIG;
+	}
+
+	for (csum = 0, i = 0; i < size / sizeof(csum); i++)
+		csum += ntohl(p[i]);
+
+	if (csum != 0xffffffff) {
+		dev_err(adap->pdev_dev,
+			"corrupted firmware image, checksum %#x\n", csum);
+		return -EINVAL;
+	}
+
+	i = DIV_ROUND_UP(size, SF_SEC_SIZE);        /* # of sectors spanned */
+	ret = t4_flash_erase_sectors(adap, FW_START_SEC, FW_START_SEC + i - 1);
+	if (ret)
+		goto out;
+
+	/*
+	 * We write the correct version at the end so the driver can see a bad
+	 * version if the FW write fails.  Start by writing a copy of the
+	 * first page with a bad version.
+	 */
+	memcpy(first_page, fw_data, SF_PAGE_SIZE);
+	((struct fw_hdr *)first_page)->fw_ver = htonl(0xffffffff);
+	ret = t4_write_flash(adap, FW_IMG_START, SF_PAGE_SIZE, first_page);
+	if (ret)
+		goto out;
+
+	addr = FW_IMG_START;
+	for (size -= SF_PAGE_SIZE; size; size -= SF_PAGE_SIZE) {
+		addr += SF_PAGE_SIZE;
+		fw_data += SF_PAGE_SIZE;
+		ret = t4_write_flash(adap, addr, SF_PAGE_SIZE, fw_data);
+		if (ret)
+			goto out;
+	}
+
+	ret = t4_write_flash(adap,
+			     FW_IMG_START + offsetof(struct fw_hdr, fw_ver),
+			     sizeof(hdr->fw_ver), (const u8 *)&hdr->fw_ver);
+out:
+	if (ret)
+		dev_err(adap->pdev_dev, "firmware download failed, error %d\n",
+			ret);
+	return ret;
+}
+
+#define ADVERT_MASK (FW_PORT_CAP_SPEED_100M | FW_PORT_CAP_SPEED_1G |\
+		     FW_PORT_CAP_SPEED_10G | FW_PORT_CAP_ANEG)
+
+/**
+ *	t4_link_start - apply link configuration to MAC/PHY
+ *	@phy: the PHY to setup
+ *	@mac: the MAC to setup
+ *	@lc: the requested link configuration
+ *
+ *	Set up a port's MAC and PHY according to a desired link configuration.
+ *	- If the PHY can auto-negotiate first decide what to advertise, then
+ *	  enable/disable auto-negotiation as desired, and reset.
+ *	- If the PHY does not auto-negotiate just reset it.
+ *	- If auto-negotiation is off set the MAC to the proper speed/duplex/FC,
+ *	  otherwise do it later based on the outcome of auto-negotiation.
+ */
+int t4_link_start(struct adapter *adap, unsigned int mbox, unsigned int port,
+		  struct link_config *lc)
+{
+	struct fw_port_cmd c;
+	unsigned int fc = 0, mdi = FW_PORT_MDI(FW_PORT_MDI_AUTO);
+
+	lc->link_ok = 0;
+	if (lc->requested_fc & PAUSE_RX)
+		fc |= FW_PORT_CAP_FC_RX;
+	if (lc->requested_fc & PAUSE_TX)
+		fc |= FW_PORT_CAP_FC_TX;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_portid = htonl(FW_CMD_OP(FW_PORT_CMD) | FW_CMD_REQUEST |
+			       FW_CMD_EXEC | FW_PORT_CMD_PORTID(port));
+	c.action_to_len16 = htonl(FW_PORT_CMD_ACTION(FW_PORT_ACTION_L1_CFG) |
+				  FW_LEN16(c));
+
+	if (!(lc->supported & FW_PORT_CAP_ANEG)) {
+		c.u.l1cfg.rcap = htonl((lc->supported & ADVERT_MASK) | fc);
+		lc->fc = lc->requested_fc & (PAUSE_RX | PAUSE_TX);
+	} else if (lc->autoneg == AUTONEG_DISABLE) {
+		c.u.l1cfg.rcap = htonl(lc->requested_speed | fc | mdi);
+		lc->fc = lc->requested_fc & (PAUSE_RX | PAUSE_TX);
+	} else
+		c.u.l1cfg.rcap = htonl(lc->advertising | fc | mdi);
+
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_restart_aneg - restart autonegotiation
+ *	@adap: the adapter
+ *	@mbox: mbox to use for the FW command
+ *	@port: the port id
+ *
+ *	Restarts autonegotiation for the selected port.
+ */
+int t4_restart_aneg(struct adapter *adap, unsigned int mbox, unsigned int port)
+{
+	struct fw_port_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_portid = htonl(FW_CMD_OP(FW_PORT_CMD) | FW_CMD_REQUEST |
+			       FW_CMD_EXEC | FW_PORT_CMD_PORTID(port));
+	c.action_to_len16 = htonl(FW_PORT_CMD_ACTION(FW_PORT_ACTION_L1_CFG) |
+				  FW_LEN16(c));
+	c.u.l1cfg.rcap = htonl(FW_PORT_CAP_ANEG);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_set_vlan_accel - configure HW VLAN extraction
+ *	@adap: the adapter
+ *	@ports: bitmap of adapter ports to operate on
+ *	@on: enable (1) or disable (0) HW VLAN extraction
+ *
+ *	Enables or disables HW extraction of VLAN tags for the ports specified
+ *	by @ports.  @ports is a bitmap with the ith bit designating the port
+ *	associated with the ith adapter channel.
+ */
+void t4_set_vlan_accel(struct adapter *adap, unsigned int ports, int on)
+{
+	ports <<= VLANEXTENABLE_SHIFT;
+	t4_set_reg_field(adap, TP_OUT_CONFIG, ports, on ? ports : 0);
+}
+
+struct intr_info {
+	unsigned int mask;       /* bits to check in interrupt status */
+	const char *msg;         /* message to print or NULL */
+	short stat_idx;          /* stat counter to increment or -1 */
+	unsigned short fatal;    /* whether the condition reported is fatal */
+};
+
+/**
+ *	t4_handle_intr_status - table driven interrupt handler
+ *	@adapter: the adapter that generated the interrupt
+ *	@reg: the interrupt status register to process
+ *	@acts: table of interrupt actions
+ *
+ *	A table driven interrupt handler that applies a set of masks to an
+ *	interrupt status word and performs the corresponding actions if the
+ *	interrupts described by the mask have occured.  The actions include
+ *	optionally emitting a warning or alert message.  The table is terminated
+ *	by an entry specifying mask 0.  Returns the number of fatal interrupt
+ *	conditions.
+ */
+static int t4_handle_intr_status(struct adapter *adapter, unsigned int reg,
+				 const struct intr_info *acts)
+{
+	int fatal = 0;
+	unsigned int mask = 0;
+	unsigned int status = t4_read_reg(adapter, reg);
+
+	for ( ; acts->mask; ++acts) {
+		if (!(status & acts->mask))
+			continue;
+		if (acts->fatal) {
+			fatal++;
+			dev_alert(adapter->pdev_dev, "%s (0x%x)\n", acts->msg,
+				  status & acts->mask);
+		} else if (acts->msg && printk_ratelimit())
+			dev_warn(adapter->pdev_dev, "%s (0x%x)\n", acts->msg,
+				 status & acts->mask);
+		mask |= acts->mask;
+	}
+	status &= mask;
+	if (status)                           /* clear processed interrupts */
+		t4_write_reg(adapter, reg, status);
+	return fatal;
+}
+
+/*
+ * Interrupt handler for the PCIE module.
+ */
+static void pcie_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info sysbus_intr_info[] = {
+		{ RNPP, "RXNP array parity error", -1, 1 },
+		{ RPCP, "RXPC array parity error", -1, 1 },
+		{ RCIP, "RXCIF array parity error", -1, 1 },
+		{ RCCP, "Rx completions control array parity error", -1, 1 },
+		{ RFTP, "RXFT array parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info pcie_port_intr_info[] = {
+		{ TPCP, "TXPC array parity error", -1, 1 },
+		{ TNPP, "TXNP array parity error", -1, 1 },
+		{ TFTP, "TXFT array parity error", -1, 1 },
+		{ TCAP, "TXCA array parity error", -1, 1 },
+		{ TCIP, "TXCIF array parity error", -1, 1 },
+		{ RCAP, "RXCA array parity error", -1, 1 },
+		{ OTDD, "outbound request TLP discarded", -1, 1 },
+		{ RDPE, "Rx data parity error", -1, 1 },
+		{ TDUE, "Tx uncorrectable data error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info pcie_intr_info[] = {
+		{ MSIADDRLPERR, "MSI AddrL parity error", -1, 1 },
+		{ MSIADDRHPERR, "MSI AddrH parity error", -1, 1 },
+		{ MSIDATAPERR, "MSI data parity error", -1, 1 },
+		{ MSIXADDRLPERR, "MSI-X AddrL parity error", -1, 1 },
+		{ MSIXADDRHPERR, "MSI-X AddrH parity error", -1, 1 },
+		{ MSIXDATAPERR, "MSI-X data parity error", -1, 1 },
+		{ MSIXDIPERR, "MSI-X DI parity error", -1, 1 },
+		{ PIOCPLPERR, "PCI PIO completion FIFO parity error", -1, 1 },
+		{ PIOREQPERR, "PCI PIO request FIFO parity error", -1, 1 },
+		{ TARTAGPERR, "PCI PCI target tag FIFO parity error", -1, 1 },
+		{ CCNTPERR, "PCI CMD channel count parity error", -1, 1 },
+		{ CREQPERR, "PCI CMD channel request parity error", -1, 1 },
+		{ CRSPPERR, "PCI CMD channel response parity error", -1, 1 },
+		{ DCNTPERR, "PCI DMA channel count parity error", -1, 1 },
+		{ DREQPERR, "PCI DMA channel request parity error", -1, 1 },
+		{ DRSPPERR, "PCI DMA channel response parity error", -1, 1 },
+		{ HCNTPERR, "PCI HMA channel count parity error", -1, 1 },
+		{ HREQPERR, "PCI HMA channel request parity error", -1, 1 },
+		{ HRSPPERR, "PCI HMA channel response parity error", -1, 1 },
+		{ CFGSNPPERR, "PCI config snoop FIFO parity error", -1, 1 },
+		{ FIDPERR, "PCI FID parity error", -1, 1 },
+		{ INTXCLRPERR, "PCI INTx clear parity error", -1, 1 },
+		{ MATAGPERR, "PCI MA tag parity error", -1, 1 },
+		{ PIOTAGPERR, "PCI PIO tag parity error", -1, 1 },
+		{ RXCPLPERR, "PCI Rx completion parity error", -1, 1 },
+		{ RXWRPERR, "PCI Rx write parity error", -1, 1 },
+		{ RPLPERR, "PCI replay buffer parity error", -1, 1 },
+		{ PCIESINT, "PCI core secondary fault", -1, 1 },
+		{ PCIEPINT, "PCI core primary fault", -1, 1 },
+		{ UNXSPLCPLERR, "PCI unexpected split completion error", -1, 0 },
+		{ 0 }
+	};
+
+	int fat;
+
+	fat = t4_handle_intr_status(adapter,
+				    PCIE_CORE_UTL_SYSTEM_BUS_AGENT_STATUS,
+				    sysbus_intr_info) +
+	      t4_handle_intr_status(adapter,
+				    PCIE_CORE_UTL_PCI_EXPRESS_PORT_STATUS,
+				    pcie_port_intr_info) +
+	      t4_handle_intr_status(adapter, PCIE_INT_CAUSE, pcie_intr_info);
+	if (fat)
+		t4_fatal_err(adapter);
+}
+
+/*
+ * TP interrupt handler.
+ */
+static void tp_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info tp_intr_info[] = {
+		{ 0x3fffffff, "TP parity error", -1, 1 },
+		{ FLMTXFLSTEMPTY, "TP out of Tx pages", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, TP_INT_CAUSE, tp_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * SGE interrupt handler.
+ */
+static void sge_intr_handler(struct adapter *adapter)
+{
+	u64 v;
+
+	static struct intr_info sge_intr_info[] = {
+		{ ERR_CPL_EXCEED_IQE_SIZE,
+		  "SGE received CPL exceeding IQE size", -1, 1 },
+		{ ERR_INVALID_CIDX_INC,
+		  "SGE GTS CIDX increment too large", -1, 0 },
+		{ ERR_CPL_OPCODE_0, "SGE received 0-length CPL", -1, 0 },
+		{ ERR_DROPPED_DB, "SGE doorbell dropped", -1, 0 },
+		{ ERR_DATA_CPL_ON_HIGH_QID1 | ERR_DATA_CPL_ON_HIGH_QID0,
+		  "SGE IQID > 1023 received CPL for FL", -1, 0 },
+		{ ERR_BAD_DB_PIDX3, "SGE DBP 3 pidx increment too large", -1,
+		  0 },
+		{ ERR_BAD_DB_PIDX2, "SGE DBP 2 pidx increment too large", -1,
+		  0 },
+		{ ERR_BAD_DB_PIDX1, "SGE DBP 1 pidx increment too large", -1,
+		  0 },
+		{ ERR_BAD_DB_PIDX0, "SGE DBP 0 pidx increment too large", -1,
+		  0 },
+		{ ERR_ING_CTXT_PRIO,
+		  "SGE too many priority ingress contexts", -1, 0 },
+		{ ERR_EGR_CTXT_PRIO,
+		  "SGE too many priority egress contexts", -1, 0 },
+		{ INGRESS_SIZE_ERR, "SGE illegal ingress QID", -1, 0 },
+		{ EGRESS_SIZE_ERR, "SGE illegal egress QID", -1, 0 },
+		{ 0 }
+	};
+
+	v = (u64)t4_read_reg(adapter, SGE_INT_CAUSE1) |
+	    ((u64)t4_read_reg(adapter, SGE_INT_CAUSE2) << 32);
+	if (v) {
+		dev_alert(adapter->pdev_dev, "SGE parity error (%#llx)\n",
+			 (unsigned long long)v);
+		t4_write_reg(adapter, SGE_INT_CAUSE1, v);
+		t4_write_reg(adapter, SGE_INT_CAUSE2, v >> 32);
+	}
+
+	if (t4_handle_intr_status(adapter, SGE_INT_CAUSE3, sge_intr_info) ||
+	    v != 0)
+		t4_fatal_err(adapter);
+}
+
+/*
+ * CIM interrupt handler.
+ */
+static void cim_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info cim_intr_info[] = {
+		{ PREFDROPINT, "CIM control register prefetch drop", -1, 1 },
+		{ OBQPARERR, "CIM OBQ parity error", -1, 1 },
+		{ IBQPARERR, "CIM IBQ parity error", -1, 1 },
+		{ MBUPPARERR, "CIM mailbox uP parity error", -1, 1 },
+		{ MBHOSTPARERR, "CIM mailbox host parity error", -1, 1 },
+		{ TIEQINPARERRINT, "CIM TIEQ outgoing parity error", -1, 1 },
+		{ TIEQOUTPARERRINT, "CIM TIEQ incoming parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info cim_upintr_info[] = {
+		{ RSVDSPACEINT, "CIM reserved space access", -1, 1 },
+		{ ILLTRANSINT, "CIM illegal transaction", -1, 1 },
+		{ ILLWRINT, "CIM illegal write", -1, 1 },
+		{ ILLRDINT, "CIM illegal read", -1, 1 },
+		{ ILLRDBEINT, "CIM illegal read BE", -1, 1 },
+		{ ILLWRBEINT, "CIM illegal write BE", -1, 1 },
+		{ SGLRDBOOTINT, "CIM single read from boot space", -1, 1 },
+		{ SGLWRBOOTINT, "CIM single write to boot space", -1, 1 },
+		{ BLKWRBOOTINT, "CIM block write to boot space", -1, 1 },
+		{ SGLRDFLASHINT, "CIM single read from flash space", -1, 1 },
+		{ SGLWRFLASHINT, "CIM single write to flash space", -1, 1 },
+		{ BLKWRFLASHINT, "CIM block write to flash space", -1, 1 },
+		{ SGLRDEEPROMINT, "CIM single EEPROM read", -1, 1 },
+		{ SGLWREEPROMINT, "CIM single EEPROM write", -1, 1 },
+		{ BLKRDEEPROMINT, "CIM block EEPROM read", -1, 1 },
+		{ BLKWREEPROMINT, "CIM block EEPROM write", -1, 1 },
+		{ SGLRDCTLINT , "CIM single read from CTL space", -1, 1 },
+		{ SGLWRCTLINT , "CIM single write to CTL space", -1, 1 },
+		{ BLKRDCTLINT , "CIM block read from CTL space", -1, 1 },
+		{ BLKWRCTLINT , "CIM block write to CTL space", -1, 1 },
+		{ SGLRDPLINT , "CIM single read from PL space", -1, 1 },
+		{ SGLWRPLINT , "CIM single write to PL space", -1, 1 },
+		{ BLKRDPLINT , "CIM block read from PL space", -1, 1 },
+		{ BLKWRPLINT , "CIM block write to PL space", -1, 1 },
+		{ REQOVRLOOKUPINT , "CIM request FIFO overwrite", -1, 1 },
+		{ RSPOVRLOOKUPINT , "CIM response FIFO overwrite", -1, 1 },
+		{ TIMEOUTINT , "CIM PIF timeout", -1, 1 },
+		{ TIMEOUTMAINT , "CIM PIF MA timeout", -1, 1 },
+		{ 0 }
+	};
+
+	int fat;
+
+	fat = t4_handle_intr_status(adapter, CIM_HOST_INT_CAUSE,
+				    cim_intr_info) +
+	      t4_handle_intr_status(adapter, CIM_HOST_UPACC_INT_CAUSE,
+				    cim_upintr_info);
+	if (fat)
+		t4_fatal_err(adapter);
+}
+
+/*
+ * ULP RX interrupt handler.
+ */
+static void ulprx_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info ulprx_intr_info[] = {
+		{ 0x7fffff, "ULPRX parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, ULP_RX_INT_CAUSE, ulprx_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * ULP TX interrupt handler.
+ */
+static void ulptx_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info ulptx_intr_info[] = {
+		{ PBL_BOUND_ERR_CH3, "ULPTX channel 3 PBL out of bounds", -1,
+		  0 },
+		{ PBL_BOUND_ERR_CH2, "ULPTX channel 2 PBL out of bounds", -1,
+		  0 },
+		{ PBL_BOUND_ERR_CH1, "ULPTX channel 1 PBL out of bounds", -1,
+		  0 },
+		{ PBL_BOUND_ERR_CH0, "ULPTX channel 0 PBL out of bounds", -1,
+		  0 },
+		{ 0xfffffff, "ULPTX parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, ULP_TX_INT_CAUSE, ulptx_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * PM TX interrupt handler.
+ */
+static void pmtx_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info pmtx_intr_info[] = {
+		{ PCMD_LEN_OVFL0, "PMTX channel 0 pcmd too large", -1, 1 },
+		{ PCMD_LEN_OVFL1, "PMTX channel 1 pcmd too large", -1, 1 },
+		{ PCMD_LEN_OVFL2, "PMTX channel 2 pcmd too large", -1, 1 },
+		{ ZERO_C_CMD_ERROR, "PMTX 0-length pcmd", -1, 1 },
+		{ PMTX_FRAMING_ERROR, "PMTX framing error", -1, 1 },
+		{ OESPI_PAR_ERROR, "PMTX oespi parity error", -1, 1 },
+		{ DB_OPTIONS_PAR_ERROR, "PMTX db_options parity error", -1, 1 },
+		{ ICSPI_PAR_ERROR, "PMTX icspi parity error", -1, 1 },
+		{ C_PCMD_PAR_ERROR, "PMTX c_pcmd parity error", -1, 1},
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, PM_TX_INT_CAUSE, pmtx_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * PM RX interrupt handler.
+ */
+static void pmrx_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info pmrx_intr_info[] = {
+		{ ZERO_E_CMD_ERROR, "PMRX 0-length pcmd", -1, 1 },
+		{ PMRX_FRAMING_ERROR, "PMRX framing error", -1, 1 },
+		{ OCSPI_PAR_ERROR, "PMRX ocspi parity error", -1, 1 },
+		{ DB_OPTIONS_PAR_ERROR, "PMRX db_options parity error", -1, 1 },
+		{ IESPI_PAR_ERROR, "PMRX iespi parity error", -1, 1 },
+		{ E_PCMD_PAR_ERROR, "PMRX e_pcmd parity error", -1, 1},
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, PM_RX_INT_CAUSE, pmrx_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * CPL switch interrupt handler.
+ */
+static void cplsw_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info cplsw_intr_info[] = {
+		{ CIM_OP_MAP_PERR, "CPLSW CIM op_map parity error", -1, 1 },
+		{ CIM_OVFL_ERROR, "CPLSW CIM overflow", -1, 1 },
+		{ TP_FRAMING_ERROR, "CPLSW TP framing error", -1, 1 },
+		{ SGE_FRAMING_ERROR, "CPLSW SGE framing error", -1, 1 },
+		{ CIM_FRAMING_ERROR, "CPLSW CIM framing error", -1, 1 },
+		{ ZERO_SWITCH_ERROR, "CPLSW no-switch error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adapter, CPL_INTR_CAUSE, cplsw_intr_info))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * LE interrupt handler.
+ */
+static void le_intr_handler(struct adapter *adap)
+{
+	static struct intr_info le_intr_info[] = {
+		{ LIPMISS, "LE LIP miss", -1, 0 },
+		{ LIP0, "LE 0 LIP error", -1, 0 },
+		{ PARITYERR, "LE parity error", -1, 1 },
+		{ UNKNOWNCMD, "LE unknown command", -1, 1 },
+		{ REQQPARERR, "LE request queue parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adap, LE_DB_INT_CAUSE, le_intr_info))
+		t4_fatal_err(adap);
+}
+
+/*
+ * MPS interrupt handler.
+ */
+static void mps_intr_handler(struct adapter *adapter)
+{
+	static struct intr_info mps_rx_intr_info[] = {
+		{ 0xffffff, "MPS Rx parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_tx_intr_info[] = {
+		{ TPFIFO, "MPS Tx TP FIFO parity error", -1, 1 },
+		{ NCSIFIFO, "MPS Tx NC-SI FIFO parity error", -1, 1 },
+		{ TXDATAFIFO, "MPS Tx data FIFO parity error", -1, 1 },
+		{ TXDESCFIFO, "MPS Tx desc FIFO parity error", -1, 1 },
+		{ BUBBLE, "MPS Tx underflow", -1, 1 },
+		{ SECNTERR, "MPS Tx SOP/EOP error", -1, 1 },
+		{ FRMERR, "MPS Tx framing error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_trc_intr_info[] = {
+		{ FILTMEM, "MPS TRC filter parity error", -1, 1 },
+		{ PKTFIFO, "MPS TRC packet FIFO parity error", -1, 1 },
+		{ MISCPERR, "MPS TRC misc parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_stat_sram_intr_info[] = {
+		{ 0x1fffff, "MPS statistics SRAM parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_stat_tx_intr_info[] = {
+		{ 0xfffff, "MPS statistics Tx FIFO parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_stat_rx_intr_info[] = {
+		{ 0xffffff, "MPS statistics Rx FIFO parity error", -1, 1 },
+		{ 0 }
+	};
+	static struct intr_info mps_cls_intr_info[] = {
+		{ MATCHSRAM, "MPS match SRAM parity error", -1, 1 },
+		{ MATCHTCAM, "MPS match TCAM parity error", -1, 1 },
+		{ HASHSRAM, "MPS hash SRAM parity error", -1, 1 },
+		{ 0 }
+	};
+
+	int fat;
+
+	fat = t4_handle_intr_status(adapter, MPS_RX_PERR_INT_CAUSE,
+				    mps_rx_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_TX_INT_CAUSE,
+				    mps_tx_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_TRC_INT_CAUSE,
+				    mps_trc_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_STAT_PERR_INT_CAUSE_SRAM,
+				    mps_stat_sram_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_STAT_PERR_INT_CAUSE_TX_FIFO,
+				    mps_stat_tx_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_STAT_PERR_INT_CAUSE_RX_FIFO,
+				    mps_stat_rx_intr_info) +
+	      t4_handle_intr_status(adapter, MPS_CLS_INT_CAUSE,
+				    mps_cls_intr_info);
+
+	t4_write_reg(adapter, MPS_INT_CAUSE, CLSINT | TRCINT |
+		     RXINT | TXINT | STATINT);
+	t4_read_reg(adapter, MPS_INT_CAUSE);                    /* flush */
+	if (fat)
+		t4_fatal_err(adapter);
+}
+
+#define MEM_INT_MASK (PERR_INT_CAUSE | ECC_CE_INT_CAUSE | ECC_UE_INT_CAUSE)
+
+/*
+ * EDC/MC interrupt handler.
+ */
+static void mem_intr_handler(struct adapter *adapter, int idx)
+{
+	static const char name[3][5] = { "EDC0", "EDC1", "MC" };
+
+	unsigned int addr, cnt_addr, v;
+
+	if (idx <= MEM_EDC1) {
+		addr = EDC_REG(EDC_INT_CAUSE, idx);
+		cnt_addr = EDC_REG(EDC_ECC_STATUS, idx);
+	} else {
+		addr = MC_INT_CAUSE;
+		cnt_addr = MC_ECC_STATUS;
+	}
+
+	v = t4_read_reg(adapter, addr) & MEM_INT_MASK;
+	if (v & PERR_INT_CAUSE)
+		dev_alert(adapter->pdev_dev, "%s FIFO parity error\n",
+			  name[idx]);
+	if (v & ECC_CE_INT_CAUSE) {
+		u32 cnt = ECC_CECNT_GET(t4_read_reg(adapter, cnt_addr));
+
+		t4_write_reg(adapter, cnt_addr, ECC_CECNT_MASK);
+		if (printk_ratelimit())
+			dev_warn(adapter->pdev_dev,
+				 "%u %s correctable ECC data error%s\n",
+				 cnt, name[idx], cnt > 1 ? "s" : "");
+	}
+	if (v & ECC_UE_INT_CAUSE)
+		dev_alert(adapter->pdev_dev,
+			  "%s uncorrectable ECC data error\n", name[idx]);
+
+	t4_write_reg(adapter, addr, v);
+	if (v & (PERR_INT_CAUSE | ECC_UE_INT_CAUSE))
+		t4_fatal_err(adapter);
+}
+
+/*
+ * MA interrupt handler.
+ */
+static void ma_intr_handler(struct adapter *adap)
+{
+	u32 v, status = t4_read_reg(adap, MA_INT_CAUSE);
+
+	if (status & MEM_PERR_INT_CAUSE)
+		dev_alert(adap->pdev_dev,
+			  "MA parity error, parity status %#x\n",
+			  t4_read_reg(adap, MA_PARITY_ERROR_STATUS));
+	if (status & MEM_WRAP_INT_CAUSE) {
+		v = t4_read_reg(adap, MA_INT_WRAP_STATUS);
+		dev_alert(adap->pdev_dev, "MA address wrap-around error by "
+			  "client %u to address %#x\n",
+			  MEM_WRAP_CLIENT_NUM_GET(v),
+			  MEM_WRAP_ADDRESS_GET(v) << 4);
+	}
+	t4_write_reg(adap, MA_INT_CAUSE, status);
+	t4_fatal_err(adap);
+}
+
+/*
+ * SMB interrupt handler.
+ */
+static void smb_intr_handler(struct adapter *adap)
+{
+	static struct intr_info smb_intr_info[] = {
+		{ MSTTXFIFOPARINT, "SMB master Tx FIFO parity error", -1, 1 },
+		{ MSTRXFIFOPARINT, "SMB master Rx FIFO parity error", -1, 1 },
+		{ SLVFIFOPARINT, "SMB slave FIFO parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adap, SMB_INT_CAUSE, smb_intr_info))
+		t4_fatal_err(adap);
+}
+
+/*
+ * NC-SI interrupt handler.
+ */
+static void ncsi_intr_handler(struct adapter *adap)
+{
+	static struct intr_info ncsi_intr_info[] = {
+		{ CIM_DM_PRTY_ERR, "NC-SI CIM parity error", -1, 1 },
+		{ MPS_DM_PRTY_ERR, "NC-SI MPS parity error", -1, 1 },
+		{ TXFIFO_PRTY_ERR, "NC-SI Tx FIFO parity error", -1, 1 },
+		{ RXFIFO_PRTY_ERR, "NC-SI Rx FIFO parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adap, NCSI_INT_CAUSE, ncsi_intr_info))
+		t4_fatal_err(adap);
+}
+
+/*
+ * XGMAC interrupt handler.
+ */
+static void xgmac_intr_handler(struct adapter *adap, int port)
+{
+	u32 v = t4_read_reg(adap, PORT_REG(port, XGMAC_PORT_INT_CAUSE));
+
+	v &= TXFIFO_PRTY_ERR | RXFIFO_PRTY_ERR;
+	if (!v)
+		return;
+
+	if (v & TXFIFO_PRTY_ERR)
+		dev_alert(adap->pdev_dev, "XGMAC %d Tx FIFO parity error\n",
+			  port);
+	if (v & RXFIFO_PRTY_ERR)
+		dev_alert(adap->pdev_dev, "XGMAC %d Rx FIFO parity error\n",
+			  port);
+	t4_write_reg(adap, PORT_REG(port, XGMAC_PORT_INT_CAUSE), v);
+	t4_fatal_err(adap);
+}
+
+/*
+ * PL interrupt handler.
+ */
+static void pl_intr_handler(struct adapter *adap)
+{
+	static struct intr_info pl_intr_info[] = {
+		{ FATALPERR, "T4 fatal parity error", -1, 1 },
+		{ PERRVFID, "PL VFID_MAP parity error", -1, 1 },
+		{ 0 }
+	};
+
+	if (t4_handle_intr_status(adap, PL_PL_INT_CAUSE, pl_intr_info))
+		t4_fatal_err(adap);
+}
+
+#define PF_INTR_MASK (PFSW | PFCIM)
+#define GLBL_INTR_MASK (CIM | MPS | PL | PCIE | MC | EDC0 | \
+		EDC1 | LE | TP | MA | PM_TX | PM_RX | ULP_RX | \
+		CPL_SWITCH | SGE | ULP_TX)
+
+/**
+ *	t4_slow_intr_handler - control path interrupt handler
+ *	@adapter: the adapter
+ *
+ *	T4 interrupt handler for non-data global interrupt events, e.g., errors.
+ *	The designation 'slow' is because it involves register reads, while
+ *	data interrupts typically don't involve any MMIOs.
+ */
+int t4_slow_intr_handler(struct adapter *adapter)
+{
+	u32 cause = t4_read_reg(adapter, PL_INT_CAUSE);
+
+	if (!(cause & GLBL_INTR_MASK))
+		return 0;
+	if (cause & CIM)
+		cim_intr_handler(adapter);
+	if (cause & MPS)
+		mps_intr_handler(adapter);
+	if (cause & NCSI)
+		ncsi_intr_handler(adapter);
+	if (cause & PL)
+		pl_intr_handler(adapter);
+	if (cause & SMB)
+		smb_intr_handler(adapter);
+	if (cause & XGMAC0)
+		xgmac_intr_handler(adapter, 0);
+	if (cause & XGMAC1)
+		xgmac_intr_handler(adapter, 1);
+	if (cause & XGMAC_KR0)
+		xgmac_intr_handler(adapter, 2);
+	if (cause & XGMAC_KR1)
+		xgmac_intr_handler(adapter, 3);
+	if (cause & PCIE)
+		pcie_intr_handler(adapter);
+	if (cause & MC)
+		mem_intr_handler(adapter, MEM_MC);
+	if (cause & EDC0)
+		mem_intr_handler(adapter, MEM_EDC0);
+	if (cause & EDC1)
+		mem_intr_handler(adapter, MEM_EDC1);
+	if (cause & LE)
+		le_intr_handler(adapter);
+	if (cause & TP)
+		tp_intr_handler(adapter);
+	if (cause & MA)
+		ma_intr_handler(adapter);
+	if (cause & PM_TX)
+		pmtx_intr_handler(adapter);
+	if (cause & PM_RX)
+		pmrx_intr_handler(adapter);
+	if (cause & ULP_RX)
+		ulprx_intr_handler(adapter);
+	if (cause & CPL_SWITCH)
+		cplsw_intr_handler(adapter);
+	if (cause & SGE)
+		sge_intr_handler(adapter);
+	if (cause & ULP_TX)
+		ulptx_intr_handler(adapter);
+
+	/* Clear the interrupts just processed for which we are the master. */
+	t4_write_reg(adapter, PL_INT_CAUSE, cause & GLBL_INTR_MASK);
+	(void) t4_read_reg(adapter, PL_INT_CAUSE); /* flush */
+	return 1;
+}
+
+/**
+ *	t4_intr_enable - enable interrupts
+ *	@adapter: the adapter whose interrupts should be enabled
+ *
+ *	Enable PF-specific interrupts for the calling function and the top-level
+ *	interrupt concentrator for global interrupts.  Interrupts are already
+ *	enabled at each module,	here we just enable the roots of the interrupt
+ *	hierarchies.
+ *
+ *	Note: this function should be called only when the driver manages
+ *	non PF-specific interrupts from the various HW modules.  Only one PCI
+ *	function at a time should be doing this.
+ */
+void t4_intr_enable(struct adapter *adapter)
+{
+	u32 pf = SOURCEPF_GET(t4_read_reg(adapter, PL_WHOAMI));
+
+	t4_write_reg(adapter, SGE_INT_ENABLE3, ERR_CPL_EXCEED_IQE_SIZE |
+		     ERR_INVALID_CIDX_INC | ERR_CPL_OPCODE_0 |
+		     ERR_DROPPED_DB | ERR_DATA_CPL_ON_HIGH_QID1 |
+		     ERR_DATA_CPL_ON_HIGH_QID0 | ERR_BAD_DB_PIDX3 |
+		     ERR_BAD_DB_PIDX2 | ERR_BAD_DB_PIDX1 |
+		     ERR_BAD_DB_PIDX0 | ERR_ING_CTXT_PRIO |
+		     ERR_EGR_CTXT_PRIO | INGRESS_SIZE_ERR |
+		     EGRESS_SIZE_ERR);
+	t4_write_reg(adapter, MYPF_REG(PL_PF_INT_ENABLE), PF_INTR_MASK);
+	t4_set_reg_field(adapter, PL_INT_MAP0, 0, 1 << pf);
+}
+
+/**
+ *	t4_intr_disable - disable interrupts
+ *	@adapter: the adapter whose interrupts should be disabled
+ *
+ *	Disable interrupts.  We only disable the top-level interrupt
+ *	concentrators.  The caller must be a PCI function managing global
+ *	interrupts.
+ */
+void t4_intr_disable(struct adapter *adapter)
+{
+	u32 pf = SOURCEPF_GET(t4_read_reg(adapter, PL_WHOAMI));
+
+	t4_write_reg(adapter, MYPF_REG(PL_PF_INT_ENABLE), 0);
+	t4_set_reg_field(adapter, PL_INT_MAP0, 1 << pf, 0);
+}
+
+/**
+ *	t4_intr_clear - clear all interrupts
+ *	@adapter: the adapter whose interrupts should be cleared
+ *
+ *	Clears all interrupts.  The caller must be a PCI function managing
+ *	global interrupts.
+ */
+void t4_intr_clear(struct adapter *adapter)
+{
+	static const unsigned int cause_reg[] = {
+		SGE_INT_CAUSE1, SGE_INT_CAUSE2, SGE_INT_CAUSE3,
+		PCIE_CORE_UTL_SYSTEM_BUS_AGENT_STATUS,
+		PCIE_CORE_UTL_PCI_EXPRESS_PORT_STATUS,
+		PCIE_NONFAT_ERR, PCIE_INT_CAUSE,
+		MC_INT_CAUSE,
+		MA_INT_WRAP_STATUS, MA_PARITY_ERROR_STATUS, MA_INT_CAUSE,
+		EDC_INT_CAUSE, EDC_REG(EDC_INT_CAUSE, 1),
+		CIM_HOST_INT_CAUSE, CIM_HOST_UPACC_INT_CAUSE,
+		MYPF_REG(CIM_PF_HOST_INT_CAUSE),
+		TP_INT_CAUSE,
+		ULP_RX_INT_CAUSE, ULP_TX_INT_CAUSE,
+		PM_RX_INT_CAUSE, PM_TX_INT_CAUSE,
+		MPS_RX_PERR_INT_CAUSE,
+		CPL_INTR_CAUSE,
+		MYPF_REG(PL_PF_INT_CAUSE),
+		PL_PL_INT_CAUSE,
+		LE_DB_INT_CAUSE,
+	};
+
+	unsigned int i;
+
+	for (i = 0; i < ARRAY_SIZE(cause_reg); ++i)
+		t4_write_reg(adapter, cause_reg[i], 0xffffffff);
+
+	t4_write_reg(adapter, PL_INT_CAUSE, GLBL_INTR_MASK);
+	(void) t4_read_reg(adapter, PL_INT_CAUSE);          /* flush */
+}
+
+/**
+ *	hash_mac_addr - return the hash value of a MAC address
+ *	@addr: the 48-bit Ethernet MAC address
+ *
+ *	Hashes a MAC address according to the hash function used by HW inexact
+ *	(hash) address matching.
+ */
+static int hash_mac_addr(const u8 *addr)
+{
+	u32 a = ((u32)addr[0] << 16) | ((u32)addr[1] << 8) | addr[2];
+	u32 b = ((u32)addr[3] << 16) | ((u32)addr[4] << 8) | addr[5];
+	a ^= b;
+	a ^= (a >> 12);
+	a ^= (a >> 6);
+	return a & 0x3f;
+}
+
+/**
+ *	t4_config_rss_range - configure a portion of the RSS mapping table
+ *	@adapter: the adapter
+ *	@mbox: mbox to use for the FW command
+ *	@viid: virtual interface whose RSS subtable is to be written
+ *	@start: start entry in the table to write
+ *	@n: how many table entries to write
+ *	@rspq: values for the response queue lookup table
+ *	@nrspq: number of values in @rspq
+ *
+ *	Programs the selected part of the VI's RSS mapping table with the
+ *	provided values.  If @nrspq < @n the supplied values are used repeatedly
+ *	until the full table range is populated.
+ *
+ *	The caller must ensure the values in @rspq are in the range allowed for
+ *	@viid.
+ */
+int t4_config_rss_range(struct adapter *adapter, int mbox, unsigned int viid,
+			int start, int n, const u16 *rspq, unsigned int nrspq)
+{
+	int ret;
+	const u16 *rsp = rspq;
+	const u16 *rsp_end = rspq + nrspq;
+	struct fw_rss_ind_tbl_cmd cmd;
+
+	memset(&cmd, 0, sizeof(cmd));
+	cmd.op_to_viid = htonl(FW_CMD_OP(FW_RSS_IND_TBL_CMD) |
+			       FW_CMD_REQUEST | FW_CMD_WRITE |
+			       FW_RSS_IND_TBL_CMD_VIID(viid));
+	cmd.retval_len16 = htonl(FW_LEN16(cmd));
+
+	/* each fw_rss_ind_tbl_cmd takes up to 32 entries */
+	while (n > 0) {
+		int nq = min(n, 32);
+		__be32 *qp = &cmd.iq0_to_iq2;
+
+		cmd.niqid = htons(nq);
+		cmd.startidx = htons(start);
+
+		start += nq;
+		n -= nq;
+
+		while (nq > 0) {
+			unsigned int v;
+
+			v = FW_RSS_IND_TBL_CMD_IQ0(*rsp);
+			if (++rsp >= rsp_end)
+				rsp = rspq;
+			v |= FW_RSS_IND_TBL_CMD_IQ1(*rsp);
+			if (++rsp >= rsp_end)
+				rsp = rspq;
+			v |= FW_RSS_IND_TBL_CMD_IQ2(*rsp);
+			if (++rsp >= rsp_end)
+				rsp = rspq;
+
+			*qp++ = htonl(v);
+			nq -= 3;
+		}
+
+		ret = t4_wr_mbox(adapter, mbox, &cmd, sizeof(cmd), NULL);
+		if (ret)
+			return ret;
+	}
+	return 0;
+}
+
+/**
+ *	t4_config_glbl_rss - configure the global RSS mode
+ *	@adapter: the adapter
+ *	@mbox: mbox to use for the FW command
+ *	@mode: global RSS mode
+ *	@flags: mode-specific flags
+ *
+ *	Sets the global RSS mode.
+ */
+int t4_config_glbl_rss(struct adapter *adapter, int mbox, unsigned int mode,
+		       unsigned int flags)
+{
+	struct fw_rss_glb_config_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_write = htonl(FW_CMD_OP(FW_RSS_GLB_CONFIG_CMD) |
+			      FW_CMD_REQUEST | FW_CMD_WRITE);
+	c.retval_len16 = htonl(FW_LEN16(c));
+	if (mode == FW_RSS_GLB_CONFIG_CMD_MODE_MANUAL) {
+		c.u.manual.mode_pkd = htonl(FW_RSS_GLB_CONFIG_CMD_MODE(mode));
+	} else if (mode == FW_RSS_GLB_CONFIG_CMD_MODE_BASICVIRTUAL) {
+		c.u.basicvirtual.mode_pkd =
+			htonl(FW_RSS_GLB_CONFIG_CMD_MODE(mode));
+		c.u.basicvirtual.synmapen_to_hashtoeplitz = htonl(flags);
+	} else
+		return -EINVAL;
+	return t4_wr_mbox(adapter, mbox, &c, sizeof(c), NULL);
+}
+
+/* Read an RSS table row */
+static int rd_rss_row(struct adapter *adap, int row, u32 *val)
+{
+	t4_write_reg(adap, TP_RSS_LKP_TABLE, 0xfff00000 | row);
+	return t4_wait_op_done_val(adap, TP_RSS_LKP_TABLE, LKPTBLROWVLD, 1,
+				   5, 0, val);
+}
+
+/**
+ *	t4_read_rss - read the contents of the RSS mapping table
+ *	@adapter: the adapter
+ *	@map: holds the contents of the RSS mapping table
+ *
+ *	Reads the contents of the RSS hash->queue mapping table.
+ */
+int t4_read_rss(struct adapter *adapter, u16 *map)
+{
+	u32 val;
+	int i, ret;
+
+	for (i = 0; i < RSS_NENTRIES / 2; ++i) {
+		ret = rd_rss_row(adapter, i, &val);
+		if (ret)
+			return ret;
+		*map++ = LKPTBLQUEUE0_GET(val);
+		*map++ = LKPTBLQUEUE1_GET(val);
+	}
+	return 0;
+}
+
+/**
+ *	t4_tp_get_tcp_stats - read TP's TCP MIB counters
+ *	@adap: the adapter
+ *	@v4: holds the TCP/IP counter values
+ *	@v6: holds the TCP/IPv6 counter values
+ *
+ *	Returns the values of TP's TCP/IP and TCP/IPv6 MIB counters.
+ *	Either @v4 or @v6 may be %NULL to skip the corresponding stats.
+ */
+void t4_tp_get_tcp_stats(struct adapter *adap, struct tp_tcp_stats *v4,
+			 struct tp_tcp_stats *v6)
+{
+	u32 val[TP_MIB_TCP_RXT_SEG_LO - TP_MIB_TCP_OUT_RST + 1];
+
+#define STAT_IDX(x) ((TP_MIB_TCP_##x) - TP_MIB_TCP_OUT_RST)
+#define STAT(x)     val[STAT_IDX(x)]
+#define STAT64(x)   (((u64)STAT(x##_HI) << 32) | STAT(x##_LO))
+
+	if (v4) {
+		t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, val,
+				 ARRAY_SIZE(val), TP_MIB_TCP_OUT_RST);
+		v4->tcpOutRsts = STAT(OUT_RST);
+		v4->tcpInSegs  = STAT64(IN_SEG);
+		v4->tcpOutSegs = STAT64(OUT_SEG);
+		v4->tcpRetransSegs = STAT64(RXT_SEG);
+	}
+	if (v6) {
+		t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, val,
+				 ARRAY_SIZE(val), TP_MIB_TCP_V6OUT_RST);
+		v6->tcpOutRsts = STAT(OUT_RST);
+		v6->tcpInSegs  = STAT64(IN_SEG);
+		v6->tcpOutSegs = STAT64(OUT_SEG);
+		v6->tcpRetransSegs = STAT64(RXT_SEG);
+	}
+#undef STAT64
+#undef STAT
+#undef STAT_IDX
+}
+
+/**
+ *	t4_tp_get_err_stats - read TP's error MIB counters
+ *	@adap: the adapter
+ *	@st: holds the counter values
+ *
+ *	Returns the values of TP's error counters.
+ */
+void t4_tp_get_err_stats(struct adapter *adap, struct tp_err_stats *st)
+{
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, st->macInErrs,
+			 12, TP_MIB_MAC_IN_ERR_0);
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, st->tnlCongDrops,
+			 8, TP_MIB_TNL_CNG_DROP_0);
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, st->tnlTxDrops,
+			 4, TP_MIB_TNL_DROP_0);
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, st->ofldVlanDrops,
+			 4, TP_MIB_OFD_VLN_DROP_0);
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, st->tcp6InErrs,
+			 4, TP_MIB_TCP_V6IN_ERR_0);
+	t4_read_indirect(adap, TP_MIB_INDEX, TP_MIB_DATA, &st->ofldNoNeigh,
+			 2, TP_MIB_OFD_ARP_DROP);
+}
+
+/**
+ *	t4_read_mtu_tbl - returns the values in the HW path MTU table
+ *	@adap: the adapter
+ *	@mtus: where to store the MTU values
+ *	@mtu_log: where to store the MTU base-2 log (may be %NULL)
+ *
+ *	Reads the HW path MTU table.
+ */
+void t4_read_mtu_tbl(struct adapter *adap, u16 *mtus, u8 *mtu_log)
+{
+	u32 v;
+	int i;
+
+	for (i = 0; i < NMTUS; ++i) {
+		t4_write_reg(adap, TP_MTU_TABLE,
+			     MTUINDEX(0xff) | MTUVALUE(i));
+		v = t4_read_reg(adap, TP_MTU_TABLE);
+		mtus[i] = MTUVALUE_GET(v);
+		if (mtu_log)
+			mtu_log[i] = MTUWIDTH_GET(v);
+	}
+}
+
+/**
+ *	init_cong_ctrl - initialize congestion control parameters
+ *	@a: the alpha values for congestion control
+ *	@b: the beta values for congestion control
+ *
+ *	Initialize the congestion control parameters.
+ */
+static void __devinit init_cong_ctrl(unsigned short *a, unsigned short *b)
+{
+	a[0] = a[1] = a[2] = a[3] = a[4] = a[5] = a[6] = a[7] = a[8] = 1;
+	a[9] = 2;
+	a[10] = 3;
+	a[11] = 4;
+	a[12] = 5;
+	a[13] = 6;
+	a[14] = 7;
+	a[15] = 8;
+	a[16] = 9;
+	a[17] = 10;
+	a[18] = 14;
+	a[19] = 17;
+	a[20] = 21;
+	a[21] = 25;
+	a[22] = 30;
+	a[23] = 35;
+	a[24] = 45;
+	a[25] = 60;
+	a[26] = 80;
+	a[27] = 100;
+	a[28] = 200;
+	a[29] = 300;
+	a[30] = 400;
+	a[31] = 500;
+
+	b[0] = b[1] = b[2] = b[3] = b[4] = b[5] = b[6] = b[7] = b[8] = 0;
+	b[9] = b[10] = 1;
+	b[11] = b[12] = 2;
+	b[13] = b[14] = b[15] = b[16] = 3;
+	b[17] = b[18] = b[19] = b[20] = b[21] = 4;
+	b[22] = b[23] = b[24] = b[25] = b[26] = b[27] = 5;
+	b[28] = b[29] = 6;
+	b[30] = b[31] = 7;
+}
+
+/* The minimum additive increment value for the congestion control table */
+#define CC_MIN_INCR 2U
+
+/**
+ *	t4_load_mtus - write the MTU and congestion control HW tables
+ *	@adap: the adapter
+ *	@mtus: the values for the MTU table
+ *	@alpha: the values for the congestion control alpha parameter
+ *	@beta: the values for the congestion control beta parameter
+ *
+ *	Write the HW MTU table with the supplied MTUs and the high-speed
+ *	congestion control table with the supplied alpha, beta, and MTUs.
+ *	We write the two tables together because the additive increments
+ *	depend on the MTUs.
+ */
+void t4_load_mtus(struct adapter *adap, const unsigned short *mtus,
+		  const unsigned short *alpha, const unsigned short *beta)
+{
+	static const unsigned int avg_pkts[NCCTRL_WIN] = {
+		2, 6, 10, 14, 20, 28, 40, 56, 80, 112, 160, 224, 320, 448, 640,
+		896, 1281, 1792, 2560, 3584, 5120, 7168, 10240, 14336, 20480,
+		28672, 40960, 57344, 81920, 114688, 163840, 229376
+	};
+
+	unsigned int i, w;
+
+	for (i = 0; i < NMTUS; ++i) {
+		unsigned int mtu = mtus[i];
+		unsigned int log2 = fls(mtu);
+
+		if (!(mtu & ((1 << log2) >> 2)))     /* round */
+			log2--;
+		t4_write_reg(adap, TP_MTU_TABLE, MTUINDEX(i) |
+			     MTUWIDTH(log2) | MTUVALUE(mtu));
+
+		for (w = 0; w < NCCTRL_WIN; ++w) {
+			unsigned int inc;
+
+			inc = max(((mtu - 40) * alpha[w]) / avg_pkts[w],
+				  CC_MIN_INCR);
+
+			t4_write_reg(adap, TP_CCTRL_TABLE, (i << 21) |
+				     (w << 16) | (beta[w] << 13) | inc);
+		}
+	}
+}
+
+/**
+ *	t4_set_trace_filter - configure one of the tracing filters
+ *	@adap: the adapter
+ *	@tp: the desired trace filter parameters
+ *	@idx: which filter to configure
+ *	@enable: whether to enable or disable the filter
+ *
+ *	Configures one of the tracing filters available in HW.  If @enable is
+ *	%0 @tp is not examined and may be %NULL.
+ */
+int t4_set_trace_filter(struct adapter *adap, const struct trace_params *tp,
+			int idx, int enable)
+{
+	int i, ofst = idx * 4;
+	u32 data_reg, mask_reg, cfg;
+	u32 multitrc = TRCMULTIFILTER;
+
+	if (!enable) {
+		t4_write_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + ofst, 0);
+		goto out;
+	}
+
+	if (tp->port > 11 || tp->invert > 1 || tp->skip_len > 0x1f ||
+	    tp->skip_ofst > 0x1f || tp->min_len > 0x1ff ||
+	    tp->snap_len > 9600 || (idx && tp->snap_len > 256))
+		return -EINVAL;
+
+	if (tp->snap_len > 256) {            /* must be tracer 0 */
+		if ((t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + 4) |
+		     t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + 8) |
+		     t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + 12)) & TFEN)
+			return -EINVAL;  /* other tracers are enabled */
+		multitrc = 0;
+	} else if (idx) {
+		i = t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_B);
+		if (TFCAPTUREMAX_GET(i) > 256 &&
+		    (t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A) & TFEN))
+			return -EINVAL;
+	}
+
+	/* stop the tracer we'll be changing */
+	t4_write_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + ofst, 0);
+
+	/* disable tracing globally if running in the wrong single/multi mode */
+	cfg = t4_read_reg(adap, MPS_TRC_CFG);
+	if ((cfg & TRCEN) && multitrc != (cfg & TRCMULTIFILTER)) {
+		t4_write_reg(adap, MPS_TRC_CFG, cfg ^ TRCEN);
+		t4_read_reg(adap, MPS_TRC_CFG);                  /* flush */
+		msleep(1);
+		if (!(t4_read_reg(adap, MPS_TRC_CFG) & TRCFIFOEMPTY))
+			return -ETIMEDOUT;
+	}
+	/*
+	 * At this point either the tracing is enabled and in the right mode or
+	 * disabled.
+	 */
+
+	idx *= (MPS_TRC_FILTER1_MATCH - MPS_TRC_FILTER0_MATCH);
+	data_reg = MPS_TRC_FILTER0_MATCH + idx;
+	mask_reg = MPS_TRC_FILTER0_DONT_CARE + idx;
+
+	for (i = 0; i < TRACE_LEN / 4; i++, data_reg += 4, mask_reg += 4) {
+		t4_write_reg(adap, data_reg, tp->data[i]);
+		t4_write_reg(adap, mask_reg, ~tp->mask[i]);
+	}
+	t4_write_reg(adap, MPS_TRC_FILTER_MATCH_CTL_B + ofst,
+		     TFCAPTUREMAX(tp->snap_len) |
+		     TFMINPKTSIZE(tp->min_len));
+	t4_write_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + ofst,
+		     TFOFFSET(tp->skip_ofst) | TFLENGTH(tp->skip_len) |
+		     TFPORT(tp->port) | TFEN |
+		     (tp->invert ? TFINVERTMATCH : 0));
+
+	cfg &= ~TRCMULTIFILTER;
+	t4_write_reg(adap, MPS_TRC_CFG, cfg | TRCEN | multitrc);
+out:	t4_read_reg(adap, MPS_TRC_CFG);  /* flush */
+	return 0;
+}
+
+/**
+ *	t4_get_trace_filter - query one of the tracing filters
+ *	@adap: the adapter
+ *	@tp: the current trace filter parameters
+ *	@idx: which trace filter to query
+ *	@enabled: non-zero if the filter is enabled
+ *
+ *	Returns the current settings of one of the HW tracing filters.
+ */
+void t4_get_trace_filter(struct adapter *adap, struct trace_params *tp, int idx,
+			 int *enabled)
+{
+	u32 ctla, ctlb;
+	int i, ofst = idx * 4;
+	u32 data_reg, mask_reg;
+
+	ctla = t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_A + ofst);
+	ctlb = t4_read_reg(adap, MPS_TRC_FILTER_MATCH_CTL_B + ofst);
+
+	*enabled = !!(ctla & TFEN);
+	tp->snap_len = TFCAPTUREMAX_GET(ctlb);
+	tp->min_len = TFMINPKTSIZE_GET(ctlb);
+	tp->skip_ofst = TFOFFSET_GET(ctla);
+	tp->skip_len = TFLENGTH_GET(ctla);
+	tp->invert = !!(ctla & TFINVERTMATCH);
+	tp->port = TFPORT_GET(ctla);
+
+	ofst = (MPS_TRC_FILTER1_MATCH - MPS_TRC_FILTER0_MATCH) * idx;
+	data_reg = MPS_TRC_FILTER0_MATCH + ofst;
+	mask_reg = MPS_TRC_FILTER0_DONT_CARE + ofst;
+
+	for (i = 0; i < TRACE_LEN / 4; i++, data_reg += 4, mask_reg += 4) {
+		tp->mask[i] = ~t4_read_reg(adap, mask_reg);
+		tp->data[i] = t4_read_reg(adap, data_reg) & tp->mask[i];
+	}
+}
+
+/**
+ *	get_mps_bg_map - return the buffer groups associated with a port
+ *	@adap: the adapter
+ *	@idx: the port index
+ *
+ *	Returns a bitmap indicating which MPS buffer groups are associated
+ *	with the given port.  Bit i is set if buffer group i is used by the
+ *	port.
+ */
+static unsigned int get_mps_bg_map(struct adapter *adap, int idx)
+{
+	u32 n = NUMPORTS_GET(t4_read_reg(adap, MPS_CMN_CTL));
+
+	if (n == 0)
+		return idx == 0 ? 0xf : 0;
+	if (n == 1)
+		return idx < 2 ? (3 << (2 * idx)) : 0;
+	return 1 << idx;
+}
+
+/**
+ *	t4_get_port_stats - collect port statistics
+ *	@adap: the adapter
+ *	@idx: the port index
+ *	@p: the stats structure to fill
+ *
+ *	Collect statistics related to the given port from HW.
+ */
+void t4_get_port_stats(struct adapter *adap, int idx, struct port_stats *p)
+{
+	u32 bgmap = get_mps_bg_map(adap, idx);
+
+#define GET_STAT(name) \
+	t4_read_reg64(adap, PORT_REG(idx, MPS_PORT_STAT_##name##_L))
+#define GET_STAT_COM(name) t4_read_reg64(adap, MPS_STAT_##name##_L)
+
+	p->tx_octets           = GET_STAT(TX_PORT_BYTES);
+	p->tx_frames           = GET_STAT(TX_PORT_FRAMES);
+	p->tx_bcast_frames     = GET_STAT(TX_PORT_BCAST);
+	p->tx_mcast_frames     = GET_STAT(TX_PORT_MCAST);
+	p->tx_ucast_frames     = GET_STAT(TX_PORT_UCAST);
+	p->tx_error_frames     = GET_STAT(TX_PORT_ERROR);
+	p->tx_frames_64        = GET_STAT(TX_PORT_64B);
+	p->tx_frames_65_127    = GET_STAT(TX_PORT_65B_127B);
+	p->tx_frames_128_255   = GET_STAT(TX_PORT_128B_255B);
+	p->tx_frames_256_511   = GET_STAT(TX_PORT_256B_511B);
+	p->tx_frames_512_1023  = GET_STAT(TX_PORT_512B_1023B);
+	p->tx_frames_1024_1518 = GET_STAT(TX_PORT_1024B_1518B);
+	p->tx_frames_1519_max  = GET_STAT(TX_PORT_1519B_MAX);
+	p->tx_drop             = GET_STAT(TX_PORT_DROP);
+	p->tx_pause            = GET_STAT(TX_PORT_PAUSE);
+	p->tx_ppp0             = GET_STAT(TX_PORT_PPP0);
+	p->tx_ppp1             = GET_STAT(TX_PORT_PPP1);
+	p->tx_ppp2             = GET_STAT(TX_PORT_PPP2);
+	p->tx_ppp3             = GET_STAT(TX_PORT_PPP3);
+	p->tx_ppp4             = GET_STAT(TX_PORT_PPP4);
+	p->tx_ppp5             = GET_STAT(TX_PORT_PPP5);
+	p->tx_ppp6             = GET_STAT(TX_PORT_PPP6);
+	p->tx_ppp7             = GET_STAT(TX_PORT_PPP7);
+
+	p->rx_octets           = GET_STAT(RX_PORT_BYTES);
+	p->rx_frames           = GET_STAT(RX_PORT_FRAMES);
+	p->rx_bcast_frames     = GET_STAT(RX_PORT_BCAST);
+	p->rx_mcast_frames     = GET_STAT(RX_PORT_MCAST);
+	p->rx_ucast_frames     = GET_STAT(RX_PORT_UCAST);
+	p->rx_too_long         = GET_STAT(RX_PORT_MTU_ERROR);
+	p->rx_jabber           = GET_STAT(RX_PORT_MTU_CRC_ERROR);
+	p->rx_fcs_err          = GET_STAT(RX_PORT_CRC_ERROR);
+	p->rx_len_err          = GET_STAT(RX_PORT_LEN_ERROR);
+	p->rx_symbol_err       = GET_STAT(RX_PORT_SYM_ERROR);
+	p->rx_runt             = GET_STAT(RX_PORT_LESS_64B);
+	p->rx_frames_64        = GET_STAT(RX_PORT_64B);
+	p->rx_frames_65_127    = GET_STAT(RX_PORT_65B_127B);
+	p->rx_frames_128_255   = GET_STAT(RX_PORT_128B_255B);
+	p->rx_frames_256_511   = GET_STAT(RX_PORT_256B_511B);
+	p->rx_frames_512_1023  = GET_STAT(RX_PORT_512B_1023B);
+	p->rx_frames_1024_1518 = GET_STAT(RX_PORT_1024B_1518B);
+	p->rx_frames_1519_max  = GET_STAT(RX_PORT_1519B_MAX);
+	p->rx_pause            = GET_STAT(RX_PORT_PAUSE);
+	p->rx_ppp0             = GET_STAT(RX_PORT_PPP0);
+	p->rx_ppp1             = GET_STAT(RX_PORT_PPP1);
+	p->rx_ppp2             = GET_STAT(RX_PORT_PPP2);
+	p->rx_ppp3             = GET_STAT(RX_PORT_PPP3);
+	p->rx_ppp4             = GET_STAT(RX_PORT_PPP4);
+	p->rx_ppp5             = GET_STAT(RX_PORT_PPP5);
+	p->rx_ppp6             = GET_STAT(RX_PORT_PPP6);
+	p->rx_ppp7             = GET_STAT(RX_PORT_PPP7);
+
+	p->rx_ovflow0 = (bgmap & 1) ? GET_STAT_COM(RX_BG_0_MAC_DROP_FRAME) : 0;
+	p->rx_ovflow1 = (bgmap & 2) ? GET_STAT_COM(RX_BG_1_MAC_DROP_FRAME) : 0;
+	p->rx_ovflow2 = (bgmap & 4) ? GET_STAT_COM(RX_BG_2_MAC_DROP_FRAME) : 0;
+	p->rx_ovflow3 = (bgmap & 8) ? GET_STAT_COM(RX_BG_3_MAC_DROP_FRAME) : 0;
+	p->rx_trunc0 = (bgmap & 1) ? GET_STAT_COM(RX_BG_0_MAC_TRUNC_FRAME) : 0;
+	p->rx_trunc1 = (bgmap & 2) ? GET_STAT_COM(RX_BG_1_MAC_TRUNC_FRAME) : 0;
+	p->rx_trunc2 = (bgmap & 4) ? GET_STAT_COM(RX_BG_2_MAC_TRUNC_FRAME) : 0;
+	p->rx_trunc3 = (bgmap & 8) ? GET_STAT_COM(RX_BG_3_MAC_TRUNC_FRAME) : 0;
+
+#undef GET_STAT
+#undef GET_STAT_COM
+}
+
+/**
+ *	t4_get_lb_stats - collect loopback port statistics
+ *	@adap: the adapter
+ *	@idx: the loopback port index
+ *	@p: the stats structure to fill
+ *
+ *	Return HW statistics for the given loopback port.
+ */
+void t4_get_lb_stats(struct adapter *adap, int idx, struct lb_port_stats *p)
+{
+	u32 bgmap = get_mps_bg_map(adap, idx);
+
+#define GET_STAT(name) \
+	t4_read_reg64(adap, PORT_REG(idx, MPS_PORT_STAT_LB_PORT_##name##_L))
+#define GET_STAT_COM(name) t4_read_reg64(adap, MPS_STAT_##name##_L)
+
+	p->octets           = GET_STAT(BYTES);
+	p->frames           = GET_STAT(FRAMES);
+	p->bcast_frames     = GET_STAT(BCAST);
+	p->mcast_frames     = GET_STAT(MCAST);
+	p->ucast_frames     = GET_STAT(UCAST);
+	p->error_frames     = GET_STAT(ERROR);
+
+	p->frames_64        = GET_STAT(64B);
+	p->frames_65_127    = GET_STAT(65B_127B);
+	p->frames_128_255   = GET_STAT(128B_255B);
+	p->frames_256_511   = GET_STAT(256B_511B);
+	p->frames_512_1023  = GET_STAT(512B_1023B);
+	p->frames_1024_1518 = GET_STAT(1024B_1518B);
+	p->frames_1519_max  = GET_STAT(1519B_MAX);
+	p->drop             = t4_read_reg(adap, PORT_REG(idx,
+					  MPS_PORT_STAT_LB_PORT_DROP_FRAMES));
+
+	p->ovflow0 = (bgmap & 1) ? GET_STAT_COM(RX_BG_0_LB_DROP_FRAME) : 0;
+	p->ovflow1 = (bgmap & 2) ? GET_STAT_COM(RX_BG_1_LB_DROP_FRAME) : 0;
+	p->ovflow2 = (bgmap & 4) ? GET_STAT_COM(RX_BG_2_LB_DROP_FRAME) : 0;
+	p->ovflow3 = (bgmap & 8) ? GET_STAT_COM(RX_BG_3_LB_DROP_FRAME) : 0;
+	p->trunc0 = (bgmap & 1) ? GET_STAT_COM(RX_BG_0_LB_TRUNC_FRAME) : 0;
+	p->trunc1 = (bgmap & 2) ? GET_STAT_COM(RX_BG_1_LB_TRUNC_FRAME) : 0;
+	p->trunc2 = (bgmap & 4) ? GET_STAT_COM(RX_BG_2_LB_TRUNC_FRAME) : 0;
+	p->trunc3 = (bgmap & 8) ? GET_STAT_COM(RX_BG_3_LB_TRUNC_FRAME) : 0;
+
+#undef GET_STAT
+#undef GET_STAT_COM
+}
+
+/**
+ *	t4_wol_magic_enable - enable/disable magic packet WoL
+ *	@adap: the adapter
+ *	@port: the physical port index
+ *	@addr: MAC address expected in magic packets, %NULL to disable
+ *
+ *	Enables/disables magic packet wake-on-LAN for the selected port.
+ */
+void t4_wol_magic_enable(struct adapter *adap, unsigned int port,
+			 const u8 *addr)
+{
+	if (addr) {
+		t4_write_reg(adap, PORT_REG(port, XGMAC_PORT_MAGIC_MACID_LO),
+			     (addr[2] << 24) | (addr[3] << 16) |
+			     (addr[4] << 8) | addr[5]);
+		t4_write_reg(adap, PORT_REG(port, XGMAC_PORT_MAGIC_MACID_HI),
+			     (addr[0] << 8) | addr[1]);
+	}
+	t4_set_reg_field(adap, PORT_REG(port, XGMAC_PORT_CFG2), MAGICEN,
+			 addr ? MAGICEN : 0);
+}
+
+/**
+ *	t4_wol_pat_enable - enable/disable pattern-based WoL
+ *	@adap: the adapter
+ *	@port: the physical port index
+ *	@map: bitmap of which HW pattern filters to set
+ *	@mask0: byte mask for bytes 0-63 of a packet
+ *	@mask1: byte mask for bytes 64-127 of a packet
+ *	@crc: Ethernet CRC for selected bytes
+ *	@enable: enable/disable switch
+ *
+ *	Sets the pattern filters indicated in @map to mask out the bytes
+ *	specified in @mask0/@mask1 in received packets and compare the CRC of
+ *	the resulting packet against @crc.  If @enable is %true pattern-based
+ *	WoL is enabled, otherwise disabled.
+ */
+int t4_wol_pat_enable(struct adapter *adap, unsigned int port, unsigned int map,
+		      u64 mask0, u64 mask1, unsigned int crc, bool enable)
+{
+	int i;
+
+	if (!enable) {
+		t4_set_reg_field(adap, PORT_REG(port, XGMAC_PORT_CFG2),
+				 PATEN, 0);
+		return 0;
+	}
+	if (map > 0xff)
+		return -EINVAL;
+
+#define EPIO_REG(name) PORT_REG(port, XGMAC_PORT_EPIO_##name)
+
+	t4_write_reg(adap, EPIO_REG(DATA1), mask0 >> 32);
+	t4_write_reg(adap, EPIO_REG(DATA2), mask1);
+	t4_write_reg(adap, EPIO_REG(DATA3), mask1 >> 32);
+
+	for (i = 0; i < NWOL_PAT; i++, map >>= 1) {
+		if (!(map & 1))
+			continue;
+
+		/* write byte masks */
+		t4_write_reg(adap, EPIO_REG(DATA0), mask0);
+		t4_write_reg(adap, EPIO_REG(OP), ADDRESS(i) | EPIOWR);
+		t4_read_reg(adap, EPIO_REG(OP));                /* flush */
+		if (t4_read_reg(adap, EPIO_REG(OP)) & BUSY)
+			return -ETIMEDOUT;
+
+		/* write CRC */
+		t4_write_reg(adap, EPIO_REG(DATA0), crc);
+		t4_write_reg(adap, EPIO_REG(OP), ADDRESS(i + 32) | EPIOWR);
+		t4_read_reg(adap, EPIO_REG(OP));                /* flush */
+		if (t4_read_reg(adap, EPIO_REG(OP)) & BUSY)
+			return -ETIMEDOUT;
+	}
+#undef EPIO_REG
+
+	t4_set_reg_field(adap, PORT_REG(port, XGMAC_PORT_CFG2), 0, PATEN);
+	return 0;
+}
+
+#define INIT_CMD(var, cmd, rd_wr) do { \
+	(var).op_to_write = htonl(FW_CMD_OP(FW_##cmd##_CMD) | \
+				  FW_CMD_REQUEST | FW_CMD_##rd_wr); \
+	(var).retval_len16 = htonl(FW_LEN16(var)); \
+} while (0)
+
+/**
+ *	t4_mdio_rd - read a PHY register through MDIO
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@phy_addr: the PHY address
+ *	@mmd: the PHY MMD to access (0 for clause 22 PHYs)
+ *	@reg: the register to read
+ *	@valp: where to store the value
+ *
+ *	Issues a FW command through the given mailbox to read a PHY register.
+ */
+int t4_mdio_rd(struct adapter *adap, unsigned int mbox, unsigned int phy_addr,
+	       unsigned int mmd, unsigned int reg, u16 *valp)
+{
+	int ret;
+	struct fw_ldst_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_addrspace = htonl(FW_CMD_OP(FW_LDST_CMD) | FW_CMD_REQUEST |
+		FW_CMD_READ | FW_LDST_CMD_ADDRSPACE(FW_LDST_ADDRSPC_MDIO));
+	c.cycles_to_len16 = htonl(FW_LEN16(c));
+	c.u.mdio.paddr_mmd = htons(FW_LDST_CMD_PADDR(phy_addr) |
+				   FW_LDST_CMD_MMD(mmd));
+	c.u.mdio.raddr = htons(reg);
+
+	ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+	if (ret == 0)
+		*valp = ntohs(c.u.mdio.rval);
+	return ret;
+}
+
+/**
+ *	t4_mdio_wr - write a PHY register through MDIO
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@phy_addr: the PHY address
+ *	@mmd: the PHY MMD to access (0 for clause 22 PHYs)
+ *	@reg: the register to write
+ *	@valp: value to write
+ *
+ *	Issues a FW command through the given mailbox to write a PHY register.
+ */
+int t4_mdio_wr(struct adapter *adap, unsigned int mbox, unsigned int phy_addr,
+	       unsigned int mmd, unsigned int reg, u16 val)
+{
+	struct fw_ldst_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_addrspace = htonl(FW_CMD_OP(FW_LDST_CMD) | FW_CMD_REQUEST |
+		FW_CMD_WRITE | FW_LDST_CMD_ADDRSPACE(FW_LDST_ADDRSPC_MDIO));
+	c.cycles_to_len16 = htonl(FW_LEN16(c));
+	c.u.mdio.paddr_mmd = htons(FW_LDST_CMD_PADDR(phy_addr) |
+				   FW_LDST_CMD_MMD(mmd));
+	c.u.mdio.raddr = htons(reg);
+	c.u.mdio.rval = htons(val);
+
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_fw_hello - establish communication with FW
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@evt_mbox: mailbox to receive async FW events
+ *	@master: specifies the caller's willingness to be the device master
+ *	@state: returns the current device state
+ *
+ *	Issues a command to establish communication with FW.
+ */
+int t4_fw_hello(struct adapter *adap, unsigned int mbox, unsigned int evt_mbox,
+		enum dev_master master, enum dev_state *state)
+{
+	int ret;
+	struct fw_hello_cmd c;
+
+	INIT_CMD(c, HELLO, WRITE);
+	c.err_to_mbasyncnot = htonl(
+		FW_HELLO_CMD_MASTERDIS(master == MASTER_CANT) |
+		FW_HELLO_CMD_MASTERFORCE(master == MASTER_MUST) |
+		FW_HELLO_CMD_MBMASTER(master == MASTER_MUST ? mbox : 0xff) |
+		FW_HELLO_CMD_MBASYNCNOT(evt_mbox));
+
+	ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+	if (ret == 0 && state) {
+		u32 v = ntohl(c.err_to_mbasyncnot);
+		if (v & FW_HELLO_CMD_INIT)
+			*state = DEV_STATE_INIT;
+		else if (v & FW_HELLO_CMD_ERR)
+			*state = DEV_STATE_ERR;
+		else
+			*state = DEV_STATE_UNINIT;
+	}
+	return ret;
+}
+
+/**
+ *	t4_fw_bye - end communication with FW
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *
+ *	Issues a command to terminate communication with FW.
+ */
+int t4_fw_bye(struct adapter *adap, unsigned int mbox)
+{
+	struct fw_bye_cmd c;
+
+	INIT_CMD(c, BYE, WRITE);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_init_cmd - ask FW to initialize the device
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *
+ *	Issues a command to FW to partially initialize the device.  This
+ *	performs initialization that generally doesn't depend on user input.
+ */
+int t4_early_init(struct adapter *adap, unsigned int mbox)
+{
+	struct fw_initialize_cmd c;
+
+	INIT_CMD(c, INITIALIZE, WRITE);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_fw_reset - issue a reset to FW
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@reset: specifies the type of reset to perform
+ *
+ *	Issues a reset command of the specified type to FW.
+ */
+int t4_fw_reset(struct adapter *adap, unsigned int mbox, int reset)
+{
+	struct fw_reset_cmd c;
+
+	INIT_CMD(c, RESET, WRITE);
+	c.val = htonl(reset);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_query_params - query FW or device parameters
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF
+ *	@vf: the VF
+ *	@nparams: the number of parameters
+ *	@params: the parameter names
+ *	@val: the parameter values
+ *
+ *	Reads the value of FW or device parameters.  Up to 7 parameters can be
+ *	queried at once.
+ */
+int t4_query_params(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int nparams, const u32 *params,
+		    u32 *val)
+{
+	int i, ret;
+	struct fw_params_cmd c;
+	__be32 *p = &c.param[0].mnem;
+
+	if (nparams > 7)
+		return -EINVAL;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_PARAMS_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_READ | FW_PARAMS_CMD_PFN(pf) |
+			    FW_PARAMS_CMD_VFN(vf));
+	c.retval_len16 = htonl(FW_LEN16(c));
+	for (i = 0; i < nparams; i++, p += 2)
+		*p = htonl(*params++);
+
+	ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+	if (ret == 0)
+		for (i = 0, p = &c.param[0].val; i < nparams; i++, p += 2)
+			*val++ = ntohl(*p);
+	return ret;
+}
+
+/**
+ *	t4_set_params - sets FW or device parameters
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF
+ *	@vf: the VF
+ *	@nparams: the number of parameters
+ *	@params: the parameter names
+ *	@val: the parameter values
+ *
+ *	Sets the value of FW or device parameters.  Up to 7 parameters can be
+ *	specified at once.
+ */
+int t4_set_params(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		  unsigned int vf, unsigned int nparams, const u32 *params,
+		  const u32 *val)
+{
+	struct fw_params_cmd c;
+	__be32 *p = &c.param[0].mnem;
+
+	if (nparams > 7)
+		return -EINVAL;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_PARAMS_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_PARAMS_CMD_PFN(pf) |
+			    FW_PARAMS_CMD_VFN(vf));
+	c.retval_len16 = htonl(FW_LEN16(c));
+	while (nparams--) {
+		*p++ = htonl(*params++);
+		*p++ = htonl(*val++);
+	}
+
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_cfg_pfvf - configure PF/VF resource limits
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF being configured
+ *	@vf: the VF being configured
+ *	@txq: the max number of egress queues
+ *	@txq_eth_ctrl: the max number of egress Ethernet or control queues
+ *	@rxqi: the max number of interrupt-capable ingress queues
+ *	@rxq: the max number of interruptless ingress queues
+ *	@tc: the PCI traffic class
+ *	@vi: the max number of virtual interfaces
+ *	@cmask: the channel access rights mask for the PF/VF
+ *	@pmask: the port access rights mask for the PF/VF
+ *	@nexact: the maximum number of exact MPS filters
+ *	@rcaps: read capabilities
+ *	@wxcaps: write/execute capabilities
+ *
+ *	Configures resource limits and capabilities for a physical or virtual
+ *	function.
+ */
+int t4_cfg_pfvf(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		unsigned int vf, unsigned int txq, unsigned int txq_eth_ctrl,
+		unsigned int rxqi, unsigned int rxq, unsigned int tc,
+		unsigned int vi, unsigned int cmask, unsigned int pmask,
+		unsigned int nexact, unsigned int rcaps, unsigned int wxcaps)
+{
+	struct fw_pfvf_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_PFVF_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_PFVF_CMD_PFN(pf) |
+			    FW_PFVF_CMD_VFN(vf));
+	c.retval_len16 = htonl(FW_LEN16(c));
+	c.niqflint_niq = htonl(FW_PFVF_CMD_NIQFLINT(rxqi) |
+			       FW_PFVF_CMD_NIQ(rxq));
+	c.cmask_to_neq = htonl(FW_PFVF_CMD_CMASK(cmask) |
+			       FW_PFVF_CMD_PMASK(pmask) |
+			       FW_PFVF_CMD_NEQ(txq));
+	c.tc_to_nexactf = htonl(FW_PFVF_CMD_TC(tc) | FW_PFVF_CMD_NVI(vi) |
+				FW_PFVF_CMD_NEXACTF(nexact));
+	c.r_caps_to_nethctrl = htonl(FW_PFVF_CMD_R_CAPS(rcaps) |
+				     FW_PFVF_CMD_WX_CAPS(wxcaps) |
+				     FW_PFVF_CMD_NETHCTRL(txq_eth_ctrl));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_alloc_vi - allocate a virtual interface
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@port: physical port associated with the VI
+ *	@pf: the PF owning the VI
+ *	@vf: the VF owning the VI
+ *	@nmac: number of MAC addresses needed (1 to 5)
+ *	@mac: the MAC addresses of the VI
+ *	@rss_size: size of RSS table slice associated with this VI
+ *
+ *	Allocates a virtual interface for the given physical port.  If @mac is
+ *	not %NULL it contains the MAC addresses of the VI as assigned by FW.
+ *	@mac should be large enough to hold @nmac Ethernet addresses, they are
+ *	stored consecutively so the space needed is @nmac * 6 bytes.
+ *	Returns a negative error number or the non-negative VI id.
+ */
+int t4_alloc_vi(struct adapter *adap, unsigned int mbox, unsigned int port,
+		unsigned int pf, unsigned int vf, unsigned int nmac, u8 *mac,
+		unsigned int *rss_size)
+{
+	int ret;
+	struct fw_vi_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_VI_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_WRITE | FW_CMD_EXEC |
+			    FW_VI_CMD_PFN(pf) | FW_VI_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_VI_CMD_ALLOC | FW_LEN16(c));
+	c.portid_pkd = FW_VI_CMD_PORTID(port);
+	c.nmac = nmac - 1;
+
+	ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+	if (ret)
+		return ret;
+
+	if (mac) {
+		memcpy(mac, c.mac, sizeof(c.mac));
+		switch (nmac) {
+		case 5:
+			memcpy(mac + 24, c.nmac3, sizeof(c.nmac3));
+		case 4:
+			memcpy(mac + 18, c.nmac2, sizeof(c.nmac2));
+		case 3:
+			memcpy(mac + 12, c.nmac1, sizeof(c.nmac1));
+		case 2:
+			memcpy(mac + 6,  c.nmac0, sizeof(c.nmac0));
+		}
+	}
+	if (rss_size)
+		*rss_size = FW_VI_CMD_RSSSIZE_GET(ntohs(c.rsssize_pkd));
+	return ntohs(c.viid_pkd);
+}
+
+/**
+ *	t4_free_vi - free a virtual interface
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF owning the VI
+ *	@vf: the VF owning the VI
+ *	@viid: virtual interface identifiler
+ *
+ *	Free a previously allocated virtual interface.
+ */
+int t4_free_vi(struct adapter *adap, unsigned int mbox, unsigned int pf,
+	       unsigned int vf, unsigned int viid)
+{
+	struct fw_vi_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_VI_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_VI_CMD_PFN(pf) |
+			    FW_VI_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_VI_CMD_FREE | FW_LEN16(c));
+	c.viid_pkd = htons(FW_VI_CMD_VIID(viid));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+}
+
+/**
+ *	t4_set_rxmode - set Rx properties of a virtual interface
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@mtu: the new MTU or -1
+ *	@promisc: 1 to enable promiscuous mode, 0 to disable it, -1 no change
+ *	@all_multi: 1 to enable all-multi mode, 0 to disable it, -1 no change
+ *	@bcast: 1 to enable broadcast Rx, 0 to disable it, -1 no change
+ *	@sleep_ok: if true we may sleep while awaiting command completion
+ *
+ *	Sets Rx properties of a virtual interface.
+ */
+int t4_set_rxmode(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		  int mtu, int promisc, int all_multi, int bcast, bool sleep_ok)
+{
+	struct fw_vi_rxmode_cmd c;
+
+	/* convert to FW values */
+	if (mtu < 0)
+		mtu = FW_RXMODE_MTU_NO_CHG;
+	if (promisc < 0)
+		promisc = FW_VI_RXMODE_CMD_PROMISCEN_MASK;
+	if (all_multi < 0)
+		all_multi = FW_VI_RXMODE_CMD_ALLMULTIEN_MASK;
+	if (bcast < 0)
+		bcast = FW_VI_RXMODE_CMD_BROADCASTEN_MASK;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_RXMODE_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_WRITE | FW_VI_RXMODE_CMD_VIID(viid));
+	c.retval_len16 = htonl(FW_LEN16(c));
+	c.mtu_to_broadcasten = htonl(FW_VI_RXMODE_CMD_MTU(mtu) |
+				     FW_VI_RXMODE_CMD_PROMISCEN(promisc) |
+				     FW_VI_RXMODE_CMD_ALLMULTIEN(all_multi) |
+				     FW_VI_RXMODE_CMD_BROADCASTEN(bcast));
+	return t4_wr_mbox_meat(adap, mbox, &c, sizeof(c), NULL, sleep_ok);
+}
+
+/**
+ *	t4_alloc_mac_filt - allocates exact-match filters for MAC addresses
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@free: if true any existing filters for this VI id are first removed
+ *	@naddr: the number of MAC addresses to allocate filters for (up to 7)
+ *	@addr: the MAC address(es)
+ *	@idx: where to store the index of each allocated filter
+ *	@hash: pointer to hash address filter bitmap
+ *	@sleep_ok: call is allowed to sleep
+ *
+ *	Allocates an exact-match filter for each of the supplied addresses and
+ *	sets it to the corresponding address.  If @idx is not %NULL it should
+ *	have at least @naddr entries, each of which will be set to the index of
+ *	the filter allocated for the corresponding MAC address.  If a filter
+ *	could not be allocated for an address its index is set to 0xffff.
+ *	If @hash is not %NULL addresses that fail to allocate an exact filter
+ *	are hashed and update the hash filter bitmap pointed at by @hash.
+ *
+ *	Returns a negative error number or the number of filters allocated.
+ */
+int t4_alloc_mac_filt(struct adapter *adap, unsigned int mbox,
+		      unsigned int viid, bool free, unsigned int naddr,
+		      const u8 **addr, u16 *idx, u64 *hash, bool sleep_ok)
+{
+	int i, ret;
+	struct fw_vi_mac_cmd c;
+	struct fw_vi_mac_exact *p;
+
+	if (naddr > 7)
+		return -EINVAL;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_MAC_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_WRITE | (free ? FW_CMD_EXEC : 0) |
+			     FW_VI_MAC_CMD_VIID(viid));
+	c.freemacs_to_len16 = htonl(FW_VI_MAC_CMD_FREEMACS(free) |
+				    FW_CMD_LEN16((naddr + 2) / 2));
+
+	for (i = 0, p = c.u.exact; i < naddr; i++, p++) {
+		p->valid_to_idx = htons(FW_VI_MAC_CMD_VALID |
+				      FW_VI_MAC_CMD_IDX(FW_VI_MAC_ADD_MAC));
+		memcpy(p->macaddr, addr[i], sizeof(p->macaddr));
+	}
+
+	ret = t4_wr_mbox_meat(adap, mbox, &c, sizeof(c), &c, sleep_ok);
+	if (ret)
+		return ret;
+
+	for (i = 0, p = c.u.exact; i < naddr; i++, p++) {
+		u16 index = FW_VI_MAC_CMD_IDX_GET(ntohs(p->valid_to_idx));
+
+		if (idx)
+			idx[i] = index >= NEXACT_MAC ? 0xffff : index;
+		if (index < NEXACT_MAC)
+			ret++;
+		else if (hash)
+			*hash |= (1 << hash_mac_addr(addr[i]));
+	}
+	return ret;
+}
+
+/**
+ *	t4_change_mac - modifies the exact-match filter for a MAC address
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@idx: index of existing filter for old value of MAC address, or -1
+ *	@addr: the new MAC address value
+ *	@persist: whether a new MAC allocation should be persistent
+ *	@add_smt: if true also add the address to the HW SMT
+ *
+ *	Modifies an exact-match filter and sets it to the new MAC address.
+ *	Note that in general it is not possible to modify the value of a given
+ *	filter so the generic way to modify an address filter is to free the one
+ *	being used by the old address value and allocate a new filter for the
+ *	new address value.  @idx can be -1 if the address is a new addition.
+ *
+ *	Returns a negative error number or the index of the filter with the new
+ *	MAC value.
+ */
+int t4_change_mac(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		  int idx, const u8 *addr, bool persist, bool add_smt)
+{
+	int ret, mode;
+	struct fw_vi_mac_cmd c;
+	struct fw_vi_mac_exact *p = c.u.exact;
+
+	if (idx < 0)                             /* new allocation */
+		idx = persist ? FW_VI_MAC_ADD_PERSIST_MAC : FW_VI_MAC_ADD_MAC;
+	mode = add_smt ? FW_VI_MAC_SMT_AND_MPSTCAM : FW_VI_MAC_MPS_TCAM_ENTRY;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_MAC_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_WRITE | FW_VI_MAC_CMD_VIID(viid));
+	c.freemacs_to_len16 = htonl(FW_CMD_LEN16(1));
+	p->valid_to_idx = htons(FW_VI_MAC_CMD_VALID |
+				FW_VI_MAC_CMD_SMAC_RESULT(mode) |
+				FW_VI_MAC_CMD_IDX(idx));
+	memcpy(p->macaddr, addr, sizeof(p->macaddr));
+
+	ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+	if (ret == 0) {
+		ret = FW_VI_MAC_CMD_IDX_GET(ntohs(p->valid_to_idx));
+		if (ret >= NEXACT_MAC)
+			ret = -ENOMEM;
+	}
+	return ret;
+}
+
+/**
+ *	t4_set_addr_hash - program the MAC inexact-match hash filter
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@ucast: whether the hash filter should also match unicast addresses
+ *	@vec: the value to be written to the hash filter
+ *	@sleep_ok: call is allowed to sleep
+ *
+ *	Sets the 64-bit inexact-match hash filter for a virtual interface.
+ */
+int t4_set_addr_hash(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		     bool ucast, u64 vec, bool sleep_ok)
+{
+	struct fw_vi_mac_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_MAC_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_WRITE | FW_VI_ENABLE_CMD_VIID(viid));
+	c.freemacs_to_len16 = htonl(FW_VI_MAC_CMD_HASHVECEN |
+				    FW_VI_MAC_CMD_HASHUNIEN(ucast) |
+				    FW_CMD_LEN16(1));
+	c.u.hash.hashvec = cpu_to_be64(vec);
+	return t4_wr_mbox_meat(adap, mbox, &c, sizeof(c), NULL, sleep_ok);
+}
+
+/**
+ *	t4_enable_vi - enable/disable a virtual interface
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@rx_en: 1=enable Rx, 0=disable Rx
+ *	@tx_en: 1=enable Tx, 0=disable Tx
+ *
+ *	Enables/disables a virtual interface.
+ */
+int t4_enable_vi(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		 bool rx_en, bool tx_en)
+{
+	struct fw_vi_enable_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_ENABLE_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_EXEC | FW_VI_ENABLE_CMD_VIID(viid));
+	c.ien_to_len16 = htonl(FW_VI_ENABLE_CMD_IEN(rx_en) |
+			       FW_VI_ENABLE_CMD_EEN(tx_en) | FW_LEN16(c));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_identify_port - identify a VI's port by blinking its LED
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@viid: the VI id
+ *	@nblinks: how many times to blink LED at 2.5 Hz
+ *
+ *	Identifies a VI's port by blinking its LED.
+ */
+int t4_identify_port(struct adapter *adap, unsigned int mbox, unsigned int viid,
+		     unsigned int nblinks)
+{
+	struct fw_vi_enable_cmd c;
+
+	c.op_to_viid = htonl(FW_CMD_OP(FW_VI_ENABLE_CMD) | FW_CMD_REQUEST |
+			     FW_CMD_EXEC | FW_VI_ENABLE_CMD_VIID(viid));
+	c.ien_to_len16 = htonl(FW_VI_ENABLE_CMD_LED | FW_LEN16(c));
+	c.blinkdur = htons(nblinks);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_iq_start_stop - enable/disable an ingress queue and its FLs
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@start: %true to enable the queues, %false to disable them
+ *	@pf: the PF owning the queues
+ *	@vf: the VF owning the queues
+ *	@iqid: ingress queue id
+ *	@fl0id: FL0 queue id or 0xffff if no attached FL0
+ *	@fl1id: FL1 queue id or 0xffff if no attached FL1
+ *
+ *	Starts or stops an ingress queue and its associated FLs, if any.
+ */
+int t4_iq_start_stop(struct adapter *adap, unsigned int mbox, bool start,
+		     unsigned int pf, unsigned int vf, unsigned int iqid,
+		     unsigned int fl0id, unsigned int fl1id)
+{
+	struct fw_iq_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_IQ_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_IQ_CMD_PFN(pf) |
+			    FW_IQ_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_IQ_CMD_IQSTART(start) |
+				 FW_IQ_CMD_IQSTOP(!start) | FW_LEN16(c));
+	c.iqid = htons(iqid);
+	c.fl0id = htons(fl0id);
+	c.fl1id = htons(fl1id);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_iq_free - free an ingress queue and its FLs
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF owning the queues
+ *	@vf: the VF owning the queues
+ *	@iqtype: the ingress queue type
+ *	@iqid: ingress queue id
+ *	@fl0id: FL0 queue id or 0xffff if no attached FL0
+ *	@fl1id: FL1 queue id or 0xffff if no attached FL1
+ *
+ *	Frees an ingress queue and its associated FLs, if any.
+ */
+int t4_iq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+	       unsigned int vf, unsigned int iqtype, unsigned int iqid,
+	       unsigned int fl0id, unsigned int fl1id)
+{
+	struct fw_iq_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_IQ_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_IQ_CMD_PFN(pf) |
+			    FW_IQ_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_IQ_CMD_FREE | FW_LEN16(c));
+	c.type_to_iqandstindex = htonl(FW_IQ_CMD_TYPE(iqtype));
+	c.iqid = htons(iqid);
+	c.fl0id = htons(fl0id);
+	c.fl1id = htons(fl1id);
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_eth_eq_free - free an Ethernet egress queue
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF owning the queue
+ *	@vf: the VF owning the queue
+ *	@eqid: egress queue id
+ *
+ *	Frees an Ethernet egress queue.
+ */
+int t4_eth_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		   unsigned int vf, unsigned int eqid)
+{
+	struct fw_eq_eth_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_ETH_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_EQ_ETH_CMD_PFN(pf) |
+			    FW_EQ_ETH_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_EQ_ETH_CMD_FREE | FW_LEN16(c));
+	c.eqid_pkd = htonl(FW_EQ_ETH_CMD_EQID(eqid));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_ctrl_eq_free - free a control egress queue
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF owning the queue
+ *	@vf: the VF owning the queue
+ *	@eqid: egress queue id
+ *
+ *	Frees a control egress queue.
+ */
+int t4_ctrl_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int eqid)
+{
+	struct fw_eq_ctrl_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_CTRL_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_EQ_CTRL_CMD_PFN(pf) |
+			    FW_EQ_CTRL_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_EQ_CTRL_CMD_FREE | FW_LEN16(c));
+	c.cmpliqid_eqid = htonl(FW_EQ_CTRL_CMD_EQID(eqid));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_ofld_eq_free - free an offload egress queue
+ *	@adap: the adapter
+ *	@mbox: mailbox to use for the FW command
+ *	@pf: the PF owning the queue
+ *	@vf: the VF owning the queue
+ *	@eqid: egress queue id
+ *
+ *	Frees a control egress queue.
+ */
+int t4_ofld_eq_free(struct adapter *adap, unsigned int mbox, unsigned int pf,
+		    unsigned int vf, unsigned int eqid)
+{
+	struct fw_eq_ofld_cmd c;
+
+	memset(&c, 0, sizeof(c));
+	c.op_to_vfn = htonl(FW_CMD_OP(FW_EQ_OFLD_CMD) | FW_CMD_REQUEST |
+			    FW_CMD_EXEC | FW_EQ_OFLD_CMD_PFN(pf) |
+			    FW_EQ_OFLD_CMD_VFN(vf));
+	c.alloc_to_len16 = htonl(FW_EQ_OFLD_CMD_FREE | FW_LEN16(c));
+	c.eqid_pkd = htonl(FW_EQ_OFLD_CMD_EQID(eqid));
+	return t4_wr_mbox(adap, mbox, &c, sizeof(c), NULL);
+}
+
+/**
+ *	t4_handle_fw_rpl - process a FW reply message
+ *	@adap: the adapter
+ *	@rpl: start of the FW message
+ *
+ *	Processes a FW message, such as link state change messages.
+ */
+int t4_handle_fw_rpl(struct adapter *adap, const __be64 *rpl)
+{
+	u8 opcode = *(const u8 *)rpl;
+
+	if (opcode == FW_PORT_CMD) {    /* link/module state change message */
+		int speed = 0, fc = 0;
+		const struct fw_port_cmd *p = (void *)rpl;
+		int chan = FW_PORT_CMD_PORTID_GET(ntohl(p->op_to_portid));
+		int port = adap->chan_map[chan];
+		struct port_info *pi = adap2pinfo(adap, port);
+		struct link_config *lc = &pi->link_cfg;
+		u32 stat = ntohl(p->u.info.lstatus_to_modtype);
+		int link_ok = (stat & FW_PORT_CMD_LSTATUS) != 0;
+		u32 mod = FW_PORT_CMD_MODTYPE_GET(stat);
+
+		if (stat & FW_PORT_CMD_RXPAUSE)
+			fc |= PAUSE_RX;
+		if (stat & FW_PORT_CMD_TXPAUSE)
+			fc |= PAUSE_TX;
+		if (stat & FW_PORT_CMD_LSPEED(FW_PORT_CAP_SPEED_100M))
+			speed = SPEED_100;
+		else if (stat & FW_PORT_CMD_LSPEED(FW_PORT_CAP_SPEED_1G))
+			speed = SPEED_1000;
+		else if (stat & FW_PORT_CMD_LSPEED(FW_PORT_CAP_SPEED_10G))
+			speed = SPEED_10000;
+
+		if (link_ok != lc->link_ok || speed != lc->speed ||
+		    fc != lc->fc) {                    /* something changed */
+			lc->link_ok = link_ok;
+			lc->speed = speed;
+			lc->fc = fc;
+			t4_os_link_changed(adap, port, link_ok);
+		}
+		if (mod != pi->mod_type) {
+			pi->mod_type = mod;
+			t4_os_portmod_changed(adap, port);
+		}
+	}
+	return 0;
+}
+
+static void __devinit get_pci_mode(struct adapter *adapter,
+				   struct pci_params *p)
+{
+	u16 val;
+	u32 pcie_cap = pci_pcie_cap(adapter->pdev);
+
+	if (pcie_cap) {
+		pci_read_config_word(adapter->pdev, pcie_cap + PCI_EXP_LNKSTA,
+				     &val);
+		p->speed = val & PCI_EXP_LNKSTA_CLS;
+		p->width = (val & PCI_EXP_LNKSTA_NLW) >> 4;
+	}
+}
+
+/**
+ *	init_link_config - initialize a link's SW state
+ *	@lc: structure holding the link state
+ *	@caps: link capabilities
+ *
+ *	Initializes the SW state maintained for each link, including the link's
+ *	capabilities and default speed/flow-control/autonegotiation settings.
+ */
+static void __devinit init_link_config(struct link_config *lc,
+				       unsigned int caps)
+{
+	lc->supported = caps;
+	lc->requested_speed = 0;
+	lc->speed = 0;
+	lc->requested_fc = lc->fc = PAUSE_RX | PAUSE_TX;
+	if (lc->supported & FW_PORT_CAP_ANEG) {
+		lc->advertising = lc->supported & ADVERT_MASK;
+		lc->autoneg = AUTONEG_ENABLE;
+		lc->requested_fc |= PAUSE_AUTONEG;
+	} else {
+		lc->advertising = 0;
+		lc->autoneg = AUTONEG_DISABLE;
+	}
+}
+
+static int __devinit wait_dev_ready(struct adapter *adap)
+{
+	if (t4_read_reg(adap, PL_WHOAMI) != 0xffffffff)
+		return 0;
+	msleep(500);
+	return t4_read_reg(adap, PL_WHOAMI) != 0xffffffff ? 0 : -EIO;
+}
+
+/**
+ *	t4_prep_adapter - prepare SW and HW for operation
+ *	@adapter: the adapter
+ *	@reset: if true perform a HW reset
+ *
+ *	Initialize adapter SW state for the various HW modules, set initial
+ *	values for some adapter tunables, take PHYs out of reset, and
+ *	initialize the MDIO interface.
+ */
+int __devinit t4_prep_adapter(struct adapter *adapter)
+{
+	int ret;
+
+	ret = wait_dev_ready(adapter);
+	if (ret < 0)
+		return ret;
+
+	get_pci_mode(adapter, &adapter->params.pci);
+	adapter->params.rev = t4_read_reg(adapter, PL_REV);
+
+	ret = get_vpd_params(adapter, &adapter->params.vpd);
+	if (ret < 0)
+		return ret;
+
+	init_cong_ctrl(adapter->params.a_wnd, adapter->params.b_wnd);
+
+	/*
+	 * Default port for debugging in case we can't reach FW.
+	 */
+	adapter->params.nports = 1;
+	adapter->params.portvec = 1;
+	return 0;
+}
+
+int __devinit t4_port_init(struct adapter *adap, int mbox, int pf, int vf)
+{
+	u8 addr[6];
+	int ret, i, j = 0;
+	struct fw_port_cmd c;
+
+	memset(&c, 0, sizeof(c));
+
+	for_each_port(adap, i) {
+		unsigned int rss_size;
+		struct port_info *p = adap2pinfo(adap, i);
+
+		while ((adap->params.portvec & (1 << j)) == 0)
+			j++;
+
+		c.op_to_portid = htonl(FW_CMD_OP(FW_PORT_CMD) |
+				       FW_CMD_REQUEST | FW_CMD_READ |
+				       FW_PORT_CMD_PORTID(j));
+		c.action_to_len16 = htonl(
+			FW_PORT_CMD_ACTION(FW_PORT_ACTION_GET_PORT_INFO) |
+			FW_LEN16(c));
+		ret = t4_wr_mbox(adap, mbox, &c, sizeof(c), &c);
+		if (ret)
+			return ret;
+
+		ret = t4_alloc_vi(adap, mbox, j, pf, vf, 1, addr, &rss_size);
+		if (ret < 0)
+			return ret;
+
+		p->viid = ret;
+		p->tx_chan = j;
+		p->lport = j;
+		p->rss_size = rss_size;
+		memcpy(adap->port[i]->dev_addr, addr, ETH_ALEN);
+		memcpy(adap->port[i]->perm_addr, addr, ETH_ALEN);
+
+		ret = ntohl(c.u.info.lstatus_to_modtype);
+		p->mdio_addr = (ret & FW_PORT_CMD_MDIOCAP) ?
+			FW_PORT_CMD_MDIOADDR_GET(ret) : -1;
+		p->port_type = FW_PORT_CMD_PTYPE_GET(ret);
+		p->mod_type = FW_PORT_CMD_MODTYPE_GET(ret);
+
+		init_link_config(&p->link_cfg, ntohs(c.u.info.pcap));
+		j++;
+	}
+	return 0;
+}
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/t4_hw.h linux-2.6.34-rc4/drivers/net/cxgb4/t4_hw.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/t4_hw.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/t4_hw.h	2010-04-13 02:19:01.111633065 +0000
@@ -0,0 +1,100 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __T4_HW_H
+#define __T4_HW_H
+
+#include <linux/types.h>
+
+enum {
+	NCHAN          = 4,     /* # of HW channels */
+	MAX_MTU        = 9600,  /* max MAC MTU, excluding header + FCS */
+	EEPROMSIZE     = 17408, /* Serial EEPROM physical size */
+	EEPROMVSIZE    = 32768, /* Serial EEPROM virtual address space size */
+	RSS_NENTRIES   = 2048,  /* # of entries in RSS mapping table */
+	TCB_SIZE       = 128,   /* TCB size */
+	NMTUS          = 16,    /* size of MTU table */
+	NCCTRL_WIN     = 32,    /* # of congestion control windows */
+	NEXACT_MAC     = 336,   /* # of exact MAC address filters */
+	L2T_SIZE       = 4096,  /* # of L2T entries */
+	MBOX_LEN       = 64,    /* mailbox size in bytes */
+	TRACE_LEN      = 112,   /* length of trace data and mask */
+	FILTER_OPT_LEN = 36,    /* filter tuple width for optional components */
+	NWOL_PAT       = 8,     /* # of WoL patterns */
+	WOL_PAT_LEN    = 128,   /* length of WoL patterns */
+};
+
+enum {
+	SF_PAGE_SIZE = 256,           /* serial flash page size */
+	SF_SEC_SIZE = 64 * 1024,      /* serial flash sector size */
+	SF_SIZE = SF_SEC_SIZE * 16,   /* serial flash size */
+};
+
+enum { RSP_TYPE_FLBUF, RSP_TYPE_CPL, RSP_TYPE_INTR }; /* response entry types */
+
+enum { MBOX_OWNER_NONE, MBOX_OWNER_FW, MBOX_OWNER_DRV };    /* mailbox owners */
+
+enum {
+	SGE_MAX_WR_LEN = 512,     /* max WR size in bytes */
+	SGE_NTIMERS = 6,          /* # of interrupt holdoff timer values */
+	SGE_NCOUNTERS = 4,        /* # of interrupt packet counter values */
+};
+
+struct sge_qstat {                /* data written to SGE queue status entries */
+	__be32 qid;
+	__be16 cidx;
+	__be16 pidx;
+};
+
+/*
+ * Structure for last 128 bits of response descriptors
+ */
+struct rsp_ctrl {
+	__be32 hdrbuflen_pidx;
+	__be32 pldbuflen_qid;
+	union {
+		u8 type_gen;
+		__be64 last_flit;
+	};
+};
+
+#define RSPD_NEWBUF 0x80000000U
+#define RSPD_LEN    0x7fffffffU
+
+#define RSPD_GEN(x)  ((x) >> 7)
+#define RSPD_TYPE(x) (((x) >> 4) & 3)
+
+#define QINTR_CNT_EN       0x1
+#define QINTR_TIMER_IDX(x) ((x) << 1)
+#endif /* __T4_HW_H */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/t4_msg.h linux-2.6.34-rc4/drivers/net/cxgb4/t4_msg.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/t4_msg.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/t4_msg.h	2010-04-13 02:19:01.111633065 +0000
@@ -0,0 +1,664 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2003-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __T4_MSG_H
+#define __T4_MSG_H
+
+#include <linux/types.h>
+
+enum {
+	CPL_PASS_OPEN_REQ     = 0x1,
+	CPL_PASS_ACCEPT_RPL   = 0x2,
+	CPL_ACT_OPEN_REQ      = 0x3,
+	CPL_SET_TCB_FIELD     = 0x5,
+	CPL_GET_TCB           = 0x6,
+	CPL_CLOSE_CON_REQ     = 0x8,
+	CPL_CLOSE_LISTSRV_REQ = 0x9,
+	CPL_ABORT_REQ         = 0xA,
+	CPL_ABORT_RPL         = 0xB,
+	CPL_RX_DATA_ACK       = 0xD,
+	CPL_TX_PKT            = 0xE,
+	CPL_L2T_WRITE_REQ     = 0x12,
+	CPL_TID_RELEASE       = 0x1A,
+
+	CPL_CLOSE_LISTSRV_RPL = 0x20,
+	CPL_L2T_WRITE_RPL     = 0x23,
+	CPL_PASS_OPEN_RPL     = 0x24,
+	CPL_ACT_OPEN_RPL      = 0x25,
+	CPL_PEER_CLOSE        = 0x26,
+	CPL_ABORT_REQ_RSS     = 0x2B,
+	CPL_ABORT_RPL_RSS     = 0x2D,
+
+	CPL_CLOSE_CON_RPL     = 0x32,
+	CPL_ISCSI_HDR         = 0x33,
+	CPL_RDMA_CQE          = 0x35,
+	CPL_RDMA_CQE_READ_RSP = 0x36,
+	CPL_RDMA_CQE_ERR      = 0x37,
+	CPL_RX_DATA           = 0x39,
+	CPL_SET_TCB_RPL       = 0x3A,
+	CPL_RX_PKT            = 0x3B,
+	CPL_RX_DDP_COMPLETE   = 0x3F,
+
+	CPL_ACT_ESTABLISH     = 0x40,
+	CPL_PASS_ESTABLISH    = 0x41,
+	CPL_RX_DATA_DDP       = 0x42,
+	CPL_PASS_ACCEPT_REQ   = 0x44,
+
+	CPL_RDMA_READ_REQ     = 0x60,
+
+	CPL_PASS_OPEN_REQ6    = 0x81,
+	CPL_ACT_OPEN_REQ6     = 0x83,
+
+	CPL_RDMA_TERMINATE    = 0xA2,
+	CPL_RDMA_WRITE        = 0xA4,
+	CPL_SGE_EGR_UPDATE    = 0xA5,
+
+	CPL_TRACE_PKT         = 0xB0,
+
+	CPL_FW4_MSG           = 0xC0,
+	CPL_FW4_PLD           = 0xC1,
+	CPL_FW4_ACK           = 0xC3,
+
+	CPL_FW6_MSG           = 0xE0,
+	CPL_FW6_PLD           = 0xE1,
+	CPL_TX_PKT_LSO        = 0xED,
+	CPL_TX_PKT_XT         = 0xEE,
+
+	NUM_CPL_CMDS
+};
+
+enum CPL_error {
+	CPL_ERR_NONE               = 0,
+	CPL_ERR_TCAM_FULL          = 3,
+	CPL_ERR_BAD_LENGTH         = 15,
+	CPL_ERR_BAD_ROUTE          = 18,
+	CPL_ERR_CONN_RESET         = 20,
+	CPL_ERR_CONN_EXIST_SYNRECV = 21,
+	CPL_ERR_CONN_EXIST         = 22,
+	CPL_ERR_ARP_MISS           = 23,
+	CPL_ERR_BAD_SYN            = 24,
+	CPL_ERR_CONN_TIMEDOUT      = 30,
+	CPL_ERR_XMIT_TIMEDOUT      = 31,
+	CPL_ERR_PERSIST_TIMEDOUT   = 32,
+	CPL_ERR_FINWAIT2_TIMEDOUT  = 33,
+	CPL_ERR_KEEPALIVE_TIMEDOUT = 34,
+	CPL_ERR_RTX_NEG_ADVICE     = 35,
+	CPL_ERR_PERSIST_NEG_ADVICE = 36,
+	CPL_ERR_ABORT_FAILED       = 42,
+	CPL_ERR_IWARP_FLM          = 50,
+};
+
+enum {
+	ULP_MODE_NONE          = 0,
+	ULP_MODE_ISCSI         = 2,
+	ULP_MODE_RDMA          = 4,
+	ULP_MODE_FCOE          = 6,
+};
+
+enum {
+	ULP_CRC_HEADER = 1 << 0,
+	ULP_CRC_DATA   = 1 << 1
+};
+
+enum {
+	CPL_ABORT_SEND_RST = 0,
+	CPL_ABORT_NO_RST,
+};
+
+enum {                     /* TX_PKT_XT checksum types */
+	TX_CSUM_TCP    = 0,
+	TX_CSUM_UDP    = 1,
+	TX_CSUM_CRC16  = 4,
+	TX_CSUM_CRC32  = 5,
+	TX_CSUM_CRC32C = 6,
+	TX_CSUM_FCOE   = 7,
+	TX_CSUM_TCPIP  = 8,
+	TX_CSUM_UDPIP  = 9,
+	TX_CSUM_TCPIP6 = 10,
+	TX_CSUM_UDPIP6 = 11,
+	TX_CSUM_IP     = 12,
+};
+
+union opcode_tid {
+	__be32 opcode_tid;
+	u8 opcode;
+};
+
+#define CPL_OPCODE(x) ((x) << 24)
+#define MK_OPCODE_TID(opcode, tid) (CPL_OPCODE(opcode) | (tid))
+#define OPCODE_TID(cmd) ((cmd)->ot.opcode_tid)
+#define GET_TID(cmd) (ntohl(OPCODE_TID(cmd)) & 0xFFFFFF)
+
+/* partitioning of TID fields that also carry a queue id */
+#define GET_TID_TID(x) ((x) & 0x3fff)
+#define GET_TID_QID(x) (((x) >> 14) & 0x3ff)
+#define TID_QID(x)     ((x) << 14)
+
+struct rss_header {
+	u8 opcode;
+#if defined(__LITTLE_ENDIAN_BITFIELD)
+	u8 channel:2;
+	u8 filter_hit:1;
+	u8 filter_tid:1;
+	u8 hash_type:2;
+	u8 ipv6:1;
+	u8 send2fw:1;
+#else
+	u8 send2fw:1;
+	u8 ipv6:1;
+	u8 hash_type:2;
+	u8 filter_tid:1;
+	u8 filter_hit:1;
+	u8 channel:2;
+#endif
+	__be16 qid;
+	__be32 hash_val;
+};
+
+struct work_request_hdr {
+	__be32 wr_hi;
+	__be32 wr_mid;
+	__be64 wr_lo;
+};
+
+#define WR_HDR struct work_request_hdr wr
+
+struct cpl_pass_open_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 local_port;
+	__be16 peer_port;
+	__be32 local_ip;
+	__be32 peer_ip;
+	__be64 opt0;
+#define TX_CHAN(x)    ((x) << 2)
+#define DELACK(x)     ((x) << 5)
+#define ULP_MODE(x)   ((x) << 8)
+#define RCV_BUFSIZ(x) ((x) << 12)
+#define DSCP(x)       ((x) << 22)
+#define SMAC_SEL(x)   ((u64)(x) << 28)
+#define L2T_IDX(x)    ((u64)(x) << 36)
+#define NAGLE(x)      ((u64)(x) << 49)
+#define WND_SCALE(x)  ((u64)(x) << 50)
+#define KEEP_ALIVE(x) ((u64)(x) << 54)
+#define MSS_IDX(x)    ((u64)(x) << 60)
+	__be64 opt1;
+#define SYN_RSS_ENABLE   (1 << 0)
+#define SYN_RSS_QUEUE(x) ((x) << 2)
+#define CONN_POLICY_ASK  (1 << 22)
+};
+
+struct cpl_pass_open_req6 {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 local_port;
+	__be16 peer_port;
+	__be64 local_ip_hi;
+	__be64 local_ip_lo;
+	__be64 peer_ip_hi;
+	__be64 peer_ip_lo;
+	__be64 opt0;
+	__be64 opt1;
+};
+
+struct cpl_pass_open_rpl {
+	union opcode_tid ot;
+	u8 rsvd[3];
+	u8 status;
+};
+
+struct cpl_pass_accept_rpl {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 opt2;
+#define RSS_QUEUE(x)         ((x) << 0)
+#define RSS_QUEUE_VALID      (1 << 10)
+#define RX_COALESCE_VALID(x) ((x) << 11)
+#define RX_COALESCE(x)       ((x) << 12)
+#define TX_QUEUE(x)          ((x) << 23)
+#define RX_CHANNEL(x)        ((x) << 26)
+#define WND_SCALE_EN(x)      ((x) << 28)
+#define TSTAMPS_EN(x)        ((x) << 29)
+#define SACK_EN(x)           ((x) << 30)
+	__be64 opt0;
+};
+
+struct cpl_act_open_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 local_port;
+	__be16 peer_port;
+	__be32 local_ip;
+	__be32 peer_ip;
+	__be64 opt0;
+	__be32 params;
+	__be32 opt2;
+};
+
+struct cpl_act_open_req6 {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 local_port;
+	__be16 peer_port;
+	__be64 local_ip_hi;
+	__be64 local_ip_lo;
+	__be64 peer_ip_hi;
+	__be64 peer_ip_lo;
+	__be64 opt0;
+	__be32 params;
+	__be32 opt2;
+};
+
+struct cpl_act_open_rpl {
+	union opcode_tid ot;
+	__be32 atid_status;
+#define GET_AOPEN_STATUS(x) ((x) & 0xff)
+#define GET_AOPEN_ATID(x)   (((x) >> 8) & 0xffffff)
+};
+
+struct cpl_pass_establish {
+	union opcode_tid ot;
+	__be32 rsvd;
+	__be32 tos_stid;
+#define GET_POPEN_TID(x) ((x) & 0xffffff)
+#define GET_POPEN_TOS(x) (((x) >> 24) & 0xff)
+	__be16 mac_idx;
+	__be16 tcp_opt;
+#define GET_TCPOPT_WSCALE_OK(x)  (((x) >> 5) & 1)
+#define GET_TCPOPT_SACK(x)       (((x) >> 6) & 1)
+#define GET_TCPOPT_TSTAMP(x)     (((x) >> 7) & 1)
+#define GET_TCPOPT_SND_WSCALE(x) (((x) >> 8) & 0xf)
+#define GET_TCPOPT_MSS(x)        (((x) >> 12) & 0xf)
+	__be32 snd_isn;
+	__be32 rcv_isn;
+};
+
+struct cpl_act_establish {
+	union opcode_tid ot;
+	__be32 rsvd;
+	__be32 tos_atid;
+	__be16 mac_idx;
+	__be16 tcp_opt;
+	__be32 snd_isn;
+	__be32 rcv_isn;
+};
+
+struct cpl_get_tcb {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 reply_ctrl;
+#define QUEUENO(x)    ((x) << 0)
+#define REPLY_CHAN(x) ((x) << 14)
+#define NO_REPLY(x)   ((x) << 15)
+	__be16 cookie;
+};
+
+struct cpl_set_tcb_field {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 reply_ctrl;
+	__be16 word_cookie;
+#define TCB_WORD(x)   ((x) << 0)
+#define TCB_COOKIE(x) ((x) << 5)
+	__be64 mask;
+	__be64 val;
+};
+
+struct cpl_set_tcb_rpl {
+	union opcode_tid ot;
+	__be16 rsvd;
+	u8 cookie;
+	u8 status;
+	__be64 oldval;
+};
+
+struct cpl_close_con_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 rsvd;
+};
+
+struct cpl_close_con_rpl {
+	union opcode_tid ot;
+	u8 rsvd[3];
+	u8 status;
+	__be32 snd_nxt;
+	__be32 rcv_nxt;
+};
+
+struct cpl_close_listsvr_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 reply_ctrl;
+#define LISTSVR_IPV6 (1 << 14)
+	__be16 rsvd;
+};
+
+struct cpl_close_listsvr_rpl {
+	union opcode_tid ot;
+	u8 rsvd[3];
+	u8 status;
+};
+
+struct cpl_abort_req_rss {
+	union opcode_tid ot;
+	u8 rsvd[3];
+	u8 status;
+};
+
+struct cpl_abort_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 rsvd0;
+	u8 rsvd1;
+	u8 cmd;
+	u8 rsvd2[6];
+};
+
+struct cpl_abort_rpl_rss {
+	union opcode_tid ot;
+	u8 rsvd[3];
+	u8 status;
+};
+
+struct cpl_abort_rpl {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 rsvd0;
+	u8 rsvd1;
+	u8 cmd;
+	u8 rsvd2[6];
+};
+
+struct cpl_peer_close {
+	union opcode_tid ot;
+	__be32 rcv_nxt;
+};
+
+struct cpl_tid_release {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 rsvd;
+};
+
+struct cpl_tx_pkt_core {
+	__be32 ctrl0;
+#define TXPKT_VF(x)        ((x) << 0)
+#define TXPKT_PF(x)        ((x) << 8)
+#define TXPKT_VF_VLD       (1 << 11)
+#define TXPKT_OVLAN_IDX(x) ((x) << 12)
+#define TXPKT_INTF(x)      ((x) << 16)
+#define TXPKT_INS_OVLAN    (1 << 21)
+#define TXPKT_OPCODE(x)    ((x) << 24)
+	__be16 pack;
+	__be16 len;
+	__be64 ctrl1;
+#define TXPKT_CSUM_END(x)   ((x) << 12)
+#define TXPKT_CSUM_START(x) ((x) << 20)
+#define TXPKT_IPHDR_LEN(x)  ((u64)(x) << 20)
+#define TXPKT_CSUM_LOC(x)   ((u64)(x) << 30)
+#define TXPKT_ETHHDR_LEN(x) ((u64)(x) << 34)
+#define TXPKT_CSUM_TYPE(x)  ((u64)(x) << 40)
+#define TXPKT_VLAN(x)       ((u64)(x) << 44)
+#define TXPKT_VLAN_VLD      (1ULL << 60)
+#define TXPKT_IPCSUM_DIS    (1ULL << 62)
+#define TXPKT_L4CSUM_DIS    (1ULL << 63)
+};
+
+struct cpl_tx_pkt {
+	WR_HDR;
+	struct cpl_tx_pkt_core c;
+};
+
+#define cpl_tx_pkt_xt cpl_tx_pkt
+
+struct cpl_tx_pkt_lso {
+	WR_HDR;
+	__be32 lso_ctrl;
+#define LSO_TCPHDR_LEN(x) ((x) << 0)
+#define LSO_IPHDR_LEN(x)  ((x) << 4)
+#define LSO_ETHHDR_LEN(x) ((x) << 16)
+#define LSO_IPV6(x)       ((x) << 20)
+#define LSO_LAST_SLICE    (1 << 22)
+#define LSO_FIRST_SLICE   (1 << 23)
+#define LSO_OPCODE(x)     ((x) << 24)
+	__be16 ipid_ofst;
+	__be16 mss;
+	__be32 seqno_offset;
+	__be32 len;
+	/* encapsulated CPL (TX_PKT, TX_PKT_XT or TX_DATA) follows here */
+};
+
+struct cpl_iscsi_hdr {
+	union opcode_tid ot;
+	__be16 pdu_len_ddp;
+#define ISCSI_PDU_LEN(x) ((x) & 0x7FFF)
+#define ISCSI_DDP        (1 << 15)
+	__be16 len;
+	__be32 seq;
+	__be16 urg;
+	u8 rsvd;
+	u8 status;
+};
+
+struct cpl_rx_data {
+	union opcode_tid ot;
+	__be16 rsvd;
+	__be16 len;
+	__be32 seq;
+	__be16 urg;
+#if defined(__LITTLE_ENDIAN_BITFIELD)
+	u8 dack_mode:2;
+	u8 psh:1;
+	u8 heartbeat:1;
+	u8 ddp_off:1;
+	u8 :3;
+#else
+	u8 :3;
+	u8 ddp_off:1;
+	u8 heartbeat:1;
+	u8 psh:1;
+	u8 dack_mode:2;
+#endif
+	u8 status;
+};
+
+struct cpl_rx_data_ack {
+	WR_HDR;
+	union opcode_tid ot;
+	__be32 credit_dack;
+#define RX_CREDITS(x)   ((x) << 0)
+#define RX_FORCE_ACK(x) ((x) << 28)
+};
+
+struct cpl_rx_pkt {
+	u8 opcode;
+#if defined(__LITTLE_ENDIAN_BITFIELD)
+	u8 iff:4;
+	u8 csum_calc:1;
+	u8 ipmi_pkt:1;
+	u8 vlan_ex:1;
+	u8 ip_frag:1;
+#else
+	u8 ip_frag:1;
+	u8 vlan_ex:1;
+	u8 ipmi_pkt:1;
+	u8 csum_calc:1;
+	u8 iff:4;
+#endif
+	__be16 csum;
+	__be16 vlan;
+	__be16 len;
+	__be32 l2info;
+#define RXF_UDP (1 << 22)
+#define RXF_TCP (1 << 23)
+	__be16 hdr_len;
+	__be16 err_vec;
+};
+
+struct cpl_trace_pkt {
+	u8 opcode;
+	u8 intf;
+#if defined(__LITTLE_ENDIAN_BITFIELD)
+	u8 runt:4;
+	u8 filter_hit:4;
+	u8 :6;
+	u8 err:1;
+	u8 trunc:1;
+#else
+	u8 filter_hit:4;
+	u8 runt:4;
+	u8 trunc:1;
+	u8 err:1;
+	u8 :6;
+#endif
+	__be16 rsvd;
+	__be16 len;
+	__be64 tstamp;
+};
+
+struct cpl_l2t_write_req {
+	WR_HDR;
+	union opcode_tid ot;
+	__be16 params;
+#define L2T_W_INFO(x)    ((x) << 2)
+#define L2T_W_PORT(x)    ((x) << 8)
+#define L2T_W_NOREPLY(x) ((x) << 15)
+	__be16 l2t_idx;
+	__be16 vlan;
+	u8 dst_mac[6];
+};
+
+struct cpl_l2t_write_rpl {
+	union opcode_tid ot;
+	u8 status;
+	u8 rsvd[3];
+};
+
+struct cpl_rdma_terminate {
+	union opcode_tid ot;
+	__be16 rsvd;
+	__be16 len;
+};
+
+struct cpl_sge_egr_update {
+	__be32 opcode_qid;
+#define EGR_QID(x) ((x) & 0x1FFFF)
+	__be16 cidx;
+	__be16 pidx;
+};
+
+struct cpl_fw4_pld {
+	u8 opcode;
+	u8 rsvd0[3];
+	u8 type;
+	u8 rsvd1;
+	__be16 len;
+	__be64 data;
+	__be64 rsvd2;
+};
+
+struct cpl_fw6_pld {
+	u8 opcode;
+	u8 rsvd[5];
+	__be16 len;
+	__be64 data[4];
+};
+
+struct cpl_fw4_msg {
+	u8 opcode;
+	u8 type;
+	__be16 rsvd0;
+	__be32 rsvd1;
+	__be64 data[2];
+};
+
+struct cpl_fw4_ack {
+	union opcode_tid ot;
+	u8 credits;
+	u8 rsvd0[2];
+	u8 seq_vld;
+	__be32 snd_nxt;
+	__be32 snd_una;
+	__be64 rsvd1;
+};
+
+struct cpl_fw6_msg {
+	u8 opcode;
+	u8 type;
+	__be16 rsvd0;
+	__be32 rsvd1;
+	__be64 data[4];
+};
+
+enum {
+	ULP_TX_MEM_READ = 2,
+	ULP_TX_MEM_WRITE = 3,
+	ULP_TX_PKT = 4
+};
+
+enum {
+	ULP_TX_SC_NOOP = 0x80,
+	ULP_TX_SC_IMM  = 0x81,
+	ULP_TX_SC_DSGL = 0x82,
+	ULP_TX_SC_ISGL = 0x83
+};
+
+struct ulptx_sge_pair {
+	__be32 len[2];
+	__be64 addr[2];
+};
+
+struct ulptx_sgl {
+	__be32 cmd_nsge;
+#define ULPTX_CMD(x) ((x) << 24)
+#define ULPTX_NSGE(x) ((x) << 0)
+	__be32 len0;
+	__be64 addr0;
+	struct ulptx_sge_pair sge[0];
+};
+
+struct ulp_mem_io {
+	WR_HDR;
+	__be32 cmd;
+#define ULP_MEMIO_ORDER(x) ((x) << 23)
+	__be32 len16;             /* command length */
+	__be32 dlen;              /* data length in 32-byte units */
+#define ULP_MEMIO_DATA_LEN(x) ((x) << 0)
+	__be32 lock_addr;
+#define ULP_MEMIO_ADDR(x) ((x) << 0)
+#define ULP_MEMIO_LOCK(x) ((x) << 31)
+};
+
+#endif  /* __T4_MSG_H */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/t4_regs.h linux-2.6.34-rc4/drivers/net/cxgb4/t4_regs.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/t4_regs.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/t4_regs.h	2010-04-13 02:19:01.112633019 +0000
@@ -0,0 +1,878 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef __T4_REGS_H
+#define __T4_REGS_H
+
+#define MYPF_BASE 0x1b000
+#define MYPF_REG(reg_addr) (MYPF_BASE + (reg_addr))
+
+#define PF0_BASE 0x1e000
+#define PF0_REG(reg_addr) (PF0_BASE + (reg_addr))
+
+#define PF_STRIDE 0x400
+#define PF_BASE(idx) (PF0_BASE + (idx) * PF_STRIDE)
+#define PF_REG(idx, reg) (PF_BASE(idx) + (reg))
+
+#define MYPORT_BASE 0x1c000
+#define MYPORT_REG(reg_addr) (MYPORT_BASE + (reg_addr))
+
+#define PORT0_BASE 0x20000
+#define PORT0_REG(reg_addr) (PORT0_BASE + (reg_addr))
+
+#define PORT_STRIDE 0x2000
+#define PORT_BASE(idx) (PORT0_BASE + (idx) * PORT_STRIDE)
+#define PORT_REG(idx, reg) (PORT_BASE(idx) + (reg))
+
+#define EDC_STRIDE (EDC_1_BASE_ADDR - EDC_0_BASE_ADDR)
+#define EDC_REG(reg, idx) (reg + EDC_STRIDE * idx)
+
+#define PCIE_MEM_ACCESS_REG(reg_addr, idx) ((reg_addr) + (idx) * 8)
+#define PCIE_MAILBOX_REG(reg_addr, idx) ((reg_addr) + (idx) * 8)
+#define MC_BIST_STATUS_REG(reg_addr, idx) ((reg_addr) + (idx) * 4)
+#define EDC_BIST_STATUS_REG(reg_addr, idx) ((reg_addr) + (idx) * 4)
+
+#define SGE_PF_KDOORBELL 0x0
+#define  QID_MASK    0xffff8000U
+#define  QID_SHIFT   15
+#define  QID(x)      ((x) << QID_SHIFT)
+#define  DBPRIO      0x00004000U
+#define  PIDX_MASK   0x00003fffU
+#define  PIDX_SHIFT  0
+#define  PIDX(x)     ((x) << PIDX_SHIFT)
+
+#define SGE_PF_GTS 0x4
+#define  INGRESSQID_MASK   0xffff0000U
+#define  INGRESSQID_SHIFT  16
+#define  INGRESSQID(x)     ((x) << INGRESSQID_SHIFT)
+#define  TIMERREG_MASK     0x0000e000U
+#define  TIMERREG_SHIFT    13
+#define  TIMERREG(x)       ((x) << TIMERREG_SHIFT)
+#define  SEINTARM_MASK     0x00001000U
+#define  SEINTARM_SHIFT    12
+#define  SEINTARM(x)       ((x) << SEINTARM_SHIFT)
+#define  CIDXINC_MASK      0x00000fffU
+#define  CIDXINC_SHIFT     0
+#define  CIDXINC(x)        ((x) << CIDXINC_SHIFT)
+
+#define SGE_CONTROL 0x1008
+#define  DCASYSTYPE             0x00080000U
+#define  RXPKTCPLMODE           0x00040000U
+#define  EGRSTATUSPAGESIZE      0x00020000U
+#define  PKTSHIFT_MASK          0x00001c00U
+#define  PKTSHIFT_SHIFT         10
+#define  PKTSHIFT(x)            ((x) << PKTSHIFT_SHIFT)
+#define  INGPCIEBOUNDARY_MASK   0x00000380U
+#define  INGPCIEBOUNDARY_SHIFT  7
+#define  INGPCIEBOUNDARY(x)     ((x) << INGPCIEBOUNDARY_SHIFT)
+#define  INGPADBOUNDARY_MASK    0x00000070U
+#define  INGPADBOUNDARY_SHIFT   4
+#define  INGPADBOUNDARY(x)      ((x) << INGPADBOUNDARY_SHIFT)
+#define  EGRPCIEBOUNDARY_MASK   0x0000000eU
+#define  EGRPCIEBOUNDARY_SHIFT  1
+#define  EGRPCIEBOUNDARY(x)     ((x) << EGRPCIEBOUNDARY_SHIFT)
+#define  GLOBALENABLE           0x00000001U
+
+#define SGE_HOST_PAGE_SIZE 0x100c
+#define  HOSTPAGESIZEPF0_MASK   0x0000000fU
+#define  HOSTPAGESIZEPF0_SHIFT  0
+#define  HOSTPAGESIZEPF0(x)     ((x) << HOSTPAGESIZEPF0_SHIFT)
+
+#define SGE_EGRESS_QUEUES_PER_PAGE_PF 0x1010
+#define  QUEUESPERPAGEPF0_MASK   0x0000000fU
+#define  QUEUESPERPAGEPF0_GET(x) ((x) & QUEUESPERPAGEPF0_MASK)
+
+#define SGE_INT_CAUSE1 0x1024
+#define SGE_INT_CAUSE2 0x1030
+#define SGE_INT_CAUSE3 0x103c
+#define  ERR_FLM_DBP               0x80000000U
+#define  ERR_FLM_IDMA1             0x40000000U
+#define  ERR_FLM_IDMA0             0x20000000U
+#define  ERR_FLM_HINT              0x10000000U
+#define  ERR_PCIE_ERROR3           0x08000000U
+#define  ERR_PCIE_ERROR2           0x04000000U
+#define  ERR_PCIE_ERROR1           0x02000000U
+#define  ERR_PCIE_ERROR0           0x01000000U
+#define  ERR_TIMER_ABOVE_MAX_QID   0x00800000U
+#define  ERR_CPL_EXCEED_IQE_SIZE   0x00400000U
+#define  ERR_INVALID_CIDX_INC      0x00200000U
+#define  ERR_ITP_TIME_PAUSED       0x00100000U
+#define  ERR_CPL_OPCODE_0          0x00080000U
+#define  ERR_DROPPED_DB            0x00040000U
+#define  ERR_DATA_CPL_ON_HIGH_QID1 0x00020000U
+#define  ERR_DATA_CPL_ON_HIGH_QID0 0x00010000U
+#define  ERR_BAD_DB_PIDX3          0x00008000U
+#define  ERR_BAD_DB_PIDX2          0x00004000U
+#define  ERR_BAD_DB_PIDX1          0x00002000U
+#define  ERR_BAD_DB_PIDX0          0x00001000U
+#define  ERR_ING_PCIE_CHAN         0x00000800U
+#define  ERR_ING_CTXT_PRIO         0x00000400U
+#define  ERR_EGR_CTXT_PRIO         0x00000200U
+#define  DBFIFO_HP_INT             0x00000100U
+#define  DBFIFO_LP_INT             0x00000080U
+#define  REG_ADDRESS_ERR           0x00000040U
+#define  INGRESS_SIZE_ERR          0x00000020U
+#define  EGRESS_SIZE_ERR           0x00000010U
+#define  ERR_INV_CTXT3             0x00000008U
+#define  ERR_INV_CTXT2             0x00000004U
+#define  ERR_INV_CTXT1             0x00000002U
+#define  ERR_INV_CTXT0             0x00000001U
+
+#define SGE_INT_ENABLE3 0x1040
+#define SGE_FL_BUFFER_SIZE0 0x1044
+#define SGE_FL_BUFFER_SIZE1 0x1048
+#define SGE_INGRESS_RX_THRESHOLD 0x10a0
+#define  THRESHOLD_0_MASK   0x3f000000U
+#define  THRESHOLD_0_SHIFT  24
+#define  THRESHOLD_0(x)     ((x) << THRESHOLD_0_SHIFT)
+#define  THRESHOLD_0_GET(x) (((x) & THRESHOLD_0_MASK) >> THRESHOLD_0_SHIFT)
+#define  THRESHOLD_1_MASK   0x003f0000U
+#define  THRESHOLD_1_SHIFT  16
+#define  THRESHOLD_1(x)     ((x) << THRESHOLD_1_SHIFT)
+#define  THRESHOLD_1_GET(x) (((x) & THRESHOLD_1_MASK) >> THRESHOLD_1_SHIFT)
+#define  THRESHOLD_2_MASK   0x00003f00U
+#define  THRESHOLD_2_SHIFT  8
+#define  THRESHOLD_2(x)     ((x) << THRESHOLD_2_SHIFT)
+#define  THRESHOLD_2_GET(x) (((x) & THRESHOLD_2_MASK) >> THRESHOLD_2_SHIFT)
+#define  THRESHOLD_3_MASK   0x0000003fU
+#define  THRESHOLD_3_SHIFT  0
+#define  THRESHOLD_3(x)     ((x) << THRESHOLD_3_SHIFT)
+#define  THRESHOLD_3_GET(x) (((x) & THRESHOLD_3_MASK) >> THRESHOLD_3_SHIFT)
+
+#define SGE_TIMER_VALUE_0_AND_1 0x10b8
+#define  TIMERVALUE0_MASK   0xffff0000U
+#define  TIMERVALUE0_SHIFT  16
+#define  TIMERVALUE0(x)     ((x) << TIMERVALUE0_SHIFT)
+#define  TIMERVALUE0_GET(x) (((x) & TIMERVALUE0_MASK) >> TIMERVALUE0_SHIFT)
+#define  TIMERVALUE1_MASK   0x0000ffffU
+#define  TIMERVALUE1_SHIFT  0
+#define  TIMERVALUE1(x)     ((x) << TIMERVALUE1_SHIFT)
+#define  TIMERVALUE1_GET(x) (((x) & TIMERVALUE1_MASK) >> TIMERVALUE1_SHIFT)
+
+#define SGE_TIMER_VALUE_2_AND_3 0x10bc
+#define SGE_TIMER_VALUE_4_AND_5 0x10c0
+#define SGE_DEBUG_INDEX 0x10cc
+#define SGE_DEBUG_DATA_HIGH 0x10d0
+#define SGE_DEBUG_DATA_LOW 0x10d4
+#define SGE_INGRESS_QUEUES_PER_PAGE_PF 0x10f4
+
+#define PCIE_PF_CLI 0x44
+#define PCIE_INT_CAUSE 0x3004
+#define  UNXSPLCPLERR  0x20000000U
+#define  PCIEPINT      0x10000000U
+#define  PCIESINT      0x08000000U
+#define  RPLPERR       0x04000000U
+#define  RXWRPERR      0x02000000U
+#define  RXCPLPERR     0x01000000U
+#define  PIOTAGPERR    0x00800000U
+#define  MATAGPERR     0x00400000U
+#define  INTXCLRPERR   0x00200000U
+#define  FIDPERR       0x00100000U
+#define  CFGSNPPERR    0x00080000U
+#define  HRSPPERR      0x00040000U
+#define  HREQPERR      0x00020000U
+#define  HCNTPERR      0x00010000U
+#define  DRSPPERR      0x00008000U
+#define  DREQPERR      0x00004000U
+#define  DCNTPERR      0x00002000U
+#define  CRSPPERR      0x00001000U
+#define  CREQPERR      0x00000800U
+#define  CCNTPERR      0x00000400U
+#define  TARTAGPERR    0x00000200U
+#define  PIOREQPERR    0x00000100U
+#define  PIOCPLPERR    0x00000080U
+#define  MSIXDIPERR    0x00000040U
+#define  MSIXDATAPERR  0x00000020U
+#define  MSIXADDRHPERR 0x00000010U
+#define  MSIXADDRLPERR 0x00000008U
+#define  MSIDATAPERR   0x00000004U
+#define  MSIADDRHPERR  0x00000002U
+#define  MSIADDRLPERR  0x00000001U
+
+#define PCIE_NONFAT_ERR 0x3010
+#define PCIE_MEM_ACCESS_BASE_WIN 0x3068
+#define  PCIEOFST_MASK   0xfffffc00U
+#define  BIR_MASK        0x00000300U
+#define  BIR_SHIFT       8
+#define  BIR(x)          ((x) << BIR_SHIFT)
+#define  WINDOW_MASK     0x000000ffU
+#define  WINDOW_SHIFT    0
+#define  WINDOW(x)       ((x) << WINDOW_SHIFT)
+
+#define PCIE_CORE_UTL_SYSTEM_BUS_AGENT_STATUS 0x5908
+#define  RNPP 0x80000000U
+#define  RPCP 0x20000000U
+#define  RCIP 0x08000000U
+#define  RCCP 0x04000000U
+#define  RFTP 0x00800000U
+#define  PTRP 0x00100000U
+
+#define PCIE_CORE_UTL_PCI_EXPRESS_PORT_STATUS 0x59a4
+#define  TPCP 0x40000000U
+#define  TNPP 0x20000000U
+#define  TFTP 0x10000000U
+#define  TCAP 0x08000000U
+#define  TCIP 0x04000000U
+#define  RCAP 0x02000000U
+#define  PLUP 0x00800000U
+#define  PLDN 0x00400000U
+#define  OTDD 0x00200000U
+#define  GTRP 0x00100000U
+#define  RDPE 0x00040000U
+#define  TDCE 0x00020000U
+#define  TDUE 0x00010000U
+
+#define MC_INT_CAUSE 0x7518
+#define  ECC_UE_INT_CAUSE 0x00000004U
+#define  ECC_CE_INT_CAUSE 0x00000002U
+#define  PERR_INT_CAUSE   0x00000001U
+
+#define MC_ECC_STATUS 0x751c
+#define  ECC_CECNT_MASK   0xffff0000U
+#define  ECC_CECNT_SHIFT  16
+#define  ECC_CECNT(x)     ((x) << ECC_CECNT_SHIFT)
+#define  ECC_CECNT_GET(x) (((x) & ECC_CECNT_MASK) >> ECC_CECNT_SHIFT)
+#define  ECC_UECNT_MASK   0x0000ffffU
+#define  ECC_UECNT_SHIFT  0
+#define  ECC_UECNT(x)     ((x) << ECC_UECNT_SHIFT)
+#define  ECC_UECNT_GET(x) (((x) & ECC_UECNT_MASK) >> ECC_UECNT_SHIFT)
+
+#define MC_BIST_CMD 0x7600
+#define  START_BIST          0x80000000U
+#define  BIST_CMD_GAP_MASK   0x0000ff00U
+#define  BIST_CMD_GAP_SHIFT  8
+#define  BIST_CMD_GAP(x)     ((x) << BIST_CMD_GAP_SHIFT)
+#define  BIST_OPCODE_MASK    0x00000003U
+#define  BIST_OPCODE_SHIFT   0
+#define  BIST_OPCODE(x)      ((x) << BIST_OPCODE_SHIFT)
+
+#define MC_BIST_CMD_ADDR 0x7604
+#define MC_BIST_CMD_LEN 0x7608
+#define MC_BIST_DATA_PATTERN 0x760c
+#define  BIST_DATA_TYPE_MASK   0x0000000fU
+#define  BIST_DATA_TYPE_SHIFT  0
+#define  BIST_DATA_TYPE(x)     ((x) << BIST_DATA_TYPE_SHIFT)
+
+#define MC_BIST_STATUS_RDATA 0x7688
+
+#define MA_EXT_MEMORY_BAR 0x77c8
+#define  EXT_MEM_SIZE_MASK   0x00000fffU
+#define  EXT_MEM_SIZE_SHIFT  0
+#define  EXT_MEM_SIZE_GET(x) (((x) & EXT_MEM_SIZE_MASK) >> EXT_MEM_SIZE_SHIFT)
+
+#define MA_TARGET_MEM_ENABLE 0x77d8
+#define  EXT_MEM_ENABLE 0x00000004U
+#define  EDRAM1_ENABLE  0x00000002U
+#define  EDRAM0_ENABLE  0x00000001U
+
+#define MA_INT_CAUSE 0x77e0
+#define  MEM_PERR_INT_CAUSE 0x00000002U
+#define  MEM_WRAP_INT_CAUSE 0x00000001U
+
+#define MA_INT_WRAP_STATUS 0x77e4
+#define  MEM_WRAP_ADDRESS_MASK   0xfffffff0U
+#define  MEM_WRAP_ADDRESS_SHIFT  4
+#define  MEM_WRAP_ADDRESS_GET(x) (((x) & MEM_WRAP_ADDRESS_MASK) >> MEM_WRAP_ADDRESS_SHIFT)
+#define  MEM_WRAP_CLIENT_NUM_MASK   0x0000000fU
+#define  MEM_WRAP_CLIENT_NUM_SHIFT  0
+#define  MEM_WRAP_CLIENT_NUM_GET(x) (((x) & MEM_WRAP_CLIENT_NUM_MASK) >> MEM_WRAP_CLIENT_NUM_SHIFT)
+
+#define MA_PARITY_ERROR_STATUS 0x77f4
+
+#define EDC_0_BASE_ADDR 0x7900
+
+#define EDC_BIST_CMD 0x7904
+#define EDC_BIST_CMD_ADDR 0x7908
+#define EDC_BIST_CMD_LEN 0x790c
+#define EDC_BIST_DATA_PATTERN 0x7910
+#define EDC_BIST_STATUS_RDATA 0x7928
+#define EDC_INT_CAUSE 0x7978
+#define  ECC_UE_PAR     0x00000020U
+#define  ECC_CE_PAR     0x00000010U
+#define  PERR_PAR_CAUSE 0x00000008U
+
+#define EDC_ECC_STATUS 0x797c
+
+#define EDC_1_BASE_ADDR 0x7980
+
+#define CIM_PF_MAILBOX_DATA 0x240
+#define CIM_PF_MAILBOX_CTRL 0x280
+#define  MBMSGVALID     0x00000008U
+#define  MBINTREQ       0x00000004U
+#define  MBOWNER_MASK   0x00000003U
+#define  MBOWNER_SHIFT  0
+#define  MBOWNER(x)     ((x) << MBOWNER_SHIFT)
+#define  MBOWNER_GET(x) (((x) & MBOWNER_MASK) >> MBOWNER_SHIFT)
+
+#define CIM_PF_HOST_INT_CAUSE 0x28c
+#define  MBMSGRDYINT 0x00080000U
+
+#define CIM_HOST_INT_CAUSE 0x7b2c
+#define  TIEQOUTPARERRINT  0x00100000U
+#define  TIEQINPARERRINT   0x00080000U
+#define  MBHOSTPARERR      0x00040000U
+#define  MBUPPARERR        0x00020000U
+#define  IBQPARERR         0x0001f800U
+#define  IBQTP0PARERR      0x00010000U
+#define  IBQTP1PARERR      0x00008000U
+#define  IBQULPPARERR      0x00004000U
+#define  IBQSGELOPARERR    0x00002000U
+#define  IBQSGEHIPARERR    0x00001000U
+#define  IBQNCSIPARERR     0x00000800U
+#define  OBQPARERR         0x000007e0U
+#define  OBQULP0PARERR     0x00000400U
+#define  OBQULP1PARERR     0x00000200U
+#define  OBQULP2PARERR     0x00000100U
+#define  OBQULP3PARERR     0x00000080U
+#define  OBQSGEPARERR      0x00000040U
+#define  OBQNCSIPARERR     0x00000020U
+#define  PREFDROPINT       0x00000002U
+#define  UPACCNONZERO      0x00000001U
+
+#define CIM_HOST_UPACC_INT_CAUSE 0x7b34
+#define  EEPROMWRINT      0x40000000U
+#define  TIMEOUTMAINT     0x20000000U
+#define  TIMEOUTINT       0x10000000U
+#define  RSPOVRLOOKUPINT  0x08000000U
+#define  REQOVRLOOKUPINT  0x04000000U
+#define  BLKWRPLINT       0x02000000U
+#define  BLKRDPLINT       0x01000000U
+#define  SGLWRPLINT       0x00800000U
+#define  SGLRDPLINT       0x00400000U
+#define  BLKWRCTLINT      0x00200000U
+#define  BLKRDCTLINT      0x00100000U
+#define  SGLWRCTLINT      0x00080000U
+#define  SGLRDCTLINT      0x00040000U
+#define  BLKWREEPROMINT   0x00020000U
+#define  BLKRDEEPROMINT   0x00010000U
+#define  SGLWREEPROMINT   0x00008000U
+#define  SGLRDEEPROMINT   0x00004000U
+#define  BLKWRFLASHINT    0x00002000U
+#define  BLKRDFLASHINT    0x00001000U
+#define  SGLWRFLASHINT    0x00000800U
+#define  SGLRDFLASHINT    0x00000400U
+#define  BLKWRBOOTINT     0x00000200U
+#define  BLKRDBOOTINT     0x00000100U
+#define  SGLWRBOOTINT     0x00000080U
+#define  SGLRDBOOTINT     0x00000040U
+#define  ILLWRBEINT       0x00000020U
+#define  ILLRDBEINT       0x00000010U
+#define  ILLRDINT         0x00000008U
+#define  ILLWRINT         0x00000004U
+#define  ILLTRANSINT      0x00000002U
+#define  RSVDSPACEINT     0x00000001U
+
+#define TP_OUT_CONFIG 0x7d04
+#define  VLANEXTENABLE_MASK  0x0000f000U
+#define  VLANEXTENABLE_SHIFT 12
+
+#define TP_PARA_REG2 0x7d68
+#define  MAXRXDATA_MASK    0xffff0000U
+#define  MAXRXDATA_SHIFT   16
+#define  MAXRXDATA_GET(x) (((x) & MAXRXDATA_MASK) >> MAXRXDATA_SHIFT)
+
+#define TP_TIMER_RESOLUTION 0x7d90
+#define  TIMERRESOLUTION_MASK   0x00ff0000U
+#define  TIMERRESOLUTION_SHIFT  16
+#define  TIMERRESOLUTION_GET(x) (((x) & TIMERRESOLUTION_MASK) >> TIMERRESOLUTION_SHIFT)
+
+#define TP_SHIFT_CNT 0x7dc0
+
+#define TP_CCTRL_TABLE 0x7ddc
+#define TP_MTU_TABLE 0x7de4
+#define  MTUINDEX_MASK   0xff000000U
+#define  MTUINDEX_SHIFT  24
+#define  MTUINDEX(x)     ((x) << MTUINDEX_SHIFT)
+#define  MTUWIDTH_MASK   0x000f0000U
+#define  MTUWIDTH_SHIFT  16
+#define  MTUWIDTH(x)     ((x) << MTUWIDTH_SHIFT)
+#define  MTUWIDTH_GET(x) (((x) & MTUWIDTH_MASK) >> MTUWIDTH_SHIFT)
+#define  MTUVALUE_MASK   0x00003fffU
+#define  MTUVALUE_SHIFT  0
+#define  MTUVALUE(x)     ((x) << MTUVALUE_SHIFT)
+#define  MTUVALUE_GET(x) (((x) & MTUVALUE_MASK) >> MTUVALUE_SHIFT)
+
+#define TP_RSS_LKP_TABLE 0x7dec
+#define  LKPTBLROWVLD        0x80000000U
+#define  LKPTBLQUEUE1_MASK   0x000ffc00U
+#define  LKPTBLQUEUE1_SHIFT  10
+#define  LKPTBLQUEUE1(x)     ((x) << LKPTBLQUEUE1_SHIFT)
+#define  LKPTBLQUEUE1_GET(x) (((x) & LKPTBLQUEUE1_MASK) >> LKPTBLQUEUE1_SHIFT)
+#define  LKPTBLQUEUE0_MASK   0x000003ffU
+#define  LKPTBLQUEUE0_SHIFT  0
+#define  LKPTBLQUEUE0(x)     ((x) << LKPTBLQUEUE0_SHIFT)
+#define  LKPTBLQUEUE0_GET(x) (((x) & LKPTBLQUEUE0_MASK) >> LKPTBLQUEUE0_SHIFT)
+
+#define TP_PIO_ADDR 0x7e40
+#define TP_PIO_DATA 0x7e44
+#define TP_MIB_INDEX 0x7e50
+#define TP_MIB_DATA 0x7e54
+#define TP_INT_CAUSE 0x7e74
+#define  FLMTXFLSTEMPTY 0x40000000U
+
+#define TP_INGRESS_CONFIG 0x141
+#define  VNIC                0x00000800U
+#define  CSUM_HAS_PSEUDO_HDR 0x00000400U
+#define  RM_OVLAN            0x00000200U
+#define  LOOKUPEVERYPKT      0x00000100U
+
+#define TP_MIB_MAC_IN_ERR_0 0x0
+#define TP_MIB_TCP_OUT_RST 0xc
+#define TP_MIB_TCP_IN_SEG_HI 0x10
+#define TP_MIB_TCP_IN_SEG_LO 0x11
+#define TP_MIB_TCP_OUT_SEG_HI 0x12
+#define TP_MIB_TCP_OUT_SEG_LO 0x13
+#define TP_MIB_TCP_RXT_SEG_HI 0x14
+#define TP_MIB_TCP_RXT_SEG_LO 0x15
+#define TP_MIB_TNL_CNG_DROP_0 0x18
+#define TP_MIB_TCP_V6IN_ERR_0 0x28
+#define TP_MIB_TCP_V6OUT_RST 0x2c
+#define TP_MIB_OFD_ARP_DROP 0x36
+#define TP_MIB_TNL_DROP_0 0x44
+#define TP_MIB_OFD_VLN_DROP_0 0x58
+
+#define ULP_TX_INT_CAUSE 0x8dcc
+#define  PBL_BOUND_ERR_CH3 0x80000000U
+#define  PBL_BOUND_ERR_CH2 0x40000000U
+#define  PBL_BOUND_ERR_CH1 0x20000000U
+#define  PBL_BOUND_ERR_CH0 0x10000000U
+
+#define PM_RX_INT_CAUSE 0x8fdc
+#define  ZERO_E_CMD_ERROR     0x00400000U
+#define  PMRX_FRAMING_ERROR   0x003ffff0U
+#define  OCSPI_PAR_ERROR      0x00000008U
+#define  DB_OPTIONS_PAR_ERROR 0x00000004U
+#define  IESPI_PAR_ERROR      0x00000002U
+#define  E_PCMD_PAR_ERROR     0x00000001U
+
+#define PM_TX_INT_CAUSE 0x8ffc
+#define  PCMD_LEN_OVFL0     0x80000000U
+#define  PCMD_LEN_OVFL1     0x40000000U
+#define  PCMD_LEN_OVFL2     0x20000000U
+#define  ZERO_C_CMD_ERROR   0x10000000U
+#define  PMTX_FRAMING_ERROR 0x0ffffff0U
+#define  OESPI_PAR_ERROR    0x00000008U
+#define  ICSPI_PAR_ERROR    0x00000002U
+#define  C_PCMD_PAR_ERROR   0x00000001U
+
+#define MPS_PORT_STAT_TX_PORT_BYTES_L 0x400
+#define MPS_PORT_STAT_TX_PORT_BYTES_H 0x404
+#define MPS_PORT_STAT_TX_PORT_FRAMES_L 0x408
+#define MPS_PORT_STAT_TX_PORT_FRAMES_H 0x40c
+#define MPS_PORT_STAT_TX_PORT_BCAST_L 0x410
+#define MPS_PORT_STAT_TX_PORT_BCAST_H 0x414
+#define MPS_PORT_STAT_TX_PORT_MCAST_L 0x418
+#define MPS_PORT_STAT_TX_PORT_MCAST_H 0x41c
+#define MPS_PORT_STAT_TX_PORT_UCAST_L 0x420
+#define MPS_PORT_STAT_TX_PORT_UCAST_H 0x424
+#define MPS_PORT_STAT_TX_PORT_ERROR_L 0x428
+#define MPS_PORT_STAT_TX_PORT_ERROR_H 0x42c
+#define MPS_PORT_STAT_TX_PORT_64B_L 0x430
+#define MPS_PORT_STAT_TX_PORT_64B_H 0x434
+#define MPS_PORT_STAT_TX_PORT_65B_127B_L 0x438
+#define MPS_PORT_STAT_TX_PORT_65B_127B_H 0x43c
+#define MPS_PORT_STAT_TX_PORT_128B_255B_L 0x440
+#define MPS_PORT_STAT_TX_PORT_128B_255B_H 0x444
+#define MPS_PORT_STAT_TX_PORT_256B_511B_L 0x448
+#define MPS_PORT_STAT_TX_PORT_256B_511B_H 0x44c
+#define MPS_PORT_STAT_TX_PORT_512B_1023B_L 0x450
+#define MPS_PORT_STAT_TX_PORT_512B_1023B_H 0x454
+#define MPS_PORT_STAT_TX_PORT_1024B_1518B_L 0x458
+#define MPS_PORT_STAT_TX_PORT_1024B_1518B_H 0x45c
+#define MPS_PORT_STAT_TX_PORT_1519B_MAX_L 0x460
+#define MPS_PORT_STAT_TX_PORT_1519B_MAX_H 0x464
+#define MPS_PORT_STAT_TX_PORT_DROP_L 0x468
+#define MPS_PORT_STAT_TX_PORT_DROP_H 0x46c
+#define MPS_PORT_STAT_TX_PORT_PAUSE_L 0x470
+#define MPS_PORT_STAT_TX_PORT_PAUSE_H 0x474
+#define MPS_PORT_STAT_TX_PORT_PPP0_L 0x478
+#define MPS_PORT_STAT_TX_PORT_PPP0_H 0x47c
+#define MPS_PORT_STAT_TX_PORT_PPP1_L 0x480
+#define MPS_PORT_STAT_TX_PORT_PPP1_H 0x484
+#define MPS_PORT_STAT_TX_PORT_PPP2_L 0x488
+#define MPS_PORT_STAT_TX_PORT_PPP2_H 0x48c
+#define MPS_PORT_STAT_TX_PORT_PPP3_L 0x490
+#define MPS_PORT_STAT_TX_PORT_PPP3_H 0x494
+#define MPS_PORT_STAT_TX_PORT_PPP4_L 0x498
+#define MPS_PORT_STAT_TX_PORT_PPP4_H 0x49c
+#define MPS_PORT_STAT_TX_PORT_PPP5_L 0x4a0
+#define MPS_PORT_STAT_TX_PORT_PPP5_H 0x4a4
+#define MPS_PORT_STAT_TX_PORT_PPP6_L 0x4a8
+#define MPS_PORT_STAT_TX_PORT_PPP6_H 0x4ac
+#define MPS_PORT_STAT_TX_PORT_PPP7_L 0x4b0
+#define MPS_PORT_STAT_TX_PORT_PPP7_H 0x4b4
+#define MPS_PORT_STAT_LB_PORT_BYTES_L 0x4c0
+#define MPS_PORT_STAT_LB_PORT_BYTES_H 0x4c4
+#define MPS_PORT_STAT_LB_PORT_FRAMES_L 0x4c8
+#define MPS_PORT_STAT_LB_PORT_FRAMES_H 0x4cc
+#define MPS_PORT_STAT_LB_PORT_BCAST_L 0x4d0
+#define MPS_PORT_STAT_LB_PORT_BCAST_H 0x4d4
+#define MPS_PORT_STAT_LB_PORT_MCAST_L 0x4d8
+#define MPS_PORT_STAT_LB_PORT_MCAST_H 0x4dc
+#define MPS_PORT_STAT_LB_PORT_UCAST_L 0x4e0
+#define MPS_PORT_STAT_LB_PORT_UCAST_H 0x4e4
+#define MPS_PORT_STAT_LB_PORT_ERROR_L 0x4e8
+#define MPS_PORT_STAT_LB_PORT_ERROR_H 0x4ec
+#define MPS_PORT_STAT_LB_PORT_64B_L 0x4f0
+#define MPS_PORT_STAT_LB_PORT_64B_H 0x4f4
+#define MPS_PORT_STAT_LB_PORT_65B_127B_L 0x4f8
+#define MPS_PORT_STAT_LB_PORT_65B_127B_H 0x4fc
+#define MPS_PORT_STAT_LB_PORT_128B_255B_L 0x500
+#define MPS_PORT_STAT_LB_PORT_128B_255B_H 0x504
+#define MPS_PORT_STAT_LB_PORT_256B_511B_L 0x508
+#define MPS_PORT_STAT_LB_PORT_256B_511B_H 0x50c
+#define MPS_PORT_STAT_LB_PORT_512B_1023B_L 0x510
+#define MPS_PORT_STAT_LB_PORT_512B_1023B_H 0x514
+#define MPS_PORT_STAT_LB_PORT_1024B_1518B_L 0x518
+#define MPS_PORT_STAT_LB_PORT_1024B_1518B_H 0x51c
+#define MPS_PORT_STAT_LB_PORT_1519B_MAX_L 0x520
+#define MPS_PORT_STAT_LB_PORT_1519B_MAX_H 0x524
+#define MPS_PORT_STAT_LB_PORT_DROP_FRAMES 0x528
+#define MPS_PORT_STAT_RX_PORT_BYTES_L 0x540
+#define MPS_PORT_STAT_RX_PORT_BYTES_H 0x544
+#define MPS_PORT_STAT_RX_PORT_FRAMES_L 0x548
+#define MPS_PORT_STAT_RX_PORT_FRAMES_H 0x54c
+#define MPS_PORT_STAT_RX_PORT_BCAST_L 0x550
+#define MPS_PORT_STAT_RX_PORT_BCAST_H 0x554
+#define MPS_PORT_STAT_RX_PORT_MCAST_L 0x558
+#define MPS_PORT_STAT_RX_PORT_MCAST_H 0x55c
+#define MPS_PORT_STAT_RX_PORT_UCAST_L 0x560
+#define MPS_PORT_STAT_RX_PORT_UCAST_H 0x564
+#define MPS_PORT_STAT_RX_PORT_MTU_ERROR_L 0x568
+#define MPS_PORT_STAT_RX_PORT_MTU_ERROR_H 0x56c
+#define MPS_PORT_STAT_RX_PORT_MTU_CRC_ERROR_L 0x570
+#define MPS_PORT_STAT_RX_PORT_MTU_CRC_ERROR_H 0x574
+#define MPS_PORT_STAT_RX_PORT_CRC_ERROR_L 0x578
+#define MPS_PORT_STAT_RX_PORT_CRC_ERROR_H 0x57c
+#define MPS_PORT_STAT_RX_PORT_LEN_ERROR_L 0x580
+#define MPS_PORT_STAT_RX_PORT_LEN_ERROR_H 0x584
+#define MPS_PORT_STAT_RX_PORT_SYM_ERROR_L 0x588
+#define MPS_PORT_STAT_RX_PORT_SYM_ERROR_H 0x58c
+#define MPS_PORT_STAT_RX_PORT_64B_L 0x590
+#define MPS_PORT_STAT_RX_PORT_64B_H 0x594
+#define MPS_PORT_STAT_RX_PORT_65B_127B_L 0x598
+#define MPS_PORT_STAT_RX_PORT_65B_127B_H 0x59c
+#define MPS_PORT_STAT_RX_PORT_128B_255B_L 0x5a0
+#define MPS_PORT_STAT_RX_PORT_128B_255B_H 0x5a4
+#define MPS_PORT_STAT_RX_PORT_256B_511B_L 0x5a8
+#define MPS_PORT_STAT_RX_PORT_256B_511B_H 0x5ac
+#define MPS_PORT_STAT_RX_PORT_512B_1023B_L 0x5b0
+#define MPS_PORT_STAT_RX_PORT_512B_1023B_H 0x5b4
+#define MPS_PORT_STAT_RX_PORT_1024B_1518B_L 0x5b8
+#define MPS_PORT_STAT_RX_PORT_1024B_1518B_H 0x5bc
+#define MPS_PORT_STAT_RX_PORT_1519B_MAX_L 0x5c0
+#define MPS_PORT_STAT_RX_PORT_1519B_MAX_H 0x5c4
+#define MPS_PORT_STAT_RX_PORT_PAUSE_L 0x5c8
+#define MPS_PORT_STAT_RX_PORT_PAUSE_H 0x5cc
+#define MPS_PORT_STAT_RX_PORT_PPP0_L 0x5d0
+#define MPS_PORT_STAT_RX_PORT_PPP0_H 0x5d4
+#define MPS_PORT_STAT_RX_PORT_PPP1_L 0x5d8
+#define MPS_PORT_STAT_RX_PORT_PPP1_H 0x5dc
+#define MPS_PORT_STAT_RX_PORT_PPP2_L 0x5e0
+#define MPS_PORT_STAT_RX_PORT_PPP2_H 0x5e4
+#define MPS_PORT_STAT_RX_PORT_PPP3_L 0x5e8
+#define MPS_PORT_STAT_RX_PORT_PPP3_H 0x5ec
+#define MPS_PORT_STAT_RX_PORT_PPP4_L 0x5f0
+#define MPS_PORT_STAT_RX_PORT_PPP4_H 0x5f4
+#define MPS_PORT_STAT_RX_PORT_PPP5_L 0x5f8
+#define MPS_PORT_STAT_RX_PORT_PPP5_H 0x5fc
+#define MPS_PORT_STAT_RX_PORT_PPP6_L 0x600
+#define MPS_PORT_STAT_RX_PORT_PPP6_H 0x604
+#define MPS_PORT_STAT_RX_PORT_PPP7_L 0x608
+#define MPS_PORT_STAT_RX_PORT_PPP7_H 0x60c
+#define MPS_PORT_STAT_RX_PORT_LESS_64B_L 0x610
+#define MPS_PORT_STAT_RX_PORT_LESS_64B_H 0x614
+#define MPS_CMN_CTL 0x9000
+#define  NUMPORTS_MASK   0x00000003U
+#define  NUMPORTS_SHIFT  0
+#define  NUMPORTS_GET(x) (((x) & NUMPORTS_MASK) >> NUMPORTS_SHIFT)
+
+#define MPS_INT_CAUSE 0x9008
+#define  STATINT 0x00000020U
+#define  TXINT   0x00000010U
+#define  RXINT   0x00000008U
+#define  TRCINT  0x00000004U
+#define  CLSINT  0x00000002U
+#define  PLINT   0x00000001U
+
+#define MPS_TX_INT_CAUSE 0x9408
+#define  PORTERR    0x00010000U
+#define  FRMERR     0x00008000U
+#define  SECNTERR   0x00004000U
+#define  BUBBLE     0x00002000U
+#define  TXDESCFIFO 0x00001e00U
+#define  TXDATAFIFO 0x000001e0U
+#define  NCSIFIFO   0x00000010U
+#define  TPFIFO     0x0000000fU
+
+#define MPS_STAT_PERR_INT_CAUSE_SRAM 0x9614
+#define MPS_STAT_PERR_INT_CAUSE_TX_FIFO 0x9620
+#define MPS_STAT_PERR_INT_CAUSE_RX_FIFO 0x962c
+
+#define MPS_STAT_RX_BG_0_MAC_DROP_FRAME_L 0x9640
+#define MPS_STAT_RX_BG_0_MAC_DROP_FRAME_H 0x9644
+#define MPS_STAT_RX_BG_1_MAC_DROP_FRAME_L 0x9648
+#define MPS_STAT_RX_BG_1_MAC_DROP_FRAME_H 0x964c
+#define MPS_STAT_RX_BG_2_MAC_DROP_FRAME_L 0x9650
+#define MPS_STAT_RX_BG_2_MAC_DROP_FRAME_H 0x9654
+#define MPS_STAT_RX_BG_3_MAC_DROP_FRAME_L 0x9658
+#define MPS_STAT_RX_BG_3_MAC_DROP_FRAME_H 0x965c
+#define MPS_STAT_RX_BG_0_LB_DROP_FRAME_L 0x9660
+#define MPS_STAT_RX_BG_0_LB_DROP_FRAME_H 0x9664
+#define MPS_STAT_RX_BG_1_LB_DROP_FRAME_L 0x9668
+#define MPS_STAT_RX_BG_1_LB_DROP_FRAME_H 0x966c
+#define MPS_STAT_RX_BG_2_LB_DROP_FRAME_L 0x9670
+#define MPS_STAT_RX_BG_2_LB_DROP_FRAME_H 0x9674
+#define MPS_STAT_RX_BG_3_LB_DROP_FRAME_L 0x9678
+#define MPS_STAT_RX_BG_3_LB_DROP_FRAME_H 0x967c
+#define MPS_STAT_RX_BG_0_MAC_TRUNC_FRAME_L 0x9680
+#define MPS_STAT_RX_BG_0_MAC_TRUNC_FRAME_H 0x9684
+#define MPS_STAT_RX_BG_1_MAC_TRUNC_FRAME_L 0x9688
+#define MPS_STAT_RX_BG_1_MAC_TRUNC_FRAME_H 0x968c
+#define MPS_STAT_RX_BG_2_MAC_TRUNC_FRAME_L 0x9690
+#define MPS_STAT_RX_BG_2_MAC_TRUNC_FRAME_H 0x9694
+#define MPS_STAT_RX_BG_3_MAC_TRUNC_FRAME_L 0x9698
+#define MPS_STAT_RX_BG_3_MAC_TRUNC_FRAME_H 0x969c
+#define MPS_STAT_RX_BG_0_LB_TRUNC_FRAME_L 0x96a0
+#define MPS_STAT_RX_BG_0_LB_TRUNC_FRAME_H 0x96a4
+#define MPS_STAT_RX_BG_1_LB_TRUNC_FRAME_L 0x96a8
+#define MPS_STAT_RX_BG_1_LB_TRUNC_FRAME_H 0x96ac
+#define MPS_STAT_RX_BG_2_LB_TRUNC_FRAME_L 0x96b0
+#define MPS_STAT_RX_BG_2_LB_TRUNC_FRAME_H 0x96b4
+#define MPS_STAT_RX_BG_3_LB_TRUNC_FRAME_L 0x96b8
+#define MPS_STAT_RX_BG_3_LB_TRUNC_FRAME_H 0x96bc
+#define MPS_TRC_CFG 0x9800
+#define  TRCFIFOEMPTY       0x00000010U
+#define  TRCIGNOREDROPINPUT 0x00000008U
+#define  TRCKEEPDUPLICATES  0x00000004U
+#define  TRCEN              0x00000002U
+#define  TRCMULTIFILTER     0x00000001U
+
+#define MPS_TRC_RSS_CONTROL 0x9808
+#define  RSSCONTROL_MASK    0x00ff0000U
+#define  RSSCONTROL_SHIFT   16
+#define  RSSCONTROL(x)      ((x) << RSSCONTROL_SHIFT)
+#define  QUEUENUMBER_MASK   0x0000ffffU
+#define  QUEUENUMBER_SHIFT  0
+#define  QUEUENUMBER(x)     ((x) << QUEUENUMBER_SHIFT)
+
+#define MPS_TRC_FILTER_MATCH_CTL_A 0x9810
+#define  TFINVERTMATCH   0x01000000U
+#define  TFPKTTOOLARGE   0x00800000U
+#define  TFEN            0x00400000U
+#define  TFPORT_MASK     0x003c0000U
+#define  TFPORT_SHIFT    18
+#define  TFPORT(x)       ((x) << TFPORT_SHIFT)
+#define  TFPORT_GET(x)   (((x) & TFPORT_MASK) >> TFPORT_SHIFT)
+#define  TFDROP          0x00020000U
+#define  TFSOPEOPERR     0x00010000U
+#define  TFLENGTH_MASK   0x00001f00U
+#define  TFLENGTH_SHIFT  8
+#define  TFLENGTH(x)     ((x) << TFLENGTH_SHIFT)
+#define  TFLENGTH_GET(x) (((x) & TFLENGTH_MASK) >> TFLENGTH_SHIFT)
+#define  TFOFFSET_MASK   0x0000001fU
+#define  TFOFFSET_SHIFT  0
+#define  TFOFFSET(x)     ((x) << TFOFFSET_SHIFT)
+#define  TFOFFSET_GET(x) (((x) & TFOFFSET_MASK) >> TFOFFSET_SHIFT)
+
+#define MPS_TRC_FILTER_MATCH_CTL_B 0x9820
+#define  TFMINPKTSIZE_MASK   0x01ff0000U
+#define  TFMINPKTSIZE_SHIFT  16
+#define  TFMINPKTSIZE(x)     ((x) << TFMINPKTSIZE_SHIFT)
+#define  TFMINPKTSIZE_GET(x) (((x) & TFMINPKTSIZE_MASK) >> TFMINPKTSIZE_SHIFT)
+#define  TFCAPTUREMAX_MASK   0x00003fffU
+#define  TFCAPTUREMAX_SHIFT  0
+#define  TFCAPTUREMAX(x)     ((x) << TFCAPTUREMAX_SHIFT)
+#define  TFCAPTUREMAX_GET(x) (((x) & TFCAPTUREMAX_MASK) >> TFCAPTUREMAX_SHIFT)
+
+#define MPS_TRC_INT_CAUSE 0x985c
+#define  MISCPERR 0x00000100U
+#define  PKTFIFO  0x000000f0U
+#define  FILTMEM  0x0000000fU
+
+#define MPS_TRC_FILTER0_MATCH 0x9c00
+#define MPS_TRC_FILTER0_DONT_CARE 0x9c80
+#define MPS_TRC_FILTER1_MATCH 0x9d00
+#define MPS_CLS_INT_CAUSE 0xd028
+#define  PLERRENB  0x00000008U
+#define  HASHSRAM  0x00000004U
+#define  MATCHTCAM 0x00000002U
+#define  MATCHSRAM 0x00000001U
+
+#define MPS_RX_PERR_INT_CAUSE 0x11074
+
+#define CPL_INTR_CAUSE 0x19054
+#define  CIM_OP_MAP_PERR   0x00000020U
+#define  CIM_OVFL_ERROR    0x00000010U
+#define  TP_FRAMING_ERROR  0x00000008U
+#define  SGE_FRAMING_ERROR 0x00000004U
+#define  CIM_FRAMING_ERROR 0x00000002U
+#define  ZERO_SWITCH_ERROR 0x00000001U
+
+#define SMB_INT_CAUSE 0x19090
+#define  MSTTXFIFOPARINT 0x00200000U
+#define  MSTRXFIFOPARINT 0x00100000U
+#define  SLVFIFOPARINT   0x00080000U
+
+#define ULP_RX_INT_CAUSE 0x19158
+#define ULP_RX_ISCSI_TAGMASK 0x19164
+#define ULP_RX_ISCSI_PSZ 0x19168
+#define  HPZ3_MASK   0x0f000000U
+#define  HPZ3_SHIFT  24
+#define  HPZ3(x)     ((x) << HPZ3_SHIFT)
+#define  HPZ2_MASK   0x000f0000U
+#define  HPZ2_SHIFT  16
+#define  HPZ2(x)     ((x) << HPZ2_SHIFT)
+#define  HPZ1_MASK   0x00000f00U
+#define  HPZ1_SHIFT  8
+#define  HPZ1(x)     ((x) << HPZ1_SHIFT)
+#define  HPZ0_MASK   0x0000000fU
+#define  HPZ0_SHIFT  0
+#define  HPZ0(x)     ((x) << HPZ0_SHIFT)
+
+#define ULP_RX_TDDP_PSZ 0x19178
+
+#define SF_DATA 0x193f8
+#define SF_OP 0x193fc
+#define  BUSY          0x80000000U
+#define  SF_LOCK       0x00000010U
+#define  SF_CONT       0x00000008U
+#define  BYTECNT_MASK  0x00000006U
+#define  BYTECNT_SHIFT 1
+#define  BYTECNT(x)    ((x) << BYTECNT_SHIFT)
+#define  OP_WR         0x00000001U
+
+#define PL_PF_INT_CAUSE 0x3c0
+#define  PFSW  0x00000008U
+#define  PFSGE 0x00000004U
+#define  PFCIM 0x00000002U
+#define  PFMPS 0x00000001U
+
+#define PL_PF_INT_ENABLE 0x3c4
+#define PL_PF_CTL 0x3c8
+#define  SWINT 0x00000001U
+
+#define PL_WHOAMI 0x19400
+#define  SOURCEPF_MASK   0x00000700U
+#define  SOURCEPF_SHIFT  8
+#define  SOURCEPF(x)     ((x) << SOURCEPF_SHIFT)
+#define  SOURCEPF_GET(x) (((x) & SOURCEPF_MASK) >> SOURCEPF_SHIFT)
+#define  ISVF            0x00000080U
+#define  VFID_MASK       0x0000007fU
+#define  VFID_SHIFT      0
+#define  VFID(x)         ((x) << VFID_SHIFT)
+#define  VFID_GET(x)     (((x) & VFID_MASK) >> VFID_SHIFT)
+
+#define PL_INT_CAUSE 0x1940c
+#define  ULP_TX     0x08000000U
+#define  SGE        0x04000000U
+#define  HMA        0x02000000U
+#define  CPL_SWITCH 0x01000000U
+#define  ULP_RX     0x00800000U
+#define  PM_RX      0x00400000U
+#define  PM_TX      0x00200000U
+#define  MA         0x00100000U
+#define  TP         0x00080000U
+#define  LE         0x00040000U
+#define  EDC1       0x00020000U
+#define  EDC0       0x00010000U
+#define  MC         0x00008000U
+#define  PCIE       0x00004000U
+#define  PMU        0x00002000U
+#define  XGMAC_KR1  0x00001000U
+#define  XGMAC_KR0  0x00000800U
+#define  XGMAC1     0x00000400U
+#define  XGMAC0     0x00000200U
+#define  SMB        0x00000100U
+#define  SF         0x00000080U
+#define  PL         0x00000040U
+#define  NCSI       0x00000020U
+#define  MPS        0x00000010U
+#define  MI         0x00000008U
+#define  DBG        0x00000004U
+#define  I2CM       0x00000002U
+#define  CIM        0x00000001U
+
+#define PL_INT_MAP0 0x19414
+#define PL_RST 0x19428
+#define  PIORST     0x00000002U
+#define  PIORSTMODE 0x00000001U
+
+#define PL_PL_INT_CAUSE 0x19430
+#define  FATALPERR 0x00000010U
+#define  PERRVFID  0x00000001U
+
+#define PL_REV 0x1943c
+
+#define LE_DB_CONFIG 0x19c04
+#define  HASHEN 0x00100000U
+
+#define LE_DB_SERVER_INDEX 0x19c18
+#define LE_DB_ACT_CNT_IPV4 0x19c20
+#define LE_DB_ACT_CNT_IPV6 0x19c24
+
+#define LE_DB_INT_CAUSE 0x19c3c
+#define  REQQPARERR 0x00010000U
+#define  UNKNOWNCMD 0x00008000U
+#define  PARITYERR  0x00000040U
+#define  LIPMISS    0x00000020U
+#define  LIP0       0x00000010U
+
+#define LE_DB_TID_HASHBASE 0x19df8
+
+#define NCSI_INT_CAUSE 0x1a0d8
+#define  CIM_DM_PRTY_ERR 0x00000100U
+#define  MPS_DM_PRTY_ERR 0x00000080U
+#define  TXFIFO_PRTY_ERR 0x00000002U
+#define  RXFIFO_PRTY_ERR 0x00000001U
+
+#define XGMAC_PORT_CFG2 0x1018
+#define  PATEN   0x00040000U
+#define  MAGICEN 0x00020000U
+
+#define XGMAC_PORT_MAGIC_MACID_LO 0x1024
+#define XGMAC_PORT_MAGIC_MACID_HI 0x1028
+
+#define XGMAC_PORT_EPIO_DATA0 0x10c0
+#define XGMAC_PORT_EPIO_DATA1 0x10c4
+#define XGMAC_PORT_EPIO_DATA2 0x10c8
+#define XGMAC_PORT_EPIO_DATA3 0x10cc
+#define XGMAC_PORT_EPIO_OP 0x10d0
+#define  EPIOWR         0x00000100U
+#define  ADDRESS_MASK   0x000000ffU
+#define  ADDRESS_SHIFT  0
+#define  ADDRESS(x)     ((x) << ADDRESS_SHIFT)
+
+#define XGMAC_PORT_INT_CAUSE 0x10dc
+#endif /* __T4_REGS_H */
diff -urN linux-2.6.34-rc3/drivers/net/cxgb4/t4fw_api.h linux-2.6.34-rc4/drivers/net/cxgb4/t4fw_api.h
--- linux-2.6.34-rc3/drivers/net/cxgb4/t4fw_api.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/cxgb4/t4fw_api.h	2010-04-13 02:19:01.112633019 +0000
@@ -0,0 +1,1580 @@
+/*
+ * This file is part of the Chelsio T4 Ethernet driver for Linux.
+ *
+ * Copyright (c) 2009-2010 Chelsio Communications, Inc. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#ifndef _T4FW_INTERFACE_H_
+#define _T4FW_INTERFACE_H_
+
+#define FW_T4VF_SGE_BASE_ADDR      0x0000
+#define FW_T4VF_MPS_BASE_ADDR      0x0100
+#define FW_T4VF_PL_BASE_ADDR       0x0200
+#define FW_T4VF_MBDATA_BASE_ADDR   0x0240
+#define FW_T4VF_CIM_BASE_ADDR      0x0300
+
+enum fw_wr_opcodes {
+	FW_FILTER_WR                   = 0x02,
+	FW_ULPTX_WR                    = 0x04,
+	FW_TP_WR                       = 0x05,
+	FW_ETH_TX_PKT_WR               = 0x08,
+	FW_FLOWC_WR                    = 0x0a,
+	FW_OFLD_TX_DATA_WR             = 0x0b,
+	FW_CMD_WR                      = 0x10,
+	FW_ETH_TX_PKT_VM_WR            = 0x11,
+	FW_RI_RES_WR                   = 0x0c,
+	FW_RI_INIT_WR                  = 0x0d,
+	FW_RI_RDMA_WRITE_WR            = 0x14,
+	FW_RI_SEND_WR                  = 0x15,
+	FW_RI_RDMA_READ_WR             = 0x16,
+	FW_RI_RECV_WR                  = 0x17,
+	FW_RI_BIND_MW_WR               = 0x18,
+	FW_RI_FR_NSMR_WR               = 0x19,
+	FW_RI_INV_LSTAG_WR             = 0x1a,
+	FW_LASTC2E_WR                  = 0x40
+};
+
+struct fw_wr_hdr {
+	__be32 hi;
+	__be32 lo;
+};
+
+#define FW_WR_OP(x)	 ((x) << 24)
+#define FW_WR_ATOMIC(x)	 ((x) << 23)
+#define FW_WR_FLUSH(x)   ((x) << 22)
+#define FW_WR_COMPL(x)   ((x) << 21)
+#define FW_WR_IMMDLEN(x) ((x) << 0)
+
+#define FW_WR_EQUIQ	(1U << 31)
+#define FW_WR_EQUEQ	(1U << 30)
+#define FW_WR_FLOWID(x)	((x) << 8)
+#define FW_WR_LEN16(x)	((x) << 0)
+
+struct fw_ulptx_wr {
+	__be32 op_to_compl;
+	__be32 flowid_len16;
+	u64 cookie;
+};
+
+struct fw_tp_wr {
+	__be32 op_to_immdlen;
+	__be32 flowid_len16;
+	u64 cookie;
+};
+
+struct fw_eth_tx_pkt_wr {
+	__be32 op_immdlen;
+	__be32 equiq_to_len16;
+	__be64 r3;
+};
+
+enum fw_flowc_mnem {
+	FW_FLOWC_MNEM_PFNVFN,		/* PFN [15:8] VFN [7:0] */
+	FW_FLOWC_MNEM_CH,
+	FW_FLOWC_MNEM_PORT,
+	FW_FLOWC_MNEM_IQID,
+	FW_FLOWC_MNEM_SNDNXT,
+	FW_FLOWC_MNEM_RCVNXT,
+	FW_FLOWC_MNEM_SNDBUF,
+	FW_FLOWC_MNEM_MSS,
+};
+
+struct fw_flowc_mnemval {
+	u8 mnemonic;
+	u8 r4[3];
+	__be32 val;
+};
+
+struct fw_flowc_wr {
+	__be32 op_to_nparams;
+#define FW_FLOWC_WR_NPARAMS(x)	((x) << 0)
+	__be32 flowid_len16;
+	struct fw_flowc_mnemval mnemval[0];
+};
+
+struct fw_ofld_tx_data_wr {
+	__be32 op_to_immdlen;
+	__be32 flowid_len16;
+	__be32 plen;
+	__be32 tunnel_to_proxy;
+#define FW_OFLD_TX_DATA_WR_TUNNEL(x)	 ((x) << 19)
+#define FW_OFLD_TX_DATA_WR_SAVE(x)	 ((x) << 18)
+#define FW_OFLD_TX_DATA_WR_FLUSH(x)	 ((x) << 17)
+#define FW_OFLD_TX_DATA_WR_URGENT(x)	 ((x) << 16)
+#define FW_OFLD_TX_DATA_WR_MORE(x)	 ((x) << 15)
+#define FW_OFLD_TX_DATA_WR_SHOVE(x)	 ((x) << 14)
+#define FW_OFLD_TX_DATA_WR_ULPMODE(x)	 ((x) << 10)
+#define FW_OFLD_TX_DATA_WR_ULPSUBMODE(x) ((x) << 6)
+};
+
+struct fw_cmd_wr {
+	__be32 op_dma;
+#define FW_CMD_WR_DMA (1U << 17)
+	__be32 len16_pkd;
+	__be64 cookie_daddr;
+};
+
+struct fw_eth_tx_pkt_vm_wr {
+	__be32 op_immdlen;
+	__be32 equiq_to_len16;
+	__be32 r3[2];
+	u8 ethmacdst[6];
+	u8 ethmacsrc[6];
+	__be16 ethtype;
+	__be16 vlantci;
+};
+
+#define FW_CMD_MAX_TIMEOUT 3000
+
+enum fw_cmd_opcodes {
+	FW_LDST_CMD                    = 0x01,
+	FW_RESET_CMD                   = 0x03,
+	FW_HELLO_CMD                   = 0x04,
+	FW_BYE_CMD                     = 0x05,
+	FW_INITIALIZE_CMD              = 0x06,
+	FW_CAPS_CONFIG_CMD             = 0x07,
+	FW_PARAMS_CMD                  = 0x08,
+	FW_PFVF_CMD                    = 0x09,
+	FW_IQ_CMD                      = 0x10,
+	FW_EQ_MNGT_CMD                 = 0x11,
+	FW_EQ_ETH_CMD                  = 0x12,
+	FW_EQ_CTRL_CMD                 = 0x13,
+	FW_EQ_OFLD_CMD                 = 0x21,
+	FW_VI_CMD                      = 0x14,
+	FW_VI_MAC_CMD                  = 0x15,
+	FW_VI_RXMODE_CMD               = 0x16,
+	FW_VI_ENABLE_CMD               = 0x17,
+	FW_ACL_MAC_CMD                 = 0x18,
+	FW_ACL_VLAN_CMD                = 0x19,
+	FW_VI_STATS_CMD                = 0x1a,
+	FW_PORT_CMD                    = 0x1b,
+	FW_PORT_STATS_CMD              = 0x1c,
+	FW_PORT_LB_STATS_CMD           = 0x1d,
+	FW_PORT_TRACE_CMD              = 0x1e,
+	FW_PORT_TRACE_MMAP_CMD         = 0x1f,
+	FW_RSS_IND_TBL_CMD             = 0x20,
+	FW_RSS_GLB_CONFIG_CMD          = 0x22,
+	FW_RSS_VI_CONFIG_CMD           = 0x23,
+	FW_LASTC2E_CMD                 = 0x40,
+	FW_ERROR_CMD                   = 0x80,
+	FW_DEBUG_CMD                   = 0x81,
+};
+
+enum fw_cmd_cap {
+	FW_CMD_CAP_PF                  = 0x01,
+	FW_CMD_CAP_DMAQ                = 0x02,
+	FW_CMD_CAP_PORT                = 0x04,
+	FW_CMD_CAP_PORTPROMISC         = 0x08,
+	FW_CMD_CAP_PORTSTATS           = 0x10,
+	FW_CMD_CAP_VF                  = 0x80,
+};
+
+/*
+ * Generic command header flit0
+ */
+struct fw_cmd_hdr {
+	__be32 hi;
+	__be32 lo;
+};
+
+#define FW_CMD_OP(x)		((x) << 24)
+#define FW_CMD_OP_GET(x)        (((x) >> 24) & 0xff)
+#define FW_CMD_REQUEST          (1U << 23)
+#define FW_CMD_READ		(1U << 22)
+#define FW_CMD_WRITE		(1U << 21)
+#define FW_CMD_EXEC		(1U << 20)
+#define FW_CMD_RAMASK(x)	((x) << 20)
+#define FW_CMD_RETVAL(x)	((x) << 8)
+#define FW_CMD_RETVAL_GET(x)	(((x) >> 8) & 0xff)
+#define FW_CMD_LEN16(x)         ((x) << 0)
+
+enum fw_ldst_addrspc {
+	FW_LDST_ADDRSPC_FIRMWARE  = 0x0001,
+	FW_LDST_ADDRSPC_SGE_EGRC  = 0x0008,
+	FW_LDST_ADDRSPC_SGE_INGC  = 0x0009,
+	FW_LDST_ADDRSPC_SGE_FLMC  = 0x000a,
+	FW_LDST_ADDRSPC_SGE_CONMC = 0x000b,
+	FW_LDST_ADDRSPC_TP_PIO    = 0x0010,
+	FW_LDST_ADDRSPC_TP_TM_PIO = 0x0011,
+	FW_LDST_ADDRSPC_TP_MIB    = 0x0012,
+	FW_LDST_ADDRSPC_MDIO      = 0x0018,
+	FW_LDST_ADDRSPC_MPS       = 0x0020,
+	FW_LDST_ADDRSPC_FUNC      = 0x0028
+};
+
+enum fw_ldst_mps_fid {
+	FW_LDST_MPS_ATRB,
+	FW_LDST_MPS_RPLC
+};
+
+enum fw_ldst_func_access_ctl {
+	FW_LDST_FUNC_ACC_CTL_VIID,
+	FW_LDST_FUNC_ACC_CTL_FID
+};
+
+enum fw_ldst_func_mod_index {
+	FW_LDST_FUNC_MPS
+};
+
+struct fw_ldst_cmd {
+	__be32 op_to_addrspace;
+#define FW_LDST_CMD_ADDRSPACE(x) ((x) << 0)
+	__be32 cycles_to_len16;
+	union fw_ldst {
+		struct fw_ldst_addrval {
+			__be32 addr;
+			__be32 val;
+		} addrval;
+		struct fw_ldst_idctxt {
+			__be32 physid;
+			__be32 msg_pkd;
+			__be32 ctxt_data7;
+			__be32 ctxt_data6;
+			__be32 ctxt_data5;
+			__be32 ctxt_data4;
+			__be32 ctxt_data3;
+			__be32 ctxt_data2;
+			__be32 ctxt_data1;
+			__be32 ctxt_data0;
+		} idctxt;
+		struct fw_ldst_mdio {
+			__be16 paddr_mmd;
+			__be16 raddr;
+			__be16 vctl;
+			__be16 rval;
+		} mdio;
+		struct fw_ldst_mps {
+			__be16 fid_ctl;
+			__be16 rplcpf_pkd;
+			__be32 rplc127_96;
+			__be32 rplc95_64;
+			__be32 rplc63_32;
+			__be32 rplc31_0;
+			__be32 atrb;
+			__be16 vlan[16];
+		} mps;
+		struct fw_ldst_func {
+			u8 access_ctl;
+			u8 mod_index;
+			__be16 ctl_id;
+			__be32 offset;
+			__be64 data0;
+			__be64 data1;
+		} func;
+	} u;
+};
+
+#define FW_LDST_CMD_MSG(x)	((x) << 31)
+#define FW_LDST_CMD_PADDR(x)	((x) << 8)
+#define FW_LDST_CMD_MMD(x)	((x) << 0)
+#define FW_LDST_CMD_FID(x)	((x) << 15)
+#define FW_LDST_CMD_CTL(x)	((x) << 0)
+#define FW_LDST_CMD_RPLCPF(x)	((x) << 0)
+
+struct fw_reset_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	__be32 val;
+	__be32 r3;
+};
+
+struct fw_hello_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	__be32 err_to_mbasyncnot;
+#define FW_HELLO_CMD_ERR	    (1U << 31)
+#define FW_HELLO_CMD_INIT	    (1U << 30)
+#define FW_HELLO_CMD_MASTERDIS(x)   ((x) << 29)
+#define FW_HELLO_CMD_MASTERFORCE(x) ((x) << 28)
+#define FW_HELLO_CMD_MBMASTER(x)    ((x) << 24)
+#define FW_HELLO_CMD_MBASYNCNOT(x)  ((x) << 20)
+	__be32 fwrev;
+};
+
+struct fw_bye_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	__be64 r3;
+};
+
+struct fw_initialize_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	__be64 r3;
+};
+
+enum fw_caps_config_hm {
+	FW_CAPS_CONFIG_HM_PCIE		= 0x00000001,
+	FW_CAPS_CONFIG_HM_PL		= 0x00000002,
+	FW_CAPS_CONFIG_HM_SGE		= 0x00000004,
+	FW_CAPS_CONFIG_HM_CIM		= 0x00000008,
+	FW_CAPS_CONFIG_HM_ULPTX		= 0x00000010,
+	FW_CAPS_CONFIG_HM_TP		= 0x00000020,
+	FW_CAPS_CONFIG_HM_ULPRX		= 0x00000040,
+	FW_CAPS_CONFIG_HM_PMRX		= 0x00000080,
+	FW_CAPS_CONFIG_HM_PMTX		= 0x00000100,
+	FW_CAPS_CONFIG_HM_MC		= 0x00000200,
+	FW_CAPS_CONFIG_HM_LE		= 0x00000400,
+	FW_CAPS_CONFIG_HM_MPS		= 0x00000800,
+	FW_CAPS_CONFIG_HM_XGMAC		= 0x00001000,
+	FW_CAPS_CONFIG_HM_CPLSWITCH	= 0x00002000,
+	FW_CAPS_CONFIG_HM_T4DBG		= 0x00004000,
+	FW_CAPS_CONFIG_HM_MI		= 0x00008000,
+	FW_CAPS_CONFIG_HM_I2CM		= 0x00010000,
+	FW_CAPS_CONFIG_HM_NCSI		= 0x00020000,
+	FW_CAPS_CONFIG_HM_SMB		= 0x00040000,
+	FW_CAPS_CONFIG_HM_MA		= 0x00080000,
+	FW_CAPS_CONFIG_HM_EDRAM		= 0x00100000,
+	FW_CAPS_CONFIG_HM_PMU		= 0x00200000,
+	FW_CAPS_CONFIG_HM_UART		= 0x00400000,
+	FW_CAPS_CONFIG_HM_SF		= 0x00800000,
+};
+
+enum fw_caps_config_nbm {
+	FW_CAPS_CONFIG_NBM_IPMI		= 0x00000001,
+	FW_CAPS_CONFIG_NBM_NCSI		= 0x00000002,
+};
+
+enum fw_caps_config_link {
+	FW_CAPS_CONFIG_LINK_PPP		= 0x00000001,
+	FW_CAPS_CONFIG_LINK_QFC		= 0x00000002,
+	FW_CAPS_CONFIG_LINK_DCBX	= 0x00000004,
+};
+
+enum fw_caps_config_switch {
+	FW_CAPS_CONFIG_SWITCH_INGRESS	= 0x00000001,
+	FW_CAPS_CONFIG_SWITCH_EGRESS	= 0x00000002,
+};
+
+enum fw_caps_config_nic {
+	FW_CAPS_CONFIG_NIC		= 0x00000001,
+	FW_CAPS_CONFIG_NIC_VM		= 0x00000002,
+};
+
+enum fw_caps_config_ofld {
+	FW_CAPS_CONFIG_OFLD		= 0x00000001,
+};
+
+enum fw_caps_config_rdma {
+	FW_CAPS_CONFIG_RDMA_RDDP	= 0x00000001,
+	FW_CAPS_CONFIG_RDMA_RDMAC	= 0x00000002,
+};
+
+enum fw_caps_config_iscsi {
+	FW_CAPS_CONFIG_ISCSI_INITIATOR_PDU = 0x00000001,
+	FW_CAPS_CONFIG_ISCSI_TARGET_PDU = 0x00000002,
+	FW_CAPS_CONFIG_ISCSI_INITIATOR_CNXOFLD = 0x00000004,
+	FW_CAPS_CONFIG_ISCSI_TARGET_CNXOFLD = 0x00000008,
+};
+
+enum fw_caps_config_fcoe {
+	FW_CAPS_CONFIG_FCOE_INITIATOR	= 0x00000001,
+	FW_CAPS_CONFIG_FCOE_TARGET	= 0x00000002,
+};
+
+struct fw_caps_config_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	__be32 r2;
+	__be32 hwmbitmap;
+	__be16 nbmcaps;
+	__be16 linkcaps;
+	__be16 switchcaps;
+	__be16 r3;
+	__be16 niccaps;
+	__be16 ofldcaps;
+	__be16 rdmacaps;
+	__be16 r4;
+	__be16 iscsicaps;
+	__be16 fcoecaps;
+	__be32 r5;
+	__be64 r6;
+};
+
+/*
+ * params command mnemonics
+ */
+enum fw_params_mnem {
+	FW_PARAMS_MNEM_DEV		= 1,	/* device params */
+	FW_PARAMS_MNEM_PFVF		= 2,	/* function params */
+	FW_PARAMS_MNEM_REG		= 3,	/* limited register access */
+	FW_PARAMS_MNEM_DMAQ		= 4,	/* dma queue params */
+	FW_PARAMS_MNEM_LAST
+};
+
+/*
+ * device parameters
+ */
+enum fw_params_param_dev {
+	FW_PARAMS_PARAM_DEV_CCLK	= 0x00, /* chip core clock in khz */
+	FW_PARAMS_PARAM_DEV_PORTVEC	= 0x01, /* the port vector */
+	FW_PARAMS_PARAM_DEV_NTID	= 0x02, /* reads the number of TIDs
+						 * allocated by the device's
+						 * Lookup Engine
+						 */
+	FW_PARAMS_PARAM_DEV_FLOWC_BUFFIFO_SZ = 0x03,
+	FW_PARAMS_PARAM_DEV_INTVER_NIC	= 0x04,
+	FW_PARAMS_PARAM_DEV_INTVER_VNIC = 0x05,
+	FW_PARAMS_PARAM_DEV_INTVER_OFLD = 0x06,
+	FW_PARAMS_PARAM_DEV_INTVER_RI	= 0x07,
+	FW_PARAMS_PARAM_DEV_INTVER_ISCSIPDU = 0x08,
+	FW_PARAMS_PARAM_DEV_INTVER_ISCSI = 0x09,
+	FW_PARAMS_PARAM_DEV_INTVER_FCOE = 0x0A
+};
+
+/*
+ * physical and virtual function parameters
+ */
+enum fw_params_param_pfvf {
+	FW_PARAMS_PARAM_PFVF_RWXCAPS	= 0x00,
+	FW_PARAMS_PARAM_PFVF_ROUTE_START = 0x01,
+	FW_PARAMS_PARAM_PFVF_ROUTE_END = 0x02,
+	FW_PARAMS_PARAM_PFVF_CLIP_START = 0x03,
+	FW_PARAMS_PARAM_PFVF_CLIP_END = 0x04,
+	FW_PARAMS_PARAM_PFVF_FILTER_START = 0x05,
+	FW_PARAMS_PARAM_PFVF_FILTER_END = 0x06,
+	FW_PARAMS_PARAM_PFVF_SERVER_START = 0x07,
+	FW_PARAMS_PARAM_PFVF_SERVER_END = 0x08,
+	FW_PARAMS_PARAM_PFVF_TDDP_START = 0x09,
+	FW_PARAMS_PARAM_PFVF_TDDP_END = 0x0A,
+	FW_PARAMS_PARAM_PFVF_ISCSI_START = 0x0B,
+	FW_PARAMS_PARAM_PFVF_ISCSI_END = 0x0C,
+	FW_PARAMS_PARAM_PFVF_STAG_START = 0x0D,
+	FW_PARAMS_PARAM_PFVF_STAG_END = 0x0E,
+	FW_PARAMS_PARAM_PFVF_RQ_START = 0x1F,
+	FW_PARAMS_PARAM_PFVF_RQ_END	= 0x10,
+	FW_PARAMS_PARAM_PFVF_PBL_START = 0x11,
+	FW_PARAMS_PARAM_PFVF_PBL_END	= 0x12,
+	FW_PARAMS_PARAM_PFVF_L2T_START = 0x13,
+	FW_PARAMS_PARAM_PFVF_L2T_END = 0x14,
+	FW_PARAMS_PARAM_PFVF_SCHEDCLASS_ETH = 0x20,
+};
+
+/*
+ * dma queue parameters
+ */
+enum fw_params_param_dmaq {
+	FW_PARAMS_PARAM_DMAQ_IQ_DCAEN_DCACPU = 0x00,
+	FW_PARAMS_PARAM_DMAQ_IQ_INTCNTTHRESH = 0x01,
+	FW_PARAMS_PARAM_DMAQ_EQ_CMPLIQID_MNGT = 0x10,
+	FW_PARAMS_PARAM_DMAQ_EQ_CMPLIQID_CTRL = 0x11,
+	FW_PARAMS_PARAM_DMAQ_EQ_SCHEDCLASS_ETH = 0x12,
+};
+
+#define FW_PARAMS_MNEM(x)      ((x) << 24)
+#define FW_PARAMS_PARAM_X(x)   ((x) << 16)
+#define FW_PARAMS_PARAM_Y(x)   ((x) << 8)
+#define FW_PARAMS_PARAM_Z(x)   ((x) << 0)
+#define FW_PARAMS_PARAM_XYZ(x) ((x) << 0)
+#define FW_PARAMS_PARAM_YZ(x)  ((x) << 0)
+
+struct fw_params_cmd {
+	__be32 op_to_vfn;
+	__be32 retval_len16;
+	struct fw_params_param {
+		__be32 mnem;
+		__be32 val;
+	} param[7];
+};
+
+#define FW_PARAMS_CMD_PFN(x) ((x) << 8)
+#define FW_PARAMS_CMD_VFN(x) ((x) << 0)
+
+struct fw_pfvf_cmd {
+	__be32 op_to_vfn;
+	__be32 retval_len16;
+	__be32 niqflint_niq;
+	__be32 cmask_to_neq;
+	__be32 tc_to_nexactf;
+	__be32 r_caps_to_nethctrl;
+	__be16 nricq;
+	__be16 nriqp;
+	__be32 r4;
+};
+
+#define FW_PFVF_CMD_PFN(x) ((x) << 8)
+#define FW_PFVF_CMD_VFN(x) ((x) << 0)
+
+#define FW_PFVF_CMD_NIQFLINT(x) ((x) << 20)
+#define FW_PFVF_CMD_NIQFLINT_GET(x) (((x) >> 20) & 0xfff)
+
+#define FW_PFVF_CMD_NIQ(x) ((x) << 0)
+#define FW_PFVF_CMD_NIQ_GET(x) (((x) >> 0) & 0xfffff)
+
+#define FW_PFVF_CMD_CMASK(x) ((x) << 24)
+#define FW_PFVF_CMD_CMASK_GET(x) (((x) >> 24) & 0xf)
+
+#define FW_PFVF_CMD_PMASK(x) ((x) << 20)
+#define FW_PFVF_CMD_PMASK_GET(x) (((x) >> 20) & 0xf)
+
+#define FW_PFVF_CMD_NEQ(x) ((x) << 0)
+#define FW_PFVF_CMD_NEQ_GET(x) (((x) >> 0) & 0xfffff)
+
+#define FW_PFVF_CMD_TC(x) ((x) << 24)
+#define FW_PFVF_CMD_TC_GET(x) (((x) >> 24) & 0xff)
+
+#define FW_PFVF_CMD_NVI(x) ((x) << 16)
+#define FW_PFVF_CMD_NVI_GET(x) (((x) >> 16) & 0xff)
+
+#define FW_PFVF_CMD_NEXACTF(x) ((x) << 0)
+#define FW_PFVF_CMD_NEXACTF_GET(x) (((x) >> 0) & 0xffff)
+
+#define FW_PFVF_CMD_R_CAPS(x) ((x) << 24)
+#define FW_PFVF_CMD_R_CAPS_GET(x) (((x) >> 24) & 0xff)
+
+#define FW_PFVF_CMD_WX_CAPS(x) ((x) << 16)
+#define FW_PFVF_CMD_WX_CAPS_GET(x) (((x) >> 16) & 0xff)
+
+#define FW_PFVF_CMD_NETHCTRL(x) ((x) << 0)
+#define FW_PFVF_CMD_NETHCTRL_GET(x) (((x) >> 0) & 0xffff)
+
+enum fw_iq_type {
+	FW_IQ_TYPE_FL_INT_CAP,
+	FW_IQ_TYPE_NO_FL_INT_CAP
+};
+
+struct fw_iq_cmd {
+	__be32 op_to_vfn;
+	__be32 alloc_to_len16;
+	__be16 physiqid;
+	__be16 iqid;
+	__be16 fl0id;
+	__be16 fl1id;
+	__be32 type_to_iqandstindex;
+	__be16 iqdroprss_to_iqesize;
+	__be16 iqsize;
+	__be64 iqaddr;
+	__be32 iqns_to_fl0congen;
+	__be16 fl0dcaen_to_fl0cidxfthresh;
+	__be16 fl0size;
+	__be64 fl0addr;
+	__be32 fl1cngchmap_to_fl1congen;
+	__be16 fl1dcaen_to_fl1cidxfthresh;
+	__be16 fl1size;
+	__be64 fl1addr;
+};
+
+#define FW_IQ_CMD_PFN(x) ((x) << 8)
+#define FW_IQ_CMD_VFN(x) ((x) << 0)
+
+#define FW_IQ_CMD_ALLOC (1U << 31)
+#define FW_IQ_CMD_FREE (1U << 30)
+#define FW_IQ_CMD_MODIFY (1U << 29)
+#define FW_IQ_CMD_IQSTART(x) ((x) << 28)
+#define FW_IQ_CMD_IQSTOP(x) ((x) << 27)
+
+#define FW_IQ_CMD_TYPE(x) ((x) << 29)
+#define FW_IQ_CMD_IQASYNCH(x) ((x) << 28)
+#define FW_IQ_CMD_VIID(x) ((x) << 16)
+#define FW_IQ_CMD_IQANDST(x) ((x) << 15)
+#define FW_IQ_CMD_IQANUS(x) ((x) << 14)
+#define FW_IQ_CMD_IQANUD(x) ((x) << 12)
+#define FW_IQ_CMD_IQANDSTINDEX(x) ((x) << 0)
+
+#define FW_IQ_CMD_IQDROPRSS (1U << 15)
+#define FW_IQ_CMD_IQGTSMODE (1U << 14)
+#define FW_IQ_CMD_IQPCIECH(x) ((x) << 12)
+#define FW_IQ_CMD_IQDCAEN(x) ((x) << 11)
+#define FW_IQ_CMD_IQDCACPU(x) ((x) << 6)
+#define FW_IQ_CMD_IQINTCNTTHRESH(x) ((x) << 4)
+#define FW_IQ_CMD_IQO (1U << 3)
+#define FW_IQ_CMD_IQCPRIO(x) ((x) << 2)
+#define FW_IQ_CMD_IQESIZE(x) ((x) << 0)
+
+#define FW_IQ_CMD_IQNS(x) ((x) << 31)
+#define FW_IQ_CMD_IQRO(x) ((x) << 30)
+#define FW_IQ_CMD_IQFLINTIQHSEN(x) ((x) << 28)
+#define FW_IQ_CMD_IQFLINTCONGEN(x) ((x) << 27)
+#define FW_IQ_CMD_IQFLINTISCSIC(x) ((x) << 26)
+#define FW_IQ_CMD_FL0CNGCHMAP(x) ((x) << 20)
+#define FW_IQ_CMD_FL0CACHELOCK(x) ((x) << 15)
+#define FW_IQ_CMD_FL0DBP(x) ((x) << 14)
+#define FW_IQ_CMD_FL0DATANS(x) ((x) << 13)
+#define FW_IQ_CMD_FL0DATARO(x) ((x) << 12)
+#define FW_IQ_CMD_FL0CONGCIF(x) ((x) << 11)
+#define FW_IQ_CMD_FL0ONCHIP(x) ((x) << 10)
+#define FW_IQ_CMD_FL0STATUSPGNS(x) ((x) << 9)
+#define FW_IQ_CMD_FL0STATUSPGRO(x) ((x) << 8)
+#define FW_IQ_CMD_FL0FETCHNS(x) ((x) << 7)
+#define FW_IQ_CMD_FL0FETCHRO(x) ((x) << 6)
+#define FW_IQ_CMD_FL0HOSTFCMODE(x) ((x) << 4)
+#define FW_IQ_CMD_FL0CPRIO(x) ((x) << 3)
+#define FW_IQ_CMD_FL0PADEN (1U << 2)
+#define FW_IQ_CMD_FL0PACKEN (1U << 1)
+#define FW_IQ_CMD_FL0CONGEN (1U << 0)
+
+#define FW_IQ_CMD_FL0DCAEN(x) ((x) << 15)
+#define FW_IQ_CMD_FL0DCACPU(x) ((x) << 10)
+#define FW_IQ_CMD_FL0FBMIN(x) ((x) << 7)
+#define FW_IQ_CMD_FL0FBMAX(x) ((x) << 4)
+#define FW_IQ_CMD_FL0CIDXFTHRESHO (1U << 3)
+#define FW_IQ_CMD_FL0CIDXFTHRESH(x) ((x) << 0)
+
+#define FW_IQ_CMD_FL1CNGCHMAP(x) ((x) << 20)
+#define FW_IQ_CMD_FL1CACHELOCK(x) ((x) << 15)
+#define FW_IQ_CMD_FL1DBP(x) ((x) << 14)
+#define FW_IQ_CMD_FL1DATANS(x) ((x) << 13)
+#define FW_IQ_CMD_FL1DATARO(x) ((x) << 12)
+#define FW_IQ_CMD_FL1CONGCIF(x) ((x) << 11)
+#define FW_IQ_CMD_FL1ONCHIP(x) ((x) << 10)
+#define FW_IQ_CMD_FL1STATUSPGNS(x) ((x) << 9)
+#define FW_IQ_CMD_FL1STATUSPGRO(x) ((x) << 8)
+#define FW_IQ_CMD_FL1FETCHNS(x) ((x) << 7)
+#define FW_IQ_CMD_FL1FETCHRO(x) ((x) << 6)
+#define FW_IQ_CMD_FL1HOSTFCMODE(x) ((x) << 4)
+#define FW_IQ_CMD_FL1CPRIO(x) ((x) << 3)
+#define FW_IQ_CMD_FL1PADEN (1U << 2)
+#define FW_IQ_CMD_FL1PACKEN (1U << 1)
+#define FW_IQ_CMD_FL1CONGEN (1U << 0)
+
+#define FW_IQ_CMD_FL1DCAEN(x) ((x) << 15)
+#define FW_IQ_CMD_FL1DCACPU(x) ((x) << 10)
+#define FW_IQ_CMD_FL1FBMIN(x) ((x) << 7)
+#define FW_IQ_CMD_FL1FBMAX(x) ((x) << 4)
+#define FW_IQ_CMD_FL1CIDXFTHRESHO (1U << 3)
+#define FW_IQ_CMD_FL1CIDXFTHRESH(x) ((x) << 0)
+
+struct fw_eq_eth_cmd {
+	__be32 op_to_vfn;
+	__be32 alloc_to_len16;
+	__be32 eqid_pkd;
+	__be32 physeqid_pkd;
+	__be32 fetchszm_to_iqid;
+	__be32 dcaen_to_eqsize;
+	__be64 eqaddr;
+	__be32 viid_pkd;
+	__be32 r8_lo;
+	__be64 r9;
+};
+
+#define FW_EQ_ETH_CMD_PFN(x) ((x) << 8)
+#define FW_EQ_ETH_CMD_VFN(x) ((x) << 0)
+#define FW_EQ_ETH_CMD_ALLOC (1U << 31)
+#define FW_EQ_ETH_CMD_FREE (1U << 30)
+#define FW_EQ_ETH_CMD_MODIFY (1U << 29)
+#define FW_EQ_ETH_CMD_EQSTART (1U << 28)
+#define FW_EQ_ETH_CMD_EQSTOP (1U << 27)
+
+#define FW_EQ_ETH_CMD_EQID(x) ((x) << 0)
+#define FW_EQ_ETH_CMD_EQID_GET(x) (((x) >> 0) & 0xfffff)
+#define FW_EQ_ETH_CMD_PHYSEQID(x) ((x) << 0)
+
+#define FW_EQ_ETH_CMD_FETCHSZM(x) ((x) << 26)
+#define FW_EQ_ETH_CMD_STATUSPGNS(x) ((x) << 25)
+#define FW_EQ_ETH_CMD_STATUSPGRO(x) ((x) << 24)
+#define FW_EQ_ETH_CMD_FETCHNS(x) ((x) << 23)
+#define FW_EQ_ETH_CMD_FETCHRO(x) ((x) << 22)
+#define FW_EQ_ETH_CMD_HOSTFCMODE(x) ((x) << 20)
+#define FW_EQ_ETH_CMD_CPRIO(x) ((x) << 19)
+#define FW_EQ_ETH_CMD_ONCHIP(x) ((x) << 18)
+#define FW_EQ_ETH_CMD_PCIECHN(x) ((x) << 16)
+#define FW_EQ_ETH_CMD_IQID(x) ((x) << 0)
+
+#define FW_EQ_ETH_CMD_DCAEN(x) ((x) << 31)
+#define FW_EQ_ETH_CMD_DCACPU(x) ((x) << 26)
+#define FW_EQ_ETH_CMD_FBMIN(x) ((x) << 23)
+#define FW_EQ_ETH_CMD_FBMAX(x) ((x) << 20)
+#define FW_EQ_ETH_CMD_CIDXFTHRESHO(x) ((x) << 19)
+#define FW_EQ_ETH_CMD_CIDXFTHRESH(x) ((x) << 16)
+#define FW_EQ_ETH_CMD_EQSIZE(x) ((x) << 0)
+
+#define FW_EQ_ETH_CMD_VIID(x) ((x) << 16)
+
+struct fw_eq_ctrl_cmd {
+	__be32 op_to_vfn;
+	__be32 alloc_to_len16;
+	__be32 cmpliqid_eqid;
+	__be32 physeqid_pkd;
+	__be32 fetchszm_to_iqid;
+	__be32 dcaen_to_eqsize;
+	__be64 eqaddr;
+};
+
+#define FW_EQ_CTRL_CMD_PFN(x) ((x) << 8)
+#define FW_EQ_CTRL_CMD_VFN(x) ((x) << 0)
+
+#define FW_EQ_CTRL_CMD_ALLOC (1U << 31)
+#define FW_EQ_CTRL_CMD_FREE (1U << 30)
+#define FW_EQ_CTRL_CMD_MODIFY (1U << 29)
+#define FW_EQ_CTRL_CMD_EQSTART (1U << 28)
+#define FW_EQ_CTRL_CMD_EQSTOP (1U << 27)
+
+#define FW_EQ_CTRL_CMD_CMPLIQID(x) ((x) << 20)
+#define FW_EQ_CTRL_CMD_EQID(x) ((x) << 0)
+#define FW_EQ_CTRL_CMD_EQID_GET(x) (((x) >> 0) & 0xfffff)
+#define FW_EQ_CTRL_CMD_PHYSEQID_GET(x) (((x) >> 0) & 0xfffff)
+
+#define FW_EQ_CTRL_CMD_FETCHSZM (1U << 26)
+#define FW_EQ_CTRL_CMD_STATUSPGNS (1U << 25)
+#define FW_EQ_CTRL_CMD_STATUSPGRO (1U << 24)
+#define FW_EQ_CTRL_CMD_FETCHNS (1U << 23)
+#define FW_EQ_CTRL_CMD_FETCHRO (1U << 22)
+#define FW_EQ_CTRL_CMD_HOSTFCMODE(x) ((x) << 20)
+#define FW_EQ_CTRL_CMD_CPRIO(x) ((x) << 19)
+#define FW_EQ_CTRL_CMD_ONCHIP(x) ((x) << 18)
+#define FW_EQ_CTRL_CMD_PCIECHN(x) ((x) << 16)
+#define FW_EQ_CTRL_CMD_IQID(x) ((x) << 0)
+
+#define FW_EQ_CTRL_CMD_DCAEN(x) ((x) << 31)
+#define FW_EQ_CTRL_CMD_DCACPU(x) ((x) << 26)
+#define FW_EQ_CTRL_CMD_FBMIN(x) ((x) << 23)
+#define FW_EQ_CTRL_CMD_FBMAX(x) ((x) << 20)
+#define FW_EQ_CTRL_CMD_CIDXFTHRESHO(x) ((x) << 19)
+#define FW_EQ_CTRL_CMD_CIDXFTHRESH(x) ((x) << 16)
+#define FW_EQ_CTRL_CMD_EQSIZE(x) ((x) << 0)
+
+struct fw_eq_ofld_cmd {
+	__be32 op_to_vfn;
+	__be32 alloc_to_len16;
+	__be32 eqid_pkd;
+	__be32 physeqid_pkd;
+	__be32 fetchszm_to_iqid;
+	__be32 dcaen_to_eqsize;
+	__be64 eqaddr;
+};
+
+#define FW_EQ_OFLD_CMD_PFN(x) ((x) << 8)
+#define FW_EQ_OFLD_CMD_VFN(x) ((x) << 0)
+
+#define FW_EQ_OFLD_CMD_ALLOC (1U << 31)
+#define FW_EQ_OFLD_CMD_FREE (1U << 30)
+#define FW_EQ_OFLD_CMD_MODIFY (1U << 29)
+#define FW_EQ_OFLD_CMD_EQSTART (1U << 28)
+#define FW_EQ_OFLD_CMD_EQSTOP (1U << 27)
+
+#define FW_EQ_OFLD_CMD_EQID(x) ((x) << 0)
+#define FW_EQ_OFLD_CMD_EQID_GET(x) (((x) >> 0) & 0xfffff)
+#define FW_EQ_OFLD_CMD_PHYSEQID_GET(x) (((x) >> 0) & 0xfffff)
+
+#define FW_EQ_OFLD_CMD_FETCHSZM(x) ((x) << 26)
+#define FW_EQ_OFLD_CMD_STATUSPGNS(x) ((x) << 25)
+#define FW_EQ_OFLD_CMD_STATUSPGRO(x) ((x) << 24)
+#define FW_EQ_OFLD_CMD_FETCHNS(x) ((x) << 23)
+#define FW_EQ_OFLD_CMD_FETCHRO(x) ((x) << 22)
+#define FW_EQ_OFLD_CMD_HOSTFCMODE(x) ((x) << 20)
+#define FW_EQ_OFLD_CMD_CPRIO(x) ((x) << 19)
+#define FW_EQ_OFLD_CMD_ONCHIP(x) ((x) << 18)
+#define FW_EQ_OFLD_CMD_PCIECHN(x) ((x) << 16)
+#define FW_EQ_OFLD_CMD_IQID(x) ((x) << 0)
+
+#define FW_EQ_OFLD_CMD_DCAEN(x) ((x) << 31)
+#define FW_EQ_OFLD_CMD_DCACPU(x) ((x) << 26)
+#define FW_EQ_OFLD_CMD_FBMIN(x) ((x) << 23)
+#define FW_EQ_OFLD_CMD_FBMAX(x) ((x) << 20)
+#define FW_EQ_OFLD_CMD_CIDXFTHRESHO(x) ((x) << 19)
+#define FW_EQ_OFLD_CMD_CIDXFTHRESH(x) ((x) << 16)
+#define FW_EQ_OFLD_CMD_EQSIZE(x) ((x) << 0)
+
+/*
+ * Macros for VIID parsing:
+ * VIID - [10:8] PFN, [7] VI Valid, [6:0] VI number
+ */
+#define FW_VIID_PFN_GET(x) (((x) >> 8) & 0x7)
+#define FW_VIID_VIVLD_GET(x) (((x) >> 7) & 0x1)
+#define FW_VIID_VIN_GET(x) (((x) >> 0) & 0x7F)
+
+struct fw_vi_cmd {
+	__be32 op_to_vfn;
+	__be32 alloc_to_len16;
+	__be16 viid_pkd;
+	u8 mac[6];
+	u8 portid_pkd;
+	u8 nmac;
+	u8 nmac0[6];
+	__be16 rsssize_pkd;
+	u8 nmac1[6];
+	__be16 r7;
+	u8 nmac2[6];
+	__be16 r8;
+	u8 nmac3[6];
+	__be64 r9;
+	__be64 r10;
+};
+
+#define FW_VI_CMD_PFN(x) ((x) << 8)
+#define FW_VI_CMD_VFN(x) ((x) << 0)
+#define FW_VI_CMD_ALLOC (1U << 31)
+#define FW_VI_CMD_FREE (1U << 30)
+#define FW_VI_CMD_VIID(x) ((x) << 0)
+#define FW_VI_CMD_PORTID(x) ((x) << 4)
+#define FW_VI_CMD_RSSSIZE_GET(x) (((x) >> 0) & 0x7ff)
+
+/* Special VI_MAC command index ids */
+#define FW_VI_MAC_ADD_MAC		0x3FF
+#define FW_VI_MAC_ADD_PERSIST_MAC	0x3FE
+#define FW_VI_MAC_MAC_BASED_FREE	0x3FD
+
+enum fw_vi_mac_smac {
+	FW_VI_MAC_MPS_TCAM_ENTRY,
+	FW_VI_MAC_MPS_TCAM_ONLY,
+	FW_VI_MAC_SMT_ONLY,
+	FW_VI_MAC_SMT_AND_MPSTCAM
+};
+
+enum fw_vi_mac_result {
+	FW_VI_MAC_R_SUCCESS,
+	FW_VI_MAC_R_F_NONEXISTENT_NOMEM,
+	FW_VI_MAC_R_SMAC_FAIL,
+	FW_VI_MAC_R_F_ACL_CHECK
+};
+
+struct fw_vi_mac_cmd {
+	__be32 op_to_viid;
+	__be32 freemacs_to_len16;
+	union fw_vi_mac {
+		struct fw_vi_mac_exact {
+			__be16 valid_to_idx;
+			u8 macaddr[6];
+		} exact[7];
+		struct fw_vi_mac_hash {
+			__be64 hashvec;
+		} hash;
+	} u;
+};
+
+#define FW_VI_MAC_CMD_VIID(x) ((x) << 0)
+#define FW_VI_MAC_CMD_FREEMACS(x) ((x) << 31)
+#define FW_VI_MAC_CMD_HASHVECEN (1U << 23)
+#define FW_VI_MAC_CMD_HASHUNIEN(x) ((x) << 22)
+#define FW_VI_MAC_CMD_VALID (1U << 15)
+#define FW_VI_MAC_CMD_PRIO(x) ((x) << 12)
+#define FW_VI_MAC_CMD_SMAC_RESULT(x) ((x) << 10)
+#define FW_VI_MAC_CMD_SMAC_RESULT_GET(x) (((x) >> 10) & 0x3)
+#define FW_VI_MAC_CMD_IDX(x) ((x) << 0)
+#define FW_VI_MAC_CMD_IDX_GET(x) (((x) >> 0) & 0x3ff)
+
+#define FW_RXMODE_MTU_NO_CHG	65535
+
+struct fw_vi_rxmode_cmd {
+	__be32 op_to_viid;
+	__be32 retval_len16;
+	__be32 mtu_to_broadcasten;
+	__be32 r4_lo;
+};
+
+#define FW_VI_RXMODE_CMD_VIID(x) ((x) << 0)
+#define FW_VI_RXMODE_CMD_MTU(x) ((x) << 16)
+#define FW_VI_RXMODE_CMD_PROMISCEN_MASK 0x3
+#define FW_VI_RXMODE_CMD_PROMISCEN(x) ((x) << 14)
+#define FW_VI_RXMODE_CMD_ALLMULTIEN_MASK 0x3
+#define FW_VI_RXMODE_CMD_ALLMULTIEN(x) ((x) << 12)
+#define FW_VI_RXMODE_CMD_BROADCASTEN_MASK 0x3
+#define FW_VI_RXMODE_CMD_BROADCASTEN(x) ((x) << 10)
+
+struct fw_vi_enable_cmd {
+	__be32 op_to_viid;
+	__be32 ien_to_len16;
+	__be16 blinkdur;
+	__be16 r3;
+	__be32 r4;
+};
+
+#define FW_VI_ENABLE_CMD_VIID(x) ((x) << 0)
+#define FW_VI_ENABLE_CMD_IEN(x) ((x) << 31)
+#define FW_VI_ENABLE_CMD_EEN(x) ((x) << 30)
+#define FW_VI_ENABLE_CMD_LED (1U << 29)
+
+/* VI VF stats offset definitions */
+#define VI_VF_NUM_STATS	16
+enum fw_vi_stats_vf_index {
+	FW_VI_VF_STAT_TX_BCAST_BYTES_IX,
+	FW_VI_VF_STAT_TX_BCAST_FRAMES_IX,
+	FW_VI_VF_STAT_TX_MCAST_BYTES_IX,
+	FW_VI_VF_STAT_TX_MCAST_FRAMES_IX,
+	FW_VI_VF_STAT_TX_UCAST_BYTES_IX,
+	FW_VI_VF_STAT_TX_UCAST_FRAMES_IX,
+	FW_VI_VF_STAT_TX_DROP_FRAMES_IX,
+	FW_VI_VF_STAT_TX_OFLD_BYTES_IX,
+	FW_VI_VF_STAT_TX_OFLD_FRAMES_IX,
+	FW_VI_VF_STAT_RX_BCAST_BYTES_IX,
+	FW_VI_VF_STAT_RX_BCAST_FRAMES_IX,
+	FW_VI_VF_STAT_RX_MCAST_BYTES_IX,
+	FW_VI_VF_STAT_RX_MCAST_FRAMES_IX,
+	FW_VI_VF_STAT_RX_UCAST_BYTES_IX,
+	FW_VI_VF_STAT_RX_UCAST_FRAMES_IX,
+	FW_VI_VF_STAT_RX_ERR_FRAMES_IX
+};
+
+/* VI PF stats offset definitions */
+#define VI_PF_NUM_STATS	17
+enum fw_vi_stats_pf_index {
+	FW_VI_PF_STAT_TX_BCAST_BYTES_IX,
+	FW_VI_PF_STAT_TX_BCAST_FRAMES_IX,
+	FW_VI_PF_STAT_TX_MCAST_BYTES_IX,
+	FW_VI_PF_STAT_TX_MCAST_FRAMES_IX,
+	FW_VI_PF_STAT_TX_UCAST_BYTES_IX,
+	FW_VI_PF_STAT_TX_UCAST_FRAMES_IX,
+	FW_VI_PF_STAT_TX_OFLD_BYTES_IX,
+	FW_VI_PF_STAT_TX_OFLD_FRAMES_IX,
+	FW_VI_PF_STAT_RX_BYTES_IX,
+	FW_VI_PF_STAT_RX_FRAMES_IX,
+	FW_VI_PF_STAT_RX_BCAST_BYTES_IX,
+	FW_VI_PF_STAT_RX_BCAST_FRAMES_IX,
+	FW_VI_PF_STAT_RX_MCAST_BYTES_IX,
+	FW_VI_PF_STAT_RX_MCAST_FRAMES_IX,
+	FW_VI_PF_STAT_RX_UCAST_BYTES_IX,
+	FW_VI_PF_STAT_RX_UCAST_FRAMES_IX,
+	FW_VI_PF_STAT_RX_ERR_FRAMES_IX
+};
+
+struct fw_vi_stats_cmd {
+	__be32 op_to_viid;
+	__be32 retval_len16;
+	union fw_vi_stats {
+		struct fw_vi_stats_ctl {
+			__be16 nstats_ix;
+			__be16 r6;
+			__be32 r7;
+			__be64 stat0;
+			__be64 stat1;
+			__be64 stat2;
+			__be64 stat3;
+			__be64 stat4;
+			__be64 stat5;
+		} ctl;
+		struct fw_vi_stats_pf {
+			__be64 tx_bcast_bytes;
+			__be64 tx_bcast_frames;
+			__be64 tx_mcast_bytes;
+			__be64 tx_mcast_frames;
+			__be64 tx_ucast_bytes;
+			__be64 tx_ucast_frames;
+			__be64 tx_offload_bytes;
+			__be64 tx_offload_frames;
+			__be64 rx_pf_bytes;
+			__be64 rx_pf_frames;
+			__be64 rx_bcast_bytes;
+			__be64 rx_bcast_frames;
+			__be64 rx_mcast_bytes;
+			__be64 rx_mcast_frames;
+			__be64 rx_ucast_bytes;
+			__be64 rx_ucast_frames;
+			__be64 rx_err_frames;
+		} pf;
+		struct fw_vi_stats_vf {
+			__be64 tx_bcast_bytes;
+			__be64 tx_bcast_frames;
+			__be64 tx_mcast_bytes;
+			__be64 tx_mcast_frames;
+			__be64 tx_ucast_bytes;
+			__be64 tx_ucast_frames;
+			__be64 tx_drop_frames;
+			__be64 tx_offload_bytes;
+			__be64 tx_offload_frames;
+			__be64 rx_bcast_bytes;
+			__be64 rx_bcast_frames;
+			__be64 rx_mcast_bytes;
+			__be64 rx_mcast_frames;
+			__be64 rx_ucast_bytes;
+			__be64 rx_ucast_frames;
+			__be64 rx_err_frames;
+		} vf;
+	} u;
+};
+
+#define FW_VI_STATS_CMD_VIID(x) ((x) << 0)
+#define FW_VI_STATS_CMD_NSTATS(x) ((x) << 12)
+#define FW_VI_STATS_CMD_IX(x) ((x) << 0)
+
+struct fw_acl_mac_cmd {
+	__be32 op_to_vfn;
+	__be32 en_to_len16;
+	u8 nmac;
+	u8 r3[7];
+	__be16 r4;
+	u8 macaddr0[6];
+	__be16 r5;
+	u8 macaddr1[6];
+	__be16 r6;
+	u8 macaddr2[6];
+	__be16 r7;
+	u8 macaddr3[6];
+};
+
+#define FW_ACL_MAC_CMD_PFN(x) ((x) << 8)
+#define FW_ACL_MAC_CMD_VFN(x) ((x) << 0)
+#define FW_ACL_MAC_CMD_EN(x) ((x) << 31)
+
+struct fw_acl_vlan_cmd {
+	__be32 op_to_vfn;
+	__be32 en_to_len16;
+	u8 nvlan;
+	u8 dropnovlan_fm;
+	u8 r3_lo[6];
+	__be16 vlanid[16];
+};
+
+#define FW_ACL_VLAN_CMD_PFN(x) ((x) << 8)
+#define FW_ACL_VLAN_CMD_VFN(x) ((x) << 0)
+#define FW_ACL_VLAN_CMD_EN(x) ((x) << 31)
+#define FW_ACL_VLAN_CMD_DROPNOVLAN(x) ((x) << 7)
+#define FW_ACL_VLAN_CMD_FM(x) ((x) << 6)
+
+enum fw_port_cap {
+	FW_PORT_CAP_SPEED_100M		= 0x0001,
+	FW_PORT_CAP_SPEED_1G		= 0x0002,
+	FW_PORT_CAP_SPEED_2_5G		= 0x0004,
+	FW_PORT_CAP_SPEED_10G		= 0x0008,
+	FW_PORT_CAP_SPEED_40G		= 0x0010,
+	FW_PORT_CAP_SPEED_100G		= 0x0020,
+	FW_PORT_CAP_FC_RX		= 0x0040,
+	FW_PORT_CAP_FC_TX		= 0x0080,
+	FW_PORT_CAP_ANEG		= 0x0100,
+	FW_PORT_CAP_MDI_0		= 0x0200,
+	FW_PORT_CAP_MDI_1		= 0x0400,
+	FW_PORT_CAP_BEAN		= 0x0800,
+	FW_PORT_CAP_PMA_LPBK		= 0x1000,
+	FW_PORT_CAP_PCS_LPBK		= 0x2000,
+	FW_PORT_CAP_PHYXS_LPBK		= 0x4000,
+	FW_PORT_CAP_FAR_END_LPBK	= 0x8000,
+};
+
+enum fw_port_mdi {
+	FW_PORT_MDI_UNCHANGED,
+	FW_PORT_MDI_AUTO,
+	FW_PORT_MDI_F_STRAIGHT,
+	FW_PORT_MDI_F_CROSSOVER
+};
+
+#define FW_PORT_MDI(x) ((x) << 9)
+
+enum fw_port_action {
+	FW_PORT_ACTION_L1_CFG		= 0x0001,
+	FW_PORT_ACTION_L2_CFG		= 0x0002,
+	FW_PORT_ACTION_GET_PORT_INFO	= 0x0003,
+	FW_PORT_ACTION_L2_PPP_CFG	= 0x0004,
+	FW_PORT_ACTION_L2_DCB_CFG	= 0x0005,
+	FW_PORT_ACTION_LOW_PWR_TO_NORMAL = 0x0010,
+	FW_PORT_ACTION_L1_LOW_PWR_EN	= 0x0011,
+	FW_PORT_ACTION_L2_WOL_MODE_EN	= 0x0012,
+	FW_PORT_ACTION_LPBK_TO_NORMAL	= 0x0020,
+	FW_PORT_ACTION_L1_LPBK		= 0x0021,
+	FW_PORT_ACTION_L1_PMA_LPBK	= 0x0022,
+	FW_PORT_ACTION_L1_PCS_LPBK	= 0x0023,
+	FW_PORT_ACTION_L1_PHYXS_CSIDE_LPBK = 0x0024,
+	FW_PORT_ACTION_L1_PHYXS_ESIDE_LPBK = 0x0025,
+	FW_PORT_ACTION_PHY_RESET	= 0x0040,
+	FW_PORT_ACTION_PMA_RESET	= 0x0041,
+	FW_PORT_ACTION_PCS_RESET	= 0x0042,
+	FW_PORT_ACTION_PHYXS_RESET	= 0x0043,
+	FW_PORT_ACTION_DTEXS_REEST	= 0x0044,
+	FW_PORT_ACTION_AN_RESET		= 0x0045
+};
+
+enum fw_port_l2cfg_ctlbf {
+	FW_PORT_L2_CTLBF_OVLAN0	= 0x01,
+	FW_PORT_L2_CTLBF_OVLAN1	= 0x02,
+	FW_PORT_L2_CTLBF_OVLAN2	= 0x04,
+	FW_PORT_L2_CTLBF_OVLAN3	= 0x08,
+	FW_PORT_L2_CTLBF_IVLAN	= 0x10,
+	FW_PORT_L2_CTLBF_TXIPG	= 0x20
+};
+
+enum fw_port_dcb_cfg {
+	FW_PORT_DCB_CFG_PG	= 0x01,
+	FW_PORT_DCB_CFG_PFC	= 0x02,
+	FW_PORT_DCB_CFG_APPL	= 0x04
+};
+
+enum fw_port_dcb_cfg_rc {
+	FW_PORT_DCB_CFG_SUCCESS	= 0x0,
+	FW_PORT_DCB_CFG_ERROR	= 0x1
+};
+
+struct fw_port_cmd {
+	__be32 op_to_portid;
+	__be32 action_to_len16;
+	union fw_port {
+		struct fw_port_l1cfg {
+			__be32 rcap;
+			__be32 r;
+		} l1cfg;
+		struct fw_port_l2cfg {
+			__be16 ctlbf_to_ivlan0;
+			__be16 ivlantype;
+			__be32 txipg_pkd;
+			__be16 ovlan0mask;
+			__be16 ovlan0type;
+			__be16 ovlan1mask;
+			__be16 ovlan1type;
+			__be16 ovlan2mask;
+			__be16 ovlan2type;
+			__be16 ovlan3mask;
+			__be16 ovlan3type;
+		} l2cfg;
+		struct fw_port_info {
+			__be32 lstatus_to_modtype;
+			__be16 pcap;
+			__be16 acap;
+		} info;
+		struct fw_port_ppp {
+			__be32 pppen_to_ncsich;
+			__be32 r11;
+		} ppp;
+		struct fw_port_dcb {
+			__be16 cfg;
+			u8 up_map;
+			u8 sf_cfgrc;
+			__be16 prot_ix;
+			u8 pe7_to_pe0;
+			u8 numTCPFCs;
+			__be32 pgid0_to_pgid7;
+			__be32 numTCs_oui;
+			u8 pgpc[8];
+		} dcb;
+	} u;
+};
+
+#define FW_PORT_CMD_READ (1U << 22)
+
+#define FW_PORT_CMD_PORTID(x) ((x) << 0)
+#define FW_PORT_CMD_PORTID_GET(x) (((x) >> 0) & 0xf)
+
+#define FW_PORT_CMD_ACTION(x) ((x) << 16)
+
+#define FW_PORT_CMD_CTLBF(x) ((x) << 10)
+#define FW_PORT_CMD_OVLAN3(x) ((x) << 7)
+#define FW_PORT_CMD_OVLAN2(x) ((x) << 6)
+#define FW_PORT_CMD_OVLAN1(x) ((x) << 5)
+#define FW_PORT_CMD_OVLAN0(x) ((x) << 4)
+#define FW_PORT_CMD_IVLAN0(x) ((x) << 3)
+
+#define FW_PORT_CMD_TXIPG(x) ((x) << 19)
+
+#define FW_PORT_CMD_LSTATUS (1U << 31)
+#define FW_PORT_CMD_LSPEED(x) ((x) << 24)
+#define FW_PORT_CMD_LSPEED_GET(x) (((x) >> 24) & 0x3f)
+#define FW_PORT_CMD_TXPAUSE (1U << 23)
+#define FW_PORT_CMD_RXPAUSE (1U << 22)
+#define FW_PORT_CMD_MDIOCAP (1U << 21)
+#define FW_PORT_CMD_MDIOADDR_GET(x) (((x) >> 16) & 0x1f)
+#define FW_PORT_CMD_LPTXPAUSE (1U << 15)
+#define FW_PORT_CMD_LPRXPAUSE (1U << 14)
+#define FW_PORT_CMD_PTYPE_MASK 0x1f
+#define FW_PORT_CMD_PTYPE_GET(x) (((x) >> 8) & FW_PORT_CMD_PTYPE_MASK)
+#define FW_PORT_CMD_MODTYPE_MASK 0x1f
+#define FW_PORT_CMD_MODTYPE_GET(x) (((x) >> 0) & FW_PORT_CMD_MODTYPE_MASK)
+
+#define FW_PORT_CMD_PPPEN(x) ((x) << 31)
+#define FW_PORT_CMD_TPSRC(x) ((x) << 28)
+#define FW_PORT_CMD_NCSISRC(x) ((x) << 24)
+
+#define FW_PORT_CMD_CH0(x) ((x) << 20)
+#define FW_PORT_CMD_CH1(x) ((x) << 16)
+#define FW_PORT_CMD_CH2(x) ((x) << 12)
+#define FW_PORT_CMD_CH3(x) ((x) << 8)
+#define FW_PORT_CMD_NCSICH(x) ((x) << 4)
+
+enum fw_port_type {
+	FW_PORT_TYPE_FIBER,
+	FW_PORT_TYPE_KX4,
+	FW_PORT_TYPE_BT_SGMII,
+	FW_PORT_TYPE_KX,
+	FW_PORT_TYPE_BT_XAUI,
+	FW_PORT_TYPE_KR,
+	FW_PORT_TYPE_CX4,
+	FW_PORT_TYPE_TWINAX,
+
+	FW_PORT_TYPE_NONE = FW_PORT_CMD_PTYPE_MASK
+};
+
+enum fw_port_module_type {
+	FW_PORT_MOD_TYPE_NA,
+	FW_PORT_MOD_TYPE_LR,
+	FW_PORT_MOD_TYPE_SR,
+	FW_PORT_MOD_TYPE_ER,
+
+	FW_PORT_MOD_TYPE_NONE = FW_PORT_CMD_MODTYPE_MASK
+};
+
+/* port stats */
+#define FW_NUM_PORT_STATS 50
+#define FW_NUM_PORT_TX_STATS 23
+#define FW_NUM_PORT_RX_STATS 27
+
+enum fw_port_stats_tx_index {
+	FW_STAT_TX_PORT_BYTES_IX,
+	FW_STAT_TX_PORT_FRAMES_IX,
+	FW_STAT_TX_PORT_BCAST_IX,
+	FW_STAT_TX_PORT_MCAST_IX,
+	FW_STAT_TX_PORT_UCAST_IX,
+	FW_STAT_TX_PORT_ERROR_IX,
+	FW_STAT_TX_PORT_64B_IX,
+	FW_STAT_TX_PORT_65B_127B_IX,
+	FW_STAT_TX_PORT_128B_255B_IX,
+	FW_STAT_TX_PORT_256B_511B_IX,
+	FW_STAT_TX_PORT_512B_1023B_IX,
+	FW_STAT_TX_PORT_1024B_1518B_IX,
+	FW_STAT_TX_PORT_1519B_MAX_IX,
+	FW_STAT_TX_PORT_DROP_IX,
+	FW_STAT_TX_PORT_PAUSE_IX,
+	FW_STAT_TX_PORT_PPP0_IX,
+	FW_STAT_TX_PORT_PPP1_IX,
+	FW_STAT_TX_PORT_PPP2_IX,
+	FW_STAT_TX_PORT_PPP3_IX,
+	FW_STAT_TX_PORT_PPP4_IX,
+	FW_STAT_TX_PORT_PPP5_IX,
+	FW_STAT_TX_PORT_PPP6_IX,
+	FW_STAT_TX_PORT_PPP7_IX
+};
+
+enum fw_port_stat_rx_index {
+	FW_STAT_RX_PORT_BYTES_IX,
+	FW_STAT_RX_PORT_FRAMES_IX,
+	FW_STAT_RX_PORT_BCAST_IX,
+	FW_STAT_RX_PORT_MCAST_IX,
+	FW_STAT_RX_PORT_UCAST_IX,
+	FW_STAT_RX_PORT_MTU_ERROR_IX,
+	FW_STAT_RX_PORT_MTU_CRC_ERROR_IX,
+	FW_STAT_RX_PORT_CRC_ERROR_IX,
+	FW_STAT_RX_PORT_LEN_ERROR_IX,
+	FW_STAT_RX_PORT_SYM_ERROR_IX,
+	FW_STAT_RX_PORT_64B_IX,
+	FW_STAT_RX_PORT_65B_127B_IX,
+	FW_STAT_RX_PORT_128B_255B_IX,
+	FW_STAT_RX_PORT_256B_511B_IX,
+	FW_STAT_RX_PORT_512B_1023B_IX,
+	FW_STAT_RX_PORT_1024B_1518B_IX,
+	FW_STAT_RX_PORT_1519B_MAX_IX,
+	FW_STAT_RX_PORT_PAUSE_IX,
+	FW_STAT_RX_PORT_PPP0_IX,
+	FW_STAT_RX_PORT_PPP1_IX,
+	FW_STAT_RX_PORT_PPP2_IX,
+	FW_STAT_RX_PORT_PPP3_IX,
+	FW_STAT_RX_PORT_PPP4_IX,
+	FW_STAT_RX_PORT_PPP5_IX,
+	FW_STAT_RX_PORT_PPP6_IX,
+	FW_STAT_RX_PORT_PPP7_IX,
+	FW_STAT_RX_PORT_LESS_64B_IX
+};
+
+struct fw_port_stats_cmd {
+	__be32 op_to_portid;
+	__be32 retval_len16;
+	union fw_port_stats {
+		struct fw_port_stats_ctl {
+			u8 nstats_bg_bm;
+			u8 tx_ix;
+			__be16 r6;
+			__be32 r7;
+			__be64 stat0;
+			__be64 stat1;
+			__be64 stat2;
+			__be64 stat3;
+			__be64 stat4;
+			__be64 stat5;
+		} ctl;
+		struct fw_port_stats_all {
+			__be64 tx_bytes;
+			__be64 tx_frames;
+			__be64 tx_bcast;
+			__be64 tx_mcast;
+			__be64 tx_ucast;
+			__be64 tx_error;
+			__be64 tx_64b;
+			__be64 tx_65b_127b;
+			__be64 tx_128b_255b;
+			__be64 tx_256b_511b;
+			__be64 tx_512b_1023b;
+			__be64 tx_1024b_1518b;
+			__be64 tx_1519b_max;
+			__be64 tx_drop;
+			__be64 tx_pause;
+			__be64 tx_ppp0;
+			__be64 tx_ppp1;
+			__be64 tx_ppp2;
+			__be64 tx_ppp3;
+			__be64 tx_ppp4;
+			__be64 tx_ppp5;
+			__be64 tx_ppp6;
+			__be64 tx_ppp7;
+			__be64 rx_bytes;
+			__be64 rx_frames;
+			__be64 rx_bcast;
+			__be64 rx_mcast;
+			__be64 rx_ucast;
+			__be64 rx_mtu_error;
+			__be64 rx_mtu_crc_error;
+			__be64 rx_crc_error;
+			__be64 rx_len_error;
+			__be64 rx_sym_error;
+			__be64 rx_64b;
+			__be64 rx_65b_127b;
+			__be64 rx_128b_255b;
+			__be64 rx_256b_511b;
+			__be64 rx_512b_1023b;
+			__be64 rx_1024b_1518b;
+			__be64 rx_1519b_max;
+			__be64 rx_pause;
+			__be64 rx_ppp0;
+			__be64 rx_ppp1;
+			__be64 rx_ppp2;
+			__be64 rx_ppp3;
+			__be64 rx_ppp4;
+			__be64 rx_ppp5;
+			__be64 rx_ppp6;
+			__be64 rx_ppp7;
+			__be64 rx_less_64b;
+			__be64 rx_bg_drop;
+			__be64 rx_bg_trunc;
+		} all;
+	} u;
+};
+
+#define FW_PORT_STATS_CMD_NSTATS(x) ((x) << 4)
+#define FW_PORT_STATS_CMD_BG_BM(x) ((x) << 0)
+#define FW_PORT_STATS_CMD_TX(x) ((x) << 7)
+#define FW_PORT_STATS_CMD_IX(x) ((x) << 0)
+
+/* port loopback stats */
+#define FW_NUM_LB_STATS 16
+enum fw_port_lb_stats_index {
+	FW_STAT_LB_PORT_BYTES_IX,
+	FW_STAT_LB_PORT_FRAMES_IX,
+	FW_STAT_LB_PORT_BCAST_IX,
+	FW_STAT_LB_PORT_MCAST_IX,
+	FW_STAT_LB_PORT_UCAST_IX,
+	FW_STAT_LB_PORT_ERROR_IX,
+	FW_STAT_LB_PORT_64B_IX,
+	FW_STAT_LB_PORT_65B_127B_IX,
+	FW_STAT_LB_PORT_128B_255B_IX,
+	FW_STAT_LB_PORT_256B_511B_IX,
+	FW_STAT_LB_PORT_512B_1023B_IX,
+	FW_STAT_LB_PORT_1024B_1518B_IX,
+	FW_STAT_LB_PORT_1519B_MAX_IX,
+	FW_STAT_LB_PORT_DROP_FRAMES_IX
+};
+
+struct fw_port_lb_stats_cmd {
+	__be32 op_to_lbport;
+	__be32 retval_len16;
+	union fw_port_lb_stats {
+		struct fw_port_lb_stats_ctl {
+			u8 nstats_bg_bm;
+			u8 ix_pkd;
+			__be16 r6;
+			__be32 r7;
+			__be64 stat0;
+			__be64 stat1;
+			__be64 stat2;
+			__be64 stat3;
+			__be64 stat4;
+			__be64 stat5;
+		} ctl;
+		struct fw_port_lb_stats_all {
+			__be64 tx_bytes;
+			__be64 tx_frames;
+			__be64 tx_bcast;
+			__be64 tx_mcast;
+			__be64 tx_ucast;
+			__be64 tx_error;
+			__be64 tx_64b;
+			__be64 tx_65b_127b;
+			__be64 tx_128b_255b;
+			__be64 tx_256b_511b;
+			__be64 tx_512b_1023b;
+			__be64 tx_1024b_1518b;
+			__be64 tx_1519b_max;
+			__be64 rx_lb_drop;
+			__be64 rx_lb_trunc;
+		} all;
+	} u;
+};
+
+#define FW_PORT_LB_STATS_CMD_LBPORT(x) ((x) << 0)
+#define FW_PORT_LB_STATS_CMD_NSTATS(x) ((x) << 4)
+#define FW_PORT_LB_STATS_CMD_BG_BM(x) ((x) << 0)
+#define FW_PORT_LB_STATS_CMD_IX(x) ((x) << 0)
+
+struct fw_rss_ind_tbl_cmd {
+	__be32 op_to_viid;
+#define FW_RSS_IND_TBL_CMD_VIID(x) ((x) << 0)
+	__be32 retval_len16;
+	__be16 niqid;
+	__be16 startidx;
+	__be32 r3;
+	__be32 iq0_to_iq2;
+#define FW_RSS_IND_TBL_CMD_IQ0(x) ((x) << 20)
+#define FW_RSS_IND_TBL_CMD_IQ1(x) ((x) << 10)
+#define FW_RSS_IND_TBL_CMD_IQ2(x) ((x) << 0)
+	__be32 iq3_to_iq5;
+	__be32 iq6_to_iq8;
+	__be32 iq9_to_iq11;
+	__be32 iq12_to_iq14;
+	__be32 iq15_to_iq17;
+	__be32 iq18_to_iq20;
+	__be32 iq21_to_iq23;
+	__be32 iq24_to_iq26;
+	__be32 iq27_to_iq29;
+	__be32 iq30_iq31;
+	__be32 r15_lo;
+};
+
+struct fw_rss_glb_config_cmd {
+	__be32 op_to_write;
+	__be32 retval_len16;
+	union fw_rss_glb_config {
+		struct fw_rss_glb_config_manual {
+			__be32 mode_pkd;
+			__be32 r3;
+			__be64 r4;
+			__be64 r5;
+		} manual;
+		struct fw_rss_glb_config_basicvirtual {
+			__be32 mode_pkd;
+			__be32 synmapen_to_hashtoeplitz;
+#define FW_RSS_GLB_CONFIG_CMD_SYNMAPEN      (1U << 8)
+#define FW_RSS_GLB_CONFIG_CMD_SYN4TUPENIPV6 (1U << 7)
+#define FW_RSS_GLB_CONFIG_CMD_SYN2TUPENIPV6 (1U << 6)
+#define FW_RSS_GLB_CONFIG_CMD_SYN4TUPENIPV4 (1U << 5)
+#define FW_RSS_GLB_CONFIG_CMD_SYN2TUPENIPV4 (1U << 4)
+#define FW_RSS_GLB_CONFIG_CMD_OFDMAPEN      (1U << 3)
+#define FW_RSS_GLB_CONFIG_CMD_TNLMAPEN      (1U << 2)
+#define FW_RSS_GLB_CONFIG_CMD_TNLALLLKP     (1U << 1)
+#define FW_RSS_GLB_CONFIG_CMD_HASHTOEPLITZ  (1U << 0)
+			__be64 r8;
+			__be64 r9;
+		} basicvirtual;
+	} u;
+};
+
+#define FW_RSS_GLB_CONFIG_CMD_MODE(x)	((x) << 28)
+
+#define FW_RSS_GLB_CONFIG_CMD_MODE_MANUAL	0
+#define FW_RSS_GLB_CONFIG_CMD_MODE_BASICVIRTUAL	1
+
+struct fw_rss_vi_config_cmd {
+	__be32 op_to_viid;
+#define FW_RSS_VI_CONFIG_CMD_VIID(x) ((x) << 0)
+	__be32 retval_len16;
+	union fw_rss_vi_config {
+		struct fw_rss_vi_config_manual {
+			__be64 r3;
+			__be64 r4;
+			__be64 r5;
+		} manual;
+		struct fw_rss_vi_config_basicvirtual {
+			__be32 r6;
+			__be32 defaultq_to_ip4udpen;
+#define FW_RSS_VI_CONFIG_CMD_DEFAULTQ(x)  ((x) << 16)
+#define FW_RSS_VI_CONFIG_CMD_IP6FOURTUPEN (1U << 4)
+#define FW_RSS_VI_CONFIG_CMD_IP6TWOTUPEN  (1U << 3)
+#define FW_RSS_VI_CONFIG_CMD_IP4FOURTUPEN (1U << 2)
+#define FW_RSS_VI_CONFIG_CMD_IP4TWOTUPEN  (1U << 1)
+#define FW_RSS_VI_CONFIG_CMD_IP4UDPEN     (1U << 0)
+			__be64 r9;
+			__be64 r10;
+		} basicvirtual;
+	} u;
+};
+
+enum fw_error_type {
+	FW_ERROR_TYPE_EXCEPTION		= 0x0,
+	FW_ERROR_TYPE_HWMODULE		= 0x1,
+	FW_ERROR_TYPE_WR		= 0x2,
+	FW_ERROR_TYPE_ACL		= 0x3,
+};
+
+struct fw_error_cmd {
+	__be32 op_to_type;
+	__be32 len16_pkd;
+	union fw_error {
+		struct fw_error_exception {
+			__be32 info[6];
+		} exception;
+		struct fw_error_hwmodule {
+			__be32 regaddr;
+			__be32 regval;
+		} hwmodule;
+		struct fw_error_wr {
+			__be16 cidx;
+			__be16 pfn_vfn;
+			__be32 eqid;
+			u8 wrhdr[16];
+		} wr;
+		struct fw_error_acl {
+			__be16 cidx;
+			__be16 pfn_vfn;
+			__be32 eqid;
+			__be16 mv_pkd;
+			u8 val[6];
+			__be64 r4;
+		} acl;
+	} u;
+};
+
+struct fw_debug_cmd {
+	__be32 op_type;
+#define FW_DEBUG_CMD_TYPE_GET(x) ((x) & 0xff)
+	__be32 len16_pkd;
+	union fw_debug {
+		struct fw_debug_assert {
+			__be32 fcid;
+			__be32 line;
+			__be32 x;
+			__be32 y;
+			u8 filename_0_7[8];
+			u8 filename_8_15[8];
+			__be64 r3;
+		} assert;
+		struct fw_debug_prt {
+			__be16 dprtstridx;
+			__be16 r3[3];
+			__be32 dprtstrparam0;
+			__be32 dprtstrparam1;
+			__be32 dprtstrparam2;
+			__be32 dprtstrparam3;
+		} prt;
+	} u;
+};
+
+struct fw_hdr {
+	u8 ver;
+	u8 reserved1;
+	__be16	len512;			/* bin length in units of 512-bytes */
+	__be32	fw_ver;			/* firmware version */
+	__be32	tp_microcode_ver;
+	u8 intfver_nic;
+	u8 intfver_vnic;
+	u8 intfver_ofld;
+	u8 intfver_ri;
+	u8 intfver_iscsipdu;
+	u8 intfver_iscsi;
+	u8 intfver_fcoe;
+	u8 reserved2;
+	__be32  reserved3[27];
+};
+
+#define FW_HDR_FW_VER_MAJOR_GET(x) (((x) >> 24) & 0xff)
+#define FW_HDR_FW_VER_MINOR_GET(x) (((x) >> 16) & 0xff)
+#define FW_HDR_FW_VER_MICRO_GET(x) (((x) >> 8) & 0xff)
+#define FW_HDR_FW_VER_BUILD_GET(x) (((x) >> 0) & 0xff)
+#endif /* _T4FW_INTERFACE_H_ */
diff -urN linux-2.6.34-rc3/drivers/net/dm9000.c linux-2.6.34-rc4/drivers/net/dm9000.c
--- linux-2.6.34-rc3/drivers/net/dm9000.c	2010-04-13 02:18:55.908633035 +0000
+++ linux-2.6.34-rc4/drivers/net/dm9000.c	2010-04-13 02:19:01.115633100 +0000
@@ -33,6 +33,7 @@
 #include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/net/e1000e/ethtool.c linux-2.6.34-rc4/drivers/net/e1000e/ethtool.c
--- linux-2.6.34-rc3/drivers/net/e1000e/ethtool.c	2010-04-13 02:18:55.910570371 +0000
+++ linux-2.6.34-rc4/drivers/net/e1000e/ethtool.c	2010-04-13 02:19:01.118633180 +0000
@@ -31,6 +31,7 @@
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "e1000.h"
diff -urN linux-2.6.34-rc3/drivers/net/e1000e/netdev.c linux-2.6.34-rc4/drivers/net/e1000e/netdev.c
--- linux-2.6.34-rc3/drivers/net/e1000e/netdev.c	2010-04-13 02:18:55.912633093 +0000
+++ linux-2.6.34-rc4/drivers/net/e1000e/netdev.c	2010-04-13 02:19:01.120633059 +0000
@@ -36,6 +36,7 @@
 #include <linux/netdevice.h>
 #include <linux/tcp.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip6_checksum.h>
 #include <linux/mii.h>
diff -urN linux-2.6.34-rc3/drivers/net/eepro.c linux-2.6.34-rc4/drivers/net/eepro.c
--- linux-2.6.34-rc3/drivers/net/eepro.c	2010-04-13 02:18:55.912633093 +0000
+++ linux-2.6.34-rc4/drivers/net/eepro.c	2010-04-13 02:19:01.120633059 +0000
@@ -137,7 +137,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/eexpress.c linux-2.6.34-rc4/drivers/net/eexpress.c
--- linux-2.6.34-rc3/drivers/net/eexpress.c	2010-04-13 02:18:55.913633363 +0000
+++ linux-2.6.34-rc4/drivers/net/eexpress.c	2010-04-13 02:19:01.120633059 +0000
@@ -111,7 +111,6 @@
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/mca-legacy.h>
 #include <linux/spinlock.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/net/ehea/ehea_main.c linux-2.6.34-rc4/drivers/net/ehea/ehea_main.c
--- linux-2.6.34-rc3/drivers/net/ehea/ehea_main.c	2010-04-13 02:18:55.913633363 +0000
+++ linux-2.6.34-rc4/drivers/net/ehea/ehea_main.c	2010-04-13 02:19:01.121633086 +0000
@@ -32,6 +32,7 @@
 #include <linux/udp.h>
 #include <linux/if.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/if_ether.h>
 #include <linux/notifier.h>
 #include <linux/reboot.h>
diff -urN linux-2.6.34-rc3/drivers/net/ehea/ehea_qmr.c linux-2.6.34-rc4/drivers/net/ehea/ehea_qmr.c
--- linux-2.6.34-rc3/drivers/net/ehea/ehea_qmr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ehea/ehea_qmr.c	2010-04-13 02:19:01.121633086 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include "ehea.h"
 #include "ehea_phyp.h"
 #include "ehea_qmr.h"
diff -urN linux-2.6.34-rc3/drivers/net/enc28j60.c linux-2.6.34-rc4/drivers/net/enc28j60.c
--- linux-2.6.34-rc3/drivers/net/enc28j60.c	2010-04-13 02:18:55.913633363 +0000
+++ linux-2.6.34-rc4/drivers/net/enc28j60.c	2010-04-13 02:19:01.121633086 +0000
@@ -18,7 +18,6 @@
 #include <linux/types.h>
 #include <linux/fcntl.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/enic/vnic_dev.c linux-2.6.34-rc4/drivers/net/enic/vnic_dev.c
--- linux-2.6.34-rc3/drivers/net/enic/vnic_dev.c	2010-04-13 02:18:55.914633045 +0000
+++ linux-2.6.34-rc4/drivers/net/enic/vnic_dev.c	2010-04-13 02:19:01.122633128 +0000
@@ -23,6 +23,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 
 #include "vnic_resource.h"
 #include "vnic_devcmd.h"
diff -urN linux-2.6.34-rc3/drivers/net/enic/vnic_rq.c linux-2.6.34-rc4/drivers/net/enic/vnic_rq.c
--- linux-2.6.34-rc3/drivers/net/enic/vnic_rq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/enic/vnic_rq.c	2010-04-13 02:19:01.122633128 +0000
@@ -22,6 +22,7 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "vnic_dev.h"
 #include "vnic_rq.h"
diff -urN linux-2.6.34-rc3/drivers/net/enic/vnic_wq.c linux-2.6.34-rc4/drivers/net/enic/vnic_wq.c
--- linux-2.6.34-rc3/drivers/net/enic/vnic_wq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/enic/vnic_wq.c	2010-04-13 02:19:01.122633128 +0000
@@ -22,6 +22,7 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "vnic_dev.h"
 #include "vnic_wq.h"
diff -urN linux-2.6.34-rc3/drivers/net/epic100.c linux-2.6.34-rc4/drivers/net/epic100.c
--- linux-2.6.34-rc3/drivers/net/epic100.c	2010-04-13 02:18:55.915633054 +0000
+++ linux-2.6.34-rc4/drivers/net/epic100.c	2010-04-13 02:19:01.123633196 +0000
@@ -73,7 +73,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/eql.c linux-2.6.34-rc4/drivers/net/eql.c
--- linux-2.6.34-rc3/drivers/net/eql.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/eql.c	2010-04-13 02:19:01.123633196 +0000
@@ -115,6 +115,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/netdevice.h>
 #include <net/net_namespace.h>
diff -urN linux-2.6.34-rc3/drivers/net/eth16i.c linux-2.6.34-rc4/drivers/net/eth16i.c
--- linux-2.6.34-rc3/drivers/net/eth16i.c	2010-04-13 02:18:55.915633054 +0000
+++ linux-2.6.34-rc4/drivers/net/eth16i.c	2010-04-13 02:19:01.123633196 +0000
@@ -152,7 +152,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/ethoc.c linux-2.6.34-rc4/drivers/net/ethoc.c
--- linux-2.6.34-rc3/drivers/net/ethoc.c	2010-04-13 02:18:55.915633054 +0000
+++ linux-2.6.34-rc4/drivers/net/ethoc.c	2010-04-13 02:19:01.123633196 +0000
@@ -18,6 +18,7 @@
 #include <linux/phy.h>
 #include <linux/platform_device.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/ethoc.h>
 
 static int buffer_size = 0x8000; /* 32 KBytes */
diff -urN linux-2.6.34-rc3/drivers/net/fealnx.c linux-2.6.34-rc4/drivers/net/fealnx.c
--- linux-2.6.34-rc3/drivers/net/fealnx.c	2010-04-13 02:18:55.916633026 +0000
+++ linux-2.6.34-rc4/drivers/net/fealnx.c	2010-04-13 02:19:01.124633043 +0000
@@ -74,7 +74,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/fec_mpc52xx.c linux-2.6.34-rc4/drivers/net/fec_mpc52xx.c
--- linux-2.6.34-rc3/drivers/net/fec_mpc52xx.c	2010-04-13 02:18:55.916633026 +0000
+++ linux-2.6.34-rc4/drivers/net/fec_mpc52xx.c	2010-04-13 02:19:01.124633043 +0000
@@ -19,6 +19,7 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/fec_mpc52xx_phy.c linux-2.6.34-rc4/drivers/net/fec_mpc52xx_phy.c
--- linux-2.6.34-rc3/drivers/net/fec_mpc52xx_phy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/fec_mpc52xx_phy.c	2010-04-13 02:19:01.125633076 +0000
@@ -14,6 +14,7 @@
 #include <linux/netdevice.h>
 #include <linux/phy.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 #include <linux/of_mdio.h>
 #include <asm/io.h>
 #include <asm/mpc52xx.h>
diff -urN linux-2.6.34-rc3/drivers/net/forcedeth.c linux-2.6.34-rc4/drivers/net/forcedeth.c
--- linux-2.6.34-rc3/drivers/net/forcedeth.c	2010-04-13 02:18:55.917633059 +0000
+++ linux-2.6.34-rc4/drivers/net/forcedeth.c	2010-04-13 02:19:01.125633076 +0000
@@ -59,6 +59,7 @@
 #include <linux/init.h>
 #include <linux/if_vlan.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/fs_enet/mac-fcc.c linux-2.6.34-rc4/drivers/net/fs_enet/mac-fcc.c
--- linux-2.6.34-rc3/drivers/net/fs_enet/mac-fcc.c	2010-04-13 02:18:55.918633062 +0000
+++ linux-2.6.34-rc4/drivers/net/fs_enet/mac-fcc.c	2010-04-13 02:19:01.126633064 +0000
@@ -19,7 +19,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
@@ -34,6 +33,7 @@
 #include <linux/platform_device.h>
 #include <linux/phy.h>
 #include <linux/of_device.h>
+#include <linux/gfp.h>
 
 #include <asm/immap_cpm2.h>
 #include <asm/mpc8260.h>
diff -urN linux-2.6.34-rc3/drivers/net/fs_enet/mac-fec.c linux-2.6.34-rc4/drivers/net/fs_enet/mac-fec.c
--- linux-2.6.34-rc3/drivers/net/fs_enet/mac-fec.c	2010-04-13 02:18:55.919571680 +0000
+++ linux-2.6.34-rc4/drivers/net/fs_enet/mac-fec.c	2010-04-13 02:19:01.126633064 +0000
@@ -19,7 +19,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
@@ -33,6 +32,7 @@
 #include <linux/fs.h>
 #include <linux/platform_device.h>
 #include <linux/of_device.h>
+#include <linux/gfp.h>
 
 #include <asm/irq.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/fs_enet/mac-scc.c linux-2.6.34-rc4/drivers/net/fs_enet/mac-scc.c
--- linux-2.6.34-rc3/drivers/net/fs_enet/mac-scc.c	2010-04-13 02:18:55.919571680 +0000
+++ linux-2.6.34-rc4/drivers/net/fs_enet/mac-scc.c	2010-04-13 02:19:01.126633064 +0000
@@ -19,7 +19,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/gianfar.c linux-2.6.34-rc4/drivers/net/gianfar.c
--- linux-2.6.34-rc3/drivers/net/gianfar.c	2010-04-13 02:18:55.919571680 +0000
+++ linux-2.6.34-rc4/drivers/net/gianfar.c	2010-04-13 02:19:01.127633030 +0000
@@ -676,7 +676,7 @@
 		priv->rx_queue[i] = NULL;
 
 	for (i = 0; i < priv->num_tx_queues; i++) {
-		priv->tx_queue[i] =  (struct gfar_priv_tx_q *)kmalloc(
+		priv->tx_queue[i] =  (struct gfar_priv_tx_q *)kzalloc(
 				sizeof (struct gfar_priv_tx_q), GFP_KERNEL);
 		if (!priv->tx_queue[i]) {
 			err = -ENOMEM;
@@ -689,7 +689,7 @@
 	}
 
 	for (i = 0; i < priv->num_rx_queues; i++) {
-		priv->rx_queue[i] = (struct gfar_priv_rx_q *)kmalloc(
+		priv->rx_queue[i] = (struct gfar_priv_rx_q *)kzalloc(
 					sizeof (struct gfar_priv_rx_q), GFP_KERNEL);
 		if (!priv->rx_queue[i]) {
 			err = -ENOMEM;
@@ -1120,10 +1120,10 @@
 	/* provided which set of benchmarks. */
 	printk(KERN_INFO "%s: Running with NAPI enabled\n", dev->name);
 	for (i = 0; i < priv->num_rx_queues; i++)
-		printk(KERN_INFO "%s: :RX BD ring size for Q[%d]: %d\n",
+		printk(KERN_INFO "%s: RX BD ring size for Q[%d]: %d\n",
 			dev->name, i, priv->rx_queue[i]->rx_ring_size);
 	for(i = 0; i < priv->num_tx_queues; i++)
-		 printk(KERN_INFO "%s:TX BD ring size for Q[%d]: %d\n",
+		 printk(KERN_INFO "%s: TX BD ring size for Q[%d]: %d\n",
 			dev->name, i, priv->tx_queue[i]->tx_ring_size);
 
 	return 0;
@@ -1638,13 +1638,13 @@
 	/* Go through all the buffer descriptors and free their data buffers */
 	for (i = 0; i < priv->num_tx_queues; i++) {
 		tx_queue = priv->tx_queue[i];
-		if(!tx_queue->tx_skbuff)
+		if(tx_queue->tx_skbuff)
 			free_skb_tx_queue(tx_queue);
 	}
 
 	for (i = 0; i < priv->num_rx_queues; i++) {
 		rx_queue = priv->rx_queue[i];
-		if(!rx_queue->rx_skbuff)
+		if(rx_queue->rx_skbuff)
 			free_skb_rx_queue(rx_queue);
 	}
 
diff -urN linux-2.6.34-rc3/drivers/net/gianfar_ethtool.c linux-2.6.34-rc4/drivers/net/gianfar_ethtool.c
--- linux-2.6.34-rc3/drivers/net/gianfar_ethtool.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/gianfar_ethtool.c	2010-04-13 02:19:01.127633030 +0000
@@ -19,7 +19,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/gianfar_sysfs.c linux-2.6.34-rc4/drivers/net/gianfar_sysfs.c
--- linux-2.6.34-rc3/drivers/net/gianfar_sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/gianfar_sysfs.c	2010-04-13 02:19:01.127633030 +0000
@@ -24,7 +24,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/greth.c linux-2.6.34-rc4/drivers/net/greth.c
--- linux-2.6.34-rc3/drivers/net/greth.c	2010-04-13 02:18:55.920570446 +0000
+++ linux-2.6.34-rc4/drivers/net/greth.c	2010-04-13 02:19:01.128633045 +0000
@@ -34,6 +34,7 @@
 #include <linux/mii.h>
 #include <linux/of_device.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 #include <asm/byteorder.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/hamachi.c linux-2.6.34-rc4/drivers/net/hamachi.c
--- linux-2.6.34-rc3/drivers/net/hamachi.c	2010-04-13 02:18:55.920570446 +0000
+++ linux-2.6.34-rc4/drivers/net/hamachi.c	2010-04-13 02:19:01.129573430 +0000
@@ -153,7 +153,6 @@
 #include <linux/time.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/6pack.c linux-2.6.34-rc4/drivers/net/hamradio/6pack.c
--- linux-2.6.34-rc3/drivers/net/hamradio/6pack.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/6pack.c	2010-04-13 02:19:01.129573430 +0000
@@ -24,6 +24,7 @@
 #include <linux/errno.h>
 #include <linux/netdevice.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/etherdevice.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/bpqether.c linux-2.6.34-rc4/drivers/net/hamradio/bpqether.c
--- linux-2.6.34-rc3/drivers/net/hamradio/bpqether.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/bpqether.c	2010-04-13 02:19:01.129573430 +0000
@@ -61,6 +61,7 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/dmascc.c linux-2.6.34-rc4/drivers/net/hamradio/dmascc.c
--- linux-2.6.34-rc3/drivers/net/hamradio/dmascc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/dmascc.c	2010-04-13 02:19:01.129573430 +0000
@@ -32,6 +32,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/rtnetlink.h>
 #include <linux/sockios.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/hdlcdrv.c linux-2.6.34-rc4/drivers/net/hamradio/hdlcdrv.c
--- linux-2.6.34-rc3/drivers/net/hamradio/hdlcdrv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/hdlcdrv.c	2010-04-13 02:19:01.129573430 +0000
@@ -48,7 +48,6 @@
 #include <linux/net.h>
 #include <linux/in.h>
 #include <linux/if.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/mkiss.c linux-2.6.34-rc4/drivers/net/hamradio/mkiss.c
--- linux-2.6.34-rc3/drivers/net/hamradio/mkiss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/mkiss.c	2010-04-13 02:19:01.129573430 +0000
@@ -26,6 +26,7 @@
 #include <linux/interrupt.h>
 #include <linux/in.h>
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/hamradio/scc.c linux-2.6.34-rc4/drivers/net/hamradio/scc.c
--- linux-2.6.34-rc3/drivers/net/hamradio/scc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hamradio/scc.c	2010-04-13 02:19:01.130633102 +0000
@@ -158,7 +158,6 @@
 #include <linux/in.h>
 #include <linux/fcntl.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/hp100.c linux-2.6.34-rc4/drivers/net/hp100.c
--- linux-2.6.34-rc3/drivers/net/hp100.c	2010-04-13 02:18:55.921633055 +0000
+++ linux-2.6.34-rc4/drivers/net/hp100.c	2010-04-13 02:19:01.130633102 +0000
@@ -102,7 +102,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/eisa.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/net/hplance.c linux-2.6.34-rc4/drivers/net/hplance.c
--- linux-2.6.34-rc3/drivers/net/hplance.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hplance.c	2010-04-13 02:19:01.130633102 +0000
@@ -10,7 +10,6 @@
 #include <linux/types.h>
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/hydra.c linux-2.6.34-rc4/drivers/net/hydra.c
--- linux-2.6.34-rc3/drivers/net/hydra.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/hydra.c	2010-04-13 02:19:01.131633104 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibm_newemac/core.c linux-2.6.34-rc4/drivers/net/ibm_newemac/core.c
--- linux-2.6.34-rc3/drivers/net/ibm_newemac/core.c	2010-04-13 02:18:55.921633055 +0000
+++ linux-2.6.34-rc4/drivers/net/ibm_newemac/core.c	2010-04-13 02:19:01.131633104 +0000
@@ -39,6 +39,7 @@
 #include <linux/bitops.h>
 #include <linux/workqueue.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibm_newemac/core.h linux-2.6.34-rc4/drivers/net/ibm_newemac/core.h
--- linux-2.6.34-rc3/drivers/net/ibm_newemac/core.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ibm_newemac/core.h	2010-04-13 02:19:01.131633104 +0000
@@ -34,6 +34,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/spinlock.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/dcr.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibm_newemac/mal.c linux-2.6.34-rc4/drivers/net/ibm_newemac/mal.c
--- linux-2.6.34-rc3/drivers/net/ibm_newemac/mal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ibm_newemac/mal.c	2010-04-13 02:19:01.131633104 +0000
@@ -26,6 +26,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "core.h"
 #include <asm/dcr-regs.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibm_newemac/rgmii.c linux-2.6.34-rc4/drivers/net/ibm_newemac/rgmii.c
--- linux-2.6.34-rc3/drivers/net/ibm_newemac/rgmii.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ibm_newemac/rgmii.c	2010-04-13 02:19:01.131633104 +0000
@@ -21,6 +21,7 @@
  * option) any later version.
  *
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/ethtool.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibm_newemac/zmii.c linux-2.6.34-rc4/drivers/net/ibm_newemac/zmii.c
--- linux-2.6.34-rc3/drivers/net/ibm_newemac/zmii.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ibm_newemac/zmii.c	2010-04-13 02:19:01.131633104 +0000
@@ -21,6 +21,7 @@
  * option) any later version.
  *
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/ethtool.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibmlana.c linux-2.6.34-rc4/drivers/net/ibmlana.c
--- linux-2.6.34-rc3/drivers/net/ibmlana.c	2010-04-13 02:18:55.921633055 +0000
+++ linux-2.6.34-rc4/drivers/net/ibmlana.c	2010-04-13 02:19:01.132633071 +0000
@@ -79,7 +79,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/drivers/net/ibmveth.c linux-2.6.34-rc4/drivers/net/ibmveth.c
--- linux-2.6.34-rc3/drivers/net/ibmveth.c	2010-04-13 02:18:55.922633037 +0000
+++ linux-2.6.34-rc4/drivers/net/ibmveth.c	2010-04-13 02:19:01.132633071 +0000
@@ -49,6 +49,7 @@
 #include <linux/proc_fs.h>
 #include <linux/in.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <asm/hvcall.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/net/igb/e1000_82575.c linux-2.6.34-rc4/drivers/net/igb/e1000_82575.c
--- linux-2.6.34-rc3/drivers/net/igb/e1000_82575.c	2010-04-13 02:18:55.922633037 +0000
+++ linux-2.6.34-rc4/drivers/net/igb/e1000_82575.c	2010-04-13 02:19:01.132633071 +0000
@@ -30,7 +30,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/if_ether.h>
 
 #include "e1000_mac.h"
diff -urN linux-2.6.34-rc3/drivers/net/igb/igb_ethtool.c linux-2.6.34-rc4/drivers/net/igb/igb_ethtool.c
--- linux-2.6.34-rc3/drivers/net/igb/igb_ethtool.c	2010-04-13 02:18:55.924633012 +0000
+++ linux-2.6.34-rc4/drivers/net/igb/igb_ethtool.c	2010-04-13 02:19:01.134633047 +0000
@@ -35,6 +35,7 @@
 #include <linux/if_ether.h>
 #include <linux/ethtool.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "igb.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/igb/igb_main.c linux-2.6.34-rc4/drivers/net/igb/igb_main.c
--- linux-2.6.34-rc3/drivers/net/igb/igb_main.c	2010-04-13 02:18:55.925633054 +0000
+++ linux-2.6.34-rc4/drivers/net/igb/igb_main.c	2010-04-13 02:19:01.136633061 +0000
@@ -32,6 +32,7 @@
 #include <linux/pagemap.h>
 #include <linux/netdevice.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip6_checksum.h>
 #include <linux/net_tstamp.h>
diff -urN linux-2.6.34-rc3/drivers/net/igbvf/netdev.c linux-2.6.34-rc4/drivers/net/igbvf/netdev.c
--- linux-2.6.34-rc3/drivers/net/igbvf/netdev.c	2010-04-13 02:18:55.926633063 +0000
+++ linux-2.6.34-rc4/drivers/net/igbvf/netdev.c	2010-04-13 02:19:01.136633061 +0000
@@ -35,6 +35,7 @@
 #include <linux/netdevice.h>
 #include <linux/tcp.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip6_checksum.h>
 #include <linux/mii.h>
diff -urN linux-2.6.34-rc3/drivers/net/ioc3-eth.c linux-2.6.34-rc4/drivers/net/ioc3-eth.c
--- linux-2.6.34-rc3/drivers/net/ioc3-eth.c	2010-04-13 02:18:55.926633063 +0000
+++ linux-2.6.34-rc4/drivers/net/ioc3-eth.c	2010-04-13 02:19:01.137633085 +0000
@@ -44,6 +44,7 @@
 #include <linux/tcp.h>
 #include <linux/udp.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #ifdef CONFIG_SERIAL_8250
 #include <linux/serial_core.h>
diff -urN linux-2.6.34-rc3/drivers/net/ipg.c linux-2.6.34-rc4/drivers/net/ipg.c
--- linux-2.6.34-rc3/drivers/net/ipg.c	2010-04-13 02:18:55.926633063 +0000
+++ linux-2.6.34-rc4/drivers/net/ipg.c	2010-04-13 02:19:01.137633085 +0000
@@ -22,6 +22,7 @@
  */
 #include <linux/crc32.h>
 #include <linux/ethtool.h>
+#include <linux/gfp.h>
 #include <linux/mii.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/irda/ali-ircc.c linux-2.6.34-rc4/drivers/net/irda/ali-ircc.c
--- linux-2.6.34-rc3/drivers/net/irda/ali-ircc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/ali-ircc.c	2010-04-13 02:19:01.138633061 +0000
@@ -22,6 +22,7 @@
  ********************************************************************/
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 
 #include <linux/kernel.h>
 #include <linux/types.h>
@@ -29,7 +30,6 @@
 #include <linux/netdevice.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/serial_reg.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/bfin_sir.h linux-2.6.34-rc4/drivers/net/irda/bfin_sir.h
--- linux-2.6.34-rc3/drivers/net/irda/bfin_sir.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/bfin_sir.h	2010-04-13 02:19:01.138633061 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/wrapper.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/irtty-sir.c linux-2.6.34-rc4/drivers/net/irda/irtty-sir.c
--- linux-2.6.34-rc3/drivers/net/irda/irtty-sir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/irtty-sir.c	2010-04-13 02:19:01.139633018 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/nsc-ircc.c linux-2.6.34-rc4/drivers/net/irda/nsc-ircc.c
--- linux-2.6.34-rc3/drivers/net/irda/nsc-ircc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/nsc-ircc.c	2010-04-13 02:19:01.139633018 +0000
@@ -43,6 +43,7 @@
  ********************************************************************/
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 
 #include <linux/kernel.h>
 #include <linux/types.h>
@@ -50,7 +51,6 @@
 #include <linux/netdevice.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/pxaficp_ir.c linux-2.6.34-rc4/drivers/net/irda/pxaficp_ir.c
--- linux-2.6.34-rc3/drivers/net/irda/pxaficp_ir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/pxaficp_ir.c	2010-04-13 02:19:01.139633018 +0000
@@ -18,6 +18,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irmod.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/sh_sir.c linux-2.6.34-rc4/drivers/net/irda/sh_sir.c
--- linux-2.6.34-rc3/drivers/net/irda/sh_sir.c	2010-04-13 02:18:55.928633029 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/sh_sir.c	2010-04-13 02:19:01.140633084 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <net/irda/wrapper.h>
 #include <net/irda/irda_device.h>
 #include <asm/clock.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/sir_dev.c linux-2.6.34-rc4/drivers/net/irda/sir_dev.c
--- linux-2.6.34-rc3/drivers/net/irda/sir_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/sir_dev.c	2010-04-13 02:19:01.140633084 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/irda/smsc-ircc2.c linux-2.6.34-rc4/drivers/net/irda/smsc-ircc2.c
--- linux-2.6.34-rc3/drivers/net/irda/smsc-ircc2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/smsc-ircc2.c	2010-04-13 02:19:01.140633084 +0000
@@ -48,13 +48,13 @@
 #include <linux/netdevice.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/serial_reg.h>
 #include <linux/dma-mapping.h>
 #include <linux/pnp.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/via-ircc.c linux-2.6.34-rc4/drivers/net/irda/via-ircc.c
--- linux-2.6.34-rc3/drivers/net/irda/via-ircc.c	2010-04-13 02:18:55.928633029 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/via-ircc.c	2010-04-13 02:19:01.141633072 +0000
@@ -45,11 +45,11 @@
 #include <linux/netdevice.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/irda/w83977af_ir.c linux-2.6.34-rc4/drivers/net/irda/w83977af_ir.c
--- linux-2.6.34-rc3/drivers/net/irda/w83977af_ir.c	2010-04-13 02:18:55.929571566 +0000
+++ linux-2.6.34-rc4/drivers/net/irda/w83977af_ir.c	2010-04-13 02:19:01.141633072 +0000
@@ -46,10 +46,10 @@
 #include <linux/netdevice.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/iseries_veth.c linux-2.6.34-rc4/drivers/net/iseries_veth.c
--- linux-2.6.34-rc3/drivers/net/iseries_veth.c	2010-04-13 02:18:55.930570516 +0000
+++ linux-2.6.34-rc4/drivers/net/iseries_veth.c	2010-04-13 02:19:01.143633074 +0000
@@ -69,6 +69,7 @@
 #include <linux/mm.h>
 #include <linux/ethtool.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 
 #include <asm/abs_addr.h>
 #include <asm/iseries/mf.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_ethtool.c linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_ethtool.c
--- linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_ethtool.c	2010-04-13 02:18:55.933633085 +0000
+++ linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_ethtool.c	2010-04-13 02:19:01.145633104 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/types.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_fcoe.c linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_fcoe.c
--- linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_fcoe.c	2010-04-13 02:18:55.933633085 +0000
+++ linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_fcoe.c	2010-04-13 02:19:01.146633086 +0000
@@ -31,6 +31,7 @@
 #include "ixgbe_dcb_82599.h"
 #endif /* CONFIG_IXGBE_DCB */
 #include <linux/if_ether.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_device.h>
 #include <scsi/fc/fc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_main.c linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_main.c
--- linux-2.6.34-rc3/drivers/net/ixgbe/ixgbe_main.c	2010-04-13 02:18:55.935633027 +0000
+++ linux-2.6.34-rc4/drivers/net/ixgbe/ixgbe_main.c	2010-04-13 02:19:01.148633064 +0000
@@ -36,6 +36,7 @@
 #include <linux/tcp.h>
 #include <linux/pkt_sched.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip6_checksum.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixgbevf/ethtool.c linux-2.6.34-rc4/drivers/net/ixgbevf/ethtool.c
--- linux-2.6.34-rc3/drivers/net/ixgbevf/ethtool.c	2010-04-13 02:18:55.937633057 +0000
+++ linux-2.6.34-rc4/drivers/net/ixgbevf/ethtool.c	2010-04-13 02:19:01.150633108 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/types.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixgbevf/ixgbevf_main.c linux-2.6.34-rc4/drivers/net/ixgbevf/ixgbevf_main.c
--- linux-2.6.34-rc3/drivers/net/ixgbevf/ixgbevf_main.c	2010-04-13 02:18:55.938633081 +0000
+++ linux-2.6.34-rc4/drivers/net/ixgbevf/ixgbevf_main.c	2010-04-13 02:19:01.152633084 +0000
@@ -39,6 +39,7 @@
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip6_checksum.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/ixp2000/ixpdev.c linux-2.6.34-rc4/drivers/net/ixp2000/ixpdev.c
--- linux-2.6.34-rc3/drivers/net/ixp2000/ixpdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ixp2000/ixpdev.c	2010-04-13 02:19:01.153633093 +0000
@@ -15,6 +15,7 @@
 #include <linux/etherdevice.h>
 #include <linux/init.h>
 #include <linux/moduleparam.h>
+#include <linux/gfp.h>
 #include <asm/hardware/uengine.h>
 #include <asm/io.h>
 #include "ixp2400_rx.ucode"
diff -urN linux-2.6.34-rc3/drivers/net/jazzsonic.c linux-2.6.34-rc4/drivers/net/jazzsonic.c
--- linux-2.6.34-rc3/drivers/net/jazzsonic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/jazzsonic.c	2010-04-13 02:19:01.153633093 +0000
@@ -22,11 +22,11 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/fcntl.h>
+#include <linux/gfp.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/errno.h>
@@ -35,6 +35,7 @@
 #include <linux/skbuff.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/bootinfo.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/net/jme.c linux-2.6.34-rc4/drivers/net/jme.c
--- linux-2.6.34-rc3/drivers/net/jme.c	2010-04-13 02:18:55.940570420 +0000
+++ linux-2.6.34-rc4/drivers/net/jme.c	2010-04-13 02:19:01.153633093 +0000
@@ -37,6 +37,7 @@
 #include <linux/tcp.h>
 #include <linux/udp.h>
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 #include <net/ip6_checksum.h>
 #include "jme.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/ks8851_mll.c linux-2.6.34-rc4/drivers/net/ks8851_mll.c
--- linux-2.6.34-rc3/drivers/net/ks8851_mll.c	2010-04-13 02:18:55.941633080 +0000
+++ linux-2.6.34-rc4/drivers/net/ks8851_mll.c	2010-04-13 02:19:01.154633032 +0000
@@ -31,6 +31,7 @@
 #include <linux/mii.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #define	DRV_NAME	"ks8851_mll"
 
diff -urN linux-2.6.34-rc3/drivers/net/ksz884x.c linux-2.6.34-rc4/drivers/net/ksz884x.c
--- linux-2.6.34-rc3/drivers/net/ksz884x.c	2010-04-13 02:18:55.944633067 +0000
+++ linux-2.6.34-rc4/drivers/net/ksz884x.c	2010-04-13 02:19:01.157633065 +0000
@@ -30,6 +30,7 @@
 #include <linux/if_vlan.h>
 #include <linux/crc32.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 
 /* DMA Registers */
diff -urN linux-2.6.34-rc3/drivers/net/lasi_82596.c linux-2.6.34-rc4/drivers/net/lasi_82596.c
--- linux-2.6.34-rc3/drivers/net/lasi_82596.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/lasi_82596.c	2010-04-13 02:19:01.158633088 +0000
@@ -74,7 +74,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/lib82596.c linux-2.6.34-rc4/drivers/net/lib82596.c
--- linux-2.6.34-rc3/drivers/net/lib82596.c	2010-04-13 02:18:55.944633067 +0000
+++ linux-2.6.34-rc4/drivers/net/lib82596.c	2010-04-13 02:19:01.158633088 +0000
@@ -73,7 +73,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
@@ -85,6 +84,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/io.h>
 #include <linux/irq.h>
+#include <linux/gfp.h>
 
 /* DEBUG flags
  */
diff -urN linux-2.6.34-rc3/drivers/net/ll_temac_main.c linux-2.6.34-rc4/drivers/net/ll_temac_main.c
--- linux-2.6.34-rc3/drivers/net/ll_temac_main.c	2010-04-13 02:18:55.945633088 +0000
+++ linux-2.6.34-rc4/drivers/net/ll_temac_main.c	2010-04-13 02:19:01.158633088 +0000
@@ -49,6 +49,7 @@
 #include <linux/in.h>
 #include <linux/io.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 
 #include "ll_temac.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/ll_temac_mdio.c linux-2.6.34-rc4/drivers/net/ll_temac_mdio.c
--- linux-2.6.34-rc3/drivers/net/ll_temac_mdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ll_temac_mdio.c	2010-04-13 02:19:01.158633088 +0000
@@ -10,6 +10,7 @@
 #include <linux/phy.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/slab.h>
 #include <linux/of_mdio.h>
 
 #include "ll_temac.h"
diff -urN linux-2.6.34-rc3/drivers/net/mac8390.c linux-2.6.34-rc4/drivers/net/mac8390.c
--- linux-2.6.34-rc3/drivers/net/mac8390.c	2010-04-13 02:18:55.946633049 +0000
+++ linux-2.6.34-rc4/drivers/net/mac8390.c	2010-04-13 02:19:01.160633079 +0000
@@ -28,7 +28,6 @@
 #include <linux/ioport.h>
 #include <linux/nubus.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/mac89x0.c linux-2.6.34-rc4/drivers/net/mac89x0.c
--- linux-2.6.34-rc3/drivers/net/mac89x0.c	2010-04-13 02:18:55.946633049 +0000
+++ linux-2.6.34-rc4/drivers/net/mac89x0.c	2010-04-13 02:19:01.160633079 +0000
@@ -88,7 +88,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/nubus.h>
 #include <linux/errno.h>
@@ -98,6 +97,7 @@
 #include <linux/skbuff.h>
 #include <linux/delay.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/mace.c linux-2.6.34-rc4/drivers/net/mace.c
--- linux-2.6.34-rc3/drivers/net/mace.c	2010-04-13 02:18:55.946633049 +0000
+++ linux-2.6.34-rc4/drivers/net/mace.c	2010-04-13 02:19:01.160633079 +0000
@@ -16,6 +16,7 @@
 #include <linux/crc32.h>
 #include <linux/spinlock.h>
 #include <linux/bitrev.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include <asm/dbdma.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/macmace.c linux-2.6.34-rc4/drivers/net/macmace.c
--- linux-2.6.34-rc3/drivers/net/macmace.c	2010-04-13 02:18:55.946633049 +0000
+++ linux-2.6.34-rc4/drivers/net/macmace.c	2010-04-13 02:19:01.160633079 +0000
@@ -30,6 +30,7 @@
 #include <linux/bitrev.h>
 #include <linux/dma-mapping.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/macintosh.h>
diff -urN linux-2.6.34-rc3/drivers/net/macsonic.c linux-2.6.34-rc4/drivers/net/macsonic.c
--- linux-2.6.34-rc3/drivers/net/macsonic.c	2010-04-13 02:18:55.946633049 +0000
+++ linux-2.6.34-rc4/drivers/net/macsonic.c	2010-04-13 02:19:01.161633694 +0000
@@ -35,11 +35,11 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/fcntl.h>
+#include <linux/gfp.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/nubus.h>
@@ -50,6 +50,7 @@
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/bitrev.h>
+#include <linux/slab.h>
 
 #include <asm/bootinfo.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/net/macvtap.c linux-2.6.34-rc4/drivers/net/macvtap.c
--- linux-2.6.34-rc3/drivers/net/macvtap.c	2010-04-13 02:18:55.947571873 +0000
+++ linux-2.6.34-rc4/drivers/net/macvtap.c	2010-04-13 02:19:01.161633694 +0000
@@ -9,6 +9,7 @@
 #include <linux/cache.h>
 #include <linux/sched.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/wait.h>
 #include <linux/cdev.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/cmd.c linux-2.6.34-rc4/drivers/net/mlx4/cmd.c
--- linux-2.6.34-rc3/drivers/net/mlx4/cmd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/cmd.c	2010-04-13 02:19:01.162633180 +0000
@@ -33,6 +33,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/errno.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/cq.c linux-2.6.34-rc4/drivers/net/mlx4/cq.c
--- linux-2.6.34-rc3/drivers/net/mlx4/cq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/cq.c	2010-04-13 02:19:01.162633180 +0000
@@ -35,6 +35,7 @@
  */
 
 #include <linux/hardirq.h>
+#include <linux/gfp.h>
 
 #include <linux/mlx4/cmd.h>
 #include <linux/mlx4/cq.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/en_main.c linux-2.6.34-rc4/drivers/net/mlx4/en_main.c
--- linux-2.6.34-rc3/drivers/net/mlx4/en_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/en_main.c	2010-04-13 02:19:01.162633180 +0000
@@ -35,6 +35,7 @@
 #include <linux/module.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include <linux/mlx4/driver.h>
 #include <linux/mlx4/device.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/en_netdev.c linux-2.6.34-rc4/drivers/net/mlx4/en_netdev.c
--- linux-2.6.34-rc3/drivers/net/mlx4/en_netdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/en_netdev.c	2010-04-13 02:19:01.162633180 +0000
@@ -35,6 +35,7 @@
 #include <linux/tcp.h>
 #include <linux/if_vlan.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <linux/mlx4/driver.h>
 #include <linux/mlx4/device.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/en_resources.c linux-2.6.34-rc4/drivers/net/mlx4/en_resources.c
--- linux-2.6.34-rc3/drivers/net/mlx4/en_resources.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/en_resources.c	2010-04-13 02:19:01.162633180 +0000
@@ -31,6 +31,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/mlx4/qp.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/en_rx.c linux-2.6.34-rc4/drivers/net/mlx4/en_rx.c
--- linux-2.6.34-rc3/drivers/net/mlx4/en_rx.c	2010-04-13 02:18:55.947571873 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/en_rx.c	2010-04-13 02:19:01.162633180 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/mlx4/cq.h>
+#include <linux/slab.h>
 #include <linux/mlx4/qp.h>
 #include <linux/skbuff.h>
 #include <linux/if_ether.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/en_tx.c linux-2.6.34-rc4/drivers/net/mlx4/en_tx.c
--- linux-2.6.34-rc3/drivers/net/mlx4/en_tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/en_tx.c	2010-04-13 02:19:01.162633180 +0000
@@ -33,6 +33,7 @@
 
 #include <asm/page.h>
 #include <linux/mlx4/cq.h>
+#include <linux/slab.h>
 #include <linux/mlx4/qp.h>
 #include <linux/skbuff.h>
 #include <linux/if_vlan.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/eq.c linux-2.6.34-rc4/drivers/net/mlx4/eq.c
--- linux-2.6.34-rc3/drivers/net/mlx4/eq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/eq.c	2010-04-13 02:19:01.162633180 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/dma-mapping.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/icm.c linux-2.6.34-rc4/drivers/net/mlx4/icm.c
--- linux-2.6.34-rc3/drivers/net/mlx4/icm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/icm.c	2010-04-13 02:19:01.163633102 +0000
@@ -34,6 +34,7 @@
 #include <linux/errno.h>
 #include <linux/mm.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include <linux/mlx4/cmd.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/intf.c linux-2.6.34-rc4/drivers/net/mlx4/intf.c
--- linux-2.6.34-rc3/drivers/net/mlx4/intf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/intf.c	2010-04-13 02:19:01.163633102 +0000
@@ -31,6 +31,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "mlx4.h"
 
 struct mlx4_device_context {
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/main.c linux-2.6.34-rc4/drivers/net/mlx4/main.c
--- linux-2.6.34-rc3/drivers/net/mlx4/main.c	2010-04-13 02:18:55.948570559 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/main.c	2010-04-13 02:19:01.163633102 +0000
@@ -38,6 +38,7 @@
 #include <linux/errno.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <linux/mlx4/device.h>
 #include <linux/mlx4/doorbell.h>
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/mcg.c linux-2.6.34-rc4/drivers/net/mlx4/mcg.c
--- linux-2.6.34-rc3/drivers/net/mlx4/mcg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/mcg.c	2010-04-13 02:19:01.163633102 +0000
@@ -32,7 +32,6 @@
  */
 
 #include <linux/string.h>
-#include <linux/slab.h>
 
 #include <linux/mlx4/cmd.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/mr.c linux-2.6.34-rc4/drivers/net/mlx4/mr.c
--- linux-2.6.34-rc3/drivers/net/mlx4/mr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/mr.c	2010-04-13 02:19:01.163633102 +0000
@@ -33,6 +33,7 @@
  */
 
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include <linux/mlx4/cmd.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/profile.c linux-2.6.34-rc4/drivers/net/mlx4/profile.c
--- linux-2.6.34-rc3/drivers/net/mlx4/profile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/profile.c	2010-04-13 02:19:01.163633102 +0000
@@ -32,6 +32,8 @@
  * SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "mlx4.h"
 #include "fw.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/qp.c linux-2.6.34-rc4/drivers/net/mlx4/qp.c
--- linux-2.6.34-rc3/drivers/net/mlx4/qp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/qp.c	2010-04-13 02:19:01.163633102 +0000
@@ -33,6 +33,7 @@
  * SOFTWARE.
  */
 
+#include <linux/gfp.h>
 #include <linux/mlx4/cmd.h>
 #include <linux/mlx4/qp.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/mlx4/srq.c linux-2.6.34-rc4/drivers/net/mlx4/srq.c
--- linux-2.6.34-rc3/drivers/net/mlx4/srq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mlx4/srq.c	2010-04-13 02:19:01.163633102 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/mlx4/cmd.h>
+#include <linux/gfp.h>
 
 #include "mlx4.h"
 #include "icm.h"
diff -urN linux-2.6.34-rc3/drivers/net/mv643xx_eth.c linux-2.6.34-rc4/drivers/net/mv643xx_eth.c
--- linux-2.6.34-rc3/drivers/net/mv643xx_eth.c	2010-04-13 02:18:55.948570559 +0000
+++ linux-2.6.34-rc4/drivers/net/mv643xx_eth.c	2010-04-13 02:19:01.164633114 +0000
@@ -54,6 +54,7 @@
 #include <linux/io.h>
 #include <linux/types.h>
 #include <linux/inet_lro.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 
 static char mv643xx_eth_driver_name[] = "mv643xx_eth";
diff -urN linux-2.6.34-rc3/drivers/net/mvme147.c linux-2.6.34-rc4/drivers/net/mvme147.c
--- linux-2.6.34-rc3/drivers/net/mvme147.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/mvme147.c	2010-04-13 02:19:01.164633114 +0000
@@ -10,11 +10,11 @@
 #include <linux/types.h>
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 /* Used for the temporal inet entries and routing */
 #include <linux/socket.h>
 #include <linux/route.h>
diff -urN linux-2.6.34-rc3/drivers/net/myri10ge/myri10ge.c linux-2.6.34-rc4/drivers/net/myri10ge/myri10ge.c
--- linux-2.6.34-rc3/drivers/net/myri10ge/myri10ge.c	2010-04-13 02:18:55.949570508 +0000
+++ linux-2.6.34-rc4/drivers/net/myri10ge/myri10ge.c	2010-04-13 02:19:01.165633066 +0000
@@ -64,6 +64,7 @@
 #include <linux/moduleparam.h>
 #include <linux/io.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/ip.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/drivers/net/myri_sbus.c linux-2.6.34-rc4/drivers/net/myri_sbus.c
--- linux-2.6.34-rc3/drivers/net/myri_sbus.c	2010-04-13 02:18:55.949570508 +0000
+++ linux-2.6.34-rc4/drivers/net/myri_sbus.c	2010-04-13 02:19:01.165633066 +0000
@@ -14,7 +14,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
@@ -26,6 +25,7 @@
 #include <linux/of.h>
 #include <linux/of_device.h>
 #include <linux/firmware.h>
+#include <linux/gfp.h>
 
 #include <net/dst.h>
 #include <net/arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/ne2.c linux-2.6.34-rc4/drivers/net/ne2.c
--- linux-2.6.34-rc3/drivers/net/ne2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ne2.c	2010-04-13 02:19:01.166633083 +0000
@@ -66,7 +66,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/netconsole.c linux-2.6.34-rc4/drivers/net/netconsole.c
--- linux-2.6.34-rc3/drivers/net/netconsole.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/netconsole.c	2010-04-13 02:19:01.166633083 +0000
@@ -37,6 +37,7 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/console.h>
 #include <linux/moduleparam.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_hw.c linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_hw.c
--- linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_hw.c	2010-04-13 02:18:55.951570600 +0000
+++ linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_hw.c	2010-04-13 02:19:01.168633107 +0000
@@ -23,6 +23,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include "netxen_nic.h"
 #include "netxen_nic_hw.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_init.c linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_init.c
--- linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_init.c	2010-04-13 02:18:55.951570600 +0000
+++ linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_init.c	2010-04-13 02:19:01.168633107 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "netxen_nic.h"
 #include "netxen_nic_hw.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_main.c linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_main.c
--- linux-2.6.34-rc3/drivers/net/netxen/netxen_nic_main.c	2010-04-13 02:18:55.952633065 +0000
+++ linux-2.6.34-rc4/drivers/net/netxen/netxen_nic_main.c	2010-04-13 02:19:01.169633221 +0000
@@ -23,6 +23,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/interrupt.h>
 #include "netxen_nic_hw.h"
diff -urN linux-2.6.34-rc3/drivers/net/ni5010.c linux-2.6.34-rc4/drivers/net/ni5010.c
--- linux-2.6.34-rc3/drivers/net/ni5010.c	2010-04-13 02:18:55.952633065 +0000
+++ linux-2.6.34-rc4/drivers/net/ni5010.c	2010-04-13 02:19:01.169633221 +0000
@@ -51,7 +51,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/ni52.c linux-2.6.34-rc4/drivers/net/ni52.c
--- linux-2.6.34-rc3/drivers/net/ni52.c	2010-04-13 02:18:55.952633065 +0000
+++ linux-2.6.34-rc4/drivers/net/ni52.c	2010-04-13 02:19:01.169633221 +0000
@@ -109,7 +109,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/niu.c linux-2.6.34-rc4/drivers/net/niu.c
--- linux-2.6.34-rc3/drivers/net/niu.c	2010-04-13 02:18:55.955633085 +0000
+++ linux-2.6.34-rc4/drivers/net/niu.c	2010-04-13 02:19:01.172633085 +0000
@@ -25,6 +25,7 @@
 #include <linux/jiffies.h>
 #include <linux/crc32.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/ns83820.c linux-2.6.34-rc4/drivers/net/ns83820.c
--- linux-2.6.34-rc3/drivers/net/ns83820.c	2010-04-13 02:18:55.955633085 +0000
+++ linux-2.6.34-rc4/drivers/net/ns83820.c	2010-04-13 02:19:01.172633085 +0000
@@ -116,6 +116,7 @@
 #include <linux/if_vlan.h>
 #include <linux/rtnetlink.h>
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/octeon/octeon_mgmt.c linux-2.6.34-rc4/drivers/net/octeon/octeon_mgmt.c
--- linux-2.6.34-rc3/drivers/net/octeon/octeon_mgmt.c	2010-04-13 02:18:55.955633085 +0000
+++ linux-2.6.34-rc4/drivers/net/octeon/octeon_mgmt.c	2010-04-13 02:19:01.172633085 +0000
@@ -13,6 +13,7 @@
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 #include <linux/phy.h>
 #include <linux/spinlock.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/pasemi_mac.c linux-2.6.34-rc4/drivers/net/pasemi_mac.c
--- linux-2.6.34-rc3/drivers/net/pasemi_mac.c	2010-04-13 02:18:55.955633085 +0000
+++ linux-2.6.34-rc4/drivers/net/pasemi_mac.c	2010-04-13 02:19:01.173633088 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/dmaengine.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/pcmcia/axnet_cs.c linux-2.6.34-rc4/drivers/net/pcmcia/axnet_cs.c
--- linux-2.6.34-rc3/drivers/net/pcmcia/axnet_cs.c	2010-04-13 02:18:55.957633196 +0000
+++ linux-2.6.34-rc4/drivers/net/pcmcia/axnet_cs.c	2010-04-13 02:19:01.175633117 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/pcmcia/pcnet_cs.c linux-2.6.34-rc4/drivers/net/pcmcia/pcnet_cs.c
--- linux-2.6.34-rc3/drivers/net/pcmcia/pcnet_cs.c	2010-04-13 02:18:55.958633051 +0000
+++ linux-2.6.34-rc4/drivers/net/pcmcia/pcnet_cs.c	2010-04-13 02:19:01.176633078 +0000
@@ -32,7 +32,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/pcmcia/smc91c92_cs.c linux-2.6.34-rc4/drivers/net/pcmcia/smc91c92_cs.c
--- linux-2.6.34-rc3/drivers/net/pcmcia/smc91c92_cs.c	2010-04-13 02:18:55.959571699 +0000
+++ linux-2.6.34-rc4/drivers/net/pcmcia/smc91c92_cs.c	2010-04-13 02:19:01.176633078 +0000
@@ -493,13 +493,14 @@
 {
 	struct net_device *dev = priv;
 	cisparse_t parse;
+	u8 *buf;
 
 	if (pcmcia_parse_tuple(tuple, &parse))
 		return -EINVAL;
 
-	if ((parse.version_1.ns > 3) &&
-	    (cvt_ascii_address(dev,
-			       (parse.version_1.str + parse.version_1.ofs[3]))))
+	buf = parse.version_1.str + parse.version_1.ofs[3];
+
+	if ((parse.version_1.ns > 3) && (cvt_ascii_address(dev, buf) == 0))
 		return 0;
 
 	return -EINVAL;
@@ -528,7 +529,7 @@
     len = pcmcia_get_tuple(link, 0x81, &buf);
     if (buf && len >= 13) {
 	    buf[12] = '\0';
-	    if (cvt_ascii_address(dev, buf))
+	    if (cvt_ascii_address(dev, buf) == 0)
 		    rc = 0;
     }
     kfree(buf);
@@ -910,7 +911,7 @@
 
     if (i != 0) {
 	printk(KERN_NOTICE "smc91c92_cs: Unable to find hardware address.\n");
-	goto config_undo;
+	goto config_failed;
     }
 
     smc->duplex = 0;
@@ -998,6 +999,7 @@
     unregister_netdev(dev);
 config_failed:
     smc91c92_release(link);
+    free_netdev(dev);
     return -ENODEV;
 } /* smc91c92_config */
 
diff -urN linux-2.6.34-rc3/drivers/net/phy/cicada.c linux-2.6.34-rc4/drivers/net/phy/cicada.c
--- linux-2.6.34-rc3/drivers/net/phy/cicada.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/cicada.c	2010-04-13 02:19:01.178633076 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/davicom.c linux-2.6.34-rc4/drivers/net/phy/davicom.c
--- linux-2.6.34-rc3/drivers/net/phy/davicom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/davicom.c	2010-04-13 02:19:01.178633076 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/et1011c.c linux-2.6.34-rc4/drivers/net/phy/et1011c.c
--- linux-2.6.34-rc3/drivers/net/phy/et1011c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/et1011c.c	2010-04-13 02:19:01.178633076 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/fixed.c linux-2.6.34-rc4/drivers/net/phy/fixed.c
--- linux-2.6.34-rc3/drivers/net/phy/fixed.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/fixed.c	2010-04-13 02:19:01.178633076 +0000
@@ -20,6 +20,7 @@
 #include <linux/phy.h>
 #include <linux/phy_fixed.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #define MII_REGS_NUM 29
 
diff -urN linux-2.6.34-rc3/drivers/net/phy/icplus.c linux-2.6.34-rc4/drivers/net/phy/icplus.c
--- linux-2.6.34-rc3/drivers/net/phy/icplus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/icplus.c	2010-04-13 02:19:01.178633076 +0000
@@ -13,7 +13,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/lxt.c linux-2.6.34-rc4/drivers/net/phy/lxt.c
--- linux-2.6.34-rc3/drivers/net/phy/lxt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/lxt.c	2010-04-13 02:19:01.178633076 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/marvell.c linux-2.6.34-rc4/drivers/net/phy/marvell.c
--- linux-2.6.34-rc3/drivers/net/phy/marvell.c	2010-04-13 02:18:55.960570520 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/marvell.c	2010-04-13 02:19:01.178633076 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/mdio-bitbang.c linux-2.6.34-rc4/drivers/net/phy/mdio-bitbang.c
--- linux-2.6.34-rc3/drivers/net/phy/mdio-bitbang.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/mdio-bitbang.c	2010-04-13 02:19:01.178633076 +0000
@@ -19,7 +19,6 @@
 
 #include <linux/module.h>
 #include <linux/mdio-bitbang.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/phy/mdio-octeon.c linux-2.6.34-rc4/drivers/net/phy/mdio-octeon.c
--- linux-2.6.34-rc3/drivers/net/phy/mdio-octeon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/mdio-octeon.c	2010-04-13 02:19:01.178633076 +0000
@@ -6,6 +6,7 @@
  * Copyright (C) 2009 Cavium Networks
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/phy.c linux-2.6.34-rc4/drivers/net/phy/phy.c
--- linux-2.6.34-rc3/drivers/net/phy/phy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/phy.c	2010-04-13 02:19:01.179633087 +0000
@@ -19,7 +19,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/phy/qsemi.c linux-2.6.34-rc4/drivers/net/phy/qsemi.c
--- linux-2.6.34-rc3/drivers/net/phy/qsemi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/phy/qsemi.c	2010-04-13 02:19:01.179633087 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/unistd.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/plip.c linux-2.6.34-rc4/drivers/net/plip.c
--- linux-2.6.34-rc3/drivers/net/plip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/plip.c	2010-04-13 02:19:01.179633087 +0000
@@ -94,6 +94,7 @@
 #include <linux/fcntl.h>
 #include <linux/interrupt.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/if_ether.h>
 #include <linux/in.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/ppp_async.c linux-2.6.34-rc4/drivers/net/ppp_async.c
--- linux-2.6.34-rc3/drivers/net/ppp_async.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ppp_async.c	2010-04-13 02:19:01.179633087 +0000
@@ -31,6 +31,7 @@
 #include <linux/spinlock.h>
 #include <linux/init.h>
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/string.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/ppp_generic.c linux-2.6.34-rc4/drivers/net/ppp_generic.c
--- linux-2.6.34-rc3/drivers/net/ppp_generic.c	2010-04-13 02:18:55.961633135 +0000
+++ linux-2.6.34-rc4/drivers/net/ppp_generic.c	2010-04-13 02:19:01.180633071 +0000
@@ -46,6 +46,7 @@
 #include <linux/stddef.h>
 #include <linux/device.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/slhc_vj.h>
 #include <asm/atomic.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/ppp_synctty.c linux-2.6.34-rc4/drivers/net/ppp_synctty.c
--- linux-2.6.34-rc3/drivers/net/ppp_synctty.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ppp_synctty.c	2010-04-13 02:19:01.180633071 +0000
@@ -44,6 +44,7 @@
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #define PPP_VERSION	"2.4.2"
diff -urN linux-2.6.34-rc3/drivers/net/pppox.c linux-2.6.34-rc4/drivers/net/pppox.c
--- linux-2.6.34-rc3/drivers/net/pppox.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/pppox.c	2010-04-13 02:19:01.181633070 +0000
@@ -22,7 +22,6 @@
 #include <linux/string.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
 #include <linux/net.h>
diff -urN linux-2.6.34-rc3/drivers/net/ps3_gelic_net.c linux-2.6.34-rc4/drivers/net/ps3_gelic_net.c
--- linux-2.6.34-rc3/drivers/net/ps3_gelic_net.c	2010-04-13 02:18:55.962633065 +0000
+++ linux-2.6.34-rc4/drivers/net/ps3_gelic_net.c	2010-04-13 02:19:01.181633070 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/etherdevice.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/ps3_gelic_wireless.c linux-2.6.34-rc4/drivers/net/ps3_gelic_wireless.c
--- linux-2.6.34-rc3/drivers/net/ps3_gelic_wireless.c	2010-04-13 02:18:55.962633065 +0000
+++ linux-2.6.34-rc4/drivers/net/ps3_gelic_wireless.c	2010-04-13 02:19:01.181633070 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/etherdevice.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_hw.c linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_hw.c
--- linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_hw.c	2010-04-13 02:18:55.965570480 +0000
+++ linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_hw.c	2010-04-13 02:19:01.185633102 +0000
@@ -24,6 +24,7 @@
 
 #include "qlcnic.h"
 
+#include <linux/slab.h>
 #include <net/ip.h>
 
 #define MASK(n) ((1ULL<<(n))-1)
diff -urN linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_init.c linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_init.c
--- linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_init.c	2010-04-13 02:18:55.966570455 +0000
+++ linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_init.c	2010-04-13 02:19:01.186633110 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "qlcnic.h"
 
 struct crb_addr_pair {
diff -urN linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_main.c linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_main.c
--- linux-2.6.34-rc3/drivers/net/qlcnic/qlcnic_main.c	2010-04-13 02:18:55.967633091 +0000
+++ linux-2.6.34-rc4/drivers/net/qlcnic/qlcnic_main.c	2010-04-13 02:19:01.187633052 +0000
@@ -22,6 +22,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/qlge/qlge_dbg.c linux-2.6.34-rc4/drivers/net/qlge/qlge_dbg.c
--- linux-2.6.34-rc3/drivers/net/qlge/qlge_dbg.c	2010-04-13 02:18:55.968633058 +0000
+++ linux-2.6.34-rc4/drivers/net/qlge/qlge_dbg.c	2010-04-13 02:19:01.188633066 +0000
@@ -1,3 +1,5 @@
+#include <linux/slab.h>
+
 #include "qlge.h"
 
 /* Read a NIC register from the alternate function. */
diff -urN linux-2.6.34-rc3/drivers/net/qlge/qlge_ethtool.c linux-2.6.34-rc4/drivers/net/qlge/qlge_ethtool.c
--- linux-2.6.34-rc3/drivers/net/qlge/qlge_ethtool.c	2010-04-13 02:18:55.969571910 +0000
+++ linux-2.6.34-rc4/drivers/net/qlge/qlge_ethtool.c	2010-04-13 02:19:01.188633066 +0000
@@ -7,7 +7,6 @@
 #include <linux/dma-mapping.h>
 #include <linux/pagemap.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/dmapool.h>
 #include <linux/mempool.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/net/r6040.c linux-2.6.34-rc4/drivers/net/r6040.c
--- linux-2.6.34-rc3/drivers/net/r6040.c	2010-04-13 02:18:55.971633063 +0000
+++ linux-2.6.34-rc4/drivers/net/r6040.c	2010-04-13 02:19:01.191570382 +0000
@@ -29,7 +29,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/r8169.c linux-2.6.34-rc4/drivers/net/r8169.c
--- linux-2.6.34-rc3/drivers/net/r8169.c	2010-04-13 02:18:55.972633156 +0000
+++ linux-2.6.34-rc4/drivers/net/r8169.c	2010-04-13 02:19:01.192599892 +0000
@@ -3227,8 +3227,8 @@
 	unsigned int max_frame = mtu + VLAN_ETH_HLEN + ETH_FCS_LEN;
 
 	if (max_frame != 16383)
-		printk(KERN_WARNING "WARNING! Changing of MTU on this NIC"
-			"May lead to frame reception errors!\n");
+		printk(KERN_WARNING PFX "WARNING! Changing of MTU on this "
+			"NIC may lead to frame reception errors!\n");
 
 	tp->rx_buf_sz = (max_frame > RX_BUF_SIZE) ? max_frame : RX_BUF_SIZE;
 }
diff -urN linux-2.6.34-rc3/drivers/net/rionet.c linux-2.6.34-rc4/drivers/net/rionet.c
--- linux-2.6.34-rc3/drivers/net/rionet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/rionet.c	2010-04-13 02:19:01.192599892 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/rio.h>
 #include <linux/rio_drv.h>
+#include <linux/slab.h>
 #include <linux/rio_ids.h>
 
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/rrunner.c linux-2.6.34-rc4/drivers/net/rrunner.c
--- linux-2.6.34-rc3/drivers/net/rrunner.c	2010-04-13 02:18:55.972633156 +0000
+++ linux-2.6.34-rc4/drivers/net/rrunner.c	2010-04-13 02:19:01.193633097 +0000
@@ -40,6 +40,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/net/s2io.c linux-2.6.34-rc4/drivers/net/s2io.c
--- linux-2.6.34-rc3/drivers/net/s2io.c	2010-04-13 02:18:55.973633078 +0000
+++ linux-2.6.34-rc4/drivers/net/s2io.c	2010-04-13 02:19:01.194633069 +0000
@@ -79,6 +79,7 @@
 #include <linux/tcp.h>
 #include <linux/uaccess.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <net/tcp.h>
 
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/net/sb1000.c linux-2.6.34-rc4/drivers/net/sb1000.c
--- linux-2.6.34-rc3/drivers/net/sb1000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/sb1000.c	2010-04-13 02:19:01.194633069 +0000
@@ -42,7 +42,6 @@
 #include <linux/errno.h>
 #include <linux/if_cablemodem.h> /* for SIOGCM/SIOSCM stuff */
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/netdevice.h>
 #include <linux/if_arp.h>
@@ -52,6 +51,7 @@
 #include <linux/pnp.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/processor.h>
diff -urN linux-2.6.34-rc3/drivers/net/seeq8005.c linux-2.6.34-rc4/drivers/net/seeq8005.c
--- linux-2.6.34-rc3/drivers/net/seeq8005.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/seeq8005.c	2010-04-13 02:19:01.195633026 +0000
@@ -37,7 +37,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/sfc/efx.c linux-2.6.34-rc4/drivers/net/sfc/efx.c
--- linux-2.6.34-rc3/drivers/net/sfc/efx.c	2010-04-13 02:18:55.974633065 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/efx.c	2010-04-13 02:19:01.195633026 +0000
@@ -20,6 +20,7 @@
 #include <linux/crc32.h>
 #include <linux/ethtool.h>
 #include <linux/topology.h>
+#include <linux/gfp.h>
 #include "net_driver.h"
 #include "efx.h"
 #include "mdio_10g.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/falcon.c linux-2.6.34-rc4/drivers/net/sfc/falcon.c
--- linux-2.6.34-rc3/drivers/net/sfc/falcon.c	2010-04-13 02:18:55.975633053 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/falcon.c	2010-04-13 02:19:01.196633049 +0000
@@ -15,6 +15,7 @@
 #include <linux/seq_file.h>
 #include <linux/i2c.h>
 #include <linux/mii.h>
+#include <linux/slab.h>
 #include "net_driver.h"
 #include "bitfield.h"
 #include "efx.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/mcdi_phy.c linux-2.6.34-rc4/drivers/net/sfc/mcdi_phy.c
--- linux-2.6.34-rc3/drivers/net/sfc/mcdi_phy.c	2010-04-13 02:18:55.976633020 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/mcdi_phy.c	2010-04-13 02:19:01.197633078 +0000
@@ -11,6 +11,7 @@
  * Driver for PHY related operations via MCDI.
  */
 
+#include <linux/slab.h>
 #include "efx.h"
 #include "phy.h"
 #include "mcdi.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/mtd.c linux-2.6.34-rc4/drivers/net/sfc/mtd.c
--- linux-2.6.34-rc3/drivers/net/sfc/mtd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/mtd.c	2010-04-13 02:19:01.197633078 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/mtd/mtd.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/rtnetlink.h>
 
 #define EFX_DRIVER_NAME "sfc_mtd"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/qt202x_phy.c linux-2.6.34-rc4/drivers/net/sfc/qt202x_phy.c
--- linux-2.6.34-rc3/drivers/net/sfc/qt202x_phy.c	2010-04-13 02:18:55.977633110 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/qt202x_phy.c	2010-04-13 02:19:01.198633278 +0000
@@ -10,6 +10,7 @@
  * Driver for AMCC QT202x SFP+ and XFP adapters; see www.amcc.com for details
  */
 
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/delay.h>
 #include "efx.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/rx.c linux-2.6.34-rc4/drivers/net/sfc/rx.c
--- linux-2.6.34-rc3/drivers/net/sfc/rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/rx.c	2010-04-13 02:19:01.198633278 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/socket.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/udp.h>
diff -urN linux-2.6.34-rc3/drivers/net/sfc/selftest.c linux-2.6.34-rc4/drivers/net/sfc/selftest.c
--- linux-2.6.34-rc3/drivers/net/sfc/selftest.c	2010-04-13 02:18:55.977633110 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/selftest.c	2010-04-13 02:19:01.198633278 +0000
@@ -18,6 +18,7 @@
 #include <linux/in.h>
 #include <linux/udp.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include "net_driver.h"
 #include "efx.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/siena.c linux-2.6.34-rc4/drivers/net/sfc/siena.c
--- linux-2.6.34-rc3/drivers/net/sfc/siena.c	2010-04-13 02:18:55.977633110 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/siena.c	2010-04-13 02:19:01.199633112 +0000
@@ -12,6 +12,7 @@
 #include <linux/delay.h>
 #include <linux/pci.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include "net_driver.h"
 #include "bitfield.h"
 #include "efx.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/tenxpress.c linux-2.6.34-rc4/drivers/net/sfc/tenxpress.c
--- linux-2.6.34-rc3/drivers/net/sfc/tenxpress.c	2010-04-13 02:18:55.978633049 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/tenxpress.c	2010-04-13 02:19:01.199633112 +0000
@@ -10,6 +10,7 @@
 #include <linux/delay.h>
 #include <linux/rtnetlink.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "efx.h"
 #include "mdio_10g.h"
 #include "nic.h"
diff -urN linux-2.6.34-rc3/drivers/net/sfc/tx.c linux-2.6.34-rc4/drivers/net/sfc/tx.c
--- linux-2.6.34-rc3/drivers/net/sfc/tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/sfc/tx.c	2010-04-13 02:19:01.199633112 +0000
@@ -13,6 +13,7 @@
 #include <linux/ip.h>
 #include <linux/in.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/ipv6.h>
 #include <linux/if_ether.h>
 #include <linux/highmem.h>
diff -urN linux-2.6.34-rc3/drivers/net/sgiseeq.c linux-2.6.34-rc4/drivers/net/sgiseeq.c
--- linux-2.6.34-rc3/drivers/net/sgiseeq.c	2010-04-13 02:18:55.978633049 +0000
+++ linux-2.6.34-rc4/drivers/net/sgiseeq.c	2010-04-13 02:19:01.199633112 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/types.h>
@@ -592,8 +593,10 @@
 	/* Setup... */
 	len = skb->len;
 	if (len < ETH_ZLEN) {
-		if (skb_padto(skb, ETH_ZLEN))
+		if (skb_padto(skb, ETH_ZLEN)) {
+			spin_unlock_irqrestore(&sp->tx_lock, flags);
 			return NETDEV_TX_OK;
+		}
 		len = ETH_ZLEN;
 	}
 
diff -urN linux-2.6.34-rc3/drivers/net/sh_eth.c linux-2.6.34-rc4/drivers/net/sh_eth.c
--- linux-2.6.34-rc3/drivers/net/sh_eth.c	2010-04-13 02:18:55.978633049 +0000
+++ linux-2.6.34-rc4/drivers/net/sh_eth.c	2010-04-13 02:19:01.200571510 +0000
@@ -31,6 +31,7 @@
 #include <linux/cache.h>
 #include <linux/io.h>
 #include <linux/pm_runtime.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 
 #include "sh_eth.h"
diff -urN linux-2.6.34-rc3/drivers/net/sis190.c linux-2.6.34-rc4/drivers/net/sis190.c
--- linux-2.6.34-rc3/drivers/net/sis190.c	2010-04-13 02:18:55.979571451 +0000
+++ linux-2.6.34-rc4/drivers/net/sis190.c	2010-04-13 02:19:01.200571510 +0000
@@ -32,6 +32,7 @@
 #include <linux/delay.h>
 #include <linux/crc32.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/irq.h>
 
 #define PHY_MAX_ADDR		32
diff -urN linux-2.6.34-rc3/drivers/net/skfp/skfddi.c linux-2.6.34-rc4/drivers/net/skfp/skfddi.c
--- linux-2.6.34-rc3/drivers/net/skfp/skfddi.c	2010-04-13 02:18:55.980570482 +0000
+++ linux-2.6.34-rc4/drivers/net/skfp/skfddi.c	2010-04-13 02:19:01.201570447 +0000
@@ -78,13 +78,13 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
 #include <linux/fddidevice.h>
 #include <linux/skbuff.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/byteorder.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/skge.c linux-2.6.34-rc4/drivers/net/skge.c
--- linux-2.6.34-rc3/drivers/net/skge.c	2010-04-13 02:18:55.980570482 +0000
+++ linux-2.6.34-rc4/drivers/net/skge.c	2010-04-13 02:19:01.202570500 +0000
@@ -42,6 +42,7 @@
 #include <linux/sched.h>
 #include <linux/seq_file.h>
 #include <linux/mii.h>
+#include <linux/slab.h>
 #include <asm/irq.h>
 
 #include "skge.h"
diff -urN linux-2.6.34-rc3/drivers/net/sky2.c linux-2.6.34-rc4/drivers/net/sky2.c
--- linux-2.6.34-rc3/drivers/net/sky2.c	2010-04-13 02:18:55.982633060 +0000
+++ linux-2.6.34-rc4/drivers/net/sky2.c	2010-04-13 02:19:01.203633069 +0000
@@ -33,6 +33,7 @@
 #include <linux/ethtool.h>
 #include <linux/pci.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <linux/tcp.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/drivers/net/slhc.c linux-2.6.34-rc4/drivers/net/slhc.c
--- linux-2.6.34-rc3/drivers/net/slhc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/slhc.c	2010-04-13 02:19:01.204633107 +0000
@@ -51,6 +51,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/slip.c linux-2.6.34-rc4/drivers/net/slip.c
--- linux-2.6.34-rc3/drivers/net/slip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/slip.c	2010-04-13 02:19:01.204633107 +0000
@@ -83,6 +83,7 @@
 #include <linux/compat.h>
 #include <linux/delay.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include "slip.h"
 #ifdef CONFIG_INET
 #include <linux/ip.h>
diff -urN linux-2.6.34-rc3/drivers/net/smc911x.c linux-2.6.34-rc4/drivers/net/smc911x.c
--- linux-2.6.34-rc3/drivers/net/smc911x.c	2010-04-13 02:18:55.982633060 +0000
+++ linux-2.6.34-rc4/drivers/net/smc911x.c	2010-04-13 02:19:01.204633107 +0000
@@ -59,7 +59,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/smc9194.c linux-2.6.34-rc4/drivers/net/smc9194.c
--- linux-2.6.34-rc3/drivers/net/smc9194.c	2010-04-13 02:18:55.983633051 +0000
+++ linux-2.6.34-rc4/drivers/net/smc9194.c	2010-04-13 02:19:01.205633094 +0000
@@ -64,7 +64,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/crc32.h>
diff -urN linux-2.6.34-rc3/drivers/net/smc91x.c linux-2.6.34-rc4/drivers/net/smc91x.c
--- linux-2.6.34-rc3/drivers/net/smc91x.c	2010-04-13 02:18:55.983633051 +0000
+++ linux-2.6.34-rc4/drivers/net/smc91x.c	2010-04-13 02:19:01.205633094 +0000
@@ -70,7 +70,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/smsc911x.c linux-2.6.34-rc4/drivers/net/smsc911x.c
--- linux-2.6.34-rc3/drivers/net/smsc911x.c	2010-04-13 02:18:55.984633033 +0000
+++ linux-2.6.34-rc4/drivers/net/smsc911x.c	2010-04-13 02:19:01.206633081 +0000
@@ -41,7 +41,6 @@
 #include <linux/netdevice.h>
 #include <linux/platform_device.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/bug.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/net/smsc9420.c linux-2.6.34-rc4/drivers/net/smsc9420.c
--- linux-2.6.34-rc3/drivers/net/smsc9420.c	2010-04-13 02:18:55.984633033 +0000
+++ linux-2.6.34-rc4/drivers/net/smsc9420.c	2010-04-13 02:19:01.206633081 +0000
@@ -26,6 +26,7 @@
 #include <linux/if_vlan.h>
 #include <linux/dma-mapping.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "smsc9420.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/sni_82596.c linux-2.6.34-rc4/drivers/net/sni_82596.c
--- linux-2.6.34-rc3/drivers/net/sni_82596.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/sni_82596.c	2010-04-13 02:19:01.206633081 +0000
@@ -8,7 +8,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/spider_net.c linux-2.6.34-rc4/drivers/net/spider_net.c
--- linux-2.6.34-rc3/drivers/net/spider_net.c	2010-04-13 02:18:55.984633033 +0000
+++ linux-2.6.34-rc4/drivers/net/spider_net.c	2010-04-13 02:19:01.207633047 +0000
@@ -31,6 +31,7 @@
 #include <linux/if_vlan.h>
 #include <linux/in.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/ioport.h>
 #include <linux/ip.h>
 #include <linux/kernel.h>
@@ -40,7 +41,6 @@
 #include <linux/device.h>
 #include <linux/pci.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/tcp.h>
 #include <linux/types.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/net/stmmac/Kconfig linux-2.6.34-rc4/drivers/net/stmmac/Kconfig
--- linux-2.6.34-rc3/drivers/net/stmmac/Kconfig	2010-04-13 02:18:55.985633071 +0000
+++ linux-2.6.34-rc4/drivers/net/stmmac/Kconfig	2010-04-13 02:19:01.207633047 +0000
@@ -2,6 +2,7 @@
 	tristate "STMicroelectronics 10/100/1000 Ethernet driver"
 	select MII
 	select PHYLIB
+	select CRC32
 	depends on NETDEVICES && CPU_SUBTYPE_ST40
 	help
 	  This is the driver for the Ethernet IPs are built around a
diff -urN linux-2.6.34-rc3/drivers/net/stmmac/dwmac100.c linux-2.6.34-rc4/drivers/net/stmmac/dwmac100.c
--- linux-2.6.34-rc3/drivers/net/stmmac/dwmac100.c	2010-04-13 02:18:55.986633068 +0000
+++ linux-2.6.34-rc4/drivers/net/stmmac/dwmac100.c	2010-04-13 02:19:01.208633080 +0000
@@ -29,6 +29,7 @@
 #include <linux/crc32.h>
 #include <linux/mii.h>
 #include <linux/phy.h>
+#include <linux/slab.h>
 
 #include "common.h"
 #include "dwmac100.h"
diff -urN linux-2.6.34-rc3/drivers/net/stmmac/dwmac1000_core.c linux-2.6.34-rc4/drivers/net/stmmac/dwmac1000_core.c
--- linux-2.6.34-rc3/drivers/net/stmmac/dwmac1000_core.c	2010-04-13 02:18:55.986633068 +0000
+++ linux-2.6.34-rc4/drivers/net/stmmac/dwmac1000_core.c	2010-04-13 02:19:01.208633080 +0000
@@ -27,6 +27,7 @@
 *******************************************************************************/
 
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include "dwmac1000.h"
 
 static void dwmac1000_core_init(unsigned long ioaddr)
diff -urN linux-2.6.34-rc3/drivers/net/stmmac/stmmac_main.c linux-2.6.34-rc4/drivers/net/stmmac/stmmac_main.c
--- linux-2.6.34-rc3/drivers/net/stmmac/stmmac_main.c	2010-04-13 02:18:55.990633052 +0000
+++ linux-2.6.34-rc4/drivers/net/stmmac/stmmac_main.c	2010-04-13 02:19:01.212633118 +0000
@@ -44,6 +44,7 @@
 #include <linux/phy.h>
 #include <linux/if_vlan.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include "stmmac.h"
 
 #define STMMAC_RESOURCE_NAME	"stmmaceth"
diff -urN linux-2.6.34-rc3/drivers/net/stmmac/stmmac_mdio.c linux-2.6.34-rc4/drivers/net/stmmac/stmmac_mdio.c
--- linux-2.6.34-rc3/drivers/net/stmmac/stmmac_mdio.c	2010-04-13 02:18:55.990633052 +0000
+++ linux-2.6.34-rc4/drivers/net/stmmac/stmmac_mdio.c	2010-04-13 02:19:01.213570574 +0000
@@ -26,6 +26,7 @@
 
 #include <linux/mii.h>
 #include <linux/phy.h>
+#include <linux/slab.h>
 
 #include "stmmac.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/sun3_82586.c linux-2.6.34-rc4/drivers/net/sun3_82586.c
--- linux-2.6.34-rc3/drivers/net/sun3_82586.c	2010-04-13 02:18:55.990633052 +0000
+++ linux-2.6.34-rc4/drivers/net/sun3_82586.c	2010-04-13 02:19:01.213570574 +0000
@@ -33,7 +33,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/sun3lance.c linux-2.6.34-rc4/drivers/net/sun3lance.c
--- linux-2.6.34-rc3/drivers/net/sun3lance.c	2010-04-13 02:18:55.990633052 +0000
+++ linux-2.6.34-rc4/drivers/net/sun3lance.c	2010-04-13 02:19:01.213570574 +0000
@@ -28,7 +28,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/net/sunbmac.c linux-2.6.34-rc4/drivers/net/sunbmac.c
--- linux-2.6.34-rc3/drivers/net/sunbmac.c	2010-04-13 02:18:55.991633058 +0000
+++ linux-2.6.34-rc4/drivers/net/sunbmac.c	2010-04-13 02:19:01.213570574 +0000
@@ -11,7 +11,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
@@ -25,6 +24,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/gfp.h>
 
 #include <asm/auxio.h>
 #include <asm/byteorder.h>
diff -urN linux-2.6.34-rc3/drivers/net/sundance.c linux-2.6.34-rc4/drivers/net/sundance.c
--- linux-2.6.34-rc3/drivers/net/sundance.c	2010-04-13 02:18:55.991633058 +0000
+++ linux-2.6.34-rc4/drivers/net/sundance.c	2010-04-13 02:19:01.213570574 +0000
@@ -84,7 +84,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/sungem.c linux-2.6.34-rc4/drivers/net/sungem.c
--- linux-2.6.34-rc3/drivers/net/sungem.c	2010-04-13 02:18:55.991633058 +0000
+++ linux-2.6.34-rc4/drivers/net/sungem.c	2010-04-13 02:19:01.214633653 +0000
@@ -39,7 +39,6 @@
 #include <linux/ioport.h>
 #include <linux/in.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
@@ -58,6 +57,7 @@
 #include <linux/bitops.h>
 #include <linux/mutex.h>
 #include <linux/mm.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/sunlance.c linux-2.6.34-rc4/drivers/net/sunlance.c
--- linux-2.6.34-rc3/drivers/net/sunlance.c	2010-04-13 02:18:55.992633070 +0000
+++ linux-2.6.34-rc4/drivers/net/sunlance.c	2010-04-13 02:19:01.215633178 +0000
@@ -78,7 +78,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/init.h>
@@ -94,6 +93,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/tehuti.h linux-2.6.34-rc4/drivers/net/tehuti.h
--- linux-2.6.34-rc3/drivers/net/tehuti.h	2010-04-13 02:18:55.994633078 +0000
+++ linux-2.6.34-rc4/drivers/net/tehuti.h	2010-04-13 02:19:01.216633108 +0000
@@ -32,6 +32,7 @@
 #include <linux/firmware.h>
 #include <asm/byteorder.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 /* Compile Time Switches */
 /* start */
diff -urN linux-2.6.34-rc3/drivers/net/tokenring/3c359.c linux-2.6.34-rc4/drivers/net/tokenring/3c359.c
--- linux-2.6.34-rc3/drivers/net/tokenring/3c359.c	2010-04-13 02:18:55.999571389 +0000
+++ linux-2.6.34-rc4/drivers/net/tokenring/3c359.c	2010-04-13 02:19:01.221570578 +0000
@@ -63,6 +63,7 @@
 #include <linux/spinlock.h>
 #include <linux/bitops.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include <net/checksum.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/tokenring/lanstreamer.c linux-2.6.34-rc4/drivers/net/tokenring/lanstreamer.c
--- linux-2.6.34-rc3/drivers/net/tokenring/lanstreamer.c	2010-04-13 02:18:55.999571389 +0000
+++ linux-2.6.34-rc4/drivers/net/tokenring/lanstreamer.c	2010-04-13 02:19:01.222633291 +0000
@@ -121,6 +121,7 @@
 #include <linux/spinlock.h>
 #include <linux/bitops.h>
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/checksum.h>
diff -urN linux-2.6.34-rc3/drivers/net/tokenring/madgemc.c linux-2.6.34-rc4/drivers/net/tokenring/madgemc.c
--- linux-2.6.34-rc3/drivers/net/tokenring/madgemc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/tokenring/madgemc.c	2010-04-13 02:19:01.222633291 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/module.h>
 #include <linux/mca.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/tokenring/smctr.c linux-2.6.34-rc4/drivers/net/tokenring/smctr.c
--- linux-2.6.34-rc3/drivers/net/tokenring/smctr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/tokenring/smctr.c	2010-04-13 02:19:01.223633056 +0000
@@ -36,7 +36,6 @@
 #include <linux/ptrace.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/time.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/tokenring/tms380tr.c linux-2.6.34-rc4/drivers/net/tokenring/tms380tr.c
--- linux-2.6.34-rc3/drivers/net/tokenring/tms380tr.c	2010-04-13 02:18:56.000570489 +0000
+++ linux-2.6.34-rc4/drivers/net/tokenring/tms380tr.c	2010-04-13 02:19:01.223633056 +0000
@@ -85,7 +85,6 @@
 #include <linux/ptrace.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/time.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/net/tsi108_eth.c linux-2.6.34-rc4/drivers/net/tsi108_eth.c
--- linux-2.6.34-rc3/drivers/net/tsi108_eth.c	2010-04-13 02:18:56.000570489 +0000
+++ linux-2.6.34-rc4/drivers/net/tsi108_eth.c	2010-04-13 02:19:01.224633130 +0000
@@ -38,7 +38,6 @@
 #include <linux/etherdevice.h>
 #include <linux/ethtool.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/delay.h>
 #include <linux/crc32.h>
@@ -48,6 +47,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/timer.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/de2104x.c linux-2.6.34-rc4/drivers/net/tulip/de2104x.c
--- linux-2.6.34-rc3/drivers/net/tulip/de2104x.c	2010-04-13 02:18:56.001570290 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/de2104x.c	2010-04-13 02:19:01.225633048 +0000
@@ -42,6 +42,7 @@
 #include <linux/compiler.h>
 #include <linux/rtnetlink.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/de4x5.c linux-2.6.34-rc4/drivers/net/tulip/de4x5.c
--- linux-2.6.34-rc3/drivers/net/tulip/de4x5.c	2010-04-13 02:18:56.002633091 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/de4x5.c	2010-04-13 02:19:01.225633048 +0000
@@ -450,7 +450,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/eisa.h>
 #include <linux/delay.h>
@@ -467,6 +466,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/moduleparam.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/dmfe.c linux-2.6.34-rc4/drivers/net/tulip/dmfe.c
--- linux-2.6.34-rc3/drivers/net/tulip/dmfe.c	2010-04-13 02:18:56.002633091 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/dmfe.c	2010-04-13 02:19:01.226633026 +0000
@@ -74,7 +74,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/eeprom.c linux-2.6.34-rc4/drivers/net/tulip/eeprom.c
--- linux-2.6.34-rc3/drivers/net/tulip/eeprom.c	2010-04-13 02:18:56.002633091 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/eeprom.c	2010-04-13 02:19:01.226633026 +0000
@@ -13,6 +13,7 @@
 */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include "tulip.h"
 #include <linux/init.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/tulip_core.c linux-2.6.34-rc4/drivers/net/tulip/tulip_core.c
--- linux-2.6.34-rc3/drivers/net/tulip/tulip_core.c	2010-04-13 02:18:56.004633031 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/tulip_core.c	2010-04-13 02:19:01.228633045 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include "tulip.h"
 #include <linux/init.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/uli526x.c linux-2.6.34-rc4/drivers/net/tulip/uli526x.c
--- linux-2.6.34-rc3/drivers/net/tulip/uli526x.c	2010-04-13 02:18:56.004633031 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/uli526x.c	2010-04-13 02:19:01.228633045 +0000
@@ -25,7 +25,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/tulip/winbond-840.c linux-2.6.34-rc4/drivers/net/tulip/winbond-840.c
--- linux-2.6.34-rc3/drivers/net/tulip/winbond-840.c	2010-04-13 02:18:56.005633081 +0000
+++ linux-2.6.34-rc4/drivers/net/tulip/winbond-840.c	2010-04-13 02:19:01.229633065 +0000
@@ -114,7 +114,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/net/typhoon.c linux-2.6.34-rc4/drivers/net/typhoon.c
--- linux-2.6.34-rc3/drivers/net/typhoon.c	2010-04-13 02:18:56.006633078 +0000
+++ linux-2.6.34-rc4/drivers/net/typhoon.c	2010-04-13 02:19:01.230571766 +0000
@@ -109,7 +109,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/ucc_geth_ethtool.c linux-2.6.34-rc4/drivers/net/ucc_geth_ethtool.c
--- linux-2.6.34-rc3/drivers/net/ucc_geth_ethtool.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/ucc_geth_ethtool.c	2010-04-13 02:19:01.231570502 +0000
@@ -18,7 +18,6 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/interrupt.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/usb/asix.c linux-2.6.34-rc4/drivers/net/usb/asix.c
--- linux-2.6.34-rc3/drivers/net/usb/asix.c	2010-04-13 02:18:56.008633033 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/asix.c	2010-04-13 02:19:01.232570435 +0000
@@ -34,6 +34,7 @@
 #include <linux/usb.h>
 #include <linux/crc32.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 
 #define DRIVER_VERSION "14-Jun-2006"
 static const char driver_name [] = "asix";
diff -urN linux-2.6.34-rc3/drivers/net/usb/catc.c linux-2.6.34-rc4/drivers/net/usb/catc.c
--- linux-2.6.34-rc3/drivers/net/usb/catc.c	2010-04-13 02:18:56.008633033 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/catc.c	2010-04-13 02:19:01.232570435 +0000
@@ -36,7 +36,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/skbuff.h>
@@ -44,6 +43,7 @@
 #include <linux/ethtool.h>
 #include <linux/crc32.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 
 #undef DEBUG
diff -urN linux-2.6.34-rc3/drivers/net/usb/cdc-phonet.c linux-2.6.34-rc4/drivers/net/usb/cdc-phonet.c
--- linux-2.6.34-rc3/drivers/net/usb/cdc-phonet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/cdc-phonet.c	2010-04-13 02:19:01.232570435 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/usb.h>
 #include <linux/usb/cdc.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/usb/cdc_eem.c linux-2.6.34-rc4/drivers/net/usb/cdc_eem.c
--- linux-2.6.34-rc3/drivers/net/usb/cdc_eem.c	2010-04-13 02:18:56.008633033 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/cdc_eem.c	2010-04-13 02:19:01.232570435 +0000
@@ -30,6 +30,7 @@
 #include <linux/crc32.h>
 #include <linux/usb/cdc.h>
 #include <linux/usb/usbnet.h>
+#include <linux/gfp.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/drivers/net/usb/dm9601.c linux-2.6.34-rc4/drivers/net/usb/dm9601.c
--- linux-2.6.34-rc3/drivers/net/usb/dm9601.c	2010-04-13 02:18:56.008633033 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/dm9601.c	2010-04-13 02:19:01.232570435 +0000
@@ -21,6 +21,7 @@
 #include <linux/usb.h>
 #include <linux/crc32.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 
 /* datasheet:
  http://ptm2.cc.utu.fi/ftp/network/cards/DM9601/From_NET/DM9601-DS-P01-930914.pdf
diff -urN linux-2.6.34-rc3/drivers/net/usb/gl620a.c linux-2.6.34-rc4/drivers/net/usb/gl620a.c
--- linux-2.6.34-rc3/drivers/net/usb/gl620a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/gl620a.c	2010-04-13 02:19:01.233633079 +0000
@@ -30,6 +30,7 @@
 #include <linux/mii.h>
 #include <linux/usb.h>
 #include <linux/usb/usbnet.h>
+#include <linux/gfp.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/drivers/net/usb/int51x1.c linux-2.6.34-rc4/drivers/net/usb/int51x1.c
--- linux-2.6.34-rc3/drivers/net/usb/int51x1.c	2010-04-13 02:18:56.009571803 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/int51x1.c	2010-04-13 02:19:01.233633079 +0000
@@ -29,6 +29,7 @@
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/ethtool.h>
+#include <linux/slab.h>
 #include <linux/mii.h>
 #include <linux/usb.h>
 #include <linux/usb/usbnet.h>
diff -urN linux-2.6.34-rc3/drivers/net/usb/mcs7830.c linux-2.6.34-rc4/drivers/net/usb/mcs7830.c
--- linux-2.6.34-rc3/drivers/net/usb/mcs7830.c	2010-04-13 02:18:56.009571803 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/mcs7830.c	2010-04-13 02:19:01.234633057 +0000
@@ -44,6 +44,7 @@
 #include <linux/mii.h>
 #include <linux/module.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/usbnet.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/usb/net1080.c linux-2.6.34-rc4/drivers/net/usb/net1080.c
--- linux-2.6.34-rc3/drivers/net/usb/net1080.c	2010-04-13 02:18:56.010570471 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/net1080.c	2010-04-13 02:19:01.234633057 +0000
@@ -29,6 +29,7 @@
 #include <linux/mii.h>
 #include <linux/usb.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/usb/rndis_host.c linux-2.6.34-rc4/drivers/net/usb/rndis_host.c
--- linux-2.6.34-rc3/drivers/net/usb/rndis_host.c	2010-04-13 02:18:56.010570471 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/rndis_host.c	2010-04-13 02:19:01.235633056 +0000
@@ -22,6 +22,7 @@
 #include <linux/etherdevice.h>
 #include <linux/ethtool.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include <linux/mii.h>
 #include <linux/usb.h>
 #include <linux/usb/cdc.h>
diff -urN linux-2.6.34-rc3/drivers/net/usb/smsc75xx.c linux-2.6.34-rc4/drivers/net/usb/smsc75xx.c
--- linux-2.6.34-rc3/drivers/net/usb/smsc75xx.c	2010-04-13 02:18:56.011570468 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/smsc75xx.c	2010-04-13 02:19:01.235633056 +0000
@@ -28,6 +28,7 @@
 #include <linux/usb.h>
 #include <linux/crc32.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 #include "smsc75xx.h"
 
 #define SMSC_CHIPNAME			"smsc75xx"
diff -urN linux-2.6.34-rc3/drivers/net/usb/smsc95xx.c linux-2.6.34-rc4/drivers/net/usb/smsc95xx.c
--- linux-2.6.34-rc3/drivers/net/usb/smsc95xx.c	2010-04-13 02:18:56.012633052 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/smsc95xx.c	2010-04-13 02:19:01.236633052 +0000
@@ -28,6 +28,7 @@
 #include <linux/usb.h>
 #include <linux/crc32.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 #include "smsc95xx.h"
 
 #define SMSC_CHIPNAME			"smsc95xx"
diff -urN linux-2.6.34-rc3/drivers/net/usb/usbnet.c linux-2.6.34-rc4/drivers/net/usb/usbnet.c
--- linux-2.6.34-rc3/drivers/net/usb/usbnet.c	2010-04-13 02:18:56.012633052 +0000
+++ linux-2.6.34-rc4/drivers/net/usb/usbnet.c	2010-04-13 02:19:01.237633072 +0000
@@ -43,6 +43,7 @@
 #include <linux/mii.h>
 #include <linux/usb.h>
 #include <linux/usb/usbnet.h>
+#include <linux/slab.h>
 
 #define DRIVER_VERSION		"22-Aug-2005"
 
diff -urN linux-2.6.34-rc3/drivers/net/veth.c linux-2.6.34-rc4/drivers/net/veth.c
--- linux-2.6.34-rc3/drivers/net/veth.c	2010-04-13 02:18:56.013633067 +0000
+++ linux-2.6.34-rc4/drivers/net/veth.c	2010-04-13 02:19:01.237633072 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/ethtool.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/via-rhine.c linux-2.6.34-rc4/drivers/net/via-rhine.c
--- linux-2.6.34-rc3/drivers/net/via-rhine.c	2010-04-13 02:18:56.013633067 +0000
+++ linux-2.6.34-rc4/drivers/net/via-rhine.c	2010-04-13 02:19:01.237633072 +0000
@@ -89,7 +89,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/net/virtio_net.c linux-2.6.34-rc4/drivers/net/virtio_net.c
--- linux-2.6.34-rc3/drivers/net/virtio_net.c	2010-04-13 02:18:56.014633097 +0000
+++ linux-2.6.34-rc4/drivers/net/virtio_net.c	2010-04-13 02:19:01.238633080 +0000
@@ -25,6 +25,7 @@
 #include <linux/virtio_net.h>
 #include <linux/scatterlist.h>
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 
 static int napi_weight = 128;
 module_param(napi_weight, int, 0444);
diff -urN linux-2.6.34-rc3/drivers/net/vxge/vxge-config.c linux-2.6.34-rc4/drivers/net/vxge/vxge-config.c
--- linux-2.6.34-rc3/drivers/net/vxge/vxge-config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/vxge/vxge-config.c	2010-04-13 02:19:01.239633043 +0000
@@ -15,6 +15,7 @@
 #include <linux/etherdevice.h>
 #include <linux/pci.h>
 #include <linux/pci_hotplug.h>
+#include <linux/slab.h>
 
 #include "vxge-traffic.h"
 #include "vxge-config.h"
diff -urN linux-2.6.34-rc3/drivers/net/vxge/vxge-config.h linux-2.6.34-rc4/drivers/net/vxge/vxge-config.h
--- linux-2.6.34-rc3/drivers/net/vxge/vxge-config.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/vxge/vxge-config.h	2010-04-13 02:19:01.240571597 +0000
@@ -14,6 +14,7 @@
 #ifndef VXGE_CONFIG_H
 #define VXGE_CONFIG_H
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #ifndef VXGE_CACHE_LINE_SIZE
 #define VXGE_CACHE_LINE_SIZE 128
diff -urN linux-2.6.34-rc3/drivers/net/vxge/vxge-ethtool.c linux-2.6.34-rc4/drivers/net/vxge/vxge-ethtool.c
--- linux-2.6.34-rc3/drivers/net/vxge/vxge-ethtool.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/vxge/vxge-ethtool.c	2010-04-13 02:19:01.240571597 +0000
@@ -12,6 +12,7 @@
  * Copyright(c) 2002-2009 Neterion Inc.
  ******************************************************************************/
 #include<linux/ethtool.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/vxge/vxge-main.c linux-2.6.34-rc4/drivers/net/vxge/vxge-main.c
--- linux-2.6.34-rc3/drivers/net/vxge/vxge-main.c	2010-04-13 02:18:56.015620059 +0000
+++ linux-2.6.34-rc4/drivers/net/vxge/vxge-main.c	2010-04-13 02:19:01.241570465 +0000
@@ -43,6 +43,7 @@
 
 #include <linux/if_vlan.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/tcp.h>
 #include <net/ip.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/dscc4.c linux-2.6.34-rc4/drivers/net/wan/dscc4.c
--- linux-2.6.34-rc3/drivers/net/wan/dscc4.c	2010-04-13 02:18:56.015620059 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/dscc4.c	2010-04-13 02:19:01.241570465 +0000
@@ -89,6 +89,7 @@
 #include <linux/pci.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/cache.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/farsync.c linux-2.6.34-rc4/drivers/net/wan/farsync.c
--- linux-2.6.34-rc3/drivers/net/wan/farsync.c	2010-04-13 02:18:56.016570634 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/farsync.c	2010-04-13 02:19:01.242570524 +0000
@@ -20,6 +20,7 @@
 #include <linux/version.h>
 #include <linux/pci.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <linux/if.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/hd64570.c linux-2.6.34-rc4/drivers/net/wan/hd64570.c
--- linux-2.6.34-rc3/drivers/net/wan/hd64570.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hd64570.c	2010-04-13 02:19:01.242570524 +0000
@@ -37,7 +37,6 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/types.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/hd64572.c linux-2.6.34-rc4/drivers/net/wan/hd64572.c
--- linux-2.6.34-rc3/drivers/net/wan/hd64572.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hd64572.c	2010-04-13 02:19:01.242570524 +0000
@@ -37,7 +37,6 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/types.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/hdlc_cisco.c linux-2.6.34-rc4/drivers/net/wan/hdlc_cisco.c
--- linux-2.6.34-rc3/drivers/net/wan/hdlc_cisco.c	2010-04-13 02:18:56.016570634 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hdlc_cisco.c	2010-04-13 02:19:01.242570524 +0000
@@ -20,7 +20,6 @@
 #include <linux/poll.h>
 #include <linux/rtnetlink.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 
 #undef DEBUG_HARD_HEADER
 
diff -urN linux-2.6.34-rc3/drivers/net/wan/hdlc_raw.c linux-2.6.34-rc4/drivers/net/wan/hdlc_raw.c
--- linux-2.6.34-rc3/drivers/net/wan/hdlc_raw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hdlc_raw.c	2010-04-13 02:19:01.242570524 +0000
@@ -20,7 +20,6 @@
 #include <linux/poll.h>
 #include <linux/rtnetlink.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 
 
 static int raw_ioctl(struct net_device *dev, struct ifreq *ifr);
diff -urN linux-2.6.34-rc3/drivers/net/wan/hdlc_raw_eth.c linux-2.6.34-rc4/drivers/net/wan/hdlc_raw_eth.c
--- linux-2.6.34-rc3/drivers/net/wan/hdlc_raw_eth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hdlc_raw_eth.c	2010-04-13 02:19:01.242570524 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/errno.h>
 #include <linux/etherdevice.h>
+#include <linux/gfp.h>
 #include <linux/hdlc.h>
 #include <linux/if_arp.h>
 #include <linux/inetdevice.h>
@@ -21,7 +22,6 @@
 #include <linux/poll.h>
 #include <linux/rtnetlink.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 
 static int raw_eth_ioctl(struct net_device *dev, struct ifreq *ifr);
 
diff -urN linux-2.6.34-rc3/drivers/net/wan/hdlc_x25.c linux-2.6.34-rc4/drivers/net/wan/hdlc_x25.c
--- linux-2.6.34-rc3/drivers/net/wan/hdlc_x25.c	2010-04-13 02:18:56.016570634 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hdlc_x25.c	2010-04-13 02:19:01.242570524 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/hdlc.h>
 #include <linux/if_arp.h>
 #include <linux/inetdevice.h>
@@ -21,7 +22,6 @@
 #include <linux/poll.h>
 #include <linux/rtnetlink.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <net/x25device.h>
 
 static int x25_ioctl(struct net_device *dev, struct ifreq *ifr);
diff -urN linux-2.6.34-rc3/drivers/net/wan/hostess_sv11.c linux-2.6.34-rc4/drivers/net/wan/hostess_sv11.c
--- linux-2.6.34-rc3/drivers/net/wan/hostess_sv11.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/hostess_sv11.c	2010-04-13 02:19:01.242570524 +0000
@@ -30,6 +30,7 @@
 #include <linux/delay.h>
 #include <linux/hdlc.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/ixp4xx_hss.c linux-2.6.34-rc4/drivers/net/wan/ixp4xx_hss.c
--- linux-2.6.34-rc3/drivers/net/wan/ixp4xx_hss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/ixp4xx_hss.c	2010-04-13 02:19:01.243633090 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <mach/npe.h>
 #include <mach/qmgr.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wan/lapbether.c linux-2.6.34-rc4/drivers/net/wan/lapbether.c
--- linux-2.6.34-rc3/drivers/net/wan/lapbether.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/lapbether.c	2010-04-13 02:19:01.243633090 +0000
@@ -24,6 +24,7 @@
 #include <linux/types.h>
 #include <linux/socket.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/net.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/lmc/lmc_media.c linux-2.6.34-rc4/drivers/net/wan/lmc/lmc_media.c
--- linux-2.6.34-rc3/drivers/net/wan/lmc/lmc_media.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/lmc/lmc_media.c	2010-04-13 02:19:01.243633090 +0000
@@ -6,7 +6,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/in.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/lmc/lmc_proto.c linux-2.6.34-rc4/drivers/net/wan/lmc/lmc_proto.c
--- linux-2.6.34-rc3/drivers/net/wan/lmc/lmc_proto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/lmc/lmc_proto.c	2010-04-13 02:19:01.243633090 +0000
@@ -25,7 +25,6 @@
 #include <linux/ptrace.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/in.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/pc300_drv.c linux-2.6.34-rc4/drivers/net/wan/pc300_drv.c
--- linux-2.6.34-rc3/drivers/net/wan/pc300_drv.c	2010-04-13 02:18:56.017570493 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/pc300_drv.c	2010-04-13 02:19:01.244633071 +0000
@@ -228,6 +228,7 @@
 #include <linux/etherdevice.h>
 #include <linux/spinlock.h>
 #include <linux/if.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/sbni.c linux-2.6.34-rc4/drivers/net/wan/sbni.c
--- linux-2.6.34-rc3/drivers/net/wan/sbni.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/sbni.c	2010-04-13 02:19:01.244633071 +0000
@@ -43,7 +43,6 @@
 #include <linux/fcntl.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/sealevel.c linux-2.6.34-rc4/drivers/net/wan/sealevel.c
--- linux-2.6.34-rc3/drivers/net/wan/sealevel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/sealevel.c	2010-04-13 02:19:01.244633071 +0000
@@ -23,6 +23,7 @@
 #include <linux/hdlc.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/x25_asy.c linux-2.6.34-rc4/drivers/net/wan/x25_asy.c
--- linux-2.6.34-rc3/drivers/net/wan/x25_asy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/x25_asy.c	2010-04-13 02:19:01.245633070 +0000
@@ -34,6 +34,7 @@
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/compat.h>
+#include <linux/slab.h>
 #include "x25_asy.h"
 
 #include <net/x25device.h>
diff -urN linux-2.6.34-rc3/drivers/net/wan/z85230.c linux-2.6.34-rc4/drivers/net/wan/z85230.c
--- linux-2.6.34-rc3/drivers/net/wan/z85230.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wan/z85230.c	2010-04-13 02:19:01.245633070 +0000
@@ -47,6 +47,7 @@
 #include <linux/hdlc.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <asm/dma.h>
 #include <asm/io.h>
 #define RT_LOCK
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/control.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/control.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/control.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/control.c	2010-04-13 02:19:01.245633070 +0000
@@ -76,6 +76,7 @@
 #include <stdarg.h>
 #include "i2400m.h"
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/wimax/i2400m.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/driver.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/driver.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/driver.c	2010-04-13 02:18:56.017570493 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/driver.c	2010-04-13 02:19:01.246633024 +0000
@@ -69,6 +69,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/suspend.h>
+#include <linux/slab.h>
 
 #define D_SUBMODULE driver
 #include "debug-levels.h"
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/fw.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/fw.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/fw.c	2010-04-13 02:18:56.018570466 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/fw.c	2010-04-13 02:19:01.246633024 +0000
@@ -156,6 +156,7 @@
  */
 #include <linux/firmware.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include "i2400m.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/netdev.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/netdev.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/netdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/netdev.c	2010-04-13 02:19:01.246633024 +0000
@@ -73,6 +73,7 @@
  *                        alloc_netdev.
  */
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
 #include "i2400m.h"
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/op-rfkill.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/op-rfkill.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/op-rfkill.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/op-rfkill.c	2010-04-13 02:19:01.246633024 +0000
@@ -34,6 +34,7 @@
  */
 #include "i2400m.h"
 #include <linux/wimax/i2400m.h>
+#include <linux/slab.h>
 
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/rx.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/rx.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/rx.c	2010-04-13 02:19:01.247633057 +0000
@@ -144,6 +144,7 @@
  *       i2400m_msg_size_check
  *       wimax_msg
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/if_arp.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/sdio-rx.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/sdio-rx.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/sdio-rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/sdio-rx.c	2010-04-13 02:19:01.247633057 +0000
@@ -65,6 +65,7 @@
 #include <linux/skbuff.h>
 #include <linux/mmc/sdio.h>
 #include <linux/mmc/sdio_func.h>
+#include <linux/slab.h>
 #include "i2400m-sdio.h"
 
 #define D_SUBMODULE rx
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/sdio.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/sdio.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/sdio.c	2010-04-13 02:18:56.018570466 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/sdio.c	2010-04-13 02:19:01.247633057 +0000
@@ -48,6 +48,7 @@
  *     __i2400ms_send_barker()
  */
 
+#include <linux/slab.h>
 #include <linux/debugfs.h>
 #include <linux/mmc/sdio_ids.h>
 #include <linux/mmc/sdio.h>
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/tx.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/tx.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/tx.c	2010-04-13 02:19:01.247633057 +0000
@@ -244,6 +244,7 @@
  *                               (FIFO empty).
  */
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include "i2400m.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-fw.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-fw.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-fw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-fw.c	2010-04-13 02:19:01.247633057 +0000
@@ -73,6 +73,7 @@
  *   i2400m_notif_submit
  */
 #include <linux/usb.h>
+#include <linux/gfp.h>
 #include "i2400m-usb.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-notif.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-notif.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-notif.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-notif.c	2010-04-13 02:19:01.247633057 +0000
@@ -56,6 +56,7 @@
  *     i2400mu_rx_kick()
  */
 #include <linux/usb.h>
+#include <linux/slab.h>
 #include "i2400m-usb.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-rx.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-rx.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb-rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb-rx.c	2010-04-13 02:19:01.247633057 +0000
@@ -83,6 +83,7 @@
  * i2400mu_rx_release()            called from i2400mu_bus_dev_stop()
  */
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include "i2400m-usb.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb.c linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb.c
--- linux-2.6.34-rc3/drivers/net/wimax/i2400m/usb.c	2010-04-13 02:18:56.018570466 +0000
+++ linux-2.6.34-rc4/drivers/net/wimax/i2400m/usb.c	2010-04-13 02:19:01.247633057 +0000
@@ -66,6 +66,7 @@
 #include "i2400m-usb.h"
 #include <linux/wimax/i2400m.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 
 #define D_SUBMODULE usb
diff -urN linux-2.6.34-rc3/drivers/net/wireless/adm8211.c linux-2.6.34-rc4/drivers/net/wireless/adm8211.c
--- linux-2.6.34-rc3/drivers/net/wireless/adm8211.c	2010-04-13 02:18:56.018570466 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/adm8211.c	2010-04-13 02:19:01.248633101 +0000
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/if.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/etherdevice.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ar9170/main.c linux-2.6.34-rc4/drivers/net/wireless/ath/ar9170/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ar9170/main.c	2010-04-13 02:18:56.021633086 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ar9170/main.c	2010-04-13 02:19:01.250571390 +0000
@@ -38,6 +38,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/etherdevice.h>
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ar9170/usb.c linux-2.6.34-rc4/drivers/net/wireless/ath/ar9170/usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ar9170/usb.c	2010-04-13 02:18:56.021633086 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ar9170/usb.c	2010-04-13 02:19:01.251570462 +0000
@@ -38,6 +38,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
@@ -94,6 +95,8 @@
 	{ USB_DEVICE(0x04bb, 0x093f) },
 	/* AVM FRITZ!WLAN USB Stick N */
 	{ USB_DEVICE(0x057C, 0x8401) },
+	/* NEC WL300NU-G */
+	{ USB_DEVICE(0x0409, 0x0249) },
 	/* AVM FRITZ!WLAN USB Stick N 2.4 */
 	{ USB_DEVICE(0x057C, 0x8402), .driver_info = AR9170_REQ_FW1_ONLY },
 
@@ -416,7 +419,7 @@
 	spin_unlock_irqrestore(&aru->common.cmdlock, flags);
 
 	usb_fill_int_urb(urb, aru->udev,
-			 usb_sndbulkpipe(aru->udev, AR9170_EP_CMD),
+			 usb_sndintpipe(aru->udev, AR9170_EP_CMD),
 			 aru->common.cmdbuf, plen + 4,
 			 ar9170_usb_tx_urb_complete, NULL, 1);
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/attach.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/attach.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/attach.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/attach.c	2010-04-13 02:19:01.251570462 +0000
@@ -21,6 +21,7 @@
 \*************************************/
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include "ath5k.h"
 #include "reg.h"
 #include "debug.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/base.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/base.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/base.c	2010-04-13 02:18:56.022633050 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/base.c	2010-04-13 02:19:01.252633031 +0000
@@ -50,6 +50,7 @@
 #include <linux/pci.h>
 #include <linux/ethtool.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 #include <net/ieee80211_radiotap.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/eeprom.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/eeprom.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/eeprom.c	2010-04-13 02:18:56.022633050 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/eeprom.c	2010-04-13 02:19:01.252633031 +0000
@@ -21,6 +21,8 @@
 * EEPROM access functions and helpers *
 \*************************************/
 
+#include <linux/slab.h>
+
 #include "ath5k.h"
 #include "reg.h"
 #include "debug.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/phy.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/phy.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath5k/phy.c	2010-04-13 02:18:56.023633113 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath5k/phy.c	2010-04-13 02:19:01.253633054 +0000
@@ -23,6 +23,7 @@
 #define _ATH5K_PHY
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "ath5k.h"
 #include "reg.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/debug.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/debug.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/debug.c	2010-04-13 02:18:56.025633082 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/debug.c	2010-04-13 02:19:01.255633652 +0000
@@ -14,6 +14,7 @@
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include "ath9k.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/hw.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/hw.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/hw.c	2010-04-13 02:18:56.026633025 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/hw.c	2010-04-13 02:19:01.256633636 +0000
@@ -15,6 +15,7 @@
  */
 
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include "hw.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/init.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/init.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/init.c	2010-04-13 02:18:56.026633025 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/init.c	2010-04-13 02:19:01.257633671 +0000
@@ -14,6 +14,8 @@
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "ath9k.h"
 
 static char *dev_info = "ath9k";
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/phy.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/phy.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/phy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/phy.c	2010-04-13 02:19:01.259633573 +0000
@@ -39,6 +39,8 @@
  * AR9287 - 11n single-band 1x1 MIMO for USB
  */
 
+#include <linux/slab.h>
+
 #include "hw.h"
 
 /**
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/rc.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/rc.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/rc.c	2010-04-13 02:18:56.028633060 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/rc.c	2010-04-13 02:19:01.259633573 +0000
@@ -15,6 +15,8 @@
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "ath9k.h"
 
 static const struct ath_rate_table ar5416_11na_ratetable = {
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/virtual.c linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/virtual.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/ath9k/virtual.c	2010-04-13 02:18:56.029571846 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/ath9k/virtual.c	2010-04-13 02:19:01.260633569 +0000
@@ -14,6 +14,8 @@
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#include <linux/slab.h>
+
 #include "ath9k.h"
 
 struct ath9k_vif_iter_data {
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ath/regd.c linux-2.6.34-rc4/drivers/net/wireless/ath/regd.c
--- linux-2.6.34-rc3/drivers/net/wireless/ath/regd.c	2010-04-13 02:18:56.030570484 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ath/regd.c	2010-04-13 02:19:01.261633883 +0000
@@ -15,7 +15,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <net/cfg80211.h>
 #include <net/mac80211.h>
 #include "regd.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/dma.c linux-2.6.34-rc4/drivers/net/wireless/b43/dma.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/dma.c	2010-04-13 02:18:56.031570481 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/dma.c	2010-04-13 02:19:01.261633883 +0000
@@ -38,6 +38,7 @@
 #include <linux/delay.h>
 #include <linux/skbuff.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <asm/div64.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/lo.c linux-2.6.34-rc4/drivers/net/wireless/b43/lo.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/lo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/lo.c	2010-04-13 02:19:01.262634239 +0000
@@ -34,6 +34,7 @@
 
 #include <linux/delay.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 
 static struct b43_lo_calib *b43_find_lo_calib(struct b43_txpower_lo_control *lo,
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/main.c linux-2.6.34-rc4/drivers/net/wireless/b43/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/main.c	2010-04-13 02:18:56.031570481 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/main.c	2010-04-13 02:19:01.263634043 +0000
@@ -42,6 +42,7 @@
 #include <linux/skbuff.h>
 #include <linux/io.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include "b43.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/pcmcia.c linux-2.6.34-rc4/drivers/net/wireless/b43/pcmcia.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/pcmcia.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/pcmcia.c	2010-04-13 02:19:01.263634043 +0000
@@ -24,6 +24,7 @@
 #include "pcmcia.h"
 
 #include <linux/ssb/ssb.h>
+#include <linux/slab.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/cs.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/phy_a.c linux-2.6.34-rc4/drivers/net/wireless/b43/phy_a.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/phy_a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/phy_a.c	2010-04-13 02:19:01.263634043 +0000
@@ -26,6 +26,8 @@
 
 */
 
+#include <linux/slab.h>
+
 #include "b43.h"
 #include "phy_a.h"
 #include "phy_common.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/phy_g.c linux-2.6.34-rc4/drivers/net/wireless/b43/phy_g.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/phy_g.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/phy_g.c	2010-04-13 02:19:01.264633820 +0000
@@ -33,6 +33,7 @@
 #include "main.h"
 
 #include <linux/bitrev.h>
+#include <linux/slab.h>
 
 
 static const s8 b43_tssi2dbm_g_table[] = {
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/phy_lp.c linux-2.6.34-rc4/drivers/net/wireless/b43/phy_lp.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/phy_lp.c	2010-04-13 02:18:56.032570504 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/phy_lp.c	2010-04-13 02:19:01.264633820 +0000
@@ -23,6 +23,8 @@
 
 */
 
+#include <linux/slab.h>
+
 #include "b43.h"
 #include "main.h"
 #include "phy_lp.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/phy_n.c linux-2.6.34-rc4/drivers/net/wireless/b43/phy_n.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/phy_n.c	2010-04-13 02:18:56.034633068 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/phy_n.c	2010-04-13 02:19:01.266633857 +0000
@@ -23,6 +23,7 @@
 */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include "b43.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/pio.c linux-2.6.34-rc4/drivers/net/wireless/b43/pio.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/pio.c	2010-04-13 02:18:56.034633068 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/pio.c	2010-04-13 02:19:01.266633857 +0000
@@ -31,6 +31,7 @@
 
 #include <linux/delay.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 
 static u16 generate_cookie(struct b43_pio_txqueue *q,
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43/sdio.c linux-2.6.34-rc4/drivers/net/wireless/b43/sdio.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43/sdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43/sdio.c	2010-04-13 02:19:01.267634081 +0000
@@ -16,6 +16,7 @@
 #include <linux/mmc/card.h>
 #include <linux/mmc/sdio_func.h>
 #include <linux/mmc/sdio_ids.h>
+#include <linux/slab.h>
 #include <linux/ssb/ssb.h>
 
 #include "sdio.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43legacy/dma.c linux-2.6.34-rc4/drivers/net/wireless/b43legacy/dma.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43legacy/dma.c	2010-04-13 02:18:56.035633743 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43legacy/dma.c	2010-04-13 02:19:01.268635943 +0000
@@ -37,6 +37,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/dst.h>
 
 /* 32bit DMA ops. */
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43legacy/main.c linux-2.6.34-rc4/drivers/net/wireless/b43legacy/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43legacy/main.c	2010-04-13 02:18:56.036633148 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43legacy/main.c	2010-04-13 02:19:01.269634085 +0000
@@ -40,6 +40,7 @@
 #include <linux/sched.h>
 #include <linux/skbuff.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <net/dst.h>
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43legacy/phy.c linux-2.6.34-rc4/drivers/net/wireless/b43legacy/phy.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43legacy/phy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43legacy/phy.c	2010-04-13 02:19:01.269634085 +0000
@@ -32,6 +32,7 @@
 #include <linux/delay.h>
 #include <linux/pci.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include "b43legacy.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/b43legacy/pio.c linux-2.6.34-rc4/drivers/net/wireless/b43legacy/pio.c
--- linux-2.6.34-rc3/drivers/net/wireless/b43legacy/pio.c	2010-04-13 02:18:56.036633148 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/b43legacy/pio.c	2010-04-13 02:19:01.269634085 +0000
@@ -29,6 +29,7 @@
 #include "xmit.h"
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 
 static void tx_start(struct b43legacy_pioqueue *queue)
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_80211_rx.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_80211_rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_80211_rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_80211_rx.c	2010-04-13 02:19:01.270633775 +0000
@@ -1,4 +1,5 @@
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <net/lib80211.h>
 #include <linux/if_arp.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_80211_tx.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_80211_tx.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_80211_tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_80211_tx.c	2010-04-13 02:19:01.270633775 +0000
@@ -1,3 +1,5 @@
+#include <linux/slab.h>
+
 #include "hostap_80211.h"
 #include "hostap_common.h"
 #include "hostap_wlan.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_ap.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_ap.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_ap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_ap.c	2010-04-13 02:19:01.270633775 +0000
@@ -20,6 +20,7 @@
 #include <linux/delay.h>
 #include <linux/random.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 
 #include "hostap_wlan.h"
 #include "hostap.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_cs.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_cs.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_cs.c	2010-04-13 02:18:56.037633088 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_cs.c	2010-04-13 02:19:01.270633775 +0000
@@ -3,6 +3,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/if.h>
+#include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/timer.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_info.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_info.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_info.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_info.c	2010-04-13 02:19:01.271633534 +0000
@@ -2,6 +2,7 @@
 
 #include <linux/if_arp.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "hostap_wlan.h"
 #include "hostap.h"
 #include "hostap_ap.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_ioctl.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_ioctl.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_ioctl.c	2010-04-13 02:19:01.272633728 +0000
@@ -1,5 +1,6 @@
 /* ioctl() (mostly Linux Wireless Extensions) routines for Host AP driver */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_pci.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_pci.c	2010-04-13 02:18:56.037633088 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_pci.c	2010-04-13 02:19:01.272633728 +0000
@@ -9,6 +9,7 @@
 #include <linux/if.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/wireless.h>
 #include <net/iw_handler.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_plx.c linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_plx.c
--- linux-2.6.34-rc3/drivers/net/wireless/hostap/hostap_plx.c	2010-04-13 02:18:56.037633088 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/hostap/hostap_plx.c	2010-04-13 02:19:01.272633728 +0000
@@ -12,6 +12,7 @@
 #include <linux/if.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/wireless.h>
 #include <net/iw_handler.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/ipw2200.c linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/ipw2200.c
--- linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/ipw2200.c	2010-04-13 02:18:56.040570562 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/ipw2200.c	2010-04-13 02:19:01.275633614 +0000
@@ -31,6 +31,7 @@
 ******************************************************************************/
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "ipw2200.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_geo.c linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_geo.c
--- linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_geo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_geo.c	2010-04-13 02:19:01.276633706 +0000
@@ -34,7 +34,6 @@
 #include <linux/netdevice.h>
 #include <linux/proc_fs.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/tcp.h>
 #include <linux/types.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_rx.c linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_rx.c	2010-04-13 02:19:01.276633706 +0000
@@ -17,6 +17,7 @@
 #include <linux/errno.h>
 #include <linux/if_arp.h>
 #include <linux/in6.h>
+#include <linux/gfp.h>
 #include <linux/in.h>
 #include <linux/ip.h>
 #include <linux/kernel.h>
@@ -24,7 +25,6 @@
 #include <linux/netdevice.h>
 #include <linux/proc_fs.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/tcp.h>
 #include <linux/types.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_wx.c linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_wx.c
--- linux-2.6.34-rc3/drivers/net/wireless/ipw2x00/libipw_wx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ipw2x00/libipw_wx.c	2010-04-13 02:19:01.276633706 +0000
@@ -31,6 +31,7 @@
 ******************************************************************************/
 
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/jiffies.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-3945-rs.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-3945-rs.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-3945-rs.c	2010-04-13 02:18:56.041633090 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-3945-rs.c	2010-04-13 02:19:01.277633144 +0000
@@ -27,6 +27,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <net/mac80211.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-3945.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-3945.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-3945.c	2010-04-13 02:18:56.041633090 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-3945.c	2010-04-13 02:19:01.278633068 +0000
@@ -27,6 +27,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-4965.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-4965.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-4965.c	2010-04-13 02:18:56.042633039 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-4965.c	2010-04-13 02:19:01.278633068 +0000
@@ -2041,16 +2041,14 @@
 				   tx_resp->failure_frame);
 
 		freed = iwl_tx_queue_reclaim(priv, txq_id, index);
-		if (qc && likely(sta_id != IWL_INVALID_STATION))
-			priv->stations[sta_id].tid[tid].tfds_in_queue -= freed;
+		iwl_free_tfds_in_queue(priv, sta_id, tid, freed);
 
 		if (priv->mac80211_registered &&
 		    (iwl_queue_space(&txq->q) > txq->q.low_mark))
 			iwl_wake_queue(priv, txq_id);
 	}
 
-	if (qc && likely(sta_id != IWL_INVALID_STATION))
-		iwl_txq_check_empty(priv, sta_id, tid, txq_id);
+	iwl_txq_check_empty(priv, sta_id, tid, txq_id);
 
 	if (iwl_check_bits(status, TX_ABORT_REQUIRED_MSK))
 		IWL_ERR(priv, "TODO:  Implement Tx ABORT REQUIRED!!!\n");
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-agn-rs.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-agn-rs.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-agn-rs.c	2010-04-13 02:18:56.044633071 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-agn-rs.c	2010-04-13 02:19:01.280633699 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <net/mac80211.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-agn.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-agn.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-agn.c	2010-04-13 02:18:56.045633101 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-agn.c	2010-04-13 02:19:01.281633233 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
@@ -1258,7 +1259,15 @@
 	/* Ack/clear/reset pending uCode interrupts.
 	 * Note:  Some bits in CSR_INT are "OR" of bits in CSR_FH_INT_STATUS,
 	 */
-	iwl_write32(priv, CSR_INT, priv->inta);
+	/* There is a hardware bug in the interrupt mask function that some
+	 * interrupts (i.e. CSR_INT_BIT_SCD) can still be generated even if
+	 * they are disabled in the CSR_INT_MASK register. Furthermore the
+	 * ICT interrupt handling mechanism has another bug that might cause
+	 * these unmasked interrupts fail to be detected. We workaround the
+	 * hardware bugs here by ACKing all the possible interrupts so that
+	 * interrupt coalescing can still be achieved.
+	 */
+	iwl_write32(priv, CSR_INT, priv->inta | ~priv->inta_mask);
 
 	inta = priv->inta;
 
@@ -2644,7 +2653,7 @@
 		BIT(NL80211_IFTYPE_STATION) |
 		BIT(NL80211_IFTYPE_ADHOC);
 
-	hw->wiphy->flags |= WIPHY_FLAG_STRICT_REGULATORY |
+	hw->wiphy->flags |= WIPHY_FLAG_CUSTOM_REGULATORY |
 			    WIPHY_FLAG_DISABLE_BEACON_HINTS;
 
 	/*
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-calib.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-calib.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-calib.c	2010-04-13 02:18:56.045633101 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-calib.c	2010-04-13 02:19:01.281633233 +0000
@@ -60,6 +60,7 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *****************************************************************************/
 
+#include <linux/slab.h>
 #include <net/mac80211.h>
 
 #include "iwl-dev.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-core.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-core.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-core.c	2010-04-13 02:18:56.046633104 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-core.c	2010-04-13 02:19:01.283633612 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/etherdevice.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 
 #include "iwl-eeprom.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-debugfs.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-debugfs.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-debugfs.c	2010-04-13 02:18:56.048633130 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-debugfs.c	2010-04-13 02:19:01.285633769 +0000
@@ -26,6 +26,7 @@
  * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497
  *****************************************************************************/
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-devtrace.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-devtrace.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-devtrace.c	2010-04-13 02:18:56.049571862 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-devtrace.c	2010-04-13 02:19:01.285633769 +0000
@@ -28,6 +28,8 @@
 
 /* sparse doesn't like tracepoint macros */
 #ifndef __CHECKER__
+#include "iwl-dev.h"
+
 #define CREATE_TRACE_POINTS
 #include "iwl-devtrace.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-devtrace.h linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-devtrace.h
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-devtrace.h	2010-04-13 02:18:56.049571862 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-devtrace.h	2010-04-13 02:19:01.285633769 +0000
@@ -28,7 +28,6 @@
 #define __IWLWIFI_DEVICE_TRACE
 
 #include <linux/tracepoint.h>
-#include "iwl-dev.h"
 
 #if !defined(CONFIG_IWLWIFI_DEVICE_TRACING) || defined(__CHECKER__)
 #undef TRACE_EVENT
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-eeprom.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-eeprom.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-eeprom.c	2010-04-13 02:18:56.049571862 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-eeprom.c	2010-04-13 02:19:01.286634104 +0000
@@ -63,6 +63,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-io.h linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-io.h
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-io.h	2010-04-13 02:18:56.050570617 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-io.h	2010-04-13 02:19:01.286634104 +0000
@@ -31,6 +31,7 @@
 
 #include <linux/io.h>
 
+#include "iwl-dev.h"
 #include "iwl-debug.h"
 #include "iwl-devtrace.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-power.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-power.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-power.c	2010-04-13 02:18:56.050570617 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-power.c	2010-04-13 02:19:01.287633150 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-rx.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-rx.c	2010-04-13 02:18:56.050570617 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-rx.c	2010-04-13 02:19:01.287633150 +0000
@@ -28,6 +28,7 @@
  *****************************************************************************/
 
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include <asm/unaligned.h>
 #include "iwl-eeprom.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-scan.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-scan.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-scan.c	2010-04-13 02:18:56.051633078 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-scan.c	2010-04-13 02:19:01.288633560 +0000
@@ -25,6 +25,7 @@
  *  Intel Linux Wireless <ilw@linux.intel.com>
  * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497
  *****************************************************************************/
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/etherdevice.h>
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-tx.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-tx.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl-tx.c	2010-04-13 02:18:56.053633078 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl-tx.c	2010-04-13 02:19:01.290633183 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/etherdevice.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "iwl-eeprom.h"
 #include "iwl-dev.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl3945-base.c linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl3945-base.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwlwifi/iwl3945-base.c	2010-04-13 02:18:56.054633345 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwlwifi/iwl3945-base.c	2010-04-13 02:19:01.291633041 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
@@ -1955,7 +1956,7 @@
 {
 	int i;
 
-	for (i = 0; i < IWL_RATE_COUNT; i++) {
+	for (i = 0; i < IWL_RATE_COUNT_LEGACY; i++) {
 		rates[i].bitrate = iwl3945_rates[i].ieee * 5;
 		rates[i].hw_value = i; /* Rate scaling will work on indexes */
 		rates[i].hw_value_short = i;
@@ -3921,7 +3922,7 @@
 		BIT(NL80211_IFTYPE_STATION) |
 		BIT(NL80211_IFTYPE_ADHOC);
 
-	hw->wiphy->flags |= WIPHY_FLAG_STRICT_REGULATORY |
+	hw->wiphy->flags |= WIPHY_FLAG_CUSTOM_REGULATORY |
 			    WIPHY_FLAG_DISABLE_BEACON_HINTS;
 
 	hw->wiphy->max_scan_ssids = PROBE_OPTION_MAX_3945;
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/cfg80211.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/cfg80211.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/cfg80211.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/cfg80211.c	2010-04-13 02:19:01.291633041 +0000
@@ -27,6 +27,7 @@
 #include <linux/etherdevice.h>
 #include <linux/wireless.h>
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/cfg80211.h>
 
 #include "iwm.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/commands.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/commands.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/commands.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/commands.c	2010-04-13 02:19:01.291633041 +0000
@@ -41,6 +41,7 @@
 #include <linux/etherdevice.h>
 #include <linux/ieee80211.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "iwm.h"
 #include "bus.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/debugfs.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/debugfs.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/debugfs.c	2010-04-13 02:18:56.054633345 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/debugfs.c	2010-04-13 02:19:01.291633041 +0000
@@ -21,6 +21,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/bitops.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/eeprom.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/eeprom.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/eeprom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/eeprom.c	2010-04-13 02:19:01.291633041 +0000
@@ -37,6 +37,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "iwm.h"
 #include "umac.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/hal.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/hal.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/hal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/hal.c	2010-04-13 02:19:01.291633041 +0000
@@ -98,6 +98,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include "iwm.h"
 #include "bus.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/main.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/main.c	2010-04-13 02:19:01.292633628 +0000
@@ -41,6 +41,7 @@
 #include <linux/sched.h>
 #include <linux/ieee80211.h>
 #include <linux/wireless.h>
+#include <linux/slab.h>
 
 #include "iwm.h"
 #include "debug.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/netdev.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/netdev.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/netdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/netdev.c	2010-04-13 02:19:01.292633628 +0000
@@ -46,6 +46,7 @@
  *              -> sdio_disable_func()
  */
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include "iwm.h"
 #include "commands.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/rx.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/rx.c	2010-04-13 02:18:56.055633089 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/rx.c	2010-04-13 02:19:01.292633628 +0000
@@ -44,6 +44,7 @@
 #include <linux/ieee80211.h>
 #include <linux/if_arp.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 
 #include "iwm.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/sdio.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/sdio.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/sdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/sdio.c	2010-04-13 02:19:01.292633628 +0000
@@ -63,6 +63,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/debugfs.h>
 #include <linux/mmc/sdio_ids.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/tx.c linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/tx.c
--- linux-2.6.34-rc3/drivers/net/wireless/iwmc3200wifi/tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/iwmc3200wifi/tx.c	2010-04-13 02:19:01.292633628 +0000
@@ -64,6 +64,7 @@
  * (i.e. half of the max size). [iwm_tx_worker]
  */
 
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
 #include <linux/ieee80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/assoc.c linux-2.6.34-rc4/drivers/net/wireless/libertas/assoc.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/assoc.c	2010-04-13 02:18:56.055633089 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/assoc.c	2010-04-13 02:19:01.293633048 +0000
@@ -4,6 +4,7 @@
 #include <linux/etherdevice.h>
 #include <linux/ieee80211.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/lib80211.h>
 
 #include "assoc.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/cfg.c linux-2.6.34-rc4/drivers/net/wireless/libertas/cfg.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/cfg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/cfg.c	2010-04-13 02:19:01.293633048 +0000
@@ -6,6 +6,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <net/cfg80211.h>
 
 #include "cfg.h"
@@ -172,6 +173,8 @@
 	if (ret < 0)
 		lbs_pr_err("cannot register wiphy device\n");
 
+	priv->wiphy_registered = true;
+
 	ret = register_netdev(priv->dev);
 	if (ret)
 		lbs_pr_err("cannot register network device\n");
@@ -190,9 +193,11 @@
 	if (!wdev)
 		return;
 
-	if (wdev->wiphy) {
+	if (priv->wiphy_registered)
 		wiphy_unregister(wdev->wiphy);
+
+	if (wdev->wiphy)
 		wiphy_free(wdev->wiphy);
-	}
+
 	kfree(wdev);
 }
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/cmd.c linux-2.6.34-rc4/drivers/net/wireless/libertas/cmd.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/cmd.c	2010-04-13 02:18:56.056633026 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/cmd.c	2010-04-13 02:19:01.294633095 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/kfifo.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "host.h"
 #include "decl.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/cmdresp.c linux-2.6.34-rc4/drivers/net/wireless/libertas/cmdresp.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/cmdresp.c	2010-04-13 02:18:56.056633026 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/cmdresp.c	2010-04-13 02:19:01.294633095 +0000
@@ -2,6 +2,7 @@
   * This file contains the handling of command
   * responses as well as events generated by firmware.
   */
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/sched.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/debugfs.c linux-2.6.34-rc4/drivers/net/wireless/libertas/debugfs.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/debugfs.c	2010-04-13 02:19:01.294633095 +0000
@@ -4,6 +4,7 @@
 #include <linux/delay.h>
 #include <linux/mm.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 #include <net/lib80211.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/dev.h linux-2.6.34-rc4/drivers/net/wireless/libertas/dev.h
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/dev.h	2010-04-13 02:18:56.056633026 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/dev.h	2010-04-13 02:19:01.294633095 +0000
@@ -36,6 +36,7 @@
 
 	/* CFG80211 */
 	struct wireless_dev *wdev;
+	bool wiphy_registered;
 
 	/* Mesh */
 	struct net_device *mesh_dev; /* Virtual device */
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/if_cs.c linux-2.6.34-rc4/drivers/net/wireless/libertas/if_cs.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/if_cs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/if_cs.c	2010-04-13 02:19:01.294633095 +0000
@@ -22,6 +22,7 @@
 */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/if_sdio.c linux-2.6.34-rc4/drivers/net/wireless/libertas/if_sdio.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/if_sdio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/if_sdio.c	2010-04-13 02:19:01.295633037 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/kernel.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/netdevice.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/if_spi.c linux-2.6.34-rc4/drivers/net/wireless/libertas/if_spi.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/if_spi.c	2010-04-13 02:18:56.056633026 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/if_spi.c	2010-04-13 02:19:01.295633037 +0000
@@ -24,6 +24,7 @@
 #include <linux/list.h>
 #include <linux/netdevice.h>
 #include <linux/semaphore.h>
+#include <linux/slab.h>
 #include <linux/spi/libertas_spi.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/if_usb.c linux-2.6.34-rc4/drivers/net/wireless/libertas/if_usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/if_usb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/if_usb.c	2010-04-13 02:19:01.295633037 +0000
@@ -5,6 +5,7 @@
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #ifdef CONFIG_OLPC
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/main.c linux-2.6.34-rc4/drivers/net/wireless/libertas/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/main.c	2010-04-13 02:18:56.057633071 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/main.c	2010-04-13 02:19:01.295633037 +0000
@@ -13,6 +13,7 @@
 #include <linux/kfifo.h>
 #include <linux/stddef.h>
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 #include <net/cfg80211.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/rx.c linux-2.6.34-rc4/drivers/net/wireless/libertas/rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/rx.c	2010-04-13 02:19:01.296633081 +0000
@@ -2,6 +2,7 @@
   * This file contains the handling of RX in wlan driver.
   */
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 
 #include "host.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/scan.c linux-2.6.34-rc4/drivers/net/wireless/libertas/scan.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/scan.c	2010-04-13 02:18:56.057633071 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/scan.c	2010-04-13 02:19:01.296633081 +0000
@@ -4,6 +4,7 @@
   * IOCTL handlers as well as command preperation and response routines
   *  for sending scan commands to the firmware.
   */
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas/wext.c linux-2.6.34-rc4/drivers/net/wireless/libertas/wext.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas/wext.c	2010-04-13 02:18:56.058633062 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas/wext.c	2010-04-13 02:19:01.297633074 +0000
@@ -2,6 +2,7 @@
   * This file contains ioctl functions
   */
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/if.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/cmd.c linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/cmd.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/cmd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/cmd.c	2010-04-13 02:19:01.297633074 +0000
@@ -7,6 +7,8 @@
  *  the Free Software Foundation; either version 2 of the License, or (at
  *  your option) any later version.
  */
+#include <linux/slab.h>
+
 #include "libertas_tf.h"
 
 static const struct channel_range channel_ranges[] = {
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/if_usb.c linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/if_usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/if_usb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/if_usb.c	2010-04-13 02:19:01.297633074 +0000
@@ -11,6 +11,7 @@
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #define DRV_NAME "lbtf_usb"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/main.c linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/libertas_tf/main.c	2010-04-13 02:18:56.058633062 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/libertas_tf/main.c	2010-04-13 02:19:01.297633074 +0000
@@ -7,6 +7,8 @@
  *  the Free Software Foundation; either version 2 of the License, or (at
  *  your option) any later version.
  */
+#include <linux/slab.h>
+
 #include "libertas_tf.h"
 #include "linux/etherdevice.h"
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/mac80211_hwsim.c linux-2.6.34-rc4/drivers/net/wireless/mac80211_hwsim.c
--- linux-2.6.34-rc3/drivers/net/wireless/mac80211_hwsim.c	2010-04-13 02:18:56.058633062 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/mac80211_hwsim.c	2010-04-13 02:19:01.298633094 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <net/dst.h>
 #include <net/xfrm.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/mwl8k.c linux-2.6.34-rc4/drivers/net/wireless/mwl8k.c
--- linux-2.6.34-rc3/drivers/net/wireless/mwl8k.c	2010-04-13 02:18:56.060570467 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/mwl8k.c	2010-04-13 02:19:01.300633047 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/completion.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
@@ -3851,6 +3852,7 @@
 MODULE_FIRMWARE("mwl8k/fmimage_8366.fw");
 
 static DEFINE_PCI_DEVICE_TABLE(mwl8k_pci_id_table) = {
+	{ PCI_VDEVICE(MARVELL, 0x2a0a), .driver_data = MWL8363, },
 	{ PCI_VDEVICE(MARVELL, 0x2a0c), .driver_data = MWL8363, },
 	{ PCI_VDEVICE(MARVELL, 0x2a24), .driver_data = MWL8363, },
 	{ PCI_VDEVICE(MARVELL, 0x2a2b), .driver_data = MWL8687, },
diff -urN linux-2.6.34-rc3/drivers/net/wireless/orinoco/fw.c linux-2.6.34-rc4/drivers/net/wireless/orinoco/fw.c
--- linux-2.6.34-rc3/drivers/net/wireless/orinoco/fw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/orinoco/fw.c	2010-04-13 02:19:01.300633047 +0000
@@ -3,6 +3,7 @@
  * See copyright notice in main.c
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/orinoco/main.c linux-2.6.34-rc4/drivers/net/wireless/orinoco/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/orinoco/main.c	2010-04-13 02:18:56.061633061 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/orinoco/main.c	2010-04-13 02:19:01.300633047 +0000
@@ -78,6 +78,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/orinoco/scan.c linux-2.6.34-rc4/drivers/net/wireless/orinoco/scan.c
--- linux-2.6.34-rc3/drivers/net/wireless/orinoco/scan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/orinoco/scan.c	2010-04-13 02:19:01.301633022 +0000
@@ -3,6 +3,7 @@
  * See copyright notice in main.c
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/ieee80211.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/orinoco/wext.c linux-2.6.34-rc4/drivers/net/wireless/orinoco/wext.c
--- linux-2.6.34-rc3/drivers/net/wireless/orinoco/wext.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/orinoco/wext.c	2010-04-13 02:19:01.301633022 +0000
@@ -2,6 +2,7 @@
  *
  * See copyright notice in main.c
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/if_arp.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/eeprom.c linux-2.6.34-rc4/drivers/net/wireless/p54/eeprom.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/eeprom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/eeprom.c	2010-04-13 02:19:01.302633042 +0000
@@ -20,6 +20,7 @@
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
 #include <linux/sort.h>
+#include <linux/slab.h>
 
 #include <net/mac80211.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/fwio.c linux-2.6.34-rc4/drivers/net/wireless/p54/fwio.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/fwio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/fwio.c	2010-04-13 02:19:01.302633042 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/main.c linux-2.6.34-rc4/drivers/net/wireless/p54/main.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/main.c	2010-04-13 02:18:56.062633049 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/main.c	2010-04-13 02:19:01.302633042 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/p54pci.c linux-2.6.34-rc4/drivers/net/wireless/p54/p54pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/p54pci.c	2010-04-13 02:18:56.062633049 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/p54pci.c	2010-04-13 02:19:01.302633042 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/p54spi.c linux-2.6.34-rc4/drivers/net/wireless/p54/p54spi.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/p54spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/p54spi.c	2010-04-13 02:19:01.302633042 +0000
@@ -29,6 +29,7 @@
 #include <linux/spi/spi.h>
 #include <linux/etherdevice.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include "p54spi.h"
 #include "p54spi_eeprom.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/p54/p54usb.c linux-2.6.34-rc4/drivers/net/wireless/p54/p54usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/p54/p54usb.c	2010-04-13 02:18:56.062633049 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/p54/p54usb.c	2010-04-13 02:19:01.303633104 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/usb.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <linux/etherdevice.h>
 #include <linux/delay.h>
@@ -35,6 +36,7 @@
 static struct usb_device_id p54u_table[] __devinitdata = {
 	/* Version 1 devices (pci chip + net2280) */
 	{USB_DEVICE(0x0506, 0x0a11)},	/* 3COM 3CRWE254G72 */
+	{USB_DEVICE(0x06b9, 0x0120)},	/* Thomson SpeedTouch 120g */
 	{USB_DEVICE(0x0707, 0xee06)},	/* SMC 2862W-G */
 	{USB_DEVICE(0x07aa, 0x001c)},	/* Corega CG-WLUSB2GT */
 	{USB_DEVICE(0x083a, 0x4501)},	/* Accton 802.11g WN4501 USB */
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/isl_ioctl.c linux-2.6.34-rc4/drivers/net/wireless/prism54/isl_ioctl.c
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/isl_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/isl_ioctl.c	2010-04-13 02:19:01.303633104 +0000
@@ -23,6 +23,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_dev.c linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_dev.c
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_dev.c	2010-04-13 02:19:01.303633104 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/netdevice.h>
 #include <linux/ethtool.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_eth.c linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_eth.c
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_eth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_eth.c	2010-04-13 02:19:01.304633055 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 
 #include <linux/pci.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_mgt.c linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_mgt.c
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_mgt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_mgt.c	2010-04-13 02:19:01.304633055 +0000
@@ -21,6 +21,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_mgt.h linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_mgt.h
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/islpci_mgt.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/islpci_mgt.h	2010-04-13 02:19:01.304633055 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/wireless.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 /*
  *  Function definitions
diff -urN linux-2.6.34-rc3/drivers/net/wireless/prism54/oid_mgt.c linux-2.6.34-rc4/drivers/net/wireless/prism54/oid_mgt.c
--- linux-2.6.34-rc3/drivers/net/wireless/prism54/oid_mgt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/prism54/oid_mgt.c	2010-04-13 02:19:01.304633055 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "prismcompat.h"
 #include "islpci_dev.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/ray_cs.c linux-2.6.34-rc4/drivers/net/wireless/ray_cs.c
--- linux-2.6.34-rc3/drivers/net/wireless/ray_cs.c	2010-04-13 02:18:56.063633069 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/ray_cs.c	2010-04-13 02:19:01.305633027 +0000
@@ -35,7 +35,6 @@
 #include <linux/proc_fs.h>
 #include <linux/ptrace.h>
 #include <linux/seq_file.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rndis_wlan.c linux-2.6.34-rc4/drivers/net/wireless/rndis_wlan.c
--- linux-2.6.34-rc3/drivers/net/wireless/rndis_wlan.c	2010-04-13 02:18:56.064633024 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rndis_wlan.c	2010-04-13 02:19:01.306633071 +0000
@@ -41,6 +41,7 @@
 #include <linux/if_arp.h>
 #include <linux/ctype.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 #include <net/cfg80211.h>
 #include <linux/usb/usbnet.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2400pci.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2400pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2400pci.c	2010-04-13 02:18:56.064633024 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2400pci.c	2010-04-13 02:19:01.306633071 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/eeprom_93cx6.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #include "rt2x00pci.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2500pci.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2500pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2500pci.c	2010-04-13 02:18:56.065633087 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2500pci.c	2010-04-13 02:19:01.307633049 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/eeprom_93cx6.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #include "rt2x00pci.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2500usb.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2500usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2500usb.c	2010-04-13 02:18:56.065633087 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2500usb.c	2010-04-13 02:19:01.307633049 +0000
@@ -29,6 +29,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "rt2x00.h"
@@ -1643,6 +1644,11 @@
 	unsigned int i;
 
 	/*
+	 * Disable powersaving as default.
+	 */
+	rt2x00dev->hw->wiphy->flags &= ~WIPHY_FLAG_PS_ON_BY_DEFAULT;
+
+	/*
 	 * Initialize all hw fields.
 	 */
 	rt2x00dev->hw->flags =
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2800lib.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2800lib.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2800lib.c	2010-04-13 02:18:56.066633096 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2800lib.c	2010-04-13 02:19:01.308633033 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #if defined(CONFIG_RT2X00_LIB_USB) || defined(CONFIG_RT2X00_LIB_USB_MODULE)
@@ -812,9 +813,9 @@
 	rt2800_rfcsr_write(rt2x00dev, 24,
 			      rt2x00dev->calibration[conf_is_ht40(conf)]);
 
-	rt2800_rfcsr_read(rt2x00dev, 23, &rfcsr);
+	rt2800_rfcsr_read(rt2x00dev, 7, &rfcsr);
 	rt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);
-	rt2800_rfcsr_write(rt2x00dev, 23, rfcsr);
+	rt2800_rfcsr_write(rt2x00dev, 7, rfcsr);
 }
 
 static void rt2800_config_channel(struct rt2x00_dev *rt2x00dev,
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00debug.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00debug.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00debug.c	2010-04-13 02:18:56.068633038 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00debug.c	2010-04-13 02:19:01.310633016 +0000
@@ -28,6 +28,7 @@
 #include <linux/module.h>
 #include <linux/poll.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #include "rt2x00.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00dev.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00dev.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00dev.c	2010-04-13 02:18:56.068633038 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00dev.c	2010-04-13 02:19:01.310633016 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #include "rt2x00lib.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00pci.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00pci.c	2010-04-13 02:18:56.068633038 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00pci.c	2010-04-13 02:19:01.310633016 +0000
@@ -27,6 +27,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #include "rt2x00pci.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00queue.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00queue.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00queue.c	2010-04-13 02:18:56.069571707 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00queue.c	2010-04-13 02:19:01.311633108 +0000
@@ -24,6 +24,7 @@
 	Abstract: rt2x00 queue specific routines.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00soc.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00soc.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00soc.c	2010-04-13 02:18:56.069571707 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00soc.c	2010-04-13 02:19:01.311633108 +0000
@@ -28,6 +28,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include "rt2x00.h"
 #include "rt2x00soc.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00usb.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt2x00usb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt2x00usb.c	2010-04-13 02:19:01.311633108 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/bug.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt61pci.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt61pci.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt61pci.c	2010-04-13 02:18:56.069571707 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt61pci.c	2010-04-13 02:19:01.312633020 +0000
@@ -30,6 +30,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/eeprom_93cx6.h>
 
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt73usb.c linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt73usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/rt2x00/rt73usb.c	2010-04-13 02:18:56.070570494 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rt2x00/rt73usb.c	2010-04-13 02:19:01.312633020 +0000
@@ -30,6 +30,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "rt2x00.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rtl818x/rtl8180_dev.c linux-2.6.34-rc4/drivers/net/wireless/rtl818x/rtl8180_dev.c
--- linux-2.6.34-rc3/drivers/net/wireless/rtl818x/rtl8180_dev.c	2010-04-13 02:18:56.071570476 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rtl818x/rtl8180_dev.c	2010-04-13 02:19:01.313633040 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/etherdevice.h>
 #include <linux/eeprom_93cx6.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/rtl818x/rtl8187_dev.c linux-2.6.34-rc4/drivers/net/wireless/rtl818x/rtl8187_dev.c
--- linux-2.6.34-rc3/drivers/net/wireless/rtl818x/rtl8187_dev.c	2010-04-13 02:18:56.071570476 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/rtl818x/rtl8187_dev.c	2010-04-13 02:19:01.313633040 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/init.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/etherdevice.h>
 #include <linux/eeprom_93cx6.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_acx.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_acx.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_acx.c	2010-04-13 02:18:56.072633064 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_acx.c	2010-04-13 02:19:01.314633033 +0000
@@ -1,6 +1,7 @@
 #include "wl1251_acx.h"
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/crc7.h>
 
 #include "wl1251.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_boot.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_boot.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_boot.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_boot.c	2010-04-13 02:19:01.314633033 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include "wl1251_reg.h"
 #include "wl1251_boot.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_cmd.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_cmd.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_cmd.c	2010-04-13 02:18:56.072633064 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_cmd.c	2010-04-13 02:19:01.314633033 +0000
@@ -1,6 +1,7 @@
 #include "wl1251_cmd.h"
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/crc7.h>
 
 #include "wl1251.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_debugfs.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_debugfs.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_debugfs.c	2010-04-13 02:18:56.072633064 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_debugfs.c	2010-04-13 02:19:01.315633098 +0000
@@ -24,6 +24,7 @@
 #include "wl1251_debugfs.h"
 
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include "wl1251.h"
 #include "wl1251_acx.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_init.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_init.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_init.c	2010-04-13 02:18:56.072633064 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_init.c	2010-04-13 02:19:01.315633098 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "wl1251_init.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_main.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_main.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_main.c	2010-04-13 02:18:56.073633091 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_main.c	2010-04-13 02:19:01.315633098 +0000
@@ -29,6 +29,7 @@
 #include <linux/crc32.h>
 #include <linux/etherdevice.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include "wl1251.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_rx.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_rx.c	2010-04-13 02:18:56.073633091 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_rx.c	2010-04-13 02:19:01.316632485 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/skbuff.h>
+#include <linux/gfp.h>
 #include <net/mac80211.h>
 
 #include "wl1251.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_spi.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_spi.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1251_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1251_spi.c	2010-04-13 02:19:01.316632485 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/irq.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/crc7.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/wl12xx.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_acx.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_acx.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_acx.c	2010-04-13 02:18:56.074633063 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_acx.c	2010-04-13 02:19:01.317588859 +0000
@@ -27,6 +27,7 @@
 #include <linux/platform_device.h>
 #include <linux/crc7.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 #include "wl1271.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_boot.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_boot.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_boot.c	2010-04-13 02:18:56.074633063 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_boot.c	2010-04-13 02:19:01.317588859 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include "wl1271_acx.h"
 #include "wl1271_reg.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_cmd.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_cmd.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_cmd.c	2010-04-13 02:18:56.075633033 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_cmd.c	2010-04-13 02:19:01.318633470 +0000
@@ -26,6 +26,7 @@
 #include <linux/crc7.h>
 #include <linux/spi/spi.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 
 #include "wl1271.h"
 #include "wl1271_reg.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_debugfs.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_debugfs.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_debugfs.c	2010-04-13 02:18:56.075633033 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_debugfs.c	2010-04-13 02:19:01.319633460 +0000
@@ -24,6 +24,7 @@
 #include "wl1271_debugfs.h"
 
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include "wl1271.h"
 #include "wl1271_acx.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_init.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_init.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_init.c	2010-04-13 02:18:56.076633054 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_init.c	2010-04-13 02:19:01.319633460 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "wl1271_init.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_main.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_main.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_main.c	2010-04-13 02:18:56.077633084 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_main.c	2010-04-13 02:19:01.320633081 +0000
@@ -33,6 +33,7 @@
 #include <linux/vmalloc.h>
 #include <linux/spi/wl12xx.h>
 #include <linux/inetdevice.h>
+#include <linux/slab.h>
 
 #include "wl1271.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_rx.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_rx.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_rx.c	2010-04-13 02:18:56.077633084 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_rx.c	2010-04-13 02:19:01.321633002 +0000
@@ -21,6 +21,8 @@
  *
  */
 
+#include <linux/gfp.h>
+
 #include "wl1271.h"
 #include "wl1271_acx.h"
 #include "wl1271_reg.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_spi.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_spi.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_spi.c	2010-04-13 02:18:56.078633092 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_spi.c	2010-04-13 02:19:01.321633002 +0000
@@ -25,6 +25,7 @@
 #include <linux/platform_device.h>
 #include <linux/crc7.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 #include "wl1271.h"
 #include "wl12xx_80211.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_testmode.c linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_testmode.c
--- linux-2.6.34-rc3/drivers/net/wireless/wl12xx/wl1271_testmode.c	2010-04-13 02:18:56.078633092 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/wl12xx/wl1271_testmode.c	2010-04-13 02:19:01.321633002 +0000
@@ -22,6 +22,7 @@
  */
 #include "wl1271_testmode.h"
 
+#include <linux/slab.h>
 #include <net/genetlink.h>
 
 #include "wl1271.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/zd1201.c linux-2.6.34-rc4/drivers/net/wireless/zd1201.c
--- linux-2.6.34-rc3/drivers/net/wireless/zd1201.c	2010-04-13 02:18:56.079571566 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/zd1201.c	2010-04-13 02:19:01.322633238 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/module.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_chip.c linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_chip.c
--- linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_chip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_chip.c	2010-04-13 02:19:01.322633238 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include "zd_def.h"
 #include "zd_chip.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_mac.c linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_mac.c
--- linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_mac.c	2010-04-13 02:18:56.079571566 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_mac.c	2010-04-13 02:19:01.322633238 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/jiffies.h>
 #include <net/ieee80211_radiotap.h>
diff -urN linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_rf_uw2453.c linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_rf_uw2453.c
--- linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_rf_uw2453.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_rf_uw2453.c	2010-04-13 02:19:01.322633238 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "zd_rf.h"
 #include "zd_usb.h"
diff -urN linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_usb.c linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_usb.c
--- linux-2.6.34-rc3/drivers/net/wireless/zd1211rw/zd_usb.c	2010-04-13 02:18:56.079571566 +0000
+++ linux-2.6.34-rc4/drivers/net/wireless/zd1211rw/zd_usb.c	2010-04-13 02:19:01.323633078 +0000
@@ -24,6 +24,7 @@
 #include <linux/firmware.h>
 #include <linux/device.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/usb.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/net/xen-netfront.c linux-2.6.34-rc4/drivers/net/xen-netfront.c
--- linux-2.6.34-rc3/drivers/net/xen-netfront.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/xen-netfront.c	2010-04-13 02:19:01.323633078 +0000
@@ -40,6 +40,7 @@
 #include <linux/udp.h>
 #include <linux/moduleparam.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 
 #include <xen/xen.h>
diff -urN linux-2.6.34-rc3/drivers/net/xilinx_emaclite.c linux-2.6.34-rc4/drivers/net/xilinx_emaclite.c
--- linux-2.6.34-rc3/drivers/net/xilinx_emaclite.c	2010-04-13 02:18:56.079571566 +0000
+++ linux-2.6.34-rc4/drivers/net/xilinx_emaclite.c	2010-04-13 02:19:01.323633078 +0000
@@ -19,6 +19,7 @@
 #include <linux/etherdevice.h>
 #include <linux/skbuff.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/of_device.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/net/xtsonic.c linux-2.6.34-rc4/drivers/net/xtsonic.c
--- linux-2.6.34-rc3/drivers/net/xtsonic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/net/xtsonic.c	2010-04-13 02:19:01.324633056 +0000
@@ -20,11 +20,11 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/fcntl.h>
+#include <linux/gfp.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/delay.h>
 #include <linux/errno.h>
@@ -33,6 +33,7 @@
 #include <linux/skbuff.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/drivers/net/yellowfin.c linux-2.6.34-rc4/drivers/net/yellowfin.c
--- linux-2.6.34-rc3/drivers/net/yellowfin.c	2010-04-13 02:18:56.080570468 +0000
+++ linux-2.6.34-rc4/drivers/net/yellowfin.c	2010-04-13 02:19:01.324633056 +0000
@@ -90,7 +90,6 @@
 #include <linux/timer.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/net/znet.c linux-2.6.34-rc4/drivers/net/znet.c
--- linux-2.6.34-rc3/drivers/net/znet.c	2010-04-13 02:18:56.080570468 +0000
+++ linux-2.6.34-rc4/drivers/net/znet.c	2010-04-13 02:19:01.324633056 +0000
@@ -88,6 +88,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/nubus/nubus.c linux-2.6.34-rc4/drivers/nubus/nubus.c
--- linux-2.6.34-rc3/drivers/nubus/nubus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/nubus/nubus.c	2010-04-13 02:19:01.324633056 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/setup.h>
 #include <asm/system.h>
 #include <asm/page.h>
diff -urN linux-2.6.34-rc3/drivers/of/base.c linux-2.6.34-rc4/drivers/of/base.c
--- linux-2.6.34-rc3/drivers/of/base.c	2010-04-13 02:18:56.081570486 +0000
+++ linux-2.6.34-rc4/drivers/of/base.c	2010-04-13 02:19:01.325633023 +0000
@@ -20,6 +20,7 @@
 #include <linux/module.h>
 #include <linux/of.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 
 struct device_node *allnodes;
diff -urN linux-2.6.34-rc3/drivers/of/fdt.c linux-2.6.34-rc4/drivers/of/fdt.c
--- linux-2.6.34-rc3/drivers/of/fdt.c	2010-04-13 02:18:56.081570486 +0000
+++ linux-2.6.34-rc4/drivers/of/fdt.c	2010-04-13 02:19:01.325633023 +0000
@@ -376,8 +376,11 @@
 		if (!np->type)
 			np->type = "<NULL>";
 	}
-	while (tag == OF_DT_BEGIN_NODE) {
-		mem = unflatten_dt_node(mem, p, np, allnextpp, fpsize);
+	while (tag == OF_DT_BEGIN_NODE || tag == OF_DT_NOP) {
+		if (tag == OF_DT_NOP)
+			*p += 4;
+		else
+			mem = unflatten_dt_node(mem, p, np, allnextpp, fpsize);
 		tag = be32_to_cpup((__be32 *)(*p));
 	}
 	if (tag != OF_DT_END_NODE) {
diff -urN linux-2.6.34-rc3/drivers/of/gpio.c linux-2.6.34-rc4/drivers/of/gpio.c
--- linux-2.6.34-rc3/drivers/of/gpio.c	2010-04-13 02:18:56.081570486 +0000
+++ linux-2.6.34-rc4/drivers/of/gpio.c	2010-04-13 02:19:01.325633023 +0000
@@ -15,6 +15,7 @@
 #include <linux/errno.h>
 #include <linux/io.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 #include <linux/of_gpio.h>
 #include <asm/prom.h>
 
diff -urN linux-2.6.34-rc3/drivers/oprofile/buffer_sync.c linux-2.6.34-rc4/drivers/oprofile/buffer_sync.c
--- linux-2.6.34-rc3/drivers/oprofile/buffer_sync.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/oprofile/buffer_sync.c	2010-04-13 02:19:01.326633064 +0000
@@ -30,6 +30,7 @@
 #include <linux/fs.h>
 #include <linux/oprofile.h>
 #include <linux/sched.h>
+#include <linux/gfp.h>
 
 #include "oprofile_stats.h"
 #include "event_buffer.h"
diff -urN linux-2.6.34-rc3/drivers/parisc/asp.c linux-2.6.34-rc4/drivers/parisc/asp.c
--- linux-2.6.34-rc3/drivers/parisc/asp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parisc/asp.c	2010-04-13 02:19:01.326633064 +0000
@@ -15,7 +15,6 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 #include <asm/io.h>
 #include <asm/led.h>
diff -urN linux-2.6.34-rc3/drivers/parisc/ccio-rm-dma.c linux-2.6.34-rc4/drivers/parisc/ccio-rm-dma.c
--- linux-2.6.34-rc3/drivers/parisc/ccio-rm-dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parisc/ccio-rm-dma.c	2010-04-13 02:19:01.326633064 +0000
@@ -38,6 +38,7 @@
 #include <linux/mm.h>
 #include <linux/string.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/parisc/gsc.c linux-2.6.34-rc4/drivers/parisc/gsc.c
--- linux-2.6.34-rc3/drivers/parisc/gsc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parisc/gsc.c	2010-04-13 02:19:01.326633064 +0000
@@ -19,7 +19,6 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 
 #include <asm/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/parport/daisy.c linux-2.6.34-rc4/drivers/parport/daisy.c
--- linux-2.6.34-rc3/drivers/parport/daisy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parport/daisy.c	2010-04-13 02:19:01.328633065 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/parport.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include <asm/current.h>
diff -urN linux-2.6.34-rc3/drivers/parport/parport_ax88796.c linux-2.6.34-rc4/drivers/parport/parport_ax88796.c
--- linux-2.6.34-rc3/drivers/parport/parport_ax88796.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parport/parport_ax88796.c	2010-04-13 02:19:01.328633065 +0000
@@ -15,6 +15,7 @@
 #include <linux/interrupt.h>
 #include <linux/errno.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/parport/parport_ip32.c linux-2.6.34-rc4/drivers/parport/parport_ip32.c
--- linux-2.6.34-rc3/drivers/parport/parport_ip32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parport/parport_ip32.c	2010-04-13 02:19:01.328633065 +0000
@@ -103,6 +103,7 @@
 #include <linux/module.h>
 #include <linux/parport.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/stddef.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/drivers/parport/parport_serial.c linux-2.6.34-rc4/drivers/parport/parport_serial.c
--- linux-2.6.34-rc3/drivers/parport/parport_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parport/parport_serial.c	2010-04-13 02:19:01.329633049 +0000
@@ -20,6 +20,7 @@
 #include <linux/types.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/parport.h>
diff -urN linux-2.6.34-rc3/drivers/parport/probe.c linux-2.6.34-rc4/drivers/parport/probe.c
--- linux-2.6.34-rc3/drivers/parport/probe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/parport/probe.c	2010-04-13 02:19:01.329633049 +0000
@@ -9,6 +9,7 @@
 #include <linux/parport.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 static const struct {
diff -urN linux-2.6.34-rc3/drivers/pci/access.c linux-2.6.34-rc4/drivers/pci/access.c
--- linux-2.6.34-rc3/drivers/pci/access.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/access.c	2010-04-13 02:19:01.329633049 +0000
@@ -2,6 +2,7 @@
 #include <linux/pci.h>
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/wait.h>
 
diff -urN linux-2.6.34-rc3/drivers/pci/bus.c linux-2.6.34-rc4/drivers/pci/bus.c
--- linux-2.6.34-rc3/drivers/pci/bus.c	2010-04-13 02:18:56.084633085 +0000
+++ linux-2.6.34-rc4/drivers/pci/bus.c	2010-04-13 02:19:01.329633049 +0000
@@ -14,6 +14,7 @@
 #include <linux/ioport.h>
 #include <linux/proc_fs.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include "pci.h"
 
diff -urN linux-2.6.34-rc3/drivers/pci/dmar.c linux-2.6.34-rc4/drivers/pci/dmar.c
--- linux-2.6.34-rc3/drivers/pci/dmar.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/dmar.c	2010-04-13 02:19:01.330633093 +0000
@@ -35,6 +35,7 @@
 #include <linux/interrupt.h>
 #include <linux/tboot.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 
 #define PREFIX "DMAR: "
 
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/acpi_pcihp.c linux-2.6.34-rc4/drivers/pci/hotplug/acpi_pcihp.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/acpi_pcihp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/acpi_pcihp.c	2010-04-13 02:19:01.330633093 +0000
@@ -32,6 +32,7 @@
 #include <linux/pci_hotplug.h>
 #include <linux/acpi.h>
 #include <linux/pci-acpi.h>
+#include <linux/slab.h>
 
 #define MY_NAME	"acpi_pcihp"
 
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/acpiphp_glue.c linux-2.6.34-rc4/drivers/pci/hotplug/acpiphp_glue.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/acpiphp_glue.c	2010-04-13 02:18:56.084633085 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/acpiphp_glue.c	2010-04-13 02:19:01.330633093 +0000
@@ -47,6 +47,7 @@
 #include <linux/pci_hotplug.h>
 #include <linux/pci-acpi.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include "../pci.h"
 #include "acpiphp.h"
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/acpiphp_ibm.c linux-2.6.34-rc4/drivers/pci/hotplug/acpiphp_ibm.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/acpiphp_ibm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/acpiphp_ibm.c	2010-04-13 02:19:01.330633093 +0000
@@ -26,6 +26,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <acpi/acpi_bus.h>
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/cpqphp_sysfs.c linux-2.6.34-rc4/drivers/pci/hotplug/cpqphp_sysfs.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/cpqphp_sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/cpqphp_sysfs.c	2010-04-13 02:19:01.331633047 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/proc_fs.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/fakephp.c linux-2.6.34-rc4/drivers/pci/hotplug/fakephp.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/fakephp.c	2010-04-13 02:18:56.085633094 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/fakephp.c	2010-04-13 02:19:01.331633047 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include "../pci.h"
 
 struct legacy_slot {
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/pci_hotplug_core.c linux-2.6.34-rc4/drivers/pci/hotplug/pci_hotplug_core.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/pci_hotplug_core.c	2010-04-13 02:18:56.086633087 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/pci_hotplug_core.c	2010-04-13 02:19:01.333633078 +0000
@@ -33,7 +33,6 @@
 #include <linux/kobject.h>
 #include <linux/sysfs.h>
 #include <linux/pagemap.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_acpi.c linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_acpi.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_acpi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_acpi.c	2010-04-13 02:19:01.333633078 +0000
@@ -26,6 +26,7 @@
 #include <linux/acpi.h>
 #include <linux/pci.h>
 #include <linux/pci_hotplug.h>
+#include <linux/slab.h>
 #include "pciehp.h"
 
 #define PCIEHP_DETECT_PCIE	(0)
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_core.c linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_core.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_core.c	2010-04-13 02:18:56.086633087 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_core.c	2010-04-13 02:19:01.333633078 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/pci.h>
 #include "pciehp.h"
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_ctrl.c linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_ctrl.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_ctrl.c	2010-04-13 02:18:56.086633087 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_ctrl.c	2010-04-13 02:19:01.333633078 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/workqueue.h>
 #include "../pci.h"
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_hpc.c linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_hpc.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/pciehp_hpc.c	2010-04-13 02:18:56.087633081 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/pciehp_hpc.c	2010-04-13 02:19:01.333633078 +0000
@@ -36,6 +36,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/time.h>
+#include <linux/slab.h>
 
 #include "../pci.h"
 #include "pciehp.h"
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/rpaphp_core.c linux-2.6.34-rc4/drivers/pci/hotplug/rpaphp_core.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/rpaphp_core.c	2010-04-13 02:18:56.087633081 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/rpaphp_core.c	2010-04-13 02:19:01.334633068 +0000
@@ -27,7 +27,6 @@
 #include <linux/moduleparam.h>
 #include <linux/pci.h>
 #include <linux/pci_hotplug.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/init.h>
 #include <asm/eeh.h>       /* for eeh_add_device() */
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/sgi_hotplug.c linux-2.6.34-rc4/drivers/pci/hotplug/sgi_hotplug.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/sgi_hotplug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/sgi_hotplug.c	2010-04-13 02:19:01.334633068 +0000
@@ -15,6 +15,7 @@
 #include <linux/pci.h>
 #include <linux/pci_hotplug.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/shpchp_core.c linux-2.6.34-rc4/drivers/pci/hotplug/shpchp_core.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/shpchp_core.c	2010-04-13 02:18:56.087633081 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/shpchp_core.c	2010-04-13 02:19:01.334633068 +0000
@@ -31,6 +31,7 @@
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/workqueue.h>
 #include "shpchp.h"
diff -urN linux-2.6.34-rc3/drivers/pci/hotplug/shpchp_ctrl.c linux-2.6.34-rc4/drivers/pci/hotplug/shpchp_ctrl.c
--- linux-2.6.34-rc3/drivers/pci/hotplug/shpchp_ctrl.c	2010-04-13 02:18:56.087633081 +0000
+++ linux-2.6.34-rc4/drivers/pci/hotplug/shpchp_ctrl.c	2010-04-13 02:19:01.334633068 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/workqueue.h>
 #include "../pci.h"
diff -urN linux-2.6.34-rc3/drivers/pci/htirq.c linux-2.6.34-rc4/drivers/pci/htirq.c
--- linux-2.6.34-rc3/drivers/pci/htirq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/htirq.c	2010-04-13 02:19:01.335633046 +0000
@@ -10,7 +10,6 @@
 #include <linux/pci.h>
 #include <linux/spinlock.h>
 #include <linux/slab.h>
-#include <linux/gfp.h>
 #include <linux/htirq.h>
 
 /* Global ht irq lock.
diff -urN linux-2.6.34-rc3/drivers/pci/intr_remapping.c linux-2.6.34-rc4/drivers/pci/intr_remapping.c
--- linux-2.6.34-rc3/drivers/pci/intr_remapping.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/intr_remapping.c	2010-04-13 02:19:01.335633046 +0000
@@ -1,6 +1,7 @@
 #include <linux/interrupt.h>
 #include <linux/dmar.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/jiffies.h>
 #include <linux/hpet.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/pci/ioapic.c linux-2.6.34-rc4/drivers/pci/ioapic.c
--- linux-2.6.34-rc3/drivers/pci/ioapic.c	2010-04-13 02:18:56.088633060 +0000
+++ linux-2.6.34-rc4/drivers/pci/ioapic.c	2010-04-13 02:19:01.335633046 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/pci.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 
 struct ioapic {
diff -urN linux-2.6.34-rc3/drivers/pci/iov.c linux-2.6.34-rc4/drivers/pci/iov.c
--- linux-2.6.34-rc3/drivers/pci/iov.c	2010-04-13 02:18:56.088633060 +0000
+++ linux-2.6.34-rc4/drivers/pci/iov.c	2010-04-13 02:19:01.335633046 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/string.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/pci/msi.c linux-2.6.34-rc4/drivers/pci/msi.c
--- linux-2.6.34-rc3/drivers/pci/msi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/msi.c	2010-04-13 02:19:01.336633144 +0000
@@ -18,6 +18,7 @@
 #include <linux/smp.h>
 #include <linux/errno.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include "pci.h"
 #include "msi.h"
diff -urN linux-2.6.34-rc3/drivers/pci/pci-sysfs.c linux-2.6.34-rc4/drivers/pci/pci-sysfs.c
--- linux-2.6.34-rc3/drivers/pci/pci-sysfs.c	2010-04-13 02:18:56.089571599 +0000
+++ linux-2.6.34-rc4/drivers/pci/pci-sysfs.c	2010-04-13 02:19:01.336633144 +0000
@@ -23,6 +23,7 @@
 #include <linux/mm.h>
 #include <linux/capability.h>
 #include <linux/pci-aspm.h>
+#include <linux/slab.h>
 #include "pci.h"
 
 static int sysfs_initialized;	/* = 0 */
diff -urN linux-2.6.34-rc3/drivers/pci/pci.c linux-2.6.34-rc4/drivers/pci/pci.c
--- linux-2.6.34-rc3/drivers/pci/pci.c	2010-04-13 02:18:56.090570477 +0000
+++ linux-2.6.34-rc4/drivers/pci/pci.c	2010-04-13 02:19:01.337633038 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/pm.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/pci/pcie/aer/aer_inject.c linux-2.6.34-rc4/drivers/pci/pcie/aer/aer_inject.c
--- linux-2.6.34-rc3/drivers/pci/pcie/aer/aer_inject.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/pcie/aer/aer_inject.c	2010-04-13 02:19:01.337633038 +0000
@@ -21,6 +21,7 @@
 #include <linux/init.h>
 #include <linux/miscdevice.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/uaccess.h>
 #include <linux/stddef.h>
diff -urN linux-2.6.34-rc3/drivers/pci/pcie/aer/aerdrv.c linux-2.6.34-rc4/drivers/pci/pcie/aer/aerdrv.c
--- linux-2.6.34-rc3/drivers/pci/pcie/aer/aerdrv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/pcie/aer/aerdrv.c	2010-04-13 02:19:01.337633038 +0000
@@ -25,6 +25,7 @@
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/pcieport_if.h>
+#include <linux/slab.h>
 
 #include "aerdrv.h"
 #include "../../pci.h"
diff -urN linux-2.6.34-rc3/drivers/pci/pcie/aer/aerdrv_core.c linux-2.6.34-rc4/drivers/pci/pcie/aer/aerdrv_core.c
--- linux-2.6.34-rc3/drivers/pci/pcie/aer/aerdrv_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/pcie/aer/aerdrv_core.c	2010-04-13 02:19:01.338633040 +0000
@@ -23,6 +23,7 @@
 #include <linux/pm.h>
 #include <linux/suspend.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "aerdrv.h"
 
 static int forceload;
diff -urN linux-2.6.34-rc3/drivers/pci/pcie/pme/pcie_pme.c linux-2.6.34-rc4/drivers/pci/pcie/pme/pcie_pme.c
--- linux-2.6.34-rc3/drivers/pci/pcie/pme/pcie_pme.c	2010-04-13 02:18:56.090570477 +0000
+++ linux-2.6.34-rc4/drivers/pci/pcie/pme/pcie_pme.c	2010-04-13 02:19:01.338633040 +0000
@@ -14,6 +14,7 @@
 #include <linux/pci.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/pci/pcie/portdrv_pci.c linux-2.6.34-rc4/drivers/pci/pcie/portdrv_pci.c
--- linux-2.6.34-rc3/drivers/pci/pcie/portdrv_pci.c	2010-04-13 02:18:56.091570546 +0000
+++ linux-2.6.34-rc4/drivers/pci/pcie/portdrv_pci.c	2010-04-13 02:19:01.338633040 +0000
@@ -12,7 +12,6 @@
 #include <linux/errno.h>
 #include <linux/pm.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/pcieport_if.h>
 #include <linux/aer.h>
 #include <linux/dmi.h>
diff -urN linux-2.6.34-rc3/drivers/pci/proc.c linux-2.6.34-rc4/drivers/pci/proc.c
--- linux-2.6.34-rc3/drivers/pci/proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/proc.c	2010-04-13 02:19:01.339633063 +0000
@@ -6,6 +6,7 @@
 
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/pci/quirks.c linux-2.6.34-rc4/drivers/pci/quirks.c
--- linux-2.6.34-rc3/drivers/pci/quirks.c	2010-04-13 02:18:56.091570546 +0000
+++ linux-2.6.34-rc4/drivers/pci/quirks.c	2010-04-13 02:19:01.340633038 +0000
@@ -2123,6 +2123,9 @@
 	}
 }
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_AMD, PCI_DEVICE_ID_AMD_8131_BRIDGE, quirk_disable_msi);
+DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_AMD, 0x9602, quirk_disable_msi);
+DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_ASUSTEK, 0x9602, quirk_disable_msi);
+DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_AI, 0x9602, quirk_disable_msi);
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_VIA, 0xa238, quirk_disable_msi);
 
 /* Go through the list of Hypertransport capabilities and
@@ -2495,39 +2498,6 @@
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_ATI, 0x4375,
 			quirk_msi_intx_disable_bug);
 
-/*
- * MSI does not work with the AMD RS780/RS880 internal graphics and HDMI audio
- * devices unless the BIOS has initialized the nb_cntl.strap_msi_enable bit.
- */
-static void __init rs780_int_gfx_disable_msi(struct pci_dev *int_gfx_bridge)
-{
-	u32 nb_cntl;
-
-	if (!int_gfx_bridge->subordinate)
-		return;
-
-	pci_bus_write_config_dword(int_gfx_bridge->bus, PCI_DEVFN(0, 0),
-				   0x60, 0);
-	pci_bus_read_config_dword(int_gfx_bridge->bus, PCI_DEVFN(0, 0),
-				  0x64, &nb_cntl);
-
-	if (!(nb_cntl & BIT(10))) {
-		dev_warn(&int_gfx_bridge->dev,
-			 FW_WARN "RS780: MSI for internal graphics disabled\n");
-		int_gfx_bridge->subordinate->bus_flags |= PCI_BUS_FLAGS_NO_MSI;
-	}
-}
-
-#define PCI_DEVICE_ID_AMD_RS780_P2P_INT_GFX	0x9602
-
-DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_AMD,
-			PCI_DEVICE_ID_AMD_RS780_P2P_INT_GFX,
-			rs780_int_gfx_disable_msi);
-/* wrong vendor ID on M4A785TD motherboard: */
-DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_ASUSTEK,
-			PCI_DEVICE_ID_AMD_RS780_P2P_INT_GFX,
-			rs780_int_gfx_disable_msi);
-
 #endif /* CONFIG_PCI_MSI */
 
 #ifdef CONFIG_PCI_IOV
diff -urN linux-2.6.34-rc3/drivers/pci/search.c linux-2.6.34-rc4/drivers/pci/search.c
--- linux-2.6.34-rc3/drivers/pci/search.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pci/search.c	2010-04-13 02:19:01.340633038 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
 #include "pci.h"
diff -urN linux-2.6.34-rc3/drivers/pci/slot.c linux-2.6.34-rc4/drivers/pci/slot.c
--- linux-2.6.34-rc3/drivers/pci/slot.c	2010-04-13 02:18:56.092633110 +0000
+++ linux-2.6.34-rc4/drivers/pci/slot.c	2010-04-13 02:19:01.340633038 +0000
@@ -6,6 +6,7 @@
  */
 
 #include <linux/kobject.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/err.h>
 #include "pci.h"
diff -urN linux-2.6.34-rc3/drivers/pcmcia/at91_cf.c linux-2.6.34-rc4/drivers/pcmcia/at91_cf.c
--- linux-2.6.34-rc3/drivers/pcmcia/at91_cf.c	2010-04-13 02:18:56.093633077 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/at91_cf.c	2010-04-13 02:19:01.341633082 +0000
@@ -15,6 +15,7 @@
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include <pcmcia/ss.h>
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/au1000_generic.c linux-2.6.34-rc4/drivers/pcmcia/au1000_generic.c
--- linux-2.6.34-rc3/drivers/pcmcia/au1000_generic.c	2010-04-13 02:18:56.093633077 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/au1000_generic.c	2010-04-13 02:19:01.341633082 +0000
@@ -43,6 +43,7 @@
 #include <linux/spinlock.h>
 #include <linux/mutex.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/bcm63xx_pcmcia.c linux-2.6.34-rc4/drivers/pcmcia/bcm63xx_pcmcia.c
--- linux-2.6.34-rc3/drivers/pcmcia/bcm63xx_pcmcia.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/bcm63xx_pcmcia.c	2010-04-13 02:19:01.342633063 +0000
@@ -11,6 +11,7 @@
 #include <linux/ioport.h>
 #include <linux/timer.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
 #include <linux/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/bfin_cf_pcmcia.c linux-2.6.34-rc4/drivers/pcmcia/bfin_cf_pcmcia.c
--- linux-2.6.34-rc3/drivers/pcmcia/bfin_cf_pcmcia.c	2010-04-13 02:18:56.094633064 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/bfin_cf_pcmcia.c	2010-04-13 02:19:01.342633063 +0000
@@ -31,6 +31,7 @@
 #include <linux/platform_device.h>
 #include <linux/errno.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/db1xxx_ss.c linux-2.6.34-rc4/drivers/pcmcia/db1xxx_ss.c
--- linux-2.6.34-rc3/drivers/pcmcia/db1xxx_ss.c	2010-04-13 02:18:56.096633079 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/db1xxx_ss.c	2010-04-13 02:19:01.345633076 +0000
@@ -26,6 +26,7 @@
 #include <linux/pm.h>
 #include <linux/platform_device.h>
 #include <linux/resource.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <pcmcia/cs_types.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/ds.c linux-2.6.34-rc4/drivers/pcmcia/ds.c
--- linux-2.6.34-rc3/drivers/pcmcia/ds.c	2010-04-13 02:18:56.097633075 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/ds.c	2010-04-13 02:19:01.345633076 +0000
@@ -24,6 +24,7 @@
 #include <linux/firmware.h>
 #include <linux/kref.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/cs.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/electra_cf.c linux-2.6.34-rc4/drivers/pcmcia/electra_cf.c
--- linux-2.6.34-rc3/drivers/pcmcia/electra_cf.c	2010-04-13 02:18:56.097633075 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/electra_cf.c	2010-04-13 02:19:01.345633076 +0000
@@ -31,6 +31,7 @@
 #include <linux/mm.h>
 #include <linux/vmalloc.h>
 #include <linux/of_platform.h>
+#include <linux/slab.h>
 
 #include <pcmcia/ss.h>
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/i82365.c linux-2.6.34-rc4/drivers/pcmcia/i82365.c
--- linux-2.6.34-rc3/drivers/pcmcia/i82365.c	2010-04-13 02:18:56.097633075 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/i82365.c	2010-04-13 02:19:01.346633044 +0000
@@ -40,7 +40,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/timer.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/m32r_cfc.c linux-2.6.34-rc4/drivers/pcmcia/m32r_cfc.c
--- linux-2.6.34-rc3/drivers/pcmcia/m32r_cfc.c	2010-04-13 02:18:56.097633075 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/m32r_cfc.c	2010-04-13 02:19:01.346633044 +0000
@@ -16,7 +16,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/timer.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/m32r_pcc.c linux-2.6.34-rc4/drivers/pcmcia/m32r_pcc.c
--- linux-2.6.34-rc3/drivers/pcmcia/m32r_pcc.c	2010-04-13 02:18:56.098574045 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/m32r_pcc.c	2010-04-13 02:19:01.346633044 +0000
@@ -16,7 +16,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/timer.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/m8xx_pcmcia.c linux-2.6.34-rc4/drivers/pcmcia/m8xx_pcmcia.c
--- linux-2.6.34-rc3/drivers/pcmcia/m8xx_pcmcia.c	2010-04-13 02:18:56.098574045 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/m8xx_pcmcia.c	2010-04-13 02:19:01.346633044 +0000
@@ -42,7 +42,6 @@
 
 #include <linux/kernel.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/omap_cf.c linux-2.6.34-rc4/drivers/pcmcia/omap_cf.c
--- linux-2.6.34-rc3/drivers/pcmcia/omap_cf.c	2010-04-13 02:18:56.098574045 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/omap_cf.c	2010-04-13 02:19:01.347633049 +0000
@@ -16,6 +16,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include <pcmcia/ss.h>
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/pcmcia_ioctl.c linux-2.6.34-rc4/drivers/pcmcia/pcmcia_ioctl.c
--- linux-2.6.34-rc3/drivers/pcmcia/pcmcia_ioctl.c	2010-04-13 02:18:56.098574045 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/pcmcia_ioctl.c	2010-04-13 02:19:01.347633049 +0000
@@ -27,6 +27,7 @@
 #include <linux/proc_fs.h>
 #include <linux/poll.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/smp_lock.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/pcmcia_resource.c linux-2.6.34-rc4/drivers/pcmcia/pcmcia_resource.c
--- linux-2.6.34-rc3/drivers/pcmcia/pcmcia_resource.c	2010-04-13 02:18:56.099570517 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/pcmcia_resource.c	2010-04-13 02:19:01.347633049 +0000
@@ -21,6 +21,7 @@
 #include <linux/pci.h>
 #include <linux/device.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/ss.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/pd6729.c linux-2.6.34-rc4/drivers/pcmcia/pd6729.c
--- linux-2.6.34-rc3/drivers/pcmcia/pd6729.c	2010-04-13 02:18:56.099570517 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/pd6729.c	2010-04-13 02:19:01.348633044 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/pxa2xx_base.c linux-2.6.34-rc4/drivers/pcmcia/pxa2xx_base.c
--- linux-2.6.34-rc3/drivers/pcmcia/pxa2xx_base.c	2010-04-13 02:18:56.099570517 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/pxa2xx_base.c	2010-04-13 02:19:01.348633044 +0000
@@ -17,6 +17,7 @@
   ======================================================================*/
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/cpufreq.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/rsrc_mgr.c linux-2.6.34-rc4/drivers/pcmcia/rsrc_mgr.c
--- linux-2.6.34-rc3/drivers/pcmcia/rsrc_mgr.c	2010-04-13 02:18:56.099570517 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/rsrc_mgr.c	2010-04-13 02:19:01.348633044 +0000
@@ -12,6 +12,7 @@
  * (C) 1999		David A. Hinds
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/rsrc_nonstatic.c linux-2.6.34-rc4/drivers/pcmcia/rsrc_nonstatic.c
--- linux-2.6.34-rc3/drivers/pcmcia/rsrc_nonstatic.c	2010-04-13 02:18:56.100570496 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/rsrc_nonstatic.c	2010-04-13 02:19:01.348633044 +0000
@@ -596,19 +596,17 @@
 	struct resource_map	*map;
 };
 
-static resource_size_t
-pcmcia_common_align(void *align_data, const struct resource *res,
-			resource_size_t size, resource_size_t align)
+static resource_size_t pcmcia_common_align(struct pcmcia_align_data *align_data,
+					resource_size_t start)
 {
-	struct pcmcia_align_data *data = align_data;
-	resource_size_t start;
+	resource_size_t ret;
 	/*
 	 * Ensure that we have the correct start address
 	 */
-	start = (res->start & ~data->mask) + data->offset;
-	if (start < res->start)
-		start += data->mask + 1;
-	return start;
+	ret = (start & ~align_data->mask) + align_data->offset;
+	if (ret < start)
+		ret += align_data->mask + 1;
+	return ret;
 }
 
 static resource_size_t
@@ -619,29 +617,28 @@
 	struct resource_map *m;
 	resource_size_t start;
 
-	start = pcmcia_common_align(data, res, size, align);
+	start = pcmcia_common_align(data, res->start);
 
 	for (m = data->map->next; m != data->map; m = m->next) {
-		unsigned long start = m->base;
-		unsigned long end = m->base + m->num - 1;
+		unsigned long map_start = m->base;
+		unsigned long map_end = m->base + m->num - 1;
 
 		/*
 		 * If the lower resources are not available, try aligning
 		 * to this entry of the resource database to see if it'll
 		 * fit here.
 		 */
-		if (res->start < start) {
-			start = pcmcia_common_align(data, res, size, align);
-		}
+		if (start < map_start)
+			start = pcmcia_common_align(data, map_start);
 
 		/*
 		 * If we're above the area which was passed in, there's
 		 * no point proceeding.
 		 */
-		if (res->start >= res->end)
+		if (start >= res->end)
 			break;
 
-		if ((res->start + size - 1) <= end)
+		if ((start + size - 1) <= map_end)
 			break;
 	}
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/sa1100_generic.c linux-2.6.34-rc4/drivers/pcmcia/sa1100_generic.c
--- linux-2.6.34-rc3/drivers/pcmcia/sa1100_generic.c	2010-04-13 02:18:56.100570496 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/sa1100_generic.c	2010-04-13 02:19:01.349633789 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 
 #include <pcmcia/cs_types.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/sa1111_generic.c linux-2.6.34-rc4/drivers/pcmcia/sa1111_generic.c
--- linux-2.6.34-rc3/drivers/pcmcia/sa1111_generic.c	2010-04-13 02:18:56.100570496 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/sa1111_generic.c	2010-04-13 02:19:01.349633789 +0000
@@ -12,6 +12,7 @@
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <pcmcia/ss.h>
 
diff -urN linux-2.6.34-rc3/drivers/pcmcia/sa11xx_base.c linux-2.6.34-rc4/drivers/pcmcia/sa11xx_base.c
--- linux-2.6.34-rc3/drivers/pcmcia/sa11xx_base.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/sa11xx_base.c	2010-04-13 02:19:01.349633789 +0000
@@ -37,6 +37,7 @@
 #include <linux/kernel.h>
 #include <linux/spinlock.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/socket_sysfs.c linux-2.6.34-rc4/drivers/pcmcia/socket_sysfs.c
--- linux-2.6.34-rc3/drivers/pcmcia/socket_sysfs.c	2010-04-13 02:18:56.100570496 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/socket_sysfs.c	2010-04-13 02:19:01.349633789 +0000
@@ -15,7 +15,6 @@
 #include <linux/string.h>
 #include <linux/major.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/interrupt.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/tcic.c linux-2.6.34-rc4/drivers/pcmcia/tcic.c
--- linux-2.6.34-rc3/drivers/pcmcia/tcic.c	2010-04-13 02:18:56.100570496 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/tcic.c	2010-04-13 02:19:01.349633789 +0000
@@ -39,7 +39,6 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/xxs1500_ss.c linux-2.6.34-rc4/drivers/pcmcia/xxs1500_ss.c
--- linux-2.6.34-rc3/drivers/pcmcia/xxs1500_ss.c	2010-04-13 02:18:56.101570543 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/xxs1500_ss.c	2010-04-13 02:19:01.350571569 +0000
@@ -14,6 +14,7 @@
 #include <linux/platform_device.h>
 #include <linux/pm.h>
 #include <linux/resource.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <pcmcia/cs_types.h>
diff -urN linux-2.6.34-rc3/drivers/pcmcia/yenta_socket.c linux-2.6.34-rc4/drivers/pcmcia/yenta_socket.c
--- linux-2.6.34-rc3/drivers/pcmcia/yenta_socket.c	2010-04-13 02:18:56.101570543 +0000
+++ linux-2.6.34-rc4/drivers/pcmcia/yenta_socket.c	2010-04-13 02:19:01.350571569 +0000
@@ -17,6 +17,7 @@
 #include <linux/delay.h>
 #include <linux/module.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/ss.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/Kconfig linux-2.6.34-rc4/drivers/platform/x86/Kconfig
--- linux-2.6.34-rc3/drivers/platform/x86/Kconfig	2010-04-13 02:18:56.101570543 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/Kconfig	2010-04-13 02:19:01.350571569 +0000
@@ -385,6 +385,16 @@
 
 	  If you have an Eee PC laptop, say Y or M here.
 
+config EEEPC_WMI
+	tristate "Eee PC WMI Hotkey Driver (EXPERIMENTAL)"
+	depends on ACPI_WMI
+	depends on INPUT
+	depends on EXPERIMENTAL
+	---help---
+	  Say Y here if you want to support WMI-based hotkeys on Eee PC laptops.
+
+	  To compile this driver as a module, choose M here: the module will
+	  be called eeepc-wmi.
 
 config ACPI_WMI
 	tristate "WMI"
diff -urN linux-2.6.34-rc3/drivers/platform/x86/Makefile linux-2.6.34-rc4/drivers/platform/x86/Makefile
--- linux-2.6.34-rc3/drivers/platform/x86/Makefile	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/Makefile	2010-04-13 02:19:01.350571569 +0000
@@ -4,6 +4,7 @@
 #
 obj-$(CONFIG_ASUS_LAPTOP)	+= asus-laptop.o
 obj-$(CONFIG_EEEPC_LAPTOP)	+= eeepc-laptop.o
+obj-$(CONFIG_EEEPC_WMI)		+= eeepc-wmi.o
 obj-$(CONFIG_MSI_LAPTOP)	+= msi-laptop.o
 obj-$(CONFIG_ACPI_CMPC)		+= classmate-laptop.o
 obj-$(CONFIG_COMPAL_LAPTOP)	+= compal-laptop.o
diff -urN linux-2.6.34-rc3/drivers/platform/x86/acer-wmi.c linux-2.6.34-rc4/drivers/platform/x86/acer-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/acer-wmi.c	2010-04-13 02:18:56.102570555 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/acer-wmi.c	2010-04-13 02:19:01.351570784 +0000
@@ -36,6 +36,7 @@
 #include <linux/rfkill.h>
 #include <linux/workqueue.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/platform/x86/asus-laptop.c linux-2.6.34-rc4/drivers/platform/x86/asus-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/asus-laptop.c	2010-04-13 02:18:56.103633092 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/asus-laptop.c	2010-04-13 02:19:01.352633055 +0000
@@ -49,6 +49,7 @@
 #include <linux/input.h>
 #include <linux/input/sparse-keymap.h>
 #include <linux/rfkill.h>
+#include <linux/slab.h>
 #include <acpi/acpi_drivers.h>
 #include <acpi/acpi_bus.h>
 
@@ -139,7 +140,7 @@
 
 /* Backlight */
 static acpi_handle lcd_switch_handle;
-static const char *lcd_switch_paths[] = {
+static char *lcd_switch_paths[] = {
   "\\_SB.PCI0.SBRG.EC0._Q10",	/* All new models */
   "\\_SB.PCI0.ISA.EC0._Q10",	/* A1x */
   "\\_SB.PCI0.PX40.ECD0._Q10",	/* L3C */
@@ -153,7 +154,7 @@
 #define METHOD_SWITCH_DISPLAY	"SDSP"
 
 static acpi_handle display_get_handle;
-static const char *display_get_paths[] = {
+static char *display_get_paths[] = {
   /* A6B, A6K A6R A7D F3JM L4R M6R A3G M6A M6V VX-1 V6J V6V W3Z */
   "\\_SB.PCI0.P0P1.VGA.GETD",
   /* A3E A4K, A4D A4L A6J A7J A8J Z71V M9V S5A M5A z33A W1Jc W2V G1 */
diff -urN linux-2.6.34-rc3/drivers/platform/x86/asus_acpi.c linux-2.6.34-rc4/drivers/platform/x86/asus_acpi.c
--- linux-2.6.34-rc3/drivers/platform/x86/asus_acpi.c	2010-04-13 02:18:56.103633092 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/asus_acpi.c	2010-04-13 02:19:01.352633055 +0000
@@ -32,6 +32,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/classmate-laptop.c linux-2.6.34-rc4/drivers/platform/x86/classmate-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/classmate-laptop.c	2010-04-13 02:18:56.103633092 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/classmate-laptop.c	2010-04-13 02:19:01.352633055 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <acpi/acpi_drivers.h>
 #include <linux/backlight.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/dell-laptop.c linux-2.6.34-rc4/drivers/platform/x86/dell-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/dell-laptop.c	2010-04-13 02:18:56.104633071 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/dell-laptop.c	2010-04-13 02:19:01.353633177 +0000
@@ -24,6 +24,7 @@
 #include <linux/acpi.h>
 #include <linux/mm.h>
 #include <linux/i8042.h>
+#include <linux/slab.h>
 #include "../../firmware/dcdbas.h"
 
 #define BRIGHTNESS_TOKEN 0x7d
diff -urN linux-2.6.34-rc3/drivers/platform/x86/dell-wmi.c linux-2.6.34-rc4/drivers/platform/x86/dell-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/dell-wmi.c	2010-04-13 02:18:56.104633071 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/dell-wmi.c	2010-04-13 02:19:01.353633177 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/input.h>
 #include <acpi/acpi_drivers.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/eeepc-laptop.c linux-2.6.34-rc4/drivers/platform/x86/eeepc-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/eeepc-laptop.c	2010-04-13 02:18:56.104633071 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/eeepc-laptop.c	2010-04-13 02:19:01.353633177 +0000
@@ -27,6 +27,7 @@
 #include <linux/fb.h>
 #include <linux/hwmon.h>
 #include <linux/hwmon-sysfs.h>
+#include <linux/slab.h>
 #include <acpi/acpi_drivers.h>
 #include <acpi/acpi_bus.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/eeepc-wmi.c linux-2.6.34-rc4/drivers/platform/x86/eeepc-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/eeepc-wmi.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/eeepc-wmi.c	2010-04-13 02:19:01.353633177 +0000
@@ -0,0 +1,158 @@
+/*
+ * Eee PC WMI hotkey driver
+ *
+ * Copyright(C) 2010 Intel Corporation.
+ *
+ * Portions based on wistron_btns.c:
+ * Copyright (C) 2005 Miloslav Trmac <mitr@volny.cz>
+ * Copyright (C) 2005 Bernhard Rosenkraenzer <bero@arklinux.org>
+ * Copyright (C) 2005 Dmitry Torokhov <dtor@mail.ru>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/init.h>
+#include <linux/types.h>
+#include <linux/slab.h>
+#include <linux/input.h>
+#include <linux/input/sparse-keymap.h>
+#include <acpi/acpi_bus.h>
+#include <acpi/acpi_drivers.h>
+
+MODULE_AUTHOR("Yong Wang <yong.y.wang@intel.com>");
+MODULE_DESCRIPTION("Eee PC WMI Hotkey Driver");
+MODULE_LICENSE("GPL");
+
+#define EEEPC_WMI_EVENT_GUID	"ABBC0F72-8EA1-11D1-00A0-C90629100000"
+
+MODULE_ALIAS("wmi:"EEEPC_WMI_EVENT_GUID);
+
+#define NOTIFY_BRNUP_MIN	0x11
+#define NOTIFY_BRNUP_MAX	0x1f
+#define NOTIFY_BRNDOWN_MIN	0x20
+#define NOTIFY_BRNDOWN_MAX	0x2e
+
+static const struct key_entry eeepc_wmi_keymap[] = {
+	/* Sleep already handled via generic ACPI code */
+	{ KE_KEY, 0x5d, { KEY_WLAN } },
+	{ KE_KEY, 0x32, { KEY_MUTE } },
+	{ KE_KEY, 0x31, { KEY_VOLUMEDOWN } },
+	{ KE_KEY, 0x30, { KEY_VOLUMEUP } },
+	{ KE_IGNORE, NOTIFY_BRNDOWN_MIN, { KEY_BRIGHTNESSDOWN } },
+	{ KE_IGNORE, NOTIFY_BRNUP_MIN, { KEY_BRIGHTNESSUP } },
+	{ KE_KEY, 0xcc, { KEY_SWITCHVIDEOMODE } },
+	{ KE_END, 0},
+};
+
+static struct input_dev *eeepc_wmi_input_dev;
+
+static void eeepc_wmi_notify(u32 value, void *context)
+{
+	struct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };
+	union acpi_object *obj;
+	acpi_status status;
+	int code;
+
+	status = wmi_get_event_data(value, &response);
+	if (status != AE_OK) {
+		pr_err("EEEPC WMI: bad event status 0x%x\n", status);
+		return;
+	}
+
+	obj = (union acpi_object *)response.pointer;
+
+	if (obj && obj->type == ACPI_TYPE_INTEGER) {
+		code = obj->integer.value;
+
+		if (code >= NOTIFY_BRNUP_MIN && code <= NOTIFY_BRNUP_MAX)
+			code = NOTIFY_BRNUP_MIN;
+		else if (code >= NOTIFY_BRNDOWN_MIN && code <= NOTIFY_BRNDOWN_MAX)
+			code = NOTIFY_BRNDOWN_MIN;
+
+		if (!sparse_keymap_report_event(eeepc_wmi_input_dev,
+						code, 1, true))
+			pr_info("EEEPC WMI: Unknown key %x pressed\n", code);
+	}
+
+	kfree(obj);
+}
+
+static int eeepc_wmi_input_setup(void)
+{
+	int err;
+
+	eeepc_wmi_input_dev = input_allocate_device();
+	if (!eeepc_wmi_input_dev)
+		return -ENOMEM;
+
+	eeepc_wmi_input_dev->name = "Eee PC WMI hotkeys";
+	eeepc_wmi_input_dev->phys = "wmi/input0";
+	eeepc_wmi_input_dev->id.bustype = BUS_HOST;
+
+	err = sparse_keymap_setup(eeepc_wmi_input_dev, eeepc_wmi_keymap, NULL);
+	if (err)
+		goto err_free_dev;
+
+	err = input_register_device(eeepc_wmi_input_dev);
+	if (err)
+		goto err_free_keymap;
+
+	return 0;
+
+err_free_keymap:
+	sparse_keymap_free(eeepc_wmi_input_dev);
+err_free_dev:
+	input_free_device(eeepc_wmi_input_dev);
+	return err;
+}
+
+static int __init eeepc_wmi_init(void)
+{
+	int err;
+	acpi_status status;
+
+	if (!wmi_has_guid(EEEPC_WMI_EVENT_GUID)) {
+		pr_warning("EEEPC WMI: No known WMI GUID found\n");
+		return -ENODEV;
+	}
+
+	err = eeepc_wmi_input_setup();
+	if (err)
+		return err;
+
+	status = wmi_install_notify_handler(EEEPC_WMI_EVENT_GUID,
+					eeepc_wmi_notify, NULL);
+	if (ACPI_FAILURE(status)) {
+		sparse_keymap_free(eeepc_wmi_input_dev);
+		input_unregister_device(eeepc_wmi_input_dev);
+		pr_err("EEEPC WMI: Unable to register notify handler - %d\n",
+			status);
+		return -ENODEV;
+	}
+
+	return 0;
+}
+
+static void __exit eeepc_wmi_exit(void)
+{
+	wmi_remove_notify_handler(EEEPC_WMI_EVENT_GUID);
+	sparse_keymap_free(eeepc_wmi_input_dev);
+	input_unregister_device(eeepc_wmi_input_dev);
+}
+
+module_init(eeepc_wmi_init);
+module_exit(eeepc_wmi_exit);
diff -urN linux-2.6.34-rc3/drivers/platform/x86/fujitsu-laptop.c linux-2.6.34-rc4/drivers/platform/x86/fujitsu-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/fujitsu-laptop.c	2010-04-13 02:18:56.104633071 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/fujitsu-laptop.c	2010-04-13 02:19:01.354633061 +0000
@@ -66,6 +66,7 @@
 #include <linux/kfifo.h>
 #include <linux/video_output.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)
 #include <linux/leds.h>
 #endif
diff -urN linux-2.6.34-rc3/drivers/platform/x86/hp-wmi.c linux-2.6.34-rc4/drivers/platform/x86/hp-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/hp-wmi.c	2010-04-13 02:18:56.105633088 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/hp-wmi.c	2010-04-13 02:19:01.354633061 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/input.h>
 #include <acpi/acpi_drivers.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/intel_menlow.c linux-2.6.34-rc4/drivers/platform/x86/intel_menlow.c
--- linux-2.6.34-rc3/drivers/platform/x86/intel_menlow.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/intel_menlow.c	2010-04-13 02:19:01.354633061 +0000
@@ -30,6 +30,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/pm.h>
@@ -396,6 +397,7 @@
 	if (!attr)
 		return -ENOMEM;
 
+	sysfs_attr_init(&attr->attr.attr); /* That is consistent naming :D */
 	attr->attr.attr.name = name;
 	attr->attr.attr.mode = mode;
 	attr->attr.show = show;
diff -urN linux-2.6.34-rc3/drivers/platform/x86/msi-wmi.c linux-2.6.34-rc4/drivers/platform/x86/msi-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/msi-wmi.c	2010-04-13 02:18:56.105633088 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/msi-wmi.c	2010-04-13 02:19:01.354633061 +0000
@@ -26,6 +26,7 @@
 #include <linux/input/sparse-keymap.h>
 #include <linux/acpi.h>
 #include <linux/backlight.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Thomas Renninger <trenn@suse.de>");
 MODULE_DESCRIPTION("MSI laptop WMI hotkeys driver");
diff -urN linux-2.6.34-rc3/drivers/platform/x86/panasonic-laptop.c linux-2.6.34-rc4/drivers/platform/x86/panasonic-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/panasonic-laptop.c	2010-04-13 02:18:56.105633088 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/panasonic-laptop.c	2010-04-13 02:19:01.355633146 +0000
@@ -124,6 +124,7 @@
 #include <linux/ctype.h>
 #include <linux/seq_file.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 #include <linux/input.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/sony-laptop.c linux-2.6.34-rc4/drivers/platform/x86/sony-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/sony-laptop.c	2010-04-13 02:18:56.106633070 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/sony-laptop.c	2010-04-13 02:19:01.355633146 +0000
@@ -58,6 +58,7 @@
 #include <linux/kfifo.h>
 #include <linux/workqueue.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_drivers.h>
 #include <acpi/acpi_bus.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/tc1100-wmi.c linux-2.6.34-rc4/drivers/platform/x86/tc1100-wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/tc1100-wmi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/tc1100-wmi.c	2010-04-13 02:19:01.355633146 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <acpi/acpi.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/thinkpad_acpi.c linux-2.6.34-rc4/drivers/platform/x86/thinkpad_acpi.c
--- linux-2.6.34-rc3/drivers/platform/x86/thinkpad_acpi.c	2010-04-13 02:18:56.107633052 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/thinkpad_acpi.c	2010-04-13 02:19:01.357633122 +0000
@@ -58,6 +58,7 @@
 #include <linux/kthread.h>
 #include <linux/freezer.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <linux/nvram.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/platform/x86/topstar-laptop.c linux-2.6.34-rc4/drivers/platform/x86/topstar-laptop.c
--- linux-2.6.34-rc3/drivers/platform/x86/topstar-laptop.c	2010-04-13 02:18:56.107633052 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/topstar-laptop.c	2010-04-13 02:19:01.357633122 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/acpi.h>
 #include <linux/input.h>
 
diff -urN linux-2.6.34-rc3/drivers/platform/x86/toshiba_acpi.c linux-2.6.34-rc4/drivers/platform/x86/toshiba_acpi.c
--- linux-2.6.34-rc3/drivers/platform/x86/toshiba_acpi.c	2010-04-13 02:18:56.107633052 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/toshiba_acpi.c	2010-04-13 02:19:01.357633122 +0000
@@ -47,6 +47,7 @@
 #include <linux/platform_device.h>
 #include <linux/rfkill.h>
 #include <linux/input.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/platform/x86/wmi.c linux-2.6.34-rc4/drivers/platform/x86/wmi.c
--- linux-2.6.34-rc3/drivers/platform/x86/wmi.c	2010-04-13 02:18:56.108633061 +0000
+++ linux-2.6.34-rc4/drivers/platform/x86/wmi.c	2010-04-13 02:19:01.357633122 +0000
@@ -33,6 +33,7 @@
 #include <linux/device.h>
 #include <linux/list.h>
 #include <linux/acpi.h>
+#include <linux/slab.h>
 #include <acpi/acpi_bus.h>
 #include <acpi/acpi_drivers.h>
 
diff -urN linux-2.6.34-rc3/drivers/pnp/isapnp/core.c linux-2.6.34-rc4/drivers/pnp/isapnp/core.c
--- linux-2.6.34-rc3/drivers/pnp/isapnp/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pnp/isapnp/core.c	2010-04-13 02:19:01.358633111 +0000
@@ -37,7 +37,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/isapnp.h>
diff -urN linux-2.6.34-rc3/drivers/pnp/manager.c linux-2.6.34-rc4/drivers/pnp/manager.c
--- linux-2.6.34-rc3/drivers/pnp/manager.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pnp/manager.c	2010-04-13 02:19:01.358633111 +0000
@@ -12,7 +12,6 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/pnp.h>
-#include <linux/slab.h>
 #include <linux/bitmap.h>
 #include <linux/mutex.h>
 #include "base.h"
diff -urN linux-2.6.34-rc3/drivers/pnp/pnpacpi/core.c linux-2.6.34-rc4/drivers/pnp/pnpacpi/core.c
--- linux-2.6.34-rc3/drivers/pnp/pnpacpi/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pnp/pnpacpi/core.c	2010-04-13 02:19:01.358633111 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/acpi.h>
 #include <linux/pnp.h>
+#include <linux/slab.h>
 #include <linux/mod_devicetable.h>
 #include <acpi/acpi_bus.h>
 
diff -urN linux-2.6.34-rc3/drivers/pnp/pnpacpi/rsparser.c linux-2.6.34-rc4/drivers/pnp/pnpacpi/rsparser.c
--- linux-2.6.34-rc3/drivers/pnp/pnpacpi/rsparser.c	2010-04-13 02:18:56.108633061 +0000
+++ linux-2.6.34-rc4/drivers/pnp/pnpacpi/rsparser.c	2010-04-13 02:19:01.358633111 +0000
@@ -24,6 +24,7 @@
 #include <linux/acpi.h>
 #include <linux/pci.h>
 #include <linux/pnp.h>
+#include <linux/slab.h>
 #include "../base.h"
 #include "pnpacpi.h"
 
@@ -273,12 +274,33 @@
 	pnp_add_bus_resource(dev, start, end);
 }
 
+static u64 addr_space_length(struct pnp_dev *dev, u64 min, u64 max, u64 len)
+{
+	u64 max_len;
+
+	max_len = max - min + 1;
+	if (len <= max_len)
+		return len;
+
+	/*
+	 * Per 6.4.3.5, _LEN cannot exceed _MAX - _MIN + 1, but some BIOSes
+	 * don't do this correctly, e.g.,
+	 * https://bugzilla.kernel.org/show_bug.cgi?id=15480
+	 */
+	dev_info(&dev->dev,
+	         "resource length %#llx doesn't fit in %#llx-%#llx, trimming\n",
+		 (unsigned long long) len, (unsigned long long) min,
+		 (unsigned long long) max);
+	return max_len;
+}
+
 static void pnpacpi_parse_allocated_address_space(struct pnp_dev *dev,
 						  struct acpi_resource *res)
 {
 	struct acpi_resource_address64 addr, *p = &addr;
 	acpi_status status;
 	int window;
+	u64 len;
 
 	status = acpi_resource_to_address64(res, p);
 	if (!ACPI_SUCCESS(status)) {
@@ -287,20 +309,18 @@
 		return;
 	}
 
+	len = addr_space_length(dev, p->minimum, p->maximum, p->address_length);
 	window = (p->producer_consumer == ACPI_PRODUCER) ? 1 : 0;
 
 	if (p->resource_type == ACPI_MEMORY_RANGE)
-		pnpacpi_parse_allocated_memresource(dev,
-			p->minimum, p->address_length,
+		pnpacpi_parse_allocated_memresource(dev, p->minimum, len,
 			p->info.mem.write_protect, window);
 	else if (p->resource_type == ACPI_IO_RANGE)
-		pnpacpi_parse_allocated_ioresource(dev,
-			p->minimum, p->address_length,
+		pnpacpi_parse_allocated_ioresource(dev, p->minimum, len,
 			p->granularity == 0xfff ? ACPI_DECODE_10 :
 				ACPI_DECODE_16, window);
 	else if (p->resource_type == ACPI_BUS_NUMBER_RANGE)
-		pnpacpi_parse_allocated_busresource(dev, p->minimum,
-						    p->address_length);
+		pnpacpi_parse_allocated_busresource(dev, p->minimum, len);
 }
 
 static void pnpacpi_parse_allocated_ext_address_space(struct pnp_dev *dev,
@@ -308,21 +328,20 @@
 {
 	struct acpi_resource_extended_address64 *p = &res->data.ext_address64;
 	int window;
+	u64 len;
 
+	len = addr_space_length(dev, p->minimum, p->maximum, p->address_length);
 	window = (p->producer_consumer == ACPI_PRODUCER) ? 1 : 0;
 
 	if (p->resource_type == ACPI_MEMORY_RANGE)
-		pnpacpi_parse_allocated_memresource(dev,
-			p->minimum, p->address_length,
+		pnpacpi_parse_allocated_memresource(dev, p->minimum, len,
 			p->info.mem.write_protect, window);
 	else if (p->resource_type == ACPI_IO_RANGE)
-		pnpacpi_parse_allocated_ioresource(dev,
-			p->minimum, p->address_length,
+		pnpacpi_parse_allocated_ioresource(dev, p->minimum, len,
 			p->granularity == 0xfff ? ACPI_DECODE_10 :
 				ACPI_DECODE_16, window);
 	else if (p->resource_type == ACPI_BUS_NUMBER_RANGE)
-		pnpacpi_parse_allocated_busresource(dev, p->minimum,
-						    p->address_length);
+		pnpacpi_parse_allocated_busresource(dev, p->minimum, len);
 }
 
 static acpi_status pnpacpi_allocated_resource(struct acpi_resource *res,
diff -urN linux-2.6.34-rc3/drivers/pnp/pnpbios/bioscalls.c linux-2.6.34-rc4/drivers/pnp/pnpbios/bioscalls.c
--- linux-2.6.34-rc3/drivers/pnp/pnpbios/bioscalls.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pnp/pnpbios/bioscalls.c	2010-04-13 02:19:01.358633111 +0000
@@ -11,7 +11,6 @@
 #include <linux/pnp.h>
 #include <linux/mm.h>
 #include <linux/smp.h>
-#include <linux/slab.h>
 #include <linux/kmod.h>
 #include <linux/completion.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/pnp/pnpbios/rsparser.c linux-2.6.34-rc4/drivers/pnp/pnpbios/rsparser.c
--- linux-2.6.34-rc3/drivers/pnp/pnpbios/rsparser.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pnp/pnpbios/rsparser.c	2010-04-13 02:19:01.359633088 +0000
@@ -5,7 +5,6 @@
 #include <linux/ctype.h>
 #include <linux/pnp.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 
 #ifdef CONFIG_PCI
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/pnp/resource.c linux-2.6.34-rc4/drivers/pnp/resource.c
--- linux-2.6.34-rc3/drivers/pnp/resource.c	2010-04-13 02:18:56.108633061 +0000
+++ linux-2.6.34-rc4/drivers/pnp/resource.c	2010-04-13 02:19:01.359633088 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/interrupt.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/power/bq27x00_battery.c linux-2.6.34-rc4/drivers/power/bq27x00_battery.c
--- linux-2.6.34-rc3/drivers/power/bq27x00_battery.c	2010-04-13 02:18:56.109571708 +0000
+++ linux-2.6.34-rc4/drivers/power/bq27x00_battery.c	2010-04-13 02:19:01.359633088 +0000
@@ -24,6 +24,7 @@
 #include <linux/power_supply.h>
 #include <linux/idr.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #define DRIVER_VERSION			"1.1.0"
diff -urN linux-2.6.34-rc3/drivers/power/da9030_battery.c linux-2.6.34-rc4/drivers/power/da9030_battery.c
--- linux-2.6.34-rc3/drivers/power/da9030_battery.c	2010-04-13 02:18:56.109571708 +0000
+++ linux-2.6.34-rc4/drivers/power/da9030_battery.c	2010-04-13 02:19:01.360570739 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/power/ds2760_battery.c linux-2.6.34-rc4/drivers/power/ds2760_battery.c
--- linux-2.6.34-rc3/drivers/power/ds2760_battery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/ds2760_battery.c	2010-04-13 02:19:01.360570739 +0000
@@ -24,6 +24,7 @@
 #include <linux/jiffies.h>
 #include <linux/workqueue.h>
 #include <linux/pm.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/power_supply.h>
 
diff -urN linux-2.6.34-rc3/drivers/power/ds2782_battery.c linux-2.6.34-rc4/drivers/power/ds2782_battery.c
--- linux-2.6.34-rc3/drivers/power/ds2782_battery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/ds2782_battery.c	2010-04-13 02:19:01.360570739 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/idr.h>
 #include <linux/power_supply.h>
+#include <linux/slab.h>
 
 #define DS2782_REG_RARC		0x06	/* Remaining active relative capacity */
 
diff -urN linux-2.6.34-rc3/drivers/power/max17040_battery.c linux-2.6.34-rc4/drivers/power/max17040_battery.c
--- linux-2.6.34-rc3/drivers/power/max17040_battery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/max17040_battery.c	2010-04-13 02:19:01.360570739 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/power_supply.h>
 #include <linux/max17040_battery.h>
+#include <linux/slab.h>
 
 #define MAX17040_VCELL_MSB	0x02
 #define MAX17040_VCELL_LSB	0x03
diff -urN linux-2.6.34-rc3/drivers/power/max8925_power.c linux-2.6.34-rc4/drivers/power/max8925_power.c
--- linux-2.6.34-rc3/drivers/power/max8925_power.c	2010-04-13 02:18:56.109571708 +0000
+++ linux-2.6.34-rc4/drivers/power/max8925_power.c	2010-04-13 02:19:01.360570739 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/power/pcf50633-charger.c linux-2.6.34-rc4/drivers/power/pcf50633-charger.c
--- linux-2.6.34-rc3/drivers/power/pcf50633-charger.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/pcf50633-charger.c	2010-04-13 02:19:01.360570739 +0000
@@ -16,6 +16,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/power/pmu_battery.c linux-2.6.34-rc4/drivers/power/pmu_battery.c
--- linux-2.6.34-rc3/drivers/power/pmu_battery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/pmu_battery.c	2010-04-13 02:19:01.360570739 +0000
@@ -14,6 +14,7 @@
 #include <linux/power_supply.h>
 #include <linux/adb.h>
 #include <linux/pmu.h>
+#include <linux/slab.h>
 
 static struct pmu_battery_dev {
 	struct power_supply bat;
diff -urN linux-2.6.34-rc3/drivers/power/power_supply_leds.c linux-2.6.34-rc4/drivers/power/power_supply_leds.c
--- linux-2.6.34-rc3/drivers/power/power_supply_leds.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/power_supply_leds.c	2010-04-13 02:19:01.360570739 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/kernel.h>
 #include <linux/power_supply.h>
+#include <linux/slab.h>
 
 #include "power_supply.h"
 
diff -urN linux-2.6.34-rc3/drivers/power/power_supply_sysfs.c linux-2.6.34-rc4/drivers/power/power_supply_sysfs.c
--- linux-2.6.34-rc3/drivers/power/power_supply_sysfs.c	2010-04-13 02:18:56.109571708 +0000
+++ linux-2.6.34-rc4/drivers/power/power_supply_sysfs.c	2010-04-13 02:19:01.361570713 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/ctype.h>
 #include <linux/power_supply.h>
+#include <linux/slab.h>
 
 #include "power_supply.h"
 
diff -urN linux-2.6.34-rc3/drivers/power/wm831x_backup.c linux-2.6.34-rc4/drivers/power/wm831x_backup.c
--- linux-2.6.34-rc3/drivers/power/wm831x_backup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/wm831x_backup.c	2010-04-13 02:19:01.361570713 +0000
@@ -12,6 +12,7 @@
 #include <linux/err.h>
 #include <linux/platform_device.h>
 #include <linux/power_supply.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/auxadc.h>
diff -urN linux-2.6.34-rc3/drivers/power/wm831x_power.c linux-2.6.34-rc4/drivers/power/wm831x_power.c
--- linux-2.6.34-rc3/drivers/power/wm831x_power.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/power/wm831x_power.c	2010-04-13 02:19:01.361570713 +0000
@@ -12,6 +12,7 @@
 #include <linux/err.h>
 #include <linux/platform_device.h>
 #include <linux/power_supply.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/auxadc.h>
diff -urN linux-2.6.34-rc3/drivers/power/wm97xx_battery.c linux-2.6.34-rc4/drivers/power/wm97xx_battery.c
--- linux-2.6.34-rc3/drivers/power/wm97xx_battery.c	2010-04-13 02:18:56.110570487 +0000
+++ linux-2.6.34-rc4/drivers/power/wm97xx_battery.c	2010-04-13 02:19:01.361570713 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/gpio.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 static DEFINE_MUTEX(bat_lock);
 static struct work_struct bat_work;
diff -urN linux-2.6.34-rc3/drivers/pps/kapi.c linux-2.6.34-rc4/drivers/pps/kapi.c
--- linux-2.6.34-rc3/drivers/pps/kapi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/pps/kapi.c	2010-04-13 02:19:01.362633731 +0000
@@ -29,6 +29,7 @@
 #include <linux/idr.h>
 #include <linux/fs.h>
 #include <linux/pps_kernel.h>
+#include <linux/slab.h>
 
 /*
  * Global variables
diff -urN linux-2.6.34-rc3/drivers/ps3/ps3-lpm.c linux-2.6.34-rc4/drivers/ps3/ps3-lpm.c
--- linux-2.6.34-rc3/drivers/ps3/ps3-lpm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ps3/ps3-lpm.c	2010-04-13 02:19:01.362633731 +0000
@@ -18,6 +18,7 @@
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/ps3/ps3-vuart.c linux-2.6.34-rc4/drivers/ps3/ps3-vuart.c
--- linux-2.6.34-rc3/drivers/ps3/ps3-vuart.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ps3/ps3-vuart.c	2010-04-13 02:19:01.362633731 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/ps3/ps3av.c linux-2.6.34-rc4/drivers/ps3/ps3av.c
--- linux-2.6.34-rc3/drivers/ps3/ps3av.c	2010-04-13 02:18:56.110570487 +0000
+++ linux-2.6.34-rc4/drivers/ps3/ps3av.c	2010-04-13 02:19:01.362633731 +0000
@@ -24,6 +24,7 @@
 #include <linux/notifier.h>
 #include <linux/ioctl.h>
 #include <linux/fb.h>
+#include <linux/slab.h>
 
 #include <asm/firmware.h>
 #include <asm/ps3av.h>
diff -urN linux-2.6.34-rc3/drivers/regulator/core.c linux-2.6.34-rc4/drivers/regulator/core.c
--- linux-2.6.34-rc3/drivers/regulator/core.c	2010-04-13 02:18:56.111633036 +0000
+++ linux-2.6.34-rc4/drivers/regulator/core.c	2010-04-13 02:19:01.363633649 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/mutex.h>
 #include <linux/suspend.h>
diff -urN linux-2.6.34-rc3/drivers/regulator/fixed.c linux-2.6.34-rc4/drivers/regulator/fixed.c
--- linux-2.6.34-rc3/drivers/regulator/fixed.c	2010-04-13 02:18:56.112633039 +0000
+++ linux-2.6.34-rc4/drivers/regulator/fixed.c	2010-04-13 02:19:01.364633692 +0000
@@ -25,6 +25,7 @@
 #include <linux/regulator/fixed.h>
 #include <linux/gpio.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 struct fixed_voltage_data {
 	struct regulator_desc desc;
diff -urN linux-2.6.34-rc3/drivers/regulator/lp3971.c linux-2.6.34-rc4/drivers/regulator/lp3971.c
--- linux-2.6.34-rc3/drivers/regulator/lp3971.c	2010-04-13 02:18:56.112633039 +0000
+++ linux-2.6.34-rc4/drivers/regulator/lp3971.c	2010-04-13 02:19:01.364633692 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/regulator/driver.h>
 #include <linux/regulator/lp3971.h>
+#include <linux/slab.h>
 
 struct lp3971 {
 	struct device *dev;
diff -urN linux-2.6.34-rc3/drivers/regulator/max1586.c linux-2.6.34-rc4/drivers/regulator/max1586.c
--- linux-2.6.34-rc3/drivers/regulator/max1586.c	2010-04-13 02:18:56.112633039 +0000
+++ linux-2.6.34-rc4/drivers/regulator/max1586.c	2010-04-13 02:19:01.364633692 +0000
@@ -22,6 +22,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
+#include <linux/slab.h>
 #include <linux/regulator/max1586.h>
 
 #define MAX1586_V3_MAX_VSEL 31
diff -urN linux-2.6.34-rc3/drivers/regulator/max8649.c linux-2.6.34-rc4/drivers/regulator/max8649.c
--- linux-2.6.34-rc3/drivers/regulator/max8649.c	2010-04-13 02:18:56.112633039 +0000
+++ linux-2.6.34-rc4/drivers/regulator/max8649.c	2010-04-13 02:19:01.364633692 +0000
@@ -14,6 +14,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
+#include <linux/slab.h>
 #include <linux/regulator/max8649.h>
 
 #define MAX8649_DCDC_VMIN	750000		/* uV */
diff -urN linux-2.6.34-rc3/drivers/regulator/max8660.c linux-2.6.34-rc4/drivers/regulator/max8660.c
--- linux-2.6.34-rc3/drivers/regulator/max8660.c	2010-04-13 02:18:56.112633039 +0000
+++ linux-2.6.34-rc4/drivers/regulator/max8660.c	2010-04-13 02:19:01.364633692 +0000
@@ -42,6 +42,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
+#include <linux/slab.h>
 #include <linux/regulator/max8660.h>
 
 #define MAX8660_DCDC_MIN_UV	 725000
diff -urN linux-2.6.34-rc3/drivers/regulator/mc13783-regulator.c linux-2.6.34-rc4/drivers/regulator/mc13783-regulator.c
--- linux-2.6.34-rc3/drivers/regulator/mc13783-regulator.c	2010-04-13 02:18:56.113633041 +0000
+++ linux-2.6.34-rc4/drivers/regulator/mc13783-regulator.c	2010-04-13 02:19:01.365633171 +0000
@@ -14,6 +14,7 @@
 #include <linux/regulator/driver.h>
 #include <linux/platform_device.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/err.h>
 
diff -urN linux-2.6.34-rc3/drivers/regulator/tps65023-regulator.c linux-2.6.34-rc4/drivers/regulator/tps65023-regulator.c
--- linux-2.6.34-rc3/drivers/regulator/tps65023-regulator.c	2010-04-13 02:18:56.113633041 +0000
+++ linux-2.6.34-rc4/drivers/regulator/tps65023-regulator.c	2010-04-13 02:19:01.365633171 +0000
@@ -24,6 +24,7 @@
 #include <linux/regulator/machine.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 /* Register definitions */
 #define	TPS65023_REG_VERSION		0
diff -urN linux-2.6.34-rc3/drivers/regulator/tps6507x-regulator.c linux-2.6.34-rc4/drivers/regulator/tps6507x-regulator.c
--- linux-2.6.34-rc3/drivers/regulator/tps6507x-regulator.c	2010-04-13 02:18:56.113633041 +0000
+++ linux-2.6.34-rc4/drivers/regulator/tps6507x-regulator.c	2010-04-13 02:19:01.365633171 +0000
@@ -24,6 +24,7 @@
 #include <linux/regulator/machine.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 /* Register definitions */
 #define	TPS6507X_REG_PPATH1				0X01
diff -urN linux-2.6.34-rc3/drivers/regulator/userspace-consumer.c linux-2.6.34-rc4/drivers/regulator/userspace-consumer.c
--- linux-2.6.34-rc3/drivers/regulator/userspace-consumer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/regulator/userspace-consumer.c	2010-04-13 02:19:01.366633533 +0000
@@ -21,6 +21,7 @@
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
 #include <linux/regulator/userspace-consumer.h>
+#include <linux/slab.h>
 
 struct userspace_consumer_data {
 	const char *name;
diff -urN linux-2.6.34-rc3/drivers/regulator/virtual.c linux-2.6.34-rc4/drivers/regulator/virtual.c
--- linux-2.6.34-rc3/drivers/regulator/virtual.c	2010-04-13 02:18:56.113633041 +0000
+++ linux-2.6.34-rc4/drivers/regulator/virtual.c	2010-04-13 02:19:01.366633533 +0000
@@ -15,6 +15,7 @@
 #include <linux/mutex.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 
 struct virtual_consumer_data {
 	struct mutex lock;
diff -urN linux-2.6.34-rc3/drivers/regulator/wm831x-dcdc.c linux-2.6.34-rc4/drivers/regulator/wm831x-dcdc.c
--- linux-2.6.34-rc3/drivers/regulator/wm831x-dcdc.c	2010-04-13 02:18:56.114633092 +0000
+++ linux-2.6.34-rc4/drivers/regulator/wm831x-dcdc.c	2010-04-13 02:19:01.366633533 +0000
@@ -21,6 +21,7 @@
 #include <linux/regulator/driver.h>
 #include <linux/regulator/machine.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/regulator.h>
diff -urN linux-2.6.34-rc3/drivers/regulator/wm831x-isink.c linux-2.6.34-rc4/drivers/regulator/wm831x-isink.c
--- linux-2.6.34-rc3/drivers/regulator/wm831x-isink.c	2010-04-13 02:18:56.114633092 +0000
+++ linux-2.6.34-rc4/drivers/regulator/wm831x-isink.c	2010-04-13 02:19:01.366633533 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/regulator.h>
diff -urN linux-2.6.34-rc3/drivers/regulator/wm831x-ldo.c linux-2.6.34-rc4/drivers/regulator/wm831x-ldo.c
--- linux-2.6.34-rc3/drivers/regulator/wm831x-ldo.c	2010-04-13 02:18:56.114633092 +0000
+++ linux-2.6.34-rc4/drivers/regulator/wm831x-ldo.c	2010-04-13 02:19:01.366633533 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/regulator.h>
diff -urN linux-2.6.34-rc3/drivers/regulator/wm8994-regulator.c linux-2.6.34-rc4/drivers/regulator/wm8994-regulator.c
--- linux-2.6.34-rc3/drivers/regulator/wm8994-regulator.c	2010-04-13 02:18:56.114633092 +0000
+++ linux-2.6.34-rc4/drivers/regulator/wm8994-regulator.c	2010-04-13 02:19:01.367633753 +0000
@@ -19,6 +19,7 @@
 #include <linux/platform_device.h>
 #include <linux/regulator/driver.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm8994/core.h>
 #include <linux/mfd/wm8994/registers.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/class.c linux-2.6.34-rc4/drivers/rtc/class.c
--- linux-2.6.34-rc3/drivers/rtc/class.c	2010-04-13 02:18:56.115633059 +0000
+++ linux-2.6.34-rc4/drivers/rtc/class.c	2010-04-13 02:19:01.367633753 +0000
@@ -15,6 +15,7 @@
 #include <linux/rtc.h>
 #include <linux/kdev_t.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 
 #include "rtc-core.h"
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-at32ap700x.c linux-2.6.34-rc4/drivers/rtc/rtc-at32ap700x.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-at32ap700x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-at32ap700x.c	2010-04-13 02:19:01.367633753 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-at91sam9.c linux-2.6.34-rc4/drivers/rtc/rtc-at91sam9.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-at91sam9.c	2010-04-13 02:18:56.115633059 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-at91sam9.c	2010-04-13 02:19:01.368633814 +0000
@@ -18,6 +18,7 @@
 #include <linux/rtc.h>
 #include <linux/interrupt.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 
 #include <mach/board.h>
 #include <mach/at91_rtt.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-bfin.c linux-2.6.34-rc4/drivers/rtc/rtc-bfin.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-bfin.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-bfin.c	2010-04-13 02:19:01.368633814 +0000
@@ -51,6 +51,7 @@
 #include <linux/platform_device.h>
 #include <linux/rtc.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/blackfin.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-bq4802.c linux-2.6.34-rc4/drivers/rtc/rtc-bq4802.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-bq4802.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-bq4802.c	2010-04-13 02:19:01.368633814 +0000
@@ -10,6 +10,7 @@
 #include <linux/platform_device.h>
 #include <linux/rtc.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("David S. Miller <davem@davemloft.net>");
 MODULE_DESCRIPTION("TI BQ4802 RTC driver");
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-coh901331.c linux-2.6.34-rc4/drivers/rtc/rtc-coh901331.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-coh901331.c	2010-04-13 02:18:56.115633059 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-coh901331.c	2010-04-13 02:19:01.368633814 +0000
@@ -14,6 +14,7 @@
 #include <linux/pm.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /*
  * Registers in the COH 901 331
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1216.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1216.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1216.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1216.c	2010-04-13 02:19:01.368633814 +0000
@@ -9,6 +9,7 @@
 #include <linux/rtc.h>
 #include <linux/platform_device.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #define DRV_VERSION "0.2"
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1286.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1286.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1286.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1286.c	2010-04-13 02:19:01.368633814 +0000
@@ -18,6 +18,7 @@
 #include <linux/bcd.h>
 #include <linux/ds1286.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define DRV_VERSION		"1.0"
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1305.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1305.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1305.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1305.c	2010-04-13 02:19:01.368633814 +0000
@@ -11,6 +11,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/workqueue.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1374.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1374.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1374.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1374.c	2010-04-13 02:19:01.368633814 +0000
@@ -24,6 +24,7 @@
 #include <linux/rtc.h>
 #include <linux/bcd.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #define DS1374_REG_TOD0		0x00 /* Time of Day */
 #define DS1374_REG_TOD1		0x01
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1390.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1390.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1390.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1390.c	2010-04-13 02:19:01.368633814 +0000
@@ -19,6 +19,7 @@
 #include <linux/rtc.h>
 #include <linux/spi/spi.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #define DS1390_REG_100THS		0x00
 #define DS1390_REG_SECONDS		0x01
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1511.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1511.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1511.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1511.c	2010-04-13 02:19:01.369633555 +0000
@@ -17,6 +17,7 @@
 #include <linux/bcd.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/rtc.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1553.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1553.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1553.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1553.c	2010-04-13 02:19:01.369633555 +0000
@@ -11,6 +11,7 @@
 #include <linux/bcd.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/jiffies.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ds1742.c linux-2.6.34-rc4/drivers/rtc/rtc-ds1742.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ds1742.c	2010-04-13 02:18:56.115633059 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ds1742.c	2010-04-13 02:19:01.369633555 +0000
@@ -15,6 +15,7 @@
 #include <linux/bcd.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/jiffies.h>
 #include <linux/rtc.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-ep93xx.c linux-2.6.34-rc4/drivers/rtc/rtc-ep93xx.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-ep93xx.c	2010-04-13 02:18:56.115633059 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-ep93xx.c	2010-04-13 02:19:01.369633555 +0000
@@ -13,6 +13,7 @@
 #include <linux/rtc.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #define EP93XX_RTC_DATA			0x000
 #define EP93XX_RTC_MATCH		0x004
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-fm3130.c linux-2.6.34-rc4/drivers/rtc/rtc-fm3130.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-fm3130.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-fm3130.c	2010-04-13 02:19:01.369633555 +0000
@@ -13,6 +13,7 @@
 #include <linux/i2c.h>
 #include <linux/rtc.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #define FM3130_RTC_CONTROL	(0x0)
 #define FM3130_CAL_CONTROL	(0x1)
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-m48t35.c linux-2.6.34-rc4/drivers/rtc/rtc-m48t35.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-m48t35.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-m48t35.c	2010-04-13 02:19:01.369633555 +0000
@@ -16,6 +16,7 @@
 
 #include <linux/module.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/bcd.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-m48t59.c linux-2.6.34-rc4/drivers/rtc/rtc-m48t59.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-m48t59.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-m48t59.c	2010-04-13 02:19:01.369633555 +0000
@@ -19,6 +19,7 @@
 #include <linux/rtc.h>
 #include <linux/rtc/m48t59.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #ifndef NO_IRQ
 #define NO_IRQ	(-1)
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-max8925.c linux-2.6.34-rc4/drivers/rtc/rtc-max8925.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-max8925.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-max8925.c	2010-04-13 02:19:01.369633555 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/platform_device.h>
 #include <linux/mfd/max8925.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-mc13783.c linux-2.6.34-rc4/drivers/rtc/rtc-mc13783.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-mc13783.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-mc13783.c	2010-04-13 02:19:01.370633481 +0000
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 
 #define DRIVER_NAME "mc13783-rtc"
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-mpc5121.c linux-2.6.34-rc4/drivers/rtc/rtc-mpc5121.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-mpc5121.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-mpc5121.c	2010-04-13 02:19:01.370633481 +0000
@@ -15,6 +15,7 @@
 #include <linux/of_device.h>
 #include <linux/of_platform.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 struct mpc5121_rtc_regs {
 	u8 set_time;		/* RTC + 0x00 */
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-msm6242.c linux-2.6.34-rc4/drivers/rtc/rtc-msm6242.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-msm6242.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-msm6242.c	2010-04-13 02:19:01.370633481 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 
 
 enum {
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-mv.c linux-2.6.34-rc4/drivers/rtc/rtc-mv.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-mv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-mv.c	2010-04-13 02:19:01.370633481 +0000
@@ -13,6 +13,7 @@
 #include <linux/io.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 
 #define RTC_TIME_REG_OFFS	0
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-mxc.c linux-2.6.34-rc4/drivers/rtc/rtc-mxc.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-mxc.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-mxc.c	2010-04-13 02:19:01.370633481 +0000
@@ -12,6 +12,7 @@
 #include <linux/io.h>
 #include <linux/rtc.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
@@ -383,21 +384,26 @@
 	struct rtc_device *rtc;
 	struct rtc_plat_data *pdata = NULL;
 	u32 reg;
-	int ret, rate;
+	unsigned long rate;
+	int ret;
 
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	if (!res)
 		return -ENODEV;
 
-	pdata = kzalloc(sizeof(*pdata), GFP_KERNEL);
+	pdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);
 	if (!pdata)
 		return -ENOMEM;
 
-	pdata->ioaddr = ioremap(res->start, resource_size(res));
+	if (!devm_request_mem_region(&pdev->dev, res->start,
+				     resource_size(res), pdev->name))
+		return -EBUSY;
+
+	pdata->ioaddr = devm_ioremap(&pdev->dev, res->start,
+				     resource_size(res));
 
 	clk = clk_get(&pdev->dev, "ckil");
 	if (IS_ERR(clk)) {
-		iounmap(pdata->ioaddr);
 		ret = PTR_ERR(clk);
 		goto exit_free_pdata;
 	}
@@ -412,8 +418,7 @@
 	else if (rate == 38400)
 		reg = RTC_INPUT_CLK_38400HZ;
 	else {
-		dev_err(&pdev->dev, "rtc clock is not valid (%lu)\n",
-			clk_get_rate(clk));
+		dev_err(&pdev->dev, "rtc clock is not valid (%lu)\n", rate);
 		ret = -EINVAL;
 		goto exit_free_pdata;
 	}
@@ -449,8 +454,8 @@
 	pdata->irq = platform_get_irq(pdev, 0);
 
 	if (pdata->irq >= 0 &&
-	    request_irq(pdata->irq, mxc_rtc_interrupt, IRQF_SHARED,
-			pdev->name, pdev) < 0) {
+	    devm_request_irq(&pdev->dev, pdata->irq, mxc_rtc_interrupt,
+			     IRQF_SHARED, pdev->name, pdev) < 0) {
 		dev_warn(&pdev->dev, "interrupt not available.\n");
 		pdata->irq = -1;
 	}
@@ -458,10 +463,10 @@
 	return 0;
 
 exit_put_clk:
+	clk_disable(pdata->clk);
 	clk_put(pdata->clk);
 
 exit_free_pdata:
-	kfree(pdata);
 
 	return ret;
 }
@@ -472,12 +477,8 @@
 
 	rtc_device_unregister(pdata->rtc);
 
-	if (pdata->irq >= 0)
-		free_irq(pdata->irq, pdev);
-
 	clk_disable(pdata->clk);
 	clk_put(pdata->clk);
-	kfree(pdata);
 	platform_set_drvdata(pdev, NULL);
 
 	return 0;
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-nuc900.c linux-2.6.34-rc4/drivers/rtc/rtc-nuc900.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-nuc900.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-nuc900.c	2010-04-13 02:19:01.370633481 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/delay.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pcap.c linux-2.6.34-rc4/drivers/rtc/rtc-pcap.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pcap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pcap.c	2010-04-13 02:19:01.371633704 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/mfd/ezx-pcap.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 
 struct pcap_rtc {
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pcf2123.c linux-2.6.34-rc4/drivers/rtc/rtc-pcf2123.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pcf2123.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pcf2123.c	2010-04-13 02:19:01.371633704 +0000
@@ -39,6 +39,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pcf50633.c linux-2.6.34-rc4/drivers/rtc/rtc-pcf50633.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pcf50633.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pcf50633.c	2010-04-13 02:19:01.371633704 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/rtc.h>
 #include <linux/bcd.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pcf8563.c linux-2.6.34-rc4/drivers/rtc/rtc-pcf8563.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pcf8563.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pcf8563.c	2010-04-13 02:19:01.371633704 +0000
@@ -17,6 +17,7 @@
 #include <linux/i2c.h>
 #include <linux/bcd.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 
 #define DRV_VERSION "0.4.3"
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pl030.c linux-2.6.34-rc4/drivers/rtc/rtc-pl030.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pl030.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pl030.c	2010-04-13 02:19:01.371633704 +0000
@@ -13,6 +13,7 @@
 #include <linux/interrupt.h>
 #include <linux/amba/bus.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #define RTC_DR		(0)
 #define RTC_MR		(4)
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pl031.c linux-2.6.34-rc4/drivers/rtc/rtc-pl031.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pl031.c	2010-04-13 02:18:56.116571340 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pl031.c	2010-04-13 02:19:01.371633704 +0000
@@ -24,6 +24,7 @@
 #include <linux/bcd.h>
 #include <linux/delay.h>
 #include <linux/version.h>
+#include <linux/slab.h>
 
 /*
  * Register definitions
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-pxa.c linux-2.6.34-rc4/drivers/rtc/rtc-pxa.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-pxa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-pxa.c	2010-04-13 02:19:01.371633704 +0000
@@ -26,6 +26,7 @@
 #include <linux/seq_file.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-rp5c01.c linux-2.6.34-rc4/drivers/rtc/rtc-rp5c01.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-rp5c01.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-rp5c01.c	2010-04-13 02:19:01.371633704 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 
 
 enum {
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-rs5c348.c linux-2.6.34-rc4/drivers/rtc/rtc-rs5c348.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-rs5c348.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-rs5c348.c	2010-04-13 02:19:01.372633717 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include <linux/workqueue.h>
 #include <linux/spi/spi.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-rs5c372.c linux-2.6.34-rc4/drivers/rtc/rtc-rs5c372.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-rs5c372.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-rs5c372.c	2010-04-13 02:19:01.372633717 +0000
@@ -13,6 +13,7 @@
 #include <linux/i2c.h>
 #include <linux/rtc.h>
 #include <linux/bcd.h>
+#include <linux/slab.h>
 
 #define DRV_VERSION "0.6"
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-rx8025.c linux-2.6.34-rc4/drivers/rtc/rtc-rx8025.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-rx8025.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-rx8025.c	2010-04-13 02:19:01.372633717 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/bcd.h>
 #include <linux/i2c.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-s3c.c linux-2.6.34-rc4/drivers/rtc/rtc-s3c.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-s3c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-s3c.c	2010-04-13 02:19:01.372633717 +0000
@@ -21,6 +21,7 @@
 #include <linux/bcd.h>
 #include <linux/clk.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-sh.c linux-2.6.34-rc4/drivers/rtc/rtc-sh.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-sh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-sh.c	2010-04-13 02:19:01.372633717 +0000
@@ -26,6 +26,7 @@
 #include <linux/io.h>
 #include <linux/log2.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 #include <asm/rtc.h>
 
 #define DRV_NAME	"sh-rtc"
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-stk17ta8.c linux-2.6.34-rc4/drivers/rtc/rtc-stk17ta8.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-stk17ta8.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-stk17ta8.c	2010-04-13 02:19:01.372633717 +0000
@@ -14,6 +14,7 @@
 #include <linux/bcd.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <linux/jiffies.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-stmp3xxx.c linux-2.6.34-rc4/drivers/rtc/rtc-stmp3xxx.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-stmp3xxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-stmp3xxx.c	2010-04-13 02:19:01.372633717 +0000
@@ -22,6 +22,7 @@
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 
 #include <mach/platform.h>
 #include <mach/stmp3xxx.h>
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-tx4939.c linux-2.6.34-rc4/drivers/rtc/rtc-tx4939.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-tx4939.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-tx4939.c	2010-04-13 02:19:01.373633632 +0000
@@ -12,6 +12,7 @@
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 #include <asm/txx9/tx4939.h>
 
 struct tx4939rtc_plat_data {
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-v3020.c linux-2.6.34-rc4/drivers/rtc/rtc-v3020.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-v3020.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-v3020.c	2010-04-13 02:19:01.373633632 +0000
@@ -28,6 +28,7 @@
 #include <linux/rtc-v3020.h>
 #include <linux/delay.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/rtc/rtc-wm831x.c linux-2.6.34-rc4/drivers/rtc/rtc-wm831x.c
--- linux-2.6.34-rc3/drivers/rtc/rtc-wm831x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/rtc/rtc-wm831x.c	2010-04-13 02:19:01.373633632 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/time.h>
 #include <linux/rtc.h>
+#include <linux/slab.h>
 #include <linux/bcd.h>
 #include <linux/interrupt.h>
 #include <linux/ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_3990_erp.c linux-2.6.34-rc4/drivers/s390/block/dasd_3990_erp.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_3990_erp.c	2010-04-13 02:18:56.118633073 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_3990_erp.c	2010-04-13 02:19:01.374633162 +0000
@@ -10,7 +10,6 @@
 #define KMSG_COMPONENT "dasd-eckd"
 
 #include <linux/timer.h>
-#include <linux/slab.h>
 #include <asm/idals.h>
 
 #define PRINTK_HEADER "dasd_erp(3990): "
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_alias.c linux-2.6.34-rc4/drivers/s390/block/dasd_alias.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_alias.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_alias.c	2010-04-13 02:19:01.374633162 +0000
@@ -8,6 +8,7 @@
 #define KMSG_COMPONENT "dasd-eckd"
 
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <asm/ebcdic.h>
 #include "dasd_int.h"
 #include "dasd_eckd.h"
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_devmap.c linux-2.6.34-rc4/drivers/s390/block/dasd_devmap.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_devmap.c	2010-04-13 02:18:56.118633073 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_devmap.c	2010-04-13 02:19:01.374633162 +0000
@@ -18,6 +18,7 @@
 #include <linux/ctype.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <asm/debug.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_eer.c linux-2.6.34-rc4/drivers/s390/block/dasd_eer.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_eer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_eer.c	2010-04-13 02:19:01.375633037 +0000
@@ -19,6 +19,7 @@
 #include <linux/mutex.h>
 #include <linux/smp_lock.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_ioctl.c linux-2.6.34-rc4/drivers/s390/block/dasd_ioctl.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_ioctl.c	2010-04-13 02:18:56.119633106 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_ioctl.c	2010-04-13 02:19:01.376633012 +0000
@@ -17,6 +17,7 @@
 #include <linux/fs.h>
 #include <linux/blkpg.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <asm/compat.h>
 #include <asm/ccwdev.h>
 #include <asm/cmb.h>
diff -urN linux-2.6.34-rc3/drivers/s390/block/dasd_proc.c linux-2.6.34-rc4/drivers/s390/block/dasd_proc.c
--- linux-2.6.34-rc3/drivers/s390/block/dasd_proc.c	2010-04-13 02:18:56.119633106 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/dasd_proc.c	2010-04-13 02:19:01.376633012 +0000
@@ -14,6 +14,7 @@
 #define KMSG_COMPONENT "dasd"
 
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/seq_file.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/s390/block/xpram.c linux-2.6.34-rc4/drivers/s390/block/xpram.c
--- linux-2.6.34-rc3/drivers/s390/block/xpram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/block/xpram.c	2010-04-13 02:19:01.376633012 +0000
@@ -33,7 +33,6 @@
 #include <linux/ctype.h>  /* isdigit, isxdigit */
 #include <linux/errno.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/blkpg.h>
 #include <linux/hdreg.h>  /* HDIO_GETGEO */
@@ -41,6 +40,7 @@
 #include <linux/bio.h>
 #include <linux/suspend.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 
 #define XPRAM_NAME	"xpram"
diff -urN linux-2.6.34-rc3/drivers/s390/char/con3270.c linux-2.6.34-rc4/drivers/s390/char/con3270.c
--- linux-2.6.34-rc3/drivers/s390/char/con3270.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/con3270.c	2010-04-13 02:19:01.376633012 +0000
@@ -12,6 +12,7 @@
 #include <linux/interrupt.h>
 #include <linux/list.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/reboot.h>
 
diff -urN linux-2.6.34-rc3/drivers/s390/char/fs3270.c linux-2.6.34-rc4/drivers/s390/char/fs3270.c
--- linux-2.6.34-rc3/drivers/s390/char/fs3270.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/fs3270.c	2010-04-13 02:19:01.376633012 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/smp_lock.h>
 
diff -urN linux-2.6.34-rc3/drivers/s390/char/keyboard.c linux-2.6.34-rc4/drivers/s390/char/keyboard.c
--- linux-2.6.34-rc3/drivers/s390/char/keyboard.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/keyboard.c	2010-04-13 02:19:01.377633076 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/sysrq.h>
 
 #include <linux/consolemap.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/monreader.c linux-2.6.34-rc4/drivers/s390/char/monreader.c
--- linux-2.6.34-rc3/drivers/s390/char/monreader.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/monreader.c	2010-04-13 02:19:01.377633076 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/poll.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <net/iucv/iucv.h>
 #include <asm/uaccess.h>
 #include <asm/ebcdic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/monwriter.c linux-2.6.34-rc4/drivers/s390/char/monwriter.c
--- linux-2.6.34-rc3/drivers/s390/char/monwriter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/monwriter.c	2010-04-13 02:19:01.377633076 +0000
@@ -20,6 +20,7 @@
 #include <linux/poll.h>
 #include <linux/mutex.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/ebcdic.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/sclp_async.c linux-2.6.34-rc4/drivers/s390/char/sclp_async.c
--- linux-2.6.34-rc3/drivers/s390/char/sclp_async.c	2010-04-13 02:18:56.120633112 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/sclp_async.c	2010-04-13 02:19:01.377633076 +0000
@@ -11,6 +11,7 @@
 #include <linux/device.h>
 #include <linux/stat.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/kmod.h>
 #include <linux/err.h>
@@ -84,7 +85,7 @@
 		rc = copy_from_user(buf, buffer, sizeof(buf));
 		if (rc != 0)
 			return -EFAULT;
-		buf[len - 1] = '\0';
+		buf[sizeof(buf) - 1] = '\0';
 		if (strict_strtoul(buf, 0, &val) != 0)
 			return -EINVAL;
 		if (val != 0 && val != 1)
diff -urN linux-2.6.34-rc3/drivers/s390/char/sclp_con.c linux-2.6.34-rc4/drivers/s390/char/sclp_con.c
--- linux-2.6.34-rc3/drivers/s390/char/sclp_con.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/sclp_con.c	2010-04-13 02:19:01.378633047 +0000
@@ -14,6 +14,7 @@
 #include <linux/termios.h>
 #include <linux/err.h>
 #include <linux/reboot.h>
+#include <linux/gfp.h>
 
 #include "sclp.h"
 #include "sclp_rw.h"
diff -urN linux-2.6.34-rc3/drivers/s390/char/sclp_tty.c linux-2.6.34-rc4/drivers/s390/char/sclp_tty.c
--- linux-2.6.34-rc3/drivers/s390/char/sclp_tty.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/sclp_tty.c	2010-04-13 02:19:01.378633047 +0000
@@ -13,10 +13,10 @@
 #include <linux/tty.h>
 #include <linux/tty_driver.h>
 #include <linux/tty_flip.h>
-#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 
 #include "ctrlchar.h"
diff -urN linux-2.6.34-rc3/drivers/s390/char/sclp_vt220.c linux-2.6.34-rc4/drivers/s390/char/sclp_vt220.c
--- linux-2.6.34-rc3/drivers/s390/char/sclp_vt220.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/sclp_vt220.c	2010-04-13 02:19:01.378633047 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/reboot.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include "sclp.h"
diff -urN linux-2.6.34-rc3/drivers/s390/char/tape_34xx.c linux-2.6.34-rc4/drivers/s390/char/tape_34xx.c
--- linux-2.6.34-rc3/drivers/s390/char/tape_34xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/tape_34xx.c	2010-04-13 02:19:01.378633047 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/bio.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #define TAPE_DBF_AREA	tape_34xx_dbf
 
diff -urN linux-2.6.34-rc3/drivers/s390/char/tape_3590.c linux-2.6.34-rc4/drivers/s390/char/tape_3590.c
--- linux-2.6.34-rc3/drivers/s390/char/tape_3590.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/tape_3590.c	2010-04-13 02:19:01.378633047 +0000
@@ -12,6 +12,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/bio.h>
 #include <asm/ebcdic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/tape_class.c linux-2.6.34-rc4/drivers/s390/char/tape_class.c
--- linux-2.6.34-rc3/drivers/s390/char/tape_class.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/tape_class.c	2010-04-13 02:19:01.378633047 +0000
@@ -11,6 +11,8 @@
 #define KMSG_COMPONENT "tape"
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
+#include <linux/slab.h>
+
 #include "tape_class.h"
 
 MODULE_AUTHOR("Stefan Bader <shbader@de.ibm.com>");
diff -urN linux-2.6.34-rc3/drivers/s390/char/tape_core.c linux-2.6.34-rc4/drivers/s390/char/tape_core.c
--- linux-2.6.34-rc3/drivers/s390/char/tape_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/tape_core.c	2010-04-13 02:19:01.379633037 +0000
@@ -20,6 +20,7 @@
 #include <linux/spinlock.h>  // for locks
 #include <linux/vmalloc.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include <asm/types.h>	     // for variable types
 
diff -urN linux-2.6.34-rc3/drivers/s390/char/vmcp.c linux-2.6.34-rc4/drivers/s390/char/vmcp.c
--- linux-2.6.34-rc3/drivers/s390/char/vmcp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/vmcp.c	2010-04-13 02:19:01.379633037 +0000
@@ -19,6 +19,7 @@
 #include <linux/kernel.h>
 #include <linux/miscdevice.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/compat.h>
 #include <asm/cpcmd.h>
 #include <asm/debug.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/vmlogrdr.c linux-2.6.34-rc4/drivers/s390/char/vmlogrdr.c
--- linux-2.6.34-rc3/drivers/s390/char/vmlogrdr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/vmlogrdr.c	2010-04-13 02:19:01.379633037 +0000
@@ -16,6 +16,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/vmur.c linux-2.6.34-rc4/drivers/s390/char/vmur.c
--- linux-2.6.34-rc3/drivers/s390/char/vmur.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/vmur.c	2010-04-13 02:19:01.379633037 +0000
@@ -12,6 +12,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/cdev.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/s390/char/vmwatchdog.c linux-2.6.34-rc4/drivers/s390/char/vmwatchdog.c
--- linux-2.6.34-rc3/drivers/s390/char/vmwatchdog.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/vmwatchdog.c	2010-04-13 02:19:01.379633037 +0000
@@ -17,6 +17,7 @@
 #include <linux/miscdevice.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/suspend.h>
 #include <linux/watchdog.h>
 
diff -urN linux-2.6.34-rc3/drivers/s390/char/zcore.c linux-2.6.34-rc4/drivers/s390/char/zcore.c
--- linux-2.6.34-rc3/drivers/s390/char/zcore.c	2010-04-13 02:18:56.120633112 +0000
+++ linux-2.6.34-rc4/drivers/s390/char/zcore.c	2010-04-13 02:19:01.380633092 +0000
@@ -13,6 +13,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/miscdevice.h>
 #include <linux/debugfs.h>
 #include <asm/asm-offsets.h>
diff -urN linux-2.6.34-rc3/drivers/s390/cio/blacklist.c linux-2.6.34-rc4/drivers/s390/cio/blacklist.c
--- linux-2.6.34-rc3/drivers/s390/cio/blacklist.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/cio/blacklist.c	2010-04-13 02:19:01.380633092 +0000
@@ -14,7 +14,6 @@
 
 #include <linux/init.h>
 #include <linux/vmalloc.h>
-#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/drivers/s390/cio/chp.c linux-2.6.34-rc4/drivers/s390/cio/chp.c
--- linux-2.6.34-rc3/drivers/s390/cio/chp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/cio/chp.c	2010-04-13 02:19:01.380633092 +0000
@@ -15,6 +15,7 @@
 #include <linux/wait.h>
 #include <linux/mutex.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <asm/chpid.h>
 #include <asm/sclp.h>
 #include <asm/crw.h>
diff -urN linux-2.6.34-rc3/drivers/s390/cio/chsc_sch.c linux-2.6.34-rc4/drivers/s390/cio/chsc_sch.c
--- linux-2.6.34-rc3/drivers/s390/cio/chsc_sch.c	2010-04-13 02:18:56.121633039 +0000
+++ linux-2.6.34-rc4/drivers/s390/cio/chsc_sch.c	2010-04-13 02:19:01.380633092 +0000
@@ -7,6 +7,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/s390/cio/qdio_main.c linux-2.6.34-rc4/drivers/s390/cio/qdio_main.c
--- linux-2.6.34-rc3/drivers/s390/cio/qdio_main.c	2010-04-13 02:18:56.123633090 +0000
+++ linux-2.6.34-rc4/drivers/s390/cio/qdio_main.c	2010-04-13 02:19:01.382633230 +0000
@@ -13,6 +13,7 @@
 #include <linux/kernel.h>
 #include <linux/timer.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <asm/atomic.h>
 #include <asm/debug.h>
 #include <asm/qdio.h>
diff -urN linux-2.6.34-rc3/drivers/s390/cio/qdio_thinint.c linux-2.6.34-rc4/drivers/s390/cio/qdio_thinint.c
--- linux-2.6.34-rc3/drivers/s390/cio/qdio_thinint.c	2010-04-13 02:18:56.123633090 +0000
+++ linux-2.6.34-rc4/drivers/s390/cio/qdio_thinint.c	2010-04-13 02:19:01.383633630 +0000
@@ -7,6 +7,7 @@
  *	      Jan Glauber <jang@linux.vnet.ibm.com>
  */
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/debug.h>
 #include <asm/qdio.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/ap_bus.c linux-2.6.34-rc4/drivers/s390/crypto/ap_bus.c
--- linux-2.6.34-rc3/drivers/s390/crypto/ap_bus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/ap_bus.c	2010-04-13 02:19:01.383633630 +0000
@@ -33,6 +33,7 @@
 #include <linux/err.h>
 #include <linux/interrupt.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include <linux/notifier.h>
 #include <linux/kthread.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_api.c linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_api.c
--- linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_api.c	2010-04-13 02:18:56.123633090 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_api.c	2010-04-13 02:19:01.383633630 +0000
@@ -36,6 +36,7 @@
 #include <linux/seq_file.h>
 #include <linux/compat.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/uaccess.h>
 #include <linux/hw_random.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_cex2a.c linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_cex2a.c
--- linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_cex2a.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_cex2a.c	2010-04-13 02:19:01.383633630 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/err.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcica.c linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcica.c
--- linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcica.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcica.c	2010-04-13 02:19:01.384633070 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/err.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcicc.c linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcicc.c
--- linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcicc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcicc.c	2010-04-13 02:19:01.384633070 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/err.h>
 #include <asm/atomic.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcixcc.c linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcixcc.c
--- linux-2.6.34-rc3/drivers/s390/crypto/zcrypt_pcixcc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/crypto/zcrypt_pcixcc.c	2010-04-13 02:19:01.384633070 +0000
@@ -30,6 +30,7 @@
 #include <linux/init.h>
 #include <linux/err.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/s390/kvm/kvm_virtio.c linux-2.6.34-rc4/drivers/s390/kvm/kvm_virtio.c
--- linux-2.6.34-rc3/drivers/s390/kvm/kvm_virtio.c	2010-04-13 02:18:56.123633090 +0000
+++ linux-2.6.34-rc4/drivers/s390/kvm/kvm_virtio.c	2010-04-13 02:19:01.384633070 +0000
@@ -15,6 +15,7 @@
 #include <linux/err.h>
 #include <linux/virtio.h>
 #include <linux/virtio_config.h>
+#include <linux/slab.h>
 #include <linux/virtio_console.h>
 #include <linux/interrupt.h>
 #include <linux/virtio_ring.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/ctcm_dbug.c linux-2.6.34-rc4/drivers/s390/net/ctcm_dbug.c
--- linux-2.6.34-rc3/drivers/s390/net/ctcm_dbug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/ctcm_dbug.c	2010-04-13 02:19:01.384633070 +0000
@@ -10,7 +10,6 @@
 #include <linux/string.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/sysctl.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/ctcm_sysfs.c linux-2.6.34-rc4/drivers/s390/net/ctcm_sysfs.c
--- linux-2.6.34-rc3/drivers/s390/net/ctcm_sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/ctcm_sysfs.c	2010-04-13 02:19:01.384633070 +0000
@@ -14,6 +14,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 #include "ctcm_main.h"
 
 /*
diff -urN linux-2.6.34-rc3/drivers/s390/net/fsm.c linux-2.6.34-rc4/drivers/s390/net/fsm.c
--- linux-2.6.34-rc3/drivers/s390/net/fsm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/fsm.c	2010-04-13 02:19:01.384633070 +0000
@@ -5,6 +5,7 @@
 
 #include "fsm.h"
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 
 MODULE_AUTHOR("(C) 2000 IBM Corp. by Fritz Elfert (felfert@millenux.com)");
diff -urN linux-2.6.34-rc3/drivers/s390/net/lcs.c linux-2.6.34-rc4/drivers/s390/net/lcs.c
--- linux-2.6.34-rc3/drivers/s390/net/lcs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/lcs.c	2010-04-13 02:19:01.385633090 +0000
@@ -37,6 +37,7 @@
 #include <linux/igmp.h>
 #include <linux/delay.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/ip.h>
 
diff -urN linux-2.6.34-rc3/drivers/s390/net/qeth_core_main.c linux-2.6.34-rc4/drivers/s390/net/qeth_core_main.c
--- linux-2.6.34-rc3/drivers/s390/net/qeth_core_main.c	2010-04-13 02:18:56.124633023 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/qeth_core_main.c	2010-04-13 02:19:01.386633067 +0000
@@ -20,6 +20,7 @@
 #include <linux/tcp.h>
 #include <linux/mii.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include <asm/ebcdic.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/qeth_l2_main.c linux-2.6.34-rc4/drivers/s390/net/qeth_l2_main.c
--- linux-2.6.34-rc3/drivers/s390/net/qeth_l2_main.c	2010-04-13 02:18:56.125633119 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/qeth_l2_main.c	2010-04-13 02:19:01.386633067 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/etherdevice.h>
 #include <linux/mii.h>
 #include <linux/ip.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/qeth_l3_main.c linux-2.6.34-rc4/drivers/s390/net/qeth_l3_main.c
--- linux-2.6.34-rc3/drivers/s390/net/qeth_l3_main.c	2010-04-13 02:18:56.126633029 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/qeth_l3_main.c	2010-04-13 02:19:01.387633293 +0000
@@ -22,6 +22,7 @@
 #include <linux/ipv6.h>
 #include <linux/inetdevice.h>
 #include <linux/igmp.h>
+#include <linux/slab.h>
 
 #include <net/ip.h>
 #include <net/arp.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/qeth_l3_sys.c linux-2.6.34-rc4/drivers/s390/net/qeth_l3_sys.c
--- linux-2.6.34-rc3/drivers/s390/net/qeth_l3_sys.c	2010-04-13 02:18:56.126633029 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/qeth_l3_sys.c	2010-04-13 02:19:01.387633293 +0000
@@ -8,6 +8,8 @@
  *		 Frank Blaschka <frank.blaschka@de.ibm.com>
  */
 
+#include <linux/slab.h>
+
 #include "qeth_l3.h"
 
 #define QETH_DEVICE_ATTR(_id, _name, _mode, _show, _store) \
diff -urN linux-2.6.34-rc3/drivers/s390/net/smsgiucv.c linux-2.6.34-rc4/drivers/s390/net/smsgiucv.c
--- linux-2.6.34-rc3/drivers/s390/net/smsgiucv.c	2010-04-13 02:18:56.126633029 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/smsgiucv.c	2010-04-13 02:19:01.388633048 +0000
@@ -24,6 +24,7 @@
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <net/iucv/iucv.h>
 #include <asm/cpcmd.h>
 #include <asm/ebcdic.h>
diff -urN linux-2.6.34-rc3/drivers/s390/net/smsgiucv_app.c linux-2.6.34-rc4/drivers/s390/net/smsgiucv_app.c
--- linux-2.6.34-rc3/drivers/s390/net/smsgiucv_app.c	2010-04-13 02:18:56.126633029 +0000
+++ linux-2.6.34-rc4/drivers/s390/net/smsgiucv_app.c	2010-04-13 02:19:01.388633048 +0000
@@ -18,6 +18,7 @@
 #include <linux/list.h>
 #include <linux/kobject.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/workqueue.h>
 #include <net/iucv/iucv.h>
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_aux.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_aux.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_aux.c	2010-04-13 02:18:56.127633017 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_aux.c	2010-04-13 02:19:01.388633048 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/miscdevice.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "zfcp_ext.h"
 #include "zfcp_fc.h"
 #include "zfcp_reqlist.h"
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_cfdc.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_cfdc.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_cfdc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_cfdc.c	2010-04-13 02:19:01.388633048 +0000
@@ -10,6 +10,7 @@
 #define KMSG_COMPONENT "zfcp"
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/miscdevice.h>
 #include <asm/compat.h>
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_dbf.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_dbf.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_dbf.c	2010-04-13 02:18:56.127633017 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_dbf.c	2010-04-13 02:19:01.389574470 +0000
@@ -10,6 +10,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <asm/debug.h>
 #include "zfcp_dbf.h"
 #include "zfcp_ext.h"
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_fc.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_fc.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_fc.c	2010-04-13 02:18:56.128633055 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_fc.c	2010-04-13 02:19:01.390633261 +0000
@@ -10,6 +10,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <scsi/fc/fc_els.h>
 #include <scsi/libfc.h>
 #include "zfcp_ext.h"
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_fsf.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_fsf.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_fsf.c	2010-04-13 02:18:56.129571682 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_fsf.c	2010-04-13 02:19:01.390633261 +0000
@@ -10,6 +10,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/blktrace_api.h>
+#include <linux/slab.h>
 #include <scsi/fc/fc_els.h>
 #include "zfcp_ext.h"
 #include "zfcp_fc.h"
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_qdio.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_qdio.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_qdio.c	2010-04-13 02:18:56.129571682 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_qdio.c	2010-04-13 02:19:01.390633261 +0000
@@ -9,6 +9,7 @@
 #define KMSG_COMPONENT "zfcp"
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
+#include <linux/slab.h>
 #include "zfcp_ext.h"
 #include "zfcp_qdio.h"
 
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_scsi.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_scsi.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_scsi.c	2010-04-13 02:18:56.129571682 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_scsi.c	2010-04-13 02:19:01.391633049 +0000
@@ -10,6 +10,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <scsi/fc/fc_fcp.h>
 #include <asm/atomic.h>
 #include "zfcp_ext.h"
diff -urN linux-2.6.34-rc3/drivers/s390/scsi/zfcp_sysfs.c linux-2.6.34-rc4/drivers/s390/scsi/zfcp_sysfs.c
--- linux-2.6.34-rc3/drivers/s390/scsi/zfcp_sysfs.c	2010-04-13 02:18:56.129571682 +0000
+++ linux-2.6.34-rc4/drivers/s390/scsi/zfcp_sysfs.c	2010-04-13 02:19:01.391633049 +0000
@@ -9,6 +9,7 @@
 #define KMSG_COMPONENT "zfcp"
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
+#include <linux/slab.h>
 #include "zfcp_ext.h"
 
 #define ZFCP_DEV_ATTR(_feat, _name, _mode, _show, _store) \
diff -urN linux-2.6.34-rc3/drivers/sbus/char/bbc_envctrl.c linux-2.6.34-rc4/drivers/sbus/char/bbc_envctrl.c
--- linux-2.6.34-rc3/drivers/sbus/char/bbc_envctrl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sbus/char/bbc_envctrl.c	2010-04-13 02:19:01.391633049 +0000
@@ -8,6 +8,7 @@
 #include <linux/kmod.h>
 #include <linux/reboot.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 #include <linux/of_device.h>
 #include <asm/oplib.h>
 
diff -urN linux-2.6.34-rc3/drivers/sbus/char/display7seg.c linux-2.6.34-rc4/drivers/sbus/char/display7seg.c
--- linux-2.6.34-rc3/drivers/sbus/char/display7seg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sbus/char/display7seg.c	2010-04-13 02:19:01.391633049 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/miscdevice.h>
 #include <linux/ioport.h>		/* request_region */
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/drivers/sbus/char/envctrl.c linux-2.6.34-rc4/drivers/sbus/char/envctrl.c
--- linux-2.6.34-rc3/drivers/sbus/char/envctrl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sbus/char/envctrl.c	2010-04-13 02:19:01.392633577 +0000
@@ -26,6 +26,7 @@
 #include <linux/miscdevice.h>
 #include <linux/kmod.h>
 #include <linux/reboot.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/drivers/sbus/char/flash.c linux-2.6.34-rc4/drivers/sbus/char/flash.c
--- linux-2.6.34-rc3/drivers/sbus/char/flash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sbus/char/flash.c	2010-04-13 02:19:01.392633577 +0000
@@ -7,7 +7,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/miscdevice.h>
-#include <linux/slab.h>
 #include <linux/fcntl.h>
 #include <linux/poll.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/sbus/char/jsflash.c linux-2.6.34-rc4/drivers/sbus/char/jsflash.c
--- linux-2.6.34-rc3/drivers/sbus/char/jsflash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sbus/char/jsflash.c	2010-04-13 02:19:01.392633577 +0000
@@ -31,7 +31,6 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/miscdevice.h>
-#include <linux/slab.h>
 #include <linux/fcntl.h>
 #include <linux/poll.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/3w-9xxx.c linux-2.6.34-rc4/drivers/scsi/3w-9xxx.c
--- linux-2.6.34-rc3/drivers/scsi/3w-9xxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/3w-9xxx.c	2010-04-13 02:19:01.392633577 +0000
@@ -91,6 +91,7 @@
 #include <linux/time.h>
 #include <linux/mutex.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/3w-sas.c linux-2.6.34-rc4/drivers/scsi/3w-sas.c
--- linux-2.6.34-rc3/drivers/scsi/3w-sas.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/3w-sas.c	2010-04-13 02:19:01.393633179 +0000
@@ -65,6 +65,7 @@
 #include <linux/time.h>
 #include <linux/mutex.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/3w-xxxx.c linux-2.6.34-rc4/drivers/scsi/3w-xxxx.c
--- linux-2.6.34-rc3/drivers/scsi/3w-xxxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/3w-xxxx.c	2010-04-13 02:19:01.393633179 +0000
@@ -205,6 +205,7 @@
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/time.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/53c700.c linux-2.6.34-rc4/drivers/scsi/53c700.c
--- linux-2.6.34-rc3/drivers/scsi/53c700.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/53c700.c	2010-04-13 02:19:01.393633179 +0000
@@ -117,6 +117,7 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/BusLogic.c linux-2.6.34-rc4/drivers/scsi/BusLogic.c
--- linux-2.6.34-rc3/drivers/scsi/BusLogic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/BusLogic.c	2010-04-13 02:19:01.394633476 +0000
@@ -42,6 +42,7 @@
 #include <linux/spinlock.h>
 #include <linux/jiffies.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <scsi/scsicam.h>
 
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/NCR_D700.c linux-2.6.34-rc4/drivers/scsi/NCR_D700.c
--- linux-2.6.34-rc3/drivers/scsi/NCR_D700.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/NCR_D700.c	2010-04-13 02:19:01.395633813 +0000
@@ -97,6 +97,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/mca.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/NCR_Q720.c linux-2.6.34-rc4/drivers/scsi/NCR_Q720.c
--- linux-2.6.34-rc3/drivers/scsi/NCR_Q720.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/NCR_Q720.c	2010-04-13 02:19:01.396633232 +0000
@@ -10,6 +10,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/mca.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/init.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/a100u2w.c linux-2.6.34-rc4/drivers/scsi/a100u2w.c
--- linux-2.6.34-rc3/drivers/scsi/a100u2w.c	2010-04-13 02:18:56.131633037 +0000
+++ linux-2.6.34-rc4/drivers/scsi/a100u2w.c	2010-04-13 02:19:01.396633232 +0000
@@ -69,7 +69,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/a2091.c linux-2.6.34-rc4/drivers/scsi/a2091.c
--- linux-2.6.34-rc3/drivers/scsi/a2091.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/a2091.c	2010-04-13 02:19:01.396633232 +0000
@@ -1,5 +1,6 @@
 #include <linux/types.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/a3000.c linux-2.6.34-rc4/drivers/scsi/a3000.c
--- linux-2.6.34-rc3/drivers/scsi/a3000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/a3000.c	2010-04-13 02:19:01.396633232 +0000
@@ -1,5 +1,6 @@
 #include <linux/types.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/a4000t.c linux-2.6.34-rc4/drivers/scsi/a4000t.c
--- linux-2.6.34-rc3/drivers/scsi/a4000t.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/a4000t.c	2010-04-13 02:19:01.396633232 +0000
@@ -12,6 +12,7 @@
 #include <linux/platform_device.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/amigahw.h>
 #include <asm/amigaints.h>
 #include <scsi/scsi_host.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aacraid/rx.c linux-2.6.34-rc4/drivers/scsi/aacraid/rx.c
--- linux-2.6.34-rc3/drivers/scsi/aacraid/rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aacraid/rx.c	2010-04-13 02:19:01.396633232 +0000
@@ -33,7 +33,6 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/spinlock.h>
-#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/completion.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aacraid/sa.c linux-2.6.34-rc4/drivers/scsi/aacraid/sa.c
--- linux-2.6.34-rc3/drivers/scsi/aacraid/sa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aacraid/sa.c	2010-04-13 02:19:01.396633232 +0000
@@ -33,7 +33,6 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/spinlock.h>
-#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/delay.h>
 #include <linux/completion.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/advansys.c linux-2.6.34-rc4/drivers/scsi/advansys.c
--- linux-2.6.34-rc3/drivers/scsi/advansys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/advansys.c	2010-04-13 02:19:01.398633068 +0000
@@ -4781,12 +4781,14 @@
 	if (err) {
 		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
 		       fwname, err);
+		asc_dvc->err_code |= ASC_IERR_MCODE_CHKSUM;
 		return err;
 	}
 	if (fw->size < 4) {
 		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
 		       fw->size, fwname);
 		release_firmware(fw);
+		asc_dvc->err_code |= ASC_IERR_MCODE_CHKSUM;
 		return -EINVAL;
 	}
 	chksum = (fw->data[3] << 24) | (fw->data[2] << 16) |
@@ -5110,12 +5112,14 @@
 	if (err) {
 		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
 		       fwname, err);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return err;
 	}
 	if (fw->size < 4) {
 		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
 		       fw->size, fwname);
 		release_firmware(fw);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return -EINVAL;
 	}
 	chksum = (fw->data[3] << 24) | (fw->data[2] << 16) |
@@ -5624,12 +5628,14 @@
 	if (err) {
 		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
 		       fwname, err);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return err;
 	}
 	if (fw->size < 4) {
 		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
 		       fw->size, fwname);
 		release_firmware(fw);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return -EINVAL;
 	}
 	chksum = (fw->data[3] << 24) | (fw->data[2] << 16) |
@@ -6124,12 +6130,14 @@
 	if (err) {
 		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
 		       fwname, err);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return err;
 	}
 	if (fw->size < 4) {
 		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
 		       fw->size, fwname);
 		release_firmware(fw);
+		asc_dvc->err_code = ASC_IERR_MCODE_CHKSUM;
 		return -EINVAL;
 	}
 	chksum = (fw->data[3] << 24) | (fw->data[2] << 16) |
diff -urN linux-2.6.34-rc3/drivers/scsi/aha152x.c linux-2.6.34-rc4/drivers/scsi/aha152x.c
--- linux-2.6.34-rc3/drivers/scsi/aha152x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aha152x.c	2010-04-13 02:19:01.398633068 +0000
@@ -254,6 +254,7 @@
 #include <linux/spinlock.h>
 #include <linux/workqueue.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <scsi/scsicam.h>
 
 #include "scsi.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/aha1542.c linux-2.6.34-rc4/drivers/scsi/aha1542.c
--- linux-2.6.34-rc3/drivers/scsi/aha1542.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aha1542.c	2010-04-13 02:19:01.399633284 +0000
@@ -39,6 +39,7 @@
 #include <linux/blkdev.h>
 #include <linux/mca.h>
 #include <linux/mca-legacy.h>
+#include <linux/slab.h>
 
 #include <asm/dma.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aha1740.c linux-2.6.34-rc4/drivers/scsi/aha1740.c
--- linux-2.6.34-rc3/drivers/scsi/aha1740.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aha1740.c	2010-04-13 02:19:01.399633284 +0000
@@ -50,6 +50,7 @@
 #include <linux/device.h>
 #include <linux/eisa.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <asm/dma.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aic7xxx/aic79xx_osm.c linux-2.6.34-rc4/drivers/scsi/aic7xxx/aic79xx_osm.c
--- linux-2.6.34-rc3/drivers/scsi/aic7xxx/aic79xx_osm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic7xxx/aic79xx_osm.c	2010-04-13 02:19:01.399633284 +0000
@@ -53,6 +53,7 @@
 #include <linux/blkdev.h>		/* For block_size() */
 #include <linux/delay.h>	/* For ssleep/msleep */
 #include <linux/device.h>
+#include <linux/slab.h>
 
 /*
  * Bucket size for counting good commands in between bad ones.
diff -urN linux-2.6.34-rc3/drivers/scsi/aic7xxx/aic7xxx_osm.c linux-2.6.34-rc4/drivers/scsi/aic7xxx/aic7xxx_osm.c
--- linux-2.6.34-rc3/drivers/scsi/aic7xxx/aic7xxx_osm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic7xxx/aic7xxx_osm.c	2010-04-13 02:19:01.400570979 +0000
@@ -129,6 +129,7 @@
 #include <linux/mm.h>		/* For fetching system memory size */
 #include <linux/blkdev.h>		/* For block_size() */
 #include <linux/delay.h>	/* For ssleep/msleep */
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_hwi.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_hwi.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_hwi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_hwi.c	2010-04-13 02:19:01.400570979 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/module.h>
 #include <linux/firmware.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_init.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_init.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_init.c	2010-04-13 02:19:01.400570979 +0000
@@ -30,6 +30,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_host.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_scb.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_scb.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_scb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_scb.c	2010-04-13 02:19:01.400570979 +0000
@@ -24,6 +24,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <scsi/scsi_host.h>
 
 #include "aic94xx.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_sds.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_sds.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_sds.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_sds.c	2010-04-13 02:19:01.401570170 +0000
@@ -26,6 +26,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "aic94xx.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_seq.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_seq.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_seq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_seq.c	2010-04-13 02:19:01.401570170 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/module.h>
 #include <linux/firmware.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_tmf.c linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_tmf.c
--- linux-2.6.34-rc3/drivers/scsi/aic94xx/aic94xx_tmf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/aic94xx/aic94xx_tmf.c	2010-04-13 02:19:01.401570170 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/spinlock.h>
+#include <linux/gfp.h>
 #include "aic94xx.h"
 #include "aic94xx_sas.h"
 #include "aic94xx_hwi.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/arcmsr/arcmsr_hba.c linux-2.6.34-rc4/drivers/scsi/arcmsr/arcmsr_hba.c
--- linux-2.6.34-rc3/drivers/scsi/arcmsr/arcmsr_hba.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/arcmsr/arcmsr_hba.c	2010-04-13 02:19:01.401570170 +0000
@@ -58,6 +58,7 @@
 #include <linux/timer.h>
 #include <linux/pci.h>
 #include <linux/aer.h>
+#include <linux/slab.h>
 #include <asm/dma.h>
 #include <asm/io.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/atari_NCR5380.c linux-2.6.34-rc4/drivers/scsi/atari_NCR5380.c
--- linux-2.6.34-rc3/drivers/scsi/atari_NCR5380.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/atari_NCR5380.c	2010-04-13 02:19:01.402570149 +0000
@@ -651,6 +651,7 @@
  * interrupt or bottom half.
  */
 
+#include <linux/gfp.h>
 #include <linux/workqueue.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/atp870u.c linux-2.6.34-rc4/drivers/scsi/atp870u.c
--- linux-2.6.34-rc3/drivers/scsi/atp870u.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/atp870u.c	2010-04-13 02:19:01.402570149 +0000
@@ -29,6 +29,7 @@
 #include <linux/pci.h>
 #include <linux/blkdev.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/be2iscsi/be_main.c linux-2.6.34-rc4/drivers/scsi/be2iscsi/be_main.c
--- linux-2.6.34-rc3/drivers/scsi/be2iscsi/be_main.c	2010-04-13 02:18:56.133633048 +0000
+++ linux-2.6.34-rc4/drivers/scsi/be2iscsi/be_main.c	2010-04-13 02:19:01.404633026 +0000
@@ -19,6 +19,7 @@
  */
 #include <linux/reboot.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/blkdev.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/bfa/bfad.c linux-2.6.34-rc4/drivers/scsi/bfa/bfad.c
--- linux-2.6.34-rc3/drivers/scsi/bfa/bfad.c	2010-04-13 02:18:56.140570470 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bfa/bfad.c	2010-04-13 02:19:01.411570527 +0000
@@ -19,6 +19,7 @@
  *  bfad.c Linux driver PCI interface module.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kthread.h>
 #include "bfad_drv.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bfa/bfad_attr.c linux-2.6.34-rc4/drivers/scsi/bfa/bfad_attr.c
--- linux-2.6.34-rc3/drivers/scsi/bfa/bfad_attr.c	2010-04-13 02:18:56.140570470 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bfa/bfad_attr.c	2010-04-13 02:19:01.412570695 +0000
@@ -19,6 +19,7 @@
  *  bfa_attr.c Linux driver configuration interface module.
  */
 
+#include <linux/slab.h>
 #include "bfad_drv.h"
 #include "bfad_im.h"
 #include "bfad_trcmod.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bfa/bfad_im.c linux-2.6.34-rc4/drivers/scsi/bfa/bfad_im.c
--- linux-2.6.34-rc3/drivers/scsi/bfa/bfad_im.c	2010-04-13 02:18:56.140570470 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bfa/bfad_im.c	2010-04-13 02:19:01.412570695 +0000
@@ -19,6 +19,7 @@
  *  bfad_im.c Linux driver IM module.
  */
 
+#include <linux/slab.h>
 #include "bfad_drv.h"
 #include "bfad_im.h"
 #include "bfad_trcmod.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bfa/rport.c linux-2.6.34-rc4/drivers/scsi/bfa/rport.c
--- linux-2.6.34-rc3/drivers/scsi/bfa/rport.c	2010-04-13 02:18:56.148633020 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bfa/rport.c	2010-04-13 02:19:01.421633238 +0000
@@ -19,6 +19,7 @@
  *  rport.c Remote port implementation.
  */
 
+#include <linux/slab.h>
 #include <bfa.h>
 #include <bfa_svc.h>
 #include "fcbuild.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bnx2i/bnx2i_hwi.c linux-2.6.34-rc4/drivers/scsi/bnx2i/bnx2i_hwi.c
--- linux-2.6.34-rc3/drivers/scsi/bnx2i/bnx2i_hwi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bnx2i/bnx2i_hwi.c	2010-04-13 02:19:01.422633067 +0000
@@ -11,6 +11,7 @@
  * Written by: Anil Veerabhadrappa (anilgv@broadcom.com)
  */
 
+#include <linux/gfp.h>
 #include <scsi/scsi_tcq.h>
 #include <scsi/libiscsi.h>
 #include "bnx2i.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bnx2i/bnx2i_iscsi.c linux-2.6.34-rc4/drivers/scsi/bnx2i/bnx2i_iscsi.c
--- linux-2.6.34-rc3/drivers/scsi/bnx2i/bnx2i_iscsi.c	2010-04-13 02:18:56.149571614 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bnx2i/bnx2i_iscsi.c	2010-04-13 02:19:01.422633067 +0000
@@ -12,6 +12,7 @@
  * Written by: Anil Veerabhadrappa (anilgv@broadcom.com)
  */
 
+#include <linux/slab.h>
 #include <scsi/scsi_tcq.h>
 #include <scsi/libiscsi.h>
 #include "bnx2i.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/bvme6000_scsi.c linux-2.6.34-rc4/drivers/scsi/bvme6000_scsi.c
--- linux-2.6.34-rc3/drivers/scsi/bvme6000_scsi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/bvme6000_scsi.c	2010-04-13 02:19:01.422633067 +0000
@@ -12,6 +12,7 @@
 #include <linux/platform_device.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/bvme6000hw.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ch.c linux-2.6.34-rc4/drivers/scsi/ch.c
--- linux-2.6.34-rc3/drivers/scsi/ch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ch.c	2010-04-13 02:19:01.422633067 +0000
@@ -23,6 +23,7 @@
 #include <linux/mutex.h>
 #include <linux/idr.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_ddp.c linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_ddp.c
--- linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_ddp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_ddp.c	2010-04-13 02:19:01.423633076 +0000
@@ -10,6 +10,7 @@
  * Written by: Karen Xie (kxie@chelsio.com)
  */
 
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/scatterlist.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_ddp.h linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_ddp.h
--- linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_ddp.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_ddp.h	2010-04-13 02:19:01.423633076 +0000
@@ -13,6 +13,7 @@
 #ifndef __CXGB3I_ULP2_DDP_H__
 #define __CXGB3I_ULP2_DDP_H__
 
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 /**
diff -urN linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_iscsi.c linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_iscsi.c
--- linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_iscsi.c	2010-04-13 02:18:56.149571614 +0000
+++ linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_iscsi.c	2010-04-13 02:19:01.423633076 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <linux/crypto.h>
 #include <linux/if_vlan.h>
 #include <net/dst.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_offload.c linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_offload.c
--- linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_offload.c	2010-04-13 02:18:56.150570510 +0000
+++ linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_offload.c	2010-04-13 02:19:01.423633076 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 
 #include "cxgb3_defs.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_pdu.c linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_pdu.c
--- linux-2.6.34-rc3/drivers/scsi/cxgb3i/cxgb3i_pdu.c	2010-04-13 02:18:56.150570510 +0000
+++ linux-2.6.34-rc4/drivers/scsi/cxgb3i/cxgb3i_pdu.c	2010-04-13 02:19:01.423633076 +0000
@@ -12,6 +12,7 @@
  * Written by: Karen Xie (kxie@chelsio.com)
  */
 
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/crypto.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/dc395x.c linux-2.6.34-rc4/drivers/scsi/dc395x.c
--- linux-2.6.34-rc3/drivers/scsi/dc395x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/dc395x.c	2010-04-13 02:19:01.424633192 +0000
@@ -57,6 +57,7 @@
 #include <linux/pci.h>
 #include <linux/list.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh.c linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh.c
--- linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh.c	2010-04-13 02:19:01.424633192 +0000
@@ -21,6 +21,7 @@
  *               Mike Anderson <andmike@linux.vnet.ibm.com>
  */
 
+#include <linux/slab.h>
 #include <scsi/scsi_dh.h>
 #include "../scsi_priv.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_alua.c linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_alua.c
--- linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_alua.c	2010-04-13 02:18:56.150570510 +0000
+++ linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_alua.c	2010-04-13 02:19:01.424633192 +0000
@@ -19,6 +19,7 @@
  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  *
  */
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_eh.h>
 #include <scsi/scsi_dh.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_emc.c linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_emc.c
--- linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_emc.c	2010-04-13 02:18:56.150570510 +0000
+++ linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_emc.c	2010-04-13 02:19:01.425633090 +0000
@@ -20,6 +20,7 @@
  * along with this program; see the file COPYING.  If not, write to
  * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
  */
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_eh.h>
 #include <scsi/scsi_dh.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_hp_sw.c linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_hp_sw.c
--- linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_hp_sw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_hp_sw.c	2010-04-13 02:19:01.425633090 +0000
@@ -21,6 +21,7 @@
  * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_dbg.h>
 #include <scsi/scsi_eh.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_rdac.c linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_rdac.c
--- linux-2.6.34-rc3/drivers/scsi/device_handler/scsi_dh_rdac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/device_handler/scsi_dh_rdac.c	2010-04-13 02:19:01.425633090 +0000
@@ -23,6 +23,7 @@
 #include <scsi/scsi_eh.h>
 #include <scsi/scsi_dh.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #define RDAC_NAME "rdac"
 #define RDAC_RETRY_COUNT 5
diff -urN linux-2.6.34-rc3/drivers/scsi/eata.c linux-2.6.34-rc4/drivers/scsi/eata.c
--- linux-2.6.34-rc3/drivers/scsi/eata.c	2010-04-13 02:18:56.150570510 +0000
+++ linux-2.6.34-rc4/drivers/scsi/eata.c	2010-04-13 02:19:01.425633090 +0000
@@ -490,6 +490,7 @@
 #include <linux/ctype.h>
 #include <linux/spinlock.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include <asm/dma.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/eata_pio.c linux-2.6.34-rc4/drivers/scsi/eata_pio.c
--- linux-2.6.34-rc3/drivers/scsi/eata_pio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/eata_pio.c	2010-04-13 02:19:01.425633090 +0000
@@ -50,7 +50,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/ioport.h>
-#include <linux/slab.h>
 #include <linux/in.h>
 #include <linux/pci.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fcoe/fcoe.c linux-2.6.34-rc4/drivers/scsi/fcoe/fcoe.c
--- linux-2.6.34-rc3/drivers/scsi/fcoe/fcoe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fcoe/fcoe.c	2010-04-13 02:19:01.426633060 +0000
@@ -26,6 +26,7 @@
 #include <linux/if_ether.h>
 #include <linux/if_vlan.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <linux/cpu.h>
 #include <linux/fs.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fcoe/libfcoe.c linux-2.6.34-rc4/drivers/scsi/fcoe/libfcoe.c
--- linux-2.6.34-rc3/drivers/scsi/fcoe/libfcoe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fcoe/libfcoe.c	2010-04-13 02:19:01.426633060 +0000
@@ -31,6 +31,7 @@
 #include <linux/if_vlan.h>
 #include <linux/errno.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <net/rtnetlink.h>
 
 #include <scsi/fc/fc_els.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fd_mcs.c linux-2.6.34-rc4/drivers/scsi/fd_mcs.c
--- linux-2.6.34-rc3/drivers/scsi/fd_mcs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fd_mcs.c	2010-04-13 02:19:01.427633057 +0000
@@ -88,6 +88,7 @@
 #include <linux/delay.h>
 #include <linux/mca.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <scsi/scsicam.h>
 #include <linux/mca-legacy.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/fdomain.c linux-2.6.34-rc4/drivers/scsi/fdomain.c
--- linux-2.6.34-rc3/drivers/scsi/fdomain.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fdomain.c	2010-04-13 02:19:01.427633057 +0000
@@ -279,6 +279,7 @@
 #include <linux/stat.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <scsi/scsicam.h>
 
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/fnic_fcs.c linux-2.6.34-rc4/drivers/scsi/fnic/fnic_fcs.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/fnic_fcs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/fnic_fcs.c	2010-04-13 02:19:01.427633057 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/errno.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/fnic_main.c linux-2.6.34-rc4/drivers/scsi/fnic/fnic_main.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/fnic_main.c	2010-04-13 02:18:56.151633040 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/fnic_main.c	2010-04-13 02:19:01.427633057 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/mempool.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/fnic_scsi.c linux-2.6.34-rc4/drivers/scsi/fnic/fnic_scsi.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/fnic_scsi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/fnic_scsi.c	2010-04-13 02:19:01.428633068 +0000
@@ -26,6 +26,7 @@
 #include <linux/if_ether.h>
 #include <linux/if_vlan.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/vnic_dev.c linux-2.6.34-rc4/drivers/scsi/fnic/vnic_dev.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/vnic_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/vnic_dev.c	2010-04-13 02:19:01.428633068 +0000
@@ -22,6 +22,7 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 #include "vnic_resource.h"
 #include "vnic_devcmd.h"
 #include "vnic_dev.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/vnic_rq.c linux-2.6.34-rc4/drivers/scsi/fnic/vnic_rq.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/vnic_rq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/vnic_rq.c	2010-04-13 02:19:01.428633068 +0000
@@ -20,6 +20,7 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "vnic_dev.h"
 #include "vnic_rq.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/fnic/vnic_wq.c linux-2.6.34-rc4/drivers/scsi/fnic/vnic_wq.c
--- linux-2.6.34-rc3/drivers/scsi/fnic/vnic_wq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/fnic/vnic_wq.c	2010-04-13 02:19:01.428633068 +0000
@@ -20,6 +20,7 @@
 #include <linux/types.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include "vnic_dev.h"
 #include "vnic_wq.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/gdth.c linux-2.6.34-rc4/drivers/scsi/gdth.c
--- linux-2.6.34-rc3/drivers/scsi/gdth.c	2010-04-13 02:18:56.153633088 +0000
+++ linux-2.6.34-rc4/drivers/scsi/gdth.c	2010-04-13 02:19:01.430633044 +0000
@@ -121,6 +121,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/list.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 
 #ifdef GDTH_RTC
 #include <linux/mc146818rtc.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/gdth_proc.c linux-2.6.34-rc4/drivers/scsi/gdth_proc.c
--- linux-2.6.34-rc3/drivers/scsi/gdth_proc.c	2010-04-13 02:18:56.155570346 +0000
+++ linux-2.6.34-rc4/drivers/scsi/gdth_proc.c	2010-04-13 02:19:01.431633062 +0000
@@ -3,6 +3,7 @@
  */
 
 #include <linux/completion.h>
+#include <linux/slab.h>
 
 int gdth_proc_info(struct Scsi_Host *host, char *buffer,char **start,off_t offset,int length,   
                    int inout)
diff -urN linux-2.6.34-rc3/drivers/scsi/gvp11.c linux-2.6.34-rc4/drivers/scsi/gvp11.c
--- linux-2.6.34-rc3/drivers/scsi/gvp11.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/gvp11.c	2010-04-13 02:19:01.432633037 +0000
@@ -1,5 +1,6 @@
 #include <linux/types.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/hosts.c linux-2.6.34-rc4/drivers/scsi/hosts.c
--- linux-2.6.34-rc3/drivers/scsi/hosts.c	2010-04-13 02:18:56.155570346 +0000
+++ linux-2.6.34-rc4/drivers/scsi/hosts.c	2010-04-13 02:19:01.432633037 +0000
@@ -24,6 +24,7 @@
 #include <linux/module.h>
 #include <linux/blkdev.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/kthread.h>
 #include <linux/string.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/hptiop.c linux-2.6.34-rc4/drivers/scsi/hptiop.c
--- linux-2.6.34-rc3/drivers/scsi/hptiop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/hptiop.c	2010-04-13 02:19:01.434633055 +0000
@@ -25,6 +25,7 @@
 #include <linux/delay.h>
 #include <linux/timer.h>
 #include <linux/spinlock.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 #include <asm/io.h>
 #include <asm/div64.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvfc.c linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvfc.c
--- linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvfc.c	2010-04-13 02:18:56.158572794 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvfc.c	2010-04-13 02:19:01.435633052 +0000
@@ -28,6 +28,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <linux/of.h>
 #include <linux/pm.h>
 #include <linux/stringify.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvscsi.c linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvscsi.c
--- linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvscsi.c	2010-04-13 02:18:56.158572794 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvscsi.c	2010-04-13 02:19:01.435633052 +0000
@@ -70,6 +70,7 @@
 #include <linux/moduleparam.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/of.h>
 #include <linux/pm.h>
 #include <asm/firmware.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvstgt.c linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvstgt.c
--- linux-2.6.34-rc3/drivers/scsi/ibmvscsi/ibmvstgt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ibmvscsi/ibmvstgt.c	2010-04-13 02:19:01.436633483 +0000
@@ -23,6 +23,7 @@
  */
 #include <linux/interrupt.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_transport_srp.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ibmvscsi/rpa_vscsi.c linux-2.6.34-rc4/drivers/scsi/ibmvscsi/rpa_vscsi.c
--- linux-2.6.34-rc3/drivers/scsi/ibmvscsi/rpa_vscsi.c	2010-04-13 02:18:56.158572794 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ibmvscsi/rpa_vscsi.c	2010-04-13 02:19:01.436633483 +0000
@@ -32,6 +32,7 @@
 #include <asm/iommu.h>
 #include <asm/hvcall.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 #include <linux/interrupt.h>
 #include "ibmvscsi.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/imm.c linux-2.6.34-rc4/drivers/scsi/imm.c
--- linux-2.6.34-rc3/drivers/scsi/imm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/imm.c	2010-04-13 02:19:01.436633483 +0000
@@ -15,6 +15,7 @@
 #include <linux/parport.h>
 #include <linux/workqueue.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ipr.c linux-2.6.34-rc4/drivers/scsi/ipr.c
--- linux-2.6.34-rc3/drivers/scsi/ipr.c	2010-04-13 02:18:56.161633146 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ipr.c	2010-04-13 02:19:01.439633102 +0000
@@ -59,6 +59,7 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/iscsi_tcp.c linux-2.6.34-rc4/drivers/scsi/iscsi_tcp.c
--- linux-2.6.34-rc3/drivers/scsi/iscsi_tcp.c	2010-04-13 02:18:56.162633050 +0000
+++ linux-2.6.34-rc4/drivers/scsi/iscsi_tcp.c	2010-04-13 02:19:01.440571533 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/types.h>
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <linux/file.h>
 #include <linux/blkdev.h>
 #include <linux/crypto.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/jazz_esp.c linux-2.6.34-rc4/drivers/scsi/jazz_esp.c
--- linux-2.6.34-rc3/drivers/scsi/jazz_esp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/jazz_esp.c	2010-04-13 02:19:01.440571533 +0000
@@ -4,6 +4,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/types.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lasi700.c linux-2.6.34-rc4/drivers/scsi/lasi700.c
--- linux-2.6.34-rc3/drivers/scsi/lasi700.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lasi700.c	2010-04-13 02:19:01.440571533 +0000
@@ -40,6 +40,7 @@
 #include <linux/blkdev.h>
 #include <linux/ioport.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_disc.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_disc.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_disc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_disc.c	2010-04-13 02:19:01.441570558 +0000
@@ -33,6 +33,7 @@
  */
 
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_exch.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_exch.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_exch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_exch.c	2010-04-13 02:19:01.441570558 +0000
@@ -24,7 +24,7 @@
  */
 
 #include <linux/timer.h>
-#include <linux/gfp.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 
 #include <scsi/fc/fc_fc2.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_fcp.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_fcp.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_fcp.c	2010-04-13 02:18:56.162633050 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_fcp.c	2010-04-13 02:19:01.441570558 +0000
@@ -27,6 +27,7 @@
 #include <linux/scatterlist.h>
 #include <linux/err.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_tcq.h>
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_frame.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_frame.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_frame.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_frame.c	2010-04-13 02:19:01.441570558 +0000
@@ -24,6 +24,7 @@
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/crc32.h>
+#include <linux/gfp.h>
 
 #include <scsi/fc_frame.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_lport.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_lport.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_lport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_lport.c	2010-04-13 02:19:01.442633059 +0000
@@ -88,6 +88,7 @@
  */
 
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include <scsi/fc/fc_gs.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libfc/fc_rport.c linux-2.6.34-rc4/drivers/scsi/libfc/fc_rport.c
--- linux-2.6.34-rc3/drivers/scsi/libfc/fc_rport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libfc/fc_rport.c	2010-04-13 02:19:01.442633059 +0000
@@ -47,6 +47,7 @@
 #include <linux/kernel.h>
 #include <linux/spinlock.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/rcupdate.h>
 #include <linux/timer.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libiscsi.c linux-2.6.34-rc4/drivers/scsi/libiscsi.c
--- linux-2.6.34-rc3/drivers/scsi/libiscsi.c	2010-04-13 02:18:56.163633055 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libiscsi.c	2010-04-13 02:19:01.442633059 +0000
@@ -25,6 +25,7 @@
 #include <linux/kfifo.h>
 #include <linux/delay.h>
 #include <linux/log2.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include <net/tcp.h>
 #include <scsi/scsi_cmnd.h>
@@ -3087,14 +3088,15 @@
 		session->state = ISCSI_STATE_TERMINATE;
 	else if (conn->stop_stage != STOP_CONN_RECOVER)
 		session->state = ISCSI_STATE_IN_RECOVERY;
+
+	old_stop_stage = conn->stop_stage;
+	conn->stop_stage = flag;
 	spin_unlock_bh(&session->lock);
 
 	del_timer_sync(&conn->transport_timer);
 	iscsi_suspend_tx(conn);
 
 	spin_lock_bh(&session->lock);
-	old_stop_stage = conn->stop_stage;
-	conn->stop_stage = flag;
 	conn->c_stage = ISCSI_CONN_STOPPED;
 	spin_unlock_bh(&session->lock);
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libiscsi_tcp.c linux-2.6.34-rc4/drivers/scsi/libiscsi_tcp.c
--- linux-2.6.34-rc3/drivers/scsi/libiscsi_tcp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libiscsi_tcp.c	2010-04-13 02:19:01.443633140 +0000
@@ -29,6 +29,7 @@
 #include <linux/types.h>
 #include <linux/list.h>
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <linux/file.h>
 #include <linux/blkdev.h>
 #include <linux/crypto.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_ata.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_ata.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_ata.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_ata.c	2010-04-13 02:19:01.443633140 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include <scsi/sas_ata.h>
 #include "sas_internal.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_discover.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_discover.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_discover.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_discover.c	2010-04-13 02:19:01.443633140 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_eh.h>
 #include "sas_internal.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_expander.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_expander.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_expander.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_expander.c	2010-04-13 02:19:01.443633140 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/scatterlist.h>
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 
 #include "sas_internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_host_smp.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_host_smp.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_host_smp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_host_smp.c	2010-04-13 02:19:01.443633140 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/scatterlist.h>
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 
 #include "sas_internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_init.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_init.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_init.c	2010-04-13 02:19:01.443633140 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/device.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/libsas/sas_scsi_host.c linux-2.6.34-rc4/drivers/scsi/libsas/sas_scsi_host.c
--- linux-2.6.34-rc3/drivers/scsi/libsas/sas_scsi_host.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsas/sas_scsi_host.c	2010-04-13 02:19:01.444633106 +0000
@@ -44,6 +44,7 @@
 #include <linux/err.h>
 #include <linux/blkdev.h>
 #include <linux/freezer.h>
+#include <linux/gfp.h>
 #include <linux/scatterlist.h>
 #include <linux/libata.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/libsrp.c linux-2.6.34-rc4/drivers/scsi/libsrp.c
--- linux-2.6.34-rc3/drivers/scsi/libsrp.c	2010-04-13 02:18:56.163633055 +0000
+++ linux-2.6.34-rc4/drivers/scsi/libsrp.c	2010-04-13 02:19:01.444633106 +0000
@@ -19,6 +19,7 @@
  * 02110-1301 USA
  */
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/kfifo.h>
 #include <linux/scatterlist.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_attr.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_attr.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_attr.c	2010-04-13 02:18:56.164633046 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_attr.c	2010-04-13 02:19:01.445633415 +0000
@@ -24,6 +24,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/aer.h>
+#include <linux/gfp.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_bsg.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_bsg.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_bsg.c	2010-04-13 02:18:56.166633046 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_bsg.c	2010-04-13 02:19:01.446633160 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/mempool.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_ct.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_ct.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_ct.c	2010-04-13 02:18:56.166633046 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_ct.c	2010-04-13 02:19:01.447633085 +0000
@@ -25,6 +25,7 @@
 #include <linux/blkdev.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/utsname.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_debugfs.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_debugfs.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_debugfs.c	2010-04-13 02:19:01.447633085 +0000
@@ -24,6 +24,7 @@
 #include <linux/idr.h>
 #include <linux/interrupt.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/spinlock.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_els.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_els.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_els.c	2010-04-13 02:18:56.167633045 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_els.c	2010-04-13 02:19:01.449633075 +0000
@@ -21,6 +21,7 @@
 /* See Fibre Channel protocol T11 FC-LS for details */
 #include <linux/blkdev.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_hbadisc.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_hbadisc.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_hbadisc.c	2010-04-13 02:18:56.169571504 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_hbadisc.c	2010-04-13 02:19:01.450633030 +0000
@@ -20,6 +20,7 @@
  *******************************************************************/
 
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/kthread.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_init.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_init.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_init.c	2010-04-13 02:18:56.171633059 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_init.c	2010-04-13 02:19:01.453633083 +0000
@@ -29,6 +29,7 @@
 #include <linux/spinlock.h>
 #include <linux/ctype.h>
 #include <linux/aer.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_mbox.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_mbox.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_mbox.c	2010-04-13 02:18:56.172633029 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_mbox.c	2010-04-13 02:19:01.454633344 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/blkdev.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_mem.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_mem.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_mem.c	2010-04-13 02:19:01.454633344 +0000
@@ -20,6 +20,7 @@
  *******************************************************************/
 
 #include <linux/mempool.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_nportdisc.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_nportdisc.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_nportdisc.c	2010-04-13 02:18:56.172633029 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_nportdisc.c	2010-04-13 02:19:01.454633344 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/blkdev.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_scsi.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_scsi.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_scsi.c	2010-04-13 02:18:56.173633245 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_scsi.c	2010-04-13 02:19:01.455633088 +0000
@@ -19,6 +19,7 @@
  * included with this package.                                     *
  *******************************************************************/
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_sli.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_sli.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_sli.c	2010-04-13 02:18:56.175633085 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_sli.c	2010-04-13 02:19:01.457633079 +0000
@@ -23,6 +23,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_vport.c linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_vport.c
--- linux-2.6.34-rc3/drivers/scsi/lpfc/lpfc_vport.c	2010-04-13 02:18:56.176633036 +0000
+++ linux-2.6.34-rc4/drivers/scsi/lpfc/lpfc_vport.c	2010-04-13 02:19:01.458633073 +0000
@@ -26,6 +26,7 @@
 #include <linux/interrupt.h>
 #include <linux/kthread.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/mac_esp.c linux-2.6.34-rc4/drivers/scsi/mac_esp.c
--- linux-2.6.34-rc3/drivers/scsi/mac_esp.c	2010-04-13 02:18:56.176633036 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mac_esp.c	2010-04-13 02:19:01.458633073 +0000
@@ -19,6 +19,7 @@
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <linux/nubus.h>
+#include <linux/slab.h>
 
 #include <asm/irq.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_mbox.c linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_mbox.c
--- linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_mbox.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_mbox.c	2010-04-13 02:19:01.459633054 +0000
@@ -70,6 +70,7 @@
  * For history of changes, see Documentation/ChangeLog.megaraid
  */
 
+#include <linux/slab.h>
 #include "megaraid_mbox.h"
 
 static int megaraid_init(void);
diff -urN linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_mm.c linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_mm.c
--- linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_mm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_mm.c	2010-04-13 02:19:01.460571063 +0000
@@ -15,6 +15,7 @@
  * Common management module
  */
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include "megaraid_mm.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_sas.c linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_sas.c
--- linux-2.6.34-rc3/drivers/scsi/megaraid/megaraid_sas.c	2010-04-13 02:18:56.177633038 +0000
+++ linux-2.6.34-rc4/drivers/scsi/megaraid/megaraid_sas.c	2010-04-13 02:19:01.460571063 +0000
@@ -35,6 +35,7 @@
 #include <linux/delay.h>
 #include <linux/smp_lock.h>
 #include <linux/uio.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/fs.h>
 #include <linux/compat.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/megaraid.c linux-2.6.34-rc4/drivers/scsi/megaraid.c
--- linux-2.6.34-rc3/drivers/scsi/megaraid.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/megaraid.c	2010-04-13 02:19:01.459633054 +0000
@@ -47,6 +47,7 @@
 #include <linux/init.h>
 #include <linux/dma-mapping.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <scsi/scsicam.h>
 
 #include "scsi.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/mesh.c linux-2.6.34-rc4/drivers/scsi/mesh.c
--- linux-2.6.34-rc3/drivers/scsi/mesh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mesh.c	2010-04-13 02:19:01.461570523 +0000
@@ -23,7 +23,6 @@
 #include <linux/delay.h>
 #include <linux/types.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_config.c linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_config.c
--- linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_config.c	2010-04-13 02:18:56.180570471 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_config.c	2010-04-13 02:19:01.464633083 +0000
@@ -51,6 +51,7 @@
 #include <linux/workqueue.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "mpt2sas_base.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_scsih.c linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_scsih.c
--- linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_scsih.c	2010-04-13 02:18:56.181633070 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_scsih.c	2010-04-13 02:19:01.465633044 +0000
@@ -53,6 +53,7 @@
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/raid_class.h>
+#include <linux/slab.h>
 
 #include "mpt2sas_base.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_transport.c linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_transport.c
--- linux-2.6.34-rc3/drivers/scsi/mpt2sas/mpt2sas_transport.c	2010-04-13 02:18:56.181633070 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mpt2sas/mpt2sas_transport.c	2010-04-13 02:19:01.466633068 +0000
@@ -49,6 +49,7 @@
 #include <linux/workqueue.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/mvme16x_scsi.c linux-2.6.34-rc4/drivers/scsi/mvme16x_scsi.c
--- linux-2.6.34-rc3/drivers/scsi/mvme16x_scsi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mvme16x_scsi.c	2010-04-13 02:19:01.466633068 +0000
@@ -12,6 +12,7 @@
 #include <linux/platform_device.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <asm/mvme16xhw.h>
 #include <scsi/scsi_host.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/mvsas/mv_sas.h linux-2.6.34-rc4/drivers/scsi/mvsas/mv_sas.h
--- linux-2.6.34-rc3/drivers/scsi/mvsas/mv_sas.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/mvsas/mv_sas.h	2010-04-13 02:19:01.466633068 +0000
@@ -36,6 +36,7 @@
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <scsi/libsas.h>
 #include <scsi/scsi_tcq.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ncr53c8xx.c linux-2.6.34-rc4/drivers/scsi/ncr53c8xx.c
--- linux-2.6.34-rc3/drivers/scsi/ncr53c8xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ncr53c8xx.c	2010-04-13 02:19:01.467633064 +0000
@@ -98,6 +98,7 @@
 #include <linux/delay.h>
 #include <linux/dma-mapping.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/nsp32.c linux-2.6.34-rc4/drivers/scsi/nsp32.c
--- linux-2.6.34-rc3/drivers/scsi/nsp32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/nsp32.c	2010-04-13 02:19:01.467633064 +0000
@@ -26,7 +26,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/osd/osd_initiator.c linux-2.6.34-rc4/drivers/scsi/osd/osd_initiator.c
--- linux-2.6.34-rc3/drivers/scsi/osd/osd_initiator.c	2010-04-13 02:18:56.181633070 +0000
+++ linux-2.6.34-rc4/drivers/scsi/osd/osd_initiator.c	2010-04-13 02:19:01.468633088 +0000
@@ -39,6 +39,8 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
+
 #include <scsi/osd_initiator.h>
 #include <scsi/osd_sec.h>
 #include <scsi/osd_attributes.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/osd/osd_uld.c linux-2.6.34-rc4/drivers/scsi/osd/osd_uld.c
--- linux-2.6.34-rc3/drivers/scsi/osd/osd_uld.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/osd/osd_uld.c	2010-04-13 02:19:01.468633088 +0000
@@ -50,6 +50,7 @@
 #include <linux/idr.h>
 #include <linux/major.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_driver.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/osst.c linux-2.6.34-rc4/drivers/scsi/osst.c
--- linux-2.6.34-rc3/drivers/scsi/osst.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/osst.c	2010-04-13 02:19:01.469633019 +0000
@@ -38,6 +38,7 @@
 #include <linux/sched.h>
 #include <linux/proc_fs.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_ctl.c linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_ctl.c
--- linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_ctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_ctl.c	2010-04-13 02:19:01.469633019 +0000
@@ -38,6 +38,7 @@
  *
  */
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include "pm8001_sas.h"
 #include "pm8001_ctl.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_hwi.c linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_hwi.c
--- linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_hwi.c	2010-04-13 02:18:56.182633054 +0000
+++ linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_hwi.c	2010-04-13 02:19:01.470571771 +0000
@@ -37,6 +37,7 @@
  * POSSIBILITY OF SUCH DAMAGES.
  *
  */
+ #include <linux/slab.h>
  #include "pm8001_sas.h"
  #include "pm8001_hwi.h"
  #include "pm8001_chips.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_init.c linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_init.c
--- linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_init.c	2010-04-13 02:18:56.183633083 +0000
+++ linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_init.c	2010-04-13 02:19:01.470571771 +0000
@@ -38,6 +38,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include "pm8001_sas.h"
 #include "pm8001_chips.h"
 
diff -urN linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_sas.c linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_sas.c
--- linux-2.6.34-rc3/drivers/scsi/pm8001/pm8001_sas.c	2010-04-13 02:18:56.183633083 +0000
+++ linux-2.6.34-rc4/drivers/scsi/pm8001/pm8001_sas.c	2010-04-13 02:19:01.470571771 +0000
@@ -38,6 +38,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include "pm8001_sas.h"
 
 /**
diff -urN linux-2.6.34-rc3/drivers/scsi/pmcraid.c linux-2.6.34-rc4/drivers/scsi/pmcraid.c
--- linux-2.6.34-rc3/drivers/scsi/pmcraid.c	2010-04-13 02:18:56.183633083 +0000
+++ linux-2.6.34-rc4/drivers/scsi/pmcraid.c	2010-04-13 02:19:01.471570499 +0000
@@ -41,6 +41,7 @@
 #include <linux/hdreg.h>
 #include <linux/version.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/irq.h>
 #include <asm/processor.h>
 #include <linux/libata.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ppa.c linux-2.6.34-rc4/drivers/scsi/ppa.c
--- linux-2.6.34-rc3/drivers/scsi/ppa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ppa.c	2010-04-13 02:19:01.471570499 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/blkdev.h>
 #include <linux/parport.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/ps3rom.c linux-2.6.34-rc4/drivers/scsi/ps3rom.c
--- linux-2.6.34-rc3/drivers/scsi/ps3rom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ps3rom.c	2010-04-13 02:19:01.472633444 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/cdrom.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/qla1280.c linux-2.6.34-rc4/drivers/scsi/qla1280.c
--- linux-2.6.34-rc3/drivers/scsi/qla1280.c	2010-04-13 02:18:56.184633034 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla1280.c	2010-04-13 02:19:01.472633444 +0000
@@ -17,9 +17,11 @@
 * General Public License for more details.
 *
 ******************************************************************************/
-#define QLA1280_VERSION      "3.27"
+#define QLA1280_VERSION      "3.27.1"
 /*****************************************************************************
     Revision History:
+    Rev  3.27.1, February 8, 2010, Michael Reed
+	- Retain firmware image for error recovery.
     Rev  3.27, February 10, 2009, Michael Reed
 	- General code cleanup.
 	- Improve error recovery.
@@ -346,7 +348,6 @@
 #include <linux/pci.h>
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
-#include <linux/slab.h>
 #include <linux/pci_ids.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
@@ -538,9 +539,9 @@
 /*****************************************/
 
 struct qla_boards {
-	unsigned char name[9];	/* Board ID String */
+	char *name;		/* Board ID String */
 	int numPorts;		/* Number of SCSI ports */
-	char *fwname;		/* firmware name        */
+	int fw_index;		/* index into qla1280_fw_tbl for firmware */
 };
 
 /* NOTE: the last argument in each entry is used to index ql1280_board_tbl */
@@ -561,15 +562,30 @@
 };
 MODULE_DEVICE_TABLE(pci, qla1280_pci_tbl);
 
+DEFINE_MUTEX(qla1280_firmware_mutex);
+
+struct qla_fw {
+	char *fwname;
+	const struct firmware *fw;
+};
+
+#define QL_NUM_FW_IMAGES 3
+
+struct qla_fw qla1280_fw_tbl[QL_NUM_FW_IMAGES] = {
+	{"qlogic/1040.bin",  NULL},	/* image 0 */
+	{"qlogic/1280.bin",  NULL},	/* image 1 */
+	{"qlogic/12160.bin", NULL},	/* image 2 */
+};
+
+/* NOTE: Order of boards in this table must match order in qla1280_pci_tbl */
 static struct qla_boards ql1280_board_tbl[] = {
-	/* Name ,  Number of ports, FW details */
-	{"QLA12160",	2, "qlogic/12160.bin"},
-	{"QLA1040",	1, "qlogic/1040.bin"},
-	{"QLA1080",	1, "qlogic/1280.bin"},
-	{"QLA1240",	2, "qlogic/1280.bin"},
-	{"QLA1280",	2, "qlogic/1280.bin"},
-	{"QLA10160",	1, "qlogic/12160.bin"},
-	{"        ",	0, "   "},
+	{.name = "QLA12160", .numPorts = 2, .fw_index = 2},
+	{.name = "QLA1040" , .numPorts = 1, .fw_index = 0},
+	{.name = "QLA1080" , .numPorts = 1, .fw_index = 1},
+	{.name = "QLA1240" , .numPorts = 2, .fw_index = 1},
+	{.name = "QLA1280" , .numPorts = 2, .fw_index = 1},
+	{.name = "QLA10160", .numPorts = 1, .fw_index = 2},
+	{.name = "        ", .numPorts = 0, .fw_index = -1},
 };
 
 static int qla1280_verbose = 1;
@@ -1512,6 +1528,63 @@
 }
 
 /*
+ * qla1280_request_firmware
+ *      Acquire firmware for chip.  Retain in memory
+ *      for error recovery.
+ *
+ * Input:
+ *      ha = adapter block pointer.
+ *
+ * Returns:
+ *      Pointer to firmware image or an error code
+ *      cast to pointer via ERR_PTR().
+ */
+static const struct firmware *
+qla1280_request_firmware(struct scsi_qla_host *ha)
+{
+	const struct firmware *fw;
+	int err;
+	int index;
+	char *fwname;
+
+	spin_unlock_irq(ha->host->host_lock);
+	mutex_lock(&qla1280_firmware_mutex);
+
+	index = ql1280_board_tbl[ha->devnum].fw_index;
+	fw = qla1280_fw_tbl[index].fw;
+	if (fw)
+		goto out;
+
+	fwname = qla1280_fw_tbl[index].fwname;
+	err = request_firmware(&fw, fwname, &ha->pdev->dev);
+
+	if (err) {
+		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
+		       fwname, err);
+		fw = ERR_PTR(err);
+		goto unlock;
+	}
+	if ((fw->size % 2) || (fw->size < 6)) {
+		printk(KERN_ERR "Invalid firmware length %zu in image \"%s\"\n",
+		       fw->size, fwname);
+		release_firmware(fw);
+		fw = ERR_PTR(-EINVAL);
+		goto unlock;
+	}
+
+	qla1280_fw_tbl[index].fw = fw;
+
+ out:
+	ha->fwver1 = fw->data[0];
+	ha->fwver2 = fw->data[1];
+	ha->fwver3 = fw->data[2];
+ unlock:
+	mutex_unlock(&qla1280_firmware_mutex);
+	spin_lock_irq(ha->host->host_lock);
+	return fw;
+}
+
+/*
  * Chip diagnostics
  *      Test chip for proper operation.
  *
@@ -1634,30 +1707,18 @@
 static int
 qla1280_load_firmware_pio(struct scsi_qla_host *ha)
 {
+	/* enter with host_lock acquired */
+
 	const struct firmware *fw;
 	const __le16 *fw_data;
 	uint16_t risc_address, risc_code_size;
 	uint16_t mb[MAILBOX_REGISTER_COUNT], i;
-	int err;
+	int err = 0;
+
+	fw = qla1280_request_firmware(ha);
+	if (IS_ERR(fw))
+		return PTR_ERR(fw);
 
-	spin_unlock_irq(ha->host->host_lock);
-	err = request_firmware(&fw, ql1280_board_tbl[ha->devnum].fwname,
-			       &ha->pdev->dev);
-	spin_lock_irq(ha->host->host_lock);
-	if (err) {
-		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
-		       ql1280_board_tbl[ha->devnum].fwname, err);
-		return err;
-	}
-	if ((fw->size % 2) || (fw->size < 6)) {
-		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
-		       fw->size, ql1280_board_tbl[ha->devnum].fwname);
-		err = -EINVAL;
-		goto out;
-	}
-	ha->fwver1 = fw->data[0];
-	ha->fwver2 = fw->data[1];
-	ha->fwver3 = fw->data[2];
 	fw_data = (const __le16 *)&fw->data[0];
 	ha->fwstart = __le16_to_cpu(fw_data[2]);
 
@@ -1675,11 +1736,10 @@
 		if (err) {
 			printk(KERN_ERR "scsi(%li): Failed to load firmware\n",
 					ha->host_no);
-			goto out;
+			break;
 		}
 	}
-out:
-	release_firmware(fw);
+
 	return err;
 }
 
@@ -1687,6 +1747,7 @@
 static int
 qla1280_load_firmware_dma(struct scsi_qla_host *ha)
 {
+	/* enter with host_lock acquired */
 	const struct firmware *fw;
 	const __le16 *fw_data;
 	uint16_t risc_address, risc_code_size;
@@ -1701,24 +1762,10 @@
 		return -ENOMEM;
 #endif
 
-	spin_unlock_irq(ha->host->host_lock);
-	err = request_firmware(&fw, ql1280_board_tbl[ha->devnum].fwname,
-			       &ha->pdev->dev);
-	spin_lock_irq(ha->host->host_lock);
-	if (err) {
-		printk(KERN_ERR "Failed to load image \"%s\" err %d\n",
-		       ql1280_board_tbl[ha->devnum].fwname, err);
-		return err;
-	}
-	if ((fw->size % 2) || (fw->size < 6)) {
-		printk(KERN_ERR "Bogus length %zu in image \"%s\"\n",
-		       fw->size, ql1280_board_tbl[ha->devnum].fwname);
-		err = -EINVAL;
-		goto out;
-	}
-	ha->fwver1 = fw->data[0];
-	ha->fwver2 = fw->data[1];
-	ha->fwver3 = fw->data[2];
+	fw = qla1280_request_firmware(ha);
+	if (IS_ERR(fw))
+		return PTR_ERR(fw);
+
 	fw_data = (const __le16 *)&fw->data[0];
 	ha->fwstart = __le16_to_cpu(fw_data[2]);
 
@@ -1803,7 +1850,6 @@
 #if DUMP_IT_BACK
 	pci_free_consistent(ha->pdev, 8000, tbuf, p_tbuf);
 #endif
-	release_firmware(fw);
 	return err;
 }
 
@@ -1842,6 +1888,7 @@
 static int
 qla1280_load_firmware(struct scsi_qla_host *ha)
 {
+	/* enter with host_lock taken */
 	int err;
 
 	err = qla1280_chip_diag(ha);
@@ -4420,7 +4467,16 @@
 static void __exit
 qla1280_exit(void)
 {
+	int i;
+
 	pci_unregister_driver(&qla1280_pci_driver);
+	/* release any allocated firmware images */
+	for (i = 0; i < QL_NUM_FW_IMAGES; i++) {
+		if (qla1280_fw_tbl[i].fw) {
+			release_firmware(qla1280_fw_tbl[i].fw);
+			qla1280_fw_tbl[i].fw = NULL;
+		}
+	}
 }
 
 module_init(qla1280_init);
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_attr.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_attr.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_attr.c	2010-04-13 02:18:56.185633066 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_attr.c	2010-04-13 02:19:01.473633711 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/kthread.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 static int qla24xx_vport_disable(struct fc_vport *, bool);
@@ -1274,7 +1275,11 @@
 	int rval = QLA_FUNCTION_FAILED;
 	uint16_t state[5];
 
-	if (!vha->hw->flags.eeh_busy)
+	if (test_bit(ABORT_ISP_ACTIVE, &vha->dpc_flags) ||
+		test_bit(ISP_ABORT_NEEDED, &vha->dpc_flags))
+		DEBUG2_3_11(printk("%s(%ld): isp reset in progress.\n",
+			__func__, vha->host_no));
+	else if (!vha->hw->flags.eeh_busy)
 		rval = qla2x00_get_firmware_state(vha, state);
 	if (rval != QLA_SUCCESS)
 		memset(state, -1, sizeof(state));
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_fw.h linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_fw.h
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_fw.h	2010-04-13 02:18:56.186633063 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_fw.h	2010-04-13 02:19:01.474633264 +0000
@@ -1592,10 +1592,22 @@
 
 	/* Offset 384. */
 	uint8_t reserved_21[16];
-	uint16_t reserved_22[8];
+	uint16_t reserved_22[3];
+
+	/*
+	 * BIT 0 = Extended BB credits for LR
+	 * BIT 1 = Virtual Fabric Enable
+	 * BIT 2 = Enhanced Features Unused
+	 * BIT 3-7 = Enhanced Features Reserved
+	 */
+	/* Enhanced Features */
+	uint8_t enhanced_features;
+
+	uint8_t reserved_23;
+	uint16_t reserved_24[4];
 
 	/* Offset 416. */
-	uint16_t reserved_23[32];
+	uint16_t reserved_25[32];
 
 	/* Offset 480. */
 	uint8_t model_name[16];
@@ -1603,7 +1615,7 @@
 	/* Offset 496. */
 	uint16_t feature_mask_l;
 	uint16_t feature_mask_h;
-	uint16_t reserved_24[2];
+	uint16_t reserved_26[2];
 
 	uint16_t subsystem_vendor_id;
 	uint16_t subsystem_device_id;
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_init.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_init.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_init.c	2010-04-13 02:18:56.186633063 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_init.c	2010-04-13 02:19:01.475633230 +0000
@@ -8,6 +8,7 @@
 #include "qla_gbl.h"
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "qla_devtbl.h"
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_isr.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_isr.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_isr.c	2010-04-13 02:18:56.187633041 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_isr.c	2010-04-13 02:19:01.475633230 +0000
@@ -7,6 +7,7 @@
 #include "qla_def.h"
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <scsi/scsi_tcq.h>
 #include <scsi/scsi_bsg_fc.h>
 
@@ -620,11 +621,10 @@
 		 *           vp_idx does not match
 		 *       Event is not global, vp_idx does not match
 		 */
-		if ((mb[1] == 0xffff && (mb[3] & 0xff) != 0xff)
-			|| (mb[1] != 0xffff)) {
-			if (vha->vp_idx != (mb[3] & 0xff))
-				break;
-		}
+		if (IS_QLA2XXX_MIDTYPE(ha) &&
+		    ((mb[1] == 0xffff && (mb[3] & 0xff) != 0xff) ||
+			(mb[1] != 0xffff)) && vha->vp_idx != (mb[3] & 0xff))
+			break;
 
 		/* Global event -- port logout or port unavailable. */
 		if (mb[1] == 0xffff && mb[2] == 0x7) {
@@ -2272,30 +2272,28 @@
 
 	/* If possible, enable MSI-X. */
 	if (!IS_QLA2432(ha) && !IS_QLA2532(ha) &&
-	    !IS_QLA8432(ha) && !IS_QLA8001(ha))
-		goto skip_msix;
+		!IS_QLA8432(ha) && !IS_QLA8001(ha))
+		goto skip_msi;
+
+	if (ha->pdev->subsystem_vendor == PCI_VENDOR_ID_HP &&
+		(ha->pdev->subsystem_device == 0x7040 ||
+		ha->pdev->subsystem_device == 0x7041 ||
+		ha->pdev->subsystem_device == 0x1705)) {
+		DEBUG2(qla_printk(KERN_WARNING, ha,
+			"MSI-X: Unsupported ISP2432 SSVID/SSDID (0x%X,0x%X).\n",
+			ha->pdev->subsystem_vendor,
+			ha->pdev->subsystem_device));
+		goto skip_msi;
+	}
 
 	if (IS_QLA2432(ha) && (ha->pdev->revision < QLA_MSIX_CHIP_REV_24XX ||
 		!QLA_MSIX_FW_MODE_1(ha->fw_attributes))) {
 		DEBUG2(qla_printk(KERN_WARNING, ha,
 		"MSI-X: Unsupported ISP2432 (0x%X, 0x%X).\n",
 			ha->pdev->revision, ha->fw_attributes));
-
 		goto skip_msix;
 	}
 
-	if (ha->pdev->subsystem_vendor == PCI_VENDOR_ID_HP &&
-	    (ha->pdev->subsystem_device == 0x7040 ||
-		ha->pdev->subsystem_device == 0x7041 ||
-		ha->pdev->subsystem_device == 0x1705)) {
-		DEBUG2(qla_printk(KERN_WARNING, ha,
-		    "MSI-X: Unsupported ISP2432 SSVID/SSDID (0x%X, 0x%X).\n",
-		    ha->pdev->subsystem_vendor,
-		    ha->pdev->subsystem_device));
-
-		goto skip_msi;
-	}
-
 	ret = qla24xx_enable_msix(ha, rsp);
 	if (!ret) {
 		DEBUG2(qla_printk(KERN_INFO, ha,
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_mbx.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_mbx.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_mbx.c	2010-04-13 02:18:56.187633041 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_mbx.c	2010-04-13 02:19:01.476633116 +0000
@@ -7,6 +7,7 @@
 #include "qla_def.h"
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 
 /*
@@ -339,6 +340,7 @@
 	return rval;
 }
 
+#define	EXTENDED_BB_CREDITS	BIT_0
 /*
  * qla2x00_execute_fw
  *     Start adapter firmware.
@@ -371,7 +373,12 @@
 		mcp->mb[1] = MSW(risc_addr);
 		mcp->mb[2] = LSW(risc_addr);
 		mcp->mb[3] = 0;
-		mcp->mb[4] = 0;
+		if (IS_QLA81XX(ha)) {
+			struct nvram_81xx *nv = ha->nvram;
+			mcp->mb[4] = (nv->enhanced_features &
+			    EXTENDED_BB_CREDITS);
+		} else
+			mcp->mb[4] = 0;
 		mcp->out_mb |= MBX_4|MBX_3|MBX_2|MBX_1;
 		mcp->in_mb |= MBX_1;
 	} else {
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_mid.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_mid.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_mid.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_mid.c	2010-04-13 02:19:01.476633116 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/moduleparam.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 
 #include <scsi/scsi_tcq.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_os.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_os.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_os.c	2010-04-13 02:18:56.189572170 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_os.c	2010-04-13 02:19:01.477633656 +0000
@@ -12,6 +12,7 @@
 #include <linux/kthread.h>
 #include <linux/mutex.h>
 #include <linux/kobject.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_tcq.h>
 #include <scsi/scsicam.h>
@@ -1676,9 +1677,11 @@
 
 	/* Determine queue resources */
 	ha->max_req_queues = ha->max_rsp_queues = 1;
-	if ((ql2xmaxqueues <= 1 || ql2xmultique_tag < 1) &&
+	if ((ql2xmaxqueues <= 1 && !ql2xmultique_tag) ||
+		(ql2xmaxqueues > 1 && ql2xmultique_tag) ||
 		(!IS_QLA25XX(ha) && !IS_QLA81XX(ha)))
 		goto mqiobase_exit;
+
 	ha->mqiobase = ioremap(pci_resource_start(ha->pdev, 3),
 			pci_resource_len(ha->pdev, 3));
 	if (ha->mqiobase) {
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_sup.c linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_sup.c
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_sup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_sup.c	2010-04-13 02:19:01.477633656 +0000
@@ -7,6 +7,7 @@
 #include "qla_def.h"
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_version.h linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_version.h
--- linux-2.6.34-rc3/drivers/scsi/qla2xxx/qla_version.h	2010-04-13 02:18:56.189572170 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla2xxx/qla_version.h	2010-04-13 02:19:01.477633656 +0000
@@ -7,9 +7,9 @@
 /*
  * Driver version
  */
-#define QLA2XXX_VERSION      "8.03.02-k1"
+#define QLA2XXX_VERSION      "8.03.02-k2"
 
 #define QLA_DRIVER_MAJOR_VER	8
 #define QLA_DRIVER_MINOR_VER	3
 #define QLA_DRIVER_PATCH_VER	2
-#define QLA_DRIVER_BETA_VER	1
+#define QLA_DRIVER_BETA_VER	2
diff -urN linux-2.6.34-rc3/drivers/scsi/qla4xxx/ql4_os.c linux-2.6.34-rc4/drivers/scsi/qla4xxx/ql4_os.c
--- linux-2.6.34-rc3/drivers/scsi/qla4xxx/ql4_os.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qla4xxx/ql4_os.c	2010-04-13 02:19:01.478633397 +0000
@@ -5,6 +5,7 @@
  * See LICENSE.qla4xxx for copyright and licensing details.
  */
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_tcq.h>
 #include <scsi/scsicam.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/qlogicpti.c linux-2.6.34-rc4/drivers/scsi/qlogicpti.c
--- linux-2.6.34-rc3/drivers/scsi/qlogicpti.c	2010-04-13 02:18:56.189572170 +0000
+++ linux-2.6.34-rc4/drivers/scsi/qlogicpti.c	2010-04-13 02:19:01.478633397 +0000
@@ -16,7 +16,7 @@
 #include <linux/delay.h>
 #include <linux/types.h>
 #include <linux/string.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/blkdev.h>
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_debug.c linux-2.6.34-rc4/drivers/scsi/scsi_debug.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_debug.c	2010-04-13 02:19:01.479633958 +0000
@@ -30,6 +30,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 #include <linux/genhd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_devinfo.c linux-2.6.34-rc4/drivers/scsi/scsi_devinfo.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_devinfo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_devinfo.c	2010-04-13 02:19:01.479633958 +0000
@@ -6,6 +6,7 @@
 #include <linux/moduleparam.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi_device.h>
 #include <scsi/scsi_devinfo.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_error.c linux-2.6.34-rc4/drivers/scsi/scsi_error.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_error.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_error.c	2010-04-13 02:19:01.479633958 +0000
@@ -16,6 +16,7 @@
 
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include <linux/timer.h>
 #include <linux/string.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_netlink.c linux-2.6.34-rc4/drivers/scsi/scsi_netlink.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_netlink.c	2010-04-13 02:19:01.480571535 +0000
@@ -22,6 +22,7 @@
 #include <linux/jiffies.h>
 #include <linux/security.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/netlink.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_proc.c linux-2.6.34-rc4/drivers/scsi/scsi_proc.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_proc.c	2010-04-13 02:19:01.480571535 +0000
@@ -20,12 +20,12 @@
 #include <linux/init.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/errno.h>
 #include <linux/blkdev.h>
 #include <linux/seq_file.h>
 #include <linux/mutex.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_scan.c linux-2.6.34-rc4/drivers/scsi/scsi_scan.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_scan.c	2010-04-13 02:18:56.190570489 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_scan.c	2010-04-13 02:19:01.480571535 +0000
@@ -33,6 +33,7 @@
 #include <linux/kthread.h>
 #include <linux/spinlock.h>
 #include <linux/async.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_sysfs.c linux-2.6.34-rc4/drivers/scsi/scsi_sysfs.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_sysfs.c	2010-04-13 02:18:56.190570489 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_sysfs.c	2010-04-13 02:19:01.481570524 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_tgt_if.c linux-2.6.34-rc4/drivers/scsi/scsi_tgt_if.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_tgt_if.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_tgt_if.c	2010-04-13 02:19:01.481570524 +0000
@@ -20,6 +20,7 @@
  * 02110-1301 USA
  */
 #include <linux/miscdevice.h>
+#include <linux/gfp.h>
 #include <linux/file.h>
 #include <linux/smp_lock.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_tgt_lib.c linux-2.6.34-rc4/drivers/scsi/scsi_tgt_lib.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_tgt_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_tgt_lib.c	2010-04-13 02:19:01.481570524 +0000
@@ -23,6 +23,7 @@
 #include <linux/hash.h>
 #include <linux/module.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_transport_fc.c linux-2.6.34-rc4/drivers/scsi/scsi_transport_fc.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_transport_fc.c	2010-04-13 02:18:56.191570482 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_transport_fc.c	2010-04-13 02:19:01.482633060 +0000
@@ -27,6 +27,7 @@
  */
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <scsi/scsi_device.h>
 #include <scsi/scsi_host.h>
@@ -3852,7 +3853,7 @@
 		if (rport && (rport->port_state != FC_PORTSTATE_ONLINE)) {
 			req->errors = -ENXIO;
 			spin_unlock_irq(q->queue_lock);
-			blk_end_request(req, -ENXIO, blk_rq_bytes(req));
+			blk_end_request_all(req, -ENXIO);
 			spin_lock_irq(q->queue_lock);
 			continue;
 		}
@@ -3862,7 +3863,7 @@
 		ret = fc_req_to_bsgjob(shost, rport, req);
 		if (ret) {
 			req->errors = ret;
-			blk_end_request(req, ret, blk_rq_bytes(req));
+			blk_end_request_all(req, ret);
 			spin_lock_irq(q->queue_lock);
 			continue;
 		}
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_transport_iscsi.c linux-2.6.34-rc4/drivers/scsi/scsi_transport_iscsi.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_transport_iscsi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_transport_iscsi.c	2010-04-13 02:19:01.482633060 +0000
@@ -22,6 +22,7 @@
  */
 #include <linux/module.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/tcp.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_host.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsi_transport_spi.c linux-2.6.34-rc4/drivers/scsi/scsi_transport_spi.c
--- linux-2.6.34-rc3/drivers/scsi/scsi_transport_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsi_transport_spi.c	2010-04-13 02:19:01.483633099 +0000
@@ -25,6 +25,7 @@
 #include <linux/blkdev.h>
 #include <linux/mutex.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include "scsi_priv.h"
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/scsicam.c linux-2.6.34-rc4/drivers/scsi/scsicam.c
--- linux-2.6.34-rc3/drivers/scsi/scsicam.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/scsicam.c	2010-04-13 02:19:01.483633099 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/genhd.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sd.c linux-2.6.34-rc4/drivers/scsi/sd.c
--- linux-2.6.34-rc3/drivers/scsi/sd.c	2010-04-13 02:18:56.192633027 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sd.c	2010-04-13 02:19:01.483633099 +0000
@@ -49,6 +49,7 @@
 #include <linux/mutex.h>
 #include <linux/string_helpers.h>
 #include <linux/async.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/unaligned.h>
 
@@ -2185,7 +2186,7 @@
 	blk_queue_prep_rq(sdp->request_queue, sd_prep_fn);
 
 	gd->driverfs_dev = &sdp->sdev_gendev;
-	gd->flags = GENHD_FL_EXT_DEVT | GENHD_FL_DRIVERFS;
+	gd->flags = GENHD_FL_EXT_DEVT;
 	if (sdp->removable)
 		gd->flags |= GENHD_FL_REMOVABLE;
 
diff -urN linux-2.6.34-rc3/drivers/scsi/ses.c linux-2.6.34-rc4/drivers/scsi/ses.c
--- linux-2.6.34-rc3/drivers/scsi/ses.c	2010-04-13 02:18:56.192633027 +0000
+++ linux-2.6.34-rc4/drivers/scsi/ses.c	2010-04-13 02:19:01.483633099 +0000
@@ -21,6 +21,7 @@
 **-----------------------------------------------------------------------------
 */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/enclosure.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sg.c linux-2.6.34-rc4/drivers/scsi/sg.c
--- linux-2.6.34-rc3/drivers/scsi/sg.c	2010-04-13 02:18:56.192633027 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sg.c	2010-04-13 02:19:01.484633042 +0000
@@ -38,6 +38,7 @@
 #include <linux/errno.h>
 #include <linux/mtio.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <linux/fcntl.h>
 #include <linux/init.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sim710.c linux-2.6.34-rc4/drivers/scsi/sim710.c
--- linux-2.6.34-rc3/drivers/scsi/sim710.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sim710.c	2010-04-13 02:19:01.484633042 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/blkdev.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sni_53c710.c linux-2.6.34-rc4/drivers/scsi/sni_53c710.c
--- linux-2.6.34-rc3/drivers/scsi/sni_53c710.c	2010-04-13 02:18:56.192633027 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sni_53c710.c	2010-04-13 02:19:01.484633042 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 #include <linux/mm.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sr.c linux-2.6.34-rc4/drivers/scsi/sr.c
--- linux-2.6.34-rc3/drivers/scsi/sr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sr.c	2010-04-13 02:19:01.484633042 +0000
@@ -44,6 +44,7 @@
 #include <linux/init.h>
 #include <linux/blkdev.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sr_ioctl.c linux-2.6.34-rc4/drivers/scsi/sr_ioctl.c
--- linux-2.6.34-rc3/drivers/scsi/sr_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sr_ioctl.c	2010-04-13 02:19:01.484633042 +0000
@@ -7,6 +7,7 @@
 #include <linux/blkpg.h>
 #include <linux/cdrom.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/sr_vendor.c linux-2.6.34-rc4/drivers/scsi/sr_vendor.c
--- linux-2.6.34-rc3/drivers/scsi/sr_vendor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sr_vendor.c	2010-04-13 02:19:01.484633042 +0000
@@ -39,6 +39,7 @@
 #include <linux/string.h>
 #include <linux/bcd.h>
 #include <linux/blkdev.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/st.c linux-2.6.34-rc4/drivers/scsi/st.c
--- linux-2.6.34-rc3/drivers/scsi/st.c	2010-04-13 02:18:56.193633080 +0000
+++ linux-2.6.34-rc4/drivers/scsi/st.c	2010-04-13 02:19:01.485633120 +0000
@@ -27,6 +27,7 @@
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/mtio.h>
 #include <linux/cdrom.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/stex.c linux-2.6.34-rc4/drivers/scsi/stex.c
--- linux-2.6.34-rc3/drivers/scsi/stex.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/stex.c	2010-04-13 02:19:01.485633120 +0000
@@ -17,6 +17,7 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/pci.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sun3_NCR5380.c linux-2.6.34-rc4/drivers/scsi/sun3_NCR5380.c
--- linux-2.6.34-rc3/drivers/scsi/sun3_NCR5380.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sun3_NCR5380.c	2010-04-13 02:19:01.486633473 +0000
@@ -645,6 +645,7 @@
  * interrupt or bottom half.
  */
 
+#include <linux/gfp.h>
 #include <linux/workqueue.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/sun3x_esp.c linux-2.6.34-rc4/drivers/scsi/sun3x_esp.c
--- linux-2.6.34-rc3/drivers/scsi/sun3x_esp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sun3x_esp.c	2010-04-13 02:19:01.486633473 +0000
@@ -4,6 +4,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/types.h>
 #include <linux/delay.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/sun_esp.c linux-2.6.34-rc4/drivers/scsi/sun_esp.c
--- linux-2.6.34-rc3/drivers/scsi/sun_esp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/sun_esp.c	2010-04-13 02:19:01.486633473 +0000
@@ -12,6 +12,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/gfp.h>
 
 #include <asm/irq.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/tmscsim.c linux-2.6.34-rc4/drivers/scsi/tmscsim.c
--- linux-2.6.34-rc3/drivers/scsi/tmscsim.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/tmscsim.c	2010-04-13 02:19:01.486633473 +0000
@@ -233,6 +233,7 @@
 #include <linux/interrupt.h>
 #include <linux/init.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include <scsi/scsi.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/u14-34f.c linux-2.6.34-rc4/drivers/scsi/u14-34f.c
--- linux-2.6.34-rc3/drivers/scsi/u14-34f.c	2010-04-13 02:18:56.193633080 +0000
+++ linux-2.6.34-rc4/drivers/scsi/u14-34f.c	2010-04-13 02:19:01.487633986 +0000
@@ -420,6 +420,7 @@
 #include <linux/init.h>
 #include <linux/ctype.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <asm/dma.h>
 #include <asm/irq.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/vmw_pvscsi.c linux-2.6.34-rc4/drivers/scsi/vmw_pvscsi.c
--- linux-2.6.34-rc3/drivers/scsi/vmw_pvscsi.c	2010-04-13 02:18:56.193633080 +0000
+++ linux-2.6.34-rc4/drivers/scsi/vmw_pvscsi.c	2010-04-13 02:19:01.487633986 +0000
@@ -24,6 +24,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/pci.h>
 
diff -urN linux-2.6.34-rc3/drivers/scsi/wd7000.c linux-2.6.34-rc4/drivers/scsi/wd7000.c
--- linux-2.6.34-rc3/drivers/scsi/wd7000.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/wd7000.c	2010-04-13 02:19:01.487633986 +0000
@@ -171,7 +171,6 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/ioport.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/drivers/scsi/zorro7xx.c linux-2.6.34-rc4/drivers/scsi/zorro7xx.c
--- linux-2.6.34-rc3/drivers/scsi/zorro7xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/scsi/zorro7xx.c	2010-04-13 02:19:01.487633986 +0000
@@ -13,6 +13,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/zorro.h>
+#include <linux/slab.h>
 
 #include <asm/amigahw.h>
 #include <asm/amigaints.h>
diff -urN linux-2.6.34-rc3/drivers/serial/68328serial.c linux-2.6.34-rc4/drivers/serial/68328serial.c
--- linux-2.6.34-rc3/drivers/serial/68328serial.c	2010-04-13 02:18:56.194570392 +0000
+++ linux-2.6.34-rc4/drivers/serial/68328serial.c	2010-04-13 02:19:01.488633590 +0000
@@ -35,6 +35,7 @@
 #include <linux/pm.h>
 #include <linux/bitops.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/serial/8250.c linux-2.6.34-rc4/drivers/serial/8250.c
--- linux-2.6.34-rc3/drivers/serial/8250.c	2010-04-13 02:18:56.194570392 +0000
+++ linux-2.6.34-rc4/drivers/serial/8250.c	2010-04-13 02:19:01.488633590 +0000
@@ -38,6 +38,7 @@
 #include <linux/serial_8250.h>
 #include <linux/nmi.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/serial/8250_gsc.c linux-2.6.34-rc4/drivers/serial/8250_gsc.c
--- linux-2.6.34-rc3/drivers/serial/8250_gsc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/8250_gsc.c	2010-04-13 02:19:01.488633590 +0000
@@ -16,7 +16,6 @@
 #include <linux/module.h>
 #include <linux/serial_core.h>
 #include <linux/signal.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 
 #include <asm/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/serial/8250_hp300.c linux-2.6.34-rc4/drivers/serial/8250_hp300.c
--- linux-2.6.34-rc3/drivers/serial/8250_hp300.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/8250_hp300.c	2010-04-13 02:19:01.488633590 +0000
@@ -15,6 +15,7 @@
 #include <linux/delay.h>
 #include <linux/dio.h>
 #include <linux/console.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 
 #include "8250.h"
diff -urN linux-2.6.34-rc3/drivers/serial/amba-pl010.c linux-2.6.34-rc4/drivers/serial/amba-pl010.c
--- linux-2.6.34-rc3/drivers/serial/amba-pl010.c	2010-04-13 02:18:56.195570487 +0000
+++ linux-2.6.34-rc4/drivers/serial/amba-pl010.c	2010-04-13 02:19:01.489633581 +0000
@@ -47,6 +47,7 @@
 #include <linux/amba/bus.h>
 #include <linux/amba/serial.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/serial/amba-pl011.c linux-2.6.34-rc4/drivers/serial/amba-pl011.c
--- linux-2.6.34-rc3/drivers/serial/amba-pl011.c	2010-04-13 02:18:56.195570487 +0000
+++ linux-2.6.34-rc4/drivers/serial/amba-pl011.c	2010-04-13 02:19:01.490633169 +0000
@@ -47,6 +47,7 @@
 #include <linux/amba/bus.h>
 #include <linux/amba/serial.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/sizes.h>
diff -urN linux-2.6.34-rc3/drivers/serial/bfin_5xx.c linux-2.6.34-rc4/drivers/serial/bfin_5xx.c
--- linux-2.6.34-rc3/drivers/serial/bfin_5xx.c	2010-04-13 02:18:56.196633044 +0000
+++ linux-2.6.34-rc4/drivers/serial/bfin_5xx.c	2010-04-13 02:19:01.490633169 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/module.h>
 #include <linux/ioport.h>
+#include <linux/gfp.h>
 #include <linux/io.h>
 #include <linux/init.h>
 #include <linux/console.h>
diff -urN linux-2.6.34-rc3/drivers/serial/bfin_sport_uart.c linux-2.6.34-rc4/drivers/serial/bfin_sport_uart.c
--- linux-2.6.34-rc3/drivers/serial/bfin_sport_uart.c	2010-04-13 02:18:56.197570380 +0000
+++ linux-2.6.34-rc4/drivers/serial/bfin_sport_uart.c	2010-04-13 02:19:01.491633070 +0000
@@ -28,6 +28,7 @@
 #include <linux/init.h>
 #include <linux/console.h>
 #include <linux/sysrq.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
diff -urN linux-2.6.34-rc3/drivers/serial/cpm_uart/cpm_uart_cpm1.c linux-2.6.34-rc4/drivers/serial/cpm_uart/cpm_uart_cpm1.c
--- linux-2.6.34-rc3/drivers/serial/cpm_uart/cpm_uart_cpm1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/cpm_uart/cpm_uart_cpm1.c	2010-04-13 02:19:01.491633070 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/module.h>
 #include <linux/tty.h>
+#include <linux/gfp.h>
 #include <linux/ioport.h>
 #include <linux/init.h>
 #include <linux/serial.h>
diff -urN linux-2.6.34-rc3/drivers/serial/cpm_uart/cpm_uart_cpm2.c linux-2.6.34-rc4/drivers/serial/cpm_uart/cpm_uart_cpm2.c
--- linux-2.6.34-rc3/drivers/serial/cpm_uart/cpm_uart_cpm2.c	2010-04-13 02:18:56.197570380 +0000
+++ linux-2.6.34-rc4/drivers/serial/cpm_uart/cpm_uart_cpm2.c	2010-04-13 02:19:01.491633070 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/tty.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/serial.h>
 #include <linux/console.h>
diff -urN linux-2.6.34-rc3/drivers/serial/imx.c linux-2.6.34-rc4/drivers/serial/imx.c
--- linux-2.6.34-rc3/drivers/serial/imx.c	2010-04-13 02:18:56.197570380 +0000
+++ linux-2.6.34-rc4/drivers/serial/imx.c	2010-04-13 02:19:01.492633034 +0000
@@ -46,6 +46,7 @@
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/rational.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/serial/ioc3_serial.c linux-2.6.34-rc4/drivers/serial/ioc3_serial.c
--- linux-2.6.34-rc3/drivers/serial/ioc3_serial.c	2010-04-13 02:18:56.197570380 +0000
+++ linux-2.6.34-rc4/drivers/serial/ioc3_serial.c	2010-04-13 02:19:01.492633034 +0000
@@ -20,6 +20,7 @@
 #include <linux/pci.h>
 #include <linux/serial_core.h>
 #include <linux/ioc3.h>
+#include <linux/slab.h>
 
 /*
  * Interesting things about the ioc3
diff -urN linux-2.6.34-rc3/drivers/serial/ioc4_serial.c linux-2.6.34-rc4/drivers/serial/ioc4_serial.c
--- linux-2.6.34-rc3/drivers/serial/ioc4_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/ioc4_serial.c	2010-04-13 02:19:01.493633052 +0000
@@ -22,6 +22,7 @@
 #include <linux/pci.h>
 #include <linux/ioc4.h>
 #include <linux/serial_core.h>
+#include <linux/slab.h>
 
 /*
  * interesting things about the ioc4
diff -urN linux-2.6.34-rc3/drivers/serial/jsm/jsm_driver.c linux-2.6.34-rc4/drivers/serial/jsm/jsm_driver.c
--- linux-2.6.34-rc3/drivers/serial/jsm/jsm_driver.c	2010-04-13 02:18:56.198570487 +0000
+++ linux-2.6.34-rc4/drivers/serial/jsm/jsm_driver.c	2010-04-13 02:19:01.493633052 +0000
@@ -26,6 +26,7 @@
  ***********************************************************************/
 #include <linux/moduleparam.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "jsm.h"
 
diff -urN linux-2.6.34-rc3/drivers/serial/jsm/jsm_tty.c linux-2.6.34-rc4/drivers/serial/jsm/jsm_tty.c
--- linux-2.6.34-rc3/drivers/serial/jsm/jsm_tty.c	2010-04-13 02:18:56.198570487 +0000
+++ linux-2.6.34-rc4/drivers/serial/jsm/jsm_tty.c	2010-04-13 02:19:01.493633052 +0000
@@ -30,6 +30,7 @@
 #include <linux/serial_reg.h>
 #include <linux/delay.h>	/* For udelay */
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "jsm.h"
 
diff -urN linux-2.6.34-rc3/drivers/serial/max3100.c linux-2.6.34-rc4/drivers/serial/max3100.c
--- linux-2.6.34-rc3/drivers/serial/max3100.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/max3100.c	2010-04-13 02:19:01.493633052 +0000
@@ -41,6 +41,7 @@
 #define MAX_MAX3100 4
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/serial_core.h>
 #include <linux/serial.h>
diff -urN linux-2.6.34-rc3/drivers/serial/mpsc.c linux-2.6.34-rc4/drivers/serial/mpsc.c
--- linux-2.6.34-rc3/drivers/serial/mpsc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/mpsc.c	2010-04-13 02:19:01.494633108 +0000
@@ -70,6 +70,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/mv643xx.h>
 #include <linux/platform_device.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/serial/mux.c linux-2.6.34-rc4/drivers/serial/mux.c
--- linux-2.6.34-rc3/drivers/serial/mux.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/mux.c	2010-04-13 02:19:01.494633108 +0000
@@ -22,7 +22,6 @@
 #include <linux/init.h>
 #include <linux/serial.h>
 #include <linux/console.h>
-#include <linux/slab.h>
 #include <linux/delay.h> /* for udelay */
 #include <linux/device.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/serial/of_serial.c linux-2.6.34-rc4/drivers/serial/of_serial.c
--- linux-2.6.34-rc3/drivers/serial/of_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/of_serial.c	2010-04-13 02:19:01.494633108 +0000
@@ -11,6 +11,7 @@
  */
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/serial_8250.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/serial/pmac_zilog.c linux-2.6.34-rc4/drivers/serial/pmac_zilog.c
--- linux-2.6.34-rc3/drivers/serial/pmac_zilog.c	2010-04-13 02:18:56.199571530 +0000
+++ linux-2.6.34-rc4/drivers/serial/pmac_zilog.c	2010-04-13 02:19:01.495633027 +0000
@@ -54,7 +54,6 @@
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/console.h>
-#include <linux/slab.h>
 #include <linux/adb.h>
 #include <linux/pmu.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/drivers/serial/pxa.c linux-2.6.34-rc4/drivers/serial/pxa.c
--- linux-2.6.34-rc3/drivers/serial/pxa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/pxa.c	2010-04-13 02:19:01.495633027 +0000
@@ -44,6 +44,7 @@
 #include <linux/serial_core.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 struct uart_pxa_port {
 	struct uart_port        port;
diff -urN linux-2.6.34-rc3/drivers/serial/sh-sci.c linux-2.6.34-rc4/drivers/serial/sh-sci.c
--- linux-2.6.34-rc3/drivers/serial/sh-sci.c	2010-04-13 02:18:56.200570413 +0000
+++ linux-2.6.34-rc4/drivers/serial/sh-sci.c	2010-04-13 02:19:01.496633693 +0000
@@ -50,6 +50,7 @@
 #include <linux/list.h>
 #include <linux/dmaengine.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_SUPERH
 #include <asm/sh_bios.h>
diff -urN linux-2.6.34-rc3/drivers/serial/sunsu.c linux-2.6.34-rc4/drivers/serial/sunsu.c
--- linux-2.6.34-rc3/drivers/serial/sunsu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/sunsu.c	2010-04-13 02:19:01.497633297 +0000
@@ -29,6 +29,7 @@
 #include <linux/serial.h>
 #include <linux/sysrq.h>
 #include <linux/console.h>
+#include <linux/slab.h>
 #ifdef CONFIG_SERIO
 #include <linux/serio.h>
 #endif
@@ -1453,8 +1454,10 @@
 	if (up->su_type == SU_PORT_KBD || up->su_type == SU_PORT_MS) {
 		err = sunsu_kbd_ms_init(up);
 		if (err) {
+			of_iounmap(&op->resource[0],
+				   up->port.membase, up->reg_size);
 			kfree(up);
-			goto out_unmap;
+			return err;
 		}
 		dev_set_drvdata(&op->dev, up);
 
diff -urN linux-2.6.34-rc3/drivers/serial/timbuart.c linux-2.6.34-rc4/drivers/serial/timbuart.c
--- linux-2.6.34-rc3/drivers/serial/timbuart.c	2010-04-13 02:18:56.201570460 +0000
+++ linux-2.6.34-rc4/drivers/serial/timbuart.c	2010-04-13 02:19:01.497633297 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 
 #include "timbuart.h"
 
diff -urN linux-2.6.34-rc3/drivers/serial/ucc_uart.c linux-2.6.34-rc4/drivers/serial/ucc_uart.c
--- linux-2.6.34-rc3/drivers/serial/ucc_uart.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/serial/ucc_uart.c	2010-04-13 02:19:01.498633029 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/module.h>
 #include <linux/serial.h>
+#include <linux/slab.h>
 #include <linux/serial_core.h>
 #include <linux/io.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/sh/intc.c linux-2.6.34-rc4/drivers/sh/intc.c
--- linux-2.6.34-rc3/drivers/sh/intc.c	2010-04-13 02:18:56.202633071 +0000
+++ linux-2.6.34-rc4/drivers/sh/intc.c	2010-04-13 02:19:01.498633029 +0000
@@ -20,6 +20,7 @@
 #include <linux/irq.h>
 #include <linux/module.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/sh_intc.h>
 #include <linux/sysdev.h>
diff -urN linux-2.6.34-rc3/drivers/sn/ioc3.c linux-2.6.34-rc4/drivers/sn/ioc3.c
--- linux-2.6.34-rc3/drivers/sn/ioc3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/sn/ioc3.c	2010-04-13 02:19:01.499633092 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/ioc3.h>
 #include <linux/rwsem.h>
+#include <linux/slab.h>
 
 #define IOC3_PCI_SIZE 0x100000
 
diff -urN linux-2.6.34-rc3/drivers/spi/amba-pl022.c linux-2.6.34-rc4/drivers/spi/amba-pl022.c
--- linux-2.6.34-rc3/drivers/spi/amba-pl022.c	2010-04-13 02:18:56.202633071 +0000
+++ linux-2.6.34-rc4/drivers/spi/amba-pl022.c	2010-04-13 02:19:01.500633359 +0000
@@ -44,6 +44,7 @@
 #include <linux/amba/bus.h>
 #include <linux/amba/pl022.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /*
  * This macro is used to define some register default values.
diff -urN linux-2.6.34-rc3/drivers/spi/atmel_spi.c linux-2.6.34-rc4/drivers/spi/atmel_spi.c
--- linux-2.6.34-rc3/drivers/spi/atmel_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/atmel_spi.c	2010-04-13 02:19:01.500633359 +0000
@@ -18,6 +18,7 @@
 #include <linux/err.h>
 #include <linux/interrupt.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <mach/board.h>
diff -urN linux-2.6.34-rc3/drivers/spi/au1550_spi.c linux-2.6.34-rc4/drivers/spi/au1550_spi.c
--- linux-2.6.34-rc3/drivers/spi/au1550_spi.c	2010-04-13 02:18:56.202633071 +0000
+++ linux-2.6.34-rc4/drivers/spi/au1550_spi.c	2010-04-13 02:19:01.500633359 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/device.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/spi/davinci_spi.c linux-2.6.34-rc4/drivers/spi/davinci_spi.c
--- linux-2.6.34-rc3/drivers/spi/davinci_spi.c	2010-04-13 02:18:56.203633043 +0000
+++ linux-2.6.34-rc4/drivers/spi/davinci_spi.c	2010-04-13 02:19:01.501633824 +0000
@@ -27,6 +27,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
+#include <linux/slab.h>
 
 #include <mach/spi.h>
 #include <mach/edma.h>
diff -urN linux-2.6.34-rc3/drivers/spi/dw_spi.c linux-2.6.34-rc4/drivers/spi/dw_spi.c
--- linux-2.6.34-rc3/drivers/spi/dw_spi.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/dw_spi.c	2010-04-13 02:19:01.501633824 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/highmem.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <linux/spi/dw_spi.h>
 #include <linux/spi/spi.h>
diff -urN linux-2.6.34-rc3/drivers/spi/dw_spi_mmio.c linux-2.6.34-rc4/drivers/spi/dw_spi_mmio.c
--- linux-2.6.34-rc3/drivers/spi/dw_spi_mmio.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/dw_spi_mmio.c	2010-04-13 02:19:01.501633824 +0000
@@ -11,6 +11,7 @@
 #include <linux/clk.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/spi/dw_spi.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/dw_spi_pci.c linux-2.6.34-rc4/drivers/spi/dw_spi_pci.c
--- linux-2.6.34-rc3/drivers/spi/dw_spi_pci.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/dw_spi_pci.c	2010-04-13 02:19:01.501633824 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/interrupt.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/spi/dw_spi.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/mpc52xx_psc_spi.c linux-2.6.34-rc4/drivers/spi/mpc52xx_psc_spi.c
--- linux-2.6.34-rc3/drivers/spi/mpc52xx_psc_spi.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/mpc52xx_psc_spi.c	2010-04-13 02:19:01.501633824 +0000
@@ -24,6 +24,7 @@
 #include <linux/delay.h>
 #include <linux/spi/spi.h>
 #include <linux/fsl_devices.h>
+#include <linux/slab.h>
 
 #include <asm/mpc52xx.h>
 #include <asm/mpc52xx_psc.h>
diff -urN linux-2.6.34-rc3/drivers/spi/mpc52xx_spi.c linux-2.6.34-rc4/drivers/spi/mpc52xx_spi.c
--- linux-2.6.34-rc3/drivers/spi/mpc52xx_spi.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/mpc52xx_spi.c	2010-04-13 02:19:01.502633421 +0000
@@ -21,6 +21,7 @@
 #include <linux/of_spi.h>
 #include <linux/io.h>
 #include <linux/of_gpio.h>
+#include <linux/slab.h>
 #include <asm/time.h>
 #include <asm/mpc52xx.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/omap2_mcspi.c linux-2.6.34-rc4/drivers/spi/omap2_mcspi.c
--- linux-2.6.34-rc3/drivers/spi/omap2_mcspi.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/omap2_mcspi.c	2010-04-13 02:19:01.502633421 +0000
@@ -32,6 +32,7 @@
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/omap_spi_100k.c linux-2.6.34-rc4/drivers/spi/omap_spi_100k.c
--- linux-2.6.34-rc3/drivers/spi/omap_spi_100k.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/omap_spi_100k.c	2010-04-13 02:19:01.502633421 +0000
@@ -33,6 +33,7 @@
 #include <linux/clk.h>
 #include <linux/io.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/omap_uwire.c linux-2.6.34-rc4/drivers/spi/omap_uwire.c
--- linux-2.6.34-rc3/drivers/spi/omap_uwire.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/omap_uwire.c	2010-04-13 02:19:01.502633421 +0000
@@ -41,6 +41,7 @@
 #include <linux/interrupt.h>
 #include <linux/err.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
diff -urN linux-2.6.34-rc3/drivers/spi/pxa2xx_spi.c linux-2.6.34-rc4/drivers/spi/pxa2xx_spi.c
--- linux-2.6.34-rc3/drivers/spi/pxa2xx_spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/pxa2xx_spi.c	2010-04-13 02:19:01.502633421 +0000
@@ -29,6 +29,7 @@
 #include <linux/delay.h>
 #include <linux/clk.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi.c linux-2.6.34-rc4/drivers/spi/spi.c
--- linux-2.6.34-rc3/drivers/spi/spi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi.c	2010-04-13 02:19:01.503633106 +0000
@@ -23,6 +23,7 @@
 #include <linux/init.h>
 #include <linux/cache.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/mod_devicetable.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/spi/spi_bfin5xx.c linux-2.6.34-rc4/drivers/spi/spi_bfin5xx.c
--- linux-2.6.34-rc3/drivers/spi/spi_bfin5xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_bfin5xx.c	2010-04-13 02:19:01.503633106 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/delay.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/ioport.h>
 #include <linux/irq.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_bitbang.c linux-2.6.34-rc4/drivers/spi/spi_bitbang.c
--- linux-2.6.34-rc3/drivers/spi/spi_bitbang.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_bitbang.c	2010-04-13 02:19:01.503633106 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/errno.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_imx.c linux-2.6.34-rc4/drivers/spi/spi_imx.c
--- linux-2.6.34-rc3/drivers/spi/spi_imx.c	2010-04-13 02:18:56.204633021 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_imx.c	2010-04-13 02:19:01.503633106 +0000
@@ -30,6 +30,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_mpc8xxx.c linux-2.6.34-rc4/drivers/spi/spi_mpc8xxx.c
--- linux-2.6.34-rc3/drivers/spi/spi_mpc8xxx.c	2010-04-13 02:18:56.205633056 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_mpc8xxx.c	2010-04-13 02:19:01.503633106 +0000
@@ -39,6 +39,7 @@
 #include <linux/gpio.h>
 #include <linux/of_gpio.h>
 #include <linux/of_spi.h>
+#include <linux/slab.h>
 
 #include <sysdev/fsl_soc.h>
 #include <asm/cpm.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_nuc900.c linux-2.6.34-rc4/drivers/spi/spi_nuc900.c
--- linux-2.6.34-rc3/drivers/spi/spi_nuc900.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_nuc900.c	2010-04-13 02:19:01.503633106 +0000
@@ -21,6 +21,7 @@
 #include <linux/platform_device.h>
 #include <linux/gpio.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_ppc4xx.c linux-2.6.34-rc4/drivers/spi/spi_ppc4xx.c
--- linux-2.6.34-rc3/drivers/spi/spi_ppc4xx.c	2010-04-13 02:18:56.205633056 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_ppc4xx.c	2010-04-13 02:19:01.504633058 +0000
@@ -26,6 +26,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/wait.h>
 #include <linux/of_platform.h>
diff -urN linux-2.6.34-rc3/drivers/spi/spi_s3c24xx.c linux-2.6.34-rc4/drivers/spi/spi_s3c24xx.c
--- linux-2.6.34-rc3/drivers/spi/spi_s3c24xx.c	2010-04-13 02:18:56.205633056 +0000
+++ linux-2.6.34-rc4/drivers/spi/spi_s3c24xx.c	2010-04-13 02:19:01.504633058 +0000
@@ -21,6 +21,7 @@
 #include <linux/platform_device.h>
 #include <linux/gpio.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 #include <linux/spi/spi_bitbang.h>
diff -urN linux-2.6.34-rc3/drivers/spi/tle62x0.c linux-2.6.34-rc4/drivers/spi/tle62x0.c
--- linux-2.6.34-rc3/drivers/spi/tle62x0.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/spi/tle62x0.c	2010-04-13 02:19:01.504633058 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/device.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 #include <linux/spi/tle62x0.h>
diff -urN linux-2.6.34-rc3/drivers/spi/xilinx_spi_of.c linux-2.6.34-rc4/drivers/spi/xilinx_spi_of.c
--- linux-2.6.34-rc3/drivers/spi/xilinx_spi_of.c	2010-04-13 02:18:56.206633052 +0000
+++ linux-2.6.34-rc4/drivers/spi/xilinx_spi_of.c	2010-04-13 02:19:01.505633075 +0000
@@ -27,6 +27,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/of_platform.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/drivers/ssb/driver_gige.c linux-2.6.34-rc4/drivers/ssb/driver_gige.c
--- linux-2.6.34-rc3/drivers/ssb/driver_gige.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/driver_gige.c	2010-04-13 02:19:01.505633075 +0000
@@ -12,6 +12,7 @@
 #include <linux/ssb/ssb_driver_gige.h>
 #include <linux/pci.h>
 #include <linux/pci_regs.h>
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/drivers/ssb/driver_pcicore.c linux-2.6.34-rc4/drivers/ssb/driver_pcicore.c
--- linux-2.6.34-rc3/drivers/ssb/driver_pcicore.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/driver_pcicore.c	2010-04-13 02:19:01.505633075 +0000
@@ -246,20 +246,12 @@
 	.pci_ops	= &ssb_pcicore_pciops,
 	.io_resource	= &ssb_pcicore_io_resource,
 	.mem_resource	= &ssb_pcicore_mem_resource,
-	.mem_offset	= 0x24000000,
 };
 
-static u32 ssb_pcicore_pcibus_iobase = 0x100;
-static u32 ssb_pcicore_pcibus_membase = SSB_PCI_DMA;
-
 /* This function is called when doing a pci_enable_device().
  * We must first check if the device is a device on the PCI-core bridge. */
 int ssb_pcicore_plat_dev_init(struct pci_dev *d)
 {
-	struct resource *res;
-	int pos, size;
-	u32 *base;
-
 	if (d->bus->ops != &ssb_pcicore_pciops) {
 		/* This is not a device on the PCI-core bridge. */
 		return -ENODEV;
@@ -268,27 +260,6 @@
 	ssb_printk(KERN_INFO "PCI: Fixing up device %s\n",
 		   pci_name(d));
 
-	/* Fix up resource bases */
-	for (pos = 0; pos < 6; pos++) {
-		res = &d->resource[pos];
-		if (res->flags & IORESOURCE_IO)
-			base = &ssb_pcicore_pcibus_iobase;
-		else
-			base = &ssb_pcicore_pcibus_membase;
-		res->flags |= IORESOURCE_PCI_FIXED;
-		if (res->end) {
-			size = res->end - res->start + 1;
-			if (*base & (size - 1))
-				*base = (*base + size) & ~(size - 1);
-			res->start = *base;
-			res->end = res->start + size - 1;
-			*base += size;
-			pci_write_config_dword(d, PCI_BASE_ADDRESS_0 + (pos << 2), res->start);
-		}
-		/* Fix up PCI bridge BAR0 only */
-		if (d->bus->number == 0 && PCI_SLOT(d->devfn) == 0)
-			break;
-	}
 	/* Fix up interrupt lines */
 	d->irq = ssb_mips_irq(extpci_core->dev) + 2;
 	pci_write_config_byte(d, PCI_INTERRUPT_LINE, d->irq);
diff -urN linux-2.6.34-rc3/drivers/ssb/main.c linux-2.6.34-rc4/drivers/ssb/main.c
--- linux-2.6.34-rc3/drivers/ssb/main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/main.c	2010-04-13 02:19:01.505633075 +0000
@@ -18,6 +18,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/pci.h>
 #include <linux/mmc/sdio_func.h>
+#include <linux/slab.h>
 
 #include <pcmcia/cs_types.h>
 #include <pcmcia/cs.h>
diff -urN linux-2.6.34-rc3/drivers/ssb/pci.c linux-2.6.34-rc4/drivers/ssb/pci.c
--- linux-2.6.34-rc3/drivers/ssb/pci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/pci.c	2010-04-13 02:19:01.506633120 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/ssb/ssb.h>
 #include <linux/ssb/ssb_regs.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/ssb/pcihost_wrapper.c linux-2.6.34-rc4/drivers/ssb/pcihost_wrapper.c
--- linux-2.6.34-rc3/drivers/ssb/pcihost_wrapper.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/pcihost_wrapper.c	2010-04-13 02:19:01.506633120 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/ssb/ssb.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/ssb/sprom.c linux-2.6.34-rc4/drivers/ssb/sprom.c
--- linux-2.6.34-rc3/drivers/ssb/sprom.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/ssb/sprom.c	2010-04-13 02:19:01.506633120 +0000
@@ -14,6 +14,7 @@
 #include "ssb_private.h"
 
 #include <linux/ctype.h>
+#include <linux/slab.h>
 
 
 static const struct ssb_sprom *fallback_sprom;
diff -urN linux-2.6.34-rc3/drivers/staging/batman-adv/device.c linux-2.6.34-rc4/drivers/staging/batman-adv/device.c
--- linux-2.6.34-rc3/drivers/staging/batman-adv/device.c	2010-04-13 02:18:56.212633058 +0000
+++ linux-2.6.34-rc4/drivers/staging/batman-adv/device.c	2010-04-13 02:19:01.511633008 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/device.h>
+#include <linux/slab.h>
 #include "main.h"
 #include "device.h"
 #include "send.h"
diff -urN linux-2.6.34-rc3/drivers/staging/batman-adv/main.h linux-2.6.34-rc4/drivers/staging/batman-adv/main.h
--- linux-2.6.34-rc3/drivers/staging/batman-adv/main.h	2010-04-13 02:18:56.213633066 +0000
+++ linux-2.6.34-rc4/drivers/staging/batman-adv/main.h	2010-04-13 02:19:01.512633065 +0000
@@ -109,6 +109,7 @@
 #include <linux/kthread.h>	/* kernel threads */
 #include <linux/pkt_sched.h>	/* schedule types */
 #include <linux/workqueue.h>	/* workqueue */
+#include <linux/slab.h>
 #include <net/sock.h>		/* struct sock */
 #include <linux/jiffies.h>
 #include "types.h"
diff -urN linux-2.6.34-rc3/drivers/staging/batman-adv/soft-interface.c linux-2.6.34-rc4/drivers/staging/batman-adv/soft-interface.c
--- linux-2.6.34-rc3/drivers/staging/batman-adv/soft-interface.c	2010-04-13 02:18:56.215633052 +0000
+++ linux-2.6.34-rc4/drivers/staging/batman-adv/soft-interface.c	2010-04-13 02:19:01.515633631 +0000
@@ -26,6 +26,7 @@
 #include "translation-table.h"
 #include "types.h"
 #include "hash.h"
+#include <linux/slab.h>
 #include <linux/ethtool.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/8255.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/8255.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/8255.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/8255.c	2010-04-13 02:19:01.517633222 +0000
@@ -81,6 +81,7 @@
 #include "../comedidev.h"
 
 #include <linux/ioport.h>
+#include <linux/slab.h>
 
 #define _8255_SIZE 4
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/addi-data/addi_common.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/addi-data/addi_common.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/addi-data/addi_common.c	2010-04-13 02:18:56.220570498 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/addi-data/addi_common.c	2010-04-13 02:19:01.520633042 +0000
@@ -50,7 +50,6 @@
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/ioport.h>
 #include <linux/delay.h>
@@ -58,6 +57,7 @@
 #include <linux/timex.h>
 #include <linux/timer.h>
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include "../../comedidev.h"
 #include <asm/io.h>
 #if defined(CONFIG_APCI_1710) || defined(CONFIG_APCI_3200) || defined(CONFIG_APCI_3300)
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/adl_pci9118.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/adl_pci9118.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/adl_pci9118.c	2010-04-13 02:18:56.224633023 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/adl_pci9118.c	2010-04-13 02:19:01.525633175 +0000
@@ -66,6 +66,7 @@
 #include "../pci_ids.h"
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/interrupt.h>
 
 #include "amcc_s5933.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/amplc_dio200.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/amplc_dio200.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/amplc_dio200.c	2010-04-13 02:18:56.225633043 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/amplc_dio200.c	2010-04-13 02:19:01.526633715 +0000
@@ -206,6 +206,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include "../comedidev.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/amplc_pci224.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/amplc_pci224.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/amplc_pci224.c	2010-04-13 02:18:56.225633043 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/amplc_pci224.c	2010-04-13 02:19:01.526633715 +0000
@@ -104,6 +104,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include "../comedidev.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/cb_das16_cs.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/cb_das16_cs.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/cb_das16_cs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/cb_das16_cs.c	2010-04-13 02:19:01.526633715 +0000
@@ -32,6 +32,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 #include <linux/delay.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/comedi_bond.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/comedi_bond.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/comedi_bond.c	2010-04-13 02:18:56.227633059 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/comedi_bond.c	2010-04-13 02:19:01.528633802 +0000
@@ -90,6 +90,7 @@
 #include "../comedilib.h"
 #include "../comedidev.h"
 #include <linux/string.h>
+#include <linux/slab.h>
 
 /* The maxiumum number of channels per subdevice. */
 #define MAX_CHANS 256
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/das08_cs.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/das08_cs.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/das08_cs.c	2010-04-13 02:18:56.227633059 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/das08_cs.c	2010-04-13 02:19:01.528633802 +0000
@@ -43,6 +43,7 @@
 
 #include <linux/delay.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "das08.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/das16.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/das16.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/das16.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/das16.c	2010-04-13 02:19:01.528633802 +0000
@@ -79,6 +79,7 @@
 */
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <asm/dma.h>
 #include "../comedidev.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/das1800.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/das1800.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/das1800.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/das1800.c	2010-04-13 02:19:01.528633802 +0000
@@ -101,6 +101,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/dt282x.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/dt282x.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/dt282x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/dt282x.c	2010-04-13 02:19:01.530633297 +0000
@@ -58,6 +58,7 @@
 
 #include "../comedidev.h"
 
+#include <linux/gfp.h>
 #include <linux/ioport.h>
 #include <linux/interrupt.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/jr3_pci.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/jr3_pci.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/jr3_pci.c	2010-04-13 02:18:56.228633043 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/jr3_pci.c	2010-04-13 02:19:01.530633297 +0000
@@ -46,6 +46,7 @@
 #include <linux/ctype.h>
 #include <linux/firmware.h>
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include "comedi_pci.h"
 #include "jr3_pci.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_65xx.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_65xx.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_65xx.c	2010-04-13 02:18:56.229571690 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_65xx.c	2010-04-13 02:19:01.531633261 +0000
@@ -52,6 +52,7 @@
 #define DEBUG 1
 #define DEBUG_FLAGS
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include "mite.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_670x.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_670x.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_670x.c	2010-04-13 02:18:56.229571690 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_670x.c	2010-04-13 02:19:01.531633261 +0000
@@ -42,6 +42,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include "mite.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_at_a2150.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_at_a2150.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_at_a2150.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_at_a2150.c	2010-04-13 02:19:01.531633261 +0000
@@ -65,6 +65,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_daq_700.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_daq_700.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_daq_700.c	2010-04-13 02:18:56.229571690 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_daq_700.c	2010-04-13 02:19:01.532633162 +0000
@@ -42,6 +42,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_daq_dio24.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_daq_dio24.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_daq_dio24.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_daq_dio24.c	2010-04-13 02:19:01.532633162 +0000
@@ -41,6 +41,7 @@
 #undef LABPC_DEBUG
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_labpc.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_labpc.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_labpc.c	2010-04-13 02:18:56.230570465 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_labpc.c	2010-04-13 02:19:01.532633162 +0000
@@ -77,6 +77,7 @@
 /* #define LABPC_DEBUG    enable debugging messages */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_labpc_cs.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_labpc_cs.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/ni_labpc_cs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/ni_labpc_cs.c	2010-04-13 02:19:01.533633119 +0000
@@ -64,6 +64,7 @@
 #include "../comedidev.h"
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "8253.h"
 #include "8255.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl812.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl812.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl812.c	2010-04-13 02:18:56.232633024 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl812.c	2010-04-13 02:19:01.535633020 +0000
@@ -108,6 +108,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/gfp.h>
 #include "../comedidev.h"
 
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl816.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl816.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl816.c	2010-04-13 02:18:56.232633024 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl816.c	2010-04-13 02:19:01.535633020 +0000
@@ -36,6 +36,7 @@
 
 #include <linux/ioport.h>
 #include <linux/mc146818rtc.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <asm/dma.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl818.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl818.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcl818.c	2010-04-13 02:18:56.232633024 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcl818.c	2010-04-13 02:19:01.535633020 +0000
@@ -102,6 +102,7 @@
 
 #include <linux/ioport.h>
 #include <linux/mc146818rtc.h>
+#include <linux/gfp.h>
 #include <linux/delay.h>
 #include <asm/dma.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcmmio.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcmmio.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcmmio.c	2010-04-13 02:18:56.233633101 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcmmio.c	2010-04-13 02:19:01.536633052 +0000
@@ -77,6 +77,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 #include "pcm_common.h"
 #include <linux/pci.h>		/* for PCI devices */
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcmuio.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcmuio.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/pcmuio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/pcmuio.c	2010-04-13 02:19:01.536633052 +0000
@@ -76,6 +76,7 @@
 */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "../comedidev.h"
 #include "pcm_common.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/serial2002.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/serial2002.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/serial2002.c	2010-04-13 02:18:56.234633070 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/serial2002.c	2010-04-13 02:19:01.537633055 +0000
@@ -36,6 +36,7 @@
 #include <linux/delay.h>
 #include <linux/ioport.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/termios.h>
 #include <asm/ioctls.h>
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/drivers/unioxx5.c linux-2.6.34-rc4/drivers/staging/comedi/drivers/unioxx5.c
--- linux-2.6.34-rc3/drivers/staging/comedi/drivers/unioxx5.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/drivers/unioxx5.c	2010-04-13 02:19:01.537633055 +0000
@@ -44,6 +44,7 @@
 
 #include "../comedidev.h"
 #include <linux/ioport.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "unioxx5"
 #define UNIOXX5_SIZE 0x10
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/kcomedilib/kcomedilib_main.c linux-2.6.34-rc4/drivers/staging/comedi/kcomedilib/kcomedilib_main.c
--- linux-2.6.34-rc3/drivers/staging/comedi/kcomedilib/kcomedilib_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/kcomedilib/kcomedilib_main.c	2010-04-13 02:19:01.538633463 +0000
@@ -31,7 +31,6 @@
 #include <linux/delay.h>
 #include <linux/ioport.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <asm/io.h>
 
 #include "../comedi.h"
diff -urN linux-2.6.34-rc3/drivers/staging/comedi/kcomedilib/ksyms.c linux-2.6.34-rc4/drivers/staging/comedi/kcomedilib/ksyms.c
--- linux-2.6.34-rc3/drivers/staging/comedi/kcomedilib/ksyms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/comedi/kcomedilib/ksyms.c	2010-04-13 02:19:01.539633802 +0000
@@ -34,7 +34,6 @@
 #include <linux/delay.h>
 #include <linux/ioport.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 
 /* functions specific to kcomedilib */
 
diff -urN linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_hw.c linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_hw.c
--- linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_hw.c	2010-04-13 02:18:56.238633054 +0000
+++ linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_hw.c	2010-04-13 02:19:01.542570499 +0000
@@ -23,6 +23,7 @@
  **********************************************************************/
 
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "crystalhd_hw.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_lnx.c linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_lnx.c
--- linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_lnx.c	2010-04-13 02:18:56.239571578 +0000
+++ linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_lnx.c	2010-04-13 02:19:01.542570499 +0000
@@ -16,6 +16,7 @@
 ***************************************************************************/
 
 #include <linux/version.h>
+#include <linux/slab.h>
 
 #include "crystalhd_lnx.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_misc.c linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_misc.c
--- linux-2.6.34-rc3/drivers/staging/crystalhd/crystalhd_misc.c	2010-04-13 02:18:56.239571578 +0000
+++ linux-2.6.34-rc4/drivers/staging/crystalhd/crystalhd_misc.c	2010-04-13 02:19:01.543633045 +0000
@@ -24,6 +24,8 @@
  * along with this driver.  If not, see <http://www.gnu.org/licenses/>.
  **********************************************************************/
 
+#include <linux/slab.h>
+
 #include "crystalhd_misc.h"
 #include "crystalhd_lnx.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-alsa.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-alsa.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-alsa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-alsa.c	2010-04-13 02:19:01.543633045 +0000
@@ -27,6 +27,7 @@
 #include <linux/vmalloc.h>
 #include <linux/dma-mapping.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include <asm/delay.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-audio-upstream.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-audio-upstream.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-audio-upstream.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-audio-upstream.c	2010-04-13 02:19:01.544633650 +0000
@@ -32,6 +32,7 @@
 #include <linux/file.h>
 #include <linux/fcntl.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 MODULE_DESCRIPTION("v4l2 driver module for cx25821 based TV cards");
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-audups11.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-audups11.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-audups11.c	2010-04-13 02:18:56.240570455 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-audups11.c	2010-04-13 02:19:01.544633650 +0000
@@ -21,6 +21,8 @@
  *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
+
 #include "cx25821-video.h"
 
 static void buffer_queue(struct videobuf_queue *vq, struct videobuf_buffer *vb)
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-core.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-core.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-core.c	2010-04-13 02:19:01.544633650 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include "cx25821.h"
 #include "cx25821-sram.h"
 #include "cx25821-video.h"
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-video-upstream-ch2.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-video-upstream-ch2.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-video-upstream-ch2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-video-upstream-ch2.c	2010-04-13 02:19:01.544633650 +0000
@@ -31,6 +31,7 @@
 #include <linux/syscalls.h>
 #include <linux/file.h>
 #include <linux/fcntl.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 MODULE_DESCRIPTION("v4l2 driver module for cx25821 based TV cards");
diff -urN linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-video-upstream.c linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-video-upstream.c
--- linux-2.6.34-rc3/drivers/staging/cx25821/cx25821-video-upstream.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/cx25821/cx25821-video-upstream.c	2010-04-13 02:19:01.544633650 +0000
@@ -31,6 +31,7 @@
 #include <linux/syscalls.h>
 #include <linux/file.h>
 #include <linux/fcntl.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 MODULE_DESCRIPTION("v4l2 driver module for cx25821 based TV cards");
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/msm_camera.c linux-2.6.34-rc4/drivers/staging/dream/camera/msm_camera.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/msm_camera.c	2010-04-13 02:18:56.241574492 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/msm_camera.c	2010-04-13 02:19:01.545633140 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include <mach/board.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/msm_v4l2.c linux-2.6.34-rc4/drivers/staging/dream/camera/msm_v4l2.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/msm_v4l2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/msm_v4l2.c	2010-04-13 02:19:01.545633140 +0000
@@ -12,6 +12,7 @@
 #include <linux/spinlock.h>
 #include <linux/videodev2.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <media/v4l2-dev.h>
 #include <media/msm_camera.h>
 #include <mach/camera.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/msm_vfe7x.c linux-2.6.34-rc4/drivers/staging/dream/camera/msm_vfe7x.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/msm_vfe7x.c	2010-04-13 02:18:56.241574492 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/msm_vfe7x.c	2010-04-13 02:19:01.546633056 +0000
@@ -7,6 +7,7 @@
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/android_pmem.h>
+#include <linux/slab.h>
 #include <mach/msm_adsp.h>
 #include <linux/delay.h>
 #include <linux/wait.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/msm_vfe8x.c linux-2.6.34-rc4/drivers/staging/dream/camera/msm_vfe8x.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/msm_vfe8x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/msm_vfe8x.c	2010-04-13 02:19:01.546633056 +0000
@@ -1,6 +1,7 @@
 /*
  * Copyright (C) 2008-2009 QUALCOMM Incorporated.
  */
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/interrupt.h>
 #include <mach/irqs.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/mt9d112.c linux-2.6.34-rc4/drivers/staging/dream/camera/mt9d112.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/mt9d112.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/mt9d112.c	2010-04-13 02:19:01.546633056 +0000
@@ -3,6 +3,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/i2c.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/mt9p012_fox.c linux-2.6.34-rc4/drivers/staging/dream/camera/mt9p012_fox.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/mt9p012_fox.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/mt9p012_fox.c	2010-04-13 02:19:01.546633056 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/delay.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/uaccess.h>
 #include <linux/miscdevice.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/mt9t013.c linux-2.6.34-rc4/drivers/staging/dream/camera/mt9t013.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/mt9t013.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/mt9t013.c	2010-04-13 02:19:01.546633056 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/delay.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/i2c.h>
 #include <linux/uaccess.h>
 #include <linux/miscdevice.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/camera/s5k3e2fx.c linux-2.6.34-rc4/drivers/staging/dream/camera/s5k3e2fx.c
--- linux-2.6.34-rc3/drivers/staging/dream/camera/s5k3e2fx.c	2010-04-13 02:18:56.241574492 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/camera/s5k3e2fx.c	2010-04-13 02:19:01.547633080 +0000
@@ -3,6 +3,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/i2c.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/gpio_axis.c linux-2.6.34-rc4/drivers/staging/dream/gpio_axis.c
--- linux-2.6.34-rc3/drivers/staging/dream/gpio_axis.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/gpio_axis.c	2010-04-13 02:19:01.547633080 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/gpio_event.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/gpio_event.c linux-2.6.34-rc4/drivers/staging/dream/gpio_event.c
--- linux-2.6.34-rc3/drivers/staging/dream/gpio_event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/gpio_event.c	2010-04-13 02:19:01.547633080 +0000
@@ -14,6 +14,7 @@
  */
 
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/input.h>
 #include <linux/gpio_event.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/gpio_input.c linux-2.6.34-rc4/drivers/staging/dream/gpio_input.c
--- linux-2.6.34-rc3/drivers/staging/dream/gpio_input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/gpio_input.c	2010-04-13 02:19:01.547633080 +0000
@@ -19,6 +19,7 @@
 #include <linux/hrtimer.h>
 #include <linux/input.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 enum {
 	DEBOUNCE_UNSTABLE     = BIT(0),	/* Got irq, while debouncing */
diff -urN linux-2.6.34-rc3/drivers/staging/dream/gpio_matrix.c linux-2.6.34-rc4/drivers/staging/dream/gpio_matrix.c
--- linux-2.6.34-rc3/drivers/staging/dream/gpio_matrix.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/gpio_matrix.c	2010-04-13 02:19:01.547633080 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/gpio_event.h>
 #include <linux/hrtimer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/pmem.c linux-2.6.34-rc4/drivers/staging/dream/pmem.c
--- linux-2.6.34-rc3/drivers/staging/dream/pmem.c	2010-04-13 02:18:56.246633040 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/pmem.c	2010-04-13 02:19:01.552633078 +0000
@@ -23,6 +23,7 @@
 #include <linux/android_pmem.h>
 #include <linux/mempolicy.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
 #include <asm/cacheflush.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/adsp.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/adsp.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/adsp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/adsp.c	2010-04-13 02:19:01.552633078 +0000
@@ -30,6 +30,7 @@
 #include <linux/kernel.h>
 #include <linux/kthread.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/wait.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/adsp_driver.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/adsp_driver.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/adsp_driver.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/adsp_driver.c	2010-04-13 02:19:01.552633078 +0000
@@ -19,6 +19,7 @@
 #include <linux/list.h>
 #include <linux/platform_device.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #include "adsp.h"
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_aac.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_aac.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_aac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_aac.c	2010-04-13 02:19:01.552633078 +0000
@@ -24,6 +24,7 @@
 #include <linux/kthread.h>
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_amrnb.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_amrnb.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_amrnb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_amrnb.c	2010-04-13 02:19:01.552633078 +0000
@@ -32,6 +32,7 @@
 #include <linux/kthread.h>
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_evrc.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_evrc.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_evrc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_evrc.c	2010-04-13 02:19:01.553633093 +0000
@@ -27,6 +27,7 @@
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include <asm/atomic.h>
 #include <asm/ioctls.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_in.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_in.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_in.c	2010-04-13 02:19:01.553633093 +0000
@@ -23,6 +23,7 @@
 #include <linux/kthread.h>
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_mp3.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_mp3.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_mp3.c	2010-04-13 02:18:56.246633040 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_mp3.c	2010-04-13 02:19:01.553633093 +0000
@@ -23,6 +23,7 @@
 #include <linux/kthread.h>
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_out.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_out.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_out.c	2010-04-13 02:19:01.553633093 +0000
@@ -26,6 +26,7 @@
 #include <linux/debugfs.h>
 #include <linux/delay.h>
 #include <linux/wakelock.h>
+#include <linux/gfp.h>
 
 #include <linux/msm_audio.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_qcelp.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_qcelp.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audio_qcelp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audio_qcelp.c	2010-04-13 02:19:01.553633093 +0000
@@ -29,6 +29,7 @@
 #include <linux/sched.h>
 #include <linux/wait.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <asm/ioctls.h>
 #include <mach/msm_adsp.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audmgr.c linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audmgr.c
--- linux-2.6.34-rc3/drivers/staging/dream/qdsp5/audmgr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/qdsp5/audmgr.c	2010-04-13 02:19:01.553633093 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <linux/kthread.h>
 #include <linux/wait.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter.c linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter.c
--- linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter.c	2010-04-13 02:18:56.246633040 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter.c	2010-04-13 02:19:01.554633027 +0000
@@ -33,6 +33,7 @@
 #include <linux/err.h>
 #include <linux/sched.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/byteorder.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter_device.c linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter_device.c
--- linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter_device.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter_device.c	2010-04-13 02:19:01.554633027 +0000
@@ -29,6 +29,7 @@
 #include <linux/poll.h>
 #include <linux/platform_device.h>
 #include <linux/msm_rpcrouter.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/byteorder.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter_servers.c linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter_servers.c
--- linux-2.6.34-rc3/drivers/staging/dream/smd/smd_rpcrouter_servers.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/smd/smd_rpcrouter_servers.c	2010-04-13 02:19:01.554633027 +0000
@@ -27,6 +27,7 @@
 #include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <linux/wakelock.h>
+#include <linux/slab.h>
 
 #include <linux/msm_rpcrouter.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/dream/synaptics_i2c_rmi.c linux-2.6.34-rc4/drivers/staging/dream/synaptics_i2c_rmi.c
--- linux-2.6.34-rc3/drivers/staging/dream/synaptics_i2c_rmi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/dream/synaptics_i2c_rmi.c	2010-04-13 02:19:01.554633027 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/module.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #ifdef CONFIG_HAS_EARLYSUSPEND
 #include <linux/earlysuspend.h>
 #endif
diff -urN linux-2.6.34-rc3/drivers/staging/dt3155/allocator.c linux-2.6.34-rc4/drivers/staging/dt3155/allocator.c
--- linux-2.6.34-rc3/drivers/staging/dt3155/allocator.c	2010-04-13 02:18:56.246633040 +0000
+++ linux-2.6.34-rc4/drivers/staging/dt3155/allocator.c	2010-04-13 02:19:01.554633027 +0000
@@ -55,6 +55,7 @@
 #include <linux/types.h>
 #include <linux/mm.h>	/* PAGE_ALIGN() */
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/dt3155/dt3155_isr.c linux-2.6.34-rc4/drivers/staging/dt3155/dt3155_isr.c
--- linux-2.6.34-rc3/drivers/staging/dt3155/dt3155_isr.c	2010-04-13 02:18:56.248633011 +0000
+++ linux-2.6.34-rc4/drivers/staging/dt3155/dt3155_isr.c	2010-04-13 02:19:01.556633044 +0000
@@ -45,7 +45,7 @@
 */
 
 #include <asm/system.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/types.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et1310_eeprom.c linux-2.6.34-rc4/drivers/staging/et131x/et1310_eeprom.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et1310_eeprom.c	2010-04-13 02:18:56.249571673 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et1310_eeprom.c	2010-04-13 02:19:01.557633089 +0000
@@ -66,7 +66,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et1310_mac.c linux-2.6.34-rc4/drivers/staging/et131x/et1310_mac.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et1310_mac.c	2010-04-13 02:18:56.250570547 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et1310_mac.c	2010-04-13 02:19:01.558633017 +0000
@@ -65,7 +65,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et1310_phy.c linux-2.6.34-rc4/drivers/staging/et131x/et1310_phy.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et1310_phy.c	2010-04-13 02:18:56.251633011 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et1310_phy.c	2010-04-13 02:19:01.559633497 +0000
@@ -66,7 +66,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et1310_pm.c linux-2.6.34-rc4/drivers/staging/et131x/et1310_pm.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et1310_pm.c	2010-04-13 02:18:56.251633011 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et1310_pm.c	2010-04-13 02:19:01.559633497 +0000
@@ -65,7 +65,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et131x_initpci.c linux-2.6.34-rc4/drivers/staging/et131x/et131x_initpci.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et131x_initpci.c	2010-04-13 02:18:56.253570367 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et131x_initpci.c	2010-04-13 02:19:01.561570479 +0000
@@ -68,7 +68,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et131x_isr.c linux-2.6.34-rc4/drivers/staging/et131x/et131x_isr.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et131x_isr.c	2010-04-13 02:18:56.253570367 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et131x_isr.c	2010-04-13 02:19:01.561570479 +0000
@@ -66,7 +66,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/et131x/et131x_netdev.c linux-2.6.34-rc4/drivers/staging/et131x/et131x_netdev.c
--- linux-2.6.34-rc3/drivers/staging/et131x/et131x_netdev.c	2010-04-13 02:18:56.254570489 +0000
+++ linux-2.6.34-rc4/drivers/staging/et131x/et131x_netdev.c	2010-04-13 02:19:01.562570515 +0000
@@ -65,7 +65,6 @@
 
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/go7007-driver.c linux-2.6.34-rc4/drivers/staging/go7007/go7007-driver.c
--- linux-2.6.34-rc3/drivers/staging/go7007/go7007-driver.c	2010-04-13 02:18:56.254570489 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/go7007-driver.c	2010-04-13 02:19:01.563633075 +0000
@@ -29,6 +29,7 @@
 #include <linux/firmware.h>
 #include <linux/mutex.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <linux/videodev2.h>
 #include <media/tuner.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/go7007-fw.c linux-2.6.34-rc4/drivers/staging/go7007/go7007-fw.c
--- linux-2.6.34-rc3/drivers/staging/go7007/go7007-fw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/go7007-fw.c	2010-04-13 02:19:01.563633075 +0000
@@ -31,6 +31,7 @@
 #include <linux/device.h>
 #include <linux/i2c.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 
 #include "go7007-priv.h"
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/go7007-v4l2.c linux-2.6.34-rc4/drivers/staging/go7007/go7007-v4l2.c
--- linux-2.6.34-rc3/drivers/staging/go7007/go7007-v4l2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/go7007-v4l2.c	2010-04-13 02:19:01.563633075 +0000
@@ -21,6 +21,7 @@
 #include <linux/delay.h>
 #include <linux/sched.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/unistd.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/s2250-board.c linux-2.6.34-rc4/drivers/staging/go7007/s2250-board.c
--- linux-2.6.34-rc3/drivers/staging/go7007/s2250-board.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/s2250-board.c	2010-04-13 02:19:01.564633018 +0000
@@ -20,6 +20,7 @@
 #include <linux/usb.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-i2c-drv.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/s2250-loader.c linux-2.6.34-rc4/drivers/staging/go7007/s2250-loader.c
--- linux-2.6.34-rc3/drivers/staging/go7007/s2250-loader.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/s2250-loader.c	2010-04-13 02:19:01.564633018 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/usb.h>
 #include <dvb-usb.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/snd-go7007.c linux-2.6.34-rc4/drivers/staging/go7007/snd-go7007.c
--- linux-2.6.34-rc3/drivers/staging/go7007/snd-go7007.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/snd-go7007.c	2010-04-13 02:19:01.564633018 +0000
@@ -28,6 +28,7 @@
 #include <linux/i2c.h>
 #include <linux/mutex.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <asm/system.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/wis-saa7113.c linux-2.6.34-rc4/drivers/staging/go7007/wis-saa7113.c
--- linux-2.6.34-rc3/drivers/staging/go7007/wis-saa7113.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/wis-saa7113.c	2010-04-13 02:19:01.564633018 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 
 #include "wis-i2c.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/wis-saa7115.c linux-2.6.34-rc4/drivers/staging/go7007/wis-saa7115.c
--- linux-2.6.34-rc3/drivers/staging/go7007/wis-saa7115.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/wis-saa7115.c	2010-04-13 02:19:01.564633018 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 
 #include "wis-i2c.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/wis-sony-tuner.c linux-2.6.34-rc4/drivers/staging/go7007/wis-sony-tuner.c
--- linux-2.6.34-rc3/drivers/staging/go7007/wis-sony-tuner.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/wis-sony-tuner.c	2010-04-13 02:19:01.564633018 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
+#include <linux/slab.h>
 #include <media/tuner.h>
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/wis-tw2804.c linux-2.6.34-rc4/drivers/staging/go7007/wis-tw2804.c
--- linux-2.6.34-rc3/drivers/staging/go7007/wis-tw2804.c	2010-04-13 02:18:56.255633037 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/wis-tw2804.c	2010-04-13 02:19:01.564633018 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 
 #include "wis-i2c.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/go7007/wis-tw9903.c linux-2.6.34-rc4/drivers/staging/go7007/wis-tw9903.c
--- linux-2.6.34-rc3/drivers/staging/go7007/wis-tw9903.c	2010-04-13 02:18:56.256633012 +0000
+++ linux-2.6.34-rc4/drivers/staging/go7007/wis-tw9903.c	2010-04-13 02:19:01.564633018 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/videodev2.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 
 #include "wis-i2c.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/hv/Channel.c linux-2.6.34-rc4/drivers/staging/hv/Channel.c
--- linux-2.6.34-rc3/drivers/staging/hv/Channel.c	2010-04-13 02:18:56.256633012 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/Channel.c	2010-04-13 02:19:01.565633057 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include "osd.h"
 #include "logging.h"
 #include "VmbusPrivate.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/ChannelMgmt.c linux-2.6.34-rc4/drivers/staging/hv/ChannelMgmt.c
--- linux-2.6.34-rc3/drivers/staging/hv/ChannelMgmt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/ChannelMgmt.c	2010-04-13 02:19:01.565633057 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include "osd.h"
 #include "logging.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/Connection.c linux-2.6.34-rc4/drivers/staging/hv/Connection.c
--- linux-2.6.34-rc3/drivers/staging/hv/Connection.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/Connection.c	2010-04-13 02:19:01.565633057 +0000
@@ -22,6 +22,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include "osd.h"
 #include "logging.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/Hv.c linux-2.6.34-rc4/drivers/staging/hv/Hv.c
--- linux-2.6.34-rc3/drivers/staging/hv/Hv.c	2010-04-13 02:18:56.256633012 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/Hv.c	2010-04-13 02:19:01.565633057 +0000
@@ -21,6 +21,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include "osd.h"
 #include "logging.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/NetVsc.c linux-2.6.34-rc4/drivers/staging/hv/NetVsc.c
--- linux-2.6.34-rc3/drivers/staging/hv/NetVsc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/NetVsc.c	2010-04-13 02:19:01.566633165 +0000
@@ -22,6 +22,7 @@
 #include <linux/mm.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include "osd.h"
 #include "logging.h"
 #include "NetVsc.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/RndisFilter.c linux-2.6.34-rc4/drivers/staging/hv/RndisFilter.c
--- linux-2.6.34-rc3/drivers/staging/hv/RndisFilter.c	2010-04-13 02:18:56.257571053 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/RndisFilter.c	2010-04-13 02:19:01.566633165 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include "osd.h"
 #include "logging.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/StorVsc.c linux-2.6.34-rc4/drivers/staging/hv/StorVsc.c
--- linux-2.6.34-rc3/drivers/staging/hv/StorVsc.c	2010-04-13 02:18:56.257571053 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/StorVsc.c	2010-04-13 02:19:01.566633165 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/delay.h>
 #include "osd.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/Vmbus.c linux-2.6.34-rc4/drivers/staging/hv/Vmbus.c
--- linux-2.6.34-rc3/drivers/staging/hv/Vmbus.c	2010-04-13 02:18:56.257571053 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/Vmbus.c	2010-04-13 02:19:01.567570993 +0000
@@ -21,6 +21,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include "osd.h"
 #include "logging.h"
 #include "VersionInfo.h"
diff -urN linux-2.6.34-rc3/drivers/staging/hv/blkvsc_drv.c linux-2.6.34-rc4/drivers/staging/hv/blkvsc_drv.c
--- linux-2.6.34-rc3/drivers/staging/hv/blkvsc_drv.c	2010-04-13 02:18:56.258570476 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/blkvsc_drv.c	2010-04-13 02:19:01.567570993 +0000
@@ -25,6 +25,7 @@
 #include <linux/major.h>
 #include <linux/delay.h>
 #include <linux/hdreg.h>
+#include <linux/slab.h>
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_eh.h>
diff -urN linux-2.6.34-rc3/drivers/staging/hv/netvsc_drv.c linux-2.6.34-rc4/drivers/staging/hv/netvsc_drv.c
--- linux-2.6.34-rc3/drivers/staging/hv/netvsc_drv.c	2010-04-13 02:18:56.258570476 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/netvsc_drv.c	2010-04-13 02:19:01.567570993 +0000
@@ -29,6 +29,7 @@
 #include <linux/etherdevice.h>
 #include <linux/skbuff.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/route.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/drivers/staging/hv/osd.c linux-2.6.34-rc4/drivers/staging/hv/osd.c
--- linux-2.6.34-rc3/drivers/staging/hv/osd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/osd.c	2010-04-13 02:19:01.567570993 +0000
@@ -40,6 +40,7 @@
 #include <linux/time.h>
 #include <linux/io.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include "osd.h"
 
 struct osd_callback_struct {
diff -urN linux-2.6.34-rc3/drivers/staging/hv/storvsc_drv.c linux-2.6.34-rc4/drivers/staging/hv/storvsc_drv.c
--- linux-2.6.34-rc3/drivers/staging/hv/storvsc_drv.c	2010-04-13 02:18:56.258570476 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/storvsc_drv.c	2010-04-13 02:19:01.568633038 +0000
@@ -19,6 +19,7 @@
  *   Hank Janssen  <hjanssen@microsoft.com>
  */
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/device.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/drivers/staging/hv/vmbus_drv.c linux-2.6.34-rc4/drivers/staging/hv/vmbus_drv.c
--- linux-2.6.34-rc3/drivers/staging/hv/vmbus_drv.c	2010-04-13 02:18:56.258570476 +0000
+++ linux-2.6.34-rc4/drivers/staging/hv/vmbus_drv.c	2010-04-13 02:19:01.568633038 +0000
@@ -26,6 +26,7 @@
 #include <linux/sysctl.h>
 #include <linux/pci.h>
 #include <linux/dmi.h>
+#include <linux/slab.h>
 #include "VersionInfo.h"
 #include "osd.h"
 #include "logging.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/accel/kxsd9.c linux-2.6.34-rc4/drivers/staging/iio/accel/kxsd9.c
--- linux-2.6.34-rc3/drivers/staging/iio/accel/kxsd9.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/accel/kxsd9.c	2010-04-13 02:19:01.568633038 +0000
@@ -25,6 +25,7 @@
 #include <linux/sysfs.h>
 #include <linux/rtc.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "../iio.h"
 #include "../sysfs.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/accel/lis3l02dq_core.c linux-2.6.34-rc4/drivers/staging/iio/accel/lis3l02dq_core.c
--- linux-2.6.34-rc3/drivers/staging/iio/accel/lis3l02dq_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/accel/lis3l02dq_core.c	2010-04-13 02:19:01.568633038 +0000
@@ -20,6 +20,7 @@
 #include <linux/device.h>
 #include <linux/kernel.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 
 #include <linux/sysfs.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/drivers/staging/iio/accel/lis3l02dq_ring.c linux-2.6.34-rc4/drivers/staging/iio/accel/lis3l02dq_ring.c
--- linux-2.6.34-rc3/drivers/staging/iio/accel/lis3l02dq_ring.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/accel/lis3l02dq_ring.c	2010-04-13 02:19:01.569633062 +0000
@@ -8,6 +8,7 @@
 #include <linux/spi/spi.h>
 #include <linux/sysfs.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include "../iio.h"
 #include "../sysfs.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/accel/sca3000_core.c linux-2.6.34-rc4/drivers/staging/iio/accel/sca3000_core.c
--- linux-2.6.34-rc3/drivers/staging/iio/accel/sca3000_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/accel/sca3000_core.c	2010-04-13 02:19:01.569633062 +0000
@@ -14,6 +14,7 @@
 #include <linux/gpio.h>
 #include <linux/fs.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/spi/spi.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/staging/iio/accel/sca3000_ring.c linux-2.6.34-rc4/drivers/staging/iio/accel/sca3000_ring.c
--- linux-2.6.34-rc3/drivers/staging/iio/accel/sca3000_ring.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/accel/sca3000_ring.c	2010-04-13 02:19:01.569633062 +0000
@@ -13,6 +13,7 @@
 #include <linux/gpio.h>
 #include <linux/fs.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/spi/spi.h>
 #include <linux/sysfs.h>
diff -urN linux-2.6.34-rc3/drivers/staging/iio/adc/max1363_core.c linux-2.6.34-rc4/drivers/staging/iio/adc/max1363_core.c
--- linux-2.6.34-rc3/drivers/staging/iio/adc/max1363_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/adc/max1363_core.c	2010-04-13 02:19:01.569633062 +0000
@@ -33,6 +33,7 @@
 #include <linux/i2c.h>
 #include <linux/rtc.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 
 #include "../iio.h"
 #include "../sysfs.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/adc/max1363_ring.c linux-2.6.34-rc4/drivers/staging/iio/adc/max1363_ring.c
--- linux-2.6.34-rc3/drivers/staging/iio/adc/max1363_ring.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/adc/max1363_ring.c	2010-04-13 02:19:01.569633062 +0000
@@ -12,6 +12,7 @@
 #include <linux/gpio.h>
 #include <linux/workqueue.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/sysfs.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/drivers/staging/iio/industrialio-core.c linux-2.6.34-rc4/drivers/staging/iio/industrialio-core.c
--- linux-2.6.34-rc3/drivers/staging/iio/industrialio-core.c	2010-04-13 02:18:56.259571867 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/industrialio-core.c	2010-04-13 02:19:01.569633062 +0000
@@ -21,6 +21,7 @@
 #include <linux/sched.h>
 #include <linux/wait.h>
 #include <linux/cdev.h>
+#include <linux/slab.h>
 #include "iio.h"
 #include "trigger_consumer.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/iio/industrialio-ring.c linux-2.6.34-rc4/drivers/staging/iio/industrialio-ring.c
--- linux-2.6.34-rc3/drivers/staging/iio/industrialio-ring.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/industrialio-ring.c	2010-04-13 02:19:01.569633062 +0000
@@ -21,6 +21,7 @@
 #include <linux/module.h>
 #include <linux/cdev.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 
 #include "iio.h"
 #include "ring_generic.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/industrialio-trigger.c linux-2.6.34-rc4/drivers/staging/iio/industrialio-trigger.c
--- linux-2.6.34-rc3/drivers/staging/iio/industrialio-trigger.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/industrialio-trigger.c	2010-04-13 02:19:01.570633020 +0000
@@ -14,6 +14,7 @@
 #include <linux/device.h>
 #include <linux/interrupt.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include "iio.h"
 #include "trigger.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/light/tsl2563.c linux-2.6.34-rc4/drivers/staging/iio/light/tsl2563.c
--- linux-2.6.34-rc3/drivers/staging/iio/light/tsl2563.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/light/tsl2563.c	2010-04-13 02:19:01.570633020 +0000
@@ -34,6 +34,7 @@
 #include <linux/pm.h>
 #include <linux/hwmon.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include "../iio.h"
 #include "tsl2563.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/ring_sw.c linux-2.6.34-rc4/drivers/staging/iio/ring_sw.c
--- linux-2.6.34-rc3/drivers/staging/iio/ring_sw.c	2010-04-13 02:18:56.259571867 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/ring_sw.c	2010-04-13 02:19:01.570633020 +0000
@@ -7,6 +7,7 @@
  * the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/staging/iio/trigger/iio-trig-gpio.c linux-2.6.34-rc4/drivers/staging/iio/trigger/iio-trig-gpio.c
--- linux-2.6.34-rc3/drivers/staging/iio/trigger/iio-trig-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/trigger/iio-trig-gpio.c	2010-04-13 02:19:01.570633020 +0000
@@ -21,6 +21,7 @@
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include "../iio.h"
 #include "../trigger.h"
diff -urN linux-2.6.34-rc3/drivers/staging/iio/trigger/iio-trig-periodic-rtc.c linux-2.6.34-rc4/drivers/staging/iio/trigger/iio-trig-periodic-rtc.c
--- linux-2.6.34-rc3/drivers/staging/iio/trigger/iio-trig-periodic-rtc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/iio/trigger/iio-trig-periodic-rtc.c	2010-04-13 02:19:01.570633020 +0000
@@ -14,6 +14,7 @@
 #include <linux/platform_device.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/rtc.h>
 #include "../iio.h"
 #include "../trigger.h"
diff -urN linux-2.6.34-rc3/drivers/staging/line6/capture.c linux-2.6.34-rc4/drivers/staging/line6/capture.c
--- linux-2.6.34-rc3/drivers/staging/line6/capture.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/capture.c	2010-04-13 02:19:01.570633020 +0000
@@ -11,6 +11,8 @@
 
 #include "driver.h"
 
+#include <linux/slab.h>
+
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/drivers/staging/line6/driver.c linux-2.6.34-rc4/drivers/staging/line6/driver.c
--- linux-2.6.34-rc3/drivers/staging/line6/driver.c	2010-04-13 02:18:56.259571867 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/driver.c	2010-04-13 02:19:01.571633031 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "audio.h"
diff -urN linux-2.6.34-rc3/drivers/staging/line6/dumprequest.c linux-2.6.34-rc4/drivers/staging/line6/dumprequest.c
--- linux-2.6.34-rc3/drivers/staging/line6/dumprequest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/dumprequest.c	2010-04-13 02:19:01.571633031 +0000
@@ -10,6 +10,9 @@
  */
 
 #include "driver.h"
+
+#include <linux/slab.h>
+
 #include "dumprequest.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/staging/line6/midi.c linux-2.6.34-rc4/drivers/staging/line6/midi.c
--- linux-2.6.34-rc3/drivers/staging/line6/midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/midi.c	2010-04-13 02:19:01.571633031 +0000
@@ -12,6 +12,7 @@
 #include "driver.h"
 
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/rawmidi.h>
diff -urN linux-2.6.34-rc3/drivers/staging/line6/pcm.c linux-2.6.34-rc4/drivers/staging/line6/pcm.c
--- linux-2.6.34-rc3/drivers/staging/line6/pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/pcm.c	2010-04-13 02:19:01.571633031 +0000
@@ -11,6 +11,8 @@
 
 #include "driver.h"
 
+#include <linux/slab.h>
+
 #include <sound/core.h>
 #include <sound/control.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/drivers/staging/line6/playback.c linux-2.6.34-rc4/drivers/staging/line6/playback.c
--- linux-2.6.34-rc3/drivers/staging/line6/playback.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/playback.c	2010-04-13 02:19:01.571633031 +0000
@@ -11,6 +11,8 @@
 
 #include "driver.h"
 
+#include <linux/slab.h>
+
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/drivers/staging/line6/pod.c linux-2.6.34-rc4/drivers/staging/line6/pod.c
--- linux-2.6.34-rc3/drivers/staging/line6/pod.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/pod.c	2010-04-13 02:19:01.571633031 +0000
@@ -11,6 +11,8 @@
 
 #include "driver.h"
 
+#include <linux/slab.h>
+
 #include "audio.h"
 #include "capture.h"
 #include "control.h"
diff -urN linux-2.6.34-rc3/drivers/staging/line6/variax.c linux-2.6.34-rc4/drivers/staging/line6/variax.c
--- linux-2.6.34-rc3/drivers/staging/line6/variax.c	2010-04-13 02:18:56.259571867 +0000
+++ linux-2.6.34-rc4/drivers/staging/line6/variax.c	2010-04-13 02:19:01.571633031 +0000
@@ -11,6 +11,8 @@
 
 #include "driver.h"
 
+#include <linux/slab.h>
+
 #include "audio.h"
 #include "control.h"
 #include "variax.h"
diff -urN linux-2.6.34-rc3/drivers/staging/netwave/netwave_cs.c linux-2.6.34-rc4/drivers/staging/netwave/netwave_cs.c
--- linux-2.6.34-rc3/drivers/staging/netwave/netwave_cs.c	2010-04-13 02:18:56.260570507 +0000
+++ linux-2.6.34-rc4/drivers/staging/netwave/netwave_cs.c	2010-04-13 02:19:01.573633085 +0000
@@ -46,7 +46,6 @@
 #include <linux/ptrace.h>
 #include <linux/ioport.h>
 #include <linux/in.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/drivers/staging/octeon/ethernet-mem.c linux-2.6.34-rc4/drivers/staging/octeon/ethernet-mem.c
--- linux-2.6.34-rc3/drivers/staging/octeon/ethernet-mem.c	2010-04-13 02:18:56.261633043 +0000
+++ linux-2.6.34-rc4/drivers/staging/octeon/ethernet-mem.c	2010-04-13 02:19:01.573633085 +0000
@@ -26,6 +26,7 @@
 **********************************************************************/
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include <asm/octeon/octeon.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/octeon/ethernet.c linux-2.6.34-rc4/drivers/staging/octeon/ethernet.c
--- linux-2.6.34-rc3/drivers/staging/octeon/ethernet.c	2010-04-13 02:18:56.263633036 +0000
+++ linux-2.6.34-rc4/drivers/staging/octeon/ethernet.c	2010-04-13 02:19:01.576633063 +0000
@@ -30,6 +30,7 @@
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/phy.h>
+#include <linux/slab.h>
 
 #include <net/dst.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/otus/ioctl.c linux-2.6.34-rc4/drivers/staging/otus/ioctl.c
--- linux-2.6.34-rc3/drivers/staging/otus/ioctl.c	2010-04-13 02:18:56.269571783 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/ioctl.c	2010-04-13 02:19:01.582633014 +0000
@@ -23,6 +23,7 @@
 /*     Platform dependent.                                              */
 /*                                                                      */
 /************************************************************************/
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/if_arp.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/otus/usbdrv.c linux-2.6.34-rc4/drivers/staging/otus/usbdrv.c
--- linux-2.6.34-rc3/drivers/staging/otus/usbdrv.c	2010-04-13 02:18:56.269571783 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/usbdrv.c	2010-04-13 02:19:01.582633014 +0000
@@ -38,6 +38,7 @@
 
 #include "linux/netlink.h"
 #include "linux/rtnetlink.h"
+#include "linux/slab.h"
 
 #include <net/iw_handler.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/otus/usbdrv.h linux-2.6.34-rc4/drivers/staging/otus/usbdrv.h
--- linux-2.6.34-rc3/drivers/staging/otus/usbdrv.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/usbdrv.h	2010-04-13 02:19:01.582633014 +0000
@@ -38,6 +38,7 @@
 #include <linux/uaccess.h>
 #include <linux/wireless.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 
 #include "zdcompat.h"
diff -urN linux-2.6.34-rc3/drivers/staging/otus/wrap_mem.c linux-2.6.34-rc4/drivers/staging/otus/wrap_mem.c
--- linux-2.6.34-rc3/drivers/staging/otus/wrap_mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/wrap_mem.c	2010-04-13 02:19:01.582633014 +0000
@@ -27,6 +27,7 @@
 #include "usbdrv.h"
 
 #include <linux/netlink.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 
 /* Memory management */
diff -urN linux-2.6.34-rc3/drivers/staging/otus/wrap_pkt.c linux-2.6.34-rc4/drivers/staging/otus/wrap_pkt.c
--- linux-2.6.34-rc3/drivers/staging/otus/wrap_pkt.c	2010-04-13 02:18:56.269571783 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/wrap_pkt.c	2010-04-13 02:19:01.582633014 +0000
@@ -28,6 +28,7 @@
 #include "usbdrv.h"
 
 #include <linux/netlink.h>
+#include <linux/gfp.h>
 #include <net/iw_handler.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/staging/otus/wrap_usb.c linux-2.6.34-rc4/drivers/staging/otus/wrap_usb.c
--- linux-2.6.34-rc3/drivers/staging/otus/wrap_usb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/wrap_usb.c	2010-04-13 02:19:01.582633014 +0000
@@ -28,6 +28,7 @@
 #include "usbdrv.h"
 
 #include <linux/netlink.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 
 extern void zfLnxInitUsbTxQ(zdev_t *dev);
diff -urN linux-2.6.34-rc3/drivers/staging/otus/wwrap.c linux-2.6.34-rc4/drivers/staging/otus/wwrap.c
--- linux-2.6.34-rc3/drivers/staging/otus/wwrap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/wwrap.c	2010-04-13 02:19:01.583633070 +0000
@@ -26,6 +26,7 @@
 #include "usbdrv.h"
 
 #include <linux/netlink.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 
 extern void zfiRecv80211(zdev_t* dev, zbuf_t* buf, struct zsAdditionInfo* addInfo);
diff -urN linux-2.6.34-rc3/drivers/staging/otus/zdusb.c linux-2.6.34-rc4/drivers/staging/otus/zdusb.c
--- linux-2.6.34-rc3/drivers/staging/otus/zdusb.c	2010-04-13 02:18:56.269571783 +0000
+++ linux-2.6.34-rc4/drivers/staging/otus/zdusb.c	2010-04-13 02:19:01.583633070 +0000
@@ -29,6 +29,7 @@
 #endif
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "usbdrv.h"
diff -urN linux-2.6.34-rc3/drivers/staging/poch/poch.c linux-2.6.34-rc4/drivers/staging/poch/poch.c
--- linux-2.6.34-rc3/drivers/staging/poch/poch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/poch/poch.c	2010-04-13 02:19:01.584633142 +0000
@@ -21,6 +21,7 @@
 #include <linux/ioctl.h>
 #include <linux/io.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "poch.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/pohmelfs/config.c linux-2.6.34-rc4/drivers/staging/pohmelfs/config.c
--- linux-2.6.34-rc3/drivers/staging/pohmelfs/config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/pohmelfs/config.c	2010-04-13 02:19:01.585633052 +0000
@@ -20,6 +20,7 @@
 #include <linux/mutex.h>
 #include <linux/string.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 
 #include "netfs.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/pohmelfs/dir.c linux-2.6.34-rc4/drivers/staging/pohmelfs/dir.c
--- linux-2.6.34-rc3/drivers/staging/pohmelfs/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/pohmelfs/dir.c	2010-04-13 02:19:01.585633052 +0000
@@ -17,6 +17,7 @@
 #include <linux/fs.h>
 #include <linux/jhash.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 
 #include "netfs.h"
diff -urN linux-2.6.34-rc3/drivers/staging/pohmelfs/lock.c linux-2.6.34-rc4/drivers/staging/pohmelfs/lock.c
--- linux-2.6.34-rc3/drivers/staging/pohmelfs/lock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/pohmelfs/lock.c	2010-04-13 02:19:01.585633052 +0000
@@ -17,7 +17,6 @@
 #include <linux/backing-dev.h>
 #include <linux/fs.h>
 #include <linux/fsnotify.h>
-#include <linux/slab.h>
 #include <linux/mempool.h>
 
 #include "netfs.h"
diff -urN linux-2.6.34-rc3/drivers/staging/pohmelfs/net.c linux-2.6.34-rc4/drivers/staging/pohmelfs/net.c
--- linux-2.6.34-rc3/drivers/staging/pohmelfs/net.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/pohmelfs/net.c	2010-04-13 02:19:01.585633052 +0000
@@ -20,6 +20,7 @@
 #include <linux/kthread.h>
 #include <linux/pagemap.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 #include <linux/syscalls.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/staging/pohmelfs/path_entry.c linux-2.6.34-rc4/drivers/staging/pohmelfs/path_entry.c
--- linux-2.6.34-rc3/drivers/staging/pohmelfs/path_entry.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/pohmelfs/path_entry.c	2010-04-13 02:19:01.586633055 +0000
@@ -14,7 +14,6 @@
  */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/ktime.h>
 #include <linux/fs_struct.h>
diff -urN linux-2.6.34-rc3/drivers/staging/ramzswap/ramzswap_drv.c linux-2.6.34-rc4/drivers/staging/ramzswap/ramzswap_drv.c
--- linux-2.6.34-rc3/drivers/staging/ramzswap/ramzswap_drv.c	2010-04-13 02:18:56.272633057 +0000
+++ linux-2.6.34-rc4/drivers/staging/ramzswap/ramzswap_drv.c	2010-04-13 02:19:01.587633048 +0000
@@ -23,6 +23,7 @@
 #include <linux/device.h>
 #include <linux/genhd.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <linux/lzo.h>
 #include <linux/string.h>
 #include <linux/swap.h>
diff -urN linux-2.6.34-rc3/drivers/staging/rt2860/pci_main_dev.c linux-2.6.34-rc4/drivers/staging/rt2860/pci_main_dev.c
--- linux-2.6.34-rc3/drivers/staging/rt2860/pci_main_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/rt2860/pci_main_dev.c	2010-04-13 02:19:01.591570642 +0000
@@ -37,6 +37,7 @@
 
 #include "rt_config.h"
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 /* Following information will be show when you run 'modinfo' */
 /* *** If you have a solution for the bug in current version of driver, please mail to me. */
diff -urN linux-2.6.34-rc3/drivers/staging/rt2860/rt_linux.c linux-2.6.34-rc4/drivers/staging/rt2860/rt_linux.c
--- linux-2.6.34-rc3/drivers/staging/rt2860/rt_linux.c	2010-04-13 02:18:56.276570486 +0000
+++ linux-2.6.34-rc4/drivers/staging/rt2860/rt_linux.c	2010-04-13 02:19:01.592570651 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/firmware.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "rt_config.h"
 
 unsigned long RTDebugLevel = RT_DEBUG_ERROR;
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c linux-2.6.34-rc4/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c
--- linux-2.6.34-rc3/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c	2010-04-13 02:18:56.282633062 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c	2010-04-13 02:19:01.598633060 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/random.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8187se/ieee80211/ieee80211_wx.c linux-2.6.34-rc4/drivers/staging/rtl8187se/ieee80211/ieee80211_wx.c
--- linux-2.6.34-rc3/drivers/staging/rtl8187se/ieee80211/ieee80211_wx.c	2010-04-13 02:18:56.282633062 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8187se/ieee80211/ieee80211_wx.c	2010-04-13 02:19:01.598633060 +0000
@@ -31,6 +31,7 @@
 ******************************************************************************/
 #include <linux/wireless.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "ieee80211.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8187se/r8180_core.c linux-2.6.34-rc4/drivers/staging/rtl8187se/r8180_core.c
--- linux-2.6.34-rc3/drivers/staging/rtl8187se/r8180_core.c	2010-04-13 02:18:56.284633018 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8187se/r8180_core.c	2010-04-13 02:19:01.600570958 +0000
@@ -30,6 +30,7 @@
 #undef RX_DONT_PASS_UL
 #undef DUMMY_RX
 
+#include <linux/slab.h>
 #include <linux/syscalls.h>
 #include <linux/eeprom_93cx6.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/ieee80211_softmac.c linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/ieee80211_softmac.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/ieee80211_softmac.c	2010-04-13 02:18:56.289571883 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/ieee80211_softmac.c	2010-04-13 02:19:01.605633797 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/random.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include <asm/uaccess.h>
 #ifdef ENABLE_DOT11D
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/ieee80211_wx.c linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/ieee80211_wx.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/ieee80211_wx.c	2010-04-13 02:18:56.289571883 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/ieee80211_wx.c	2010-04-13 02:19:01.606633124 +0000
@@ -32,6 +32,7 @@
 #include <linux/wireless.h>
 #include <linux/version.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "ieee80211.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/rtl819x_TSProc.c linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/rtl819x_TSProc.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192e/ieee80211/rtl819x_TSProc.c	2010-04-13 02:18:56.290570487 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192e/ieee80211/rtl819x_TSProc.c	2010-04-13 02:19:01.607633076 +0000
@@ -1,5 +1,6 @@
 #include "ieee80211.h"
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include "rtl819x_TS.h"
 
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2,5,0)
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192e/r8192E_core.c linux-2.6.34-rc4/drivers/staging/rtl8192e/r8192E_core.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192e/r8192E_core.c	2010-04-13 02:18:56.292633103 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192e/r8192E_core.c	2010-04-13 02:19:01.609633598 +0000
@@ -47,6 +47,7 @@
 
 //#define CONFIG_RTL8192_IO_MAP
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include "r8192E_hw.h"
 #include "r8192E.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/ieee80211_softmac.c linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/ieee80211_softmac.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/ieee80211_softmac.c	2010-04-13 02:18:56.298633064 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/ieee80211_softmac.c	2010-04-13 02:19:01.615633029 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/random.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include <asm/uaccess.h>
 #include "dot11d.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/ieee80211_wx.c linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/ieee80211_wx.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/ieee80211_wx.c	2010-04-13 02:18:56.298633064 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/ieee80211_wx.c	2010-04-13 02:19:01.615633029 +0000
@@ -31,6 +31,7 @@
 ******************************************************************************/
 #include <linux/wireless.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "ieee80211.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/rtl819x_TSProc.c linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/rtl819x_TSProc.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192su/ieee80211/rtl819x_TSProc.c	2010-04-13 02:18:56.299572095 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192su/ieee80211/rtl819x_TSProc.c	2010-04-13 02:19:01.616633068 +0000
@@ -1,5 +1,6 @@
 #include "ieee80211.h"
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include "rtl819x_TS.h"
 
 void TsSetupTimeOut(unsigned long data)
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192su/r8192U_core.c linux-2.6.34-rc4/drivers/staging/rtl8192su/r8192U_core.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192su/r8192U_core.c	2010-04-13 02:18:56.306633027 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192su/r8192U_core.c	2010-04-13 02:19:01.623633039 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #undef LOOP_TEST
 #undef DUMP_RX
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/ieee80211_softmac.c linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/ieee80211_softmac.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/ieee80211_softmac.c	2010-04-13 02:18:56.309571858 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/ieee80211_softmac.c	2010-04-13 02:19:01.626633098 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/random.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include <asm/uaccess.h>
 #ifdef ENABLE_DOT11D
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/ieee80211_wx.c linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/ieee80211_wx.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/ieee80211_wx.c	2010-04-13 02:18:56.309571858 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/ieee80211_wx.c	2010-04-13 02:19:01.627633122 +0000
@@ -32,6 +32,7 @@
 #include <linux/wireless.h>
 #include <linux/version.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 #include "ieee80211.h"
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/rtl819x_TSProc.c linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/rtl819x_TSProc.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192u/ieee80211/rtl819x_TSProc.c	2010-04-13 02:18:56.309571858 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192u/ieee80211/rtl819x_TSProc.c	2010-04-13 02:19:01.627633122 +0000
@@ -1,5 +1,6 @@
 #include "ieee80211.h"
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include "rtl819x_TS.h"
 
 void TsSetupTimeOut(unsigned long data)
diff -urN linux-2.6.34-rc3/drivers/staging/rtl8192u/r8192U_core.c linux-2.6.34-rc4/drivers/staging/rtl8192u/r8192U_core.c
--- linux-2.6.34-rc3/drivers/staging/rtl8192u/r8192U_core.c	2010-04-13 02:18:56.310570465 +0000
+++ linux-2.6.34-rc4/drivers/staging/rtl8192u/r8192U_core.c	2010-04-13 02:19:01.628633029 +0000
@@ -70,6 +70,7 @@
 #include "r8192U_dm.h"
 //#include "r8192xU_phyreg.h"
 #include <linux/usb.h>
+#include <linux/slab.h>
 // FIXME: check if 2.6.7 is ok
 
 #ifdef CONFIG_RTL8192_PM
diff -urN linux-2.6.34-rc3/drivers/staging/sep/sep_driver.c linux-2.6.34-rc4/drivers/staging/sep/sep_driver.c
--- linux-2.6.34-rc3/drivers/staging/sep/sep_driver.c	2010-04-13 02:18:56.311633028 +0000
+++ linux-2.6.34-rc4/drivers/staging/sep/sep_driver.c	2010-04-13 02:19:01.629633049 +0000
@@ -42,6 +42,7 @@
 #include <linux/sched.h>
 #include <linux/pci.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <asm/ioctl.h>
 #include <linux/ioport.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/staging/sm7xx/smtcfb.c linux-2.6.34-rc4/drivers/staging/sm7xx/smtcfb.c
--- linux-2.6.34-rc3/drivers/staging/sm7xx/smtcfb.c	2010-04-13 02:18:56.314575609 +0000
+++ linux-2.6.34-rc4/drivers/staging/sm7xx/smtcfb.c	2010-04-13 02:19:01.632633109 +0000
@@ -34,6 +34,7 @@
 #include <linux/fb.h>
 #include <linux/pci.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 #include <linux/console.h>
 #include <linux/screen_info.h>
diff -urN linux-2.6.34-rc3/drivers/staging/strip/strip.c linux-2.6.34-rc4/drivers/staging/strip/strip.c
--- linux-2.6.34-rc3/drivers/staging/strip/strip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/strip/strip.c	2010-04-13 02:19:01.633633069 +0000
@@ -107,6 +107,7 @@
 #include <linux/serialP.h>
 #include <linux/rcupdate.h>
 #include <linux/compat.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/net_namespace.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/udlfb/udlfb.c linux-2.6.34-rc4/drivers/staging/udlfb/udlfb.c
--- linux-2.6.34-rc3/drivers/staging/udlfb/udlfb.c	2010-04-13 02:18:56.316570456 +0000
+++ linux-2.6.34-rc4/drivers/staging/udlfb/udlfb.c	2010-04-13 02:19:01.634633036 +0000
@@ -24,6 +24,7 @@
 #include <linux/mm.h>
 #include <linux/fb.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include "udlfb.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/stub_dev.c linux-2.6.34-rc4/drivers/staging/usbip/stub_dev.c
--- linux-2.6.34-rc3/drivers/staging/usbip/stub_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/stub_dev.c	2010-04-13 02:19:01.635633069 +0000
@@ -17,6 +17,8 @@
  * USA.
  */
 
+#include <linux/slab.h>
+
 #include "usbip_common.h"
 #include "stub.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/stub_main.c linux-2.6.34-rc4/drivers/staging/usbip/stub_main.c
--- linux-2.6.34-rc3/drivers/staging/usbip/stub_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/stub_main.c	2010-04-13 02:19:01.635633069 +0000
@@ -17,6 +17,7 @@
  * USA.
  */
 
+#include <linux/slab.h>
 
 #include "usbip_common.h"
 #include "stub.h"
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/stub_rx.c linux-2.6.34-rc4/drivers/staging/usbip/stub_rx.c
--- linux-2.6.34-rc3/drivers/staging/usbip/stub_rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/stub_rx.c	2010-04-13 02:19:01.635633069 +0000
@@ -17,6 +17,8 @@
  * USA.
  */
 
+#include <linux/slab.h>
+
 #include "usbip_common.h"
 #include "stub.h"
 #include "../../usb/core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/stub_tx.c linux-2.6.34-rc4/drivers/staging/usbip/stub_tx.c
--- linux-2.6.34-rc3/drivers/staging/usbip/stub_tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/stub_tx.c	2010-04-13 02:19:01.635633069 +0000
@@ -17,6 +17,8 @@
  * USA.
  */
 
+#include <linux/slab.h>
+
 #include "usbip_common.h"
 #include "stub.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/usbip_common.c linux-2.6.34-rc4/drivers/staging/usbip/usbip_common.c
--- linux-2.6.34-rc3/drivers/staging/usbip/usbip_common.c	2010-04-13 02:18:56.316570456 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/usbip_common.c	2010-04-13 02:19:01.635633069 +0000
@@ -23,6 +23,7 @@
 #include <linux/tcp.h>
 #include <linux/in.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include "usbip_common.h"
 
 /* version information */
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/vhci_hcd.c linux-2.6.34-rc4/drivers/staging/usbip/vhci_hcd.c
--- linux-2.6.34-rc3/drivers/staging/usbip/vhci_hcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/vhci_hcd.c	2010-04-13 02:19:01.635633069 +0000
@@ -17,6 +17,7 @@
  * USA.
  */
 
+#include <linux/slab.h>
 
 #include "usbip_common.h"
 #include "vhci.h"
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/vhci_rx.c linux-2.6.34-rc4/drivers/staging/usbip/vhci_rx.c
--- linux-2.6.34-rc3/drivers/staging/usbip/vhci_rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/vhci_rx.c	2010-04-13 02:19:01.636632946 +0000
@@ -17,6 +17,8 @@
  * USA.
  */
 
+#include <linux/slab.h>
+
 #include "usbip_common.h"
 #include "vhci.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/usbip/vhci_tx.c linux-2.6.34-rc4/drivers/staging/usbip/vhci_tx.c
--- linux-2.6.34-rc3/drivers/staging/usbip/vhci_tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/usbip/vhci_tx.c	2010-04-13 02:19:01.636632946 +0000
@@ -17,6 +17,8 @@
  * USA.
  */
 
+#include <linux/slab.h>
+
 #include "usbip_common.h"
 #include "vhci.h"
 
diff -urN linux-2.6.34-rc3/drivers/staging/vme/bridges/vme_ca91cx42.c linux-2.6.34-rc4/drivers/staging/vme/bridges/vme_ca91cx42.c
--- linux-2.6.34-rc3/drivers/staging/vme/bridges/vme_ca91cx42.c	2010-04-13 02:18:56.318633069 +0000
+++ linux-2.6.34-rc4/drivers/staging/vme/bridges/vme_ca91cx42.c	2010-04-13 02:19:01.638633146 +0000
@@ -25,6 +25,7 @@
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/time.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/vme/bridges/vme_tsi148.c linux-2.6.34-rc4/drivers/staging/vme/bridges/vme_tsi148.c
--- linux-2.6.34-rc3/drivers/staging/vme/bridges/vme_tsi148.c	2010-04-13 02:18:56.320570491 +0000
+++ linux-2.6.34-rc4/drivers/staging/vme/bridges/vme_tsi148.c	2010-04-13 02:19:01.639633071 +0000
@@ -25,6 +25,7 @@
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <asm/time.h>
 #include <asm/io.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/staging/vme/devices/vme_user.c linux-2.6.34-rc4/drivers/staging/vme/devices/vme_user.c
--- linux-2.6.34-rc3/drivers/staging/vme/devices/vme_user.c	2010-04-13 02:18:56.320570491 +0000
+++ linux-2.6.34-rc4/drivers/staging/vme/devices/vme_user.c	2010-04-13 02:19:01.640633017 +0000
@@ -28,6 +28,7 @@
 #include <linux/pagemap.h>
 #include <linux/pci.h>
 #include <linux/semaphore.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/syscalls.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/drivers/staging/vme/vme.c linux-2.6.34-rc4/drivers/staging/vme/vme.c
--- linux-2.6.34-rc3/drivers/staging/vme/vme.c	2010-04-13 02:18:56.321633042 +0000
+++ linux-2.6.34-rc4/drivers/staging/vme/vme.c	2010-04-13 02:19:01.640633017 +0000
@@ -29,6 +29,7 @@
 #include <linux/syscalls.h>
 #include <linux/mutex.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include "vme.h"
 #include "vme_bridge.h"
diff -urN linux-2.6.34-rc3/drivers/staging/vt6655/device_main.c linux-2.6.34-rc4/drivers/staging/vt6655/device_main.c
--- linux-2.6.34-rc3/drivers/staging/vt6655/device_main.c	2010-04-13 02:18:56.322633041 +0000
+++ linux-2.6.34-rc4/drivers/staging/vt6655/device_main.c	2010-04-13 02:19:01.642633142 +0000
@@ -84,6 +84,7 @@
 #include "iowpa.h"
 #include <linux/delay.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 //#define	DEBUG
 /*---------------------  Static Definitions -------------------------*/
diff -urN linux-2.6.34-rc3/drivers/staging/winbond/wb35reg.c linux-2.6.34-rc4/drivers/staging/winbond/wb35reg.c
--- linux-2.6.34-rc3/drivers/staging/winbond/wb35reg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/winbond/wb35reg.c	2010-04-13 02:19:01.645633114 +0000
@@ -2,6 +2,7 @@
 #include "wb35reg_f.h"
 
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 extern void phy_calibration_winbond(struct hw_data *phw_data, u32 frequency);
 
diff -urN linux-2.6.34-rc3/drivers/staging/winbond/wb35rx.c linux-2.6.34-rc4/drivers/staging/winbond/wb35rx.c
--- linux-2.6.34-rc3/drivers/staging/winbond/wb35rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/winbond/wb35rx.c	2010-04-13 02:19:01.646633054 +0000
@@ -9,6 +9,7 @@
 //
 //============================================================================
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "core.h"
 #include "sysdef.h"
diff -urN linux-2.6.34-rc3/drivers/staging/winbond/wb35tx.c linux-2.6.34-rc4/drivers/staging/winbond/wb35tx.c
--- linux-2.6.34-rc3/drivers/staging/winbond/wb35tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/winbond/wb35tx.c	2010-04-13 02:19:01.646633054 +0000
@@ -9,6 +9,7 @@
 //
 //============================================================================
 #include <linux/usb.h>
+#include <linux/gfp.h>
 
 #include "wb35tx_f.h"
 #include "mds_f.h"
diff -urN linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_cs.c linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_cs.c
--- linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_cs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_cs.c	2010-04-13 02:19:01.646633054 +0000
@@ -67,7 +67,6 @@
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_netdev.c linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_netdev.c
--- linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_netdev.c	2010-04-13 02:18:56.327633087 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_netdev.c	2010-04-13 02:19:01.647633051 +0000
@@ -65,6 +65,7 @@
 #include <wl_version.h>
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 // #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_pci.c linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_pci.c
--- linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_pci.c	2010-04-13 02:18:56.327633087 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_pci.c	2010-04-13 02:19:01.647633051 +0000
@@ -71,7 +71,6 @@
 #include <linux/init.h>
 #include <linux/sched.h>
 #include <linux/ptrace.h>
-#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/string.h>
 //#include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_priv.c linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_priv.c
--- linux-2.6.34-rc3/drivers/staging/wlags49_h2/wl_priv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlags49_h2/wl_priv.c	2010-04-13 02:19:01.648633080 +0000
@@ -65,6 +65,7 @@
 
 #include <linux/if_arp.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211req.c linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211req.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211req.c	2010-04-13 02:18:56.330570487 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211req.c	2010-04-13 02:19:01.651633026 +0000
@@ -55,7 +55,6 @@
 #include <linux/sched.h>
 #include <linux/types.h>
 #include <linux/skbuff.h>
-#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211wep.c linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211wep.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211wep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211wep.c	2010-04-13 02:19:01.651633026 +0000
@@ -50,7 +50,6 @@
 
 #include <linux/netdevice.h>
 #include <linux/wireless.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/kernel.h>
 
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211wext.c linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211wext.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/p80211wext.c	2010-04-13 02:18:56.331633062 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/p80211wext.c	2010-04-13 02:19:01.652633064 +0000
@@ -40,7 +40,6 @@
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2fw.c linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2fw.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2fw.c	2010-04-13 02:18:56.331633062 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2fw.c	2010-04-13 02:19:01.652633064 +0000
@@ -48,6 +48,7 @@
 /*================================================================*/
 /* System Includes */
 #include <linux/ihex.h>
+#include <linux/slab.h>
 
 /*================================================================*/
 /* Local Constants */
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2mgmt.c linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2mgmt.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2mgmt.c	2010-04-13 02:18:56.331633062 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2mgmt.c	2010-04-13 02:19:01.652633064 +0000
@@ -63,7 +63,6 @@
 #include <linux/wait.h>
 #include <linux/sched.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <linux/netdevice.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2mib.c linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2mib.c
--- linux-2.6.34-rc3/drivers/staging/wlan-ng/prism2mib.c	2010-04-13 02:18:56.332633049 +0000
+++ linux-2.6.34-rc4/drivers/staging/wlan-ng/prism2mib.c	2010-04-13 02:19:01.652633064 +0000
@@ -54,7 +54,6 @@
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <linux/netdevice.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/tc/tc.c linux-2.6.34-rc4/drivers/tc/tc.c
--- linux-2.6.34-rc3/drivers/tc/tc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/tc/tc.c	2010-04-13 02:19:01.653633070 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/tc.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/drivers/thermal/thermal_sys.c linux-2.6.34-rc4/drivers/thermal/thermal_sys.c
--- linux-2.6.34-rc3/drivers/thermal/thermal_sys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/thermal/thermal_sys.c	2010-04-13 02:19:01.653633070 +0000
@@ -26,6 +26,7 @@
 #include <linux/module.h>
 #include <linux/device.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/kdev_t.h>
 #include <linux/idr.h>
 #include <linux/thermal.h>
@@ -505,6 +506,7 @@
 	tz->temp_input.attr.attr.name = tz->temp_input.name;
 	tz->temp_input.attr.attr.mode = 0444;
 	tz->temp_input.attr.show = temp_input_show;
+	sysfs_attr_init(&tz->temp_input.attr.attr);
 	result = device_create_file(hwmon->device, &tz->temp_input.attr);
 	if (result)
 		goto unregister_hwmon_device;
@@ -517,6 +519,7 @@
 			tz->temp_crit.attr.attr.name = tz->temp_crit.name;
 			tz->temp_crit.attr.attr.mode = 0444;
 			tz->temp_crit.attr.show = temp_crit_show;
+			sysfs_attr_init(&tz->temp_crit.attr.attr);
 			result = device_create_file(hwmon->device,
 						    &tz->temp_crit.attr);
 			if (result)
@@ -725,6 +728,7 @@
 		goto release_idr;
 
 	sprintf(dev->attr_name, "cdev%d_trip_point", dev->id);
+	sysfs_attr_init(&dev->attr.attr);
 	dev->attr.attr.name = dev->attr_name;
 	dev->attr.attr.mode = 0444;
 	dev->attr.show = thermal_cooling_device_trip_point_show;
diff -urN linux-2.6.34-rc3/drivers/uio/uio.c linux-2.6.34-rc4/drivers/uio/uio.c
--- linux-2.6.34-rc3/drivers/uio/uio.c	2010-04-13 02:18:56.332633049 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio.c	2010-04-13 02:19:01.654633049 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/poll.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/idr.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/drivers/uio/uio_aec.c linux-2.6.34-rc4/drivers/uio/uio_aec.c
--- linux-2.6.34-rc3/drivers/uio/uio_aec.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_aec.c	2010-04-13 02:19:01.654633049 +0000
@@ -27,6 +27,7 @@
 #include <linux/io.h>
 #include <linux/uaccess.h>
 #include <linux/uio_driver.h>
+#include <linux/slab.h>
 
 #define PCI_VENDOR_ID_AEC 0xaecb
 #define PCI_DEVICE_ID_AEC_VITCLTC 0x6250
diff -urN linux-2.6.34-rc3/drivers/uio/uio_cif.c linux-2.6.34-rc4/drivers/uio/uio_cif.c
--- linux-2.6.34-rc3/drivers/uio/uio_cif.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_cif.c	2010-04-13 02:19:01.654633049 +0000
@@ -11,6 +11,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/uio_driver.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/uio/uio_netx.c linux-2.6.34-rc4/drivers/uio/uio_netx.c
--- linux-2.6.34-rc3/drivers/uio/uio_netx.c	2010-04-13 02:18:56.333633069 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_netx.c	2010-04-13 02:19:01.654633049 +0000
@@ -13,6 +13,7 @@
 #include <linux/io.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/uio_driver.h>
 
 #define PCI_VENDOR_ID_HILSCHER		0x15CF
diff -urN linux-2.6.34-rc3/drivers/uio/uio_pci_generic.c linux-2.6.34-rc4/drivers/uio/uio_pci_generic.c
--- linux-2.6.34-rc3/drivers/uio/uio_pci_generic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_pci_generic.c	2010-04-13 02:19:01.654633049 +0000
@@ -22,6 +22,7 @@
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/uio_driver.h>
 #include <linux/spinlock.h>
 
diff -urN linux-2.6.34-rc3/drivers/uio/uio_pdrv.c linux-2.6.34-rc4/drivers/uio/uio_pdrv.c
--- linux-2.6.34-rc3/drivers/uio/uio_pdrv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_pdrv.c	2010-04-13 02:19:01.654633049 +0000
@@ -11,6 +11,7 @@
 #include <linux/platform_device.h>
 #include <linux/uio_driver.h>
 #include <linux/stringify.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "uio_pdrv"
 
diff -urN linux-2.6.34-rc3/drivers/uio/uio_pdrv_genirq.c linux-2.6.34-rc4/drivers/uio/uio_pdrv_genirq.c
--- linux-2.6.34-rc3/drivers/uio/uio_pdrv_genirq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_pdrv_genirq.c	2010-04-13 02:19:01.654633049 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/stringify.h>
 #include <linux/pm_runtime.h>
+#include <linux/slab.h>
 
 #define DRIVER_NAME "uio_pdrv_genirq"
 
diff -urN linux-2.6.34-rc3/drivers/uio/uio_sercos3.c linux-2.6.34-rc4/drivers/uio/uio_sercos3.c
--- linux-2.6.34-rc3/drivers/uio/uio_sercos3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uio/uio_sercos3.c	2010-04-13 02:19:01.654633049 +0000
@@ -28,6 +28,7 @@
 #include <linux/pci.h>
 #include <linux/uio_driver.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 /* ID's for SERCOS III PCI card (PLX 9030) */
 #define SERCOS_SUB_VENDOR_ID  0x1971
diff -urN linux-2.6.34-rc3/drivers/usb/atm/speedtch.c linux-2.6.34-rc4/drivers/usb/atm/speedtch.c
--- linux-2.6.34-rc3/drivers/usb/atm/speedtch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/atm/speedtch.c	2010-04-13 02:19:01.656633114 +0000
@@ -27,7 +27,6 @@
 #include <linux/device.h>
 #include <linux/errno.h>
 #include <linux/firmware.h>
-#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/usb/atm/ueagle-atm.c linux-2.6.34-rc4/drivers/usb/atm/ueagle-atm.c
--- linux-2.6.34-rc3/drivers/usb/atm/ueagle-atm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/atm/ueagle-atm.c	2010-04-13 02:19:01.656633114 +0000
@@ -66,6 +66,7 @@
 #include <linux/kthread.h>
 #include <linux/mutex.h>
 #include <linux/freezer.h>
+#include <linux/slab.h>
 
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/c67x00/c67x00-drv.c linux-2.6.34-rc4/drivers/usb/c67x00/c67x00-drv.c
--- linux-2.6.34-rc3/drivers/usb/c67x00/c67x00-drv.c	2010-04-13 02:18:56.335633022 +0000
+++ linux-2.6.34-rc4/drivers/usb/c67x00/c67x00-drv.c	2010-04-13 02:19:01.657633561 +0000
@@ -37,6 +37,7 @@
 #include <linux/device.h>
 #include <linux/io.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/c67x00.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/c67x00/c67x00-sched.c linux-2.6.34-rc4/drivers/usb/c67x00/c67x00-sched.c
--- linux-2.6.34-rc3/drivers/usb/c67x00/c67x00-sched.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/c67x00/c67x00-sched.c	2010-04-13 02:19:01.657633561 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include "c67x00.h"
 #include "c67x00-hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/class/usbtmc.c linux-2.6.34-rc4/drivers/usb/class/usbtmc.c
--- linux-2.6.34-rc3/drivers/usb/class/usbtmc.c	2010-04-13 02:18:56.336633036 +0000
+++ linux-2.6.34-rc4/drivers/usb/class/usbtmc.c	2010-04-13 02:19:01.658633888 +0000
@@ -25,6 +25,7 @@
 #include <linux/fs.h>
 #include <linux/uaccess.h>
 #include <linux/kref.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/usb.h>
 #include <linux/usb/tmc.h>
diff -urN linux-2.6.34-rc3/drivers/usb/core/devices.c linux-2.6.34-rc4/drivers/usb/core/devices.c
--- linux-2.6.34-rc3/drivers/usb/core/devices.c	2010-04-13 02:18:56.336633036 +0000
+++ linux-2.6.34-rc4/drivers/usb/core/devices.c	2010-04-13 02:19:01.659633447 +0000
@@ -50,7 +50,7 @@
 
 #include <linux/fs.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/poll.h>
 #include <linux/usb.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/usb/core/driver.c linux-2.6.34-rc4/drivers/usb/core/driver.c
--- linux-2.6.34-rc3/drivers/usb/core/driver.c	2010-04-13 02:18:56.338633025 +0000
+++ linux-2.6.34-rc4/drivers/usb/core/driver.c	2010-04-13 02:19:01.660633443 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/quirks.h>
 #include <linux/pm_runtime.h>
diff -urN linux-2.6.34-rc3/drivers/usb/core/endpoint.c linux-2.6.34-rc4/drivers/usb/core/endpoint.c
--- linux-2.6.34-rc3/drivers/usb/core/endpoint.c	2010-04-13 02:18:56.338633025 +0000
+++ linux-2.6.34-rc4/drivers/usb/core/endpoint.c	2010-04-13 02:19:01.660633443 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/kernel.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/idr.h>
 #include <linux/usb.h>
 #include "usb.h"
diff -urN linux-2.6.34-rc3/drivers/usb/core/file.c linux-2.6.34-rc4/drivers/usb/core/file.c
--- linux-2.6.34-rc3/drivers/usb/core/file.c	2010-04-13 02:18:56.338633025 +0000
+++ linux-2.6.34-rc4/drivers/usb/core/file.c	2010-04-13 02:19:01.660633443 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/rwsem.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/usb.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/at91_udc.c linux-2.6.34-rc4/drivers/usb/gadget/at91_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/at91_udc.c	2010-04-13 02:18:56.341570395 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/at91_udc.c	2010-04-13 02:19:01.664633718 +0000
@@ -1370,6 +1370,12 @@
 {
 	struct at91_udc		*udc = _udc;
 	u32			rescans = 5;
+	int			disable_clock = 0;
+
+	if (!udc->clocked) {
+		clk_on(udc);
+		disable_clock = 1;
+	}
 
 	while (rescans--) {
 		u32 status;
@@ -1458,6 +1464,9 @@
 		}
 	}
 
+	if (disable_clock)
+		clk_off(udc);
+
 	return IRQ_HANDLED;
 }
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/atmel_usba_udc.c linux-2.6.34-rc4/drivers/usb/gadget/atmel_usba_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/atmel_usba_udc.c	2010-04-13 02:18:56.342633038 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/atmel_usba_udc.c	2010-04-13 02:19:01.664633718 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/ci13xxx_udc.c linux-2.6.34-rc4/drivers/usb/gadget/ci13xxx_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/ci13xxx_udc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/ci13xxx_udc.c	2010-04-13 02:19:01.665633523 +0000
@@ -62,6 +62,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/usb/ch9.h>
 #include <linux/usb/gadget.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/config.c linux-2.6.34-rc4/drivers/usb/gadget/config.c
--- linux-2.6.34-rc3/drivers/usb/gadget/config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/config.c	2010-04-13 02:19:01.665633523 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_acm.c linux-2.6.34-rc4/drivers/usb/gadget/f_acm.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_acm.c	2010-04-13 02:18:56.342633038 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_acm.c	2010-04-13 02:19:01.665633523 +0000
@@ -14,6 +14,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_audio.c linux-2.6.34-rc4/drivers/usb/gadget/f_audio.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_audio.c	2010-04-13 02:18:56.342633038 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_audio.c	2010-04-13 02:19:01.665633523 +0000
@@ -9,6 +9,7 @@
  * Licensed under the GPL-2 or later.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_ecm.c linux-2.6.34-rc4/drivers/usb/gadget/f_ecm.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_ecm.c	2010-04-13 02:18:56.342633038 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_ecm.c	2010-04-13 02:19:01.666633676 +0000
@@ -21,6 +21,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_eem.c linux-2.6.34-rc4/drivers/usb/gadget/f_eem.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_eem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_eem.c	2010-04-13 02:19:01.666633676 +0000
@@ -24,6 +24,7 @@
 #include <linux/device.h>
 #include <linux/etherdevice.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 
 #include "u_ether.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_loopback.c linux-2.6.34-rc4/drivers/usb/gadget/f_loopback.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_loopback.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_loopback.c	2010-04-13 02:19:01.666633676 +0000
@@ -21,6 +21,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_obex.c linux-2.6.34-rc4/drivers/usb/gadget/f_obex.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_obex.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_obex.c	2010-04-13 02:19:01.666633676 +0000
@@ -23,6 +23,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_phonet.c linux-2.6.34-rc4/drivers/usb/gadget/f_phonet.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_phonet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_phonet.c	2010-04-13 02:19:01.667633517 +0000
@@ -20,6 +20,7 @@
  * 02110-1301 USA
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_rndis.c linux-2.6.34-rc4/drivers/usb/gadget/f_rndis.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_rndis.c	2010-04-13 02:18:56.343633105 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_rndis.c	2010-04-13 02:19:01.667633517 +0000
@@ -24,6 +24,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_serial.c linux-2.6.34-rc4/drivers/usb/gadget/f_serial.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_serial.c	2010-04-13 02:19:01.667633517 +0000
@@ -10,6 +10,7 @@
  * either version 2 of that License or (at your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_sourcesink.c linux-2.6.34-rc4/drivers/usb/gadget/f_sourcesink.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_sourcesink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_sourcesink.c	2010-04-13 02:19:01.667633517 +0000
@@ -21,6 +21,7 @@
 
 /* #define VERBOSE_DEBUG */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/f_subset.c linux-2.6.34-rc4/drivers/usb/gadget/f_subset.c
--- linux-2.6.34-rc3/drivers/usb/gadget/f_subset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/f_subset.c	2010-04-13 02:19:01.667633517 +0000
@@ -19,6 +19,7 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/gmidi.c linux-2.6.34-rc4/drivers/usb/gadget/gmidi.c
--- linux-2.6.34-rc3/drivers/usb/gadget/gmidi.c	2010-04-13 02:18:56.344633026 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/gmidi.c	2010-04-13 02:19:01.669633339 +0000
@@ -21,6 +21,7 @@
 /* #define VERBOSE_DEBUG */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/utsname.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/imx_udc.c linux-2.6.34-rc4/drivers/usb/gadget/imx_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/imx_udc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/imx_udc.c	2010-04-13 02:19:01.669633339 +0000
@@ -29,6 +29,7 @@
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 
 #include <linux/usb/ch9.h>
 #include <linux/usb/gadget.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/lh7a40x_udc.c linux-2.6.34-rc4/drivers/usb/gadget/lh7a40x_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/lh7a40x_udc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/lh7a40x_udc.c	2010-04-13 02:19:01.670633663 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include "lh7a40x_udc.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/m66592-udc.c linux-2.6.34-rc4/drivers/usb/gadget/m66592-udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/m66592-udc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/m66592-udc.c	2010-04-13 02:19:01.670633663 +0000
@@ -25,6 +25,7 @@
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/usb/ch9.h>
 #include <linux/usb/gadget.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/pxa27x_udc.c linux-2.6.34-rc4/drivers/usb/gadget/pxa27x_udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/pxa27x_udc.c	2010-04-13 02:18:56.346633034 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/pxa27x_udc.c	2010-04-13 02:19:01.672633635 +0000
@@ -31,6 +31,7 @@
 #include <linux/clk.h>
 #include <linux/irq.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 
 #include <asm/byteorder.h>
 #include <mach/hardware.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/r8a66597-udc.c linux-2.6.34-rc4/drivers/usb/gadget/r8a66597-udc.c
--- linux-2.6.34-rc3/drivers/usb/gadget/r8a66597-udc.c	2010-04-13 02:18:56.347633045 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/r8a66597-udc.c	2010-04-13 02:19:01.672633635 +0000
@@ -23,11 +23,11 @@
 #include <linux/module.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
-#include <linux/err.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <linux/usb/ch9.h>
 #include <linux/usb/gadget.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/rndis.c linux-2.6.34-rc4/drivers/usb/gadget/rndis.c
--- linux-2.6.34-rc3/drivers/usb/gadget/rndis.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/rndis.c	2010-04-13 02:19:01.672633635 +0000
@@ -28,6 +28,7 @@
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/netdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/s3c-hsotg.c linux-2.6.34-rc4/drivers/usb/gadget/s3c-hsotg.c
--- linux-2.6.34-rc3/drivers/usb/gadget/s3c-hsotg.c	2010-04-13 02:18:56.347633045 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/s3c-hsotg.c	2010-04-13 02:19:01.673633527 +0000
@@ -22,6 +22,7 @@
 #include <linux/seq_file.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/usb/ch9.h>
 #include <linux/usb/gadget.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/u_audio.c linux-2.6.34-rc4/drivers/usb/gadget/u_audio.c
--- linux-2.6.34-rc3/drivers/usb/gadget/u_audio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/u_audio.c	2010-04-13 02:19:01.673633527 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/delay.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/u_ether.c linux-2.6.34-rc4/drivers/usb/gadget/u_ether.c
--- linux-2.6.34-rc3/drivers/usb/gadget/u_ether.c	2010-04-13 02:18:56.347633045 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/u_ether.c	2010-04-13 02:19:01.673633527 +0000
@@ -23,6 +23,7 @@
 /* #define VERBOSE_DEBUG */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/device.h>
 #include <linux/ctype.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/u_serial.c linux-2.6.34-rc4/drivers/usb/gadget/u_serial.c
--- linux-2.6.34-rc3/drivers/usb/gadget/u_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/u_serial.c	2010-04-13 02:19:01.673633527 +0000
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
+#include <linux/slab.h>
 
 #include "u_serial.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/gadget/zero.c linux-2.6.34-rc4/drivers/usb/gadget/zero.c
--- linux-2.6.34-rc3/drivers/usb/gadget/zero.c	2010-04-13 02:18:56.348633034 +0000
+++ linux-2.6.34-rc4/drivers/usb/gadget/zero.c	2010-04-13 02:19:01.673633527 +0000
@@ -50,6 +50,7 @@
 /* #define VERBOSE_DEBUG */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/utsname.h>
 #include <linux/device.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/host/ehci-hcd.c linux-2.6.34-rc4/drivers/usb/host/ehci-hcd.c
--- linux-2.6.34-rc3/drivers/usb/host/ehci-hcd.c	2010-04-13 02:18:56.348633034 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/ehci-hcd.c	2010-04-13 02:19:01.674633407 +0000
@@ -23,7 +23,6 @@
 #include <linux/delay.h>
 #include <linux/ioport.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/errno.h>
 #include <linux/init.h>
@@ -35,6 +34,7 @@
 #include <linux/moduleparam.h>
 #include <linux/dma-mapping.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include "../core/hcd.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/host/ehci-mxc.c linux-2.6.34-rc4/drivers/usb/host/ehci-mxc.c
--- linux-2.6.34-rc3/drivers/usb/host/ehci-mxc.c	2010-04-13 02:18:56.348633034 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/ehci-mxc.c	2010-04-13 02:19:01.674633407 +0000
@@ -21,6 +21,7 @@
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/usb/otg.h>
+#include <linux/slab.h>
 
 #include <mach/mxc_ehci.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/host/ehci-omap.c linux-2.6.34-rc4/drivers/usb/host/ehci-omap.c
--- linux-2.6.34-rc3/drivers/usb/host/ehci-omap.c	2010-04-13 02:18:56.349571680 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/ehci-omap.c	2010-04-13 02:19:01.674633407 +0000
@@ -37,6 +37,7 @@
 #include <linux/clk.h>
 #include <linux/gpio.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <plat/usb.h>
 
 /*
diff -urN linux-2.6.34-rc3/drivers/usb/host/fhci-hcd.c linux-2.6.34-rc4/drivers/usb/host/fhci-hcd.c
--- linux-2.6.34-rc3/drivers/usb/host/fhci-hcd.c	2010-04-13 02:18:56.350570464 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/fhci-hcd.c	2010-04-13 02:19:01.676633226 +0000
@@ -27,6 +27,7 @@
 #include <linux/usb.h>
 #include <linux/of_platform.h>
 #include <linux/of_gpio.h>
+#include <linux/slab.h>
 #include <asm/qe.h>
 #include <asm/fsl_gtm.h>
 #include "../core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/fhci-mem.c linux-2.6.34-rc4/drivers/usb/host/fhci-mem.c
--- linux-2.6.34-rc3/drivers/usb/host/fhci-mem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/fhci-mem.c	2010-04-13 02:19:01.676633226 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/usb.h>
 #include "../core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/fhci-q.c linux-2.6.34-rc4/drivers/usb/host/fhci-q.c
--- linux-2.6.34-rc3/drivers/usb/host/fhci-q.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/fhci-q.c	2010-04-13 02:19:01.676633226 +0000
@@ -19,6 +19,7 @@
 #include <linux/types.h>
 #include <linux/spinlock.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/usb.h>
 #include "../core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/fhci-tds.c linux-2.6.34-rc4/drivers/usb/host/fhci-tds.c
--- linux-2.6.34-rc3/drivers/usb/host/fhci-tds.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/fhci-tds.c	2010-04-13 02:19:01.676633226 +0000
@@ -18,6 +18,7 @@
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/io.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/hwa-hc.c linux-2.6.34-rc4/drivers/usb/host/hwa-hc.c
--- linux-2.6.34-rc3/drivers/usb/host/hwa-hc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/hwa-hc.c	2010-04-13 02:19:01.676633226 +0000
@@ -55,6 +55,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/workqueue.h>
 #include <linux/wait.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/imx21-hcd.c linux-2.6.34-rc4/drivers/usb/host/imx21-hcd.c
--- linux-2.6.34-rc3/drivers/usb/host/imx21-hcd.c	2010-04-13 02:18:56.351570588 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/imx21-hcd.c	2010-04-13 02:19:01.677591967 +0000
@@ -54,6 +54,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "../core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/isp116x-hcd.c linux-2.6.34-rc4/drivers/usb/host/isp116x-hcd.c
--- linux-2.6.34-rc3/drivers/usb/host/isp116x-hcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/isp116x-hcd.c	2010-04-13 02:19:01.678633614 +0000
@@ -62,6 +62,7 @@
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/isp116x.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/ohci-q.c linux-2.6.34-rc4/drivers/usb/host/ohci-q.c
--- linux-2.6.34-rc3/drivers/usb/host/ohci-q.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/ohci-q.c	2010-04-13 02:19:01.680633075 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/irq.h>
+#include <linux/slab.h>
 
 static void urb_free_priv (struct ohci_hcd *hc, urb_priv_t *urb_priv)
 {
diff -urN linux-2.6.34-rc3/drivers/usb/host/r8a66597-hcd.c linux-2.6.34-rc4/drivers/usb/host/r8a66597-hcd.c
--- linux-2.6.34-rc3/drivers/usb/host/r8a66597-hcd.c	2010-04-13 02:18:56.353633070 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/r8a66597-hcd.c	2010-04-13 02:19:01.680633075 +0000
@@ -37,6 +37,7 @@
 #include <linux/io.h>
 #include <linux/mm.h>
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <asm/cacheflush.h>
 
 #include "../core/hcd.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/uhci-debug.c linux-2.6.34-rc4/drivers/usb/host/uhci-debug.c
--- linux-2.6.34-rc3/drivers/usb/host/uhci-debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/uhci-debug.c	2010-04-13 02:19:01.681633527 +0000
@@ -9,6 +9,7 @@
  * (C) Copyright 1999-2001 Johannes Erdfelt
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/debugfs.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/whci/asl.c linux-2.6.34-rc4/drivers/usb/host/whci/asl.c
--- linux-2.6.34-rc3/drivers/usb/host/whci/asl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/whci/asl.c	2010-04-13 02:19:01.681633527 +0000
@@ -16,6 +16,7 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/dma-mapping.h>
 #include <linux/uwb/umc.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/whci/debug.c linux-2.6.34-rc4/drivers/usb/host/whci/debug.c
--- linux-2.6.34-rc3/drivers/usb/host/whci/debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/whci/debug.c	2010-04-13 02:19:01.681633527 +0000
@@ -15,6 +15,7 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/debugfs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/whci/init.c linux-2.6.34-rc4/drivers/usb/host/whci/init.c
--- linux-2.6.34-rc3/drivers/usb/host/whci/init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/whci/init.c	2010-04-13 02:19:01.681633527 +0000
@@ -16,6 +16,7 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/dma-mapping.h>
 #include <linux/uwb/umc.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/host/whci/pzl.c linux-2.6.34-rc4/drivers/usb/host/whci/pzl.c
--- linux-2.6.34-rc3/drivers/usb/host/whci/pzl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/whci/pzl.c	2010-04-13 02:19:01.681633527 +0000
@@ -16,6 +16,7 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/dma-mapping.h>
 #include <linux/uwb/umc.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/host/whci/qset.c linux-2.6.34-rc4/drivers/usb/host/whci/qset.c
--- linux-2.6.34-rc3/drivers/usb/host/whci/qset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/whci/qset.c	2010-04-13 02:19:01.681633527 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/uwb/umc.h>
 #include <linux/usb.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/host/xhci-mem.c linux-2.6.34-rc4/drivers/usb/host/xhci-mem.c
--- linux-2.6.34-rc3/drivers/usb/host/xhci-mem.c	2010-04-13 02:18:56.356633053 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/xhci-mem.c	2010-04-13 02:19:01.684633128 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/usb.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/dmapool.h>
 
 #include "xhci.h"
diff -urN linux-2.6.34-rc3/drivers/usb/host/xhci-ring.c linux-2.6.34-rc4/drivers/usb/host/xhci-ring.c
--- linux-2.6.34-rc3/drivers/usb/host/xhci-ring.c	2010-04-13 02:18:56.357633037 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/xhci-ring.c	2010-04-13 02:19:01.684633128 +0000
@@ -65,6 +65,7 @@
  */
 
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include "xhci.h"
 
 /*
diff -urN linux-2.6.34-rc3/drivers/usb/host/xhci.c linux-2.6.34-rc4/drivers/usb/host/xhci.c
--- linux-2.6.34-rc3/drivers/usb/host/xhci.c	2010-04-13 02:18:56.358633047 +0000
+++ linux-2.6.34-rc4/drivers/usb/host/xhci.c	2010-04-13 02:19:01.685633739 +0000
@@ -23,6 +23,7 @@
 #include <linux/irq.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 
 #include "xhci.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/misc/appledisplay.c linux-2.6.34-rc4/drivers/usb/misc/appledisplay.c
--- linux-2.6.34-rc3/drivers/usb/misc/appledisplay.c	2010-04-13 02:18:56.359571675 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/appledisplay.c	2010-04-13 02:19:01.687633156 +0000
@@ -24,6 +24,7 @@
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/backlight.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/usb/misc/cypress_cy7c63.c linux-2.6.34-rc4/drivers/usb/misc/cypress_cy7c63.c
--- linux-2.6.34-rc3/drivers/usb/misc/cypress_cy7c63.c	2010-04-13 02:18:56.359571675 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/cypress_cy7c63.c	2010-04-13 02:19:01.687633156 +0000
@@ -32,6 +32,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #define DRIVER_AUTHOR		"Oliver Bock (bock@tfh-berlin.de)"
diff -urN linux-2.6.34-rc3/drivers/usb/misc/cytherm.c linux-2.6.34-rc4/drivers/usb/misc/cytherm.c
--- linux-2.6.34-rc3/drivers/usb/misc/cytherm.c	2010-04-13 02:18:56.359571675 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/cytherm.c	2010-04-13 02:19:01.687633156 +0000
@@ -17,6 +17,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/usb.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/misc/isight_firmware.c linux-2.6.34-rc4/drivers/usb/misc/isight_firmware.c
--- linux-2.6.34-rc3/drivers/usb/misc/isight_firmware.c	2010-04-13 02:18:56.360570708 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/isight_firmware.c	2010-04-13 02:19:01.689633211 +0000
@@ -25,6 +25,7 @@
 #include <linux/firmware.h>
 #include <linux/errno.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 static const struct usb_device_id id_table[] = {
 	{USB_DEVICE(0x05ac, 0x8300)},
diff -urN linux-2.6.34-rc3/drivers/usb/misc/sisusbvga/sisusb_con.c linux-2.6.34-rc4/drivers/usb/misc/sisusbvga/sisusb_con.c
--- linux-2.6.34-rc3/drivers/usb/misc/sisusbvga/sisusb_con.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/sisusbvga/sisusb_con.c	2010-04-13 02:19:01.690633015 +0000
@@ -58,7 +58,6 @@
 #include <linux/string.h>
 #include <linux/kd.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/vt_kern.h>
 #include <linux/selection.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/usb/misc/sisusbvga/sisusb_init.c linux-2.6.34-rc4/drivers/usb/misc/sisusbvga/sisusb_init.c
--- linux-2.6.34-rc3/drivers/usb/misc/sisusbvga/sisusb_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/sisusbvga/sisusb_init.c	2010-04-13 02:19:01.690633015 +0000
@@ -41,7 +41,6 @@
 #include <linux/errno.h>
 #include <linux/poll.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include "sisusb.h"
diff -urN linux-2.6.34-rc3/drivers/usb/misc/trancevibrator.c linux-2.6.34-rc4/drivers/usb/misc/trancevibrator.c
--- linux-2.6.34-rc3/drivers/usb/misc/trancevibrator.c	2010-04-13 02:18:56.361633027 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/trancevibrator.c	2010-04-13 02:19:01.690633015 +0000
@@ -22,6 +22,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/usb.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/misc/uss720.c linux-2.6.34-rc4/drivers/usb/misc/uss720.c
--- linux-2.6.34-rc3/drivers/usb/misc/uss720.c	2010-04-13 02:18:56.362633256 +0000
+++ linux-2.6.34-rc4/drivers/usb/misc/uss720.c	2010-04-13 02:19:01.691633038 +0000
@@ -49,6 +49,7 @@
 #include <linux/delay.h>
 #include <linux/completion.h>
 #include <linux/kref.h>
+#include <linux/slab.h>
 
 /*
  * Version Information
diff -urN linux-2.6.34-rc3/drivers/usb/mon/mon_bin.c linux-2.6.34-rc4/drivers/usb/mon/mon_bin.c
--- linux-2.6.34-rc3/drivers/usb/mon/mon_bin.c	2010-04-13 02:18:56.363633099 +0000
+++ linux-2.6.34-rc4/drivers/usb/mon/mon_bin.c	2010-04-13 02:19:01.692633094 +0000
@@ -17,6 +17,7 @@
 #include <linux/mm.h>
 #include <linux/smp_lock.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/mon/mon_main.c linux-2.6.34-rc4/drivers/usb/mon/mon_main.c
--- linux-2.6.34-rc3/drivers/usb/mon/mon_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/mon/mon_main.c	2010-04-13 02:19:01.692633094 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 #include <linux/notifier.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/mon/mon_stat.c linux-2.6.34-rc4/drivers/usb/mon/mon_stat.c
--- linux-2.6.34-rc3/drivers/usb/mon/mon_stat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/mon/mon_stat.c	2010-04-13 02:19:01.692633094 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/fs.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/drivers/usb/mon/mon_text.c linux-2.6.34-rc4/drivers/usb/mon/mon_text.c
--- linux-2.6.34-rc3/drivers/usb/mon/mon_text.c	2010-04-13 02:18:56.363633099 +0000
+++ linux-2.6.34-rc4/drivers/usb/mon/mon_text.c	2010-04-13 02:19:01.692633094 +0000
@@ -7,6 +7,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/mutex.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/drivers/usb/musb/blackfin.c linux-2.6.34-rc4/drivers/usb/musb/blackfin.c
--- linux-2.6.34-rc3/drivers/usb/musb/blackfin.c	2010-04-13 02:18:56.363633099 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/blackfin.c	2010-04-13 02:19:01.693633042 +0000
@@ -11,7 +11,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/gpio.h>
diff -urN linux-2.6.34-rc3/drivers/usb/musb/cppi_dma.c linux-2.6.34-rc4/drivers/usb/musb/cppi_dma.c
--- linux-2.6.34-rc3/drivers/usb/musb/cppi_dma.c	2010-04-13 02:18:56.363633099 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/cppi_dma.c	2010-04-13 02:19:01.693633042 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 
 #include "musb_core.h"
diff -urN linux-2.6.34-rc3/drivers/usb/musb/davinci.c linux-2.6.34-rc4/drivers/usb/musb/davinci.c
--- linux-2.6.34-rc3/drivers/usb/musb/davinci.c	2010-04-13 02:18:56.364633031 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/davinci.c	2010-04-13 02:19:01.693633042 +0000
@@ -24,7 +24,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/drivers/usb/musb/musb_gadget.c linux-2.6.34-rc4/drivers/usb/musb/musb_gadget.c
--- linux-2.6.34-rc3/drivers/usb/musb/musb_gadget.c	2010-04-13 02:18:56.365633089 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/musb_gadget.c	2010-04-13 02:19:01.694633017 +0000
@@ -43,6 +43,7 @@
 #include <linux/moduleparam.h>
 #include <linux/stat.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include "musb_core.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/musb/musb_virthub.c linux-2.6.34-rc4/drivers/usb/musb/musb_virthub.c
--- linux-2.6.34-rc3/drivers/usb/musb/musb_virthub.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/musb_virthub.c	2010-04-13 02:19:01.695633046 +0000
@@ -35,7 +35,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/drivers/usb/musb/musbhsdma.c linux-2.6.34-rc4/drivers/usb/musb/musbhsdma.c
--- linux-2.6.34-rc3/drivers/usb/musb/musbhsdma.c	2010-04-13 02:18:56.366571172 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/musbhsdma.c	2010-04-13 02:19:01.695633046 +0000
@@ -33,6 +33,7 @@
 #include <linux/device.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include "musb_core.h"
 #include "musbhsdma.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/musb/omap2430.c linux-2.6.34-rc4/drivers/usb/musb/omap2430.c
--- linux-2.6.34-rc3/drivers/usb/musb/omap2430.c	2010-04-13 02:18:56.366571172 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/omap2430.c	2010-04-13 02:19:01.696633099 +0000
@@ -27,7 +27,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/list.h>
 #include <linux/clk.h>
diff -urN linux-2.6.34-rc3/drivers/usb/musb/tusb6010_omap.c linux-2.6.34-rc4/drivers/usb/musb/tusb6010_omap.c
--- linux-2.6.34-rc3/drivers/usb/musb/tusb6010_omap.c	2010-04-13 02:18:56.366571172 +0000
+++ linux-2.6.34-rc4/drivers/usb/musb/tusb6010_omap.c	2010-04-13 02:19:01.696633099 +0000
@@ -15,6 +15,7 @@
 #include <linux/usb.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <plat/dma.h>
 #include <plat/mux.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/otg/gpio_vbus.c linux-2.6.34-rc4/drivers/usb/otg/gpio_vbus.c
--- linux-2.6.34-rc3/drivers/usb/otg/gpio_vbus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/otg/gpio_vbus.c	2010-04-13 02:19:01.696633099 +0000
@@ -11,6 +11,7 @@
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/usb.h>
 #include <linux/workqueue.h>
diff -urN linux-2.6.34-rc3/drivers/usb/otg/nop-usb-xceiv.c linux-2.6.34-rc4/drivers/usb/otg/nop-usb-xceiv.c
--- linux-2.6.34-rc3/drivers/usb/otg/nop-usb-xceiv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/otg/nop-usb-xceiv.c	2010-04-13 02:19:01.696633099 +0000
@@ -30,6 +30,7 @@
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/usb/otg.h>
+#include <linux/slab.h>
 
 struct nop_usb_xceiv {
 	struct otg_transceiver	otg;
diff -urN linux-2.6.34-rc3/drivers/usb/otg/twl4030-usb.c linux-2.6.34-rc4/drivers/usb/otg/twl4030-usb.c
--- linux-2.6.34-rc3/drivers/usb/otg/twl4030-usb.c	2010-04-13 02:18:56.366571172 +0000
+++ linux-2.6.34-rc4/drivers/usb/otg/twl4030-usb.c	2010-04-13 02:19:01.696633099 +0000
@@ -37,6 +37,7 @@
 #include <linux/regulator/consumer.h>
 #include <linux/err.h>
 #include <linux/notifier.h>
+#include <linux/slab.h>
 
 /* Register defines */
 
diff -urN linux-2.6.34-rc3/drivers/usb/otg/ulpi.c linux-2.6.34-rc4/drivers/usb/otg/ulpi.c
--- linux-2.6.34-rc3/drivers/usb/otg/ulpi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/otg/ulpi.c	2010-04-13 02:19:01.696633099 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/otg.h>
 #include <linux/usb/ulpi.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/aircable.c linux-2.6.34-rc4/drivers/usb/serial/aircable.c
--- linux-2.6.34-rc3/drivers/usb/serial/aircable.c	2010-04-13 02:18:56.367570450 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/aircable.c	2010-04-13 02:19:01.697633083 +0000
@@ -43,6 +43,7 @@
  */
 
 #include <linux/tty.h>
+#include <linux/slab.h>
 #include <linux/tty_flip.h>
 #include <linux/circ_buf.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/ark3116.c linux-2.6.34-rc4/drivers/usb/serial/ark3116.c
--- linux-2.6.34-rc3/drivers/usb/serial/ark3116.c	2010-04-13 02:18:56.367570450 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/ark3116.c	2010-04-13 02:19:01.697633083 +0000
@@ -26,6 +26,7 @@
 #include <linux/init.h>
 #include <linux/ioctl.h>
 #include <linux/tty.h>
+#include <linux/slab.h>
 #include <linux/tty_flip.h>
 #include <linux/module.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/bus.c linux-2.6.34-rc4/drivers/usb/serial/bus.c
--- linux-2.6.34-rc3/drivers/usb/serial/bus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/bus.c	2010-04-13 02:19:01.698633025 +0000
@@ -11,6 +11,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/tty.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/usb.h>
 #include <linux/usb/serial.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/ch341.c linux-2.6.34-rc4/drivers/usb/serial/ch341.c
--- linux-2.6.34-rc3/drivers/usb/serial/ch341.c	2010-04-13 02:18:56.367570450 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/ch341.c	2010-04-13 02:19:01.698633025 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/tty.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/serial.h>
 #include <linux/serial.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/navman.c linux-2.6.34-rc4/drivers/usb/serial/navman.c
--- linux-2.6.34-rc3/drivers/usb/serial/navman.c	2010-04-13 02:18:56.375633102 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/navman.c	2010-04-13 02:19:01.706633056 +0000
@@ -12,6 +12,7 @@
  *	flags as the navman is rx only so cannot echo.
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/tty.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/opticon.c linux-2.6.34-rc4/drivers/usb/serial/opticon.c
--- linux-2.6.34-rc3/drivers/usb/serial/opticon.c	2010-04-13 02:18:56.375633102 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/opticon.c	2010-04-13 02:19:01.706633056 +0000
@@ -13,6 +13,7 @@
 #include <linux/init.h>
 #include <linux/tty.h>
 #include <linux/tty_driver.h>
+#include <linux/slab.h>
 #include <linux/tty_flip.h>
 #include <linux/serial.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/option.c linux-2.6.34-rc4/drivers/usb/serial/option.c
--- linux-2.6.34-rc3/drivers/usb/serial/option.c	2010-04-13 02:18:56.375633102 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/option.c	2010-04-13 02:19:01.707633073 +0000
@@ -37,6 +37,7 @@
 #include <linux/errno.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/bitops.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/safe_serial.c linux-2.6.34-rc4/drivers/usb/serial/safe_serial.c
--- linux-2.6.34-rc3/drivers/usb/serial/safe_serial.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/safe_serial.c	2010-04-13 02:19:01.708633222 +0000
@@ -64,8 +64,8 @@
 
 #include <linux/kernel.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/tty_driver.h>
 #include <linux/tty_flip.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/sierra.c linux-2.6.34-rc4/drivers/usb/serial/sierra.c
--- linux-2.6.34-rc3/drivers/usb/serial/sierra.c	2010-04-13 02:18:56.376633020 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/sierra.c	2010-04-13 02:19:01.708633222 +0000
@@ -26,6 +26,7 @@
 #include <linux/jiffies.h>
 #include <linux/errno.h>
 #include <linux/tty.h>
+#include <linux/slab.h>
 #include <linux/tty_flip.h>
 #include <linux/module.h>
 #include <linux/usb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/symbolserial.c linux-2.6.34-rc4/drivers/usb/serial/symbolserial.c
--- linux-2.6.34-rc3/drivers/usb/serial/symbolserial.c	2010-04-13 02:18:56.377633078 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/symbolserial.c	2010-04-13 02:19:01.708633222 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/tty.h>
+#include <linux/slab.h>
 #include <linux/tty_driver.h>
 #include <linux/tty_flip.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/usb/serial/usb_debug.c linux-2.6.34-rc4/drivers/usb/serial/usb_debug.c
--- linux-2.6.34-rc3/drivers/usb/serial/usb_debug.c	2010-04-13 02:18:56.377633078 +0000
+++ linux-2.6.34-rc4/drivers/usb/serial/usb_debug.c	2010-04-13 02:19:01.709633056 +0000
@@ -8,6 +8,7 @@
  *	2 as published by the Free Software Foundation.
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/init.h>
 #include <linux/tty.h>
diff -urN linux-2.6.34-rc3/drivers/usb/storage/alauda.c linux-2.6.34-rc4/drivers/usb/storage/alauda.c
--- linux-2.6.34-rc3/drivers/usb/storage/alauda.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/alauda.c	2010-04-13 02:19:01.710594881 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/usb/storage/karma.c linux-2.6.34-rc4/drivers/usb/storage/karma.c
--- linux-2.6.34-rc3/drivers/usb/storage/karma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/karma.c	2010-04-13 02:19:01.710594881 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <scsi/scsi.h>
 #include <scsi/scsi_cmnd.h>
diff -urN linux-2.6.34-rc3/drivers/usb/storage/option_ms.c linux-2.6.34-rc4/drivers/usb/storage/option_ms.c
--- linux-2.6.34-rc3/drivers/usb/storage/option_ms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/option_ms.c	2010-04-13 02:19:01.710594881 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "usb.h"
 #include "transport.h"
diff -urN linux-2.6.34-rc3/drivers/usb/storage/scsiglue.c linux-2.6.34-rc4/drivers/usb/storage/scsiglue.c
--- linux-2.6.34-rc3/drivers/usb/storage/scsiglue.c	2010-04-13 02:18:56.378633064 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/scsiglue.c	2010-04-13 02:19:01.710594881 +0000
@@ -43,7 +43,6 @@
  * 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
-#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/storage/sierra_ms.c linux-2.6.34-rc4/drivers/usb/storage/sierra_ms.c
--- linux-2.6.34-rc3/drivers/usb/storage/sierra_ms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/sierra_ms.c	2010-04-13 02:19:01.711633057 +0000
@@ -3,6 +3,7 @@
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_device.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "usb.h"
 #include "transport.h"
diff -urN linux-2.6.34-rc3/drivers/usb/storage/transport.c linux-2.6.34-rc4/drivers/usb/storage/transport.c
--- linux-2.6.34-rc3/drivers/usb/storage/transport.c	2010-04-13 02:18:56.379571879 +0000
+++ linux-2.6.34-rc4/drivers/usb/storage/transport.c	2010-04-13 02:19:01.711633057 +0000
@@ -44,8 +44,8 @@
  */
 
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 
 #include <linux/usb/quirks.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/cbaf.c linux-2.6.34-rc4/drivers/usb/wusbcore/cbaf.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/cbaf.c	2010-04-13 02:18:56.379571879 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/cbaf.c	2010-04-13 02:19:01.712633056 +0000
@@ -92,6 +92,7 @@
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/uwb.h>
 #include <linux/usb/wusb.h>
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/crypto.c linux-2.6.34-rc4/drivers/usb/wusbcore/crypto.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/crypto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/crypto.c	2010-04-13 02:19:01.712633056 +0000
@@ -49,6 +49,7 @@
 #include <linux/module.h>
 #include <linux/err.h>
 #include <linux/uwb.h>
+#include <linux/slab.h>
 #include <linux/usb/wusb.h>
 #include <linux/scatterlist.h>
 
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/devconnect.c linux-2.6.34-rc4/drivers/usb/wusbcore/devconnect.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/devconnect.c	2010-04-13 02:18:56.380570467 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/devconnect.c	2010-04-13 02:19:01.712633056 +0000
@@ -88,6 +88,7 @@
 
 #include <linux/jiffies.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include "wusbhc.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/mmc.c linux-2.6.34-rc4/drivers/usb/wusbcore/mmc.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/mmc.c	2010-04-13 02:18:56.380570467 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/mmc.c	2010-04-13 02:19:01.712633056 +0000
@@ -37,6 +37,7 @@
  *  - add timers that autoremove intervalled IEs?
  */
 #include <linux/usb/wusb.h>
+#include <linux/slab.h>
 #include "wusbhc.h"
 
 /* Initialize the MMCIEs handling mechanism */
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/rh.c linux-2.6.34-rc4/drivers/usb/wusbcore/rh.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/rh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/rh.c	2010-04-13 02:19:01.712633056 +0000
@@ -69,6 +69,7 @@
  *
  * wusbhc_rh_start_port_reset() ??? unimplemented
  */
+#include <linux/slab.h>
 #include "wusbhc.h"
 
 /*
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/security.c linux-2.6.34-rc4/drivers/usb/wusbcore/security.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/security.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/security.c	2010-04-13 02:19:01.712633056 +0000
@@ -23,6 +23,7 @@
  * FIXME: docs
  */
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/usb/ch9.h>
 #include <linux/random.h>
 #include "wusbhc.h"
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/wa-hc.c linux-2.6.34-rc4/drivers/usb/wusbcore/wa-hc.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/wa-hc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/wa-hc.c	2010-04-13 02:19:01.712633056 +0000
@@ -22,6 +22,7 @@
  *
  * FIXME: docs
  */
+#include <linux/slab.h>
 #include "wusbhc.h"
 #include "wa-hc.h"
 
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/wa-nep.c linux-2.6.34-rc4/drivers/usb/wusbcore/wa-nep.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/wa-nep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/wa-nep.c	2010-04-13 02:19:01.713633064 +0000
@@ -51,6 +51,7 @@
  */
 #include <linux/workqueue.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 
 #include "wa-hc.h"
 #include "wusbhc.h"
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/wa-rpipe.c linux-2.6.34-rc4/drivers/usb/wusbcore/wa-rpipe.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/wa-rpipe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/wa-rpipe.c	2010-04-13 02:19:01.713633064 +0000
@@ -60,6 +60,7 @@
 #include <linux/init.h>
 #include <asm/atomic.h>
 #include <linux/bitmap.h>
+#include <linux/slab.h>
 
 #include "wusbhc.h"
 #include "wa-hc.h"
diff -urN linux-2.6.34-rc3/drivers/usb/wusbcore/wa-xfer.c linux-2.6.34-rc4/drivers/usb/wusbcore/wa-xfer.c
--- linux-2.6.34-rc3/drivers/usb/wusbcore/wa-xfer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/usb/wusbcore/wa-xfer.c	2010-04-13 02:19:01.713633064 +0000
@@ -81,6 +81,7 @@
  */
 #include <linux/init.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/hash.h>
 
 #include "wa-hc.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/address.c linux-2.6.34-rc4/drivers/uwb/address.c
--- linux-2.6.34-rc3/drivers/uwb/address.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/address.c	2010-04-13 02:19:01.713633064 +0000
@@ -23,6 +23,7 @@
  * FIXME: docs
  */
 
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/module.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/drivers/uwb/allocator.c linux-2.6.34-rc4/drivers/uwb/allocator.c
--- linux-2.6.34-rc3/drivers/uwb/allocator.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/allocator.c	2010-04-13 02:19:01.713633064 +0000
@@ -16,6 +16,7 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/uwb.h>
 
 #include "uwb-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/beacon.c linux-2.6.34-rc4/drivers/uwb/beacon.c
--- linux-2.6.34-rc3/drivers/uwb/beacon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/beacon.c	2010-04-13 02:19:01.713633064 +0000
@@ -28,6 +28,7 @@
 #include <linux/device.h>
 #include <linux/err.h>
 #include <linux/kdev_t.h>
+#include <linux/slab.h>
 
 #include "uwb-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/drp-ie.c linux-2.6.34-rc4/drivers/uwb/drp-ie.c
--- linux-2.6.34-rc3/drivers/uwb/drp-ie.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/drp-ie.c	2010-04-13 02:19:01.714633048 +0000
@@ -18,6 +18,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/uwb.h>
 
 #include "uwb-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/drp.c linux-2.6.34-rc4/drivers/uwb/drp.c
--- linux-2.6.34-rc3/drivers/uwb/drp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/drp.c	2010-04-13 02:19:01.714633048 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/kthread.h>
 #include <linux/freezer.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include "uwb-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/est.c linux-2.6.34-rc4/drivers/uwb/est.c
--- linux-2.6.34-rc3/drivers/uwb/est.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/est.c	2010-04-13 02:19:01.714633048 +0000
@@ -40,6 +40,7 @@
  *   uwb_est_get_size()
  */
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include "uwb-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/hwa-rc.c linux-2.6.34-rc4/drivers/uwb/hwa-rc.c
--- linux-2.6.34-rc3/drivers/uwb/hwa-rc.c	2010-04-13 02:18:56.380570467 +0000
+++ linux-2.6.34-rc4/drivers/uwb/hwa-rc.c	2010-04-13 02:19:01.714633048 +0000
@@ -53,6 +53,7 @@
  */
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/wusb.h>
 #include <linux/usb/wusb-wa.h>
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/dfu/mac.c linux-2.6.34-rc4/drivers/uwb/i1480/dfu/mac.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/dfu/mac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/dfu/mac.c	2010-04-13 02:19:01.714633048 +0000
@@ -28,6 +28,7 @@
  */
 #include <linux/delay.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <linux/uwb.h>
 #include "i1480-dfu.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/dfu/usb.c linux-2.6.34-rc4/drivers/uwb/i1480/dfu/usb.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/dfu/usb.c	2010-04-13 02:18:56.380570467 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/dfu/usb.c	2010-04-13 02:19:01.714633048 +0000
@@ -37,6 +37,7 @@
 #include <linux/module.h>
 #include <linux/usb.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/uwb.h>
 #include <linux/usb/wusb.h>
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/lc.c linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/lc.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/lc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/lc.c	2010-04-13 02:19:01.715633023 +0000
@@ -55,6 +55,7 @@
  *                          is being removed.
  *         i1480u_rm()
  */
+#include <linux/gfp.h>
 #include <linux/if_arp.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/netdev.c linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/netdev.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/netdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/netdev.c	2010-04-13 02:19:01.715633023 +0000
@@ -39,6 +39,7 @@
  *     i1480u_set_config():
  */
 
+#include <linux/slab.h>
 #include <linux/if_arp.h>
 #include <linux/etherdevice.h>
 
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/rx.c linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/rx.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/rx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/rx.c	2010-04-13 02:19:01.715633023 +0000
@@ -64,6 +64,7 @@
  *
  */
 
+#include <linux/gfp.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
 #include "i1480u-wlp.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/tx.c linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/tx.c
--- linux-2.6.34-rc3/drivers/uwb/i1480/i1480u-wlp/tx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/i1480/i1480u-wlp/tx.c	2010-04-13 02:19:01.715633023 +0000
@@ -54,6 +54,7 @@
  *          the times the MTU will be smaller than one page...
  */
 
+#include <linux/slab.h>
 #include "i1480u-wlp.h"
 
 enum {
diff -urN linux-2.6.34-rc3/drivers/uwb/ie.c linux-2.6.34-rc4/drivers/uwb/ie.c
--- linux-2.6.34-rc3/drivers/uwb/ie.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/ie.c	2010-04-13 02:19:01.715633023 +0000
@@ -24,6 +24,7 @@
  * FIXME: docs
  */
 
+#include <linux/slab.h>
 #include "uwb-internal.h"
 
 /**
diff -urN linux-2.6.34-rc3/drivers/uwb/lc-dev.c linux-2.6.34-rc4/drivers/uwb/lc-dev.c
--- linux-2.6.34-rc3/drivers/uwb/lc-dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/lc-dev.c	2010-04-13 02:19:01.715633023 +0000
@@ -23,6 +23,7 @@
  * FIXME: docs
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/err.h>
 #include <linux/kdev_t.h>
diff -urN linux-2.6.34-rc3/drivers/uwb/lc-rc.c linux-2.6.34-rc4/drivers/uwb/lc-rc.c
--- linux-2.6.34-rc3/drivers/uwb/lc-rc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/lc-rc.c	2010-04-13 02:19:01.715633023 +0000
@@ -35,6 +35,7 @@
 #include <linux/kdev_t.h>
 #include <linux/etherdevice.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "uwb-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/neh.c linux-2.6.34-rc4/drivers/uwb/neh.c
--- linux-2.6.34-rc3/drivers/uwb/neh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/neh.c	2010-04-13 02:19:01.715633023 +0000
@@ -83,6 +83,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 
 #include "uwb-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/reset.c linux-2.6.34-rc4/drivers/uwb/reset.c
--- linux-2.6.34-rc3/drivers/uwb/reset.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/reset.c	2010-04-13 02:19:01.715633023 +0000
@@ -30,6 +30,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include "uwb-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/rsv.c linux-2.6.34-rc4/drivers/uwb/rsv.c
--- linux-2.6.34-rc3/drivers/uwb/rsv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/rsv.c	2010-04-13 02:19:01.716633085 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/uwb.h>
+#include <linux/slab.h>
 #include <linux/random.h>
 
 #include "uwb-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/scan.c linux-2.6.34-rc4/drivers/uwb/scan.c
--- linux-2.6.34-rc3/drivers/uwb/scan.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/scan.c	2010-04-13 02:19:01.716633085 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/device.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include "uwb-internal.h"
 
 
diff -urN linux-2.6.34-rc3/drivers/uwb/umc-dev.c linux-2.6.34-rc4/drivers/uwb/umc-dev.c
--- linux-2.6.34-rc3/drivers/uwb/umc-dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/umc-dev.c	2010-04-13 02:19:01.716633085 +0000
@@ -6,6 +6,7 @@
  * This file is released under the GNU GPL v2.
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/uwb/umc.h>
 
 static void umc_device_release(struct device *dev)
diff -urN linux-2.6.34-rc3/drivers/uwb/uwbd.c linux-2.6.34-rc4/drivers/uwb/uwbd.c
--- linux-2.6.34-rc3/drivers/uwb/uwbd.c	2010-04-13 02:18:56.380570467 +0000
+++ linux-2.6.34-rc4/drivers/uwb/uwbd.c	2010-04-13 02:19:01.716633085 +0000
@@ -69,6 +69,7 @@
  * Handler functions are called normally uwbd_evt_handle_*().
  */
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/freezer.h>
 
diff -urN linux-2.6.34-rc3/drivers/uwb/whc-rc.c linux-2.6.34-rc4/drivers/uwb/whc-rc.c
--- linux-2.6.34-rc3/drivers/uwb/whc-rc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/whc-rc.c	2010-04-13 02:19:01.716633085 +0000
@@ -45,6 +45,7 @@
 #include <linux/sched.h>
 #include <linux/dma-mapping.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/uwb.h>
 #include <linux/uwb/whci.h>
diff -urN linux-2.6.34-rc3/drivers/uwb/whci.c linux-2.6.34-rc4/drivers/uwb/whci.c
--- linux-2.6.34-rc3/drivers/uwb/whci.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/whci.c	2010-04-13 02:19:01.716633085 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/uwb/whci.h>
 #include <linux/uwb/umc.h>
 
diff -urN linux-2.6.34-rc3/drivers/uwb/wlp/eda.c linux-2.6.34-rc4/drivers/uwb/wlp/eda.c
--- linux-2.6.34-rc3/drivers/uwb/wlp/eda.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/wlp/eda.c	2010-04-13 02:19:01.716633085 +0000
@@ -53,6 +53,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <linux/wlp.h>
 #include "wlp-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/wlp/messages.c linux-2.6.34-rc4/drivers/uwb/wlp/messages.c
--- linux-2.6.34-rc3/drivers/uwb/wlp/messages.c	2010-04-13 02:18:56.381633107 +0000
+++ linux-2.6.34-rc4/drivers/uwb/wlp/messages.c	2010-04-13 02:19:01.717633858 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/wlp.h>
+#include <linux/slab.h>
 
 #include "wlp-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/wlp/txrx.c linux-2.6.34-rc4/drivers/uwb/wlp/txrx.c
--- linux-2.6.34-rc3/drivers/uwb/wlp/txrx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/wlp/txrx.c	2010-04-13 02:19:01.717633858 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <linux/wlp.h>
 
 #include "wlp-internal.h"
diff -urN linux-2.6.34-rc3/drivers/uwb/wlp/wlp-lc.c linux-2.6.34-rc4/drivers/uwb/wlp/wlp-lc.c
--- linux-2.6.34-rc3/drivers/uwb/wlp/wlp-lc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/wlp/wlp-lc.c	2010-04-13 02:19:01.717633858 +0000
@@ -22,6 +22,7 @@
  * FIXME: docs
  */
 #include <linux/wlp.h>
+#include <linux/slab.h>
 
 #include "wlp-internal.h"
 
diff -urN linux-2.6.34-rc3/drivers/uwb/wlp/wss-lc.c linux-2.6.34-rc4/drivers/uwb/wlp/wss-lc.c
--- linux-2.6.34-rc3/drivers/uwb/wlp/wss-lc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/uwb/wlp/wss-lc.c	2010-04-13 02:19:01.717633858 +0000
@@ -45,6 +45,7 @@
  */
 #include <linux/etherdevice.h> /* for is_valid_ether_addr */
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/wlp.h>
 
 #include "wlp-internal.h"
diff -urN linux-2.6.34-rc3/drivers/vhost/net.c linux-2.6.34-rc4/drivers/vhost/net.c
--- linux-2.6.34-rc3/drivers/vhost/net.c	2010-04-13 02:18:56.381633107 +0000
+++ linux-2.6.34-rc4/drivers/vhost/net.c	2010-04-13 02:19:01.718633335 +0000
@@ -17,6 +17,7 @@
 #include <linux/workqueue.h>
 #include <linux/rcupdate.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 
 #include <linux/net.h>
 #include <linux/if_packet.h>
diff -urN linux-2.6.34-rc3/drivers/vhost/vhost.c linux-2.6.34-rc4/drivers/vhost/vhost.c
--- linux-2.6.34-rc3/drivers/vhost/vhost.c	2010-04-13 02:18:56.382633042 +0000
+++ linux-2.6.34-rc4/drivers/vhost/vhost.c	2010-04-13 02:19:01.718633335 +0000
@@ -22,6 +22,7 @@
 #include <linux/poll.h>
 #include <linux/file.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 
 #include <linux/net.h>
 #include <linux/if_packet.h>
diff -urN linux-2.6.34-rc3/drivers/video/68328fb.c linux-2.6.34-rc4/drivers/video/68328fb.c
--- linux-2.6.34-rc3/drivers/video/68328fb.c	2010-04-13 02:18:56.382633042 +0000
+++ linux-2.6.34-rc4/drivers/video/68328fb.c	2010-04-13 02:19:01.719633622 +0000
@@ -32,7 +32,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/acornfb.c linux-2.6.34-rc4/drivers/video/acornfb.c
--- linux-2.6.34-rc3/drivers/video/acornfb.c	2010-04-13 02:18:56.383633041 +0000
+++ linux-2.6.34-rc4/drivers/video/acornfb.c	2010-04-13 02:19:01.719633622 +0000
@@ -22,13 +22,13 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/ctype.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/init.h>
 #include <linux/fb.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 
 #include <mach/hardware.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/video/amifb.c linux-2.6.34-rc4/drivers/video/amifb.c
--- linux-2.6.34-rc3/drivers/video/amifb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/amifb.c	2010-04-13 02:19:01.720633123 +0000
@@ -45,7 +45,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/arcfb.c linux-2.6.34-rc4/drivers/video/arcfb.c
--- linux-2.6.34-rc3/drivers/video/arcfb.c	2010-04-13 02:18:56.383633041 +0000
+++ linux-2.6.34-rc4/drivers/video/arcfb.c	2010-04-13 02:19:01.720633123 +0000
@@ -39,7 +39,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/asiliantfb.c linux-2.6.34-rc4/drivers/video/asiliantfb.c
--- linux-2.6.34-rc3/drivers/video/asiliantfb.c	2010-04-13 02:18:56.383633041 +0000
+++ linux-2.6.34-rc4/drivers/video/asiliantfb.c	2010-04-13 02:19:01.720633123 +0000
@@ -34,7 +34,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/atafb.c linux-2.6.34-rc4/drivers/video/atafb.c
--- linux-2.6.34-rc3/drivers/video/atafb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/atafb.c	2010-04-13 02:19:01.721633122 +0000
@@ -52,7 +52,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/atmel_lcdfb.c linux-2.6.34-rc4/drivers/video/atmel_lcdfb.c
--- linux-2.6.34-rc3/drivers/video/atmel_lcdfb.c	2010-04-13 02:18:56.383633041 +0000
+++ linux-2.6.34-rc4/drivers/video/atmel_lcdfb.c	2010-04-13 02:19:01.721633122 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/backlight.h>
+#include <linux/gfp.h>
 
 #include <mach/board.h>
 #include <mach/cpu.h>
diff -urN linux-2.6.34-rc3/drivers/video/aty/aty128fb.c linux-2.6.34-rc4/drivers/video/aty/aty128fb.c
--- linux-2.6.34-rc3/drivers/video/aty/aty128fb.c	2010-04-13 02:18:56.384633033 +0000
+++ linux-2.6.34-rc4/drivers/video/aty/aty128fb.c	2010-04-13 02:19:01.721633122 +0000
@@ -52,7 +52,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/aty/mach64_cursor.c linux-2.6.34-rc4/drivers/video/aty/mach64_cursor.c
--- linux-2.6.34-rc3/drivers/video/aty/mach64_cursor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/aty/mach64_cursor.c	2010-04-13 02:19:01.722633127 +0000
@@ -2,7 +2,6 @@
  *  ATI Mach64 CT/VT/GT/LT Cursor Support
  */
 
-#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/init.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/drivers/video/aty/radeon_backlight.c linux-2.6.34-rc4/drivers/video/aty/radeon_backlight.c
--- linux-2.6.34-rc3/drivers/video/aty/radeon_backlight.c	2010-04-13 02:18:56.384633033 +0000
+++ linux-2.6.34-rc4/drivers/video/aty/radeon_backlight.c	2010-04-13 02:19:01.722633127 +0000
@@ -12,6 +12,7 @@
 
 #include "radeonfb.h"
 #include <linux/backlight.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_PMAC_BACKLIGHT
 #include <asm/backlight.h>
diff -urN linux-2.6.34-rc3/drivers/video/aty/radeon_monitor.c linux-2.6.34-rc4/drivers/video/aty/radeon_monitor.c
--- linux-2.6.34-rc3/drivers/video/aty/radeon_monitor.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/aty/radeon_monitor.c	2010-04-13 02:19:01.722633127 +0000
@@ -1,4 +1,7 @@
 #include "radeonfb.h"
+
+#include <linux/slab.h>
+
 #include "../edid.h"
 
 static struct fb_var_screeninfo radeonfb_default_var = {
diff -urN linux-2.6.34-rc3/drivers/video/au1100fb.c linux-2.6.34-rc4/drivers/video/au1100fb.c
--- linux-2.6.34-rc3/drivers/video/au1100fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/au1100fb.c	2010-04-13 02:19:01.722633127 +0000
@@ -52,6 +52,7 @@
 #include <linux/ctype.h>
 #include <linux/dma-mapping.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/mach-au1x00/au1000.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/au1200fb.c linux-2.6.34-rc4/drivers/video/au1200fb.c
--- linux-2.6.34-rc3/drivers/video/au1200fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/au1200fb.c	2010-04-13 02:19:01.723633084 +0000
@@ -41,6 +41,7 @@
 #include <linux/interrupt.h>
 #include <linux/ctype.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 
 #include <asm/mach-au1x00/au1000.h>
 #include "au1200fb.h"
diff -urN linux-2.6.34-rc3/drivers/video/backlight/88pm860x_bl.c linux-2.6.34-rc4/drivers/video/backlight/88pm860x_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/88pm860x_bl.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/88pm860x_bl.c	2010-04-13 02:19:01.723633084 +0000
@@ -16,6 +16,7 @@
 #include <linux/i2c.h>
 #include <linux/backlight.h>
 #include <linux/mfd/88pm860x.h>
+#include <linux/slab.h>
 
 #define MAX_BRIGHTNESS		(0xFF)
 #define MIN_BRIGHTNESS		(0)
diff -urN linux-2.6.34-rc3/drivers/video/backlight/adp5520_bl.c linux-2.6.34-rc4/drivers/video/backlight/adp5520_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/adp5520_bl.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/adp5520_bl.c	2010-04-13 02:19:01.724633515 +0000
@@ -12,6 +12,7 @@
 #include <linux/fb.h>
 #include <linux/backlight.h>
 #include <linux/mfd/adp5520.h>
+#include <linux/slab.h>
 
 struct adp5520_bl {
 	struct device *master;
diff -urN linux-2.6.34-rc3/drivers/video/backlight/adx_bl.c linux-2.6.34-rc4/drivers/video/backlight/adx_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/adx_bl.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/adx_bl.c	2010-04-13 02:19:01.724633515 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/backlight.h>
 #include <linux/fb.h>
+#include <linux/gfp.h>
 #include <linux/io.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/backlight/atmel-pwm-bl.c linux-2.6.34-rc4/drivers/video/backlight/atmel-pwm-bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/atmel-pwm-bl.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/atmel-pwm-bl.c	2010-04-13 02:19:01.724633515 +0000
@@ -17,6 +17,7 @@
 #include <linux/backlight.h>
 #include <linux/atmel_pwm.h>
 #include <linux/atmel-pwm-bl.h>
+#include <linux/slab.h>
 
 struct atmel_pwm_bl {
 	const struct atmel_pwm_bl_platform_data	*pdata;
diff -urN linux-2.6.34-rc3/drivers/video/backlight/backlight.c linux-2.6.34-rc4/drivers/video/backlight/backlight.c
--- linux-2.6.34-rc3/drivers/video/backlight/backlight.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/backlight.c	2010-04-13 02:19:01.724633515 +0000
@@ -13,6 +13,7 @@
 #include <linux/ctype.h>
 #include <linux/err.h>
 #include <linux/fb.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_PMAC_BACKLIGHT
 #include <asm/backlight.h>
diff -urN linux-2.6.34-rc3/drivers/video/backlight/corgi_lcd.c linux-2.6.34-rc4/drivers/video/backlight/corgi_lcd.c
--- linux-2.6.34-rc3/drivers/video/backlight/corgi_lcd.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/corgi_lcd.c	2010-04-13 02:19:01.724633515 +0000
@@ -24,6 +24,7 @@
 #include <linux/lcd.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/corgi_lcd.h>
+#include <linux/slab.h>
 #include <asm/mach/sharpsl_param.h>
 
 #define POWER_IS_ON(pwr)	((pwr) <= FB_BLANK_NORMAL)
diff -urN linux-2.6.34-rc3/drivers/video/backlight/cr_bllcd.c linux-2.6.34-rc4/drivers/video/backlight/cr_bllcd.c
--- linux-2.6.34-rc3/drivers/video/backlight/cr_bllcd.c	2010-04-13 02:18:56.385633076 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/cr_bllcd.c	2010-04-13 02:19:01.724633515 +0000
@@ -36,6 +36,7 @@
 #include <linux/backlight.h>
 #include <linux/lcd.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 /* The LVDS- and panel power controls sits on the
  * GPIO port of the ISA bridge.
diff -urN linux-2.6.34-rc3/drivers/video/backlight/da903x_bl.c linux-2.6.34-rc4/drivers/video/backlight/da903x_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/da903x_bl.c	2010-04-13 02:18:56.386633069 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/da903x_bl.c	2010-04-13 02:19:01.724633515 +0000
@@ -18,6 +18,7 @@
 #include <linux/fb.h>
 #include <linux/backlight.h>
 #include <linux/mfd/da903x.h>
+#include <linux/slab.h>
 
 #define DA9030_WLED_CONTROL	0x25
 #define DA9030_WLED_CP_EN	(1 << 6)
diff -urN linux-2.6.34-rc3/drivers/video/backlight/ili9320.c linux-2.6.34-rc4/drivers/video/backlight/ili9320.c
--- linux-2.6.34-rc3/drivers/video/backlight/ili9320.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/ili9320.c	2010-04-13 02:19:01.725633076 +0000
@@ -17,6 +17,7 @@
 #include <linux/init.h>
 #include <linux/lcd.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/backlight/l4f00242t03.c linux-2.6.34-rc4/drivers/video/backlight/l4f00242t03.c
--- linux-2.6.34-rc3/drivers/video/backlight/l4f00242t03.c	2010-04-13 02:18:56.386633069 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/l4f00242t03.c	2010-04-13 02:19:01.725633076 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/gpio.h>
 #include <linux/lcd.h>
+#include <linux/slab.h>
 #include <linux/regulator/consumer.h>
 
 #include <linux/spi/spi.h>
diff -urN linux-2.6.34-rc3/drivers/video/backlight/lcd.c linux-2.6.34-rc4/drivers/video/backlight/lcd.c
--- linux-2.6.34-rc3/drivers/video/backlight/lcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/lcd.c	2010-04-13 02:19:01.725633076 +0000
@@ -13,6 +13,7 @@
 #include <linux/ctype.h>
 #include <linux/err.h>
 #include <linux/fb.h>
+#include <linux/slab.h>
 
 #if defined(CONFIG_FB) || (defined(CONFIG_FB_MODULE) && \
 			   defined(CONFIG_LCD_CLASS_DEVICE_MODULE))
diff -urN linux-2.6.34-rc3/drivers/video/backlight/lms283gf05.c linux-2.6.34-rc4/drivers/video/backlight/lms283gf05.c
--- linux-2.6.34-rc3/drivers/video/backlight/lms283gf05.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/lms283gf05.c	2010-04-13 02:19:01.725633076 +0000
@@ -11,6 +11,7 @@
 #include <linux/device.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/lcd.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/backlight/ltv350qv.c linux-2.6.34-rc4/drivers/video/backlight/ltv350qv.c
--- linux-2.6.34-rc3/drivers/video/backlight/ltv350qv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/ltv350qv.c	2010-04-13 02:19:01.726633439 +0000
@@ -13,6 +13,7 @@
 #include <linux/init.h>
 #include <linux/lcd.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spi/spi.h>
 
 #include "ltv350qv.h"
diff -urN linux-2.6.34-rc3/drivers/video/backlight/max8925_bl.c linux-2.6.34-rc4/drivers/video/backlight/max8925_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/max8925_bl.c	2010-04-13 02:18:56.386633069 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/max8925_bl.c	2010-04-13 02:19:01.726633439 +0000
@@ -16,6 +16,7 @@
 #include <linux/i2c.h>
 #include <linux/backlight.h>
 #include <linux/mfd/max8925.h>
+#include <linux/slab.h>
 
 #define MAX_BRIGHTNESS		(0xff)
 #define MIN_BRIGHTNESS		(0)
diff -urN linux-2.6.34-rc3/drivers/video/backlight/omap1_bl.c linux-2.6.34-rc4/drivers/video/backlight/omap1_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/omap1_bl.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/omap1_bl.c	2010-04-13 02:19:01.726633439 +0000
@@ -24,6 +24,7 @@
 #include <linux/platform_device.h>
 #include <linux/fb.h>
 #include <linux/backlight.h>
+#include <linux/slab.h>
 
 #include <mach/hardware.h>
 #include <plat/board.h>
diff -urN linux-2.6.34-rc3/drivers/video/backlight/platform_lcd.c linux-2.6.34-rc4/drivers/video/backlight/platform_lcd.c
--- linux-2.6.34-rc3/drivers/video/backlight/platform_lcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/platform_lcd.c	2010-04-13 02:19:01.726633439 +0000
@@ -16,6 +16,7 @@
 #include <linux/fb.h>
 #include <linux/backlight.h>
 #include <linux/lcd.h>
+#include <linux/slab.h>
 
 #include <video/platform_lcd.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/backlight/pwm_bl.c linux-2.6.34-rc4/drivers/video/backlight/pwm_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/pwm_bl.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/pwm_bl.c	2010-04-13 02:19:01.726633439 +0000
@@ -19,6 +19,7 @@
 #include <linux/err.h>
 #include <linux/pwm.h>
 #include <linux/pwm_backlight.h>
+#include <linux/slab.h>
 
 struct pwm_bl_data {
 	struct pwm_device	*pwm;
diff -urN linux-2.6.34-rc3/drivers/video/backlight/tdo24m.c linux-2.6.34-rc4/drivers/video/backlight/tdo24m.c
--- linux-2.6.34-rc3/drivers/video/backlight/tdo24m.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/tdo24m.c	2010-04-13 02:19:01.726633439 +0000
@@ -17,6 +17,7 @@
 #include <linux/spi/tdo24m.h>
 #include <linux/fb.h>
 #include <linux/lcd.h>
+#include <linux/slab.h>
 
 #define POWER_IS_ON(pwr)	((pwr) <= FB_BLANK_NORMAL)
 
diff -urN linux-2.6.34-rc3/drivers/video/backlight/tosa_bl.c linux-2.6.34-rc4/drivers/video/backlight/tosa_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/tosa_bl.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/tosa_bl.c	2010-04-13 02:19:01.726633439 +0000
@@ -18,6 +18,7 @@
 #include <linux/gpio.h>
 #include <linux/fb.h>
 #include <linux/backlight.h>
+#include <linux/slab.h>
 
 #include <asm/mach/sharpsl_param.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/backlight/tosa_lcd.c linux-2.6.34-rc4/drivers/video/backlight/tosa_lcd.c
--- linux-2.6.34-rc3/drivers/video/backlight/tosa_lcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/tosa_lcd.c	2010-04-13 02:19:01.727633798 +0000
@@ -15,6 +15,7 @@
 #include <linux/device.h>
 #include <linux/spi/spi.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/gpio.h>
 #include <linux/delay.h>
 #include <linux/lcd.h>
diff -urN linux-2.6.34-rc3/drivers/video/backlight/wm831x_bl.c linux-2.6.34-rc4/drivers/video/backlight/wm831x_bl.c
--- linux-2.6.34-rc3/drivers/video/backlight/wm831x_bl.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/backlight/wm831x_bl.c	2010-04-13 02:19:01.727633798 +0000
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/fb.h>
 #include <linux/backlight.h>
+#include <linux/slab.h>
 
 #include <linux/mfd/wm831x/core.h>
 #include <linux/mfd/wm831x/pdata.h>
diff -urN linux-2.6.34-rc3/drivers/video/bfin-lq035q1-fb.c linux-2.6.34-rc4/drivers/video/bfin-lq035q1-fb.c
--- linux-2.6.34-rc3/drivers/video/bfin-lq035q1-fb.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/bfin-lq035q1-fb.c	2010-04-13 02:19:01.727633798 +0000
@@ -13,6 +13,7 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/fb.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/types.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/bfin-t350mcqb-fb.c linux-2.6.34-rc4/drivers/video/bfin-t350mcqb-fb.c
--- linux-2.6.34-rc3/drivers/video/bfin-t350mcqb-fb.c	2010-04-13 02:18:56.387633037 +0000
+++ linux-2.6.34-rc4/drivers/video/bfin-t350mcqb-fb.c	2010-04-13 02:19:01.727633798 +0000
@@ -32,6 +32,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 #include <linux/fb.h>
 #include <linux/init.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/drivers/video/bw2.c linux-2.6.34-rc4/drivers/video/bw2.c
--- linux-2.6.34-rc3/drivers/video/bw2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/bw2.c	2010-04-13 02:19:01.728633185 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/carminefb.c linux-2.6.34-rc4/drivers/video/carminefb.c
--- linux-2.6.34-rc3/drivers/video/carminefb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/carminefb.c	2010-04-13 02:19:01.728633185 +0000
@@ -11,6 +11,7 @@
 #include <linux/fb.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "carminefb.h"
 #include "carminefb_regs.h"
diff -urN linux-2.6.34-rc3/drivers/video/cfbcopyarea.c linux-2.6.34-rc4/drivers/video/cfbcopyarea.c
--- linux-2.6.34-rc3/drivers/video/cfbcopyarea.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/cfbcopyarea.c	2010-04-13 02:19:01.728633185 +0000
@@ -26,7 +26,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/fb.h>
-#include <linux/slab.h>
 #include <asm/types.h>
 #include <asm/io.h>
 #include "fb_draw.h"
diff -urN linux-2.6.34-rc3/drivers/video/cg14.c linux-2.6.34-rc4/drivers/video/cg14.c
--- linux-2.6.34-rc3/drivers/video/cg14.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/cg14.c	2010-04-13 02:19:01.728633185 +0000
@@ -11,7 +11,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/cg3.c linux-2.6.34-rc4/drivers/video/cg3.c
--- linux-2.6.34-rc3/drivers/video/cg3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/cg3.c	2010-04-13 02:19:01.728633185 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/cg6.c linux-2.6.34-rc4/drivers/video/cg6.c
--- linux-2.6.34-rc3/drivers/video/cg6.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/cg6.c	2010-04-13 02:19:01.729633487 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/chipsfb.c linux-2.6.34-rc4/drivers/video/chipsfb.c
--- linux-2.6.34-rc3/drivers/video/chipsfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/chipsfb.c	2010-04-13 02:19:01.729633487 +0000
@@ -19,7 +19,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/cirrusfb.c linux-2.6.34-rc4/drivers/video/cirrusfb.c
--- linux-2.6.34-rc3/drivers/video/cirrusfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/cirrusfb.c	2010-04-13 02:19:01.729633487 +0000
@@ -39,7 +39,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/bitblit.c linux-2.6.34-rc4/drivers/video/console/bitblit.c
--- linux-2.6.34-rc3/drivers/video/console/bitblit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/bitblit.c	2010-04-13 02:19:01.729633487 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/vt_kern.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/fbcon_ccw.c linux-2.6.34-rc4/drivers/video/console/fbcon_ccw.c
--- linux-2.6.34-rc3/drivers/video/console/fbcon_ccw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/fbcon_ccw.c	2010-04-13 02:19:01.730633432 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/vt_kern.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/fbcon_cw.c linux-2.6.34-rc4/drivers/video/console/fbcon_cw.c
--- linux-2.6.34-rc3/drivers/video/console/fbcon_cw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/fbcon_cw.c	2010-04-13 02:19:01.730633432 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/vt_kern.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/fbcon_rotate.c linux-2.6.34-rc4/drivers/video/console/fbcon_rotate.c
--- linux-2.6.34-rc3/drivers/video/console/fbcon_rotate.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/fbcon_rotate.c	2010-04-13 02:19:01.730633432 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/vt_kern.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/fbcon_ud.c linux-2.6.34-rc4/drivers/video/console/fbcon_ud.c
--- linux-2.6.34-rc3/drivers/video/console/fbcon_ud.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/fbcon_ud.c	2010-04-13 02:19:01.730633432 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/vt_kern.h>
diff -urN linux-2.6.34-rc3/drivers/video/console/mdacon.c linux-2.6.34-rc4/drivers/video/console/mdacon.c
--- linux-2.6.34-rc3/drivers/video/console/mdacon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/console/mdacon.c	2010-04-13 02:19:01.730633432 +0000
@@ -33,7 +33,6 @@
 #include <linux/console.h>
 #include <linux/string.h>
 #include <linux/kd.h>
-#include <linux/slab.h>
 #include <linux/vt_kern.h>
 #include <linux/vt_buffer.h>
 #include <linux/selection.h>
diff -urN linux-2.6.34-rc3/drivers/video/da8xx-fb.c linux-2.6.34-rc4/drivers/video/da8xx-fb.c
--- linux-2.6.34-rc3/drivers/video/da8xx-fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/da8xx-fb.c	2010-04-13 02:19:01.731633485 +0000
@@ -30,6 +30,7 @@
 #include <linux/clk.h>
 #include <linux/cpufreq.h>
 #include <linux/console.h>
+#include <linux/slab.h>
 #include <video/da8xx-fb.h>
 
 #define DRIVER_NAME "da8xx_lcdc"
diff -urN linux-2.6.34-rc3/drivers/video/display/display-sysfs.c linux-2.6.34-rc4/drivers/video/display/display-sysfs.c
--- linux-2.6.34-rc3/drivers/video/display/display-sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/display/display-sysfs.c	2010-04-13 02:19:01.731633485 +0000
@@ -27,6 +27,7 @@
 #include <linux/idr.h>
 #include <linux/err.h>
 #include <linux/kdev_t.h>
+#include <linux/slab.h>
 
 static ssize_t display_show_name(struct device *dev,
 				struct device_attribute *attr, char *buf)
diff -urN linux-2.6.34-rc3/drivers/video/dnfb.c linux-2.6.34-rc4/drivers/video/dnfb.c
--- linux-2.6.34-rc3/drivers/video/dnfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/dnfb.c	2010-04-13 02:19:01.731633485 +0000
@@ -2,7 +2,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/ep93xx-fb.c linux-2.6.34-rc4/drivers/video/ep93xx-fb.c
--- linux-2.6.34-rc3/drivers/video/ep93xx-fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/ep93xx-fb.c	2010-04-13 02:19:01.731633485 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/clk.h>
 #include <linux/fb.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/epson1355fb.c linux-2.6.34-rc4/drivers/video/epson1355fb.c
--- linux-2.6.34-rc3/drivers/video/epson1355fb.c	2010-04-13 02:18:56.389571940 +0000
+++ linux-2.6.34-rc4/drivers/video/epson1355fb.c	2010-04-13 02:19:01.731633485 +0000
@@ -48,7 +48,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/video/fb_ddc.c linux-2.6.34-rc4/drivers/video/fb_ddc.c
--- linux-2.6.34-rc3/drivers/video/fb_ddc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/fb_ddc.c	2010-04-13 02:19:01.732633154 +0000
@@ -12,6 +12,7 @@
 #include <linux/device.h>
 #include <linux/fb.h>
 #include <linux/i2c-algo-bit.h>
+#include <linux/slab.h>
 
 #include "edid.h"
 
diff -urN linux-2.6.34-rc3/drivers/video/fb_defio.c linux-2.6.34-rc4/drivers/video/fb_defio.c
--- linux-2.6.34-rc3/drivers/video/fb_defio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/fb_defio.c	2010-04-13 02:19:01.732633154 +0000
@@ -13,7 +13,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/fbcvt.c linux-2.6.34-rc4/drivers/video/fbcvt.c
--- linux-2.6.34-rc3/drivers/video/fbcvt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/fbcvt.c	2010-04-13 02:19:01.732633154 +0000
@@ -13,6 +13,7 @@
  *
  */
 #include <linux/fb.h>
+#include <linux/slab.h>
 
 #define FB_CVT_CELLSIZE               8
 #define FB_CVT_GTF_C                 40
diff -urN linux-2.6.34-rc3/drivers/video/fbmon.c linux-2.6.34-rc4/drivers/video/fbmon.c
--- linux-2.6.34-rc3/drivers/video/fbmon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/fbmon.c	2010-04-13 02:19:01.732633154 +0000
@@ -29,6 +29,7 @@
 #include <linux/fb.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <video/edid.h>
 #ifdef CONFIG_PPC_OF
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/drivers/video/fbsysfs.c linux-2.6.34-rc4/drivers/video/fbsysfs.c
--- linux-2.6.34-rc3/drivers/video/fbsysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/fbsysfs.c	2010-04-13 02:19:01.732633154 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/console.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/video/ffb.c linux-2.6.34-rc4/drivers/video/ffb.c
--- linux-2.6.34-rc3/drivers/video/ffb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/ffb.c	2010-04-13 02:19:01.732633154 +0000
@@ -10,7 +10,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/fsl-diu-fb.c linux-2.6.34-rc4/drivers/video/fsl-diu-fb.c
--- linux-2.6.34-rc3/drivers/video/fsl-diu-fb.c	2010-04-13 02:18:56.390570443 +0000
+++ linux-2.6.34-rc4/drivers/video/fsl-diu-fb.c	2010-04-13 02:19:01.733633045 +0000
@@ -1536,6 +1536,7 @@
 		goto error;
 	}
 
+	sysfs_attr_init(&machine_data->dev_attr.attr);
 	machine_data->dev_attr.attr.name = "monitor";
 	machine_data->dev_attr.attr.mode = S_IRUGO|S_IWUSR;
 	machine_data->dev_attr.show = show_monitor;
diff -urN linux-2.6.34-rc3/drivers/video/g364fb.c linux-2.6.34-rc4/drivers/video/g364fb.c
--- linux-2.6.34-rc3/drivers/video/g364fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/g364fb.c	2010-04-13 02:19:01.733633045 +0000
@@ -20,7 +20,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/gbefb.c linux-2.6.34-rc4/drivers/video/gbefb.c
--- linux-2.6.34-rc3/drivers/video/gbefb.c	2010-04-13 02:18:56.390570443 +0000
+++ linux-2.6.34-rc4/drivers/video/gbefb.c	2010-04-13 02:19:01.733633045 +0000
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/fb.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/geode/gx1fb_core.c linux-2.6.34-rc4/drivers/video/geode/gx1fb_core.c
--- linux-2.6.34-rc3/drivers/video/geode/gx1fb_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/geode/gx1fb_core.c	2010-04-13 02:19:01.733633045 +0000
@@ -15,7 +15,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/video/geode/gxfb_core.c linux-2.6.34-rc4/drivers/video/geode/gxfb_core.c
--- linux-2.6.34-rc3/drivers/video/geode/gxfb_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/geode/gxfb_core.c	2010-04-13 02:19:01.733633045 +0000
@@ -25,7 +25,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/console.h>
diff -urN linux-2.6.34-rc3/drivers/video/geode/lxfb_core.c linux-2.6.34-rc4/drivers/video/geode/lxfb_core.c
--- linux-2.6.34-rc3/drivers/video/geode/lxfb_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/geode/lxfb_core.c	2010-04-13 02:19:01.734633098 +0000
@@ -16,7 +16,6 @@
 #include <linux/string.h>
 #include <linux/console.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/suspend.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/hecubafb.c linux-2.6.34-rc4/drivers/video/hecubafb.c
--- linux-2.6.34-rc3/drivers/video/hecubafb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/hecubafb.c	2010-04-13 02:19:01.734633098 +0000
@@ -32,7 +32,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/hgafb.c linux-2.6.34-rc4/drivers/video/hgafb.c
--- linux-2.6.34-rc3/drivers/video/hgafb.c	2010-04-13 02:18:56.390570443 +0000
+++ linux-2.6.34-rc4/drivers/video/hgafb.c	2010-04-13 02:19:01.734633098 +0000
@@ -36,7 +36,6 @@
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/video/hitfb.c linux-2.6.34-rc4/drivers/video/hitfb.c
--- linux-2.6.34-rc3/drivers/video/hitfb.c	2010-04-13 02:18:56.390570443 +0000
+++ linux-2.6.34-rc4/drivers/video/hitfb.c	2010-04-13 02:19:01.734633098 +0000
@@ -16,7 +16,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/hpfb.c linux-2.6.34-rc4/drivers/video/hpfb.c
--- linux-2.6.34-rc3/drivers/video/hpfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/hpfb.c	2010-04-13 02:19:01.734633098 +0000
@@ -10,7 +10,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/i810/i810-i2c.c linux-2.6.34-rc4/drivers/video/i810/i810-i2c.c
--- linux-2.6.34-rc3/drivers/video/i810/i810-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/i810/i810-i2c.c	2010-04-13 02:19:01.734633098 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/fb.h>
 #include "i810.h"
diff -urN linux-2.6.34-rc3/drivers/video/imsttfb.c linux-2.6.34-rc4/drivers/video/imsttfb.c
--- linux-2.6.34-rc3/drivers/video/imsttfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/imsttfb.c	2010-04-13 02:19:01.735633085 +0000
@@ -21,7 +21,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/intelfb/intelfbhw.c linux-2.6.34-rc4/drivers/video/intelfb/intelfbhw.c
--- linux-2.6.34-rc3/drivers/video/intelfb/intelfbhw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/intelfb/intelfbhw.c	2010-04-13 02:19:01.735633085 +0000
@@ -24,7 +24,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/video/leo.c linux-2.6.34-rc4/drivers/video/leo.c
--- linux-2.6.34-rc3/drivers/video/leo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/leo.c	2010-04-13 02:19:01.735633085 +0000
@@ -11,7 +11,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/matrox/i2c-matroxfb.c linux-2.6.34-rc4/drivers/video/matrox/i2c-matroxfb.c
--- linux-2.6.34-rc3/drivers/video/matrox/i2c-matroxfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/matrox/i2c-matroxfb.c	2010-04-13 02:19:01.736633060 +0000
@@ -13,6 +13,7 @@
 #include "matroxfb_base.h"
 #include "matroxfb_maven.h"
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/i2c-algo-bit.h>
 
 /* MGA-TVO I2C for G200, G400 */
diff -urN linux-2.6.34-rc3/drivers/video/matrox/matroxfb_base.c linux-2.6.34-rc4/drivers/video/matrox/matroxfb_base.c
--- linux-2.6.34-rc3/drivers/video/matrox/matroxfb_base.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/matrox/matroxfb_base.c	2010-04-13 02:19:01.736633060 +0000
@@ -113,6 +113,7 @@
 #include "matroxfb_g450.h"
 #include <linux/matroxfb.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #ifdef CONFIG_PPC_PMAC
diff -urN linux-2.6.34-rc3/drivers/video/matrox/matroxfb_crtc2.c linux-2.6.34-rc4/drivers/video/matrox/matroxfb_crtc2.c
--- linux-2.6.34-rc3/drivers/video/matrox/matroxfb_crtc2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/matrox/matroxfb_crtc2.c	2010-04-13 02:19:01.737633104 +0000
@@ -15,6 +15,7 @@
 #include "matroxfb_misc.h"
 #include "matroxfb_DAC1064.h"
 #include <linux/matroxfb.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 /* **************************************************** */
diff -urN linux-2.6.34-rc3/drivers/video/matrox/matroxfb_maven.c linux-2.6.34-rc4/drivers/video/matrox/matroxfb_maven.c
--- linux-2.6.34-rc3/drivers/video/matrox/matroxfb_maven.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/matrox/matroxfb_maven.c	2010-04-13 02:19:01.737633104 +0000
@@ -17,6 +17,7 @@
 #include "matroxfb_DAC1064.h"
 #include <linux/i2c.h>
 #include <linux/matroxfb.h>
+#include <linux/slab.h>
 #include <asm/div64.h>
 
 #define MGATVO_B	1
diff -urN linux-2.6.34-rc3/drivers/video/maxinefb.c linux-2.6.34-rc4/drivers/video/maxinefb.c
--- linux-2.6.34-rc3/drivers/video/maxinefb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/maxinefb.c	2010-04-13 02:19:01.737633104 +0000
@@ -28,7 +28,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/mb862xx/mb862xxfb_accel.c linux-2.6.34-rc4/drivers/video/mb862xx/mb862xxfb_accel.c
--- linux-2.6.34-rc3/drivers/video/mb862xx/mb862xxfb_accel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/mb862xx/mb862xxfb_accel.c	2010-04-13 02:19:01.737633104 +0000
@@ -4,7 +4,7 @@
  * Fujitsu Carmine/Coral-P(A)/Lime framebuffer driver acceleration support
  *
  * (C) 2007 Alexander Shishkin <virtuoso@slind.org>
- * (C) 2009 Valentin Sitdikov <valentin.sitdikov@siemens.com>
+ * (C) 2009 Valentin Sitdikov <v.sitdikov@gmail.com>
  * (C) 2009 Siemens AG
  *
  * This program is free software; you can redistribute it and/or modify
@@ -16,7 +16,9 @@
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
+#include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #if defined(CONFIG_OF)
 #include <linux/of_platform.h>
 #endif
@@ -329,3 +331,5 @@
 	info->fix.accel = 0xff;	/*FIXME: add right define */
 }
 EXPORT_SYMBOL(mb862xxfb_init_accel);
+
+MODULE_LICENSE("GPL v2");
diff -urN linux-2.6.34-rc3/drivers/video/mbx/mbxdebugfs.c linux-2.6.34-rc4/drivers/video/mbx/mbxdebugfs.c
--- linux-2.6.34-rc3/drivers/video/mbx/mbxdebugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/mbx/mbxdebugfs.c	2010-04-13 02:19:01.737633104 +0000
@@ -1,4 +1,5 @@
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #define BIG_BUFFER_SIZE	(1024)
 
diff -urN linux-2.6.34-rc3/drivers/video/metronomefb.c linux-2.6.34-rc4/drivers/video/metronomefb.c
--- linux-2.6.34-rc3/drivers/video/metronomefb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/metronomefb.c	2010-04-13 02:19:01.738633082 +0000
@@ -23,7 +23,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/modedb.c linux-2.6.34-rc4/drivers/video/modedb.c
--- linux-2.6.34-rc3/drivers/video/modedb.c	2010-04-13 02:18:56.392633044 +0000
+++ linux-2.6.34-rc4/drivers/video/modedb.c	2010-04-13 02:19:01.738633082 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/kernel.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/msm/mddi.c linux-2.6.34-rc4/drivers/video/msm/mddi.c
--- linux-2.6.34-rc3/drivers/video/msm/mddi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/mddi.c	2010-04-13 02:19:01.738633082 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/spinlock.h>
 #include <linux/clk.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/video/msm/mddi_client_dummy.c linux-2.6.34-rc4/drivers/video/msm/mddi_client_dummy.c
--- linux-2.6.34-rc3/drivers/video/msm/mddi_client_dummy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/mddi_client_dummy.c	2010-04-13 02:19:01.738633082 +0000
@@ -15,6 +15,7 @@
  * GNU General Public License for more details.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/msm/mddi_client_nt35399.c linux-2.6.34-rc4/drivers/video/msm/mddi_client_nt35399.c
--- linux-2.6.34-rc3/drivers/video/msm/mddi_client_nt35399.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/mddi_client_nt35399.c	2010-04-13 02:19:01.738633082 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/sched.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 #include <mach/msm_fb.h>
 
 static DECLARE_WAIT_QUEUE_HEAD(nt35399_vsync_wait);
diff -urN linux-2.6.34-rc3/drivers/video/msm/mddi_client_toshiba.c linux-2.6.34-rc4/drivers/video/msm/mddi_client_toshiba.c
--- linux-2.6.34-rc3/drivers/video/msm/mddi_client_toshiba.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/mddi_client_toshiba.c	2010-04-13 02:19:01.738633082 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/gpio.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <mach/msm_fb.h>
 
 
diff -urN linux-2.6.34-rc3/drivers/video/msm/mdp.c linux-2.6.34-rc4/drivers/video/msm/mdp.c
--- linux-2.6.34-rc3/drivers/video/msm/mdp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/mdp.c	2010-04-13 02:19:01.738633082 +0000
@@ -23,6 +23,7 @@
 #include <linux/clk.h>
 #include <linux/file.h>
 #include <linux/major.h>
+#include <linux/slab.h>
 
 #include <mach/msm_iomap.h>
 #include <mach/msm_fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/msm/msm_fb.c linux-2.6.34-rc4/drivers/video/msm/msm_fb.c
--- linux-2.6.34-rc3/drivers/video/msm/msm_fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/msm/msm_fb.c	2010-04-13 02:19:01.738633082 +0000
@@ -17,6 +17,7 @@
 #include <linux/platform_device.h>
 #include <linux/module.h>
 #include <linux/fb.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include <linux/freezer.h>
diff -urN linux-2.6.34-rc3/drivers/video/nvidia/nv_i2c.c linux-2.6.34-rc4/drivers/video/nvidia/nv_i2c.c
--- linux-2.6.34-rc3/drivers/video/nvidia/nv_i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/nvidia/nv_i2c.c	2010-04-13 02:19:01.739633066 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/fb.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/nvidia/nv_of.c linux-2.6.34-rc4/drivers/video/nvidia/nv_of.c
--- linux-2.6.34-rc3/drivers/video/nvidia/nv_of.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/nvidia/nv_of.c	2010-04-13 02:19:01.739633066 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/fb.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/nvidia/nv_setup.c linux-2.6.34-rc4/drivers/video/nvidia/nv_setup.c
--- linux-2.6.34-rc3/drivers/video/nvidia/nv_setup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/nvidia/nv_setup.c	2010-04-13 02:19:01.739633066 +0000
@@ -50,6 +50,7 @@
 #include <video/vga.h>
 #include <linux/delay.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include "nv_type.h"
 #include "nv_local.h"
 #include "nv_proto.h"
diff -urN linux-2.6.34-rc3/drivers/video/offb.c linux-2.6.34-rc4/drivers/video/offb.c
--- linux-2.6.34-rc3/drivers/video/offb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/offb.c	2010-04-13 02:19:01.739633066 +0000
@@ -17,7 +17,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap/dispc.c linux-2.6.34-rc4/drivers/video/omap/dispc.c
--- linux-2.6.34-rc3/drivers/video/omap/dispc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/omap/dispc.c	2010-04-13 02:19:01.740633047 +0000
@@ -25,6 +25,7 @@
 #include <linux/clk.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <plat/sram.h>
 #include <plat/board.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap/lcd_mipid.c linux-2.6.34-rc4/drivers/video/omap/lcd_mipid.c
--- linux-2.6.34-rc3/drivers/video/omap/lcd_mipid.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/omap/lcd_mipid.c	2010-04-13 02:19:01.740633047 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/spi/spi.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/omap/lcdc.c linux-2.6.34-rc4/drivers/video/omap/lcdc.c
--- linux-2.6.34-rc3/drivers/video/omap/lcdc.c	2010-04-13 02:18:56.393633111 +0000
+++ linux-2.6.34-rc4/drivers/video/omap/lcdc.c	2010-04-13 02:19:01.740633047 +0000
@@ -28,6 +28,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/vmalloc.h>
 #include <linux/clk.h>
+#include <linux/gfp.h>
 
 #include <mach/lcdc.h>
 #include <plat/dma.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap/omapfb_main.c linux-2.6.34-rc4/drivers/video/omap/omapfb_main.c
--- linux-2.6.34-rc3/drivers/video/omap/omapfb_main.c	2010-04-13 02:18:56.393633111 +0000
+++ linux-2.6.34-rc4/drivers/video/omap/omapfb_main.c	2010-04-13 02:19:01.740633047 +0000
@@ -26,6 +26,7 @@
  */
 #include <linux/platform_device.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #include <plat/dma.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap2/displays/panel-taal.c linux-2.6.34-rc4/drivers/video/omap2/displays/panel-taal.c
--- linux-2.6.34-rc3/drivers/video/omap2/displays/panel-taal.c	2010-04-13 02:18:56.394633070 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/displays/panel-taal.c	2010-04-13 02:19:01.741633052 +0000
@@ -30,6 +30,7 @@
 #include <linux/gpio.h>
 #include <linux/completion.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 #include <plat/display.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/omap2/displays/panel-tpo-td043mtea1.c linux-2.6.34-rc4/drivers/video/omap2/displays/panel-tpo-td043mtea1.c
--- linux-2.6.34-rc3/drivers/video/omap2/displays/panel-tpo-td043mtea1.c	2010-04-13 02:18:56.394633070 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/displays/panel-tpo-td043mtea1.c	2010-04-13 02:19:01.742632991 +0000
@@ -15,6 +15,7 @@
 #include <linux/regulator/consumer.h>
 #include <linux/gpio.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 
 #include <plat/display.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/omap2/dss/manager.c linux-2.6.34-rc4/drivers/video/omap2/dss/manager.c
--- linux-2.6.34-rc3/drivers/video/omap2/dss/manager.c	2010-04-13 02:18:56.397633068 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/dss/manager.c	2010-04-13 02:19:01.745633081 +0000
@@ -23,6 +23,7 @@
 #define DSS_SUBSYS_NAME "MANAGER"
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap2/dss/overlay.c linux-2.6.34-rc4/drivers/video/omap2/dss/overlay.c
--- linux-2.6.34-rc3/drivers/video/omap2/dss/overlay.c	2010-04-13 02:18:56.397633068 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/dss/overlay.c	2010-04-13 02:19:01.745633081 +0000
@@ -29,6 +29,7 @@
 #include <linux/kobject.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <plat/display.h>
 #include <plat/cpu.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap2/omapfb/omapfb-main.c linux-2.6.34-rc4/drivers/video/omap2/omapfb/omapfb-main.c
--- linux-2.6.34-rc3/drivers/video/omap2/omapfb/omapfb-main.c	2010-04-13 02:18:56.399571484 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/omapfb/omapfb-main.c	2010-04-13 02:19:01.747633103 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/dma-mapping.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/drivers/video/omap2/vram.c linux-2.6.34-rc4/drivers/video/omap2/vram.c
--- linux-2.6.34-rc3/drivers/video/omap2/vram.c	2010-04-13 02:18:56.399571484 +0000
+++ linux-2.6.34-rc4/drivers/video/omap2/vram.c	2010-04-13 02:19:01.747633103 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/bootmem.h>
 #include <linux/completion.h>
diff -urN linux-2.6.34-rc3/drivers/video/output.c linux-2.6.34-rc4/drivers/video/output.c
--- linux-2.6.34-rc3/drivers/video/output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/output.c	2010-04-13 02:19:01.747633103 +0000
@@ -23,6 +23,7 @@
  */
 #include <linux/module.h>
 #include <linux/video_output.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/ctype.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/p9100.c linux-2.6.34-rc4/drivers/video/p9100.c
--- linux-2.6.34-rc3/drivers/video/p9100.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/p9100.c	2010-04-13 02:19:01.747633103 +0000
@@ -10,7 +10,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/platinumfb.c linux-2.6.34-rc4/drivers/video/platinumfb.c
--- linux-2.6.34-rc3/drivers/video/platinumfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/platinumfb.c	2010-04-13 02:19:01.747633103 +0000
@@ -24,7 +24,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/pmag-aa-fb.c linux-2.6.34-rc4/drivers/video/pmag-aa-fb.c
--- linux-2.6.34-rc3/drivers/video/pmag-aa-fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/pmag-aa-fb.c	2010-04-13 02:19:01.748633135 +0000
@@ -28,7 +28,6 @@
 #include <linux/string.h>
 #include <linux/timer.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/pnx4008/pnxrgbfb.c linux-2.6.34-rc4/drivers/video/pnx4008/pnxrgbfb.c
--- linux-2.6.34-rc3/drivers/video/pnx4008/pnxrgbfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/pnx4008/pnxrgbfb.c	2010-04-13 02:19:01.748633135 +0000
@@ -18,7 +18,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/pnx4008/sdum.c linux-2.6.34-rc4/drivers/video/pnx4008/sdum.c
--- linux-2.6.34-rc3/drivers/video/pnx4008/sdum.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/pnx4008/sdum.c	2010-04-13 02:19:01.748633135 +0000
@@ -20,7 +20,6 @@
 #include <linux/string.h>
 #include <linux/mm.h>
 #include <linux/tty.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
@@ -29,6 +28,7 @@
 #include <linux/init.h>
 #include <linux/dma-mapping.h>
 #include <linux/clk.h>
+#include <linux/gfp.h>
 #include <asm/uaccess.h>
 #include <mach/gpio.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/q40fb.c linux-2.6.34-rc4/drivers/video/q40fb.c
--- linux-2.6.34-rc3/drivers/video/q40fb.c	2010-04-13 02:18:56.400570446 +0000
+++ linux-2.6.34-rc4/drivers/video/q40fb.c	2010-04-13 02:19:01.748633135 +0000
@@ -14,7 +14,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/s1d13xxxfb.c linux-2.6.34-rc4/drivers/video/s1d13xxxfb.c
--- linux-2.6.34-rc3/drivers/video/s1d13xxxfb.c	2010-04-13 02:18:56.400570446 +0000
+++ linux-2.6.34-rc4/drivers/video/s1d13xxxfb.c	2010-04-13 02:19:01.749633008 +0000
@@ -31,6 +31,7 @@
 #include <linux/fb.h>
 #include <linux/spinlock_types.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/s3c-fb.c linux-2.6.34-rc4/drivers/video/s3c-fb.c
--- linux-2.6.34-rc3/drivers/video/s3c-fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/s3c-fb.c	2010-04-13 02:19:01.749633008 +0000
@@ -16,8 +16,8 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <linux/init.h>
-#include <linux/gfp.h>
 #include <linux/clk.h>
 #include <linux/fb.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/video/s3fb.c linux-2.6.34-rc4/drivers/video/s3fb.c
--- linux-2.6.34-rc3/drivers/video/s3fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/s3fb.c	2010-04-13 02:19:01.750633052 +0000
@@ -17,7 +17,6 @@
 #include <linux/string.h>
 #include <linux/mm.h>
 #include <linux/tty.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/svga.h>
diff -urN linux-2.6.34-rc3/drivers/video/savage/savagefb-i2c.c linux-2.6.34-rc4/drivers/video/savage/savagefb-i2c.c
--- linux-2.6.34-rc3/drivers/video/savage/savagefb-i2c.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/savage/savagefb-i2c.c	2010-04-13 02:19:01.750633052 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/pci.h>
 #include <linux/fb.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/sh7760fb.c linux-2.6.34-rc4/drivers/video/sh7760fb.c
--- linux-2.6.34-rc3/drivers/video/sh7760fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/sh7760fb.c	2010-04-13 02:19:01.750633052 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <asm/sh7760fb.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/sh_mobile_lcdcfb.c linux-2.6.34-rc4/drivers/video/sh_mobile_lcdcfb.c
--- linux-2.6.34-rc3/drivers/video/sh_mobile_lcdcfb.c	2010-04-13 02:18:56.401570363 +0000
+++ linux-2.6.34-rc4/drivers/video/sh_mobile_lcdcfb.c	2010-04-13 02:19:01.750633052 +0000
@@ -20,6 +20,7 @@
 #include <linux/interrupt.h>
 #include <linux/vmalloc.h>
 #include <linux/ioctl.h>
+#include <linux/slab.h>
 #include <video/sh_mobile_lcdc.h>
 #include <asm/atomic.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/sstfb.c linux-2.6.34-rc4/drivers/video/sstfb.c
--- linux-2.6.34-rc3/drivers/video/sstfb.c	2010-04-13 02:18:56.403633042 +0000
+++ linux-2.6.34-rc4/drivers/video/sstfb.c	2010-04-13 02:19:01.752633155 +0000
@@ -86,7 +86,6 @@
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <asm/io.h>
 #include <linux/uaccess.h>
 #include <video/sstfb.h>
diff -urN linux-2.6.34-rc3/drivers/video/sunxvr1000.c linux-2.6.34-rc4/drivers/video/sunxvr1000.c
--- linux-2.6.34-rc3/drivers/video/sunxvr1000.c	2010-04-13 02:18:56.403633042 +0000
+++ linux-2.6.34-rc4/drivers/video/sunxvr1000.c	2010-04-13 02:19:01.752633155 +0000
@@ -5,7 +5,6 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/init.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/drivers/video/sunxvr2500.c linux-2.6.34-rc4/drivers/video/sunxvr2500.c
--- linux-2.6.34-rc3/drivers/video/sunxvr2500.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/sunxvr2500.c	2010-04-13 02:19:01.752633155 +0000
@@ -5,7 +5,6 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/pci.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/drivers/video/sunxvr500.c linux-2.6.34-rc4/drivers/video/sunxvr500.c
--- linux-2.6.34-rc3/drivers/video/sunxvr500.c	2010-04-13 02:18:56.403633042 +0000
+++ linux-2.6.34-rc4/drivers/video/sunxvr500.c	2010-04-13 02:19:01.752633155 +0000
@@ -5,7 +5,6 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/fb.h>
 #include <linux/pci.h>
 #include <linux/init.h>
@@ -242,11 +241,27 @@
 static int __devinit e3d_pci_register(struct pci_dev *pdev,
 				      const struct pci_device_id *ent)
 {
+	struct device_node *of_node;
+	const char *device_type;
 	struct fb_info *info;
 	struct e3d_info *ep;
 	unsigned int line_length;
 	int err;
 
+	of_node = pci_device_to_OF_node(pdev);
+	if (!of_node) {
+		printk(KERN_ERR "e3d: Cannot find OF node of %s\n",
+		       pci_name(pdev));
+		return -ENODEV;
+	}
+
+	device_type = of_get_property(of_node, "device_type", NULL);
+	if (!device_type) {
+		printk(KERN_INFO "e3d: Ignoring secondary output device "
+		       "at %s\n", pci_name(pdev));
+		return -ENODEV;
+	}
+
 	err = pci_enable_device(pdev);
 	if (err < 0) {
 		printk(KERN_ERR "e3d: Cannot enable PCI device %s\n",
@@ -265,13 +280,7 @@
 	ep->info = info;
 	ep->pdev = pdev;
 	spin_lock_init(&ep->lock);
-	ep->of_node = pci_device_to_OF_node(pdev);
-	if (!ep->of_node) {
-		printk(KERN_ERR "e3d: Cannot find OF node of %s\n",
-		       pci_name(pdev));
-		err = -ENODEV;
-		goto err_release_fb;
-	}
+	ep->of_node = of_node;
 
 	/* Read the PCI base register of the frame buffer, which we
 	 * need in order to interpret the RAMDAC_VID_*FB* values in
diff -urN linux-2.6.34-rc3/drivers/video/svgalib.c linux-2.6.34-rc4/drivers/video/svgalib.c
--- linux-2.6.34-rc3/drivers/video/svgalib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/svgalib.c	2010-04-13 02:19:01.752633155 +0000
@@ -15,7 +15,6 @@
 #include <linux/string.h>
 #include <linux/fb.h>
 #include <linux/svga.h>
-#include <linux/slab.h>
 #include <asm/types.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/syscopyarea.c linux-2.6.34-rc4/drivers/video/syscopyarea.c
--- linux-2.6.34-rc3/drivers/video/syscopyarea.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/syscopyarea.c	2010-04-13 02:19:01.753633046 +0000
@@ -16,7 +16,6 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/fb.h>
-#include <linux/slab.h>
 #include <asm/types.h>
 #include <asm/io.h>
 #include "fb_draw.h"
diff -urN linux-2.6.34-rc3/drivers/video/tcx.c linux-2.6.34-rc4/drivers/video/tcx.c
--- linux-2.6.34-rc3/drivers/video/tcx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/tcx.c	2010-04-13 02:19:01.753633046 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/fb.h>
diff -urN linux-2.6.34-rc3/drivers/video/tgafb.c linux-2.6.34-rc4/drivers/video/tgafb.c
--- linux-2.6.34-rc3/drivers/video/tgafb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/tgafb.c	2010-04-13 02:19:01.753633046 +0000
@@ -25,7 +25,6 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/selection.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/tc.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/tridentfb.c linux-2.6.34-rc4/drivers/video/tridentfb.c
--- linux-2.6.34-rc3/drivers/video/tridentfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/tridentfb.c	2010-04-13 02:19:01.753633046 +0000
@@ -19,6 +19,7 @@
 #include <linux/fb.h>
 #include <linux/init.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include <linux/delay.h>
 #include <video/vga.h>
diff -urN linux-2.6.34-rc3/drivers/video/uvesafb.c linux-2.6.34-rc4/drivers/video/uvesafb.c
--- linux-2.6.34-rc3/drivers/video/uvesafb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/uvesafb.c	2010-04-13 02:19:01.754633090 +0000
@@ -18,6 +18,7 @@
 #include <linux/fb.h>
 #include <linux/io.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <video/edid.h>
 #include <video/uvesafb.h>
 #ifdef CONFIG_X86
diff -urN linux-2.6.34-rc3/drivers/video/vermilion/vermilion.c linux-2.6.34-rc4/drivers/video/vermilion/vermilion.c
--- linux-2.6.34-rc3/drivers/video/vermilion/vermilion.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/vermilion/vermilion.c	2010-04-13 02:19:01.754633090 +0000
@@ -33,6 +33,7 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/fb.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/drivers/video/vesafb.c linux-2.6.34-rc4/drivers/video/vesafb.c
--- linux-2.6.34-rc3/drivers/video/vesafb.c	2010-04-13 02:18:56.403633042 +0000
+++ linux-2.6.34-rc4/drivers/video/vesafb.c	2010-04-13 02:19:01.754633090 +0000
@@ -13,7 +13,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/ioport.h>
@@ -226,7 +225,7 @@
 	return 0;
 }
 
-static int __devinit vesafb_probe(struct platform_device *dev)
+static int __init vesafb_probe(struct platform_device *dev)
 {
 	struct fb_info *info;
 	int i, err;
@@ -477,7 +476,6 @@
 }
 
 static struct platform_driver vesafb_driver = {
-	.probe	= vesafb_probe,
 	.driver	= {
 		.name	= "vesafb",
 	},
@@ -493,20 +491,21 @@
 	/* ignore error return of fb_get_options */
 	fb_get_options("vesafb", &option);
 	vesafb_setup(option);
-	ret = platform_driver_register(&vesafb_driver);
 
+	vesafb_device = platform_device_alloc("vesafb", 0);
+	if (!vesafb_device)
+		return -ENOMEM;
+
+	ret = platform_device_add(vesafb_device);
 	if (!ret) {
-		vesafb_device = platform_device_alloc("vesafb", 0);
+		ret = platform_driver_probe(&vesafb_driver, vesafb_probe);
+		if (ret)
+			platform_device_del(vesafb_device);
+	}
 
-		if (vesafb_device)
-			ret = platform_device_add(vesafb_device);
-		else
-			ret = -ENOMEM;
-
-		if (ret) {
-			platform_device_put(vesafb_device);
-			platform_driver_unregister(&vesafb_driver);
-		}
+	if (ret) {
+		platform_device_put(vesafb_device);
+		vesafb_device = NULL;
 	}
 
 	return ret;
diff -urN linux-2.6.34-rc3/drivers/video/vfb.c linux-2.6.34-rc4/drivers/video/vfb.c
--- linux-2.6.34-rc3/drivers/video/vfb.c	2010-04-13 02:18:56.403633042 +0000
+++ linux-2.6.34-rc4/drivers/video/vfb.c	2010-04-13 02:19:01.754633090 +0000
@@ -15,7 +15,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/drivers/video/vga16fb.c linux-2.6.34-rc4/drivers/video/vga16fb.c
--- linux-2.6.34-rc3/drivers/video/vga16fb.c	2010-04-13 02:18:56.404633024 +0000
+++ linux-2.6.34-rc4/drivers/video/vga16fb.c	2010-04-13 02:19:01.755574278 +0000
@@ -15,7 +15,6 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/ioport.h>
diff -urN linux-2.6.34-rc3/drivers/video/via/viafbdev.c linux-2.6.34-rc4/drivers/video/via/viafbdev.c
--- linux-2.6.34-rc3/drivers/video/via/viafbdev.c	2010-04-13 02:18:56.408633017 +0000
+++ linux-2.6.34-rc4/drivers/video/via/viafbdev.c	2010-04-13 02:19:01.759633121 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/module.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 #define _MASTER_FILE
 
diff -urN linux-2.6.34-rc3/drivers/video/vt8623fb.c linux-2.6.34-rc4/drivers/video/vt8623fb.c
--- linux-2.6.34-rc3/drivers/video/vt8623fb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/vt8623fb.c	2010-04-13 02:19:01.760633054 +0000
@@ -18,7 +18,6 @@
 #include <linux/string.h>
 #include <linux/mm.h>
 #include <linux/tty.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/fb.h>
 #include <linux/svga.h>
diff -urN linux-2.6.34-rc3/drivers/video/w100fb.c linux-2.6.34-rc4/drivers/video/w100fb.c
--- linux-2.6.34-rc3/drivers/video/w100fb.c	2010-04-13 02:18:56.409571378 +0000
+++ linux-2.6.34-rc4/drivers/video/w100fb.c	2010-04-13 02:19:01.760633054 +0000
@@ -30,6 +30,7 @@
 #include <linux/kernel.h>
 #include <linux/mm.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/vmalloc.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/drivers/video/xen-fbfront.c linux-2.6.34-rc4/drivers/video/xen-fbfront.c
--- linux-2.6.34-rc3/drivers/video/xen-fbfront.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/xen-fbfront.c	2010-04-13 02:19:01.760633054 +0000
@@ -23,6 +23,7 @@
 #include <linux/errno.h>
 #include <linux/fb.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/mm.h>
 
diff -urN linux-2.6.34-rc3/drivers/video/xilinxfb.c linux-2.6.34-rc4/drivers/video/xilinxfb.c
--- linux-2.6.34-rc3/drivers/video/xilinxfb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/video/xilinxfb.c	2010-04-13 02:19:01.761633752 +0000
@@ -34,6 +34,7 @@
 #include <linux/of_platform.h>
 #include <linux/io.h>
 #include <linux/xilinxfb.h>
+#include <linux/slab.h>
 #include <asm/dcr.h>
 
 #define DRIVER_NAME		"xilinxfb"
diff -urN linux-2.6.34-rc3/drivers/virtio/virtio_balloon.c linux-2.6.34-rc4/drivers/virtio/virtio_balloon.c
--- linux-2.6.34-rc3/drivers/virtio/virtio_balloon.c	2010-04-13 02:18:56.409571378 +0000
+++ linux-2.6.34-rc4/drivers/virtio/virtio_balloon.c	2010-04-13 02:19:01.761633752 +0000
@@ -24,6 +24,7 @@
 #include <linux/kthread.h>
 #include <linux/freezer.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 struct virtio_balloon
 {
diff -urN linux-2.6.34-rc3/drivers/virtio/virtio_pci.c linux-2.6.34-rc4/drivers/virtio/virtio_pci.c
--- linux-2.6.34-rc3/drivers/virtio/virtio_pci.c	2010-04-13 02:18:56.409571378 +0000
+++ linux-2.6.34-rc4/drivers/virtio/virtio_pci.c	2010-04-13 02:19:01.761633752 +0000
@@ -17,6 +17,7 @@
 #include <linux/module.h>
 #include <linux/list.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/virtio.h>
 #include <linux/virtio_config.h>
diff -urN linux-2.6.34-rc3/drivers/virtio/virtio_ring.c linux-2.6.34-rc4/drivers/virtio/virtio_ring.c
--- linux-2.6.34-rc3/drivers/virtio/virtio_ring.c	2010-04-13 02:18:56.410633166 +0000
+++ linux-2.6.34-rc4/drivers/virtio/virtio_ring.c	2010-04-13 02:19:01.761633752 +0000
@@ -20,6 +20,7 @@
 #include <linux/virtio_ring.h>
 #include <linux/virtio_config.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 /* virtio guest is communicating with a virtual "device" that actually runs on
  * a host processor.  Memory barriers are used to control SMP effects. */
diff -urN linux-2.6.34-rc3/drivers/vlynq/vlynq.c linux-2.6.34-rc4/drivers/vlynq/vlynq.c
--- linux-2.6.34-rc3/drivers/vlynq/vlynq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/vlynq/vlynq.c	2010-04-13 02:19:01.761633752 +0000
@@ -30,6 +30,7 @@
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <linux/vlynq.h>
 
diff -urN linux-2.6.34-rc3/drivers/w1/masters/ds1wm.c linux-2.6.34-rc4/drivers/w1/masters/ds1wm.c
--- linux-2.6.34-rc3/drivers/w1/masters/ds1wm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/masters/ds1wm.c	2010-04-13 02:19:01.761633752 +0000
@@ -20,6 +20,7 @@
 #include <linux/delay.h>
 #include <linux/mfd/core.h>
 #include <linux/mfd/ds1wm.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/w1/masters/ds2490.c linux-2.6.34-rc4/drivers/w1/masters/ds2490.c
--- linux-2.6.34-rc3/drivers/w1/masters/ds2490.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/masters/ds2490.c	2010-04-13 02:19:01.762633154 +0000
@@ -23,6 +23,7 @@
 #include <linux/kernel.h>
 #include <linux/mod_devicetable.h>
 #include <linux/usb.h>
+#include <linux/slab.h>
 
 #include "../w1_int.h"
 #include "../w1.h"
diff -urN linux-2.6.34-rc3/drivers/w1/masters/mxc_w1.c linux-2.6.34-rc4/drivers/w1/masters/mxc_w1.c
--- linux-2.6.34-rc3/drivers/w1/masters/mxc_w1.c	2010-04-13 02:18:56.410633166 +0000
+++ linux-2.6.34-rc4/drivers/w1/masters/mxc_w1.c	2010-04-13 02:19:01.762633154 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 
diff -urN linux-2.6.34-rc3/drivers/w1/masters/omap_hdq.c linux-2.6.34-rc4/drivers/w1/masters/omap_hdq.c
--- linux-2.6.34-rc3/drivers/w1/masters/omap_hdq.c	2010-04-13 02:18:56.410633166 +0000
+++ linux-2.6.34-rc4/drivers/w1/masters/omap_hdq.c	2010-04-13 02:19:01.762633154 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/platform_device.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/clk.h>
 #include <linux/io.h>
diff -urN linux-2.6.34-rc3/drivers/w1/masters/w1-gpio.c linux-2.6.34-rc4/drivers/w1/masters/w1-gpio.c
--- linux-2.6.34-rc3/drivers/w1/masters/w1-gpio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/masters/w1-gpio.c	2010-04-13 02:19:01.762633154 +0000
@@ -11,6 +11,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/w1-gpio.h>
 
 #include "../w1.h"
diff -urN linux-2.6.34-rc3/drivers/w1/slaves/w1_ds2433.c linux-2.6.34-rc4/drivers/w1/slaves/w1_ds2433.c
--- linux-2.6.34-rc3/drivers/w1/slaves/w1_ds2433.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/slaves/w1_ds2433.c	2010-04-13 02:19:01.762633154 +0000
@@ -13,6 +13,7 @@
 #include <linux/device.h>
 #include <linux/types.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #ifdef CONFIG_W1_SLAVE_DS2433_CRC
 #include <linux/crc16.h>
 
diff -urN linux-2.6.34-rc3/drivers/w1/slaves/w1_ds2760.c linux-2.6.34-rc4/drivers/w1/slaves/w1_ds2760.c
--- linux-2.6.34-rc3/drivers/w1/slaves/w1_ds2760.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/slaves/w1_ds2760.c	2010-04-13 02:19:01.762633154 +0000
@@ -16,6 +16,7 @@
 #include <linux/platform_device.h>
 #include <linux/mutex.h>
 #include <linux/idr.h>
+#include <linux/gfp.h>
 
 #include "../w1.h"
 #include "../w1_int.h"
diff -urN linux-2.6.34-rc3/drivers/w1/w1_int.c linux-2.6.34-rc4/drivers/w1/w1_int.c
--- linux-2.6.34-rc3/drivers/w1/w1_int.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/w1_int.c	2010-04-13 02:19:01.763633120 +0000
@@ -23,6 +23,7 @@
 #include <linux/list.h>
 #include <linux/delay.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include "w1.h"
 #include "w1_log.h"
diff -urN linux-2.6.34-rc3/drivers/w1/w1_netlink.c linux-2.6.34-rc4/drivers/w1/w1_netlink.c
--- linux-2.6.34-rc3/drivers/w1/w1_netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/w1/w1_netlink.c	2010-04-13 02:19:01.763633120 +0000
@@ -19,6 +19,7 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
  */
 
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/netlink.h>
 #include <linux/connector.h>
diff -urN linux-2.6.34-rc3/drivers/watchdog/Kconfig linux-2.6.34-rc4/drivers/watchdog/Kconfig
--- linux-2.6.34-rc3/drivers/watchdog/Kconfig	2010-04-13 02:18:56.410633166 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/Kconfig	2010-04-13 02:19:01.763633120 +0000
@@ -55,11 +55,6 @@
 	  To compile this driver as a module, choose M here: the
 	  module will be called softdog.
 
-config MAX63XX_WATCHDOG
-       tristate "Max63xx watchdog"
-       help
-         Support for memory mapped max63{69,70,71,72,73,74} watchdog timer.
-
 config WM831X_WATCHDOG
 	tristate "WM831x watchdog"
 	depends on MFD_WM831X
@@ -305,6 +300,12 @@
 	  To compile this driver as a module, choose M here: the
 	  module will be called ts72xx_wdt.
 
+config MAX63XX_WATCHDOG
+	tristate "Max63xx watchdog"
+	depends on ARM
+	help
+	  Support for memory mapped max63{69,70,71,72,73,74} watchdog timer.
+
 # AVR32 Architecture
 
 config AT32AP700X_WDT
diff -urN linux-2.6.34-rc3/drivers/watchdog/adx_wdt.c linux-2.6.34-rc4/drivers/watchdog/adx_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/adx_wdt.c	2010-04-13 02:18:56.411633091 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/adx_wdt.c	2010-04-13 02:19:01.763633120 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/io.h>
 #include <linux/miscdevice.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/drivers/watchdog/at32ap700x_wdt.c linux-2.6.34-rc4/drivers/watchdog/at32ap700x_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/at32ap700x_wdt.c	2010-04-13 02:18:56.411633091 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/at32ap700x_wdt.c	2010-04-13 02:19:01.764633083 +0000
@@ -32,6 +32,7 @@
 #include <linux/uaccess.h>
 #include <linux/io.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #define TIMEOUT_MIN		1
 #define TIMEOUT_MAX		2
diff -urN linux-2.6.34-rc3/drivers/watchdog/cpwd.c linux-2.6.34-rc4/drivers/watchdog/cpwd.c
--- linux-2.6.34-rc3/drivers/watchdog/cpwd.c	2010-04-13 02:18:56.412633055 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/cpwd.c	2010-04-13 02:19:01.765633047 +0000
@@ -24,6 +24,7 @@
 #include <linux/interrupt.h>
 #include <linux/ioport.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/io.h>
 #include <linux/of.h>
diff -urN linux-2.6.34-rc3/drivers/watchdog/davinci_wdt.c linux-2.6.34-rc4/drivers/watchdog/davinci_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/davinci_wdt.c	2010-04-13 02:18:56.412633055 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/davinci_wdt.c	2010-04-13 02:19:01.765633047 +0000
@@ -26,6 +26,7 @@
 #include <linux/io.h>
 #include <linux/device.h>
 #include <linux/clk.h>
+#include <linux/slab.h>
 
 #define MODULE_NAME "DAVINCI-WDT: "
 
diff -urN linux-2.6.34-rc3/drivers/watchdog/hpwdt.c linux-2.6.34-rc4/drivers/watchdog/hpwdt.c
--- linux-2.6.34-rc3/drivers/watchdog/hpwdt.c	2010-04-13 02:18:56.413633265 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/hpwdt.c	2010-04-13 02:19:01.765633047 +0000
@@ -39,7 +39,6 @@
 #include <linux/efi.h>
 #include <linux/string.h>
 #include <linux/bootmem.h>
-#include <linux/slab.h>
 #include <asm/desc.h>
 #include <asm/cacheflush.h>
 
@@ -443,7 +442,7 @@
 static int hpwdt_change_timer(int new_margin)
 {
 	/* Arbitrary, can't find the card's limits */
-	if (new_margin < 30 || new_margin > 600) {
+	if (new_margin < 5 || new_margin > 600) {
 		printk(KERN_WARNING
 			"hpwdt: New value passed in is invalid: %d seconds.\n",
 			new_margin);
diff -urN linux-2.6.34-rc3/drivers/watchdog/iTCO_wdt.c linux-2.6.34-rc4/drivers/watchdog/iTCO_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/iTCO_wdt.c	2010-04-13 02:18:56.413633265 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/iTCO_wdt.c	2010-04-13 02:19:01.766633106 +0000
@@ -115,8 +115,37 @@
 	TCO_3420,	/* 3420 */
 	TCO_3450,	/* 3450 */
 	TCO_EP80579,	/* EP80579 */
-	TCO_CPTD,	/* CPT Desktop */
-	TCO_CPTM,	/* CPT Mobile */
+	TCO_CPT1,	/* Cougar Point */
+	TCO_CPT2,	/* Cougar Point Desktop */
+	TCO_CPT3,	/* Cougar Point Mobile */
+	TCO_CPT4,	/* Cougar Point */
+	TCO_CPT5,	/* Cougar Point */
+	TCO_CPT6,	/* Cougar Point */
+	TCO_CPT7,	/* Cougar Point */
+	TCO_CPT8,	/* Cougar Point */
+	TCO_CPT9,	/* Cougar Point */
+	TCO_CPT10,	/* Cougar Point */
+	TCO_CPT11,	/* Cougar Point */
+	TCO_CPT12,	/* Cougar Point */
+	TCO_CPT13,	/* Cougar Point */
+	TCO_CPT14,	/* Cougar Point */
+	TCO_CPT15,	/* Cougar Point */
+	TCO_CPT16,	/* Cougar Point */
+	TCO_CPT17,	/* Cougar Point */
+	TCO_CPT18,	/* Cougar Point */
+	TCO_CPT19,	/* Cougar Point */
+	TCO_CPT20,	/* Cougar Point */
+	TCO_CPT21,	/* Cougar Point */
+	TCO_CPT22,	/* Cougar Point */
+	TCO_CPT23,	/* Cougar Point */
+	TCO_CPT24,	/* Cougar Point */
+	TCO_CPT25,	/* Cougar Point */
+	TCO_CPT26,	/* Cougar Point */
+	TCO_CPT27,	/* Cougar Point */
+	TCO_CPT28,	/* Cougar Point */
+	TCO_CPT29,	/* Cougar Point */
+	TCO_CPT30,	/* Cougar Point */
+	TCO_CPT31,	/* Cougar Point */
 };
 
 static struct {
@@ -173,8 +202,37 @@
 	{"3420", 2},
 	{"3450", 2},
 	{"EP80579", 2},
-	{"CPT Desktop", 2},
-	{"CPT Mobile", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
+	{"Cougar Point", 2},
 	{NULL, 0}
 };
 
@@ -259,8 +317,37 @@
 	{ ITCO_PCI_DEVICE(0x3b14,				TCO_3420)},
 	{ ITCO_PCI_DEVICE(0x3b16,				TCO_3450)},
 	{ ITCO_PCI_DEVICE(0x5031,				TCO_EP80579)},
-	{ ITCO_PCI_DEVICE(0x1c42,				TCO_CPTD)},
-	{ ITCO_PCI_DEVICE(0x1c43,				TCO_CPTM)},
+	{ ITCO_PCI_DEVICE(0x1c41,				TCO_CPT1)},
+	{ ITCO_PCI_DEVICE(0x1c42,				TCO_CPT2)},
+	{ ITCO_PCI_DEVICE(0x1c43,				TCO_CPT3)},
+	{ ITCO_PCI_DEVICE(0x1c44,				TCO_CPT4)},
+	{ ITCO_PCI_DEVICE(0x1c45,				TCO_CPT5)},
+	{ ITCO_PCI_DEVICE(0x1c46,				TCO_CPT6)},
+	{ ITCO_PCI_DEVICE(0x1c47,				TCO_CPT7)},
+	{ ITCO_PCI_DEVICE(0x1c48,				TCO_CPT8)},
+	{ ITCO_PCI_DEVICE(0x1c49,				TCO_CPT9)},
+	{ ITCO_PCI_DEVICE(0x1c4a,				TCO_CPT10)},
+	{ ITCO_PCI_DEVICE(0x1c4b,				TCO_CPT11)},
+	{ ITCO_PCI_DEVICE(0x1c4c,				TCO_CPT12)},
+	{ ITCO_PCI_DEVICE(0x1c4d,				TCO_CPT13)},
+	{ ITCO_PCI_DEVICE(0x1c4e,				TCO_CPT14)},
+	{ ITCO_PCI_DEVICE(0x1c4f,				TCO_CPT15)},
+	{ ITCO_PCI_DEVICE(0x1c50,				TCO_CPT16)},
+	{ ITCO_PCI_DEVICE(0x1c51,				TCO_CPT17)},
+	{ ITCO_PCI_DEVICE(0x1c52,				TCO_CPT18)},
+	{ ITCO_PCI_DEVICE(0x1c53,				TCO_CPT19)},
+	{ ITCO_PCI_DEVICE(0x1c54,				TCO_CPT20)},
+	{ ITCO_PCI_DEVICE(0x1c55,				TCO_CPT21)},
+	{ ITCO_PCI_DEVICE(0x1c56,				TCO_CPT22)},
+	{ ITCO_PCI_DEVICE(0x1c57,				TCO_CPT23)},
+	{ ITCO_PCI_DEVICE(0x1c58,				TCO_CPT24)},
+	{ ITCO_PCI_DEVICE(0x1c59,				TCO_CPT25)},
+	{ ITCO_PCI_DEVICE(0x1c5a,				TCO_CPT26)},
+	{ ITCO_PCI_DEVICE(0x1c5b,				TCO_CPT27)},
+	{ ITCO_PCI_DEVICE(0x1c5c,				TCO_CPT28)},
+	{ ITCO_PCI_DEVICE(0x1c5d,				TCO_CPT29)},
+	{ ITCO_PCI_DEVICE(0x1c5e,				TCO_CPT30)},
+	{ ITCO_PCI_DEVICE(0x1c5f,				TCO_CPT31)},
 	{ 0, },			/* End of list */
 };
 MODULE_DEVICE_TABLE(pci, iTCO_wdt_pci_tbl);
diff -urN linux-2.6.34-rc3/drivers/watchdog/ibmasr.c linux-2.6.34-rc4/drivers/watchdog/ibmasr.c
--- linux-2.6.34-rc3/drivers/watchdog/ibmasr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/ibmasr.c	2010-04-13 02:19:01.766633106 +0000
@@ -12,7 +12,6 @@
 
 #include <linux/fs.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/drivers/watchdog/max63xx_wdt.c linux-2.6.34-rc4/drivers/watchdog/max63xx_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/max63xx_wdt.c	2010-04-13 02:18:56.414633075 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/max63xx_wdt.c	2010-04-13 02:19:01.767633093 +0000
@@ -28,6 +28,7 @@
 #include <linux/uaccess.h>
 #include <linux/io.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 #define DEFAULT_HEARTBEAT 60
 #define MAX_HEARTBEAT     60
diff -urN linux-2.6.34-rc3/drivers/watchdog/mpcore_wdt.c linux-2.6.34-rc4/drivers/watchdog/mpcore_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/mpcore_wdt.c	2010-04-13 02:18:56.414633075 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/mpcore_wdt.c	2010-04-13 02:19:01.767633093 +0000
@@ -30,6 +30,7 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 #include <asm/hardware/arm_twd.h>
 
diff -urN linux-2.6.34-rc3/drivers/watchdog/nuc900_wdt.c linux-2.6.34-rc4/drivers/watchdog/nuc900_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/nuc900_wdt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/nuc900_wdt.c	2010-04-13 02:19:01.767633093 +0000
@@ -20,6 +20,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/types.h>
 #include <linux/watchdog.h>
diff -urN linux-2.6.34-rc3/drivers/watchdog/omap_wdt.c linux-2.6.34-rc4/drivers/watchdog/omap_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/omap_wdt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/omap_wdt.c	2010-04-13 02:19:01.768633119 +0000
@@ -42,6 +42,7 @@
 #include <linux/bitops.h>
 #include <linux/io.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <mach/hardware.h>
 #include <plat/prcm.h>
 
diff -urN linux-2.6.34-rc3/drivers/watchdog/pika_wdt.c linux-2.6.34-rc4/drivers/watchdog/pika_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/pika_wdt.c	2010-04-13 02:18:56.415633039 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/pika_wdt.c	2010-02-24 18:52:17.000000000 +0000
@@ -52,7 +52,7 @@
 	struct timer_list timer;	/* The timer that pings the watchdog */
 } pikawdt_private;
 
-static const struct watchdog_info ident = {
+static struct watchdog_info ident = {
 	.identity	= DRV_NAME,
 	.options	= WDIOF_CARDRESET |
 			  WDIOF_SETTIMEOUT |
diff -urN linux-2.6.34-rc3/drivers/watchdog/pnx4008_wdt.c linux-2.6.34-rc4/drivers/watchdog/pnx4008_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/pnx4008_wdt.c	2010-04-13 02:18:56.415633039 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/pnx4008_wdt.c	2010-04-13 02:19:01.768633119 +0000
@@ -30,6 +30,7 @@
 #include <linux/spinlock.h>
 #include <linux/uaccess.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <mach/hardware.h>
 
 #define MODULE_NAME "PNX4008-WDT: "
diff -urN linux-2.6.34-rc3/drivers/watchdog/riowd.c linux-2.6.34-rc4/drivers/watchdog/riowd.c
--- linux-2.6.34-rc3/drivers/watchdog/riowd.c	2010-04-13 02:18:56.416633075 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/riowd.c	2010-04-13 02:19:01.769633058 +0000
@@ -15,6 +15,7 @@
 #include <linux/of_device.h>
 #include <linux/io.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 
 /* RIO uses the NatSemi Super I/O power management logical device
diff -urN linux-2.6.34-rc3/drivers/watchdog/s3c2410_wdt.c linux-2.6.34-rc4/drivers/watchdog/s3c2410_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/s3c2410_wdt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/s3c2410_wdt.c	2010-04-13 02:19:01.769633058 +0000
@@ -37,6 +37,7 @@
 #include <linux/uaccess.h>
 #include <linux/io.h>
 #include <linux/cpufreq.h>
+#include <linux/slab.h>
 
 #include <mach/map.h>
 
diff -urN linux-2.6.34-rc3/drivers/watchdog/ts72xx_wdt.c linux-2.6.34-rc4/drivers/watchdog/ts72xx_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/ts72xx_wdt.c	2010-04-13 02:18:56.416633075 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/ts72xx_wdt.c	2010-04-13 02:19:01.769633058 +0000
@@ -20,6 +20,7 @@
 #include <linux/miscdevice.h>
 #include <linux/mutex.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <linux/watchdog.h>
 #include <linux/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/watchdog/twl4030_wdt.c linux-2.6.34-rc4/drivers/watchdog/twl4030_wdt.c
--- linux-2.6.34-rc3/drivers/watchdog/twl4030_wdt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/watchdog/twl4030_wdt.c	2010-04-13 02:19:01.770633261 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/fs.h>
 #include <linux/watchdog.h>
diff -urN linux-2.6.34-rc3/drivers/xen/balloon.c linux-2.6.34-rc4/drivers/xen/balloon.c
--- linux-2.6.34-rc3/drivers/xen/balloon.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/balloon.c	2010-04-13 02:19:01.771633041 +0000
@@ -43,6 +43,7 @@
 #include <linux/mutex.h>
 #include <linux/list.h>
 #include <linux/sysdev.h>
+#include <linux/gfp.h>
 
 #include <asm/page.h>
 #include <asm/pgalloc.h>
diff -urN linux-2.6.34-rc3/drivers/xen/events.c linux-2.6.34-rc4/drivers/xen/events.c
--- linux-2.6.34-rc3/drivers/xen/events.c	2010-04-13 02:18:56.418633059 +0000
+++ linux-2.6.34-rc4/drivers/xen/events.c	2010-04-13 02:19:01.771633041 +0000
@@ -27,6 +27,7 @@
 #include <linux/module.h>
 #include <linux/string.h>
 #include <linux/bootmem.h>
+#include <linux/slab.h>
 
 #include <asm/ptrace.h>
 #include <asm/irq.h>
diff -urN linux-2.6.34-rc3/drivers/xen/evtchn.c linux-2.6.34-rc4/drivers/xen/evtchn.c
--- linux-2.6.34-rc3/drivers/xen/evtchn.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/evtchn.c	2010-04-13 02:19:01.771633041 +0000
@@ -45,7 +45,6 @@
 #include <linux/poll.h>
 #include <linux/irq.h>
 #include <linux/init.h>
-#include <linux/gfp.h>
 #include <linux/mutex.h>
 #include <linux/cpu.h>
 
diff -urN linux-2.6.34-rc3/drivers/xen/grant-table.c linux-2.6.34-rc4/drivers/xen/grant-table.c
--- linux-2.6.34-rc3/drivers/xen/grant-table.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/grant-table.c	2010-04-13 02:19:01.771633041 +0000
@@ -34,6 +34,7 @@
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/uaccess.h>
 
diff -urN linux-2.6.34-rc3/drivers/xen/manage.c linux-2.6.34-rc4/drivers/xen/manage.c
--- linux-2.6.34-rc3/drivers/xen/manage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/manage.c	2010-04-13 02:19:01.771633041 +0000
@@ -3,6 +3,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/reboot.h>
 #include <linux/sysrq.h>
 #include <linux/stop_machine.h>
diff -urN linux-2.6.34-rc3/drivers/xen/sys-hypervisor.c linux-2.6.34-rc4/drivers/xen/sys-hypervisor.c
--- linux-2.6.34-rc3/drivers/xen/sys-hypervisor.c	2010-04-13 02:18:56.418633059 +0000
+++ linux-2.6.34-rc4/drivers/xen/sys-hypervisor.c	2010-04-13 02:19:01.771633041 +0000
@@ -7,6 +7,7 @@
  *  published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/kobject.h>
diff -urN linux-2.6.34-rc3/drivers/xen/xenbus/xenbus_client.c linux-2.6.34-rc4/drivers/xen/xenbus/xenbus_client.c
--- linux-2.6.34-rc3/drivers/xen/xenbus/xenbus_client.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/xenbus/xenbus_client.c	2010-04-13 02:19:01.772633616 +0000
@@ -30,6 +30,7 @@
  * IN THE SOFTWARE.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/vmalloc.h>
 #include <asm/xen/hypervisor.h>
diff -urN linux-2.6.34-rc3/drivers/xen/xenbus/xenbus_probe.c linux-2.6.34-rc4/drivers/xen/xenbus/xenbus_probe.c
--- linux-2.6.34-rc3/drivers/xen/xenbus/xenbus_probe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/xenbus/xenbus_probe.c	2010-04-13 02:19:01.772633616 +0000
@@ -45,6 +45,7 @@
 #include <linux/kthread.h>
 #include <linux/mutex.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/drivers/xen/xencomm.c linux-2.6.34-rc4/drivers/xen/xencomm.c
--- linux-2.6.34-rc3/drivers/xen/xencomm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/xencomm.c	2010-04-13 02:19:01.772633616 +0000
@@ -18,8 +18,8 @@
  * Authors: Hollis Blanchard <hollisb@us.ibm.com>
  */
 
-#include <linux/gfp.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <asm/page.h>
 #include <xen/xencomm.h>
 #include <xen/interface/xen.h>
diff -urN linux-2.6.34-rc3/drivers/xen/xenfs/xenbus.c linux-2.6.34-rc4/drivers/xen/xenfs/xenbus.c
--- linux-2.6.34-rc3/drivers/xen/xenfs/xenbus.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/drivers/xen/xenfs/xenbus.c	2010-04-13 02:19:01.772633616 +0000
@@ -51,6 +51,7 @@
 #include <linux/init.h>
 #include <linux/namei.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 
 #include "xenfs.h"
 #include "../xenbus/xenbus_comms.h"
diff -urN linux-2.6.34-rc3/fs/9p/cache.c linux-2.6.34-rc4/fs/9p/cache.c
--- linux-2.6.34-rc3/fs/9p/cache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/9p/cache.c	2010-04-13 02:19:01.818633409 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/jiffies.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 #include <linux/sched.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/fs/9p/fid.c linux-2.6.34-rc4/fs/9p/fid.c
--- linux-2.6.34-rc3/fs/9p/fid.c	2010-04-13 02:18:56.464633026 +0000
+++ linux-2.6.34-rc4/fs/9p/fid.c	2010-04-13 02:19:01.818633409 +0000
@@ -24,6 +24,7 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/idr.h>
 #include <net/9p/9p.h>
@@ -110,7 +111,7 @@
 {
 	int i, n, l, clone, any, access;
 	u32 uid;
-	struct p9_fid *fid;
+	struct p9_fid *fid, *old_fid = NULL;
 	struct dentry *d, *ds;
 	struct v9fs_session_info *v9ses;
 	char **wnames, *uname;
@@ -183,10 +184,18 @@
 		l = min(n - i, P9_MAXWELEM);
 		fid = p9_client_walk(fid, l, &wnames[i], clone);
 		if (IS_ERR(fid)) {
+			if (old_fid) {
+				/*
+				 * If we fail, clunk fid which are mapping
+				 * to path component and not the last component
+				 * of the path.
+				 */
+				p9_client_clunk(old_fid);
+			}
 			kfree(wnames);
 			return fid;
 		}
-
+		old_fid = fid;
 		i += l;
 		clone = 0;
 	}
diff -urN linux-2.6.34-rc3/fs/9p/v9fs.c linux-2.6.34-rc4/fs/9p/v9fs.c
--- linux-2.6.34-rc3/fs/9p/v9fs.c	2010-04-13 02:18:56.464633026 +0000
+++ linux-2.6.34-rc4/fs/9p/v9fs.c	2010-04-13 02:19:01.818633409 +0000
@@ -29,6 +29,7 @@
 #include <linux/sched.h>
 #include <linux/parser.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 #include <net/9p/transport.h>
@@ -241,7 +242,7 @@
 	list_add(&v9ses->slist, &v9fs_sessionlist);
 	spin_unlock(&v9fs_sessionlist_lock);
 
-	v9ses->flags = V9FS_PROTO_2000U | V9FS_ACCESS_USER;
+	v9ses->flags = V9FS_ACCESS_USER;
 	strcpy(v9ses->uname, V9FS_DEFUSER);
 	strcpy(v9ses->aname, V9FS_DEFANAME);
 	v9ses->uid = ~0;
@@ -262,8 +263,10 @@
 		goto error;
 	}
 
-	if (!p9_is_proto_dotu(v9ses->clnt))
-		v9ses->flags &= ~V9FS_PROTO_2000U;
+	if (p9_is_proto_dotl(v9ses->clnt))
+		v9ses->flags |= V9FS_PROTO_2000L;
+	else if (p9_is_proto_dotu(v9ses->clnt))
+		v9ses->flags |= V9FS_PROTO_2000U;
 
 	v9ses->maxdata = v9ses->clnt->msize - P9_IOHDRSZ;
 
@@ -340,6 +343,19 @@
 	p9_client_disconnect(v9ses->clnt);
 }
 
+/**
+ * v9fs_session_begin_cancel - Begin terminate of a session
+ * @v9ses: session to terminate
+ *
+ * After this call we don't allow any request other than clunk.
+ */
+
+void v9fs_session_begin_cancel(struct v9fs_session_info *v9ses)
+{
+	P9_DPRINTK(P9_DEBUG_ERROR, "begin cancel session %p\n", v9ses);
+	p9_client_begin_disconnect(v9ses->clnt);
+}
+
 extern int v9fs_error_init(void);
 
 static struct kobject *v9fs_kobj;
diff -urN linux-2.6.34-rc3/fs/9p/v9fs.h linux-2.6.34-rc4/fs/9p/v9fs.h
--- linux-2.6.34-rc3/fs/9p/v9fs.h	2010-04-13 02:18:56.464633026 +0000
+++ linux-2.6.34-rc4/fs/9p/v9fs.h	2010-04-13 02:19:01.818633409 +0000
@@ -108,6 +108,7 @@
 									char *);
 void v9fs_session_close(struct v9fs_session_info *v9ses);
 void v9fs_session_cancel(struct v9fs_session_info *v9ses);
+void v9fs_session_begin_cancel(struct v9fs_session_info *v9ses);
 
 #define V9FS_MAGIC 0x01021997
 
diff -urN linux-2.6.34-rc3/fs/9p/vfs_dentry.c linux-2.6.34-rc4/fs/9p/vfs_dentry.c
--- linux-2.6.34-rc3/fs/9p/vfs_dentry.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/9p/vfs_dentry.c	2010-04-13 02:19:01.819633987 +0000
@@ -34,6 +34,7 @@
 #include <linux/namei.h>
 #include <linux/idr.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 
diff -urN linux-2.6.34-rc3/fs/9p/vfs_dir.c linux-2.6.34-rc4/fs/9p/vfs_dir.c
--- linux-2.6.34-rc3/fs/9p/vfs_dir.c	2010-04-13 02:18:56.464633026 +0000
+++ linux-2.6.34-rc4/fs/9p/vfs_dir.c	2010-04-13 02:19:01.819633987 +0000
@@ -32,6 +32,7 @@
 #include <linux/sched.h>
 #include <linux/inet.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 
@@ -130,6 +131,8 @@
 	rdir = (struct p9_rdir *) fid->rdir;
 
 	err = mutex_lock_interruptible(&rdir->mutex);
+	if (err)
+		return err;
 	while (err == 0) {
 		if (rdir->tail == rdir->head) {
 			err = v9fs_file_readn(filp, rdir->buf, NULL,
diff -urN linux-2.6.34-rc3/fs/9p/vfs_inode.c linux-2.6.34-rc4/fs/9p/vfs_inode.c
--- linux-2.6.34-rc3/fs/9p/vfs_inode.c	2010-04-13 02:18:56.464633026 +0000
+++ linux-2.6.34-rc4/fs/9p/vfs_inode.c	2010-04-13 02:19:01.819633987 +0000
@@ -34,6 +34,7 @@
 #include <linux/namei.h>
 #include <linux/idr.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 
@@ -431,6 +432,7 @@
 
 static int v9fs_remove(struct inode *dir, struct dentry *file, int rmdir)
 {
+	int retval;
 	struct inode *file_inode;
 	struct v9fs_session_info *v9ses;
 	struct p9_fid *v9fid;
@@ -444,7 +446,10 @@
 	if (IS_ERR(v9fid))
 		return PTR_ERR(v9fid);
 
-	return p9_client_remove(v9fid);
+	retval = p9_client_remove(v9fid);
+	if (!retval)
+		drop_nlink(file_inode);
+	return retval;
 }
 
 static int
@@ -656,6 +661,9 @@
 	P9_DPRINTK(P9_DEBUG_VFS, "dir: %p dentry: (%s) %p nameidata: %p\n",
 		dir, dentry->d_name.name, dentry, nameidata);
 
+	if (dentry->d_name.len > NAME_MAX)
+		return ERR_PTR(-ENAMETOOLONG);
+
 	sb = dir->i_sb;
 	v9ses = v9fs_inode2v9ses(dir);
 	dfid = v9fs_fid_lookup(dentry->d_parent);
diff -urN linux-2.6.34-rc3/fs/9p/vfs_super.c linux-2.6.34-rc4/fs/9p/vfs_super.c
--- linux-2.6.34-rc3/fs/9p/vfs_super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/9p/vfs_super.c	2010-04-13 02:19:01.819633987 +0000
@@ -37,6 +37,7 @@
 #include <linux/mount.h>
 #include <linux/idr.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 
@@ -193,6 +194,7 @@
 
 	kill_anon_super(s);
 
+	v9fs_session_cancel(v9ses);
 	v9fs_session_close(v9ses);
 	kfree(v9ses);
 	s->s_fs_info = NULL;
@@ -205,7 +207,7 @@
 	struct v9fs_session_info *v9ses;
 
 	v9ses = sb->s_fs_info;
-	v9fs_session_cancel(v9ses);
+	v9fs_session_begin_cancel(v9ses);
 }
 
 static const struct super_operations v9fs_super_ops = {
diff -urN linux-2.6.34-rc3/fs/adfs/super.c linux-2.6.34-rc4/fs/adfs/super.c
--- linux-2.6.34-rc3/fs/adfs/super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/adfs/super.c	2010-04-13 02:19:01.820633404 +0000
@@ -13,6 +13,7 @@
 #include <linux/parser.h>
 #include <linux/mount.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/statfs.h>
 #include "adfs.h"
diff -urN linux-2.6.34-rc3/fs/affs/bitmap.c linux-2.6.34-rc4/fs/affs/bitmap.c
--- linux-2.6.34-rc3/fs/affs/bitmap.c	2010-04-13 02:18:56.465633065 +0000
+++ linux-2.6.34-rc4/fs/affs/bitmap.c	2010-04-13 02:19:01.820633404 +0000
@@ -7,6 +7,7 @@
  *  block allocation, deallocation, calculation of free space.
  */
 
+#include <linux/slab.h>
 #include "affs.h"
 
 /* This is, of course, shamelessly stolen from fs/minix */
diff -urN linux-2.6.34-rc3/fs/affs/inode.c linux-2.6.34-rc4/fs/affs/inode.c
--- linux-2.6.34-rc3/fs/affs/inode.c	2010-04-13 02:18:56.465633065 +0000
+++ linux-2.6.34-rc4/fs/affs/inode.c	2010-04-13 02:19:01.820633404 +0000
@@ -10,6 +10,7 @@
  *  (C) 1991  Linus Torvalds - minix filesystem
  */
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include "affs.h"
 
 extern const struct inode_operations affs_symlink_inode_operations;
diff -urN linux-2.6.34-rc3/fs/affs/super.c linux-2.6.34-rc4/fs/affs/super.c
--- linux-2.6.34-rc3/fs/affs/super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/affs/super.c	2010-04-13 02:19:01.820633404 +0000
@@ -17,6 +17,7 @@
 #include <linux/magic.h>
 #include <linux/sched.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include "affs.h"
 
 extern struct timezone sys_tz;
diff -urN linux-2.6.34-rc3/fs/afs/cache.c linux-2.6.34-rc4/fs/afs/cache.c
--- linux-2.6.34-rc3/fs/afs/cache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/cache.c	2010-04-13 02:19:01.820633404 +0000
@@ -9,7 +9,6 @@
  * 2 of the License, or (at your option) any later version.
  */
 
-#include <linux/slab.h>
 #include <linux/sched.h>
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/fs/afs/cmservice.c linux-2.6.34-rc4/fs/afs/cmservice.c
--- linux-2.6.34-rc3/fs/afs/cmservice.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/cmservice.c	2010-04-13 02:19:01.820633404 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/ip.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/afs/dir.c linux-2.6.34-rc4/fs/afs/dir.c
--- linux-2.6.34-rc3/fs/afs/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/dir.c	2010-04-13 02:19:01.821633418 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/pagemap.h>
 #include <linux/ctype.h>
diff -urN linux-2.6.34-rc3/fs/afs/file.c linux-2.6.34-rc4/fs/afs/file.c
--- linux-2.6.34-rc3/fs/afs/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/file.c	2010-04-13 02:19:01.821633418 +0000
@@ -12,10 +12,10 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/pagemap.h>
 #include <linux/writeback.h>
+#include <linux/gfp.h>
 #include "internal.h"
 
 static int afs_readpage(struct file *file, struct page *page);
diff -urN linux-2.6.34-rc3/fs/afs/fsclient.c linux-2.6.34-rc4/fs/afs/fsclient.c
--- linux-2.6.34-rc3/fs/afs/fsclient.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/fsclient.c	2010-04-13 02:19:01.821633418 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/circ_buf.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/afs/inode.c linux-2.6.34-rc4/fs/afs/inode.c
--- linux-2.6.34-rc3/fs/afs/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/inode.c	2010-04-13 02:19:01.821633418 +0000
@@ -16,7 +16,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/pagemap.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/fs/afs/mntpt.c linux-2.6.34-rc4/fs/afs/mntpt.c
--- linux-2.6.34-rc3/fs/afs/mntpt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/mntpt.c	2010-04-13 02:19:01.821633418 +0000
@@ -12,11 +12,11 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/pagemap.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
+#include <linux/gfp.h>
 #include "internal.h"
 
 
diff -urN linux-2.6.34-rc3/fs/afs/rxrpc.c linux-2.6.34-rc4/fs/afs/rxrpc.c
--- linux-2.6.34-rc3/fs/afs/rxrpc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/rxrpc.c	2010-04-13 02:19:01.821633418 +0000
@@ -9,6 +9,7 @@
  * 2 of the License, or (at your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <rxrpc/packet.h>
diff -urN linux-2.6.34-rc3/fs/afs/vlclient.c linux-2.6.34-rc4/fs/afs/vlclient.c
--- linux-2.6.34-rc3/fs/afs/vlclient.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/vlclient.c	2010-04-13 02:19:01.822633576 +0000
@@ -9,6 +9,7 @@
  * 2 of the License, or (at your option) any later version.
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/afs/vlocation.c linux-2.6.34-rc4/fs/afs/vlocation.c
--- linux-2.6.34-rc3/fs/afs/vlocation.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/vlocation.c	2010-04-13 02:19:01.822633576 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/afs/vnode.c linux-2.6.34-rc4/fs/afs/vnode.c
--- linux-2.6.34-rc3/fs/afs/vnode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/afs/vnode.c	2010-04-13 02:19:01.822633576 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/anon_inodes.c linux-2.6.34-rc4/fs/anon_inodes.c
--- linux-2.6.34-rc3/fs/anon_inodes.c	2010-04-13 02:18:56.466633068 +0000
+++ linux-2.6.34-rc4/fs/anon_inodes.c	2010-04-13 02:19:01.822633576 +0000
@@ -12,7 +12,6 @@
 #include <linux/file.h>
 #include <linux/poll.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/fs.h>
 #include <linux/mount.h>
diff -urN linux-2.6.34-rc3/fs/autofs/root.c linux-2.6.34-rc4/fs/autofs/root.c
--- linux-2.6.34-rc3/fs/autofs/root.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/autofs/root.c	2010-04-13 02:19:01.823633533 +0000
@@ -13,6 +13,7 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/param.h>
 #include <linux/time.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/fs/autofs4/dev-ioctl.c linux-2.6.34-rc4/fs/autofs4/dev-ioctl.c
--- linux-2.6.34-rc3/fs/autofs4/dev-ioctl.c	2010-04-13 02:18:56.466633068 +0000
+++ linux-2.6.34-rc4/fs/autofs4/dev-ioctl.c	2010-04-13 02:19:01.823633533 +0000
@@ -22,6 +22,7 @@
 #include <linux/magic.h>
 #include <linux/dcache.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 #include "autofs_i.h"
 
diff -urN linux-2.6.34-rc3/fs/autofs4/root.c linux-2.6.34-rc4/fs/autofs4/root.c
--- linux-2.6.34-rc3/fs/autofs4/root.c	2010-04-13 02:18:56.467633044 +0000
+++ linux-2.6.34-rc4/fs/autofs4/root.c	2010-04-13 02:19:01.824633484 +0000
@@ -15,6 +15,7 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/param.h>
 #include <linux/time.h>
 #include "autofs_i.h"
diff -urN linux-2.6.34-rc3/fs/befs/datastream.c linux-2.6.34-rc4/fs/befs/datastream.c
--- linux-2.6.34-rc3/fs/befs/datastream.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/befs/datastream.c	2010-04-13 02:19:01.824633484 +0000
@@ -11,7 +11,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/buffer_head.h>
 #include <linux/string.h>
 
diff -urN linux-2.6.34-rc3/fs/binfmt_aout.c linux-2.6.34-rc4/fs/binfmt_aout.c
--- linux-2.6.34-rc3/fs/binfmt_aout.c	2010-04-13 02:18:56.467633044 +0000
+++ linux-2.6.34-rc4/fs/binfmt_aout.c	2010-04-13 02:19:01.824633484 +0000
@@ -20,11 +20,11 @@
 #include <linux/fcntl.h>
 #include <linux/ptrace.h>
 #include <linux/user.h>
-#include <linux/slab.h>
 #include <linux/binfmts.h>
 #include <linux/personality.h>
 #include <linux/init.h>
 #include <linux/coredump.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/binfmt_em86.c linux-2.6.34-rc4/fs/binfmt_em86.c
--- linux-2.6.34-rc3/fs/binfmt_em86.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/binfmt_em86.c	2010-04-13 02:19:01.825633399 +0000
@@ -11,7 +11,6 @@
 #include <linux/module.h>
 #include <linux/string.h>
 #include <linux/stat.h>
-#include <linux/slab.h>
 #include <linux/binfmts.h>
 #include <linux/elf.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/fs/binfmt_script.c linux-2.6.34-rc4/fs/binfmt_script.c
--- linux-2.6.34-rc3/fs/binfmt_script.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/binfmt_script.c	2010-04-13 02:19:01.825633399 +0000
@@ -8,7 +8,6 @@
 #include <linux/module.h>
 #include <linux/string.h>
 #include <linux/stat.h>
-#include <linux/slab.h>
 #include <linux/binfmts.h>
 #include <linux/init.h>
 #include <linux/file.h>
diff -urN linux-2.6.34-rc3/fs/bio-integrity.c linux-2.6.34-rc4/fs/bio-integrity.c
--- linux-2.6.34-rc3/fs/bio-integrity.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/bio-integrity.c	2010-04-13 02:19:01.826633716 +0000
@@ -24,6 +24,7 @@
 #include <linux/mempool.h>
 #include <linux/bio.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 
 struct integrity_slab {
 	struct kmem_cache *slab;
diff -urN linux-2.6.34-rc3/fs/bio.c linux-2.6.34-rc4/fs/bio.c
--- linux-2.6.34-rc3/fs/bio.c	2010-04-13 02:18:56.469571559 +0000
+++ linux-2.6.34-rc4/fs/bio.c	2010-04-13 02:19:01.826633716 +0000
@@ -554,7 +554,7 @@
 					.bi_rw = bio->bi_rw,
 				};
 
-				if (q->merge_bvec_fn(q, &bvm, prev) < len) {
+				if (q->merge_bvec_fn(q, &bvm, prev) < prev->bv_len) {
 					prev->bv_len -= len;
 					return 0;
 				}
@@ -607,7 +607,7 @@
 		 * merge_bvec_fn() returns number of bytes it can accept
 		 * at this offset
 		 */
-		if (q->merge_bvec_fn(q, &bvm, bvec) < len) {
+		if (q->merge_bvec_fn(q, &bvm, bvec) < bvec->bv_len) {
 			bvec->bv_page = NULL;
 			bvec->bv_len = 0;
 			bvec->bv_offset = 0;
diff -urN linux-2.6.34-rc3/fs/block_dev.c linux-2.6.34-rc4/fs/block_dev.c
--- linux-2.6.34-rc3/fs/block_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/block_dev.c	2010-04-13 02:19:01.826633716 +0000
@@ -404,7 +404,7 @@
  *	NULL first argument is nfsd_sync_dir() and that's not a directory.
  */
  
-static int block_fsync(struct file *filp, struct dentry *dentry, int datasync)
+int blkdev_fsync(struct file *filp, struct dentry *dentry, int datasync)
 {
 	struct block_device *bdev = I_BDEV(filp->f_mapping->host);
 	int error;
@@ -418,6 +418,7 @@
 		error = 0;
 	return error;
 }
+EXPORT_SYMBOL(blkdev_fsync);
 
 /*
  * pseudo-fs
@@ -1481,7 +1482,7 @@
   	.aio_read	= generic_file_aio_read,
 	.aio_write	= blkdev_aio_write,
 	.mmap		= generic_file_mmap,
-	.fsync		= block_fsync,
+	.fsync		= blkdev_fsync,
 	.unlocked_ioctl	= block_ioctl,
 #ifdef CONFIG_COMPAT
 	.compat_ioctl	= compat_blkdev_ioctl,
diff -urN linux-2.6.34-rc3/fs/btrfs/acl.c linux-2.6.34-rc4/fs/btrfs/acl.c
--- linux-2.6.34-rc3/fs/btrfs/acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/acl.c	2010-04-13 02:19:01.826633716 +0000
@@ -22,6 +22,7 @@
 #include <linux/posix_acl_xattr.h>
 #include <linux/posix_acl.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include "ctree.h"
 #include "btrfs_inode.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/async-thread.c linux-2.6.34-rc4/fs/btrfs/async-thread.c
--- linux-2.6.34-rc3/fs/btrfs/async-thread.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/async-thread.c	2010-04-13 02:19:01.826633716 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/spinlock.h>
 #include <linux/freezer.h>
diff -urN linux-2.6.34-rc3/fs/btrfs/compression.c linux-2.6.34-rc4/fs/btrfs/compression.c
--- linux-2.6.34-rc3/fs/btrfs/compression.c	2010-04-13 02:18:56.469571559 +0000
+++ linux-2.6.34-rc4/fs/btrfs/compression.c	2010-04-13 02:19:01.827633370 +0000
@@ -31,7 +31,7 @@
 #include <linux/swap.h>
 #include <linux/writeback.h>
 #include <linux/bit_spinlock.h>
-#include <linux/pagevec.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "ctree.h"
 #include "disk-io.h"
@@ -445,7 +445,6 @@
 	unsigned long nr_pages = 0;
 	struct extent_map *em;
 	struct address_space *mapping = inode->i_mapping;
-	struct pagevec pvec;
 	struct extent_map_tree *em_tree;
 	struct extent_io_tree *tree;
 	u64 end;
@@ -461,7 +460,6 @@
 
 	end_index = (i_size_read(inode) - 1) >> PAGE_CACHE_SHIFT;
 
-	pagevec_init(&pvec, 0);
 	while (last_offset < compressed_end) {
 		page_index = last_offset >> PAGE_CACHE_SHIFT;
 
@@ -478,26 +476,17 @@
 			goto next;
 		}
 
-		page = alloc_page(mapping_gfp_mask(mapping) & ~__GFP_FS);
+		page = __page_cache_alloc(mapping_gfp_mask(mapping) &
+								~__GFP_FS);
 		if (!page)
 			break;
 
-		page->index = page_index;
-		/*
-		 * what we want to do here is call add_to_page_cache_lru,
-		 * but that isn't exported, so we reproduce it here
-		 */
-		if (add_to_page_cache(page, mapping,
-				      page->index, GFP_NOFS)) {
+		if (add_to_page_cache_lru(page, mapping, page_index,
+								GFP_NOFS)) {
 			page_cache_release(page);
 			goto next;
 		}
 
-		/* open coding of lru_cache_add, also not exported */
-		page_cache_get(page);
-		if (!pagevec_add(&pvec, page))
-			__pagevec_lru_add_file(&pvec);
-
 		end = last_offset + PAGE_CACHE_SIZE - 1;
 		/*
 		 * at this point, we have a locked page in the page cache
@@ -551,8 +540,6 @@
 next:
 		last_offset += PAGE_CACHE_SIZE;
 	}
-	if (pagevec_count(&pvec))
-		__pagevec_lru_add_file(&pvec);
 	return 0;
 }
 
diff -urN linux-2.6.34-rc3/fs/btrfs/ctree.c linux-2.6.34-rc4/fs/btrfs/ctree.c
--- linux-2.6.34-rc3/fs/btrfs/ctree.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/ctree.c	2010-04-13 02:19:01.827633370 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "ctree.h"
 #include "disk-io.h"
 #include "transaction.h"
@@ -3040,6 +3041,10 @@
 	if (ret > 0 || item_size != btrfs_item_size_nr(leaf, path->slots[0]))
 		goto err;
 
+	/* the leaf has  changed, it now has room.  return now */
+	if (btrfs_leaf_free_space(root, path->nodes[0]) >= ins_len)
+		goto err;
+
 	if (key.type == BTRFS_EXTENT_DATA_KEY) {
 		fi = btrfs_item_ptr(leaf, path->slots[0],
 				    struct btrfs_file_extent_item);
diff -urN linux-2.6.34-rc3/fs/btrfs/ctree.h linux-2.6.34-rc4/fs/btrfs/ctree.h
--- linux-2.6.34-rc3/fs/btrfs/ctree.h	2010-04-13 02:18:56.469571559 +0000
+++ linux-2.6.34-rc4/fs/btrfs/ctree.h	2010-04-13 02:19:01.828633645 +0000
@@ -26,6 +26,7 @@
 #include <linux/completion.h>
 #include <linux/backing-dev.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <asm/kmap_types.h>
 #include "extent_io.h"
 #include "extent_map.h"
@@ -834,7 +835,6 @@
 	u64 last_trans_log_full_commit;
 	u64 open_ioctl_trans;
 	unsigned long mount_opt;
-	u64 max_extent;
 	u64 max_inline;
 	u64 alloc_start;
 	struct btrfs_transaction *running_transaction;
diff -urN linux-2.6.34-rc3/fs/btrfs/delayed-ref.c linux-2.6.34-rc4/fs/btrfs/delayed-ref.c
--- linux-2.6.34-rc3/fs/btrfs/delayed-ref.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/delayed-ref.c	2010-04-13 02:19:01.828633645 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/sort.h>
 #include "ctree.h"
 #include "delayed-ref.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/disk-io.c linux-2.6.34-rc4/fs/btrfs/disk-io.c
--- linux-2.6.34-rc3/fs/btrfs/disk-io.c	2010-04-13 02:18:56.470570512 +0000
+++ linux-2.6.34-rc4/fs/btrfs/disk-io.c	2010-04-13 02:19:01.828633645 +0000
@@ -27,6 +27,7 @@
 #include <linux/kthread.h>
 #include <linux/freezer.h>
 #include <linux/crc32c.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "ctree.h"
 #include "disk-io.h"
@@ -1634,7 +1635,6 @@
 	atomic_set(&fs_info->async_submit_draining, 0);
 	atomic_set(&fs_info->nr_async_bios, 0);
 	fs_info->sb = sb;
-	fs_info->max_extent = (u64)-1;
 	fs_info->max_inline = 8192 * 1024;
 	fs_info->metadata_ratio = 0;
 
@@ -1922,7 +1922,11 @@
 
 	csum_root->track_dirty = 1;
 
-	btrfs_read_block_groups(extent_root);
+	ret = btrfs_read_block_groups(extent_root);
+	if (ret) {
+		printk(KERN_ERR "Failed to read block groups: %d\n", ret);
+		goto fail_block_groups;
+	}
 
 	fs_info->generation = generation;
 	fs_info->last_trans_committed = generation;
@@ -1932,7 +1936,7 @@
 	fs_info->cleaner_kthread = kthread_run(cleaner_kthread, tree_root,
 					       "btrfs-cleaner");
 	if (IS_ERR(fs_info->cleaner_kthread))
-		goto fail_csum_root;
+		goto fail_block_groups;
 
 	fs_info->transaction_kthread = kthread_run(transaction_kthread,
 						   tree_root,
@@ -2020,7 +2024,8 @@
 	filemap_write_and_wait(fs_info->btree_inode->i_mapping);
 	invalidate_inode_pages2(fs_info->btree_inode->i_mapping);
 
-fail_csum_root:
+fail_block_groups:
+	btrfs_free_block_groups(fs_info);
 	free_extent_buffer(csum_root->node);
 	free_extent_buffer(csum_root->commit_root);
 fail_dev_root:
diff -urN linux-2.6.34-rc3/fs/btrfs/extent-tree.c linux-2.6.34-rc4/fs/btrfs/extent-tree.c
--- linux-2.6.34-rc3/fs/btrfs/extent-tree.c	2010-04-13 02:18:56.471633016 +0000
+++ linux-2.6.34-rc4/fs/btrfs/extent-tree.c	2010-04-13 02:19:01.830633268 +0000
@@ -22,6 +22,7 @@
 #include <linux/sort.h>
 #include <linux/rcupdate.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "hash.h"
 #include "ctree.h"
@@ -2676,6 +2677,8 @@
 
 	INIT_LIST_HEAD(&found->block_groups);
 	init_rwsem(&found->groups_sem);
+	init_waitqueue_head(&found->flush_wait);
+	init_waitqueue_head(&found->allocate_wait);
 	spin_lock_init(&found->lock);
 	found->flags = flags;
 	found->total_bytes = total_bytes;
@@ -2846,7 +2849,7 @@
 	}
 	spin_unlock(&BTRFS_I(inode)->accounting_lock);
 
-	BTRFS_I(inode)->reserved_extents--;
+	BTRFS_I(inode)->reserved_extents -= num_items;
 	BUG_ON(BTRFS_I(inode)->reserved_extents < 0);
 
 	if (meta_sinfo->bytes_delalloc < num_bytes) {
@@ -2944,12 +2947,10 @@
 
 	spin_lock(&info->lock);
 
-	if (!info->flushing) {
+	if (!info->flushing)
 		info->flushing = 1;
-		init_waitqueue_head(&info->flush_wait);
-	} else {
+	else
 		wait = true;
-	}
 
 	spin_unlock(&info->lock);
 
@@ -3011,7 +3012,6 @@
 	if (!info->allocating_chunk) {
 		info->force_alloc = 1;
 		info->allocating_chunk = 1;
-		init_waitqueue_head(&info->allocate_wait);
 	} else {
 		wait = true;
 	}
@@ -3111,7 +3111,7 @@
 		return -ENOSPC;
 	}
 
-	BTRFS_I(inode)->reserved_extents++;
+	BTRFS_I(inode)->reserved_extents += num_items;
 	check_force_delalloc(meta_sinfo);
 	spin_unlock(&meta_sinfo->lock);
 
@@ -3235,7 +3235,8 @@
 				u64 bytes)
 {
 	struct btrfs_space_info *data_sinfo;
-	int ret = 0, committed = 0;
+	u64 used;
+	int ret = 0, committed = 0, flushed = 0;
 
 	/* make sure bytes are sectorsize aligned */
 	bytes = (bytes + root->sectorsize - 1) & ~((u64)root->sectorsize - 1);
@@ -3247,12 +3248,21 @@
 again:
 	/* make sure we have enough space to handle the data first */
 	spin_lock(&data_sinfo->lock);
-	if (data_sinfo->total_bytes - data_sinfo->bytes_used -
-	    data_sinfo->bytes_delalloc - data_sinfo->bytes_reserved -
-	    data_sinfo->bytes_pinned - data_sinfo->bytes_readonly -
-	    data_sinfo->bytes_may_use - data_sinfo->bytes_super < bytes) {
+	used = data_sinfo->bytes_used + data_sinfo->bytes_delalloc +
+		data_sinfo->bytes_reserved + data_sinfo->bytes_pinned +
+		data_sinfo->bytes_readonly + data_sinfo->bytes_may_use +
+		data_sinfo->bytes_super;
+
+	if (used + bytes > data_sinfo->total_bytes) {
 		struct btrfs_trans_handle *trans;
 
+		if (!flushed) {
+			spin_unlock(&data_sinfo->lock);
+			flush_delalloc(root, data_sinfo);
+			flushed = 1;
+			goto again;
+		}
+
 		/*
 		 * if we don't have enough free bytes in this space then we need
 		 * to alloc a new chunk.
@@ -4170,6 +4180,10 @@
 	ins->offset = 0;
 
 	space_info = __find_space_info(root->fs_info, data);
+	if (!space_info) {
+		printk(KERN_ERR "No space info for %d\n", data);
+		return -ENOSPC;
+	}
 
 	if (orig_root->ref_cows || empty_size)
 		allowed_chunk_alloc = 1;
@@ -5205,6 +5219,8 @@
 	next = btrfs_find_tree_block(root, bytenr, blocksize);
 	if (!next) {
 		next = btrfs_find_create_tree_block(root, bytenr, blocksize);
+		if (!next)
+			return -ENOMEM;
 		reada = 1;
 	}
 	btrfs_tree_lock(next);
@@ -5417,7 +5433,8 @@
 		if (ret > 0) {
 			path->slots[level]++;
 			continue;
-		}
+		} else if (ret < 0)
+			return ret;
 		level = wc->level;
 	}
 	return 0;
@@ -7369,7 +7386,6 @@
 		}
 		path->slots[0]++;
 	}
-	ret = -ENOENT;
 out:
 	return ret;
 }
diff -urN linux-2.6.34-rc3/fs/btrfs/extent_io.c linux-2.6.34-rc4/fs/btrfs/extent_io.c
--- linux-2.6.34-rc3/fs/btrfs/extent_io.c	2010-04-13 02:18:56.471633016 +0000
+++ linux-2.6.34-rc4/fs/btrfs/extent_io.c	2010-04-13 02:19:01.830633268 +0000
@@ -2,7 +2,6 @@
 #include <linux/slab.h>
 #include <linux/bio.h>
 #include <linux/mm.h>
-#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/page-flags.h>
 #include <linux/module.h>
@@ -2679,33 +2678,20 @@
 {
 	struct bio *bio = NULL;
 	unsigned page_idx;
-	struct pagevec pvec;
 	unsigned long bio_flags = 0;
 
-	pagevec_init(&pvec, 0);
 	for (page_idx = 0; page_idx < nr_pages; page_idx++) {
 		struct page *page = list_entry(pages->prev, struct page, lru);
 
 		prefetchw(&page->flags);
 		list_del(&page->lru);
-		/*
-		 * what we want to do here is call add_to_page_cache_lru,
-		 * but that isn't exported, so we reproduce it here
-		 */
-		if (!add_to_page_cache(page, mapping,
+		if (!add_to_page_cache_lru(page, mapping,
 					page->index, GFP_KERNEL)) {
-
-			/* open coding of lru_cache_add, also not exported */
-			page_cache_get(page);
-			if (!pagevec_add(&pvec, page))
-				__pagevec_lru_add_file(&pvec);
 			__extent_read_full_page(tree, page, get_extent,
 						&bio, 0, &bio_flags);
 		}
 		page_cache_release(page);
 	}
-	if (pagevec_count(&pvec))
-		__pagevec_lru_add_file(&pvec);
 	BUG_ON(!list_empty(pages));
 	if (bio)
 		submit_one_bio(READ, bio, 0, bio_flags);
diff -urN linux-2.6.34-rc3/fs/btrfs/extent_map.c linux-2.6.34-rc4/fs/btrfs/extent_map.c
--- linux-2.6.34-rc3/fs/btrfs/extent_map.c	2010-04-13 02:18:56.472633024 +0000
+++ linux-2.6.34-rc4/fs/btrfs/extent_map.c	2010-04-13 02:19:01.831633597 +0000
@@ -1,5 +1,4 @@
 #include <linux/err.h>
-#include <linux/gfp.h>
 #include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/fs/btrfs/file-item.c linux-2.6.34-rc4/fs/btrfs/file-item.c
--- linux-2.6.34-rc3/fs/btrfs/file-item.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/file-item.c	2010-04-13 02:19:01.831633597 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/bio.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/highmem.h>
 #include "ctree.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/file.c linux-2.6.34-rc4/fs/btrfs/file.c
--- linux-2.6.34-rc3/fs/btrfs/file.c	2010-04-13 02:18:56.472633024 +0000
+++ linux-2.6.34-rc4/fs/btrfs/file.c	2010-04-13 02:19:01.831633597 +0000
@@ -28,6 +28,7 @@
 #include <linux/writeback.h>
 #include <linux/statfs.h>
 #include <linux/compat.h>
+#include <linux/slab.h>
 #include "ctree.h"
 #include "disk-io.h"
 #include "transaction.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/free-space-cache.c linux-2.6.34-rc4/fs/btrfs/free-space-cache.c
--- linux-2.6.34-rc3/fs/btrfs/free-space-cache.c	2010-04-13 02:18:56.472633024 +0000
+++ linux-2.6.34-rc4/fs/btrfs/free-space-cache.c	2010-04-13 02:19:01.831633597 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/pagemap.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/math64.h>
 #include "ctree.h"
 #include "free-space-cache.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/inode.c linux-2.6.34-rc4/fs/btrfs/inode.c
--- linux-2.6.34-rc3/fs/btrfs/inode.c	2010-04-13 02:18:56.473633075 +0000
+++ linux-2.6.34-rc4/fs/btrfs/inode.c	2010-04-13 02:19:01.832633473 +0000
@@ -36,6 +36,7 @@
 #include <linux/xattr.h>
 #include <linux/posix_acl.h>
 #include <linux/falloc.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "ctree.h"
 #include "disk-io.h"
@@ -796,7 +797,7 @@
 	while (disk_num_bytes > 0) {
 		unsigned long op;
 
-		cur_alloc_size = min(disk_num_bytes, root->fs_info->max_extent);
+		cur_alloc_size = disk_num_bytes;
 		ret = btrfs_reserve_extent(trans, root, cur_alloc_size,
 					   root->sectorsize, 0, alloc_hint,
 					   (u64)-1, &ins, 1);
@@ -1227,30 +1228,9 @@
 static int btrfs_split_extent_hook(struct inode *inode,
 				    struct extent_state *orig, u64 split)
 {
-	struct btrfs_root *root = BTRFS_I(inode)->root;
-	u64 size;
-
 	if (!(orig->state & EXTENT_DELALLOC))
 		return 0;
 
-	size = orig->end - orig->start + 1;
-	if (size > root->fs_info->max_extent) {
-		u64 num_extents;
-		u64 new_size;
-
-		new_size = orig->end - split + 1;
-		num_extents = div64_u64(size + root->fs_info->max_extent - 1,
-					root->fs_info->max_extent);
-
-		/*
-		 * if we break a large extent up then leave oustanding_extents
-		 * be, since we've already accounted for the large extent.
-		 */
-		if (div64_u64(new_size + root->fs_info->max_extent - 1,
-			      root->fs_info->max_extent) < num_extents)
-			return 0;
-	}
-
 	spin_lock(&BTRFS_I(inode)->accounting_lock);
 	BTRFS_I(inode)->outstanding_extents++;
 	spin_unlock(&BTRFS_I(inode)->accounting_lock);
@@ -1268,38 +1248,10 @@
 				   struct extent_state *new,
 				   struct extent_state *other)
 {
-	struct btrfs_root *root = BTRFS_I(inode)->root;
-	u64 new_size, old_size;
-	u64 num_extents;
-
 	/* not delalloc, ignore it */
 	if (!(other->state & EXTENT_DELALLOC))
 		return 0;
 
-	old_size = other->end - other->start + 1;
-	if (new->start < other->start)
-		new_size = other->end - new->start + 1;
-	else
-		new_size = new->end - other->start + 1;
-
-	/* we're not bigger than the max, unreserve the space and go */
-	if (new_size <= root->fs_info->max_extent) {
-		spin_lock(&BTRFS_I(inode)->accounting_lock);
-		BTRFS_I(inode)->outstanding_extents--;
-		spin_unlock(&BTRFS_I(inode)->accounting_lock);
-		return 0;
-	}
-
-	/*
-	 * If we grew by another max_extent, just return, we want to keep that
-	 * reserved amount.
-	 */
-	num_extents = div64_u64(old_size + root->fs_info->max_extent - 1,
-				root->fs_info->max_extent);
-	if (div64_u64(new_size + root->fs_info->max_extent - 1,
-		      root->fs_info->max_extent) > num_extents)
-		return 0;
-
 	spin_lock(&BTRFS_I(inode)->accounting_lock);
 	BTRFS_I(inode)->outstanding_extents--;
 	spin_unlock(&BTRFS_I(inode)->accounting_lock);
@@ -1328,6 +1280,7 @@
 		BTRFS_I(inode)->outstanding_extents++;
 		spin_unlock(&BTRFS_I(inode)->accounting_lock);
 		btrfs_delalloc_reserve_space(root, inode, end - start + 1);
+
 		spin_lock(&root->fs_info->delalloc_lock);
 		BTRFS_I(inode)->delalloc_bytes += end - start + 1;
 		root->fs_info->delalloc_bytes += end - start + 1;
@@ -1356,6 +1309,7 @@
 
 		if (bits & EXTENT_DO_ACCOUNTING) {
 			spin_lock(&BTRFS_I(inode)->accounting_lock);
+			WARN_ON(!BTRFS_I(inode)->outstanding_extents);
 			BTRFS_I(inode)->outstanding_extents--;
 			spin_unlock(&BTRFS_I(inode)->accounting_lock);
 			btrfs_unreserve_metadata_for_delalloc(root, inode, 1);
@@ -5384,7 +5338,6 @@
 void btrfs_drop_inode(struct inode *inode)
 {
 	struct btrfs_root *root = BTRFS_I(inode)->root;
-
 	if (inode->i_nlink > 0 && btrfs_root_refs(&root->root_item) == 0)
 		generic_delete_inode(inode);
 	else
@@ -5788,18 +5741,15 @@
 	struct btrfs_trans_handle *trans;
 	struct btrfs_root *root = BTRFS_I(inode)->root;
 	struct btrfs_key ins;
-	u64 alloc_size;
 	u64 cur_offset = start;
 	u64 num_bytes = end - start;
 	int ret = 0;
 	u64 i_size;
 
 	while (num_bytes > 0) {
-		alloc_size = min(num_bytes, root->fs_info->max_extent);
-
 		trans = btrfs_start_transaction(root, 1);
 
-		ret = btrfs_reserve_extent(trans, root, alloc_size,
+		ret = btrfs_reserve_extent(trans, root, num_bytes,
 					   root->sectorsize, 0, alloc_hint,
 					   (u64)-1, &ins, 1);
 		if (ret) {
diff -urN linux-2.6.34-rc3/fs/btrfs/ioctl.c linux-2.6.34-rc4/fs/btrfs/ioctl.c
--- linux-2.6.34-rc3/fs/btrfs/ioctl.c	2010-04-13 02:18:56.474633045 +0000
+++ linux-2.6.34-rc4/fs/btrfs/ioctl.c	2010-04-13 02:19:01.833633319 +0000
@@ -39,6 +39,7 @@
 #include <linux/security.h>
 #include <linux/xattr.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "ctree.h"
 #include "disk-io.h"
@@ -48,7 +49,6 @@
 #include "print-tree.h"
 #include "volumes.h"
 #include "locking.h"
-#include "ctree.h"
 
 /* Mask out flags that are inappropriate for the given type of inode. */
 static inline __u32 btrfs_mask_flags(umode_t mode, __u32 flags)
@@ -511,7 +511,7 @@
 		em = btrfs_get_extent(inode, NULL, 0, start, len, 0);
 		unlock_extent(io_tree, start, start + len - 1, GFP_NOFS);
 
-		if (!em)
+		if (IS_ERR(em))
 			return 0;
 	}
 
@@ -1212,6 +1212,9 @@
 		return -EPERM;
 
 	args = kmalloc(sizeof(*args), GFP_KERNEL);
+	if (!args)
+		return -ENOMEM;
+
 	if (copy_from_user(args, argp, sizeof(*args))) {
 		kfree(args);
 		return -EFAULT;
@@ -1375,6 +1378,7 @@
 					   sizeof(*range))) {
 				ret = -EFAULT;
 				kfree(range);
+				goto out;
 			}
 			/* compression requires us to start the IO */
 			if ((range->flags & BTRFS_DEFRAG_RANGE_COMPRESS)) {
diff -urN linux-2.6.34-rc3/fs/btrfs/locking.c linux-2.6.34-rc4/fs/btrfs/locking.c
--- linux-2.6.34-rc3/fs/btrfs/locking.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/locking.c	2010-04-13 02:19:01.833633319 +0000
@@ -16,7 +16,6 @@
  * Boston, MA 021110-1307, USA.
  */
 #include <linux/sched.h>
-#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/spinlock.h>
 #include <linux/page-flags.h>
diff -urN linux-2.6.34-rc3/fs/btrfs/ordered-data.c linux-2.6.34-rc4/fs/btrfs/ordered-data.c
--- linux-2.6.34-rc3/fs/btrfs/ordered-data.c	2010-04-13 02:18:56.474633045 +0000
+++ linux-2.6.34-rc4/fs/btrfs/ordered-data.c	2010-04-13 02:19:01.833633319 +0000
@@ -16,7 +16,6 @@
  * Boston, MA 021110-1307, USA.
  */
 
-#include <linux/gfp.h>
 #include <linux/slab.h>
 #include <linux/blkdev.h>
 #include <linux/writeback.h>
@@ -303,6 +302,7 @@
 				struct btrfs_ordered_extent *entry)
 {
 	struct btrfs_ordered_inode_tree *tree;
+	struct btrfs_root *root = BTRFS_I(inode)->root;
 	struct rb_node *node;
 
 	tree = &BTRFS_I(inode)->ordered_tree;
@@ -312,12 +312,13 @@
 	set_bit(BTRFS_ORDERED_COMPLETE, &entry->flags);
 
 	spin_lock(&BTRFS_I(inode)->accounting_lock);
+	WARN_ON(!BTRFS_I(inode)->outstanding_extents);
 	BTRFS_I(inode)->outstanding_extents--;
 	spin_unlock(&BTRFS_I(inode)->accounting_lock);
 	btrfs_unreserve_metadata_for_delalloc(BTRFS_I(inode)->root,
 					      inode, 1);
 
-	spin_lock(&BTRFS_I(inode)->root->fs_info->ordered_extent_lock);
+	spin_lock(&root->fs_info->ordered_extent_lock);
 	list_del_init(&entry->root_extent_list);
 
 	/*
@@ -329,7 +330,7 @@
 	    !mapping_tagged(inode->i_mapping, PAGECACHE_TAG_DIRTY)) {
 		list_del_init(&BTRFS_I(inode)->ordered_operations);
 	}
-	spin_unlock(&BTRFS_I(inode)->root->fs_info->ordered_extent_lock);
+	spin_unlock(&root->fs_info->ordered_extent_lock);
 
 	return 0;
 }
diff -urN linux-2.6.34-rc3/fs/btrfs/ref-cache.c linux-2.6.34-rc4/fs/btrfs/ref-cache.c
--- linux-2.6.34-rc3/fs/btrfs/ref-cache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/btrfs/ref-cache.c	2010-04-13 02:19:01.834633348 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/sort.h>
 #include "ctree.h"
 #include "ref-cache.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/relocation.c linux-2.6.34-rc4/fs/btrfs/relocation.c
--- linux-2.6.34-rc3/fs/btrfs/relocation.c	2010-04-13 02:18:56.475633042 +0000
+++ linux-2.6.34-rc4/fs/btrfs/relocation.c	2010-04-13 02:19:01.834633348 +0000
@@ -21,6 +21,7 @@
 #include <linux/writeback.h>
 #include <linux/blkdev.h>
 #include <linux/rbtree.h>
+#include <linux/slab.h>
 #include "ctree.h"
 #include "disk-io.h"
 #include "transaction.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/super.c linux-2.6.34-rc4/fs/btrfs/super.c
--- linux-2.6.34-rc3/fs/btrfs/super.c	2010-04-13 02:18:56.475633042 +0000
+++ linux-2.6.34-rc4/fs/btrfs/super.c	2010-04-13 02:19:01.835633287 +0000
@@ -38,6 +38,7 @@
 #include <linux/namei.h>
 #include <linux/miscdevice.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 #include "compat.h"
 #include "ctree.h"
 #include "disk-io.h"
@@ -64,10 +65,9 @@
 
 enum {
 	Opt_degraded, Opt_subvol, Opt_subvolid, Opt_device, Opt_nodatasum,
-	Opt_nodatacow, Opt_max_extent, Opt_max_inline, Opt_alloc_start,
-	Opt_nobarrier, Opt_ssd, Opt_nossd, Opt_ssd_spread, Opt_thread_pool,
-	Opt_noacl, Opt_compress, Opt_compress_force, Opt_notreelog, Opt_ratio,
-	Opt_flushoncommit,
+	Opt_nodatacow, Opt_max_inline, Opt_alloc_start, Opt_nobarrier, Opt_ssd,
+	Opt_nossd, Opt_ssd_spread, Opt_thread_pool, Opt_noacl, Opt_compress,
+	Opt_compress_force, Opt_notreelog, Opt_ratio, Opt_flushoncommit,
 	Opt_discard, Opt_err,
 };
 
@@ -79,7 +79,6 @@
 	{Opt_nodatasum, "nodatasum"},
 	{Opt_nodatacow, "nodatacow"},
 	{Opt_nobarrier, "nobarrier"},
-	{Opt_max_extent, "max_extent=%s"},
 	{Opt_max_inline, "max_inline=%s"},
 	{Opt_alloc_start, "alloc_start=%s"},
 	{Opt_thread_pool, "thread_pool=%d"},
@@ -188,18 +187,6 @@
 				       info->thread_pool_size);
 			}
 			break;
-		case Opt_max_extent:
-			num = match_strdup(&args[0]);
-			if (num) {
-				info->max_extent = memparse(num, NULL);
-				kfree(num);
-
-				info->max_extent = max_t(u64,
-					info->max_extent, root->sectorsize);
-				printk(KERN_INFO "btrfs: max_extent at %llu\n",
-				       (unsigned long long)info->max_extent);
-			}
-			break;
 		case Opt_max_inline:
 			num = match_strdup(&args[0]);
 			if (num) {
@@ -529,9 +516,6 @@
 		seq_puts(seq, ",nodatacow");
 	if (btrfs_test_opt(root, NOBARRIER))
 		seq_puts(seq, ",nobarrier");
-	if (info->max_extent != (u64)-1)
-		seq_printf(seq, ",max_extent=%llu",
-			   (unsigned long long)info->max_extent);
 	if (info->max_inline != 8192 * 1024)
 		seq_printf(seq, ",max_inline=%llu",
 			   (unsigned long long)info->max_inline);
diff -urN linux-2.6.34-rc3/fs/btrfs/transaction.c linux-2.6.34-rc4/fs/btrfs/transaction.c
--- linux-2.6.34-rc3/fs/btrfs/transaction.c	2010-04-13 02:18:56.476633011 +0000
+++ linux-2.6.34-rc4/fs/btrfs/transaction.c	2010-04-13 02:19:01.835633287 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/writeback.h>
 #include <linux/pagemap.h>
@@ -147,18 +148,13 @@
 		while (1) {
 			prepare_to_wait(&root->fs_info->transaction_wait, &wait,
 					TASK_UNINTERRUPTIBLE);
-			if (cur_trans->blocked) {
-				mutex_unlock(&root->fs_info->trans_mutex);
-				schedule();
-				mutex_lock(&root->fs_info->trans_mutex);
-				finish_wait(&root->fs_info->transaction_wait,
-					    &wait);
-			} else {
-				finish_wait(&root->fs_info->transaction_wait,
-					    &wait);
+			if (!cur_trans->blocked)
 				break;
-			}
+			mutex_unlock(&root->fs_info->trans_mutex);
+			schedule();
+			mutex_lock(&root->fs_info->trans_mutex);
 		}
+		finish_wait(&root->fs_info->transaction_wait, &wait);
 		put_transaction(cur_trans);
 	}
 }
@@ -760,10 +756,17 @@
 	struct btrfs_root_item *new_root_item;
 	struct btrfs_root *tree_root = fs_info->tree_root;
 	struct btrfs_root *root = pending->root;
+	struct btrfs_root *parent_root;
+	struct inode *parent_inode;
 	struct extent_buffer *tmp;
 	struct extent_buffer *old;
 	int ret;
 	u64 objectid;
+	int namelen;
+	u64 index = 0;
+
+	parent_inode = pending->dentry->d_parent->d_inode;
+	parent_root = BTRFS_I(parent_inode)->root;
 
 	new_root_item = kmalloc(sizeof(*new_root_item), GFP_NOFS);
 	if (!new_root_item) {
@@ -774,79 +777,59 @@
 	if (ret)
 		goto fail;
 
-	record_root_in_trans(trans, root);
-	btrfs_set_root_last_snapshot(&root->root_item, trans->transid);
-	memcpy(new_root_item, &root->root_item, sizeof(*new_root_item));
-
 	key.objectid = objectid;
 	/* record when the snapshot was created in key.offset */
 	key.offset = trans->transid;
 	btrfs_set_key_type(&key, BTRFS_ROOT_ITEM_KEY);
 
-	old = btrfs_lock_root_node(root);
-	btrfs_cow_block(trans, root, old, NULL, 0, &old);
-	btrfs_set_lock_blocking(old);
-
-	btrfs_copy_root(trans, root, old, &tmp, objectid);
-	btrfs_tree_unlock(old);
-	free_extent_buffer(old);
-
-	btrfs_set_root_node(new_root_item, tmp);
-	ret = btrfs_insert_root(trans, root->fs_info->tree_root, &key,
-				new_root_item);
-	btrfs_tree_unlock(tmp);
-	free_extent_buffer(tmp);
-	if (ret)
-		goto fail;
-
-	key.offset = (u64)-1;
 	memcpy(&pending->root_key, &key, sizeof(key));
-fail:
-	kfree(new_root_item);
-	return ret;
-}
-
-static noinline int finish_pending_snapshot(struct btrfs_fs_info *fs_info,
-				   struct btrfs_pending_snapshot *pending)
-{
-	int ret;
-	int namelen;
-	u64 index = 0;
-	struct btrfs_trans_handle *trans;
-	struct inode *parent_inode;
-	struct btrfs_root *parent_root;
-
-	parent_inode = pending->dentry->d_parent->d_inode;
-	parent_root = BTRFS_I(parent_inode)->root;
-	trans = btrfs_join_transaction(parent_root, 1);
+	pending->root_key.offset = (u64)-1;
 
+	record_root_in_trans(trans, parent_root);
 	/*
 	 * insert the directory item
 	 */
 	namelen = strlen(pending->name);
 	ret = btrfs_set_inode_index(parent_inode, &index);
+	BUG_ON(ret);
 	ret = btrfs_insert_dir_item(trans, parent_root,
 			    pending->name, namelen,
 			    parent_inode->i_ino,
 			    &pending->root_key, BTRFS_FT_DIR, index);
-
-	if (ret)
-		goto fail;
+	BUG_ON(ret);
 
 	btrfs_i_size_write(parent_inode, parent_inode->i_size + namelen * 2);
 	ret = btrfs_update_inode(trans, parent_root, parent_inode);
 	BUG_ON(ret);
 
+	record_root_in_trans(trans, root);
+	btrfs_set_root_last_snapshot(&root->root_item, trans->transid);
+	memcpy(new_root_item, &root->root_item, sizeof(*new_root_item));
+
+	old = btrfs_lock_root_node(root);
+	btrfs_cow_block(trans, root, old, NULL, 0, &old);
+	btrfs_set_lock_blocking(old);
+
+	btrfs_copy_root(trans, root, old, &tmp, objectid);
+	btrfs_tree_unlock(old);
+	free_extent_buffer(old);
+
+	btrfs_set_root_node(new_root_item, tmp);
+	ret = btrfs_insert_root(trans, root->fs_info->tree_root, &key,
+				new_root_item);
+	BUG_ON(ret);
+	btrfs_tree_unlock(tmp);
+	free_extent_buffer(tmp);
+
 	ret = btrfs_add_root_ref(trans, parent_root->fs_info->tree_root,
 				 pending->root_key.objectid,
 				 parent_root->root_key.objectid,
 				 parent_inode->i_ino, index, pending->name,
 				 namelen);
-
 	BUG_ON(ret);
 
 fail:
-	btrfs_end_transaction(trans, fs_info->fs_root);
+	kfree(new_root_item);
 	return ret;
 }
 
@@ -867,25 +850,6 @@
 	return 0;
 }
 
-static noinline int finish_pending_snapshots(struct btrfs_trans_handle *trans,
-					     struct btrfs_fs_info *fs_info)
-{
-	struct btrfs_pending_snapshot *pending;
-	struct list_head *head = &trans->transaction->pending_snapshots;
-	int ret;
-
-	while (!list_empty(head)) {
-		pending = list_entry(head->next,
-				     struct btrfs_pending_snapshot, list);
-		ret = finish_pending_snapshot(fs_info, pending);
-		BUG_ON(ret);
-		list_del(&pending->list);
-		kfree(pending->name);
-		kfree(pending);
-	}
-	return 0;
-}
-
 static void update_super_roots(struct btrfs_root *root)
 {
 	struct btrfs_root_item *root_item;
@@ -1097,9 +1061,6 @@
 
 	btrfs_finish_extent_commit(trans, root);
 
-	/* do the directory inserts of any pending snapshot creations */
-	finish_pending_snapshots(trans, root->fs_info);
-
 	mutex_lock(&root->fs_info->trans_mutex);
 
 	cur_trans->commit_done = 1;
diff -urN linux-2.6.34-rc3/fs/btrfs/tree-log.c linux-2.6.34-rc4/fs/btrfs/tree-log.c
--- linux-2.6.34-rc3/fs/btrfs/tree-log.c	2010-04-13 02:18:56.476633011 +0000
+++ linux-2.6.34-rc4/fs/btrfs/tree-log.c	2010-04-13 02:19:01.835633287 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "ctree.h"
 #include "transaction.h"
 #include "disk-io.h"
diff -urN linux-2.6.34-rc3/fs/btrfs/volumes.c linux-2.6.34-rc4/fs/btrfs/volumes.c
--- linux-2.6.34-rc3/fs/btrfs/volumes.c	2010-04-13 02:18:56.476633011 +0000
+++ linux-2.6.34-rc4/fs/btrfs/volumes.c	2010-04-13 02:19:01.836633652 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/sched.h>
 #include <linux/bio.h>
+#include <linux/slab.h>
 #include <linux/buffer_head.h>
 #include <linux/blkdev.h>
 #include <linux/random.h>
@@ -2198,9 +2199,9 @@
 		min_stripes = 2;
 	}
 	if (type & (BTRFS_BLOCK_GROUP_RAID1)) {
-		num_stripes = min_t(u64, 2, fs_devices->rw_devices);
-		if (num_stripes < 2)
+		if (fs_devices->rw_devices < 2)
 			return -ENOSPC;
+		num_stripes = 2;
 		min_stripes = 2;
 	}
 	if (type & (BTRFS_BLOCK_GROUP_RAID10)) {
@@ -2244,8 +2245,16 @@
 		do_div(calc_size, stripe_len);
 		calc_size *= stripe_len;
 	}
+
 	/* we don't want tiny stripes */
-	calc_size = max_t(u64, min_stripe_size, calc_size);
+	if (!looped)
+		calc_size = max_t(u64, min_stripe_size, calc_size);
+
+	/*
+	 * we're about to do_div by the stripe_len so lets make sure
+	 * we end up with something bigger than a stripe
+	 */
+	calc_size = max_t(u64, calc_size, stripe_len * 4);
 
 	do_div(calc_size, stripe_len);
 	calc_size *= stripe_len;
@@ -3389,6 +3398,8 @@
 	key.type = 0;
 again:
 	ret = btrfs_search_slot(NULL, root, &key, path, 0, 0);
+	if (ret < 0)
+		goto error;
 	while (1) {
 		leaf = path->nodes[0];
 		slot = path->slots[0];
diff -urN linux-2.6.34-rc3/fs/cachefiles/interface.c linux-2.6.34-rc4/fs/cachefiles/interface.c
--- linux-2.6.34-rc3/fs/cachefiles/interface.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cachefiles/interface.c	2010-04-13 02:19:01.837633513 +0000
@@ -9,6 +9,7 @@
  * 2 of the Licence, or (at your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/buffer_head.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/cachefiles/namei.c linux-2.6.34-rc4/fs/cachefiles/namei.c
--- linux-2.6.34-rc3/fs/cachefiles/namei.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cachefiles/namei.c	2010-04-13 02:19:01.837633513 +0000
@@ -19,6 +19,7 @@
 #include <linux/mount.h>
 #include <linux/namei.h>
 #include <linux/security.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 #define CACHEFILES_KEYBUF_SIZE 512
diff -urN linux-2.6.34-rc3/fs/cachefiles/rdwr.c linux-2.6.34-rc4/fs/cachefiles/rdwr.c
--- linux-2.6.34-rc3/fs/cachefiles/rdwr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cachefiles/rdwr.c	2010-04-13 02:19:01.837633513 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/mount.h>
+#include <linux/slab.h>
 #include <linux/file.h>
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/fs/cachefiles/xattr.c linux-2.6.34-rc4/fs/cachefiles/xattr.c
--- linux-2.6.34-rc3/fs/cachefiles/xattr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cachefiles/xattr.c	2010-04-13 02:19:01.837633513 +0000
@@ -16,6 +16,7 @@
 #include <linux/fsnotify.h>
 #include <linux/quotaops.h>
 #include <linux/xattr.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 static const char cachefiles_xattr_cache[] =
diff -urN linux-2.6.34-rc3/fs/ceph/addr.c linux-2.6.34-rc4/fs/ceph/addr.c
--- linux-2.6.34-rc3/fs/ceph/addr.c	2010-04-13 02:18:56.478633080 +0000
+++ linux-2.6.34-rc4/fs/ceph/addr.c	2010-04-13 02:19:01.838633488 +0000
@@ -5,6 +5,7 @@
 #include <linux/mm.h>
 #include <linux/pagemap.h>
 #include <linux/writeback.h>	/* generic_writepages */
+#include <linux/slab.h>
 #include <linux/pagevec.h>
 #include <linux/task_io_accounting_ops.h>
 
diff -urN linux-2.6.34-rc3/fs/ceph/auth.c linux-2.6.34-rc4/fs/ceph/auth.c
--- linux-2.6.34-rc3/fs/ceph/auth.c	2010-04-13 02:18:56.478633080 +0000
+++ linux-2.6.34-rc4/fs/ceph/auth.c	2010-04-13 02:19:01.838633488 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 
 #include "types.h"
diff -urN linux-2.6.34-rc3/fs/ceph/auth_none.c linux-2.6.34-rc4/fs/ceph/auth_none.c
--- linux-2.6.34-rc3/fs/ceph/auth_none.c	2010-04-13 02:18:56.478633080 +0000
+++ linux-2.6.34-rc4/fs/ceph/auth_none.c	2010-04-13 02:19:01.838633488 +0000
@@ -4,6 +4,7 @@
 #include <linux/err.h>
 #include <linux/module.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 
 #include "auth_none.h"
 #include "auth.h"
diff -urN linux-2.6.34-rc3/fs/ceph/auth_x.c linux-2.6.34-rc4/fs/ceph/auth_x.c
--- linux-2.6.34-rc3/fs/ceph/auth_x.c	2010-04-13 02:18:56.479571946 +0000
+++ linux-2.6.34-rc4/fs/ceph/auth_x.c	2010-04-13 02:19:01.839633463 +0000
@@ -4,6 +4,7 @@
 #include <linux/err.h>
 #include <linux/module.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 
 #include "auth_x.h"
 #include "auth_x_protocol.h"
diff -urN linux-2.6.34-rc3/fs/ceph/buffer.c linux-2.6.34-rc4/fs/ceph/buffer.c
--- linux-2.6.34-rc3/fs/ceph/buffer.c	2010-04-13 02:18:56.479571946 +0000
+++ linux-2.6.34-rc4/fs/ceph/buffer.c	2010-04-13 02:19:01.839633463 +0000
@@ -1,5 +1,8 @@
 
 #include "ceph_debug.h"
+
+#include <linux/slab.h>
+
 #include "buffer.h"
 #include "decode.h"
 
diff -urN linux-2.6.34-rc3/fs/ceph/caps.c linux-2.6.34-rc4/fs/ceph/caps.c
--- linux-2.6.34-rc3/fs/ceph/caps.c	2010-04-13 02:18:56.480570485 +0000
+++ linux-2.6.34-rc4/fs/ceph/caps.c	2010-04-13 02:19:01.840633540 +0000
@@ -3,6 +3,7 @@
 #include <linux/fs.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/wait.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/fs/ceph/crypto.c linux-2.6.34-rc4/fs/ceph/crypto.c
--- linux-2.6.34-rc3/fs/ceph/crypto.c	2010-04-13 02:18:56.482570473 +0000
+++ linux-2.6.34-rc4/fs/ceph/crypto.c	2010-04-13 02:19:01.842633439 +0000
@@ -3,6 +3,7 @@
 
 #include <linux/err.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <crypto/hash.h>
 
 #include "crypto.h"
diff -urN linux-2.6.34-rc3/fs/ceph/debugfs.c linux-2.6.34-rc4/fs/ceph/debugfs.c
--- linux-2.6.34-rc3/fs/ceph/debugfs.c	2010-04-13 02:18:56.482570473 +0000
+++ linux-2.6.34-rc4/fs/ceph/debugfs.c	2010-04-13 02:19:01.843633295 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/ctype.h>
 #include <linux/debugfs.h>
diff -urN linux-2.6.34-rc3/fs/ceph/dir.c linux-2.6.34-rc4/fs/ceph/dir.c
--- linux-2.6.34-rc3/fs/ceph/dir.c	2010-04-13 02:18:56.483633024 +0000
+++ linux-2.6.34-rc4/fs/ceph/dir.c	2010-04-13 02:19:01.843633295 +0000
@@ -3,6 +3,7 @@
 #include <linux/spinlock.h>
 #include <linux/fs_struct.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include "super.h"
diff -urN linux-2.6.34-rc3/fs/ceph/export.c linux-2.6.34-rc4/fs/ceph/export.c
--- linux-2.6.34-rc3/fs/ceph/export.c	2010-04-13 02:18:56.483633024 +0000
+++ linux-2.6.34-rc4/fs/ceph/export.c	2010-04-13 02:19:01.843633295 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/exportfs.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include "super.h"
diff -urN linux-2.6.34-rc3/fs/ceph/file.c linux-2.6.34-rc4/fs/ceph/file.c
--- linux-2.6.34-rc3/fs/ceph/file.c	2010-04-13 02:18:56.484633063 +0000
+++ linux-2.6.34-rc4/fs/ceph/file.c	2010-04-13 02:19:01.844633425 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/file.h>
 #include <linux/namei.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/fs/ceph/mds_client.c linux-2.6.34-rc4/fs/ceph/mds_client.c
--- linux-2.6.34-rc3/fs/ceph/mds_client.c	2010-04-13 02:18:56.486633054 +0000
+++ linux-2.6.34-rc4/fs/ceph/mds_client.c	2010-04-13 02:19:01.846633524 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 
 #include "mds_client.h"
diff -urN linux-2.6.34-rc3/fs/ceph/messenger.c linux-2.6.34-rc4/fs/ceph/messenger.c
--- linux-2.6.34-rc3/fs/ceph/messenger.c	2010-04-13 02:18:56.487633098 +0000
+++ linux-2.6.34-rc4/fs/ceph/messenger.c	2010-04-13 02:19:01.848633365 +0000
@@ -6,6 +6,7 @@
 #include <linux/inet.h>
 #include <linux/kthread.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <linux/string.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/fs/ceph/mon_client.c linux-2.6.34-rc4/fs/ceph/mon_client.c
--- linux-2.6.34-rc3/fs/ceph/mon_client.c	2010-04-13 02:18:56.488633023 +0000
+++ linux-2.6.34-rc4/fs/ceph/mon_client.c	2010-04-13 02:19:01.848633365 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/sched.h>
 
diff -urN linux-2.6.34-rc3/fs/ceph/osdmap.c linux-2.6.34-rc4/fs/ceph/osdmap.c
--- linux-2.6.34-rc3/fs/ceph/osdmap.c	2010-04-13 02:18:56.490570444 +0000
+++ linux-2.6.34-rc4/fs/ceph/osdmap.c	2010-04-13 02:19:01.851633207 +0000
@@ -1,4 +1,7 @@
 
+#include "ceph_debug.h"
+
+#include <linux/slab.h>
 #include <asm/div64.h>
 
 #include "super.h"
@@ -6,7 +9,6 @@
 #include "crush/hash.h"
 #include "crush/mapper.h"
 #include "decode.h"
-#include "ceph_debug.h"
 
 char *ceph_osdmap_state_str(char *str, int len, int state)
 {
diff -urN linux-2.6.34-rc3/fs/ceph/pagelist.c linux-2.6.34-rc4/fs/ceph/pagelist.c
--- linux-2.6.34-rc3/fs/ceph/pagelist.c	2010-04-13 02:18:56.490570444 +0000
+++ linux-2.6.34-rc4/fs/ceph/pagelist.c	2010-04-13 02:19:01.851633207 +0000
@@ -1,4 +1,5 @@
 
+#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/highmem.h>
 
diff -urN linux-2.6.34-rc3/fs/ceph/snap.c linux-2.6.34-rc4/fs/ceph/snap.c
--- linux-2.6.34-rc3/fs/ceph/snap.c	2010-04-13 02:18:56.490570444 +0000
+++ linux-2.6.34-rc4/fs/ceph/snap.c	2010-04-13 02:19:01.852633025 +0000
@@ -1,6 +1,7 @@
 #include "ceph_debug.h"
 
 #include <linux/sort.h>
+#include <linux/slab.h>
 
 #include "super.h"
 #include "decode.h"
diff -urN linux-2.6.34-rc3/fs/ceph/super.c linux-2.6.34-rc4/fs/ceph/super.c
--- linux-2.6.34-rc3/fs/ceph/super.c	2010-04-13 02:18:56.491633022 +0000
+++ linux-2.6.34-rc4/fs/ceph/super.c	2010-04-13 02:19:01.852633025 +0000
@@ -11,6 +11,7 @@
 #include <linux/rwsem.h>
 #include <linux/sched.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/statfs.h>
 #include <linux/string.h>
 #include <linux/version.h>
diff -urN linux-2.6.34-rc3/fs/ceph/super.h linux-2.6.34-rc4/fs/ceph/super.h
--- linux-2.6.34-rc3/fs/ceph/super.h	2010-04-13 02:18:56.491633022 +0000
+++ linux-2.6.34-rc4/fs/ceph/super.h	2010-04-13 02:19:01.853633053 +0000
@@ -12,6 +12,7 @@
 #include <linux/pagemap.h>
 #include <linux/wait.h>
 #include <linux/writeback.h>
+#include <linux/slab.h>
 
 #include "types.h"
 #include "messenger.h"
diff -urN linux-2.6.34-rc3/fs/ceph/xattr.c linux-2.6.34-rc4/fs/ceph/xattr.c
--- linux-2.6.34-rc3/fs/ceph/xattr.c	2010-04-13 02:18:56.492633058 +0000
+++ linux-2.6.34-rc4/fs/ceph/xattr.c	2010-04-13 02:19:01.853633053 +0000
@@ -3,6 +3,7 @@
 #include "decode.h"
 
 #include <linux/xattr.h>
+#include <linux/slab.h>
 
 static bool ceph_is_valid_xattr(const char *name)
 {
diff -urN linux-2.6.34-rc3/fs/cifs/cifs_dfs_ref.c linux-2.6.34-rc4/fs/cifs/cifs_dfs_ref.c
--- linux-2.6.34-rc3/fs/cifs/cifs_dfs_ref.c	2010-04-13 02:18:56.492633058 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifs_dfs_ref.c	2010-04-13 02:19:01.853633053 +0000
@@ -15,6 +15,7 @@
 #include <linux/dcache.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 #include <linux/vfs.h>
 #include <linux/fs.h>
 #include "cifsglob.h"
diff -urN linux-2.6.34-rc3/fs/cifs/cifs_spnego.c linux-2.6.34-rc4/fs/cifs/cifs_spnego.c
--- linux-2.6.34-rc3/fs/cifs/cifs_spnego.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifs_spnego.c	2010-04-13 02:19:01.854633025 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <keys/user-type.h>
 #include <linux/key-type.h>
diff -urN linux-2.6.34-rc3/fs/cifs/cifs_unicode.c linux-2.6.34-rc4/fs/cifs/cifs_unicode.c
--- linux-2.6.34-rc3/fs/cifs/cifs_unicode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifs_unicode.c	2010-04-13 02:19:01.854633025 +0000
@@ -19,6 +19,7 @@
  *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
  */
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include "cifs_unicode.h"
 #include "cifs_uniupr.h"
 #include "cifspdu.h"
diff -urN linux-2.6.34-rc3/fs/cifs/cifsacl.c linux-2.6.34-rc4/fs/cifs/cifsacl.c
--- linux-2.6.34-rc3/fs/cifs/cifsacl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifsacl.c	2010-04-13 02:19:01.854633025 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include "cifspdu.h"
 #include "cifsglob.h"
 #include "cifsacl.h"
diff -urN linux-2.6.34-rc3/fs/cifs/cifsencrypt.c linux-2.6.34-rc4/fs/cifs/cifsencrypt.c
--- linux-2.6.34-rc3/fs/cifs/cifsencrypt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifsencrypt.c	2010-04-13 02:19:01.854633025 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include "cifspdu.h"
 #include "cifsglob.h"
 #include "cifs_debug.h"
diff -urN linux-2.6.34-rc3/fs/cifs/cifsfs.c linux-2.6.34-rc4/fs/cifs/cifsfs.c
--- linux-2.6.34-rc3/fs/cifs/cifsfs.c	2010-04-13 02:18:56.492633058 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifsfs.c	2010-04-13 02:19:01.854633025 +0000
@@ -808,6 +808,7 @@
 	.release = cifs_close,
 	.fsync = cifs_fsync,
 	.flush = cifs_flush,
+	.mmap = cifs_file_mmap,
 	.splice_read = generic_file_splice_read,
 #ifdef CONFIG_CIFS_POSIX
 	.unlocked_ioctl  = cifs_ioctl,
diff -urN linux-2.6.34-rc3/fs/cifs/cifsglob.h linux-2.6.34-rc4/fs/cifs/cifsglob.h
--- linux-2.6.34-rc3/fs/cifs/cifsglob.h	2010-04-13 02:18:56.493633076 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifsglob.h	2010-04-13 02:19:01.854633025 +0000
@@ -18,6 +18,7 @@
  */
 #include <linux/in.h>
 #include <linux/in6.h>
+#include <linux/slab.h>
 #include <linux/slow-work.h>
 #include "cifs_fs_sb.h"
 #include "cifsacl.h"
diff -urN linux-2.6.34-rc3/fs/cifs/cifssmb.c linux-2.6.34-rc4/fs/cifs/cifssmb.c
--- linux-2.6.34-rc3/fs/cifs/cifssmb.c	2010-04-13 02:18:56.494633061 +0000
+++ linux-2.6.34-rc4/fs/cifs/cifssmb.c	2010-04-13 02:19:01.856633450 +0000
@@ -30,6 +30,7 @@
 #include <linux/fs.h>
 #include <linux/kernel.h>
 #include <linux/vfs.h>
+#include <linux/slab.h>
 #include <linux/posix_acl_xattr.h>
 #include <asm/uaccess.h>
 #include "cifspdu.h"
@@ -1430,6 +1431,8 @@
 	__u32 bytes_sent;
 	__u16 byte_count;
 
+	*nbytes = 0;
+
 	/* cFYI(1, ("write at %lld %d bytes", offset, count));*/
 	if (tcon->ses == NULL)
 		return -ECONNABORTED;
@@ -1512,11 +1515,18 @@
 	cifs_stats_inc(&tcon->num_writes);
 	if (rc) {
 		cFYI(1, ("Send error in write = %d", rc));
-		*nbytes = 0;
 	} else {
 		*nbytes = le16_to_cpu(pSMBr->CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes += le16_to_cpu(pSMBr->Count);
+
+		/*
+		 * Mask off high 16 bits when bytes written as returned by the
+		 * server is greater than bytes requested by the client. Some
+		 * OS/2 servers are known to set incorrect CountHigh values.
+		 */
+		if (*nbytes > count)
+			*nbytes &= 0xFFFF;
 	}
 
 	cifs_buf_release(pSMB);
@@ -1605,6 +1615,14 @@
 		*nbytes = le16_to_cpu(pSMBr->CountHigh);
 		*nbytes = (*nbytes) << 16;
 		*nbytes += le16_to_cpu(pSMBr->Count);
+
+		/*
+		 * Mask off high 16 bits when bytes written as returned by the
+		 * server is greater than bytes requested by the client. OS/2
+		 * servers are known to set incorrect CountHigh values.
+		 */
+		if (*nbytes > count)
+			*nbytes &= 0xFFFF;
 	}
 
 /*	cifs_small_buf_release(pSMB); */ /* Freed earlier now in SendReceive2 */
@@ -1793,8 +1811,21 @@
 		}
 		parm_data = (struct cifs_posix_lock *)
 			((char *)&pSMBr->hdr.Protocol + data_offset);
-		if (parm_data->lock_type == cpu_to_le16(CIFS_UNLCK))
+		if (parm_data->lock_type == __constant_cpu_to_le16(CIFS_UNLCK))
 			pLockData->fl_type = F_UNLCK;
+		else {
+			if (parm_data->lock_type ==
+					__constant_cpu_to_le16(CIFS_RDLCK))
+				pLockData->fl_type = F_RDLCK;
+			else if (parm_data->lock_type ==
+					__constant_cpu_to_le16(CIFS_WRLCK))
+				pLockData->fl_type = F_WRLCK;
+
+			pLockData->fl_start = parm_data->start;
+			pLockData->fl_end = parm_data->start +
+						parm_data->length - 1;
+			pLockData->fl_pid = parm_data->pid;
+		}
 	}
 
 plk_err_exit:
diff -urN linux-2.6.34-rc3/fs/cifs/connect.c linux-2.6.34-rc4/fs/cifs/connect.c
--- linux-2.6.34-rc3/fs/cifs/connect.c	2010-04-13 02:18:56.495633048 +0000
+++ linux-2.6.34-rc4/fs/cifs/connect.c	2010-04-13 02:19:01.857633358 +0000
@@ -23,6 +23,7 @@
 #include <linux/string.h>
 #include <linux/list.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/ctype.h>
 #include <linux/utsname.h>
diff -urN linux-2.6.34-rc3/fs/cifs/dns_resolve.c linux-2.6.34-rc4/fs/cifs/dns_resolve.c
--- linux-2.6.34-rc3/fs/cifs/dns_resolve.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/dns_resolve.c	2010-04-13 02:19:01.857633358 +0000
@@ -23,6 +23,7 @@
  *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
  */
 
+#include <linux/slab.h>
 #include <keys/user-type.h>
 #include "dns_resolve.h"
 #include "cifsglob.h"
diff -urN linux-2.6.34-rc3/fs/cifs/file.c linux-2.6.34-rc4/fs/cifs/file.c
--- linux-2.6.34-rc3/fs/cifs/file.c	2010-04-13 02:18:56.495633048 +0000
+++ linux-2.6.34-rc4/fs/cifs/file.c	2010-04-13 02:19:01.858633345 +0000
@@ -31,6 +31,7 @@
 #include <linux/task_io_accounting_ops.h>
 #include <linux/delay.h>
 #include <linux/mount.h>
+#include <linux/slab.h>
 #include <asm/div64.h>
 #include "cifsfs.h"
 #include "cifspdu.h"
@@ -838,8 +839,32 @@
 
 		} else {
 			/* if rc == ERR_SHARING_VIOLATION ? */
-			rc = 0;	/* do not change lock type to unlock
-				   since range in use */
+			rc = 0;
+
+			if (lockType & LOCKING_ANDX_SHARED_LOCK) {
+				pfLock->fl_type = F_WRLCK;
+			} else {
+				rc = CIFSSMBLock(xid, tcon, netfid, length,
+					pfLock->fl_start, 0, 1,
+					lockType | LOCKING_ANDX_SHARED_LOCK,
+					0 /* wait flag */);
+				if (rc == 0) {
+					rc = CIFSSMBLock(xid, tcon, netfid,
+						length, pfLock->fl_start, 1, 0,
+						lockType |
+						LOCKING_ANDX_SHARED_LOCK,
+						0 /* wait flag */);
+					pfLock->fl_type = F_RDLCK;
+					if (rc != 0)
+						cERROR(1, ("Error unlocking "
+						"previously locked range %d "
+						"during test of lock", rc));
+					rc = 0;
+				} else {
+					pfLock->fl_type = F_WRLCK;
+					rc = 0;
+				}
+			}
 		}
 
 		FreeXid(xid);
diff -urN linux-2.6.34-rc3/fs/cifs/inode.c linux-2.6.34-rc4/fs/cifs/inode.c
--- linux-2.6.34-rc3/fs/cifs/inode.c	2010-04-13 02:18:56.496633111 +0000
+++ linux-2.6.34-rc4/fs/cifs/inode.c	2010-04-13 02:19:01.858633345 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/fs.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <asm/div64.h>
 #include "cifsfs.h"
diff -urN linux-2.6.34-rc3/fs/cifs/link.c linux-2.6.34-rc4/fs/cifs/link.c
--- linux-2.6.34-rc3/fs/cifs/link.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/link.c	2010-04-13 02:19:01.859633559 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/fs.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include "cifsfs.h"
 #include "cifspdu.h"
diff -urN linux-2.6.34-rc3/fs/cifs/readdir.c linux-2.6.34-rc4/fs/cifs/readdir.c
--- linux-2.6.34-rc3/fs/cifs/readdir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/readdir.c	2010-04-13 02:19:01.859633559 +0000
@@ -22,6 +22,7 @@
  */
 #include <linux/fs.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/stat.h>
 #include "cifspdu.h"
 #include "cifsglob.h"
diff -urN linux-2.6.34-rc3/fs/cifs/sess.c linux-2.6.34-rc4/fs/cifs/sess.c
--- linux-2.6.34-rc3/fs/cifs/sess.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/sess.c	2010-04-13 02:19:01.859633559 +0000
@@ -29,6 +29,7 @@
 #include "ntlmssp.h"
 #include "nterr.h"
 #include <linux/utsname.h>
+#include <linux/slab.h>
 #include "cifs_spnego.h"
 
 extern void SMBNTencrypt(unsigned char *passwd, unsigned char *c8,
diff -urN linux-2.6.34-rc3/fs/cifs/smbencrypt.c linux-2.6.34-rc4/fs/cifs/smbencrypt.c
--- linux-2.6.34-rc3/fs/cifs/smbencrypt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/smbencrypt.c	2010-04-13 02:19:01.859633559 +0000
@@ -24,6 +24,7 @@
 */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/string.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/fs/cifs/transport.c linux-2.6.34-rc4/fs/cifs/transport.c
--- linux-2.6.34-rc3/fs/cifs/transport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/cifs/transport.c	2010-04-13 02:19:01.859633559 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/fs.h>
 #include <linux/list.h>
+#include <linux/gfp.h>
 #include <linux/wait.h>
 #include <linux/net.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/fs/cifs/xattr.c linux-2.6.34-rc4/fs/cifs/xattr.c
--- linux-2.6.34-rc3/fs/cifs/xattr.c	2010-04-13 02:18:56.496633111 +0000
+++ linux-2.6.34-rc4/fs/cifs/xattr.c	2010-04-13 02:19:01.859633559 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/fs.h>
 #include <linux/posix_acl_xattr.h>
+#include <linux/slab.h>
 #include "cifsfs.h"
 #include "cifspdu.h"
 #include "cifsglob.h"
diff -urN linux-2.6.34-rc3/fs/coda/dir.c linux-2.6.34-rc4/fs/coda/dir.c
--- linux-2.6.34-rc3/fs/coda/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/coda/dir.c	2010-04-13 02:19:01.860633329 +0000
@@ -12,6 +12,7 @@
 #include <linux/kernel.h>
 #include <linux/time.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/file.h>
 #include <linux/stat.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/fs/coda/file.c linux-2.6.34-rc4/fs/coda/file.c
--- linux-2.6.34-rc3/fs/coda/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/coda/file.c	2010-04-13 02:19:01.860633329 +0000
@@ -17,6 +17,7 @@
 #include <linux/errno.h>
 #include <linux/smp_lock.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #include <linux/coda.h>
diff -urN linux-2.6.34-rc3/fs/coda/inode.c linux-2.6.34-rc4/fs/coda/inode.c
--- linux-2.6.34-rc3/fs/coda/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/coda/inode.c	2010-04-13 02:19:01.860633329 +0000
@@ -18,6 +18,7 @@
 #include <linux/smp_lock.h>
 #include <linux/file.h>
 #include <linux/vfs.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/coda/upcall.c linux-2.6.34-rc4/fs/coda/upcall.c
--- linux-2.6.34-rc3/fs/coda/upcall.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/coda/upcall.c	2010-04-13 02:19:01.860633329 +0000
@@ -26,6 +26,7 @@
 #include <linux/stat.h>
 #include <linux/errno.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/vmalloc.h>
 #include <linux/vfs.h>
diff -urN linux-2.6.34-rc3/fs/compat.c linux-2.6.34-rc4/fs/compat.c
--- linux-2.6.34-rc3/fs/compat.c	2010-04-13 02:18:56.496633111 +0000
+++ linux-2.6.34-rc4/fs/compat.c	2010-04-13 02:19:01.860633329 +0000
@@ -49,6 +49,7 @@
 #include <linux/mm.h>
 #include <linux/eventpoll.h>
 #include <linux/fs_struct.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/mmu_context.h>
diff -urN linux-2.6.34-rc3/fs/compat_ioctl.c linux-2.6.34-rc4/fs/compat_ioctl.c
--- linux-2.6.34-rc3/fs/compat_ioctl.c	2010-04-13 02:18:56.496633111 +0000
+++ linux-2.6.34-rc4/fs/compat_ioctl.c	2010-04-13 02:19:01.861633421 +0000
@@ -23,7 +23,6 @@
 #include <linux/ioctl.h>
 #include <linux/if.h>
 #include <linux/if_bridge.h>
-#include <linux/slab.h>
 #include <linux/raid/md_u.h>
 #include <linux/kd.h>
 #include <linux/route.h>
@@ -60,6 +59,7 @@
 #include <linux/i2c.h>
 #include <linux/i2c-dev.h>
 #include <linux/atalk.h>
+#include <linux/gfp.h>
 
 #include <net/bluetooth/bluetooth.h>
 #include <net/bluetooth/hci.h>
diff -urN linux-2.6.34-rc3/fs/configfs/inode.c linux-2.6.34-rc4/fs/configfs/inode.c
--- linux-2.6.34-rc3/fs/configfs/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/configfs/inode.c	2010-04-13 02:19:01.861633421 +0000
@@ -34,6 +34,7 @@
 #include <linux/capability.h>
 #include <linux/sched.h>
 #include <linux/lockdep.h>
+#include <linux/slab.h>
 
 #include <linux/configfs.h>
 #include "configfs_internal.h"
diff -urN linux-2.6.34-rc3/fs/configfs/mount.c linux-2.6.34-rc4/fs/configfs/mount.c
--- linux-2.6.34-rc3/fs/configfs/mount.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/configfs/mount.c	2010-04-13 02:19:01.861633421 +0000
@@ -29,6 +29,7 @@
 #include <linux/mount.h>
 #include <linux/pagemap.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <linux/configfs.h>
 #include "configfs_internal.h"
diff -urN linux-2.6.34-rc3/fs/configfs/symlink.c linux-2.6.34-rc4/fs/configfs/symlink.c
--- linux-2.6.34-rc3/fs/configfs/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/configfs/symlink.c	2010-04-13 02:19:01.861633421 +0000
@@ -27,6 +27,7 @@
 #include <linux/fs.h>
 #include <linux/module.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 
 #include <linux/configfs.h>
 #include "configfs_internal.h"
diff -urN linux-2.6.34-rc3/fs/debugfs/inode.c linux-2.6.34-rc4/fs/debugfs/inode.c
--- linux-2.6.34-rc3/fs/debugfs/inode.c	2010-04-13 02:18:56.497633078 +0000
+++ linux-2.6.34-rc4/fs/debugfs/inode.c	2010-04-13 02:19:01.862633383 +0000
@@ -27,6 +27,7 @@
 #include <linux/fsnotify.h>
 #include <linux/string.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 
 static struct vfsmount *debugfs_mount;
 static int debugfs_mount_count;
diff -urN linux-2.6.34-rc3/fs/devpts/inode.c linux-2.6.34-rc4/fs/devpts/inode.c
--- linux-2.6.34-rc3/fs/devpts/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/devpts/inode.c	2010-04-13 02:19:01.862633383 +0000
@@ -15,6 +15,7 @@
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/tty.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/fs/dlm/config.c linux-2.6.34-rc4/fs/dlm/config.c
--- linux-2.6.34-rc3/fs/dlm/config.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/dlm/config.c	2010-04-13 02:19:01.862633383 +0000
@@ -14,6 +14,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/configfs.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <linux/in6.h>
 #include <net/ipv6.h>
diff -urN linux-2.6.34-rc3/fs/dlm/debug_fs.c linux-2.6.34-rc4/fs/dlm/debug_fs.c
--- linux-2.6.34-rc3/fs/dlm/debug_fs.c	2010-04-13 02:18:56.497633078 +0000
+++ linux-2.6.34-rc4/fs/dlm/debug_fs.c	2010-04-13 02:19:01.862633383 +0000
@@ -15,6 +15,7 @@
 #include <linux/module.h>
 #include <linux/ctype.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include "dlm_internal.h"
 #include "lock.h"
diff -urN linux-2.6.34-rc3/fs/dlm/lock.c linux-2.6.34-rc4/fs/dlm/lock.c
--- linux-2.6.34-rc3/fs/dlm/lock.c	2010-04-13 02:18:56.498633057 +0000
+++ linux-2.6.34-rc4/fs/dlm/lock.c	2010-04-13 02:19:01.863633519 +0000
@@ -56,6 +56,7 @@
    L: receive_xxxx_reply()     <-  R: send_xxxx_reply()
 */
 #include <linux/types.h>
+#include <linux/slab.h>
 #include "dlm_internal.h"
 #include <linux/dlm_device.h>
 #include "memory.h"
diff -urN linux-2.6.34-rc3/fs/dlm/lowcomms.c linux-2.6.34-rc4/fs/dlm/lowcomms.c
--- linux-2.6.34-rc3/fs/dlm/lowcomms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/dlm/lowcomms.c	2010-04-13 02:19:01.864633626 +0000
@@ -51,6 +51,7 @@
 #include <linux/file.h>
 #include <linux/mutex.h>
 #include <linux/sctp.h>
+#include <linux/slab.h>
 #include <net/sctp/user.h>
 #include <net/ipv6.h>
 
diff -urN linux-2.6.34-rc3/fs/dlm/netlink.c linux-2.6.34-rc4/fs/dlm/netlink.c
--- linux-2.6.34-rc3/fs/dlm/netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/dlm/netlink.c	2010-04-13 02:19:01.864633626 +0000
@@ -9,6 +9,7 @@
 #include <net/genetlink.h>
 #include <linux/dlm.h>
 #include <linux/dlm_netlink.h>
+#include <linux/gfp.h>
 
 #include "dlm_internal.h"
 
diff -urN linux-2.6.34-rc3/fs/dlm/plock.c linux-2.6.34-rc4/fs/dlm/plock.c
--- linux-2.6.34-rc3/fs/dlm/plock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/dlm/plock.c	2010-04-13 02:19:01.864633626 +0000
@@ -11,6 +11,7 @@
 #include <linux/poll.h>
 #include <linux/dlm.h>
 #include <linux/dlm_plock.h>
+#include <linux/slab.h>
 
 #include "dlm_internal.h"
 #include "lockspace.h"
diff -urN linux-2.6.34-rc3/fs/dlm/user.c linux-2.6.34-rc4/fs/dlm/user.c
--- linux-2.6.34-rc3/fs/dlm/user.c	2010-04-13 02:18:56.499571776 +0000
+++ linux-2.6.34-rc4/fs/dlm/user.c	2010-04-13 02:19:01.864633626 +0000
@@ -17,6 +17,7 @@
 #include <linux/spinlock.h>
 #include <linux/dlm.h>
 #include <linux/dlm_device.h>
+#include <linux/slab.h>
 
 #include "dlm_internal.h"
 #include "lockspace.h"
diff -urN linux-2.6.34-rc3/fs/ecryptfs/crypto.c linux-2.6.34-rc4/fs/ecryptfs/crypto.c
--- linux-2.6.34-rc3/fs/ecryptfs/crypto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/crypto.c	2010-04-13 02:19:01.864633626 +0000
@@ -33,6 +33,7 @@
 #include <linux/crypto.h>
 #include <linux/file.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "ecryptfs_kernel.h"
 
diff -urN linux-2.6.34-rc3/fs/ecryptfs/dentry.c linux-2.6.34-rc4/fs/ecryptfs/dentry.c
--- linux-2.6.34-rc3/fs/ecryptfs/dentry.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/dentry.c	2010-04-13 02:19:01.865633306 +0000
@@ -26,6 +26,7 @@
 #include <linux/namei.h>
 #include <linux/mount.h>
 #include <linux/fs_stack.h>
+#include <linux/slab.h>
 #include "ecryptfs_kernel.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ecryptfs/file.c linux-2.6.34-rc4/fs/ecryptfs/file.c
--- linux-2.6.34-rc3/fs/ecryptfs/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/file.c	2010-04-13 02:19:01.865633306 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/file.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/pagemap.h>
 #include <linux/security.h>
diff -urN linux-2.6.34-rc3/fs/ecryptfs/inode.c linux-2.6.34-rc4/fs/ecryptfs/inode.c
--- linux-2.6.34-rc3/fs/ecryptfs/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/inode.c	2010-04-13 02:19:01.865633306 +0000
@@ -31,6 +31,7 @@
 #include <linux/mount.h>
 #include <linux/crypto.h>
 #include <linux/fs_stack.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "ecryptfs_kernel.h"
 
diff -urN linux-2.6.34-rc3/fs/ecryptfs/keystore.c linux-2.6.34-rc4/fs/ecryptfs/keystore.c
--- linux-2.6.34-rc3/fs/ecryptfs/keystore.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/keystore.c	2010-04-13 02:19:01.865633306 +0000
@@ -32,6 +32,7 @@
 #include <linux/random.h>
 #include <linux/crypto.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include "ecryptfs_kernel.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ecryptfs/kthread.c linux-2.6.34-rc4/fs/ecryptfs/kthread.c
--- linux-2.6.34-rc3/fs/ecryptfs/kthread.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/kthread.c	2010-04-13 02:19:01.865633306 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/kthread.h>
 #include <linux/freezer.h>
+#include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/mount.h>
 #include "ecryptfs_kernel.h"
diff -urN linux-2.6.34-rc3/fs/ecryptfs/main.c linux-2.6.34-rc4/fs/ecryptfs/main.c
--- linux-2.6.34-rc3/fs/ecryptfs/main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/main.c	2010-04-13 02:19:01.866633430 +0000
@@ -35,6 +35,7 @@
 #include <linux/key.h>
 #include <linux/parser.h>
 #include <linux/fs_stack.h>
+#include <linux/slab.h>
 #include "ecryptfs_kernel.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ecryptfs/messaging.c linux-2.6.34-rc4/fs/ecryptfs/messaging.c
--- linux-2.6.34-rc3/fs/ecryptfs/messaging.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/messaging.c	2010-04-13 02:19:01.866633430 +0000
@@ -20,6 +20,7 @@
  * 02111-1307, USA.
  */
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/user_namespace.h>
 #include <linux/nsproxy.h>
 #include "ecryptfs_kernel.h"
diff -urN linux-2.6.34-rc3/fs/ecryptfs/miscdev.c linux-2.6.34-rc4/fs/ecryptfs/miscdev.c
--- linux-2.6.34-rc3/fs/ecryptfs/miscdev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/miscdev.c	2010-04-13 02:19:01.866633430 +0000
@@ -24,6 +24,7 @@
 #include <linux/random.h>
 #include <linux/miscdevice.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/module.h>
 #include "ecryptfs_kernel.h"
diff -urN linux-2.6.34-rc3/fs/ecryptfs/mmap.c linux-2.6.34-rc4/fs/ecryptfs/mmap.c
--- linux-2.6.34-rc3/fs/ecryptfs/mmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/mmap.c	2010-04-13 02:19:01.866633430 +0000
@@ -32,6 +32,7 @@
 #include <linux/file.h>
 #include <linux/crypto.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "ecryptfs_kernel.h"
 
diff -urN linux-2.6.34-rc3/fs/ecryptfs/super.c linux-2.6.34-rc4/fs/ecryptfs/super.c
--- linux-2.6.34-rc3/fs/ecryptfs/super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ecryptfs/super.c	2010-04-13 02:19:01.866633430 +0000
@@ -26,6 +26,7 @@
 #include <linux/fs.h>
 #include <linux/mount.h>
 #include <linux/key.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/smp_lock.h>
 #include <linux/file.h>
diff -urN linux-2.6.34-rc3/fs/eventfd.c linux-2.6.34-rc4/fs/eventfd.c
--- linux-2.6.34-rc3/fs/eventfd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/eventfd.c	2010-04-13 02:19:01.866633430 +0000
@@ -11,6 +11,7 @@
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/spinlock.h>
 #include <linux/anon_inodes.h>
diff -urN linux-2.6.34-rc3/fs/exofs/inode.c linux-2.6.34-rc4/fs/exofs/inode.c
--- linux-2.6.34-rc3/fs/exofs/inode.c	2010-04-13 02:18:56.500570528 +0000
+++ linux-2.6.34-rc4/fs/exofs/inode.c	2010-04-13 02:19:01.867633447 +0000
@@ -31,6 +31,7 @@
  * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
  */
 
+#include <linux/slab.h>
 #include <linux/writeback.h>
 #include <linux/buffer_head.h>
 #include <scsi/scsi_device.h>
diff -urN linux-2.6.34-rc3/fs/exofs/ios.c linux-2.6.34-rc4/fs/exofs/ios.c
--- linux-2.6.34-rc3/fs/exofs/ios.c	2010-04-13 02:18:56.500570528 +0000
+++ linux-2.6.34-rc4/fs/exofs/ios.c	2010-04-13 02:19:01.868633544 +0000
@@ -22,6 +22,7 @@
  * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
  */
 
+#include <linux/slab.h>
 #include <scsi/scsi_device.h>
 #include <asm/div64.h>
 
diff -urN linux-2.6.34-rc3/fs/exofs/super.c linux-2.6.34-rc4/fs/exofs/super.c
--- linux-2.6.34-rc3/fs/exofs/super.c	2010-04-13 02:18:56.501570390 +0000
+++ linux-2.6.34-rc4/fs/exofs/super.c	2010-04-13 02:19:01.868633544 +0000
@@ -37,6 +37,7 @@
 #include <linux/vfs.h>
 #include <linux/random.h>
 #include <linux/exportfs.h>
+#include <linux/slab.h>
 
 #include "exofs.h"
 
diff -urN linux-2.6.34-rc3/fs/ext2/balloc.c linux-2.6.34-rc4/fs/ext2/balloc.c
--- linux-2.6.34-rc3/fs/ext2/balloc.c	2010-04-13 02:18:56.501570390 +0000
+++ linux-2.6.34-rc4/fs/ext2/balloc.c	2010-04-13 02:19:01.868633544 +0000
@@ -13,6 +13,7 @@
 
 #include "ext2.h"
 #include <linux/quotaops.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/buffer_head.h>
 #include <linux/capability.h>
diff -urN linux-2.6.34-rc3/fs/ext2/symlink.c linux-2.6.34-rc4/fs/ext2/symlink.c
--- linux-2.6.34-rc3/fs/ext2/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ext2/symlink.c	2010-04-13 02:19:01.870633459 +0000
@@ -32,6 +32,7 @@
 	.readlink	= generic_readlink,
 	.follow_link	= page_follow_link_light,
 	.put_link	= page_put_link,
+	.setattr	= ext2_setattr,
 #ifdef CONFIG_EXT2_FS_XATTR
 	.setxattr	= generic_setxattr,
 	.getxattr	= generic_getxattr,
@@ -43,6 +44,7 @@
 const struct inode_operations ext2_fast_symlink_inode_operations = {
 	.readlink	= generic_readlink,
 	.follow_link	= ext2_follow_link,
+	.setattr	= ext2_setattr,
 #ifdef CONFIG_EXT2_FS_XATTR
 	.setxattr	= generic_setxattr,
 	.getxattr	= generic_getxattr,
diff -urN linux-2.6.34-rc3/fs/ext2/xattr_security.c linux-2.6.34-rc4/fs/ext2/xattr_security.c
--- linux-2.6.34-rc3/fs/ext2/xattr_security.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ext2/xattr_security.c	2010-04-13 02:19:01.870633459 +0000
@@ -4,6 +4,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fs.h>
 #include <linux/ext2_fs.h>
diff -urN linux-2.6.34-rc3/fs/ext3/balloc.c linux-2.6.34-rc4/fs/ext3/balloc.c
--- linux-2.6.34-rc3/fs/ext3/balloc.c	2010-04-13 02:18:56.502633089 +0000
+++ linux-2.6.34-rc4/fs/ext3/balloc.c	2010-04-13 02:19:01.870633459 +0000
@@ -14,6 +14,7 @@
 #include <linux/time.h>
 #include <linux/capability.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/jbd.h>
 #include <linux/ext3_fs.h>
 #include <linux/ext3_jbd.h>
diff -urN linux-2.6.34-rc3/fs/ext3/symlink.c linux-2.6.34-rc4/fs/ext3/symlink.c
--- linux-2.6.34-rc3/fs/ext3/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ext3/symlink.c	2010-04-13 02:19:01.872633321 +0000
@@ -34,6 +34,7 @@
 	.readlink	= generic_readlink,
 	.follow_link	= page_follow_link_light,
 	.put_link	= page_put_link,
+	.setattr	= ext3_setattr,
 #ifdef CONFIG_EXT3_FS_XATTR
 	.setxattr	= generic_setxattr,
 	.getxattr	= generic_getxattr,
@@ -45,6 +46,7 @@
 const struct inode_operations ext3_fast_symlink_inode_operations = {
 	.readlink	= generic_readlink,
 	.follow_link	= ext3_follow_link,
+	.setattr	= ext3_setattr,
 #ifdef CONFIG_EXT3_FS_XATTR
 	.setxattr	= generic_setxattr,
 	.getxattr	= generic_getxattr,
diff -urN linux-2.6.34-rc3/fs/ext3/xattr_security.c linux-2.6.34-rc4/fs/ext3/xattr_security.c
--- linux-2.6.34-rc3/fs/ext3/xattr_security.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ext3/xattr_security.c	2010-04-13 02:19:01.873633364 +0000
@@ -4,6 +4,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/fs.h>
 #include <linux/ext3_jbd.h>
diff -urN linux-2.6.34-rc3/fs/ext4/block_validity.c linux-2.6.34-rc4/fs/ext4/block_validity.c
--- linux-2.6.34-rc3/fs/ext4/block_validity.c	2010-04-13 02:18:56.505633088 +0000
+++ linux-2.6.34-rc4/fs/ext4/block_validity.c	2010-04-13 02:19:01.873633364 +0000
@@ -18,6 +18,7 @@
 #include <linux/pagemap.h>
 #include <linux/blkdev.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include "ext4.h"
 
 struct ext4_system_zone {
diff -urN linux-2.6.34-rc3/fs/ext4/inode.c linux-2.6.34-rc4/fs/ext4/inode.c
--- linux-2.6.34-rc3/fs/ext4/inode.c	2010-04-13 02:18:56.508633036 +0000
+++ linux-2.6.34-rc4/fs/ext4/inode.c	2010-04-13 02:19:01.877633370 +0000
@@ -39,6 +39,7 @@
 #include <linux/bio.h>
 #include <linux/workqueue.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "ext4_jbd2.h"
 #include "xattr.h"
diff -urN linux-2.6.34-rc3/fs/ext4/mballoc.c linux-2.6.34-rc4/fs/ext4/mballoc.c
--- linux-2.6.34-rc3/fs/ext4/mballoc.c	2010-04-13 02:18:56.509571657 +0000
+++ linux-2.6.34-rc4/fs/ext4/mballoc.c	2010-04-13 02:19:01.878633584 +0000
@@ -23,6 +23,7 @@
 
 #include "mballoc.h"
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <trace/events/ext4.h>
 
 /*
diff -urN linux-2.6.34-rc3/fs/ext4/migrate.c linux-2.6.34-rc4/fs/ext4/migrate.c
--- linux-2.6.34-rc3/fs/ext4/migrate.c	2010-04-13 02:18:56.509571657 +0000
+++ linux-2.6.34-rc4/fs/ext4/migrate.c	2010-04-13 02:19:01.878633584 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include "ext4_jbd2.h"
 #include "ext4_extents.h"
 
diff -urN linux-2.6.34-rc3/fs/ext4/move_extent.c linux-2.6.34-rc4/fs/ext4/move_extent.c
--- linux-2.6.34-rc3/fs/ext4/move_extent.c	2010-04-13 02:18:56.510570441 +0000
+++ linux-2.6.34-rc4/fs/ext4/move_extent.c	2010-04-13 02:19:01.879633372 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/fs.h>
 #include <linux/quotaops.h>
+#include <linux/slab.h>
 #include "ext4_jbd2.h"
 #include "ext4_extents.h"
 #include "ext4.h"
diff -urN linux-2.6.34-rc3/fs/ext4/xattr_security.c linux-2.6.34-rc4/fs/ext4/xattr_security.c
--- linux-2.6.34-rc3/fs/ext4/xattr_security.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ext4/xattr_security.c	2010-04-13 02:19:01.881633360 +0000
@@ -7,6 +7,7 @@
 #include <linux/string.h>
 #include <linux/fs.h>
 #include <linux/security.h>
+#include <linux/slab.h>
 #include "ext4_jbd2.h"
 #include "ext4.h"
 #include "xattr.h"
diff -urN linux-2.6.34-rc3/fs/fat/cache.c linux-2.6.34-rc4/fs/fat/cache.c
--- linux-2.6.34-rc3/fs/fat/cache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/fat/cache.c	2010-04-13 02:19:01.881633360 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/buffer_head.h>
 #include "fat.h"
 
diff -urN linux-2.6.34-rc3/fs/fat/namei_vfat.c linux-2.6.34-rc4/fs/fat/namei_vfat.c
--- linux-2.6.34-rc3/fs/fat/namei_vfat.c	2010-04-13 02:18:56.512633080 +0000
+++ linux-2.6.34-rc4/fs/fat/namei_vfat.c	2010-04-13 02:19:01.882633334 +0000
@@ -309,7 +309,7 @@
 {
 	struct fat_mount_options *opts = &MSDOS_SB(dir->i_sb)->options;
 	wchar_t *ip, *ext_start, *end, *name_start;
-	unsigned char base[9], ext[4], buf[8], *p;
+	unsigned char base[9], ext[4], buf[5], *p;
 	unsigned char charbuf[NLS_MAX_CHARSET_SIZE];
 	int chl, chi;
 	int sz = 0, extlen, baselen, i, numtail_baselen, numtail2_baselen;
@@ -467,7 +467,7 @@
 			return 0;
 	}
 
-	i = jiffies & 0xffff;
+	i = jiffies;
 	sz = (jiffies >> 16) & 0x7;
 	if (baselen > 2) {
 		baselen = numtail2_baselen;
@@ -476,7 +476,7 @@
 	name_res[baselen + 4] = '~';
 	name_res[baselen + 5] = '1' + sz;
 	while (1) {
-		sprintf(buf, "%04X", i);
+		snprintf(buf, sizeof(buf), "%04X", i & 0xffff);
 		memcpy(&name_res[baselen], buf, 4);
 		if (vfat_find_form(dir, name_res) < 0)
 			break;
diff -urN linux-2.6.34-rc3/fs/fifo.c linux-2.6.34-rc4/fs/fifo.c
--- linux-2.6.34-rc3/fs/fifo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/fifo.c	2010-04-13 02:19:01.882633334 +0000
@@ -10,7 +10,6 @@
  */
 
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/pipe_fs_i.h>
diff -urN linux-2.6.34-rc3/fs/filesystems.c linux-2.6.34-rc4/fs/filesystems.c
--- linux-2.6.34-rc3/fs/filesystems.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/filesystems.c	2010-04-13 02:19:01.882633334 +0000
@@ -10,10 +10,10 @@
 #include <linux/fs.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
-#include <linux/slab.h>
 #include <linux/kmod.h>
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 /*
diff -urN linux-2.6.34-rc3/fs/freevxfs/vxfs_subr.c linux-2.6.34-rc4/fs/freevxfs/vxfs_subr.c
--- linux-2.6.34-rc3/fs/freevxfs/vxfs_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/freevxfs/vxfs_subr.c	2010-04-13 02:19:01.882633334 +0000
@@ -33,7 +33,6 @@
 #include <linux/fs.h>
 #include <linux/buffer_head.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 
 #include "vxfs_extern.h"
diff -urN linux-2.6.34-rc3/fs/fs-writeback.c linux-2.6.34-rc4/fs/fs-writeback.c
--- linux-2.6.34-rc3/fs/fs-writeback.c	2010-04-13 02:18:56.513633047 +0000
+++ linux-2.6.34-rc4/fs/fs-writeback.c	2010-04-13 02:19:01.883633419 +0000
@@ -16,6 +16,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/fs.h>
 #include <linux/mm.h>
@@ -553,108 +554,85 @@
 	return ret;
 }
 
-static void unpin_sb_for_writeback(struct super_block **psb)
+static void unpin_sb_for_writeback(struct super_block *sb)
 {
-	struct super_block *sb = *psb;
-
-	if (sb) {
-		up_read(&sb->s_umount);
-		put_super(sb);
-		*psb = NULL;
-	}
+	up_read(&sb->s_umount);
+	put_super(sb);
 }
 
+enum sb_pin_state {
+	SB_PINNED,
+	SB_NOT_PINNED,
+	SB_PIN_FAILED
+};
+
 /*
  * For WB_SYNC_NONE writeback, the caller does not have the sb pinned
  * before calling writeback. So make sure that we do pin it, so it doesn't
  * go away while we are writing inodes from it.
- *
- * Returns 0 if the super was successfully pinned (or pinning wasn't needed),
- * 1 if we failed.
  */
-static int pin_sb_for_writeback(struct writeback_control *wbc,
-				struct inode *inode, struct super_block **psb)
+static enum sb_pin_state pin_sb_for_writeback(struct writeback_control *wbc,
+					      struct super_block *sb)
 {
-	struct super_block *sb = inode->i_sb;
-
-	/*
-	 * If this sb is already pinned, nothing more to do. If not and
-	 * *psb is non-NULL, unpin the old one first
-	 */
-	if (sb == *psb)
-		return 0;
-	else if (*psb)
-		unpin_sb_for_writeback(psb);
-
 	/*
 	 * Caller must already hold the ref for this
 	 */
 	if (wbc->sync_mode == WB_SYNC_ALL) {
 		WARN_ON(!rwsem_is_locked(&sb->s_umount));
-		return 0;
+		return SB_NOT_PINNED;
 	}
-
 	spin_lock(&sb_lock);
 	sb->s_count++;
 	if (down_read_trylock(&sb->s_umount)) {
 		if (sb->s_root) {
 			spin_unlock(&sb_lock);
-			goto pinned;
+			return SB_PINNED;
 		}
 		/*
 		 * umounted, drop rwsem again and fall through to failure
 		 */
 		up_read(&sb->s_umount);
 	}
-
 	sb->s_count--;
 	spin_unlock(&sb_lock);
-	return 1;
-pinned:
-	*psb = sb;
-	return 0;
+	return SB_PIN_FAILED;
 }
 
-static void writeback_inodes_wb(struct bdi_writeback *wb,
-				struct writeback_control *wbc)
+/*
+ * Write a portion of b_io inodes which belong to @sb.
+ * If @wbc->sb != NULL, then find and write all such
+ * inodes. Otherwise write only ones which go sequentially
+ * in reverse order.
+ * Return 1, if the caller writeback routine should be
+ * interrupted. Otherwise return 0.
+ */
+static int writeback_sb_inodes(struct super_block *sb,
+			       struct bdi_writeback *wb,
+			       struct writeback_control *wbc)
 {
-	struct super_block *sb = wbc->sb, *pin_sb = NULL;
-	const unsigned long start = jiffies;	/* livelock avoidance */
-
-	spin_lock(&inode_lock);
-
-	if (!wbc->for_kupdate || list_empty(&wb->b_io))
-		queue_io(wb, wbc->older_than_this);
-
 	while (!list_empty(&wb->b_io)) {
-		struct inode *inode = list_entry(wb->b_io.prev,
-						struct inode, i_list);
 		long pages_skipped;
-
-		/*
-		 * super block given and doesn't match, skip this inode
-		 */
-		if (sb && sb != inode->i_sb) {
+		struct inode *inode = list_entry(wb->b_io.prev,
+						 struct inode, i_list);
+		if (wbc->sb && sb != inode->i_sb) {
+			/* super block given and doesn't
+			   match, skip this inode */
 			redirty_tail(inode);
 			continue;
 		}
-
+		if (sb != inode->i_sb)
+			/* finish with this superblock */
+			return 0;
 		if (inode->i_state & (I_NEW | I_WILL_FREE)) {
 			requeue_io(inode);
 			continue;
 		}
-
 		/*
 		 * Was this inode dirtied after sync_sb_inodes was called?
 		 * This keeps sync from extra jobs and livelock.
 		 */
-		if (inode_dirtied_after(inode, start))
-			break;
-
-		if (pin_sb_for_writeback(wbc, inode, &pin_sb)) {
-			requeue_io(inode);
-			continue;
-		}
+		if (inode_dirtied_after(inode, wbc->wb_start))
+			return 1;
 
 		BUG_ON(inode->i_state & (I_FREEING | I_CLEAR));
 		__iget(inode);
@@ -673,14 +651,50 @@
 		spin_lock(&inode_lock);
 		if (wbc->nr_to_write <= 0) {
 			wbc->more_io = 1;
-			break;
+			return 1;
 		}
 		if (!list_empty(&wb->b_more_io))
 			wbc->more_io = 1;
 	}
+	/* b_io is empty */
+	return 1;
+}
 
-	unpin_sb_for_writeback(&pin_sb);
+static void writeback_inodes_wb(struct bdi_writeback *wb,
+				struct writeback_control *wbc)
+{
+	int ret = 0;
 
+	wbc->wb_start = jiffies; /* livelock avoidance */
+	spin_lock(&inode_lock);
+	if (!wbc->for_kupdate || list_empty(&wb->b_io))
+		queue_io(wb, wbc->older_than_this);
+
+	while (!list_empty(&wb->b_io)) {
+		struct inode *inode = list_entry(wb->b_io.prev,
+						 struct inode, i_list);
+		struct super_block *sb = inode->i_sb;
+		enum sb_pin_state state;
+
+		if (wbc->sb && sb != wbc->sb) {
+			/* super block given and doesn't
+			   match, skip this inode */
+			redirty_tail(inode);
+			continue;
+		}
+		state = pin_sb_for_writeback(wbc, sb);
+
+		if (state == SB_PIN_FAILED) {
+			requeue_io(inode);
+			continue;
+		}
+		ret = writeback_sb_inodes(sb, wb, wbc);
+
+		if (state == SB_PINNED)
+			unpin_sb_for_writeback(sb);
+		if (ret)
+			break;
+	}
 	spin_unlock(&inode_lock);
 	/* Leave any unwritten inodes on b_io */
 }
diff -urN linux-2.6.34-rc3/fs/fscache/object-list.c linux-2.6.34-rc4/fs/fscache/object-list.c
--- linux-2.6.34-rc3/fs/fscache/object-list.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/fscache/object-list.c	2010-04-13 02:19:01.883633419 +0000
@@ -12,6 +12,7 @@
 #define FSCACHE_DEBUG_LEVEL COOKIE
 #include <linux/module.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/key.h>
 #include <keys/user-type.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/fscache/operation.c linux-2.6.34-rc4/fs/fscache/operation.c
--- linux-2.6.34-rc3/fs/fscache/operation.c	2010-04-13 02:18:56.513633047 +0000
+++ linux-2.6.34-rc4/fs/fscache/operation.c	2010-04-13 02:19:01.883633419 +0000
@@ -14,6 +14,7 @@
 #define FSCACHE_DEBUG_LEVEL OPERATION
 #include <linux/module.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 atomic_t fscache_op_debug_id;
diff -urN linux-2.6.34-rc3/fs/fscache/page.c linux-2.6.34-rc4/fs/fscache/page.c
--- linux-2.6.34-rc3/fs/fscache/page.c	2010-04-13 02:18:56.513633047 +0000
+++ linux-2.6.34-rc4/fs/fscache/page.c	2010-04-13 02:19:01.883633419 +0000
@@ -14,6 +14,7 @@
 #include <linux/fscache-cache.h>
 #include <linux/buffer_head.h>
 #include <linux/pagevec.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 /*
diff -urN linux-2.6.34-rc3/fs/fscache/stats.c linux-2.6.34-rc4/fs/fscache/stats.c
--- linux-2.6.34-rc3/fs/fscache/stats.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/fscache/stats.c	2010-04-13 02:19:01.883633419 +0000
@@ -165,8 +165,8 @@
 		   atomic_read(&fscache_n_object_lookups),
 		   atomic_read(&fscache_n_object_lookups_negative),
 		   atomic_read(&fscache_n_object_lookups_positive),
-		   atomic_read(&fscache_n_object_lookups_timed_out),
-		   atomic_read(&fscache_n_object_created));
+		   atomic_read(&fscache_n_object_created),
+		   atomic_read(&fscache_n_object_lookups_timed_out));
 
 	seq_printf(m, "Updates: n=%u nul=%u run=%u\n",
 		   atomic_read(&fscache_n_updates),
diff -urN linux-2.6.34-rc3/fs/fuse/cuse.c linux-2.6.34-rc4/fs/fuse/cuse.c
--- linux-2.6.34-rc3/fs/fuse/cuse.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/fuse/cuse.c	2010-04-13 02:19:01.884633307 +0000
@@ -44,6 +44,7 @@
 #include <linux/magic.h>
 #include <linux/miscdevice.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/stat.h>
 
diff -urN linux-2.6.34-rc3/fs/generic_acl.c linux-2.6.34-rc4/fs/generic_acl.c
--- linux-2.6.34-rc3/fs/generic_acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/generic_acl.c	2010-04-13 02:19:01.884633307 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/generic_acl.h>
 #include <linux/posix_acl.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/bmap.c linux-2.6.34-rc4/fs/gfs2/bmap.c
--- linux-2.6.34-rc3/fs/gfs2/bmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/gfs2/bmap.c	2010-04-13 02:19:01.885633335 +0000
@@ -7,7 +7,6 @@
  * of the GNU General Public License version 2.
  */
 
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/dentry.c linux-2.6.34-rc4/fs/gfs2/dentry.c
--- linux-2.6.34-rc3/fs/gfs2/dentry.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/gfs2/dentry.c	2010-04-13 02:19:01.885633335 +0000
@@ -7,7 +7,6 @@
  * of the GNU General Public License version 2.
  */
 
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/export.c linux-2.6.34-rc4/fs/gfs2/export.c
--- linux-2.6.34-rc3/fs/gfs2/export.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/gfs2/export.c	2010-04-13 02:19:01.885633335 +0000
@@ -7,7 +7,6 @@
  * of the GNU General Public License version 2.
  */
 
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/glops.c linux-2.6.34-rc4/fs/gfs2/glops.c
--- linux-2.6.34-rc3/fs/gfs2/glops.c	2010-04-13 02:18:56.515633025 +0000
+++ linux-2.6.34-rc4/fs/gfs2/glops.c	2010-04-13 02:19:01.886633591 +0000
@@ -7,7 +7,6 @@
  * of the GNU General Public License version 2.
  */
 
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/lock_dlm.c linux-2.6.34-rc4/fs/gfs2/lock_dlm.c
--- linux-2.6.34-rc3/fs/gfs2/lock_dlm.c	2010-04-13 02:18:56.515633025 +0000
+++ linux-2.6.34-rc4/fs/gfs2/lock_dlm.c	2010-04-13 02:19:01.886633591 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/fs.h>
 #include <linux/dlm.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/gfs2_ondisk.h>
 
diff -urN linux-2.6.34-rc3/fs/gfs2/rgrp.h linux-2.6.34-rc4/fs/gfs2/rgrp.h
--- linux-2.6.34-rc3/fs/gfs2/rgrp.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/gfs2/rgrp.h	2010-04-13 02:19:01.888633402 +0000
@@ -10,6 +10,8 @@
 #ifndef __RGRP_DOT_H__
 #define __RGRP_DOT_H__
 
+#include <linux/slab.h>
+
 struct gfs2_rgrpd;
 struct gfs2_sbd;
 struct gfs2_holder;
diff -urN linux-2.6.34-rc3/fs/gfs2/sys.c linux-2.6.34-rc4/fs/gfs2/sys.c
--- linux-2.6.34-rc3/fs/gfs2/sys.c	2010-04-13 02:18:56.517633064 +0000
+++ linux-2.6.34-rc4/fs/gfs2/sys.c	2010-04-13 02:19:01.888633402 +0000
@@ -8,7 +8,6 @@
  */
 
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/gfs2/util.c linux-2.6.34-rc4/fs/gfs2/util.c
--- linux-2.6.34-rc3/fs/gfs2/util.c	2010-04-13 02:18:56.517633064 +0000
+++ linux-2.6.34-rc4/fs/gfs2/util.c	2010-04-13 02:19:01.888633402 +0000
@@ -7,7 +7,6 @@
  * of the GNU General Public License version 2.
  */
 
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/completion.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/hfs/bnode.c linux-2.6.34-rc4/fs/hfs/bnode.c
--- linux-2.6.34-rc3/fs/hfs/bnode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hfs/bnode.c	2010-04-13 02:19:01.889633352 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 
 #include "btree.h"
diff -urN linux-2.6.34-rc3/fs/hfs/btree.c linux-2.6.34-rc4/fs/hfs/btree.c
--- linux-2.6.34-rc3/fs/hfs/btree.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hfs/btree.c	2010-04-13 02:19:01.889633352 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/log2.h>
 
 #include "btree.h"
diff -urN linux-2.6.34-rc3/fs/hfs/mdb.c linux-2.6.34-rc4/fs/hfs/mdb.c
--- linux-2.6.34-rc3/fs/hfs/mdb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hfs/mdb.c	2010-04-13 02:19:01.889633352 +0000
@@ -11,6 +11,7 @@
 #include <linux/cdrom.h>
 #include <linux/genhd.h>
 #include <linux/nls.h>
+#include <linux/slab.h>
 
 #include "hfs_fs.h"
 #include "btree.h"
diff -urN linux-2.6.34-rc3/fs/hfs/super.c linux-2.6.34-rc4/fs/hfs/super.c
--- linux-2.6.34-rc3/fs/hfs/super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hfs/super.c	2010-04-13 02:19:01.889633352 +0000
@@ -19,6 +19,7 @@
 #include <linux/nls.h>
 #include <linux/parser.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/vfs.h>
 
diff -urN linux-2.6.34-rc3/fs/hfsplus/options.c linux-2.6.34-rc4/fs/hfsplus/options.c
--- linux-2.6.34-rc3/fs/hfsplus/options.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hfsplus/options.c	2010-04-13 02:19:01.889633352 +0000
@@ -15,6 +15,7 @@
 #include <linux/nls.h>
 #include <linux/mount.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "hfsplus_fs.h"
 
 enum {
diff -urN linux-2.6.34-rc3/fs/hostfs/hostfs_kern.c linux-2.6.34-rc4/fs/hostfs/hostfs_kern.c
--- linux-2.6.34-rc3/fs/hostfs/hostfs_kern.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hostfs/hostfs_kern.c	2010-04-13 02:19:01.890633444 +0000
@@ -11,6 +11,7 @@
 #include <linux/mm.h>
 #include <linux/pagemap.h>
 #include <linux/statfs.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/mount.h>
 #include "hostfs.h"
diff -urN linux-2.6.34-rc3/fs/hpfs/buffer.c linux-2.6.34-rc4/fs/hpfs/buffer.c
--- linux-2.6.34-rc3/fs/hpfs/buffer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hpfs/buffer.c	2010-04-13 02:19:01.890633444 +0000
@@ -6,6 +6,7 @@
  *  general buffer i/o
  */
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include "hpfs_fn.h"
 
 void hpfs_lock_creation(struct super_block *s)
diff -urN linux-2.6.34-rc3/fs/hpfs/dir.c linux-2.6.34-rc4/fs/hpfs/dir.c
--- linux-2.6.34-rc3/fs/hpfs/dir.c	2010-04-13 02:18:56.518633069 +0000
+++ linux-2.6.34-rc4/fs/hpfs/dir.c	2010-04-13 02:19:01.890633444 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include "hpfs_fn.h"
 
 static int hpfs_dir_release(struct inode *inode, struct file *filp)
diff -urN linux-2.6.34-rc3/fs/hpfs/inode.c linux-2.6.34-rc4/fs/hpfs/inode.c
--- linux-2.6.34-rc3/fs/hpfs/inode.c	2010-04-13 02:18:56.518633069 +0000
+++ linux-2.6.34-rc4/fs/hpfs/inode.c	2010-04-13 02:19:01.891633456 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include "hpfs_fn.h"
 
 void hpfs_init_inode(struct inode *i)
diff -urN linux-2.6.34-rc3/fs/hpfs/super.c linux-2.6.34-rc4/fs/hpfs/super.c
--- linux-2.6.34-rc3/fs/hpfs/super.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/hpfs/super.c	2010-04-13 02:19:01.891633456 +0000
@@ -15,6 +15,7 @@
 #include <linux/sched.h>
 #include <linux/smp_lock.h>
 #include <linux/bitmap.h>
+#include <linux/slab.h>
 
 /* Mark the filesystem dirty, so that chkdsk checks it when os/2 booted */
 
diff -urN linux-2.6.34-rc3/fs/ioprio.c linux-2.6.34-rc4/fs/ioprio.c
--- linux-2.6.34-rc3/fs/ioprio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ioprio.c	2010-04-13 02:19:01.892633592 +0000
@@ -19,6 +19,7 @@
  * See also Documentation/block/ioprio.txt
  *
  */
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/ioprio.h>
 #include <linux/blkdev.h>
diff -urN linux-2.6.34-rc3/fs/isofs/dir.c linux-2.6.34-rc4/fs/isofs/dir.c
--- linux-2.6.34-rc3/fs/isofs/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/isofs/dir.c	2010-04-13 02:19:01.892633592 +0000
@@ -11,6 +11,7 @@
  *  isofs directory handling functions
  */
 #include <linux/smp_lock.h>
+#include <linux/gfp.h>
 #include "isofs.h"
 
 int isofs_name_translate(struct iso_directory_record *de, char *new, struct inode *inode)
diff -urN linux-2.6.34-rc3/fs/isofs/namei.c linux-2.6.34-rc4/fs/isofs/namei.c
--- linux-2.6.34-rc3/fs/isofs/namei.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/isofs/namei.c	2010-04-13 02:19:01.892633592 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/smp_lock.h>
+#include <linux/gfp.h>
 #include "isofs.h"
 
 /*
diff -urN linux-2.6.34-rc3/fs/jbd/commit.c linux-2.6.34-rc4/fs/jbd/commit.c
--- linux-2.6.34-rc3/fs/jbd/commit.c	2010-04-13 02:18:56.520570460 +0000
+++ linux-2.6.34-rc4/fs/jbd/commit.c	2010-04-13 02:19:01.892633592 +0000
@@ -17,7 +17,6 @@
 #include <linux/fs.h>
 #include <linux/jbd.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/pagemap.h>
 #include <linux/bio.h>
diff -urN linux-2.6.34-rc3/fs/jbd/recovery.c linux-2.6.34-rc4/fs/jbd/recovery.c
--- linux-2.6.34-rc3/fs/jbd/recovery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jbd/recovery.c	2010-04-13 02:19:01.892633592 +0000
@@ -20,7 +20,6 @@
 #include <linux/fs.h>
 #include <linux/jbd.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #endif
 
 /*
diff -urN linux-2.6.34-rc3/fs/jbd2/recovery.c linux-2.6.34-rc4/fs/jbd2/recovery.c
--- linux-2.6.34-rc3/fs/jbd2/recovery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jbd2/recovery.c	2010-04-13 02:19:01.894633560 +0000
@@ -20,7 +20,6 @@
 #include <linux/fs.h>
 #include <linux/jbd2.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/crc32.h>
 #endif
 
diff -urN linux-2.6.34-rc3/fs/jffs2/compr_lzo.c linux-2.6.34-rc4/fs/jffs2/compr_lzo.c
--- linux-2.6.34-rc3/fs/jffs2/compr_lzo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/compr_lzo.c	2010-04-13 02:19:01.894633560 +0000
@@ -11,7 +11,6 @@
 
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/init.h>
 #include <linux/lzo.h>
diff -urN linux-2.6.34-rc3/fs/jffs2/compr_zlib.c linux-2.6.34-rc4/fs/jffs2/compr_zlib.c
--- linux-2.6.34-rc3/fs/jffs2/compr_zlib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/compr_zlib.c	2010-04-13 02:19:01.894633560 +0000
@@ -14,7 +14,6 @@
 #endif
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/zlib.h>
 #include <linux/zutil.h>
 #include "nodelist.h"
diff -urN linux-2.6.34-rc3/fs/jffs2/debug.c linux-2.6.34-rc4/fs/jffs2/debug.c
--- linux-2.6.34-rc3/fs/jffs2/debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/debug.c	2010-04-13 02:19:01.895633369 +0000
@@ -15,6 +15,7 @@
 #include <linux/crc32.h>
 #include <linux/jffs2.h>
 #include <linux/mtd/mtd.h>
+#include <linux/slab.h>
 #include "nodelist.h"
 #include "debug.h"
 
diff -urN linux-2.6.34-rc3/fs/jffs2/file.c linux-2.6.34-rc4/fs/jffs2/file.c
--- linux-2.6.34-rc3/fs/jffs2/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/file.c	2010-04-13 02:19:01.895633369 +0000
@@ -10,7 +10,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/time.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/fs/jffs2/nodelist.c linux-2.6.34-rc4/fs/jffs2/nodelist.c
--- linux-2.6.34-rc3/fs/jffs2/nodelist.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/nodelist.c	2010-04-13 02:19:01.895633369 +0000
@@ -15,7 +15,6 @@
 #include <linux/mtd/mtd.h>
 #include <linux/rbtree.h>
 #include <linux/crc32.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include "nodelist.h"
 
diff -urN linux-2.6.34-rc3/fs/jffs2/nodemgmt.c linux-2.6.34-rc4/fs/jffs2/nodemgmt.c
--- linux-2.6.34-rc3/fs/jffs2/nodemgmt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/nodemgmt.c	2010-04-13 02:19:01.895633369 +0000
@@ -10,7 +10,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/mtd/mtd.h>
 #include <linux/compiler.h>
 #include <linux/sched.h> /* For cond_resched() */
diff -urN linux-2.6.34-rc3/fs/jffs2/symlink.c linux-2.6.34-rc4/fs/jffs2/symlink.c
--- linux-2.6.34-rc3/fs/jffs2/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/symlink.c	2010-04-13 02:19:01.895633369 +0000
@@ -10,7 +10,6 @@
  */
 
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/namei.h>
 #include "nodelist.h"
diff -urN linux-2.6.34-rc3/fs/jffs2/write.c linux-2.6.34-rc4/fs/jffs2/write.c
--- linux-2.6.34-rc3/fs/jffs2/write.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jffs2/write.c	2010-04-13 02:19:01.896633423 +0000
@@ -12,7 +12,6 @@
 #include <linux/kernel.h>
 #include <linux/fs.h>
 #include <linux/crc32.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/mtd/mtd.h>
 #include "nodelist.h"
diff -urN linux-2.6.34-rc3/fs/jfs/acl.c linux-2.6.34-rc4/fs/jfs/acl.c
--- linux-2.6.34-rc3/fs/jfs/acl.c	2010-04-13 02:18:56.521570571 +0000
+++ linux-2.6.34-rc4/fs/jfs/acl.c	2010-04-13 02:19:01.896633423 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/posix_acl_xattr.h>
 #include "jfs_incore.h"
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_dmap.c linux-2.6.34-rc4/fs/jfs/jfs_dmap.c
--- linux-2.6.34-rc3/fs/jfs/jfs_dmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_dmap.c	2010-04-13 02:19:01.897633394 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include "jfs_incore.h"
 #include "jfs_superblock.h"
 #include "jfs_dmap.h"
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_dtree.c linux-2.6.34-rc4/fs/jfs/jfs_dtree.c
--- linux-2.6.34-rc3/fs/jfs/jfs_dtree.c	2010-04-13 02:18:56.522633044 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_dtree.c	2010-04-13 02:19:01.897633394 +0000
@@ -102,6 +102,7 @@
 
 #include <linux/fs.h>
 #include <linux/quotaops.h>
+#include <linux/slab.h>
 #include "jfs_incore.h"
 #include "jfs_superblock.h"
 #include "jfs_filsys.h"
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_imap.c linux-2.6.34-rc4/fs/jfs/jfs_imap.c
--- linux-2.6.34-rc3/fs/jfs/jfs_imap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_imap.c	2010-04-13 02:19:01.898633394 +0000
@@ -45,6 +45,7 @@
 #include <linux/buffer_head.h>
 #include <linux/pagemap.h>
 #include <linux/quotaops.h>
+#include <linux/slab.h>
 
 #include "jfs_incore.h"
 #include "jfs_inode.h"
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_logmgr.c linux-2.6.34-rc4/fs/jfs/jfs_logmgr.c
--- linux-2.6.34-rc3/fs/jfs/jfs_logmgr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_logmgr.c	2010-04-13 02:19:01.898633394 +0000
@@ -70,6 +70,7 @@
 #include <linux/delay.h>
 #include <linux/mutex.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include "jfs_incore.h"
 #include "jfs_filsys.h"
 #include "jfs_metapage.h"
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_metapage.c linux-2.6.34-rc4/fs/jfs/jfs_metapage.c
--- linux-2.6.34-rc3/fs/jfs/jfs_metapage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_metapage.c	2010-04-13 02:19:01.899633461 +0000
@@ -21,6 +21,7 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/bio.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/buffer_head.h>
 #include <linux/mempool.h>
diff -urN linux-2.6.34-rc3/fs/jfs/jfs_unicode.h linux-2.6.34-rc4/fs/jfs/jfs_unicode.h
--- linux-2.6.34-rc3/fs/jfs/jfs_unicode.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/jfs/jfs_unicode.h	2010-04-13 02:19:01.899633461 +0000
@@ -19,6 +19,7 @@
 #ifndef _H_JFS_UNICODE
 #define _H_JFS_UNICODE
 
+#include <linux/slab.h>
 #include <asm/byteorder.h>
 #include "jfs_types.h"
 
diff -urN linux-2.6.34-rc3/fs/jfs/super.c linux-2.6.34-rc4/fs/jfs/super.c
--- linux-2.6.34-rc3/fs/jfs/super.c	2010-04-13 02:18:56.523633059 +0000
+++ linux-2.6.34-rc4/fs/jfs/super.c	2010-04-13 02:19:01.900633357 +0000
@@ -30,6 +30,7 @@
 #include <linux/buffer_head.h>
 #include <linux/exportfs.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/seq_file.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/fs/jfs/xattr.c linux-2.6.34-rc4/fs/jfs/xattr.c
--- linux-2.6.34-rc3/fs/jfs/xattr.c	2010-04-13 02:18:56.524633047 +0000
+++ linux-2.6.34-rc4/fs/jfs/xattr.c	2010-04-13 02:19:01.900633357 +0000
@@ -21,6 +21,7 @@
 #include <linux/fs.h>
 #include <linux/xattr.h>
 #include <linux/posix_acl_xattr.h>
+#include <linux/slab.h>
 #include <linux/quotaops.h>
 #include <linux/security.h>
 #include "jfs_incore.h"
diff -urN linux-2.6.34-rc3/fs/libfs.c linux-2.6.34-rc4/fs/libfs.c
--- linux-2.6.34-rc3/fs/libfs.c	2010-04-13 02:18:56.524633047 +0000
+++ linux-2.6.34-rc4/fs/libfs.c	2010-04-13 02:19:01.900633357 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/module.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/vfs.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/fs/lockd/clntlock.c linux-2.6.34-rc4/fs/lockd/clntlock.c
--- linux-2.6.34-rc3/fs/lockd/clntlock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/clntlock.c	2010-04-13 02:19:01.900633357 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/module.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/nfs_fs.h>
 #include <linux/sunrpc/clnt.h>
diff -urN linux-2.6.34-rc3/fs/lockd/clntproc.c linux-2.6.34-rc4/fs/lockd/clntproc.c
--- linux-2.6.34-rc3/fs/lockd/clntproc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/clntproc.c	2010-04-13 02:19:01.901633366 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/module.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/fs/lockd/mon.c linux-2.6.34-rc4/fs/lockd/mon.c
--- linux-2.6.34-rc3/fs/lockd/mon.c	2010-04-13 02:18:56.524633047 +0000
+++ linux-2.6.34-rc4/fs/lockd/mon.c	2010-04-13 02:19:01.901633366 +0000
@@ -10,6 +10,7 @@
 #include <linux/utsname.h>
 #include <linux/kernel.h>
 #include <linux/ktime.h>
+#include <linux/slab.h>
 
 #include <linux/sunrpc/clnt.h>
 #include <linux/sunrpc/xprtsock.h>
diff -urN linux-2.6.34-rc3/fs/lockd/svc.c linux-2.6.34-rc4/fs/lockd/svc.c
--- linux-2.6.34-rc3/fs/lockd/svc.c	2010-04-13 02:18:56.524633047 +0000
+++ linux-2.6.34-rc4/fs/lockd/svc.c	2010-04-13 02:19:01.901633366 +0000
@@ -21,7 +21,6 @@
 #include <linux/errno.h>
 #include <linux/in.h>
 #include <linux/uio.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/smp_lock.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/fs/lockd/svc4proc.c linux-2.6.34-rc4/fs/lockd/svc4proc.c
--- linux-2.6.34-rc3/fs/lockd/svc4proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/svc4proc.c	2010-04-13 02:19:01.901633366 +0000
@@ -9,7 +9,6 @@
 
 #include <linux/types.h>
 #include <linux/time.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/lockd/lockd.h>
 #include <linux/lockd/share.h>
diff -urN linux-2.6.34-rc3/fs/lockd/svclock.c linux-2.6.34-rc4/fs/lockd/svclock.c
--- linux-2.6.34-rc3/fs/lockd/svclock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/svclock.c	2010-04-13 02:19:01.901633366 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/fs/lockd/svcproc.c linux-2.6.34-rc4/fs/lockd/svcproc.c
--- linux-2.6.34-rc3/fs/lockd/svcproc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/svcproc.c	2010-04-13 02:19:01.902633406 +0000
@@ -9,7 +9,6 @@
 
 #include <linux/types.h>
 #include <linux/time.h>
-#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/lockd/lockd.h>
 #include <linux/lockd/share.h>
diff -urN linux-2.6.34-rc3/fs/lockd/svcsubs.c linux-2.6.34-rc4/fs/lockd/svcsubs.c
--- linux-2.6.34-rc3/fs/lockd/svcsubs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/lockd/svcsubs.c	2010-04-13 02:19:01.902633406 +0000
@@ -10,6 +10,7 @@
 #include <linux/string.h>
 #include <linux/time.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/sunrpc/svc.h>
 #include <linux/sunrpc/clnt.h>
diff -urN linux-2.6.34-rc3/fs/logfs/dev_bdev.c linux-2.6.34-rc4/fs/logfs/dev_bdev.c
--- linux-2.6.34-rc3/fs/logfs/dev_bdev.c	2010-04-13 02:18:56.525633053 +0000
+++ linux-2.6.34-rc4/fs/logfs/dev_bdev.c	2010-04-13 02:19:01.902633406 +0000
@@ -9,6 +9,7 @@
 #include <linux/bio.h>
 #include <linux/blkdev.h>
 #include <linux/buffer_head.h>
+#include <linux/gfp.h>
 
 #define PAGE_OFS(ofs) ((ofs) & (PAGE_SIZE-1))
 
diff -urN linux-2.6.34-rc3/fs/logfs/dir.c linux-2.6.34-rc4/fs/logfs/dir.c
--- linux-2.6.34-rc3/fs/logfs/dir.c	2010-04-13 02:18:56.525633053 +0000
+++ linux-2.6.34-rc4/fs/logfs/dir.c	2010-04-13 02:19:01.903633424 +0000
@@ -6,7 +6,7 @@
  * Copyright (c) 2005-2008 Joern Engel <joern@logfs.org>
  */
 #include "logfs.h"
-
+#include <linux/slab.h>
 
 /*
  * Atomic dir operations
diff -urN linux-2.6.34-rc3/fs/logfs/gc.c linux-2.6.34-rc4/fs/logfs/gc.c
--- linux-2.6.34-rc3/fs/logfs/gc.c	2010-04-13 02:18:56.526633034 +0000
+++ linux-2.6.34-rc4/fs/logfs/gc.c	2010-04-13 02:19:01.904633368 +0000
@@ -7,6 +7,7 @@
  */
 #include "logfs.h"
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 /*
  * Wear leveling needs to kick in when the difference between low erase
diff -urN linux-2.6.34-rc3/fs/logfs/inode.c linux-2.6.34-rc4/fs/logfs/inode.c
--- linux-2.6.34-rc3/fs/logfs/inode.c	2010-04-13 02:18:56.526633034 +0000
+++ linux-2.6.34-rc4/fs/logfs/inode.c	2010-04-13 02:19:01.904633368 +0000
@@ -6,6 +6,7 @@
  * Copyright (c) 2005-2008 Joern Engel <joern@logfs.org>
  */
 #include "logfs.h"
+#include <linux/slab.h>
 #include <linux/writeback.h>
 #include <linux/backing-dev.h>
 
diff -urN linux-2.6.34-rc3/fs/logfs/journal.c linux-2.6.34-rc4/fs/logfs/journal.c
--- linux-2.6.34-rc3/fs/logfs/journal.c	2010-04-13 02:18:56.527633010 +0000
+++ linux-2.6.34-rc4/fs/logfs/journal.c	2010-04-13 02:19:01.904633368 +0000
@@ -6,6 +6,7 @@
  * Copyright (c) 2005-2008 Joern Engel <joern@logfs.org>
  */
 #include "logfs.h"
+#include <linux/slab.h>
 
 static void logfs_calc_free(struct super_block *sb)
 {
diff -urN linux-2.6.34-rc3/fs/logfs/readwrite.c linux-2.6.34-rc4/fs/logfs/readwrite.c
--- linux-2.6.34-rc3/fs/logfs/readwrite.c	2010-04-13 02:18:56.528633079 +0000
+++ linux-2.6.34-rc4/fs/logfs/readwrite.c	2010-04-13 02:19:01.906633410 +0000
@@ -18,6 +18,7 @@
  */
 #include "logfs.h"
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 static u64 adjust_bix(u64 bix, level_t level)
 {
diff -urN linux-2.6.34-rc3/fs/logfs/segment.c linux-2.6.34-rc4/fs/logfs/segment.c
--- linux-2.6.34-rc3/fs/logfs/segment.c	2010-04-13 02:18:56.529571738 +0000
+++ linux-2.6.34-rc4/fs/logfs/segment.c	2010-04-13 02:19:01.906633410 +0000
@@ -10,6 +10,7 @@
  * three kinds of objects: inodes, dentries and blocks, both data and indirect.
  */
 #include "logfs.h"
+#include <linux/slab.h>
 
 static int logfs_mark_segment_bad(struct super_block *sb, u32 segno)
 {
diff -urN linux-2.6.34-rc3/fs/logfs/super.c linux-2.6.34-rc4/fs/logfs/super.c
--- linux-2.6.34-rc3/fs/logfs/super.c	2010-04-13 02:18:56.529571738 +0000
+++ linux-2.6.34-rc4/fs/logfs/super.c	2010-04-13 02:19:01.907633476 +0000
@@ -11,6 +11,7 @@
  */
 #include "logfs.h"
 #include <linux/bio.h>
+#include <linux/slab.h>
 #include <linux/mtd/mtd.h>
 #include <linux/statfs.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/minix/itree_v1.c linux-2.6.34-rc4/fs/minix/itree_v1.c
--- linux-2.6.34-rc3/fs/minix/itree_v1.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/minix/itree_v1.c	2010-04-13 02:19:01.907633476 +0000
@@ -1,4 +1,5 @@
 #include <linux/buffer_head.h>
+#include <linux/slab.h>
 #include "minix.h"
 
 enum {DEPTH = 3, DIRECT = 7};	/* Only double indirect */
diff -urN linux-2.6.34-rc3/fs/mpage.c linux-2.6.34-rc4/fs/mpage.c
--- linux-2.6.34-rc3/fs/mpage.c	2010-04-13 02:18:56.529571738 +0000
+++ linux-2.6.34-rc4/fs/mpage.c	2010-04-13 02:19:01.907633476 +0000
@@ -16,6 +16,7 @@
 #include <linux/module.h>
 #include <linux/mm.h>
 #include <linux/kdev_t.h>
+#include <linux/gfp.h>
 #include <linux/bio.h>
 #include <linux/fs.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/ncpfs/dir.c linux-2.6.34-rc4/fs/ncpfs/dir.c
--- linux-2.6.34-rc3/fs/ncpfs/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/dir.c	2010-04-13 02:19:01.908633312 +0000
@@ -15,7 +15,6 @@
 #include <linux/errno.h>
 #include <linux/stat.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/mm.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/ncpfs/file.c linux-2.6.34-rc4/fs/ncpfs/file.c
--- linux-2.6.34-rc3/fs/ncpfs/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/file.c	2010-04-13 02:19:01.909633458 +0000
@@ -15,7 +15,6 @@
 #include <linux/fcntl.h>
 #include <linux/stat.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/sched.h>
 #include <linux/smp_lock.h>
diff -urN linux-2.6.34-rc3/fs/ncpfs/ioctl.c linux-2.6.34-rc4/fs/ncpfs/ioctl.c
--- linux-2.6.34-rc3/fs/ncpfs/ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/ioctl.c	2010-04-13 02:19:01.909633458 +0000
@@ -15,6 +15,7 @@
 #include <linux/time.h>
 #include <linux/mm.h>
 #include <linux/mount.h>
+#include <linux/slab.h>
 #include <linux/highuid.h>
 #include <linux/smp_lock.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/fs/ncpfs/mmap.c linux-2.6.34-rc4/fs/ncpfs/mmap.c
--- linux-2.6.34-rc3/fs/ncpfs/mmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/mmap.c	2010-04-13 02:19:01.909633458 +0000
@@ -9,12 +9,12 @@
 #include <linux/stat.h>
 #include <linux/time.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/shm.h>
 #include <linux/errno.h>
 #include <linux/mman.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/fcntl.h>
 #include <linux/ncp_fs.h>
 
diff -urN linux-2.6.34-rc3/fs/ncpfs/sock.c linux-2.6.34-rc4/fs/ncpfs/sock.c
--- linux-2.6.34-rc3/fs/ncpfs/sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/sock.c	2010-04-13 02:19:01.909633458 +0000
@@ -21,6 +21,7 @@
 #include <linux/mm.h>
 #include <linux/netdevice.h>
 #include <linux/signal.h>
+#include <linux/slab.h>
 #include <net/scm.h>
 #include <net/sock.h>
 #include <linux/ipx.h>
diff -urN linux-2.6.34-rc3/fs/ncpfs/symlink.c linux-2.6.34-rc4/fs/ncpfs/symlink.c
--- linux-2.6.34-rc3/fs/ncpfs/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ncpfs/symlink.c	2010-04-13 02:19:01.909633458 +0000
@@ -27,6 +27,7 @@
 #include <linux/fs.h>
 #include <linux/ncp_fs.h>
 #include <linux/time.h>
+#include <linux/slab.h>
 #include <linux/mm.h>
 #include <linux/stat.h>
 #include "ncplib_kernel.h"
diff -urN linux-2.6.34-rc3/fs/nfs/cache_lib.c linux-2.6.34-rc4/fs/nfs/cache_lib.c
--- linux-2.6.34-rc3/fs/nfs/cache_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/cache_lib.c	2010-04-13 02:19:01.909633458 +0000
@@ -10,6 +10,7 @@
 #include <linux/moduleparam.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 #include <linux/sunrpc/cache.h>
 #include <linux/sunrpc/rpc_pipe_fs.h>
 
diff -urN linux-2.6.34-rc3/fs/nfs/callback_proc.c linux-2.6.34-rc4/fs/nfs/callback_proc.c
--- linux-2.6.34-rc3/fs/nfs/callback_proc.c	2010-04-13 02:18:56.531633024 +0000
+++ linux-2.6.34-rc4/fs/nfs/callback_proc.c	2010-04-13 02:19:01.910633348 +0000
@@ -7,6 +7,7 @@
  */
 #include <linux/nfs4.h>
 #include <linux/nfs_fs.h>
+#include <linux/slab.h>
 #include "nfs4_fs.h"
 #include "callback.h"
 #include "delegation.h"
diff -urN linux-2.6.34-rc3/fs/nfs/callback_xdr.c linux-2.6.34-rc4/fs/nfs/callback_xdr.c
--- linux-2.6.34-rc3/fs/nfs/callback_xdr.c	2010-04-13 02:18:56.531633024 +0000
+++ linux-2.6.34-rc4/fs/nfs/callback_xdr.c	2010-04-13 02:19:01.910633348 +0000
@@ -9,6 +9,7 @@
 #include <linux/sunrpc/svc.h>
 #include <linux/nfs4.h>
 #include <linux/nfs_fs.h>
+#include <linux/slab.h>
 #include "nfs4_fs.h"
 #include "callback.h"
 
diff -urN linux-2.6.34-rc3/fs/nfs/client.c linux-2.6.34-rc4/fs/nfs/client.c
--- linux-2.6.34-rc3/fs/nfs/client.c	2010-04-13 02:18:56.532633048 +0000
+++ linux-2.6.34-rc4/fs/nfs/client.c	2010-04-13 02:19:01.910633348 +0000
@@ -35,6 +35,7 @@
 #include <linux/vfs.h>
 #include <linux/inet.h>
 #include <linux/in6.h>
+#include <linux/slab.h>
 #include <net/ipv6.h>
 #include <linux/nfs_xdr.h>
 #include <linux/sunrpc/bc_xprt.h>
diff -urN linux-2.6.34-rc3/fs/nfs/delegation.c linux-2.6.34-rc4/fs/nfs/delegation.c
--- linux-2.6.34-rc3/fs/nfs/delegation.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/delegation.c	2010-04-13 02:19:01.910633348 +0000
@@ -10,6 +10,7 @@
 #include <linux/kthread.h>
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/spinlock.h>
 
diff -urN linux-2.6.34-rc3/fs/nfs/direct.c linux-2.6.34-rc4/fs/nfs/direct.c
--- linux-2.6.34-rc3/fs/nfs/direct.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/direct.c	2010-04-13 02:19:01.911633340 +0000
@@ -44,6 +44,7 @@
 #include <linux/file.h>
 #include <linux/pagemap.h>
 #include <linux/kref.h>
+#include <linux/slab.h>
 
 #include <linux/nfs_fs.h>
 #include <linux/nfs_page.h>
diff -urN linux-2.6.34-rc3/fs/nfs/dns_resolve.c linux-2.6.34-rc4/fs/nfs/dns_resolve.c
--- linux-2.6.34-rc3/fs/nfs/dns_resolve.c	2010-04-13 02:18:56.532633048 +0000
+++ linux-2.6.34-rc4/fs/nfs/dns_resolve.c	2010-04-13 02:19:01.911633340 +0000
@@ -9,6 +9,7 @@
 #include <linux/hash.h>
 #include <linux/string.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/socket.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/fs/nfs/file.c linux-2.6.34-rc4/fs/nfs/file.c
--- linux-2.6.34-rc3/fs/nfs/file.c	2010-04-13 02:18:56.532633048 +0000
+++ linux-2.6.34-rc4/fs/nfs/file.c	2010-04-13 02:19:01.911633340 +0000
@@ -24,9 +24,9 @@
 #include <linux/nfs_fs.h>
 #include <linux/nfs_mount.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/aio.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/fs/nfs/fscache.c linux-2.6.34-rc4/fs/nfs/fscache.c
--- linux-2.6.34-rc3/fs/nfs/fscache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/fscache.c	2010-04-13 02:19:01.912633373 +0000
@@ -17,6 +17,7 @@
 #include <linux/nfs_fs_sb.h>
 #include <linux/in6.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include "internal.h"
 #include "iostat.h"
diff -urN linux-2.6.34-rc3/fs/nfs/inode.c linux-2.6.34-rc4/fs/nfs/inode.c
--- linux-2.6.34-rc3/fs/nfs/inode.c	2010-04-13 02:18:56.533633066 +0000
+++ linux-2.6.34-rc4/fs/nfs/inode.c	2010-04-13 02:19:01.912633373 +0000
@@ -36,6 +36,7 @@
 #include <linux/vfs.h>
 #include <linux/inet.h>
 #include <linux/nfs_xdr.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/nfs/namespace.c linux-2.6.34-rc4/fs/nfs/namespace.c
--- linux-2.6.34-rc3/fs/nfs/namespace.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/namespace.c	2010-04-13 02:19:01.912633373 +0000
@@ -8,6 +8,7 @@
  */
 
 #include <linux/dcache.h>
+#include <linux/gfp.h>
 #include <linux/mount.h>
 #include <linux/namei.h>
 #include <linux/nfs_fs.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs2xdr.c linux-2.6.34-rc4/fs/nfs/nfs2xdr.c
--- linux-2.6.34-rc3/fs/nfs/nfs2xdr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs2xdr.c	2010-04-13 02:19:01.912633373 +0000
@@ -12,7 +12,6 @@
 #include <linux/param.h>
 #include <linux/time.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs3acl.c linux-2.6.34-rc4/fs/nfs/nfs3acl.c
--- linux-2.6.34-rc3/fs/nfs/nfs3acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs3acl.c	2010-04-13 02:19:01.913633511 +0000
@@ -1,4 +1,5 @@
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/nfs.h>
 #include <linux/nfs3.h>
 #include <linux/nfs_fs.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs3proc.c linux-2.6.34-rc4/fs/nfs/nfs3proc.c
--- linux-2.6.34-rc3/fs/nfs/nfs3proc.c	2010-04-13 02:18:56.533633066 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs3proc.c	2010-04-13 02:19:01.913633511 +0000
@@ -10,6 +10,7 @@
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/sunrpc/clnt.h>
+#include <linux/slab.h>
 #include <linux/nfs.h>
 #include <linux/nfs3.h>
 #include <linux/nfs_fs.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs3xdr.c linux-2.6.34-rc4/fs/nfs/nfs3xdr.c
--- linux-2.6.34-rc3/fs/nfs/nfs3xdr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs3xdr.c	2010-04-13 02:19:01.913633511 +0000
@@ -9,7 +9,6 @@
 #include <linux/param.h>
 #include <linux/time.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs4namespace.c linux-2.6.34-rc4/fs/nfs/nfs4namespace.c
--- linux-2.6.34-rc3/fs/nfs/nfs4namespace.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs4namespace.c	2010-04-13 02:19:01.913633511 +0000
@@ -11,6 +11,7 @@
 #include <linux/mount.h>
 #include <linux/namei.h>
 #include <linux/nfs_fs.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/sunrpc/clnt.h>
 #include <linux/vfs.h>
diff -urN linux-2.6.34-rc3/fs/nfs/nfs4proc.c linux-2.6.34-rc4/fs/nfs/nfs4proc.c
--- linux-2.6.34-rc3/fs/nfs/nfs4proc.c	2010-04-13 02:18:56.534633101 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs4proc.c	2010-04-13 02:19:01.914633424 +0000
@@ -39,6 +39,7 @@
 #include <linux/delay.h>
 #include <linux/errno.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/sunrpc/clnt.h>
 #include <linux/nfs.h>
 #include <linux/nfs4.h>
@@ -2067,8 +2068,7 @@
 			case -EDQUOT:
 			case -ENOSPC:
 			case -EROFS:
-				lookup_instantiate_filp(nd, (struct dentry *)state, NULL);
-				return 1;
+				return PTR_ERR(state);
 			default:
 				goto out_drop;
 		}
diff -urN linux-2.6.34-rc3/fs/nfs/nfs4xdr.c linux-2.6.34-rc4/fs/nfs/nfs4xdr.c
--- linux-2.6.34-rc3/fs/nfs/nfs4xdr.c	2010-04-13 02:18:56.535633008 +0000
+++ linux-2.6.34-rc4/fs/nfs/nfs4xdr.c	2010-04-13 02:19:01.915633408 +0000
@@ -38,7 +38,6 @@
 #include <linux/param.h>
 #include <linux/time.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/string.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/fs/nfs/proc.c linux-2.6.34-rc4/fs/nfs/proc.c
--- linux-2.6.34-rc3/fs/nfs/proc.c	2010-04-13 02:18:56.535633008 +0000
+++ linux-2.6.34-rc4/fs/nfs/proc.c	2010-04-13 02:19:01.916633459 +0000
@@ -29,7 +29,6 @@
 
 #include <linux/types.h>
 #include <linux/param.h>
-#include <linux/slab.h>
 #include <linux/time.h>
 #include <linux/mm.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/fs/nfs/super.c linux-2.6.34-rc4/fs/nfs/super.c
--- linux-2.6.34-rc3/fs/nfs/super.c	2010-04-13 02:18:56.536633011 +0000
+++ linux-2.6.34-rc4/fs/nfs/super.c	2010-04-13 02:19:01.916633459 +0000
@@ -48,6 +48,7 @@
 #include <linux/vfs.h>
 #include <linux/inet.h>
 #include <linux/in6.h>
+#include <linux/slab.h>
 #include <net/ipv6.h>
 #include <linux/netdevice.h>
 #include <linux/nfs_xdr.h>
diff -urN linux-2.6.34-rc3/fs/nfs/symlink.c linux-2.6.34-rc4/fs/nfs/symlink.c
--- linux-2.6.34-rc3/fs/nfs/symlink.c	2010-04-13 02:18:56.536633011 +0000
+++ linux-2.6.34-rc4/fs/nfs/symlink.c	2010-04-13 02:19:01.916633459 +0000
@@ -19,7 +19,6 @@
 #include <linux/pagemap.h>
 #include <linux/stat.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/namei.h>
 
diff -urN linux-2.6.34-rc3/fs/nfs_common/nfsacl.c linux-2.6.34-rc4/fs/nfs_common/nfsacl.c
--- linux-2.6.34-rc3/fs/nfs_common/nfsacl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfs_common/nfsacl.c	2010-04-13 02:19:01.917633432 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/module.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/sunrpc/xdr.h>
 #include <linux/nfsacl.h>
 #include <linux/nfs3.h>
diff -urN linux-2.6.34-rc3/fs/nfsd/export.c linux-2.6.34-rc4/fs/nfsd/export.c
--- linux-2.6.34-rc3/fs/nfsd/export.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/export.c	2010-04-13 02:19:01.917633432 +0000
@@ -12,6 +12,7 @@
  * Copyright (C) 1995, 1996 Olaf Kirch, <okir@monad.swb.de>
  */
 
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/module.h>
 #include <linux/exportfs.h>
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs2acl.c linux-2.6.34-rc4/fs/nfsd/nfs2acl.c
--- linux-2.6.34-rc3/fs/nfsd/nfs2acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs2acl.c	2010-04-13 02:19:01.917633432 +0000
@@ -7,6 +7,7 @@
 #include "nfsd.h"
 /* FIXME: nfsacl.h is a broken header */
 #include <linux/nfsacl.h>
+#include <linux/gfp.h>
 #include "cache.h"
 #include "xdr3.h"
 #include "vfs.h"
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs3acl.c linux-2.6.34-rc4/fs/nfsd/nfs3acl.c
--- linux-2.6.34-rc3/fs/nfsd/nfs3acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs3acl.c	2010-04-13 02:19:01.917633432 +0000
@@ -7,6 +7,7 @@
 #include "nfsd.h"
 /* FIXME: nfsacl.h is a broken header */
 #include <linux/nfsacl.h>
+#include <linux/gfp.h>
 #include "cache.h"
 #include "xdr3.h"
 #include "vfs.h"
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4acl.c linux-2.6.34-rc4/fs/nfsd/nfs4acl.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4acl.c	2010-04-13 02:19:01.917633432 +0000
@@ -34,6 +34,7 @@
  *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/slab.h>
 #include <linux/nfs_fs.h>
 #include <linux/nfs4_acl.h>
 
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4callback.c linux-2.6.34-rc4/fs/nfsd/nfs4callback.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4callback.c	2010-04-13 02:18:56.536633011 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4callback.c	2010-04-13 02:19:01.918633431 +0000
@@ -32,6 +32,7 @@
  */
 
 #include <linux/sunrpc/clnt.h>
+#include <linux/slab.h>
 #include "nfsd.h"
 #include "state.h"
 
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4idmap.c linux-2.6.34-rc4/fs/nfsd/nfs4idmap.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4idmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4idmap.c	2010-04-13 02:19:01.918633431 +0000
@@ -36,6 +36,7 @@
 #include <linux/nfsd_idmap.h>
 #include <linux/seq_file.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 /*
  * Cache entry
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4proc.c linux-2.6.34-rc4/fs/nfsd/nfs4proc.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4proc.c	2010-04-13 02:19:01.918633431 +0000
@@ -33,6 +33,7 @@
  *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 #include <linux/file.h>
+#include <linux/slab.h>
 
 #include "cache.h"
 #include "xdr4.h"
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4recover.c linux-2.6.34-rc4/fs/nfsd/nfs4recover.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4recover.c	2010-04-13 02:18:56.536633011 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4recover.c	2010-04-13 02:19:01.918633431 +0000
@@ -32,6 +32,7 @@
 */
 
 #include <linux/file.h>
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/crypto.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4state.c linux-2.6.34-rc4/fs/nfsd/nfs4state.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4state.c	2010-04-13 02:18:56.537633121 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4state.c	2010-04-13 02:19:01.919633359 +0000
@@ -34,6 +34,7 @@
 
 #include <linux/file.h>
 #include <linux/smp_lock.h>
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/swap.h>
 #include <linux/sunrpc/svcauth_gss.h>
diff -urN linux-2.6.34-rc3/fs/nfsd/nfs4xdr.c linux-2.6.34-rc4/fs/nfsd/nfs4xdr.c
--- linux-2.6.34-rc3/fs/nfsd/nfs4xdr.c	2010-04-13 02:18:56.537633121 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfs4xdr.c	2010-04-13 02:19:01.919633359 +0000
@@ -40,6 +40,7 @@
  * at the end of nfs4svc_decode_compoundargs.
  */
 
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/statfs.h>
 #include <linux/utsname.h>
diff -urN linux-2.6.34-rc3/fs/nfsd/nfscache.c linux-2.6.34-rc4/fs/nfsd/nfscache.c
--- linux-2.6.34-rc3/fs/nfsd/nfscache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfscache.c	2010-04-13 02:19:01.919633359 +0000
@@ -8,6 +8,8 @@
  * Copyright (C) 1995, 1996 Olaf Kirch <okir@monad.swb.de>
  */
 
+#include <linux/slab.h>
+
 #include "nfsd.h"
 #include "cache.h"
 
diff -urN linux-2.6.34-rc3/fs/nfsd/nfsctl.c linux-2.6.34-rc4/fs/nfsd/nfsctl.c
--- linux-2.6.34-rc3/fs/nfsd/nfsctl.c	2010-04-13 02:18:56.538633052 +0000
+++ linux-2.6.34-rc4/fs/nfsd/nfsctl.c	2010-04-13 02:19:01.920633470 +0000
@@ -4,6 +4,7 @@
  * Copyright (C) 1995, 1996 Olaf Kirch <okir@monad.swb.de>
  */
 
+#include <linux/slab.h>
 #include <linux/namei.h>
 #include <linux/ctype.h>
 
diff -urN linux-2.6.34-rc3/fs/nfsd/vfs.c linux-2.6.34-rc4/fs/nfsd/vfs.c
--- linux-2.6.34-rc3/fs/nfsd/vfs.c	2010-04-13 02:18:56.538633052 +0000
+++ linux-2.6.34-rc4/fs/nfsd/vfs.c	2010-04-13 02:19:01.920633470 +0000
@@ -25,6 +25,7 @@
 #include <linux/xattr.h>
 #include <linux/jhash.h>
 #include <linux/ima.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/exportfs.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/fs/nilfs2/alloc.c linux-2.6.34-rc4/fs/nilfs2/alloc.c
--- linux-2.6.34-rc3/fs/nilfs2/alloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/alloc.c	2010-04-13 02:19:01.920633470 +0000
@@ -26,6 +26,7 @@
 #include <linux/buffer_head.h>
 #include <linux/fs.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include "mdt.h"
 #include "alloc.h"
 
@@ -425,7 +426,7 @@
 	bitmap = bitmap_kaddr + bh_offset(req->pr_bitmap_bh);
 	if (!nilfs_clear_bit_atomic(nilfs_mdt_bgl_lock(inode, group),
 				    group_offset, bitmap))
-		printk(KERN_WARNING "%s: entry numer %llu already freed\n",
+		printk(KERN_WARNING "%s: entry number %llu already freed\n",
 		       __func__, (unsigned long long)req->pr_entry_nr);
 
 	nilfs_palloc_group_desc_add_entries(inode, group, desc, 1);
diff -urN linux-2.6.34-rc3/fs/nilfs2/btnode.c linux-2.6.34-rc4/fs/nilfs2/btnode.c
--- linux-2.6.34-rc3/fs/nilfs2/btnode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/btnode.c	2010-04-13 02:19:01.920633470 +0000
@@ -27,6 +27,7 @@
 #include <linux/buffer_head.h>
 #include <linux/mm.h>
 #include <linux/backing-dev.h>
+#include <linux/gfp.h>
 #include "nilfs.h"
 #include "mdt.h"
 #include "dat.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/btree.c linux-2.6.34-rc4/fs/nilfs2/btree.c
--- linux-2.6.34-rc3/fs/nilfs2/btree.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/btree.c	2010-04-13 02:19:01.921633398 +0000
@@ -1879,7 +1879,7 @@
 				   struct nilfs_btree_path *path,
 				   int level, struct buffer_head *bh)
 {
-	int maxlevel, ret;
+	int maxlevel = 0, ret;
 	struct nilfs_btree_node *parent;
 	struct inode *dat = nilfs_bmap_get_dat(&btree->bt_bmap);
 	__u64 ptr;
diff -urN linux-2.6.34-rc3/fs/nilfs2/gcinode.c linux-2.6.34-rc4/fs/nilfs2/gcinode.c
--- linux-2.6.34-rc3/fs/nilfs2/gcinode.c	2010-04-13 02:18:56.539571856 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/gcinode.c	2010-04-13 02:19:01.921633398 +0000
@@ -45,6 +45,7 @@
 #include <linux/buffer_head.h>
 #include <linux/mpage.h>
 #include <linux/hash.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 #include "nilfs.h"
 #include "page.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/inode.c linux-2.6.34-rc4/fs/nilfs2/inode.c
--- linux-2.6.34-rc3/fs/nilfs2/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/inode.c	2010-04-13 02:19:01.921633398 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/buffer_head.h>
+#include <linux/gfp.h>
 #include <linux/mpage.h>
 #include <linux/writeback.h>
 #include <linux/uio.h>
diff -urN linux-2.6.34-rc3/fs/nilfs2/ioctl.c linux-2.6.34-rc4/fs/nilfs2/ioctl.c
--- linux-2.6.34-rc3/fs/nilfs2/ioctl.c	2010-04-13 02:18:56.539571856 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/ioctl.c	2010-04-13 02:19:01.922633460 +0000
@@ -23,6 +23,7 @@
 #include <linux/fs.h>
 #include <linux/wait.h>
 #include <linux/smp_lock.h>	/* lock_kernel(), unlock_kernel() */
+#include <linux/slab.h>
 #include <linux/capability.h>	/* capable() */
 #include <linux/uaccess.h>	/* copy_from_user(), copy_to_user() */
 #include <linux/vmalloc.h>
@@ -648,7 +649,7 @@
 long nilfs_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)
 {
 	struct inode *inode = filp->f_dentry->d_inode;
-	void __user *argp = (void * __user *)arg;
+	void __user *argp = (void __user *)arg;
 
 	switch (cmd) {
 	case NILFS_IOCTL_CHANGE_CPMODE:
diff -urN linux-2.6.34-rc3/fs/nilfs2/mdt.c linux-2.6.34-rc4/fs/nilfs2/mdt.c
--- linux-2.6.34-rc3/fs/nilfs2/mdt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/mdt.c	2010-04-13 02:19:01.922633460 +0000
@@ -26,6 +26,7 @@
 #include <linux/writeback.h>
 #include <linux/backing-dev.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 #include "nilfs.h"
 #include "segment.h"
 #include "page.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/page.c linux-2.6.34-rc4/fs/nilfs2/page.c
--- linux-2.6.34-rc3/fs/nilfs2/page.c	2010-04-13 02:18:56.539571856 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/page.c	2010-04-13 02:19:01.922633460 +0000
@@ -29,6 +29,7 @@
 #include <linux/list.h>
 #include <linux/highmem.h>
 #include <linux/pagevec.h>
+#include <linux/gfp.h>
 #include "nilfs.h"
 #include "page.h"
 #include "mdt.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/recovery.c linux-2.6.34-rc4/fs/nilfs2/recovery.c
--- linux-2.6.34-rc3/fs/nilfs2/recovery.c	2010-04-13 02:18:56.539571856 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/recovery.c	2010-04-13 02:19:01.922633460 +0000
@@ -23,6 +23,7 @@
 #include <linux/buffer_head.h>
 #include <linux/blkdev.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 #include <linux/crc32.h>
 #include "nilfs.h"
 #include "segment.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/segbuf.c linux-2.6.34-rc4/fs/nilfs2/segbuf.c
--- linux-2.6.34-rc3/fs/nilfs2/segbuf.c	2010-04-13 02:18:56.540570344 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/segbuf.c	2010-04-13 02:19:01.923633520 +0000
@@ -25,6 +25,7 @@
 #include <linux/writeback.h>
 #include <linux/crc32.h>
 #include <linux/backing-dev.h>
+#include <linux/slab.h>
 #include "page.h"
 #include "segbuf.h"
 
diff -urN linux-2.6.34-rc3/fs/nilfs2/segment.c linux-2.6.34-rc4/fs/nilfs2/segment.c
--- linux-2.6.34-rc3/fs/nilfs2/segment.c	2010-04-13 02:18:56.540570344 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/segment.c	2010-04-13 02:19:01.923633520 +0000
@@ -32,6 +32,7 @@
 #include <linux/kthread.h>
 #include <linux/crc32.h>
 #include <linux/pagevec.h>
+#include <linux/slab.h>
 #include "nilfs.h"
 #include "btnode.h"
 #include "page.h"
diff -urN linux-2.6.34-rc3/fs/nilfs2/the_nilfs.h linux-2.6.34-rc4/fs/nilfs2/the_nilfs.h
--- linux-2.6.34-rc3/fs/nilfs2/the_nilfs.h	2010-04-13 02:18:56.541633069 +0000
+++ linux-2.6.34-rc4/fs/nilfs2/the_nilfs.h	2010-04-13 02:19:01.925633337 +0000
@@ -29,6 +29,7 @@
 #include <linux/fs.h>
 #include <linux/blkdev.h>
 #include <linux/backing-dev.h>
+#include <linux/slab.h>
 #include "sb.h"
 
 /* the_nilfs struct */
diff -urN linux-2.6.34-rc3/fs/notify/fsnotify.c linux-2.6.34-rc4/fs/notify/fsnotify.c
--- linux-2.6.34-rc3/fs/notify/fsnotify.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/notify/fsnotify.c	2010-04-13 02:19:01.925633337 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/dcache.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/srcu.h>
diff -urN linux-2.6.34-rc3/fs/notify/inode_mark.c linux-2.6.34-rc4/fs/notify/inode_mark.c
--- linux-2.6.34-rc3/fs/notify/inode_mark.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/notify/inode_mark.c	2010-04-13 02:19:01.925633337 +0000
@@ -87,7 +87,6 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
-#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/writeback.h> /* for inode_lock */
 
diff -urN linux-2.6.34-rc3/fs/ntfs/aops.c linux-2.6.34-rc4/fs/ntfs/aops.c
--- linux-2.6.34-rc3/fs/ntfs/aops.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/aops.c	2010-04-13 02:19:01.927633471 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/errno.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/pagemap.h>
 #include <linux/swap.h>
diff -urN linux-2.6.34-rc3/fs/ntfs/attrib.c linux-2.6.34-rc4/fs/ntfs/attrib.c
--- linux-2.6.34-rc3/fs/ntfs/attrib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/attrib.c	2010-04-13 02:19:01.928633507 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/buffer_head.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 #include <linux/writeback.h>
 
diff -urN linux-2.6.34-rc3/fs/ntfs/compress.c linux-2.6.34-rc4/fs/ntfs/compress.c
--- linux-2.6.34-rc3/fs/ntfs/compress.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/compress.c	2010-04-13 02:19:01.928633507 +0000
@@ -25,6 +25,7 @@
 #include <linux/buffer_head.h>
 #include <linux/blkdev.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 
 #include "attrib.h"
 #include "inode.h"
diff -urN linux-2.6.34-rc3/fs/ntfs/dir.c linux-2.6.34-rc4/fs/ntfs/dir.c
--- linux-2.6.34-rc3/fs/ntfs/dir.c	2010-04-13 02:18:56.543633060 +0000
+++ linux-2.6.34-rc4/fs/ntfs/dir.c	2010-04-13 02:19:01.930633554 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/buffer_head.h>
+#include <linux/slab.h>
 
 #include "dir.h"
 #include "aops.h"
diff -urN linux-2.6.34-rc3/fs/ntfs/file.c linux-2.6.34-rc4/fs/ntfs/file.c
--- linux-2.6.34-rc3/fs/ntfs/file.c	2010-04-13 02:18:56.543633060 +0000
+++ linux-2.6.34-rc4/fs/ntfs/file.c	2010-04-13 02:19:01.931633296 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/buffer_head.h>
+#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/pagevec.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/fs/ntfs/index.c linux-2.6.34-rc4/fs/ntfs/index.c
--- linux-2.6.34-rc3/fs/ntfs/index.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/index.c	2010-04-13 02:19:01.931633296 +0000
@@ -19,6 +19,8 @@
  * Foundation,Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
+#include <linux/slab.h>
+
 #include "aops.h"
 #include "collate.h"
 #include "debug.h"
diff -urN linux-2.6.34-rc3/fs/ntfs/mft.c linux-2.6.34-rc4/fs/ntfs/mft.c
--- linux-2.6.34-rc3/fs/ntfs/mft.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/mft.c	2010-04-13 02:19:01.932633467 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/buffer_head.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 
 #include "attrib.h"
diff -urN linux-2.6.34-rc3/fs/ntfs/namei.c linux-2.6.34-rc4/fs/ntfs/namei.c
--- linux-2.6.34-rc3/fs/ntfs/namei.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ntfs/namei.c	2010-04-13 02:19:01.932633467 +0000
@@ -23,6 +23,7 @@
 #include <linux/dcache.h>
 #include <linux/exportfs.h>
 #include <linux/security.h>
+#include <linux/slab.h>
 
 #include "attrib.h"
 #include "debug.h"
diff -urN linux-2.6.34-rc3/fs/ocfs2/acl.c linux-2.6.34-rc4/fs/ocfs2/acl.c
--- linux-2.6.34-rc3/fs/ocfs2/acl.c	2010-04-13 02:18:56.544633027 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/acl.c	2010-04-13 02:19:01.934633469 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 
 #define MLOG_MASK_PREFIX ML_INODE
diff -urN linux-2.6.34-rc3/fs/ocfs2/buffer_head_io.c linux-2.6.34-rc4/fs/ocfs2/buffer_head_io.c
--- linux-2.6.34-rc3/fs/ocfs2/buffer_head_io.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/buffer_head_io.c	2010-04-13 02:19:01.936633433 +0000
@@ -25,7 +25,6 @@
 
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 
 #include <cluster/masklog.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/cluster/heartbeat.c linux-2.6.34-rc4/fs/ocfs2/cluster/heartbeat.c
--- linux-2.6.34-rc3/fs/ocfs2/cluster/heartbeat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/cluster/heartbeat.c	2010-04-13 02:19:01.936633433 +0000
@@ -34,6 +34,7 @@
 #include <linux/crc32.h>
 #include <linux/time.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 #include "heartbeat.h"
 #include "tcp.h"
diff -urN linux-2.6.34-rc3/fs/ocfs2/cluster/nodemanager.c linux-2.6.34-rc4/fs/ocfs2/cluster/nodemanager.c
--- linux-2.6.34-rc3/fs/ocfs2/cluster/nodemanager.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/cluster/nodemanager.c	2010-04-13 02:19:01.937633472 +0000
@@ -19,6 +19,7 @@
  * Boston, MA 021110-1307, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/configfs.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/cluster/quorum.c linux-2.6.34-rc4/fs/ocfs2/cluster/quorum.c
--- linux-2.6.34-rc3/fs/ocfs2/cluster/quorum.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/cluster/quorum.c	2010-04-13 02:19:01.937633472 +0000
@@ -44,7 +44,6 @@
  * and if they're the last, they fire off the decision.
  */
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/reboot.h>
 
diff -urN linux-2.6.34-rc3/fs/ocfs2/dlm/dlmast.c linux-2.6.34-rc4/fs/ocfs2/dlm/dlmast.c
--- linux-2.6.34-rc3/fs/ocfs2/dlm/dlmast.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/dlm/dlmast.c	2010-04-13 02:19:01.939633345 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/init.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/dlm/dlmconvert.c linux-2.6.34-rc4/fs/ocfs2/dlm/dlmconvert.c
--- linux-2.6.34-rc3/fs/ocfs2/dlm/dlmconvert.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/dlm/dlmconvert.c	2010-04-13 02:19:01.939633345 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/init.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/dlm/dlmthread.c linux-2.6.34-rc4/fs/ocfs2/dlm/dlmthread.c
--- linux-2.6.34-rc3/fs/ocfs2/dlm/dlmthread.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/dlm/dlmthread.c	2010-04-13 02:19:01.941633384 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/init.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/dlm/dlmunlock.c linux-2.6.34-rc4/fs/ocfs2/dlm/dlmunlock.c
--- linux-2.6.34-rc3/fs/ocfs2/dlm/dlmunlock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/dlm/dlmunlock.c	2010-04-13 02:19:01.941633384 +0000
@@ -28,7 +28,6 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/init.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/extent_map.c linux-2.6.34-rc4/fs/ocfs2/extent_map.c
--- linux-2.6.34-rc3/fs/ocfs2/extent_map.c	2010-04-13 02:18:56.551633034 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/extent_map.c	2010-04-13 02:19:01.945633572 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/fs.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/fiemap.h>
 
diff -urN linux-2.6.34-rc3/fs/ocfs2/heartbeat.c linux-2.6.34-rc4/fs/ocfs2/heartbeat.c
--- linux-2.6.34-rc3/fs/ocfs2/heartbeat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/heartbeat.c	2010-04-13 02:19:01.946633346 +0000
@@ -26,7 +26,6 @@
 
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 
 #define MLOG_MASK_PREFIX ML_SUPER
diff -urN linux-2.6.34-rc3/fs/ocfs2/inode.c linux-2.6.34-rc4/fs/ocfs2/inode.c
--- linux-2.6.34-rc3/fs/ocfs2/inode.c	2010-04-13 02:18:56.551633034 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/inode.c	2010-04-13 02:19:01.946633346 +0000
@@ -25,7 +25,6 @@
 
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/quotaops.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/mmap.c linux-2.6.34-rc4/fs/ocfs2/mmap.c
--- linux-2.6.34-rc3/fs/ocfs2/mmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/mmap.c	2010-04-13 02:19:01.947633325 +0000
@@ -25,7 +25,6 @@
 
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/pagemap.h>
 #include <linux/uio.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/quota_global.c linux-2.6.34-rc4/fs/ocfs2/quota_global.c
--- linux-2.6.34-rc3/fs/ocfs2/quota_global.c	2010-04-13 02:18:56.553633063 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/quota_global.c	2010-04-13 02:19:01.949633180 +0000
@@ -3,6 +3,7 @@
  */
 #include <linux/spinlock.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/quota.h>
 #include <linux/quotaops.h>
 #include <linux/dqblk_qtree.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/quota_local.c linux-2.6.34-rc4/fs/ocfs2/quota_local.c
--- linux-2.6.34-rc3/fs/ocfs2/quota_local.c	2010-04-13 02:18:56.553633063 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/quota_local.c	2010-04-13 02:19:01.949633180 +0000
@@ -3,6 +3,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/quota.h>
 #include <linux/quotaops.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/refcounttree.c linux-2.6.34-rc4/fs/ocfs2/refcounttree.c
--- linux-2.6.34-rc3/fs/ocfs2/refcounttree.c	2010-04-13 02:18:56.554633069 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/refcounttree.c	2010-04-13 02:19:01.950633381 +0000
@@ -37,7 +37,6 @@
 
 #include <linux/bio.h>
 #include <linux/blkdev.h>
-#include <linux/gfp.h>
 #include <linux/slab.h>
 #include <linux/writeback.h>
 #include <linux/pagevec.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/stack_o2cb.c linux-2.6.34-rc4/fs/ocfs2/stack_o2cb.c
--- linux-2.6.34-rc3/fs/ocfs2/stack_o2cb.c	2010-04-13 02:18:56.554633069 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/stack_o2cb.c	2010-04-13 02:19:01.950633381 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/kernel.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 
 /* Needed for AOP_TRUNCATED_PAGE in mlog_errno() */
diff -urN linux-2.6.34-rc3/fs/ocfs2/stack_user.c linux-2.6.34-rc4/fs/ocfs2/stack_user.c
--- linux-2.6.34-rc3/fs/ocfs2/stack_user.c	2010-04-13 02:18:56.554633069 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/stack_user.c	2010-04-13 02:19:01.951633369 +0000
@@ -21,6 +21,7 @@
 #include <linux/fs.h>
 #include <linux/miscdevice.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/reboot.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/ocfs2/sysfile.c linux-2.6.34-rc4/fs/ocfs2/sysfile.c
--- linux-2.6.34-rc3/fs/ocfs2/sysfile.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ocfs2/sysfile.c	2010-04-13 02:19:01.953633713 +0000
@@ -25,7 +25,6 @@
 
 #include <linux/fs.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/highmem.h>
 
 #define MLOG_MASK_PREFIX ML_INODE
diff -urN linux-2.6.34-rc3/fs/omfs/inode.c linux-2.6.34-rc4/fs/omfs/inode.c
--- linux-2.6.34-rc3/fs/omfs/inode.c	2010-04-13 02:18:56.558570483 +0000
+++ linux-2.6.34-rc4/fs/omfs/inode.c	2010-04-13 02:19:01.956633494 +0000
@@ -6,6 +6,7 @@
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/vfs.h>
 #include <linux/parser.h>
diff -urN linux-2.6.34-rc3/fs/open.c linux-2.6.34-rc4/fs/open.c
--- linux-2.6.34-rc3/fs/open.c	2010-04-13 02:18:56.558570483 +0000
+++ linux-2.6.34-rc4/fs/open.c	2010-04-13 02:19:01.957633490 +0000
@@ -10,7 +10,6 @@
 #include <linux/fdtable.h>
 #include <linux/fsnotify.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/namei.h>
 #include <linux/backing-dev.h>
@@ -20,6 +19,7 @@
 #include <linux/mount.h>
 #include <linux/vfs.h>
 #include <linux/fcntl.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/fs.h>
 #include <linux/personality.h>
diff -urN linux-2.6.34-rc3/fs/partitions/check.c linux-2.6.34-rc4/fs/partitions/check.c
--- linux-2.6.34-rc3/fs/partitions/check.c	2010-04-13 02:18:56.558570483 +0000
+++ linux-2.6.34-rc4/fs/partitions/check.c	2010-04-13 02:19:01.957633490 +0000
@@ -16,6 +16,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/kmod.h>
 #include <linux/ctype.h>
 #include <linux/genhd.h>
diff -urN linux-2.6.34-rc3/fs/partitions/efi.c linux-2.6.34-rc4/fs/partitions/efi.c
--- linux-2.6.34-rc3/fs/partitions/efi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/partitions/efi.c	2010-04-13 02:19:01.957633490 +0000
@@ -95,6 +95,7 @@
  ************************************************************/
 #include <linux/crc32.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 #include "check.h"
 #include "efi.h"
 
diff -urN linux-2.6.34-rc3/fs/proc/array.c linux-2.6.34-rc4/fs/proc/array.c
--- linux-2.6.34-rc3/fs/proc/array.c	2010-04-13 02:18:56.559570588 +0000
+++ linux-2.6.34-rc4/fs/proc/array.c	2010-04-13 02:19:01.958633616 +0000
@@ -68,7 +68,6 @@
 #include <linux/hugetlb.h>
 #include <linux/pagemap.h>
 #include <linux/swap.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/signal.h>
 #include <linux/highmem.h>
diff -urN linux-2.6.34-rc3/fs/proc/base.c linux-2.6.34-rc4/fs/proc/base.c
--- linux-2.6.34-rc3/fs/proc/base.c	2010-04-13 02:18:56.559570588 +0000
+++ linux-2.6.34-rc4/fs/proc/base.c	2010-04-13 02:19:01.959633304 +0000
@@ -81,6 +81,7 @@
 #include <linux/elf.h>
 #include <linux/pid_namespace.h>
 #include <linux/fs_struct.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 /* NOTE:
@@ -442,12 +443,13 @@
 unsigned long badness(struct task_struct *p, unsigned long uptime);
 static int proc_oom_score(struct task_struct *task, char *buffer)
 {
-	unsigned long points;
+	unsigned long points = 0;
 	struct timespec uptime;
 
 	do_posix_clock_monotonic_gettime(&uptime);
 	read_lock(&tasklist_lock);
-	points = badness(task->group_leader, uptime.tv_sec);
+	if (pid_alive(task))
+		points = badness(task, uptime.tv_sec);
 	read_unlock(&tasklist_lock);
 	return sprintf(buffer, "%lu\n", points);
 }
diff -urN linux-2.6.34-rc3/fs/proc/generic.c linux-2.6.34-rc4/fs/proc/generic.c
--- linux-2.6.34-rc3/fs/proc/generic.c	2010-04-13 02:18:56.559570588 +0000
+++ linux-2.6.34-rc4/fs/proc/generic.c	2010-04-13 02:19:01.959633304 +0000
@@ -13,6 +13,7 @@
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/init.h>
 #include <linux/idr.h>
diff -urN linux-2.6.34-rc3/fs/proc/inode.c linux-2.6.34-rc4/fs/proc/inode.c
--- linux-2.6.34-rc3/fs/proc/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/inode.c	2010-04-13 02:19:01.959633304 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/smp_lock.h>
 #include <linux/sysctl.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/proc/kcore.c linux-2.6.34-rc4/fs/proc/kcore.c
--- linux-2.6.34-rc3/fs/proc/kcore.c	2010-04-13 02:18:56.559570588 +0000
+++ linux-2.6.34-rc4/fs/proc/kcore.c	2010-04-13 02:19:01.960633394 +0000
@@ -19,6 +19,7 @@
 #include <linux/highmem.h>
 #include <linux/bootmem.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/io.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/fs/proc/nommu.c linux-2.6.34-rc4/fs/proc/nommu.c
--- linux-2.6.34-rc3/fs/proc/nommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/nommu.c	2010-04-13 02:19:01.960633394 +0000
@@ -21,7 +21,6 @@
 #include <linux/mmzone.h>
 #include <linux/pagemap.h>
 #include <linux/swap.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/seq_file.h>
 #include <linux/hugetlb.h>
diff -urN linux-2.6.34-rc3/fs/proc/proc_devtree.c linux-2.6.34-rc4/fs/proc/proc_devtree.c
--- linux-2.6.34-rc3/fs/proc/proc_devtree.c	2010-04-13 02:18:56.559570588 +0000
+++ linux-2.6.34-rc4/fs/proc/proc_devtree.c	2010-04-13 02:19:01.960633394 +0000
@@ -12,6 +12,7 @@
 #include <linux/string.h>
 #include <linux/of.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/prom.h>
 #include <asm/uaccess.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/proc/proc_net.c linux-2.6.34-rc4/fs/proc/proc_net.c
--- linux-2.6.34-rc3/fs/proc/proc_net.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/proc_net.c	2010-04-13 02:19:01.960633394 +0000
@@ -14,6 +14,7 @@
 #include <linux/time.h>
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/sched.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/fs/proc/stat.c linux-2.6.34-rc4/fs/proc/stat.c
--- linux-2.6.34-rc3/fs/proc/stat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/stat.c	2010-04-13 02:19:01.960633394 +0000
@@ -1,6 +1,5 @@
 #include <linux/cpumask.h>
 #include <linux/fs.h>
-#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/kernel_stat.h>
diff -urN linux-2.6.34-rc3/fs/proc/task_mmu.c linux-2.6.34-rc4/fs/proc/task_mmu.c
--- linux-2.6.34-rc3/fs/proc/task_mmu.c	2010-04-13 02:18:56.560570434 +0000
+++ linux-2.6.34-rc4/fs/proc/task_mmu.c	2010-04-13 02:19:01.961633618 +0000
@@ -4,6 +4,7 @@
 #include <linux/seq_file.h>
 #include <linux/highmem.h>
 #include <linux/ptrace.h>
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/mempolicy.h>
 #include <linux/swap.h>
@@ -406,6 +407,7 @@
 
 	memset(&mss, 0, sizeof mss);
 	mss.vma = vma;
+	/* mmap_sem is held in m_start */
 	if (vma->vm_mm && !is_vm_hugetlb_page(vma))
 		walk_page_range(vma->vm_start, vma->vm_end, &smaps_walk);
 
@@ -552,7 +554,8 @@
 };
 
 struct pagemapread {
-	u64 __user *out, *end;
+	int pos, len;
+	u64 *buffer;
 };
 
 #define PM_ENTRY_BYTES      sizeof(u64)
@@ -575,10 +578,8 @@
 static int add_to_pagemap(unsigned long addr, u64 pfn,
 			  struct pagemapread *pm)
 {
-	if (put_user(pfn, pm->out))
-		return -EFAULT;
-	pm->out++;
-	if (pm->out >= pm->end)
+	pm->buffer[pm->pos++] = pfn;
+	if (pm->pos >= pm->len)
 		return PM_END_OF_BUFFER;
 	return 0;
 }
@@ -661,31 +662,18 @@
 	return pme;
 }
 
-static int pagemap_hugetlb_range(pte_t *pte, unsigned long addr,
-				 unsigned long end, struct mm_walk *walk)
+/* This function walks within one hugetlb entry in the single call */
+static int pagemap_hugetlb_range(pte_t *pte, unsigned long hmask,
+				 unsigned long addr, unsigned long end,
+				 struct mm_walk *walk)
 {
-	struct vm_area_struct *vma;
 	struct pagemapread *pm = walk->private;
-	struct hstate *hs = NULL;
 	int err = 0;
+	u64 pfn;
 
-	vma = find_vma(walk->mm, addr);
-	if (vma)
-		hs = hstate_vma(vma);
 	for (; addr != end; addr += PAGE_SIZE) {
-		u64 pfn = PM_NOT_PRESENT;
-
-		if (vma && (addr >= vma->vm_end)) {
-			vma = find_vma(walk->mm, addr);
-			if (vma)
-				hs = hstate_vma(vma);
-		}
-
-		if (vma && (vma->vm_start <= addr) && is_vm_hugetlb_page(vma)) {
-			/* calculate pfn of the "raw" page in the hugepage. */
-			int offset = (addr & ~huge_page_mask(hs)) >> PAGE_SHIFT;
-			pfn = huge_pte_to_pagemap_entry(*pte, offset);
-		}
+		int offset = (addr & ~hmask) >> PAGE_SHIFT;
+		pfn = huge_pte_to_pagemap_entry(*pte, offset);
 		err = add_to_pagemap(addr, pfn, pm);
 		if (err)
 			return err;
@@ -720,21 +708,20 @@
  * determine which areas of memory are actually mapped and llseek to
  * skip over unmapped regions.
  */
+#define PAGEMAP_WALK_SIZE	(PMD_SIZE)
 static ssize_t pagemap_read(struct file *file, char __user *buf,
 			    size_t count, loff_t *ppos)
 {
 	struct task_struct *task = get_proc_task(file->f_path.dentry->d_inode);
-	struct page **pages, *page;
-	unsigned long uaddr, uend;
 	struct mm_struct *mm;
 	struct pagemapread pm;
-	int pagecount;
 	int ret = -ESRCH;
 	struct mm_walk pagemap_walk = {};
 	unsigned long src;
 	unsigned long svpfn;
 	unsigned long start_vaddr;
 	unsigned long end_vaddr;
+	int copied = 0;
 
 	if (!task)
 		goto out;
@@ -757,35 +744,12 @@
 	if (!mm)
 		goto out_task;
 
-
-	uaddr = (unsigned long)buf & PAGE_MASK;
-	uend = (unsigned long)(buf + count);
-	pagecount = (PAGE_ALIGN(uend) - uaddr) / PAGE_SIZE;
-	ret = 0;
-	if (pagecount == 0)
-		goto out_mm;
-	pages = kcalloc(pagecount, sizeof(struct page *), GFP_KERNEL);
+	pm.len = PM_ENTRY_BYTES * (PAGEMAP_WALK_SIZE >> PAGE_SHIFT);
+	pm.buffer = kmalloc(pm.len, GFP_TEMPORARY);
 	ret = -ENOMEM;
-	if (!pages)
+	if (!pm.buffer)
 		goto out_mm;
 
-	down_read(&current->mm->mmap_sem);
-	ret = get_user_pages(current, current->mm, uaddr, pagecount,
-			     1, 0, pages, NULL);
-	up_read(&current->mm->mmap_sem);
-
-	if (ret < 0)
-		goto out_free;
-
-	if (ret != pagecount) {
-		pagecount = ret;
-		ret = -EFAULT;
-		goto out_pages;
-	}
-
-	pm.out = (u64 __user *)buf;
-	pm.end = (u64 __user *)(buf + count);
-
 	pagemap_walk.pmd_entry = pagemap_pte_range;
 	pagemap_walk.pte_hole = pagemap_pte_hole;
 	pagemap_walk.hugetlb_entry = pagemap_hugetlb_range;
@@ -807,23 +771,36 @@
 	 * user buffer is tracked in "pm", and the walk
 	 * will stop when we hit the end of the buffer.
 	 */
-	ret = walk_page_range(start_vaddr, end_vaddr, &pagemap_walk);
-	if (ret == PM_END_OF_BUFFER)
-		ret = 0;
-	/* don't need mmap_sem for these, but this looks cleaner */
-	*ppos += (char __user *)pm.out - buf;
-	if (!ret)
-		ret = (char __user *)pm.out - buf;
-
-out_pages:
-	for (; pagecount; pagecount--) {
-		page = pages[pagecount-1];
-		if (!PageReserved(page))
-			SetPageDirty(page);
-		page_cache_release(page);
-	}
+	ret = 0;
+	while (count && (start_vaddr < end_vaddr)) {
+		int len;
+		unsigned long end;
+
+		pm.pos = 0;
+		end = start_vaddr + PAGEMAP_WALK_SIZE;
+		/* overflow ? */
+		if (end < start_vaddr || end > end_vaddr)
+			end = end_vaddr;
+		down_read(&mm->mmap_sem);
+		ret = walk_page_range(start_vaddr, end, &pagemap_walk);
+		up_read(&mm->mmap_sem);
+		start_vaddr = end;
+
+		len = min(count, PM_ENTRY_BYTES * pm.pos);
+		if (copy_to_user(buf, pm.buffer, len)) {
+			ret = -EFAULT;
+			goto out_free;
+		}
+		copied += len;
+		buf += len;
+		count -= len;
+	}
+	*ppos += copied;
+	if (!ret || ret == PM_END_OF_BUFFER)
+		ret = copied;
+
 out_free:
-	kfree(pages);
+	kfree(pm.buffer);
 out_mm:
 	mmput(mm);
 out_task:
diff -urN linux-2.6.34-rc3/fs/proc/task_nommu.c linux-2.6.34-rc4/fs/proc/task_nommu.c
--- linux-2.6.34-rc3/fs/proc/task_nommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/task_nommu.c	2010-04-13 02:19:01.961633618 +0000
@@ -5,6 +5,7 @@
 #include <linux/fs_struct.h>
 #include <linux/mount.h>
 #include <linux/ptrace.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/fs/proc/vmcore.c linux-2.6.34-rc4/fs/proc/vmcore.c
--- linux-2.6.34-rc3/fs/proc/vmcore.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/proc/vmcore.c	2010-04-13 02:19:01.961633618 +0000
@@ -12,6 +12,7 @@
 #include <linux/user.h>
 #include <linux/elf.h>
 #include <linux/elfcore.h>
+#include <linux/slab.h>
 #include <linux/highmem.h>
 #include <linux/bootmem.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/fs/quota/dquot.c linux-2.6.34-rc4/fs/quota/dquot.c
--- linux-2.6.34-rc3/fs/quota/dquot.c	2010-04-13 02:18:56.561570548 +0000
+++ linux-2.6.34-rc4/fs/quota/dquot.c	2010-04-13 02:19:01.963632841 +0000
@@ -874,14 +874,18 @@
 static void add_dquot_ref(struct super_block *sb, int type)
 {
 	struct inode *inode, *old_inode = NULL;
+#ifdef __DQUOT_PARANOIA
 	int reserved = 0;
+#endif
 
 	spin_lock(&inode_lock);
 	list_for_each_entry(inode, &sb->s_inodes, i_sb_list) {
 		if (inode->i_state & (I_FREEING|I_CLEAR|I_WILL_FREE|I_NEW))
 			continue;
+#ifdef __DQUOT_PARANOIA
 		if (unlikely(inode_get_rsv_space(inode) > 0))
 			reserved = 1;
+#endif
 		if (!atomic_read(&inode->i_writecount))
 			continue;
 		if (!dqinit_needed(inode, type))
@@ -903,11 +907,13 @@
 	spin_unlock(&inode_lock);
 	iput(old_inode);
 
+#ifdef __DQUOT_PARANOIA
 	if (reserved) {
 		printk(KERN_WARNING "VFS (%s): Writes happened before quota"
 			" was turned on thus quota information is probably "
 			"inconsistent. Please run quotacheck(8).\n", sb->s_id);
 	}
+#endif
 }
 
 /*
@@ -2322,34 +2328,34 @@
 	if (di->dqb_valid & QIF_SPACE) {
 		dm->dqb_curspace = di->dqb_curspace - dm->dqb_rsvspace;
 		check_blim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_SPACE_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_SPACE_B, &dquot->dq_flags);
 	}
 	if (di->dqb_valid & QIF_BLIMITS) {
 		dm->dqb_bsoftlimit = qbtos(di->dqb_bsoftlimit);
 		dm->dqb_bhardlimit = qbtos(di->dqb_bhardlimit);
 		check_blim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_BLIMITS_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_BLIMITS_B, &dquot->dq_flags);
 	}
 	if (di->dqb_valid & QIF_INODES) {
 		dm->dqb_curinodes = di->dqb_curinodes;
 		check_ilim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_INODES_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_INODES_B, &dquot->dq_flags);
 	}
 	if (di->dqb_valid & QIF_ILIMITS) {
 		dm->dqb_isoftlimit = di->dqb_isoftlimit;
 		dm->dqb_ihardlimit = di->dqb_ihardlimit;
 		check_ilim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_ILIMITS_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_ILIMITS_B, &dquot->dq_flags);
 	}
 	if (di->dqb_valid & QIF_BTIME) {
 		dm->dqb_btime = di->dqb_btime;
 		check_blim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_BTIME_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_BTIME_B, &dquot->dq_flags);
 	}
 	if (di->dqb_valid & QIF_ITIME) {
 		dm->dqb_itime = di->dqb_itime;
 		check_ilim = 1;
-		__set_bit(DQ_LASTSET_B + QIF_ITIME_B, &dquot->dq_flags);
+		set_bit(DQ_LASTSET_B + QIF_ITIME_B, &dquot->dq_flags);
 	}
 
 	if (check_blim) {
diff -urN linux-2.6.34-rc3/fs/quota/netlink.c linux-2.6.34-rc4/fs/quota/netlink.c
--- linux-2.6.34-rc3/fs/quota/netlink.c	2010-04-13 02:18:56.561570548 +0000
+++ linux-2.6.34-rc4/fs/quota/netlink.c	2010-04-13 02:19:01.963632841 +0000
@@ -5,6 +5,7 @@
 #include <linux/kernel.h>
 #include <linux/quotaops.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
 
diff -urN linux-2.6.34-rc3/fs/ramfs/file-nommu.c linux-2.6.34-rc4/fs/ramfs/file-nommu.c
--- linux-2.6.34-rc3/fs/ramfs/file-nommu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ramfs/file-nommu.c	2010-04-13 02:19:01.964632712 +0000
@@ -21,6 +21,7 @@
 #include <linux/pagevec.h>
 #include <linux/mman.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include "internal.h"
diff -urN linux-2.6.34-rc3/fs/ramfs/inode.c linux-2.6.34-rc4/fs/ramfs/inode.c
--- linux-2.6.34-rc3/fs/ramfs/inode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ramfs/inode.c	2010-04-13 02:19:01.964632712 +0000
@@ -35,6 +35,7 @@
 #include <linux/sched.h>
 #include <linux/parser.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/fs/reiserfs/dir.c linux-2.6.34-rc4/fs/reiserfs/dir.c
--- linux-2.6.34-rc3/fs/reiserfs/dir.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/dir.c	2010-04-13 02:19:01.965632636 +0000
@@ -8,6 +8,7 @@
 #include <linux/reiserfs_fs.h>
 #include <linux/stat.h>
 #include <linux/buffer_head.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 extern const struct reiserfs_key MIN_KEY;
diff -urN linux-2.6.34-rc3/fs/reiserfs/fix_node.c linux-2.6.34-rc4/fs/reiserfs/fix_node.c
--- linux-2.6.34-rc3/fs/reiserfs/fix_node.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/fix_node.c	2010-04-13 02:19:01.965632636 +0000
@@ -35,6 +35,7 @@
  **/
 
 #include <linux/time.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/reiserfs_fs.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/reiserfs/inode.c linux-2.6.34-rc4/fs/reiserfs/inode.c
--- linux-2.6.34-rc3/fs/reiserfs/inode.c	2010-04-13 02:18:56.562633112 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/inode.c	2010-04-13 02:19:01.966632756 +0000
@@ -11,6 +11,7 @@
 #include <linux/smp_lock.h>
 #include <linux/pagemap.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/unaligned.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/reiserfs/journal.c linux-2.6.34-rc4/fs/reiserfs/journal.c
--- linux-2.6.34-rc3/fs/reiserfs/journal.c	2010-04-13 02:18:56.563633037 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/journal.c	2010-04-13 02:19:01.967632708 +0000
@@ -50,6 +50,7 @@
 #include <linux/blkdev.h>
 #include <linux/backing-dev.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 
diff -urN linux-2.6.34-rc3/fs/reiserfs/namei.c linux-2.6.34-rc4/fs/reiserfs/namei.c
--- linux-2.6.34-rc3/fs/reiserfs/namei.c	2010-04-13 02:18:56.563633037 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/namei.c	2010-04-13 02:19:01.968632696 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/time.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <linux/reiserfs_fs.h>
 #include <linux/reiserfs_acl.h>
 #include <linux/reiserfs_xattr.h>
diff -urN linux-2.6.34-rc3/fs/reiserfs/super.c linux-2.6.34-rc4/fs/reiserfs/super.c
--- linux-2.6.34-rc3/fs/reiserfs/super.c	2010-04-13 02:18:56.564633042 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/super.c	2010-04-13 02:19:01.969632803 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/time.h>
 #include <asm/uaccess.h>
@@ -1618,10 +1619,8 @@
 	save_mount_options(s, data);
 
 	sbi = kzalloc(sizeof(struct reiserfs_sb_info), GFP_KERNEL);
-	if (!sbi) {
-		errval = -ENOMEM;
-		goto error_alloc;
-	}
+	if (!sbi)
+		return -ENOMEM;
 	s->s_fs_info = sbi;
 	/* Set default values for options: non-aggressive tails, RO on errors */
 	REISERFS_SB(s)->s_mount_opt |= (1 << REISERFS_SMALLTAIL);
@@ -1878,12 +1877,12 @@
 	return (0);
 
 error:
-	reiserfs_write_unlock(s);
-error_alloc:
 	if (jinit_done) {	/* kill the commit thread, free journal ram */
 		journal_release_error(NULL, s);
 	}
 
+	reiserfs_write_unlock(s);
+
 	reiserfs_free_bitmap_cache(s);
 	if (SB_BUFFER_WITH_SB(s))
 		brelse(SB_BUFFER_WITH_SB(s));
diff -urN linux-2.6.34-rc3/fs/reiserfs/xattr.c linux-2.6.34-rc4/fs/reiserfs/xattr.c
--- linux-2.6.34-rc3/fs/reiserfs/xattr.c	2010-04-13 02:18:56.564633042 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/xattr.c	2010-04-13 02:19:01.969632803 +0000
@@ -38,6 +38,7 @@
 #include <linux/dcache.h>
 #include <linux/namei.h>
 #include <linux/errno.h>
+#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/file.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/fs/reiserfs/xattr_acl.c linux-2.6.34-rc4/fs/reiserfs/xattr_acl.c
--- linux-2.6.34-rc3/fs/reiserfs/xattr_acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/xattr_acl.c	2010-04-13 02:19:01.969632803 +0000
@@ -5,6 +5,7 @@
 #include <linux/errno.h>
 #include <linux/pagemap.h>
 #include <linux/xattr.h>
+#include <linux/slab.h>
 #include <linux/posix_acl_xattr.h>
 #include <linux/reiserfs_xattr.h>
 #include <linux/reiserfs_acl.h>
diff -urN linux-2.6.34-rc3/fs/reiserfs/xattr_security.c linux-2.6.34-rc4/fs/reiserfs/xattr_security.c
--- linux-2.6.34-rc3/fs/reiserfs/xattr_security.c	2010-04-13 02:18:56.564633042 +0000
+++ linux-2.6.34-rc4/fs/reiserfs/xattr_security.c	2010-04-13 02:19:01.969632803 +0000
@@ -3,6 +3,7 @@
 #include <linux/fs.h>
 #include <linux/pagemap.h>
 #include <linux/xattr.h>
+#include <linux/slab.h>
 #include <linux/reiserfs_xattr.h>
 #include <linux/security.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/fs/signalfd.c linux-2.6.34-rc4/fs/signalfd.c
--- linux-2.6.34-rc3/fs/signalfd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/signalfd.c	2010-04-13 02:19:01.970632710 +0000
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/fs.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/signal.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/fs/smbfs/file.c linux-2.6.34-rc4/fs/smbfs/file.c
--- linux-2.6.34-rc3/fs/smbfs/file.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/smbfs/file.c	2010-04-13 02:19:01.970632710 +0000
@@ -13,7 +13,6 @@
 #include <linux/fcntl.h>
 #include <linux/stat.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/smp_lock.h>
 #include <linux/net.h>
diff -urN linux-2.6.34-rc3/fs/smbfs/smbiod.c linux-2.6.34-rc4/fs/smbfs/smbiod.c
--- linux-2.6.34-rc3/fs/smbfs/smbiod.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/smbfs/smbiod.c	2010-04-13 02:19:01.970632710 +0000
@@ -12,7 +12,6 @@
 #include <linux/string.h>
 #include <linux/stat.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/file.h>
 #include <linux/dcache.h>
diff -urN linux-2.6.34-rc3/fs/smbfs/symlink.c linux-2.6.34-rc4/fs/smbfs/symlink.c
--- linux-2.6.34-rc3/fs/smbfs/symlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/smbfs/symlink.c	2010-04-13 02:19:01.970632710 +0000
@@ -15,6 +15,7 @@
 #include <linux/pagemap.h>
 #include <linux/net.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/fs/splice.c linux-2.6.34-rc4/fs/splice.c
--- linux-2.6.34-rc3/fs/splice.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/splice.c	2010-04-13 02:19:01.971632698 +0000
@@ -30,6 +30,7 @@
 #include <linux/syscalls.h>
 #include <linux/uio.h>
 #include <linux/security.h>
+#include <linux/gfp.h>
 
 /*
  * Attempt to steal a page from a pipe buffer. This should perhaps go into
diff -urN linux-2.6.34-rc3/fs/squashfs/symlink.c linux-2.6.34-rc4/fs/squashfs/symlink.c
--- linux-2.6.34-rc3/fs/squashfs/symlink.c	2010-04-13 02:18:56.566633099 +0000
+++ linux-2.6.34-rc4/fs/squashfs/symlink.c	2010-04-13 02:19:01.973632652 +0000
@@ -33,7 +33,6 @@
 #include <linux/fs.h>
 #include <linux/vfs.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/pagemap.h>
 
diff -urN linux-2.6.34-rc3/fs/squashfs/zlib_wrapper.c linux-2.6.34-rc4/fs/squashfs/zlib_wrapper.c
--- linux-2.6.34-rc3/fs/squashfs/zlib_wrapper.c	2010-04-13 02:18:56.566633099 +0000
+++ linux-2.6.34-rc4/fs/squashfs/zlib_wrapper.c	2010-04-13 02:19:01.973632652 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/mutex.h>
 #include <linux/buffer_head.h>
+#include <linux/slab.h>
 #include <linux/zlib.h>
 
 #include "squashfs_fs.h"
diff -urN linux-2.6.34-rc3/fs/sync.c linux-2.6.34-rc4/fs/sync.c
--- linux-2.6.34-rc3/fs/sync.c	2010-04-13 02:18:56.566633099 +0000
+++ linux-2.6.34-rc4/fs/sync.c	2010-04-13 02:19:01.974632853 +0000
@@ -5,6 +5,7 @@
 #include <linux/kernel.h>
 #include <linux/file.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/fs/sysfs/inode.c linux-2.6.34-rc4/fs/sysfs/inode.c
--- linux-2.6.34-rc3/fs/sysfs/inode.c	2010-04-13 02:18:56.567571426 +0000
+++ linux-2.6.34-rc4/fs/sysfs/inode.c	2010-04-13 02:19:01.975632802 +0000
@@ -18,6 +18,7 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/xattr.h>
 #include <linux/security.h>
 #include "sysfs.h"
diff -urN linux-2.6.34-rc3/fs/sysfs/mount.c linux-2.6.34-rc4/fs/sysfs/mount.c
--- linux-2.6.34-rc3/fs/sysfs/mount.c	2010-04-13 02:18:56.567571426 +0000
+++ linux-2.6.34-rc4/fs/sysfs/mount.c	2010-04-13 02:19:01.975632802 +0000
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 
 #include "sysfs.h"
 
diff -urN linux-2.6.34-rc3/fs/sysfs/symlink.c linux-2.6.34-rc4/fs/sysfs/symlink.c
--- linux-2.6.34-rc3/fs/sysfs/symlink.c	2010-04-13 02:18:56.567571426 +0000
+++ linux-2.6.34-rc4/fs/sysfs/symlink.c	2010-04-13 02:19:01.975632802 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/mount.h>
 #include <linux/module.h>
 #include <linux/kobject.h>
diff -urN linux-2.6.34-rc3/fs/timerfd.c linux-2.6.34-rc4/fs/timerfd.c
--- linux-2.6.34-rc3/fs/timerfd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/timerfd.c	2010-04-13 02:19:01.976632684 +0000
@@ -14,6 +14,7 @@
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/spinlock.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/fs/ubifs/commit.c linux-2.6.34-rc4/fs/ubifs/commit.c
--- linux-2.6.34-rc3/fs/ubifs/commit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/commit.c	2010-04-13 02:19:01.976632684 +0000
@@ -45,6 +45,7 @@
 
 #include <linux/freezer.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include "ubifs.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ubifs/debug.c linux-2.6.34-rc4/fs/ubifs/debug.c
--- linux-2.6.34-rc3/fs/ubifs/debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/debug.c	2010-04-13 02:19:01.977632729 +0000
@@ -34,6 +34,7 @@
 #include <linux/moduleparam.h>
 #include <linux/debugfs.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_UBIFS_FS_DEBUG
 
diff -urN linux-2.6.34-rc3/fs/ubifs/file.c linux-2.6.34-rc4/fs/ubifs/file.c
--- linux-2.6.34-rc3/fs/ubifs/file.c	2010-04-13 02:18:56.568633044 +0000
+++ linux-2.6.34-rc4/fs/ubifs/file.c	2010-04-13 02:19:01.978633047 +0000
@@ -52,6 +52,7 @@
 #include "ubifs.h"
 #include <linux/mount.h>
 #include <linux/namei.h>
+#include <linux/slab.h>
 
 static int read_block(struct inode *inode, void *addr, unsigned int block,
 		      struct ubifs_data_node *dn)
diff -urN linux-2.6.34-rc3/fs/ubifs/gc.c linux-2.6.34-rc4/fs/ubifs/gc.c
--- linux-2.6.34-rc3/fs/ubifs/gc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/gc.c	2010-04-13 02:19:01.978633047 +0000
@@ -53,6 +53,7 @@
  * good, and GC takes extra care when moving them.
  */
 
+#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/list_sort.h>
 #include "ubifs.h"
diff -urN linux-2.6.34-rc3/fs/ubifs/io.c linux-2.6.34-rc4/fs/ubifs/io.c
--- linux-2.6.34-rc3/fs/ubifs/io.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/io.c	2010-04-13 02:19:01.978633047 +0000
@@ -51,6 +51,7 @@
  */
 
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include "ubifs.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ubifs/lpt.c linux-2.6.34-rc4/fs/ubifs/lpt.c
--- linux-2.6.34-rc3/fs/ubifs/lpt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/lpt.c	2010-04-13 02:19:01.979632828 +0000
@@ -46,6 +46,7 @@
 #include "ubifs.h"
 #include <linux/crc16.h>
 #include <linux/math64.h>
+#include <linux/slab.h>
 
 /**
  * do_calc_lpt_geom - calculate sizes for the LPT area.
diff -urN linux-2.6.34-rc3/fs/ubifs/lpt_commit.c linux-2.6.34-rc4/fs/ubifs/lpt_commit.c
--- linux-2.6.34-rc3/fs/ubifs/lpt_commit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/lpt_commit.c	2010-04-13 02:19:01.979632828 +0000
@@ -26,6 +26,7 @@
  */
 
 #include <linux/crc16.h>
+#include <linux/slab.h>
 #include "ubifs.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ubifs/recovery.c linux-2.6.34-rc4/fs/ubifs/recovery.c
--- linux-2.6.34-rc3/fs/ubifs/recovery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/recovery.c	2010-04-13 02:19:01.979632828 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include "ubifs.h"
 
 /**
diff -urN linux-2.6.34-rc3/fs/ubifs/sb.c linux-2.6.34-rc4/fs/ubifs/sb.c
--- linux-2.6.34-rc3/fs/ubifs/sb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/sb.c	2010-04-13 02:19:01.980634177 +0000
@@ -27,6 +27,7 @@
  */
 
 #include "ubifs.h"
+#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/math64.h>
 
diff -urN linux-2.6.34-rc3/fs/ubifs/tnc.c linux-2.6.34-rc4/fs/ubifs/tnc.c
--- linux-2.6.34-rc3/fs/ubifs/tnc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/tnc.c	2010-04-13 02:19:01.981696138 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include "ubifs.h"
 
 /*
diff -urN linux-2.6.34-rc3/fs/ubifs/ubifs.h linux-2.6.34-rc4/fs/ubifs/ubifs.h
--- linux-2.6.34-rc3/fs/ubifs/ubifs.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/ubifs.h	2010-04-13 02:19:01.981696138 +0000
@@ -28,6 +28,7 @@
 #include <linux/fs.h>
 #include <linux/err.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/spinlock.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/fs/ubifs/xattr.c linux-2.6.34-rc4/fs/ubifs/xattr.c
--- linux-2.6.34-rc3/fs/ubifs/xattr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/ubifs/xattr.c	2010-04-13 02:19:01.981696138 +0000
@@ -56,6 +56,7 @@
  */
 
 #include "ubifs.h"
+#include <linux/slab.h>
 #include <linux/xattr.h>
 #include <linux/posix_acl_xattr.h>
 
diff -urN linux-2.6.34-rc3/fs/udf/balloc.c linux-2.6.34-rc4/fs/udf/balloc.c
--- linux-2.6.34-rc3/fs/udf/balloc.c	2010-04-13 02:18:56.569633074 +0000
+++ linux-2.6.34-rc4/fs/udf/balloc.c	2010-04-13 02:19:01.982695982 +0000
@@ -125,9 +125,8 @@
 
 	mutex_lock(&sbi->s_alloc_mutex);
 	partmap = &sbi->s_partmaps[bloc->partitionReferenceNum];
-	if (bloc->logicalBlockNum < 0 ||
-	    (bloc->logicalBlockNum + count) >
-		partmap->s_partition_len) {
+	if (bloc->logicalBlockNum + count < count ||
+	    (bloc->logicalBlockNum + count) > partmap->s_partition_len) {
 		udf_debug("%d < %d || %d + %d > %d\n",
 			  bloc->logicalBlockNum, 0, bloc->logicalBlockNum,
 			  count, partmap->s_partition_len);
@@ -393,9 +392,8 @@
 
 	mutex_lock(&sbi->s_alloc_mutex);
 	partmap = &sbi->s_partmaps[bloc->partitionReferenceNum];
-	if (bloc->logicalBlockNum < 0 ||
-	    (bloc->logicalBlockNum + count) >
-		partmap->s_partition_len) {
+	if (bloc->logicalBlockNum + count < count ||
+	    (bloc->logicalBlockNum + count) > partmap->s_partition_len) {
 		udf_debug("%d < %d || %d + %d > %d\n",
 			  bloc->logicalBlockNum, 0, bloc->logicalBlockNum, count,
 			  partmap->s_partition_len);
diff -urN linux-2.6.34-rc3/fs/udf/file.c linux-2.6.34-rc4/fs/udf/file.c
--- linux-2.6.34-rc3/fs/udf/file.c	2010-04-13 02:18:56.569633074 +0000
+++ linux-2.6.34-rc4/fs/udf/file.c	2010-04-13 02:19:01.982695982 +0000
@@ -218,7 +218,7 @@
 	.llseek			= generic_file_llseek,
 };
 
-static int udf_setattr(struct dentry *dentry, struct iattr *iattr)
+int udf_setattr(struct dentry *dentry, struct iattr *iattr)
 {
 	struct inode *inode = dentry->d_inode;
 	int error;
diff -urN linux-2.6.34-rc3/fs/udf/inode.c linux-2.6.34-rc4/fs/udf/inode.c
--- linux-2.6.34-rc3/fs/udf/inode.c	2010-04-13 02:18:56.569633074 +0000
+++ linux-2.6.34-rc4/fs/udf/inode.c	2010-04-13 02:19:01.983695913 +0000
@@ -1314,7 +1314,7 @@
 		break;
 	case ICBTAG_FILE_TYPE_SYMLINK:
 		inode->i_data.a_ops = &udf_symlink_aops;
-		inode->i_op = &page_symlink_inode_operations;
+		inode->i_op = &udf_symlink_inode_operations;
 		inode->i_mode = S_IFLNK | S_IRWXUGO;
 		break;
 	case ICBTAG_FILE_TYPE_MAIN:
diff -urN linux-2.6.34-rc3/fs/udf/namei.c linux-2.6.34-rc4/fs/udf/namei.c
--- linux-2.6.34-rc3/fs/udf/namei.c	2010-04-13 02:18:56.570633044 +0000
+++ linux-2.6.34-rc4/fs/udf/namei.c	2010-04-13 02:19:01.983695913 +0000
@@ -925,7 +925,7 @@
 	iinfo = UDF_I(inode);
 	inode->i_mode = S_IFLNK | S_IRWXUGO;
 	inode->i_data.a_ops = &udf_symlink_aops;
-	inode->i_op = &page_symlink_inode_operations;
+	inode->i_op = &udf_symlink_inode_operations;
 
 	if (iinfo->i_alloc_type != ICBTAG_FLAG_AD_IN_ICB) {
 		struct kernel_lb_addr eloc;
@@ -1393,6 +1393,7 @@
 const struct inode_operations udf_dir_inode_operations = {
 	.lookup				= udf_lookup,
 	.create				= udf_create,
+	.setattr			= udf_setattr,
 	.link				= udf_link,
 	.unlink				= udf_unlink,
 	.symlink			= udf_symlink,
@@ -1401,3 +1402,9 @@
 	.mknod				= udf_mknod,
 	.rename				= udf_rename,
 };
+const struct inode_operations udf_symlink_inode_operations = {
+	.readlink	= generic_readlink,
+	.follow_link	= page_follow_link_light,
+	.put_link	= page_put_link,
+	.setattr	= udf_setattr,
+};
diff -urN linux-2.6.34-rc3/fs/udf/partition.c linux-2.6.34-rc4/fs/udf/partition.c
--- linux-2.6.34-rc3/fs/udf/partition.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/udf/partition.c	2010-04-13 02:19:01.983695913 +0000
@@ -24,7 +24,6 @@
 
 #include <linux/fs.h>
 #include <linux/string.h>
-#include <linux/slab.h>
 #include <linux/buffer_head.h>
 
 uint32_t udf_get_pblock(struct super_block *sb, uint32_t block,
diff -urN linux-2.6.34-rc3/fs/udf/symlink.c linux-2.6.34-rc4/fs/udf/symlink.c
--- linux-2.6.34-rc3/fs/udf/symlink.c	2010-04-13 02:18:56.570633044 +0000
+++ linux-2.6.34-rc4/fs/udf/symlink.c	2010-04-13 02:19:01.983695913 +0000
@@ -26,7 +26,6 @@
 #include <linux/time.h>
 #include <linux/mm.h>
 #include <linux/stat.h>
-#include <linux/slab.h>
 #include <linux/pagemap.h>
 #include <linux/smp_lock.h>
 #include <linux/buffer_head.h>
diff -urN linux-2.6.34-rc3/fs/udf/udfdecl.h linux-2.6.34-rc4/fs/udf/udfdecl.h
--- linux-2.6.34-rc3/fs/udf/udfdecl.h	2010-04-13 02:18:56.570633044 +0000
+++ linux-2.6.34-rc4/fs/udf/udfdecl.h	2010-04-13 02:19:01.984696161 +0000
@@ -76,6 +76,7 @@
 extern const struct file_operations udf_dir_operations;
 extern const struct inode_operations udf_file_inode_operations;
 extern const struct file_operations udf_file_operations;
+extern const struct inode_operations udf_symlink_inode_operations;
 extern const struct address_space_operations udf_aops;
 extern const struct address_space_operations udf_adinicb_aops;
 extern const struct address_space_operations udf_symlink_aops;
@@ -131,7 +132,7 @@
 /* file.c */
 extern int udf_ioctl(struct inode *, struct file *, unsigned int,
 		     unsigned long);
-
+extern int udf_setattr(struct dentry *dentry, struct iattr *iattr);
 /* inode.c */
 extern struct inode *udf_iget(struct super_block *, struct kernel_lb_addr *);
 extern int udf_sync_inode(struct inode *);
diff -urN linux-2.6.34-rc3/fs/udf/unicode.c linux-2.6.34-rc4/fs/udf/unicode.c
--- linux-2.6.34-rc3/fs/udf/unicode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/udf/unicode.c	2010-04-13 02:19:01.984696161 +0000
@@ -24,6 +24,7 @@
 #include <linux/string.h>	/* for memset */
 #include <linux/nls.h>
 #include <linux/crc-itu-t.h>
+#include <linux/slab.h>
 
 #include "udf_sb.h"
 
diff -urN linux-2.6.34-rc3/fs/xattr_acl.c linux-2.6.34-rc4/fs/xattr_acl.c
--- linux-2.6.34-rc3/fs/xattr_acl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/fs/xattr_acl.c	2010-04-13 02:19:01.986696449 +0000
@@ -6,9 +6,9 @@
  */
 
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/posix_acl_xattr.h>
+#include <linux/gfp.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/kmem.c linux-2.6.34-rc4/fs/xfs/linux-2.6/kmem.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/kmem.c	2010-04-13 02:18:56.572633058 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/kmem.c	2010-04-13 02:19:01.987695603 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/mm.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 #include <linux/swap.h>
 #include <linux/blkdev.h>
 #include <linux/backing-dev.h>
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_acl.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_acl.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_acl.c	2010-04-13 02:18:56.572633058 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_acl.c	2010-04-13 02:19:01.987695603 +0000
@@ -22,6 +22,7 @@
 #include "xfs_inode.h"
 #include "xfs_vnodeops.h"
 #include "xfs_trace.h"
+#include <linux/slab.h>
 #include <linux/xattr.h>
 #include <linux/posix_acl_xattr.h>
 
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_aops.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_aops.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_aops.c	2010-04-13 02:18:56.572633058 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_aops.c	2010-04-13 02:19:01.987695603 +0000
@@ -40,6 +40,7 @@
 #include "xfs_vnodeops.h"
 #include "xfs_trace.h"
 #include "xfs_bmap.h"
+#include <linux/gfp.h>
 #include <linux/mpage.h>
 #include <linux/pagevec.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_buf.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_buf.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_buf.c	2010-04-13 02:18:56.573633034 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_buf.c	2010-04-13 02:19:01.988695821 +0000
@@ -18,7 +18,7 @@
 #include "xfs.h"
 #include <linux/stddef.h>
 #include <linux/errno.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/init.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_ioctl.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_ioctl.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_ioctl.c	2010-04-13 02:18:56.574633067 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_ioctl.c	2010-04-13 02:19:01.990695860 +0000
@@ -58,6 +58,7 @@
 #include <linux/mount.h>
 #include <linux/namei.h>
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/exportfs.h>
 
 /*
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_ioctl32.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_ioctl32.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_ioctl32.c	2010-04-13 02:18:56.574633067 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_ioctl32.c	2010-04-13 02:19:01.990695860 +0000
@@ -18,6 +18,7 @@
 #include <linux/compat.h>
 #include <linux/ioctl.h>
 #include <linux/mount.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include "xfs.h"
 #include "xfs_fs.h"
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_iops.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_iops.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_iops.c	2010-04-13 02:18:56.574633067 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_iops.c	2010-04-13 02:19:01.991695719 +0000
@@ -56,6 +56,7 @@
 #include <linux/security.h>
 #include <linux/falloc.h>
 #include <linux/fiemap.h>
+#include <linux/slab.h>
 
 /*
  * Bring the timestamps in the XFS inode uptodate.
diff -urN linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_super.c linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_super.c
--- linux-2.6.34-rc3/fs/xfs/linux-2.6/xfs_super.c	2010-04-13 02:18:56.575633157 +0000
+++ linux-2.6.34-rc4/fs/xfs/linux-2.6/xfs_super.c	2010-04-13 02:19:01.992636601 +0000
@@ -61,6 +61,7 @@
 
 #include <linux/namei.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/mempool.h>
 #include <linux/writeback.h>
diff -urN linux-2.6.34-rc3/include/drm/drmP.h linux-2.6.34-rc4/include/drm/drmP.h
--- linux-2.6.34-rc3/include/drm/drmP.h	2010-04-13 02:18:56.594633290 +0000
+++ linux-2.6.34-rc4/include/drm/drmP.h	2010-04-13 02:19:02.022883808 +0000
@@ -55,6 +55,7 @@
 #include <linux/mm.h>
 #include <linux/cdev.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #if defined(__alpha__) || defined(__powerpc__)
 #include <asm/pgtable.h>	/* For pte_wrprotect */
 #endif
@@ -1545,39 +1546,7 @@
 {
 }
 
-
-static __inline__ void *drm_calloc_large(size_t nmemb, size_t size)
-{
-	if (size != 0 && nmemb > ULONG_MAX / size)
-		return NULL;
-
-	if (size * nmemb <= PAGE_SIZE)
-	    return kcalloc(nmemb, size, GFP_KERNEL);
-
-	return __vmalloc(size * nmemb,
-			 GFP_KERNEL | __GFP_HIGHMEM | __GFP_ZERO, PAGE_KERNEL);
-}
-
-/* Modeled after cairo's malloc_ab, it's like calloc but without the zeroing. */
-static __inline__ void *drm_malloc_ab(size_t nmemb, size_t size)
-{
-	if (size != 0 && nmemb > ULONG_MAX / size)
-		return NULL;
-
-	if (size * nmemb <= PAGE_SIZE)
-	    return kmalloc(nmemb * size, GFP_KERNEL);
-
-	return __vmalloc(size * nmemb,
-			 GFP_KERNEL | __GFP_HIGHMEM, PAGE_KERNEL);
-}
-
-static __inline void drm_free_large(void *ptr)
-{
-	if (!is_vmalloc_addr(ptr))
-		return kfree(ptr);
-
-	vfree(ptr);
-}
+#include "drm_mem_util.h"
 /*@}*/
 
 #endif				/* __KERNEL__ */
diff -urN linux-2.6.34-rc3/include/drm/drm_mem_util.h linux-2.6.34-rc4/include/drm/drm_mem_util.h
--- linux-2.6.34-rc3/include/drm/drm_mem_util.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/include/drm/drm_mem_util.h	2010-04-13 02:19:02.022883808 +0000
@@ -0,0 +1,65 @@
+/*
+ * Copyright  2008 Intel Corporation
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice (including the next
+ * paragraph) shall be included in all copies or substantial portions of the
+ * Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+ * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
+ * IN THE SOFTWARE.
+ *
+ * Authors:
+ *     Jesse Barnes <jbarnes@virtuousgeek.org>
+ *
+ */
+#ifndef _DRM_MEM_UTIL_H_
+#define _DRM_MEM_UTIL_H_
+
+#include <linux/vmalloc.h>
+
+static __inline__ void *drm_calloc_large(size_t nmemb, size_t size)
+{
+	if (size != 0 && nmemb > ULONG_MAX / size)
+		return NULL;
+
+	if (size * nmemb <= PAGE_SIZE)
+	    return kcalloc(nmemb, size, GFP_KERNEL);
+
+	return __vmalloc(size * nmemb,
+			 GFP_KERNEL | __GFP_HIGHMEM | __GFP_ZERO, PAGE_KERNEL);
+}
+
+/* Modeled after cairo's malloc_ab, it's like calloc but without the zeroing. */
+static __inline__ void *drm_malloc_ab(size_t nmemb, size_t size)
+{
+	if (size != 0 && nmemb > ULONG_MAX / size)
+		return NULL;
+
+	if (size * nmemb <= PAGE_SIZE)
+	    return kmalloc(nmemb * size, GFP_KERNEL);
+
+	return __vmalloc(size * nmemb,
+			 GFP_KERNEL | __GFP_HIGHMEM, PAGE_KERNEL);
+}
+
+static __inline void drm_free_large(void *ptr)
+{
+	if (!is_vmalloc_addr(ptr))
+		return kfree(ptr);
+
+	vfree(ptr);
+}
+
+#endif
diff -urN linux-2.6.34-rc3/include/drm/drm_pciids.h linux-2.6.34-rc4/include/drm/drm_pciids.h
--- linux-2.6.34-rc3/include/drm/drm_pciids.h	2010-04-13 02:18:56.594633290 +0000
+++ linux-2.6.34-rc4/include/drm/drm_pciids.h	2010-04-13 02:19:02.023883723 +0000
@@ -410,6 +410,7 @@
 	{0x1002, 0x9712, PCI_ANY_ID, PCI_ANY_ID, 0, 0, CHIP_RS880|RADEON_IS_MOBILITY|RADEON_NEW_MEMMAP|RADEON_IS_IGP}, \
 	{0x1002, 0x9713, PCI_ANY_ID, PCI_ANY_ID, 0, 0, CHIP_RS880|RADEON_IS_MOBILITY|RADEON_NEW_MEMMAP|RADEON_IS_IGP}, \
 	{0x1002, 0x9714, PCI_ANY_ID, PCI_ANY_ID, 0, 0, CHIP_RS880|RADEON_NEW_MEMMAP|RADEON_IS_IGP}, \
+	{0x1002, 0x9715, PCI_ANY_ID, PCI_ANY_ID, 0, 0, CHIP_RS880|RADEON_NEW_MEMMAP|RADEON_IS_IGP}, \
 	{0, 0, 0}
 
 #define r128_PCI_IDS \
diff -urN linux-2.6.34-rc3/include/drm/ttm/ttm_bo_driver.h linux-2.6.34-rc4/include/drm/ttm/ttm_bo_driver.h
--- linux-2.6.34-rc3/include/drm/ttm/ttm_bo_driver.h	2010-04-13 02:18:56.595633115 +0000
+++ linux-2.6.34-rc4/include/drm/ttm/ttm_bo_driver.h	2010-04-13 02:19:02.023883723 +0000
@@ -115,7 +115,6 @@
 	struct ttm_backend_func *func;
 };
 
-#define TTM_PAGE_FLAG_VMALLOC         (1 << 0)
 #define TTM_PAGE_FLAG_USER            (1 << 1)
 #define TTM_PAGE_FLAG_USER_DIRTY      (1 << 2)
 #define TTM_PAGE_FLAG_WRITE           (1 << 3)
diff -urN linux-2.6.34-rc3/include/linux/amba/bus.h linux-2.6.34-rc4/include/linux/amba/bus.h
--- linux-2.6.34-rc3/include/linux/amba/bus.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/amba/bus.h	2010-04-13 02:19:02.024883612 +0000
@@ -14,6 +14,9 @@
 #ifndef ASMARM_AMBA_H
 #define ASMARM_AMBA_H
 
+#include <linux/device.h>
+#include <linux/resource.h>
+
 #define AMBA_NR_IRQS	2
 
 struct amba_device {
diff -urN linux-2.6.34-rc3/include/linux/amba/pl061.h linux-2.6.34-rc4/include/linux/amba/pl061.h
--- linux-2.6.34-rc3/include/linux/amba/pl061.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/amba/pl061.h	2010-04-13 02:19:02.024883612 +0000
@@ -1,3 +1,5 @@
+#include <linux/types.h>
+
 /* platform data for the PL061 GPIO driver */
 
 struct pl061_platform_data {
diff -urN linux-2.6.34-rc3/include/linux/ata.h linux-2.6.34-rc4/include/linux/ata.h
--- linux-2.6.34-rc3/include/linux/ata.h	2010-04-13 02:18:56.595633115 +0000
+++ linux-2.6.34-rc4/include/linux/ata.h	2010-04-13 02:19:02.024883612 +0000
@@ -1025,8 +1025,8 @@
 
 static inline int lba_28_ok(u64 block, u32 n_block)
 {
-	/* check the ending block number */
-	return ((block + n_block) < ((u64)1 << 28)) && (n_block <= 256);
+	/* check the ending block number: must be LESS THAN 0x0fffffff */
+	return ((block + n_block) < ((1 << 28) - 1)) && (n_block <= 256);
 }
 
 static inline int lba_48_ok(u64 block, u32 n_block)
diff -urN linux-2.6.34-rc3/include/linux/bitops.h linux-2.6.34-rc4/include/linux/bitops.h
--- linux-2.6.34-rc3/include/linux/bitops.h	2010-04-13 02:18:56.596633013 +0000
+++ linux-2.6.34-rc4/include/linux/bitops.h	2010-04-13 02:19:02.025883297 +0000
@@ -21,9 +21,6 @@
 	     (bit) < (size); \
 	     (bit) = find_next_bit((addr), (size), (bit) + 1))
 
-/* Temporary */
-#define for_each_bit(bit, addr, size) for_each_set_bit(bit, addr, size)
-
 static __inline__ int get_bitmask_order(unsigned int count)
 {
 	int order;
diff -urN linux-2.6.34-rc3/include/linux/blkdev.h linux-2.6.34-rc4/include/linux/blkdev.h
--- linux-2.6.34-rc3/include/linux/blkdev.h	2010-04-13 02:18:56.596633013 +0000
+++ linux-2.6.34-rc4/include/linux/blkdev.h	2010-04-13 02:19:02.026883423 +0000
@@ -158,7 +158,6 @@
 struct request {
 	struct list_head queuelist;
 	struct call_single_data csd;
-	int cpu;
 
 	struct request_queue *q;
 
@@ -166,9 +165,11 @@
 	enum rq_cmd_type_bits cmd_type;
 	unsigned long atomic_flags;
 
+	int cpu;
+
 	/* the following two fields are internal, NEVER access directly */
-	sector_t __sector;		/* sector cursor */
 	unsigned int __data_len;	/* total data len */
+	sector_t __sector;		/* sector cursor */
 
 	struct bio *bio;
 	struct bio *biotail;
@@ -201,20 +202,20 @@
 
 	unsigned short ioprio;
 
+	int ref_count;
+
 	void *special;		/* opaque pointer available for LLD use */
 	char *buffer;		/* kaddr of the current segment if available */
 
 	int tag;
 	int errors;
 
-	int ref_count;
-
 	/*
 	 * when request is used as a packet command carrier
 	 */
-	unsigned short cmd_len;
 	unsigned char __cmd[BLK_MAX_CDB];
 	unsigned char *cmd;
+	unsigned short cmd_len;
 
 	unsigned int extra_len;	/* length of alignment and padding */
 	unsigned int sense_len;
@@ -921,26 +922,7 @@
 extern void blk_queue_make_request(struct request_queue *, make_request_fn *);
 extern void blk_queue_bounce_limit(struct request_queue *, u64);
 extern void blk_queue_max_hw_sectors(struct request_queue *, unsigned int);
-
-/* Temporary compatibility wrapper */
-static inline void blk_queue_max_sectors(struct request_queue *q, unsigned int max)
-{
-	blk_queue_max_hw_sectors(q, max);
-}
-
 extern void blk_queue_max_segments(struct request_queue *, unsigned short);
-
-static inline void blk_queue_max_phys_segments(struct request_queue *q, unsigned short max)
-{
-	blk_queue_max_segments(q, max);
-}
-
-static inline void blk_queue_max_hw_segments(struct request_queue *q, unsigned short max)
-{
-	blk_queue_max_segments(q, max);
-}
-
-
 extern void blk_queue_max_segment_size(struct request_queue *, unsigned int);
 extern void blk_queue_max_discard_sectors(struct request_queue *q,
 		unsigned int max_discard_sectors);
@@ -1030,11 +1012,6 @@
 
 extern int blk_verify_command(unsigned char *cmd, fmode_t has_write_perm);
 
-#define MAX_PHYS_SEGMENTS 128
-#define MAX_HW_SEGMENTS 128
-#define SAFE_MAX_SECTORS 255
-#define MAX_SEGMENT_SIZE	65536
-
 enum blk_default_limits {
 	BLK_MAX_SEGMENTS	= 128,
 	BLK_SAFE_MAX_SECTORS	= 255,
diff -urN linux-2.6.34-rc3/include/linux/delayacct.h linux-2.6.34-rc4/include/linux/delayacct.h
--- linux-2.6.34-rc3/include/linux/delayacct.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/delayacct.h	2010-04-13 02:19:02.029883644 +0000
@@ -18,6 +18,7 @@
 #define _LINUX_DELAYACCT_H
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 /*
  * Per-task flags relevant to delay accounting
diff -urN linux-2.6.34-rc3/include/linux/drbd.h linux-2.6.34-rc4/include/linux/drbd.h
--- linux-2.6.34-rc3/include/linux/drbd.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/drbd.h	2010-04-13 02:19:02.031884228 +0000
@@ -56,7 +56,7 @@
 #define REL_VERSION "8.3.7"
 #define API_VERSION 88
 #define PRO_VERSION_MIN 86
-#define PRO_VERSION_MAX 91
+#define PRO_VERSION_MAX 92
 
 
 enum drbd_io_error_p {
diff -urN linux-2.6.34-rc3/include/linux/drbd_nl.h linux-2.6.34-rc4/include/linux/drbd_nl.h
--- linux-2.6.34-rc3/include/linux/drbd_nl.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/drbd_nl.h	2010-04-13 02:19:02.031884228 +0000
@@ -12,7 +12,7 @@
 #endif
 
 NL_PACKET(primary, 1,
-       NL_BIT(		1,	T_MAY_IGNORE,	overwrite_peer)
+       NL_BIT(		1,	T_MAY_IGNORE,	primary_force)
 )
 
 NL_PACKET(secondary, 2, )
@@ -63,6 +63,7 @@
 	NL_BIT(		41,	T_MAY_IGNORE,	always_asbp)
 	NL_BIT(		61,	T_MAY_IGNORE,	no_cork)
 	NL_BIT(		62,	T_MANDATORY,	auto_sndbuf_size)
+	NL_BIT(		70,	T_MANDATORY,	dry_run)
 )
 
 NL_PACKET(disconnect, 6, )
diff -urN linux-2.6.34-rc3/include/linux/freezer.h linux-2.6.34-rc4/include/linux/freezer.h
--- linux-2.6.34-rc3/include/linux/freezer.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/freezer.h	2010-04-13 02:19:02.034883619 +0000
@@ -64,9 +64,12 @@
 extern void cancel_freezing(struct task_struct *p);
 
 #ifdef CONFIG_CGROUP_FREEZER
-extern int cgroup_frozen(struct task_struct *task);
+extern int cgroup_freezing_or_frozen(struct task_struct *task);
 #else /* !CONFIG_CGROUP_FREEZER */
-static inline int cgroup_frozen(struct task_struct *task) { return 0; }
+static inline int cgroup_freezing_or_frozen(struct task_struct *task)
+{
+	return 0;
+}
 #endif /* !CONFIG_CGROUP_FREEZER */
 
 /*
diff -urN linux-2.6.34-rc3/include/linux/fs.h linux-2.6.34-rc4/include/linux/fs.h
--- linux-2.6.34-rc3/include/linux/fs.h	2010-04-13 02:18:56.601570355 +0000
+++ linux-2.6.34-rc4/include/linux/fs.h	2010-04-13 02:19:02.034883619 +0000
@@ -2212,6 +2212,7 @@
 /* fs/block_dev.c */
 extern ssize_t blkdev_aio_write(struct kiocb *iocb, const struct iovec *iov,
 				unsigned long nr_segs, loff_t pos);
+extern int blkdev_fsync(struct file *filp, struct dentry *dentry, int datasync);
 
 /* fs/splice.c */
 extern ssize_t generic_file_splice_read(struct file *, loff_t *,
diff -urN linux-2.6.34-rc3/include/linux/fsnotify.h linux-2.6.34-rc4/include/linux/fsnotify.h
--- linux-2.6.34-rc3/include/linux/fsnotify.h	2010-04-13 02:18:56.601570355 +0000
+++ linux-2.6.34-rc4/include/linux/fsnotify.h	2010-04-13 02:19:02.035883738 +0000
@@ -15,6 +15,7 @@
 #include <linux/inotify.h>
 #include <linux/fsnotify_backend.h>
 #include <linux/audit.h>
+#include <linux/slab.h>
 
 /*
  * fsnotify_d_instantiate - instantiate a dentry for inode
diff -urN linux-2.6.34-rc3/include/linux/gameport.h linux-2.6.34-rc4/include/linux/gameport.h
--- linux-2.6.34-rc3/include/linux/gameport.h	2010-04-13 02:18:56.602633063 +0000
+++ linux-2.6.34-rc4/include/linux/gameport.h	2010-04-13 02:19:02.035883738 +0000
@@ -16,6 +16,7 @@
 #include <linux/mutex.h>
 #include <linux/device.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 
 struct gameport {
 
diff -urN linux-2.6.34-rc3/include/linux/genhd.h linux-2.6.34-rc4/include/linux/genhd.h
--- linux-2.6.34-rc3/include/linux/genhd.h	2010-04-13 02:18:56.602633063 +0000
+++ linux-2.6.34-rc4/include/linux/genhd.h	2010-04-13 02:19:02.035883738 +0000
@@ -109,7 +109,7 @@
 };
 
 #define GENHD_FL_REMOVABLE			1
-#define GENHD_FL_DRIVERFS			2
+/* 2 is unused */
 #define GENHD_FL_MEDIA_CHANGE_NOTIFY		4
 #define GENHD_FL_CD				8
 #define GENHD_FL_UP				16
diff -urN linux-2.6.34-rc3/include/linux/i2o.h linux-2.6.34-rc4/include/linux/i2o.h
--- linux-2.6.34-rc3/include/linux/i2o.h	2010-04-13 02:18:56.604633020 +0000
+++ linux-2.6.34-rc4/include/linux/i2o.h	2010-04-13 02:19:02.038883171 +0000
@@ -782,7 +782,6 @@
 #define to_i2o_driver(drv) container_of(drv,struct i2o_driver, driver)
 #define to_i2o_device(dev) container_of(dev, struct i2o_device, device)
 #define to_i2o_controller(dev) container_of(dev, struct i2o_controller, device)
-#define kobj_to_i2o_device(kobj) to_i2o_device(container_of(kobj, struct device, kobj))
 
 /**
  *	i2o_out_to_virt - Turn an I2O message to a virtual address
diff -urN linux-2.6.34-rc3/include/linux/ide.h linux-2.6.34-rc4/include/linux/ide.h
--- linux-2.6.34-rc3/include/linux/ide.h	2010-04-13 02:18:56.604633020 +0000
+++ linux-2.6.34-rc4/include/linux/ide.h	2010-04-13 02:19:02.039883650 +0000
@@ -1169,6 +1169,7 @@
 extern void ide_timer_expiry(unsigned long);
 extern irqreturn_t ide_intr(int irq, void *dev_id);
 extern void do_ide_request(struct request_queue *);
+extern void ide_requeue_and_plug(ide_drive_t *drive, struct request *rq);
 
 void ide_init_disk(struct gendisk *, ide_drive_t *);
 
diff -urN linux-2.6.34-rc3/include/linux/io-mapping.h linux-2.6.34-rc4/include/linux/io-mapping.h
--- linux-2.6.34-rc3/include/linux/io-mapping.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/io-mapping.h	2010-04-13 02:19:02.041883824 +0000
@@ -19,6 +19,7 @@
 #define _LINUX_IO_MAPPING_H
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <asm/page.h>
 #include <asm/iomap.h>
diff -urN linux-2.6.34-rc3/include/linux/iscsi_ibft.h linux-2.6.34-rc4/include/linux/iscsi_ibft.h
--- linux-2.6.34-rc3/include/linux/iscsi_ibft.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/iscsi_ibft.h	2010-04-13 02:19:02.042883569 +0000
@@ -42,9 +42,13 @@
  * mapped address is set in the ibft_addr variable.
  */
 #ifdef CONFIG_ISCSI_IBFT_FIND
-extern void __init reserve_ibft_region(void);
+unsigned long find_ibft_region(unsigned long *sizep);
 #else
-static inline void reserve_ibft_region(void) { }
+static inline unsigned long find_ibft_region(unsigned long *sizep)
+{
+	*sizep = 0;
+	return 0;
+}
 #endif
 
 #endif /* ISCSI_IBFT_H */
diff -urN linux-2.6.34-rc3/include/linux/jbd.h linux-2.6.34-rc4/include/linux/jbd.h
--- linux-2.6.34-rc3/include/linux/jbd.h	2010-04-13 02:18:56.606633047 +0000
+++ linux-2.6.34-rc4/include/linux/jbd.h	2010-04-13 02:19:02.042883569 +0000
@@ -31,6 +31,7 @@
 #include <linux/mutex.h>
 #include <linux/timer.h>
 #include <linux/lockdep.h>
+#include <linux/slab.h>
 
 #define journal_oom_retry 1
 
diff -urN linux-2.6.34-rc3/include/linux/jbd2.h linux-2.6.34-rc4/include/linux/jbd2.h
--- linux-2.6.34-rc3/include/linux/jbd2.h	2010-04-13 02:18:56.606633047 +0000
+++ linux-2.6.34-rc4/include/linux/jbd2.h	2010-04-13 02:19:02.043883376 +0000
@@ -30,6 +30,7 @@
 #include <linux/bit_spinlock.h>
 #include <linux/mutex.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #endif
 
 #define journal_oom_retry 1
diff -urN linux-2.6.34-rc3/include/linux/kernel.h linux-2.6.34-rc4/include/linux/kernel.h
--- linux-2.6.34-rc3/include/linux/kernel.h	2010-04-13 02:18:56.607633007 +0000
+++ linux-2.6.34-rc4/include/linux/kernel.h	2010-04-13 02:19:02.043883376 +0000
@@ -426,7 +426,7 @@
 		.burst = DEFAULT_RATELIMIT_BURST,       \
 	};                                              \
 							\
-	if (!__ratelimit(&_rs))                         \
+	if (__ratelimit(&_rs))                          \
 		printk(fmt, ##__VA_ARGS__);		\
 })
 #else
diff -urN linux-2.6.34-rc3/include/linux/kfifo.h linux-2.6.34-rc4/include/linux/kfifo.h
--- linux-2.6.34-rc3/include/linux/kfifo.h	2010-04-13 02:18:56.607633007 +0000
+++ linux-2.6.34-rc4/include/linux/kfifo.h	2010-04-13 02:19:02.044884138 +0000
@@ -86,7 +86,8 @@
  */
 #define INIT_KFIFO(name) \
 	name = __kfifo_initializer(sizeof(name##kfifo_buffer) - \
-				sizeof(struct kfifo), name##kfifo_buffer)
+				sizeof(struct kfifo), \
+				name##kfifo_buffer + sizeof(struct kfifo))
 
 /**
  * DEFINE_KFIFO - macro to define and initialize a kfifo
diff -urN linux-2.6.34-rc3/include/linux/lcm.h linux-2.6.34-rc4/include/linux/lcm.h
--- linux-2.6.34-rc3/include/linux/lcm.h	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/lcm.h	2010-04-13 02:19:02.045883766 +0000
@@ -0,0 +1,8 @@
+#ifndef _LCM_H
+#define _LCM_H
+
+#include <linux/compiler.h>
+
+unsigned long lcm(unsigned long a, unsigned long b) __attribute_const__;
+
+#endif /* _LCM_H */
diff -urN linux-2.6.34-rc3/include/linux/libata.h linux-2.6.34-rc4/include/linux/libata.h
--- linux-2.6.34-rc3/include/linux/libata.h	2010-04-13 02:18:56.608633043 +0000
+++ linux-2.6.34-rc4/include/linux/libata.h	2010-04-13 02:19:02.045883766 +0000
@@ -146,6 +146,7 @@
 	ATA_DFLAG_SLEEPING	= (1 << 15), /* device is sleeping */
 	ATA_DFLAG_DUBIOUS_XFER	= (1 << 16), /* data transfer not verified */
 	ATA_DFLAG_NO_UNLOAD	= (1 << 17), /* device doesn't support unload */
+	ATA_DFLAG_UNLOCK_HPA	= (1 << 18), /* unlock HPA */
 	ATA_DFLAG_INIT_MASK	= (1 << 24) - 1,
 
 	ATA_DFLAG_DETACH	= (1 << 24),
diff -urN linux-2.6.34-rc3/include/linux/mm.h linux-2.6.34-rc4/include/linux/mm.h
--- linux-2.6.34-rc3/include/linux/mm.h	2010-04-13 02:18:56.614633096 +0000
+++ linux-2.6.34-rc4/include/linux/mm.h	2010-04-13 02:19:02.055883736 +0000
@@ -783,8 +783,8 @@
 	int (*pmd_entry)(pmd_t *, unsigned long, unsigned long, struct mm_walk *);
 	int (*pte_entry)(pte_t *, unsigned long, unsigned long, struct mm_walk *);
 	int (*pte_hole)(unsigned long, unsigned long, struct mm_walk *);
-	int (*hugetlb_entry)(pte_t *, unsigned long, unsigned long,
-			     struct mm_walk *);
+	int (*hugetlb_entry)(pte_t *, unsigned long,
+			     unsigned long, unsigned long, struct mm_walk *);
 	struct mm_struct *mm;
 	void *private;
 };
diff -urN linux-2.6.34-rc3/include/linux/module.h linux-2.6.34-rc4/include/linux/module.h
--- linux-2.6.34-rc3/include/linux/module.h	2010-04-13 02:18:56.615633026 +0000
+++ linux-2.6.34-rc4/include/linux/module.h	2010-04-13 02:19:02.057884201 +0000
@@ -330,8 +330,11 @@
 	struct module_notes_attrs *notes_attrs;
 #endif
 
+#ifdef CONFIG_SMP
 	/* Per-cpu data. */
-	void *percpu;
+	void __percpu *percpu;
+	unsigned int percpu_size;
+#endif
 
 	/* The command line arguments (may be mangled).  People like
 	   keeping pointers to this stuff */
@@ -365,7 +368,8 @@
 	void (*exit)(void);
 
 	struct module_ref {
-		int count;
+		unsigned int incs;
+		unsigned int decs;
 	} __percpu *refptr;
 #endif
 
@@ -392,6 +396,7 @@
 struct module *__module_text_address(unsigned long addr);
 struct module *__module_address(unsigned long addr);
 bool is_module_address(unsigned long addr);
+bool is_module_percpu_address(unsigned long addr);
 bool is_module_text_address(unsigned long addr);
 
 static inline int within_module_core(unsigned long addr, struct module *mod)
@@ -459,9 +464,9 @@
 {
 	if (module) {
 		preempt_disable();
-		__this_cpu_inc(module->refptr->count);
+		__this_cpu_inc(module->refptr->incs);
 		trace_module_get(module, _THIS_IP_,
-				 __this_cpu_read(module->refptr->count));
+				 __this_cpu_read(module->refptr->incs));
 		preempt_enable();
 	}
 }
@@ -474,11 +479,10 @@
 		preempt_disable();
 
 		if (likely(module_is_live(module))) {
-			__this_cpu_inc(module->refptr->count);
+			__this_cpu_inc(module->refptr->incs);
 			trace_module_get(module, _THIS_IP_,
-				__this_cpu_read(module->refptr->count));
-		}
-		else
+				__this_cpu_read(module->refptr->incs));
+		} else
 			ret = 0;
 
 		preempt_enable();
@@ -563,6 +567,11 @@
 	return false;
 }
 
+static inline bool is_module_percpu_address(unsigned long addr)
+{
+	return false;
+}
+
 static inline bool is_module_text_address(unsigned long addr)
 {
 	return false;
diff -urN linux-2.6.34-rc3/include/linux/page_cgroup.h linux-2.6.34-rc4/include/linux/page_cgroup.h
--- linux-2.6.34-rc3/include/linux/page_cgroup.h	2010-04-13 02:18:56.619570944 +0000
+++ linux-2.6.34-rc4/include/linux/page_cgroup.h	2010-04-13 02:19:02.063883323 +0000
@@ -39,6 +39,7 @@
 	PCG_CACHE, /* charged as cache */
 	PCG_USED, /* this object is in use. */
 	PCG_ACCT_LRU, /* page has been accounted for */
+	PCG_FILE_MAPPED, /* page is accounted as "mapped" */
 };
 
 #define TESTPCGFLAG(uname, lname)			\
@@ -73,6 +74,11 @@
 TESTPCGFLAG(AcctLRU, ACCT_LRU)
 TESTCLEARPCGFLAG(AcctLRU, ACCT_LRU)
 
+
+SETPCGFLAG(FileMapped, FILE_MAPPED)
+CLEARPCGFLAG(FileMapped, FILE_MAPPED)
+TESTPCGFLAG(FileMapped, FILE_MAPPED)
+
 static inline int page_cgroup_nid(struct page_cgroup *pc)
 {
 	return page_to_nid(pc->page);
diff -urN linux-2.6.34-rc3/include/linux/percpu.h linux-2.6.34-rc4/include/linux/percpu.h
--- linux-2.6.34-rc3/include/linux/percpu.h	2010-04-13 02:18:56.621570629 +0000
+++ linux-2.6.34-rc4/include/linux/percpu.h	2010-04-13 02:19:02.066883460 +0000
@@ -2,10 +2,10 @@
 #define __LINUX_PERCPU_H
 
 #include <linux/preempt.h>
-#include <linux/slab.h> /* For kmalloc() */
 #include <linux/smp.h>
 #include <linux/cpumask.h>
 #include <linux/pfn.h>
+#include <linux/init.h>
 
 #include <asm/percpu.h>
 
@@ -135,9 +135,7 @@
 #define per_cpu_ptr(ptr, cpu)	SHIFT_PERCPU_PTR((ptr), per_cpu_offset((cpu)))
 
 extern void __percpu *__alloc_reserved_percpu(size_t size, size_t align);
-extern void __percpu *__alloc_percpu(size_t size, size_t align);
-extern void free_percpu(void __percpu *__pdata);
-extern phys_addr_t per_cpu_ptr_to_phys(void *addr);
+extern bool is_kernel_percpu_address(unsigned long addr);
 
 #ifndef CONFIG_HAVE_SETUP_PER_CPU_AREA
 extern void __init setup_per_cpu_areas(void);
@@ -147,25 +145,10 @@
 
 #define per_cpu_ptr(ptr, cpu) ({ (void)(cpu); (ptr); })
 
-static inline void __percpu *__alloc_percpu(size_t size, size_t align)
+/* can't distinguish from other static vars, always false */
+static inline bool is_kernel_percpu_address(unsigned long addr)
 {
-	/*
-	 * Can't easily make larger alignment work with kmalloc.  WARN
-	 * on it.  Larger alignment should only be used for module
-	 * percpu sections on SMP for which this path isn't used.
-	 */
-	WARN_ON_ONCE(align > SMP_CACHE_BYTES);
-	return kzalloc(size, GFP_KERNEL);
-}
-
-static inline void free_percpu(void __percpu *p)
-{
-	kfree(p);
-}
-
-static inline phys_addr_t per_cpu_ptr_to_phys(void *addr)
-{
-	return __pa(addr);
+	return false;
 }
 
 static inline void __init setup_per_cpu_areas(void) { }
@@ -177,6 +160,10 @@
 
 #endif /* CONFIG_SMP */
 
+extern void __percpu *__alloc_percpu(size_t size, size_t align);
+extern void free_percpu(void __percpu *__pdata);
+extern phys_addr_t per_cpu_ptr_to_phys(void *addr);
+
 #define alloc_percpu(type)	\
 	(typeof(type) __percpu *)__alloc_percpu(sizeof(type), __alignof__(type))
 
diff -urN linux-2.6.34-rc3/include/linux/perf_event.h linux-2.6.34-rc4/include/linux/perf_event.h
--- linux-2.6.34-rc3/include/linux/perf_event.h	2010-04-13 02:18:56.621570629 +0000
+++ linux-2.6.34-rc4/include/linux/perf_event.h	2010-04-13 02:19:02.066883460 +0000
@@ -842,13 +842,6 @@
 
 extern void __perf_sw_event(u32, u64, int, struct pt_regs *, u64);
 
-static inline void
-perf_sw_event(u32 event_id, u64 nr, int nmi, struct pt_regs *regs, u64 addr)
-{
-	if (atomic_read(&perf_swevent_enabled[event_id]))
-		__perf_sw_event(event_id, nr, nmi, regs, addr);
-}
-
 extern void
 perf_arch_fetch_caller_regs(struct pt_regs *regs, unsigned long ip, int skip);
 
@@ -887,6 +880,20 @@
 	return perf_arch_fetch_caller_regs(regs, ip, skip);
 }
 
+static inline void
+perf_sw_event(u32 event_id, u64 nr, int nmi, struct pt_regs *regs, u64 addr)
+{
+	if (atomic_read(&perf_swevent_enabled[event_id])) {
+		struct pt_regs hot_regs;
+
+		if (!regs) {
+			perf_fetch_caller_regs(&hot_regs, 1);
+			regs = &hot_regs;
+		}
+		__perf_sw_event(event_id, nr, nmi, regs, addr);
+	}
+}
+
 extern void __perf_event_mmap(struct vm_area_struct *vma);
 
 static inline void perf_event_mmap(struct vm_area_struct *vma)
diff -urN linux-2.6.34-rc3/include/linux/radix-tree.h linux-2.6.34-rc4/include/linux/radix-tree.h
--- linux-2.6.34-rc3/include/linux/radix-tree.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/radix-tree.h	2010-04-13 02:19:02.069883547 +0000
@@ -121,6 +121,13 @@
  * (Note, rcu_assign_pointer and rcu_dereference are not needed to control
  * access to data items when inserting into or looking up from the radix tree)
  *
+ * Note that the value returned by radix_tree_tag_get() may not be relied upon
+ * if only the RCU read lock is held.  Functions to set/clear tags and to
+ * delete nodes running concurrently with it may affect its result such that
+ * two consecutive reads in the same locked section may return different
+ * values.  If reliability is required, modification functions must also be
+ * excluded from concurrency.
+ *
  * radix_tree_tagged is able to be called without locking or RCU.
  */
 
diff -urN linux-2.6.34-rc3/include/linux/security.h linux-2.6.34-rc4/include/linux/security.h
--- linux-2.6.34-rc3/include/linux/security.h	2010-04-13 02:18:56.626633077 +0000
+++ linux-2.6.34-rc4/include/linux/security.h	2010-04-13 02:19:02.074883812 +0000
@@ -33,7 +33,7 @@
 #include <linux/sched.h>
 #include <linux/key.h>
 #include <linux/xfrm.h>
-#include <linux/gfp.h>
+#include <linux/slab.h>
 #include <net/flow.h>
 
 /* Maximum number of letters for an LSM name string */
diff -urN linux-2.6.34-rc3/include/linux/slab.h linux-2.6.34-rc4/include/linux/slab.h
--- linux-2.6.34-rc3/include/linux/slab.h	2010-04-13 02:18:56.627633065 +0000
+++ linux-2.6.34-rc4/include/linux/slab.h	2010-04-13 02:19:02.076883674 +0000
@@ -106,6 +106,7 @@
 void kmem_cache_free(struct kmem_cache *, void *);
 unsigned int kmem_cache_size(struct kmem_cache *);
 const char *kmem_cache_name(struct kmem_cache *);
+int kern_ptr_validate(const void *ptr, unsigned long size);
 int kmem_ptr_validate(struct kmem_cache *cachep, const void *ptr);
 
 /*
diff -urN linux-2.6.34-rc3/include/linux/spi/spi.h linux-2.6.34-rc4/include/linux/spi/spi.h
--- linux-2.6.34-rc3/include/linux/spi/spi.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/spi/spi.h	2010-04-13 02:19:02.077883919 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/device.h>
 #include <linux/mod_devicetable.h>
+#include <linux/slab.h>
 
 /*
  * INTERFACES between SPI master-side drivers and SPI infrastructure.
diff -urN linux-2.6.34-rc3/include/linux/taskstats_kern.h linux-2.6.34-rc4/include/linux/taskstats_kern.h
--- linux-2.6.34-rc3/include/linux/taskstats_kern.h	2010-04-13 02:18:56.629571689 +0000
+++ linux-2.6.34-rc4/include/linux/taskstats_kern.h	2010-04-13 02:19:02.079632637 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/taskstats.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_TASKSTATS
 extern struct kmem_cache *taskstats_cache;
diff -urN linux-2.6.34-rc3/include/linux/usb/gadget.h linux-2.6.34-rc4/include/linux/usb/gadget.h
--- linux-2.6.34-rc3/include/linux/usb/gadget.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/usb/gadget.h	2010-04-13 02:19:02.082884161 +0000
@@ -15,6 +15,8 @@
 #ifndef __LINUX_USB_GADGET_H
 #define __LINUX_USB_GADGET_H
 
+#include <linux/slab.h>
+
 struct usb_ep;
 
 /**
diff -urN linux-2.6.34-rc3/include/linux/virtio_console.h linux-2.6.34-rc4/include/linux/virtio_console.h
--- linux-2.6.34-rc3/include/linux/virtio_console.h	2010-04-13 02:18:56.632633070 +0000
+++ linux-2.6.34-rc4/include/linux/virtio_console.h	2010-04-13 02:19:02.085883641 +0000
@@ -12,37 +12,14 @@
 
 /* Feature bits */
 #define VIRTIO_CONSOLE_F_SIZE	0	/* Does host provide console size? */
-#define VIRTIO_CONSOLE_F_MULTIPORT 1	/* Does host provide multiple ports? */
 
 struct virtio_console_config {
 	/* colums of the screens */
 	__u16 cols;
 	/* rows of the screens */
 	__u16 rows;
-	/* max. number of ports this device can hold */
-	__u32 max_nr_ports;
-	/* number of ports added so far */
-	__u32 nr_ports;
 } __attribute__((packed));
 
-/*
- * A message that's passed between the Host and the Guest for a
- * particular port.
- */
-struct virtio_console_control {
-	__u32 id;		/* Port number */
-	__u16 event;		/* The kind of control event (see below) */
-	__u16 value;		/* Extra information for the key */
-};
-
-/* Some events for control messages */
-#define VIRTIO_CONSOLE_PORT_READY	0
-#define VIRTIO_CONSOLE_CONSOLE_PORT	1
-#define VIRTIO_CONSOLE_RESIZE		2
-#define VIRTIO_CONSOLE_PORT_OPEN	3
-#define VIRTIO_CONSOLE_PORT_NAME	4
-#define VIRTIO_CONSOLE_PORT_REMOVE	5
-
 #ifdef __KERNEL__
 int __init virtio_cons_early_init(int (*put_chars)(u32, const char *, int));
 #endif /* __KERNEL__ */
diff -urN linux-2.6.34-rc3/include/linux/wimax/debug.h linux-2.6.34-rc4/include/linux/wimax/debug.h
--- linux-2.6.34-rc3/include/linux/wimax/debug.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/wimax/debug.h	2010-04-13 02:19:02.085883641 +0000
@@ -155,6 +155,7 @@
 
 #include <linux/types.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 
 
 /* Backend stuff */
diff -urN linux-2.6.34-rc3/include/linux/writeback.h linux-2.6.34-rc4/include/linux/writeback.h
--- linux-2.6.34-rc3/include/linux/writeback.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/linux/writeback.h	2010-04-13 02:19:02.085883641 +0000
@@ -34,6 +34,9 @@
 	enum writeback_sync_modes sync_mode;
 	unsigned long *older_than_this;	/* If !NULL, only write back inodes
 					   older than this */
+	unsigned long wb_start;         /* Time writeback_inodes_wb was
+					   called. This is needed to avoid
+					   extra jobs and livelock */
 	long nr_to_write;		/* Write this many pages, and decrement
 					   this for each page written */
 	long pages_skipped;		/* Pages which were not written */
diff -urN linux-2.6.34-rc3/include/net/9p/client.h linux-2.6.34-rc4/include/net/9p/client.h
--- linux-2.6.34-rc3/include/net/9p/client.h	2010-04-13 02:18:56.634633045 +0000
+++ linux-2.6.34-rc4/include/net/9p/client.h	2010-04-13 02:19:02.088883686 +0000
@@ -54,6 +54,7 @@
 
 enum p9_trans_status {
 	Connected,
+	BeginDisconnect,
 	Disconnected,
 	Hung,
 };
@@ -198,6 +199,7 @@
 struct p9_client *p9_client_create(const char *dev_name, char *options);
 void p9_client_destroy(struct p9_client *clnt);
 void p9_client_disconnect(struct p9_client *clnt);
+void p9_client_begin_disconnect(struct p9_client *clnt);
 struct p9_fid *p9_client_attach(struct p9_client *clnt, struct p9_fid *afid,
 					char *uname, u32 n_uname, char *aname);
 struct p9_fid *p9_client_auth(struct p9_client *clnt, char *uname,
diff -urN linux-2.6.34-rc3/include/net/ax25.h linux-2.6.34-rc4/include/net/ax25.h
--- linux-2.6.34-rc3/include/net/ax25.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/ax25.h	2010-04-13 02:19:02.088883686 +0000
@@ -10,6 +10,7 @@
 #include <linux/spinlock.h>
 #include <linux/timer.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 
 #define	AX25_T1CLAMPLO  		1
diff -urN linux-2.6.34-rc3/include/net/fib_rules.h linux-2.6.34-rc4/include/net/fib_rules.h
--- linux-2.6.34-rc3/include/net/fib_rules.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/fib_rules.h	2010-04-13 02:19:02.090888821 +0000
@@ -2,6 +2,7 @@
 #define __NET_FIB_RULES_H
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/fib_rules.h>
 #include <net/flow.h>
diff -urN linux-2.6.34-rc3/include/net/ipx.h linux-2.6.34-rc4/include/net/ipx.h
--- linux-2.6.34-rc3/include/net/ipx.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/ipx.h	2010-04-13 02:19:02.092883076 +0000
@@ -13,6 +13,7 @@
 #include <net/datalink.h>
 #include <linux/ipx.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 struct ipx_address {
 	__be32  net;
diff -urN linux-2.6.34-rc3/include/net/iucv/iucv.h linux-2.6.34-rc4/include/net/iucv/iucv.h
--- linux-2.6.34-rc3/include/net/iucv/iucv.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/iucv/iucv.h	2010-04-13 02:19:02.092883076 +0000
@@ -28,6 +28,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <asm/debug.h>
 
 /*
diff -urN linux-2.6.34-rc3/include/net/netfilter/nf_conntrack_extend.h linux-2.6.34-rc4/include/net/netfilter/nf_conntrack_extend.h
--- linux-2.6.34-rc3/include/net/netfilter/nf_conntrack_extend.h	2010-04-13 02:18:56.639571683 +0000
+++ linux-2.6.34-rc4/include/net/netfilter/nf_conntrack_extend.h	2010-04-13 02:19:02.095890416 +0000
@@ -1,6 +1,8 @@
 #ifndef _NF_CONNTRACK_EXTEND_H
 #define _NF_CONNTRACK_EXTEND_H
 
+#include <linux/slab.h>
+
 #include <net/netfilter/nf_conntrack.h>
 
 enum nf_ct_ext_id {
diff -urN linux-2.6.34-rc3/include/net/netlabel.h linux-2.6.34-rc4/include/net/netlabel.h
--- linux-2.6.34-rc3/include/net/netlabel.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/netlabel.h	2010-04-13 02:19:02.096883570 +0000
@@ -31,6 +31,7 @@
 #define _NETLABEL_H
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/net.h>
 #include <linux/skbuff.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/include/net/netrom.h linux-2.6.34-rc4/include/net/netrom.h
--- linux-2.6.34-rc3/include/net/netrom.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/netrom.h	2010-04-13 02:19:02.097883755 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/netrom.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #define	NR_NETWORK_LEN			15
diff -urN linux-2.6.34-rc3/include/net/sock.h linux-2.6.34-rc4/include/net/sock.h
--- linux-2.6.34-rc3/include/net/sock.h	2010-04-13 02:18:56.640570534 +0000
+++ linux-2.6.34-rc4/include/net/sock.h	2010-04-13 02:19:02.098883383 +0000
@@ -51,6 +51,7 @@
 #include <linux/skbuff.h>	/* struct sk_buff */
 #include <linux/mm.h>
 #include <linux/security.h>
+#include <linux/slab.h>
 
 #include <linux/filter.h>
 #include <linux/rculist_nulls.h>
diff -urN linux-2.6.34-rc3/include/net/x25.h linux-2.6.34-rc4/include/net/x25.h
--- linux-2.6.34-rc3/include/net/x25.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/net/x25.h	2010-04-13 02:19:02.099885114 +0000
@@ -10,6 +10,7 @@
 #ifndef _X25_H
 #define _X25_H 
 #include <linux/x25.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #define	X25_ADDR_LEN			16
diff -urN linux-2.6.34-rc3/include/net/xfrm.h linux-2.6.34-rc4/include/net/xfrm.h
--- linux-2.6.34-rc3/include/net/xfrm.h	2010-04-13 02:18:56.641633047 +0000
+++ linux-2.6.34-rc4/include/net/xfrm.h	2010-04-13 02:19:02.100883887 +0000
@@ -12,6 +12,7 @@
 #include <linux/in6.h>
 #include <linux/mutex.h>
 #include <linux/audit.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <net/dst.h>
diff -urN linux-2.6.34-rc3/include/scsi/libsas.h linux-2.6.34-rc4/include/scsi/libsas.h
--- linux-2.6.34-rc3/include/scsi/libsas.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/scsi/libsas.h	2010-04-13 02:19:02.101883772 +0000
@@ -36,6 +36,7 @@
 #include <scsi/scsi_cmnd.h>
 #include <scsi/scsi_transport_sas.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 
 struct block_device;
 
diff -urN linux-2.6.34-rc3/include/sound/ak4113.h linux-2.6.34-rc4/include/sound/ak4113.h
--- linux-2.6.34-rc3/include/sound/ak4113.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/sound/ak4113.h	2010-04-13 02:19:02.102883787 +0000
@@ -307,7 +307,7 @@
 
 int snd_ak4113_create(struct snd_card *card, ak4113_read_t *read,
 		ak4113_write_t *write,
-		const unsigned char pgm[AK4113_WRITABLE_REGS],
+		const unsigned char *pgm,
 		void *private_data, struct ak4113 **r_ak4113);
 void snd_ak4113_reg_write(struct ak4113 *ak4113, unsigned char reg,
 		unsigned char mask, unsigned char val);
diff -urN linux-2.6.34-rc3/include/sound/soc-dai.h linux-2.6.34-rc4/include/sound/soc-dai.h
--- linux-2.6.34-rc3/include/sound/soc-dai.h	2010-04-13 02:18:56.643633052 +0000
+++ linux-2.6.34-rc4/include/sound/soc-dai.h	2010-04-13 02:19:02.103884153 +0000
@@ -219,7 +219,6 @@
 	struct snd_soc_codec *codec;
 	unsigned int active;
 	unsigned char pop_wait:1;
-	void *dma_data;
 
 	/* DAI private data */
 	void *private_data;
@@ -230,4 +229,21 @@
 	struct list_head list;
 };
 
+static inline void *snd_soc_dai_get_dma_data(const struct snd_soc_dai *dai,
+					     const struct snd_pcm_substream *ss)
+{
+	return (ss->stream == SNDRV_PCM_STREAM_PLAYBACK) ?
+		dai->playback.dma_data : dai->capture.dma_data;
+}
+
+static inline void snd_soc_dai_set_dma_data(struct snd_soc_dai *dai,
+					    const struct snd_pcm_substream *ss,
+					    void *data)
+{
+	if (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)
+		dai->playback.dma_data = data;
+	else
+		dai->capture.dma_data = data;
+}
+
 #endif
diff -urN linux-2.6.34-rc3/include/sound/soc.h linux-2.6.34-rc4/include/sound/soc.h
--- linux-2.6.34-rc3/include/sound/soc.h	2010-04-13 02:18:56.643633052 +0000
+++ linux-2.6.34-rc4/include/sound/soc.h	2010-04-13 02:19:02.104884089 +0000
@@ -375,6 +375,7 @@
 	unsigned int channels_min;	/* min channels */
 	unsigned int channels_max;	/* max channels */
 	unsigned int active:1;		/* stream is in use */
+	void *dma_data;			/* used by platform code */
 };
 
 /* SoC audio ops */
diff -urN linux-2.6.34-rc3/include/trace/events/block.h linux-2.6.34-rc4/include/trace/events/block.h
--- linux-2.6.34-rc3/include/trace/events/block.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/trace/events/block.h	2010-04-13 02:19:02.105883642 +0000
@@ -40,6 +40,16 @@
 		  __entry->nr_sector, __entry->errors)
 );
 
+/**
+ * block_rq_abort - abort block operation request
+ * @q: queue containing the block operation request
+ * @rq: block IO operation request
+ *
+ * Called immediately after pending block IO operation request @rq in
+ * queue @q is aborted. The fields in the operation request @rq
+ * can be examined to determine which device and sectors the pending
+ * operation would access.
+ */
 DEFINE_EVENT(block_rq_with_error, block_rq_abort,
 
 	TP_PROTO(struct request_queue *q, struct request *rq),
@@ -47,6 +57,15 @@
 	TP_ARGS(q, rq)
 );
 
+/**
+ * block_rq_requeue - place block IO request back on a queue
+ * @q: queue holding operation
+ * @rq: block IO operation request
+ *
+ * The block operation request @rq is being placed back into queue
+ * @q.  For some reason the request was not completed and needs to be
+ * put back in the queue.
+ */
 DEFINE_EVENT(block_rq_with_error, block_rq_requeue,
 
 	TP_PROTO(struct request_queue *q, struct request *rq),
@@ -54,6 +73,17 @@
 	TP_ARGS(q, rq)
 );
 
+/**
+ * block_rq_complete - block IO operation completed by device driver
+ * @q: queue containing the block operation request
+ * @rq: block operations request
+ *
+ * The block_rq_complete tracepoint event indicates that some portion
+ * of operation request has been completed by the device driver.  If
+ * the @rq->bio is %NULL, then there is absolutely no additional work to
+ * do for the request. If @rq->bio is non-NULL then there is
+ * additional work required to complete the request.
+ */
 DEFINE_EVENT(block_rq_with_error, block_rq_complete,
 
 	TP_PROTO(struct request_queue *q, struct request *rq),
@@ -95,6 +125,16 @@
 		  __entry->nr_sector, __entry->comm)
 );
 
+/**
+ * block_rq_insert - insert block operation request into queue
+ * @q: target queue
+ * @rq: block IO operation request
+ *
+ * Called immediately before block operation request @rq is inserted
+ * into queue @q.  The fields in the operation request @rq struct can
+ * be examined to determine which device and sectors the pending
+ * operation would access.
+ */
 DEFINE_EVENT(block_rq, block_rq_insert,
 
 	TP_PROTO(struct request_queue *q, struct request *rq),
@@ -102,6 +142,14 @@
 	TP_ARGS(q, rq)
 );
 
+/**
+ * block_rq_issue - issue pending block IO request operation to device driver
+ * @q: queue holding operation
+ * @rq: block IO operation operation request
+ *
+ * Called when block operation request @rq from queue @q is sent to a
+ * device driver for processing.
+ */
 DEFINE_EVENT(block_rq, block_rq_issue,
 
 	TP_PROTO(struct request_queue *q, struct request *rq),
@@ -109,6 +157,17 @@
 	TP_ARGS(q, rq)
 );
 
+/**
+ * block_bio_bounce - used bounce buffer when processing block operation
+ * @q: queue holding the block operation
+ * @bio: block operation
+ *
+ * A bounce buffer was used to handle the block operation @bio in @q.
+ * This occurs when hardware limitations prevent a direct transfer of
+ * data between the @bio data memory area and the IO device.  Use of a
+ * bounce buffer requires extra copying of data and decreases
+ * performance.
+ */
 TRACE_EVENT(block_bio_bounce,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio),
@@ -138,6 +197,14 @@
 		  __entry->nr_sector, __entry->comm)
 );
 
+/**
+ * block_bio_complete - completed all work on the block operation
+ * @q: queue holding the block operation
+ * @bio: block operation completed
+ *
+ * This tracepoint indicates there is no further work to do on this
+ * block IO operation @bio.
+ */
 TRACE_EVENT(block_bio_complete,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio),
@@ -193,6 +260,14 @@
 		  __entry->nr_sector, __entry->comm)
 );
 
+/**
+ * block_bio_backmerge - merging block operation to the end of an existing operation
+ * @q: queue holding operation
+ * @bio: new block operation to merge
+ *
+ * Merging block request @bio to the end of an existing block request
+ * in queue @q.
+ */
 DEFINE_EVENT(block_bio, block_bio_backmerge,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio),
@@ -200,6 +275,14 @@
 	TP_ARGS(q, bio)
 );
 
+/**
+ * block_bio_frontmerge - merging block operation to the beginning of an existing operation
+ * @q: queue holding operation
+ * @bio: new block operation to merge
+ *
+ * Merging block IO operation @bio to the beginning of an existing block
+ * operation in queue @q.
+ */
 DEFINE_EVENT(block_bio, block_bio_frontmerge,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio),
@@ -207,6 +290,13 @@
 	TP_ARGS(q, bio)
 );
 
+/**
+ * block_bio_queue - putting new block IO operation in queue
+ * @q: queue holding operation
+ * @bio: new block operation
+ *
+ * About to place the block IO operation @bio into queue @q.
+ */
 DEFINE_EVENT(block_bio, block_bio_queue,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio),
@@ -243,6 +333,15 @@
 		  __entry->nr_sector, __entry->comm)
 );
 
+/**
+ * block_getrq - get a free request entry in queue for block IO operations
+ * @q: queue for operations
+ * @bio: pending block IO operation
+ * @rw: low bit indicates a read (%0) or a write (%1)
+ *
+ * A request struct for queue @q has been allocated to handle the
+ * block IO operation @bio.
+ */
 DEFINE_EVENT(block_get_rq, block_getrq,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio, int rw),
@@ -250,6 +349,17 @@
 	TP_ARGS(q, bio, rw)
 );
 
+/**
+ * block_sleeprq - waiting to get a free request entry in queue for block IO operation
+ * @q: queue for operation
+ * @bio: pending block IO operation
+ * @rw: low bit indicates a read (%0) or a write (%1)
+ *
+ * In the case where a request struct cannot be provided for queue @q
+ * the process needs to wait for an request struct to become
+ * available.  This tracepoint event is generated each time the
+ * process goes to sleep waiting for request struct become available.
+ */
 DEFINE_EVENT(block_get_rq, block_sleeprq,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio, int rw),
@@ -257,6 +367,14 @@
 	TP_ARGS(q, bio, rw)
 );
 
+/**
+ * block_plug - keep operations requests in request queue
+ * @q: request queue to plug
+ *
+ * Plug the request queue @q.  Do not allow block operation requests
+ * to be sent to the device driver. Instead, accumulate requests in
+ * the queue to improve throughput performance of the block device.
+ */
 TRACE_EVENT(block_plug,
 
 	TP_PROTO(struct request_queue *q),
@@ -293,6 +411,13 @@
 	TP_printk("[%s] %d", __entry->comm, __entry->nr_rq)
 );
 
+/**
+ * block_unplug_timer - timed release of operations requests in queue to device driver
+ * @q: request queue to unplug
+ *
+ * Unplug the request queue @q because a timer expired and allow block
+ * operation requests to be sent to the device driver.
+ */
 DEFINE_EVENT(block_unplug, block_unplug_timer,
 
 	TP_PROTO(struct request_queue *q),
@@ -300,6 +425,13 @@
 	TP_ARGS(q)
 );
 
+/**
+ * block_unplug_io - release of operations requests in request queue
+ * @q: request queue to unplug
+ *
+ * Unplug request queue @q because device driver is scheduled to work
+ * on elements in the request queue.
+ */
 DEFINE_EVENT(block_unplug, block_unplug_io,
 
 	TP_PROTO(struct request_queue *q),
@@ -307,6 +439,17 @@
 	TP_ARGS(q)
 );
 
+/**
+ * block_split - split a single bio struct into two bio structs
+ * @q: queue containing the bio
+ * @bio: block operation being split
+ * @new_sector: The starting sector for the new bio
+ *
+ * The bio request @bio in request queue @q needs to be split into two
+ * bio requests. The newly created @bio request starts at
+ * @new_sector. This split may be required due to hardware limitation
+ * such as operation crossing device boundaries in a RAID system.
+ */
 TRACE_EVENT(block_split,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio,
@@ -337,6 +480,16 @@
 		  __entry->comm)
 );
 
+/**
+ * block_remap - map request for a partition to the raw device
+ * @q: queue holding the operation
+ * @bio: revised operation
+ * @dev: device for the operation
+ * @from: original sector for the operation
+ *
+ * An operation for a partition on a block device has been mapped to the
+ * raw block device.
+ */
 TRACE_EVENT(block_remap,
 
 	TP_PROTO(struct request_queue *q, struct bio *bio, dev_t dev,
@@ -370,6 +523,17 @@
 		  (unsigned long long)__entry->old_sector)
 );
 
+/**
+ * block_rq_remap - map request for a block operation request
+ * @q: queue holding the operation
+ * @rq: block IO operation request
+ * @dev: device for the operation
+ * @from: original sector for the operation
+ *
+ * The block operation request @rq in @q has been remapped.  The block
+ * operation request @rq holds the current information and @from hold
+ * the original sector.
+ */
 TRACE_EVENT(block_rq_remap,
 
 	TP_PROTO(struct request_queue *q, struct request *rq, dev_t dev,
diff -urN linux-2.6.34-rc3/include/xen/xenbus.h linux-2.6.34-rc4/include/xen/xenbus.h
--- linux-2.6.34-rc3/include/xen/xenbus.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/include/xen/xenbus.h	2010-04-13 02:19:02.107883708 +0000
@@ -39,6 +39,7 @@
 #include <linux/mutex.h>
 #include <linux/completion.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <xen/interface/xen.h>
 #include <xen/interface/grant_table.h>
 #include <xen/interface/io/xenbus.h>
diff -urN linux-2.6.34-rc3/init/do_mounts.c linux-2.6.34-rc4/init/do_mounts.c
--- linux-2.6.34-rc3/init/do_mounts.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/init/do_mounts.c	2010-04-13 02:19:02.108883302 +0000
@@ -15,6 +15,7 @@
 #include <linux/initrd.h>
 #include <linux/async.h>
 #include <linux/fs_struct.h>
+#include <linux/slab.h>
 
 #include <linux/nfs_fs.h>
 #include <linux/nfs_fs_sb.h>
diff -urN linux-2.6.34-rc3/init/do_mounts_rd.c linux-2.6.34-rc4/init/do_mounts_rd.c
--- linux-2.6.34-rc3/init/do_mounts_rd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/init/do_mounts_rd.c	2010-04-13 02:19:02.108883302 +0000
@@ -7,6 +7,7 @@
 #include <linux/cramfs_fs.h>
 #include <linux/initrd.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 
 #include "do_mounts.h"
 #include "../fs/squashfs/squashfs_fs.h"
diff -urN linux-2.6.34-rc3/init/main.c linux-2.6.34-rc4/init/main.c
--- linux-2.6.34-rc3/init/main.c	2010-04-13 02:18:56.646570439 +0000
+++ linux-2.6.34-rc4/init/main.c	2010-04-13 02:19:02.108883302 +0000
@@ -25,7 +25,6 @@
 #include <linux/bootmem.h>
 #include <linux/acpi.h>
 #include <linux/tty.h>
-#include <linux/gfp.h>
 #include <linux/percpu.h>
 #include <linux/kmod.h>
 #include <linux/vmalloc.h>
@@ -69,6 +68,7 @@
 #include <linux/kmemtrace.h>
 #include <linux/sfi.h>
 #include <linux/shmem_fs.h>
+#include <linux/slab.h>
 #include <trace/boot.h>
 
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/ipc/compat.c linux-2.6.34-rc4/ipc/compat.c
--- linux-2.6.34-rc3/ipc/compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/ipc/compat.c	2010-04-13 02:19:02.109884175 +0000
@@ -26,7 +26,6 @@
 #include <linux/init.h>
 #include <linux/msg.h>
 #include <linux/shm.h>
-#include <linux/slab.h>
 #include <linux/syscalls.h>
 
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/ipc/mqueue.c linux-2.6.34-rc4/ipc/mqueue.c
--- linux-2.6.34-rc3/ipc/mqueue.c	2010-04-13 02:18:56.646570439 +0000
+++ linux-2.6.34-rc4/ipc/mqueue.c	2010-04-13 02:19:02.109884175 +0000
@@ -32,6 +32,7 @@
 #include <linux/nsproxy.h>
 #include <linux/pid.h>
 #include <linux/ipc_namespace.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include "util.h"
diff -urN linux-2.6.34-rc3/ipc/msg.c linux-2.6.34-rc4/ipc/msg.c
--- linux-2.6.34-rc3/ipc/msg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/ipc/msg.c	2010-04-13 02:19:02.109884175 +0000
@@ -23,7 +23,6 @@
  */
 
 #include <linux/capability.h>
-#include <linux/slab.h>
 #include <linux/msg.h>
 #include <linux/spinlock.h>
 #include <linux/init.h>
diff -urN linux-2.6.34-rc3/kernel/async.c linux-2.6.34-rc4/kernel/async.c
--- linux-2.6.34-rc3/kernel/async.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/async.c	2010-04-13 02:19:02.110883737 +0000
@@ -56,6 +56,7 @@
 #include <linux/init.h>
 #include <linux/kthread.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 
 static async_cookie_t next_cookie = 1;
diff -urN linux-2.6.34-rc3/kernel/audit.c linux-2.6.34-rc4/kernel/audit.c
--- linux-2.6.34-rc3/kernel/audit.c	2010-04-13 02:18:56.647570538 +0000
+++ linux-2.6.34-rc4/kernel/audit.c	2010-04-13 02:19:02.111883245 +0000
@@ -46,6 +46,7 @@
 #include <asm/atomic.h>
 #include <linux/mm.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/kthread.h>
 
diff -urN linux-2.6.34-rc3/kernel/audit_tree.c linux-2.6.34-rc4/kernel/audit_tree.c
--- linux-2.6.34-rc3/kernel/audit_tree.c	2010-04-13 02:18:56.647570538 +0000
+++ linux-2.6.34-rc4/kernel/audit_tree.c	2010-04-13 02:19:02.111883245 +0000
@@ -3,6 +3,7 @@
 #include <linux/namei.h>
 #include <linux/mount.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 struct audit_tree;
 struct audit_chunk;
diff -urN linux-2.6.34-rc3/kernel/audit_watch.c linux-2.6.34-rc4/kernel/audit_watch.c
--- linux-2.6.34-rc3/kernel/audit_watch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/audit_watch.c	2010-04-13 02:19:02.111883245 +0000
@@ -27,6 +27,7 @@
 #include <linux/namei.h>
 #include <linux/netlink.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/inotify.h>
 #include <linux/security.h>
 #include "audit.h"
diff -urN linux-2.6.34-rc3/kernel/auditfilter.c linux-2.6.34-rc4/kernel/auditfilter.c
--- linux-2.6.34-rc3/kernel/auditfilter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/auditfilter.c	2010-04-13 02:19:02.112883946 +0000
@@ -27,6 +27,7 @@
 #include <linux/namei.h>
 #include <linux/netlink.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/security.h>
 #include "audit.h"
 
diff -urN linux-2.6.34-rc3/kernel/auditsc.c linux-2.6.34-rc4/kernel/auditsc.c
--- linux-2.6.34-rc3/kernel/auditsc.c	2010-04-13 02:18:56.647570538 +0000
+++ linux-2.6.34-rc4/kernel/auditsc.c	2010-04-13 02:19:02.113570958 +0000
@@ -49,6 +49,7 @@
 #include <linux/namei.h>
 #include <linux/mm.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/mount.h>
 #include <linux/socket.h>
 #include <linux/mqueue.h>
@@ -1893,7 +1894,7 @@
 {
 	if (context->name_count >= AUDIT_NAMES) {
 		if (inode)
-			printk(KERN_DEBUG "name_count maxed, losing inode data: "
+			printk(KERN_DEBUG "audit: name_count maxed, losing inode data: "
 			       "dev=%02x:%02x, inode=%lu\n",
 			       MAJOR(inode->i_sb->s_dev),
 			       MINOR(inode->i_sb->s_dev),
diff -urN linux-2.6.34-rc3/kernel/cgroup_freezer.c linux-2.6.34-rc4/kernel/cgroup_freezer.c
--- linux-2.6.34-rc3/kernel/cgroup_freezer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/cgroup_freezer.c	2010-04-13 02:19:02.114883535 +0000
@@ -15,6 +15,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/cgroup.h>
 #include <linux/fs.h>
 #include <linux/uaccess.h>
@@ -47,17 +48,20 @@
 			    struct freezer, css);
 }
 
-int cgroup_frozen(struct task_struct *task)
+int cgroup_freezing_or_frozen(struct task_struct *task)
 {
 	struct freezer *freezer;
 	enum freezer_state state;
 
 	task_lock(task);
 	freezer = task_freezer(task);
-	state = freezer->state;
+	if (!freezer->css.cgroup->parent)
+		state = CGROUP_THAWED; /* root cgroup can't be frozen */
+	else
+		state = freezer->state;
 	task_unlock(task);
 
-	return state == CGROUP_FROZEN;
+	return (state == CGROUP_FREEZING) || (state == CGROUP_FROZEN);
 }
 
 /*
diff -urN linux-2.6.34-rc3/kernel/compat.c linux-2.6.34-rc4/kernel/compat.c
--- linux-2.6.34-rc3/kernel/compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/compat.c	2010-04-13 02:19:02.115883991 +0000
@@ -25,6 +25,7 @@
 #include <linux/posix-timers.h>
 #include <linux/times.h>
 #include <linux/ptrace.h>
+#include <linux/gfp.h>
 
 #include <asm/uaccess.h>
 
diff -urN linux-2.6.34-rc3/kernel/cpu.c linux-2.6.34-rc4/kernel/cpu.c
--- linux-2.6.34-rc3/kernel/cpu.c	2010-04-13 02:18:56.649571545 +0000
+++ linux-2.6.34-rc4/kernel/cpu.c	2010-04-13 02:19:02.115883991 +0000
@@ -14,6 +14,7 @@
 #include <linux/kthread.h>
 #include <linux/stop_machine.h>
 #include <linux/mutex.h>
+#include <linux/gfp.h>
 
 #ifdef CONFIG_SMP
 /* Serializes the updates to cpu_online_mask, cpu_present_mask */
diff -urN linux-2.6.34-rc3/kernel/cred.c linux-2.6.34-rc4/kernel/cred.c
--- linux-2.6.34-rc3/kernel/cred.c	2010-04-13 02:18:56.650570432 +0000
+++ linux-2.6.34-rc4/kernel/cred.c	2010-04-13 02:19:02.116883687 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/module.h>
 #include <linux/cred.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/key.h>
 #include <linux/keyctl.h>
diff -urN linux-2.6.34-rc3/kernel/exit.c linux-2.6.34-rc4/kernel/exit.c
--- linux-2.6.34-rc3/kernel/exit.c	2010-04-13 02:18:56.650570432 +0000
+++ linux-2.6.34-rc4/kernel/exit.c	2010-04-13 02:19:02.117883927 +0000
@@ -953,7 +953,8 @@
 
 	acct_update_integrals(tsk);
 	/* sync mm's RSS info before statistics gathering */
-	sync_mm_rss(tsk, tsk->mm);
+	if (tsk->mm)
+		sync_mm_rss(tsk, tsk->mm);
 	group_dead = atomic_dec_and_test(&tsk->signal->live);
 	if (group_dead) {
 		hrtimer_cancel(&tsk->signal->real_timer);
diff -urN linux-2.6.34-rc3/kernel/fork.c linux-2.6.34-rc4/kernel/fork.c
--- linux-2.6.34-rc3/kernel/fork.c	2010-04-13 02:18:56.650570432 +0000
+++ linux-2.6.34-rc4/kernel/fork.c	2010-04-13 02:19:02.117883927 +0000
@@ -1052,6 +1052,9 @@
 	p->prev_utime = cputime_zero;
 	p->prev_stime = cputime_zero;
 #endif
+#if defined(SPLIT_RSS_COUNTING)
+	memset(&p->rss_stat, 0, sizeof(p->rss_stat));
+#endif
 
 	p->default_timer_slack_ns = current->timer_slack_ns;
 
diff -urN linux-2.6.34-rc3/kernel/irq/manage.c linux-2.6.34-rc4/kernel/irq/manage.c
--- linux-2.6.34-rc3/kernel/irq/manage.c	2010-04-13 02:18:56.651570582 +0000
+++ linux-2.6.34-rc4/kernel/irq/manage.c	2010-04-13 02:19:02.119883822 +0000
@@ -757,6 +757,16 @@
 		if (new->flags & IRQF_ONESHOT)
 			desc->status |= IRQ_ONESHOT;
 
+		/*
+		 * Force MSI interrupts to run with interrupts
+		 * disabled. The multi vector cards can cause stack
+		 * overflows due to nested interrupts when enough of
+		 * them are directed to a core and fire at the same
+		 * time.
+		 */
+		if (desc->msi_desc)
+			new->flags |= IRQF_DISABLED;
+
 		if (!(desc->status & IRQ_NOAUTOEN)) {
 			desc->depth = 0;
 			desc->status &= ~IRQ_DISABLED;
diff -urN linux-2.6.34-rc3/kernel/irq/numa_migrate.c linux-2.6.34-rc4/kernel/irq/numa_migrate.c
--- linux-2.6.34-rc3/kernel/irq/numa_migrate.c	2010-04-13 02:18:56.651570582 +0000
+++ linux-2.6.34-rc4/kernel/irq/numa_migrate.c	2010-04-13 02:19:02.119883822 +0000
@@ -6,6 +6,7 @@
  */
 
 #include <linux/irq.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/random.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/kernel/irq/proc.c linux-2.6.34-rc4/kernel/irq/proc.c
--- linux-2.6.34-rc3/kernel/irq/proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/irq/proc.c	2010-04-13 02:19:02.119883822 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/irq.h>
+#include <linux/gfp.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/kernel/kallsyms.c linux-2.6.34-rc4/kernel/kallsyms.c
--- linux-2.6.34-rc3/kernel/kallsyms.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/kallsyms.c	2010-04-13 02:19:02.119883822 +0000
@@ -21,6 +21,7 @@
 #include <linux/sched.h>	/* for cond_resched */
 #include <linux/mm.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 
 #include <asm/sections.h>
 
diff -urN linux-2.6.34-rc3/kernel/kgdb.c linux-2.6.34-rc4/kernel/kgdb.c
--- linux-2.6.34-rc3/kernel/kgdb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/kgdb.c	2010-04-13 02:19:02.120883584 +0000
@@ -69,9 +69,16 @@
 	struct pt_regs		*linux_regs;
 };
 
+/* Exception state values */
+#define DCPU_WANT_MASTER 0x1 /* Waiting to become a master kgdb cpu */
+#define DCPU_NEXT_MASTER 0x2 /* Transition from one master cpu to another */
+#define DCPU_IS_SLAVE    0x4 /* Slave cpu enter exception */
+#define DCPU_SSTEP       0x8 /* CPU is single stepping */
+
 static struct debuggerinfo_struct {
 	void			*debuggerinfo;
 	struct task_struct	*task;
+	int 			exception_state;
 } kgdb_info[NR_CPUS];
 
 /**
@@ -391,27 +398,22 @@
 
 /*
  * Copy the binary array pointed to by buf into mem.  Fix $, #, and
- * 0x7d escaped with 0x7d.  Return a pointer to the character after
- * the last byte written.
+ * 0x7d escaped with 0x7d. Return -EFAULT on failure or 0 on success.
+ * The input buf is overwitten with the result to write to mem.
  */
 static int kgdb_ebin2mem(char *buf, char *mem, int count)
 {
-	int err = 0;
-	char c;
+	int size = 0;
+	char *c = buf;
 
 	while (count-- > 0) {
-		c = *buf++;
-		if (c == 0x7d)
-			c = *buf++ ^ 0x20;
-
-		err = probe_kernel_write(mem, &c, 1);
-		if (err)
-			break;
-
-		mem++;
+		c[size] = *buf++;
+		if (c[size] == 0x7d)
+			c[size] = *buf++ ^ 0x20;
+		size++;
 	}
 
-	return err;
+	return probe_kernel_write(mem, c, size);
 }
 
 /*
@@ -563,49 +565,6 @@
 }
 
 /*
- * CPU debug state control:
- */
-
-#ifdef CONFIG_SMP
-static void kgdb_wait(struct pt_regs *regs)
-{
-	unsigned long flags;
-	int cpu;
-
-	local_irq_save(flags);
-	cpu = raw_smp_processor_id();
-	kgdb_info[cpu].debuggerinfo = regs;
-	kgdb_info[cpu].task = current;
-	/*
-	 * Make sure the above info reaches the primary CPU before
-	 * our cpu_in_kgdb[] flag setting does:
-	 */
-	smp_wmb();
-	atomic_set(&cpu_in_kgdb[cpu], 1);
-
-	/* Disable any cpu specific hw breakpoints */
-	kgdb_disable_hw_debug(regs);
-
-	/* Wait till primary CPU is done with debugging */
-	while (atomic_read(&passive_cpu_wait[cpu]))
-		cpu_relax();
-
-	kgdb_info[cpu].debuggerinfo = NULL;
-	kgdb_info[cpu].task = NULL;
-
-	/* fix up hardware debug registers on local cpu */
-	if (arch_kgdb_ops.correct_hw_break)
-		arch_kgdb_ops.correct_hw_break();
-
-	/* Signal the primary CPU that we are done: */
-	atomic_set(&cpu_in_kgdb[cpu], 0);
-	touch_softlockup_watchdog_sync();
-	clocksource_touch_watchdog();
-	local_irq_restore(flags);
-}
-#endif
-
-/*
  * Some architectures need cache flushes when we set/clear a
  * breakpoint:
  */
@@ -1400,34 +1359,13 @@
 	return 1;
 }
 
-/*
- * kgdb_handle_exception() - main entry point from a kernel exception
- *
- * Locking hierarchy:
- *	interface locks, if any (begin_session)
- *	kgdb lock (kgdb_active)
- */
-int
-kgdb_handle_exception(int evector, int signo, int ecode, struct pt_regs *regs)
+static int kgdb_cpu_enter(struct kgdb_state *ks, struct pt_regs *regs)
 {
-	struct kgdb_state kgdb_var;
-	struct kgdb_state *ks = &kgdb_var;
 	unsigned long flags;
 	int sstep_tries = 100;
 	int error = 0;
 	int i, cpu;
-
-	ks->cpu			= raw_smp_processor_id();
-	ks->ex_vector		= evector;
-	ks->signo		= signo;
-	ks->ex_vector		= evector;
-	ks->err_code		= ecode;
-	ks->kgdb_usethreadid	= 0;
-	ks->linux_regs		= regs;
-
-	if (kgdb_reenter_check(ks))
-		return 0; /* Ouch, double exception ! */
-
+	int trace_on = 0;
 acquirelock:
 	/*
 	 * Interrupts will be restored by the 'trap return' code, except when
@@ -1435,13 +1373,43 @@
 	 */
 	local_irq_save(flags);
 
-	cpu = raw_smp_processor_id();
+	cpu = ks->cpu;
+	kgdb_info[cpu].debuggerinfo = regs;
+	kgdb_info[cpu].task = current;
+	/*
+	 * Make sure the above info reaches the primary CPU before
+	 * our cpu_in_kgdb[] flag setting does:
+	 */
+	atomic_inc(&cpu_in_kgdb[cpu]);
 
 	/*
-	 * Acquire the kgdb_active lock:
+	 * CPU will loop if it is a slave or request to become a kgdb
+	 * master cpu and acquire the kgdb_active lock:
 	 */
-	while (atomic_cmpxchg(&kgdb_active, -1, cpu) != -1)
+	while (1) {
+		if (kgdb_info[cpu].exception_state & DCPU_WANT_MASTER) {
+			if (atomic_cmpxchg(&kgdb_active, -1, cpu) == cpu)
+				break;
+		} else if (kgdb_info[cpu].exception_state & DCPU_IS_SLAVE) {
+			if (!atomic_read(&passive_cpu_wait[cpu]))
+				goto return_normal;
+		} else {
+return_normal:
+			/* Return to normal operation by executing any
+			 * hw breakpoint fixup.
+			 */
+			if (arch_kgdb_ops.correct_hw_break)
+				arch_kgdb_ops.correct_hw_break();
+			if (trace_on)
+				tracing_on();
+			atomic_dec(&cpu_in_kgdb[cpu]);
+			touch_softlockup_watchdog_sync();
+			clocksource_touch_watchdog();
+			local_irq_restore(flags);
+			return 0;
+		}
 		cpu_relax();
+	}
 
 	/*
 	 * For single stepping, try to only enter on the processor
@@ -1475,9 +1443,6 @@
 	if (kgdb_io_ops->pre_exception)
 		kgdb_io_ops->pre_exception();
 
-	kgdb_info[ks->cpu].debuggerinfo = ks->linux_regs;
-	kgdb_info[ks->cpu].task = current;
-
 	kgdb_disable_hw_debug(ks->linux_regs);
 
 	/*
@@ -1486,15 +1451,9 @@
 	 */
 	if (!kgdb_single_step) {
 		for (i = 0; i < NR_CPUS; i++)
-			atomic_set(&passive_cpu_wait[i], 1);
+			atomic_inc(&passive_cpu_wait[i]);
 	}
 
-	/*
-	 * spin_lock code is good enough as a barrier so we don't
-	 * need one here:
-	 */
-	atomic_set(&cpu_in_kgdb[ks->cpu], 1);
-
 #ifdef CONFIG_SMP
 	/* Signal the other CPUs to enter kgdb_wait() */
 	if ((!kgdb_single_step) && kgdb_do_roundup)
@@ -1518,6 +1477,9 @@
 	kgdb_single_step = 0;
 	kgdb_contthread = current;
 	exception_level = 0;
+	trace_on = tracing_is_on();
+	if (trace_on)
+		tracing_off();
 
 	/* Talk to debugger with gdbserial protocol */
 	error = gdb_serial_stub(ks);
@@ -1526,13 +1488,11 @@
 	if (kgdb_io_ops->post_exception)
 		kgdb_io_ops->post_exception();
 
-	kgdb_info[ks->cpu].debuggerinfo = NULL;
-	kgdb_info[ks->cpu].task = NULL;
-	atomic_set(&cpu_in_kgdb[ks->cpu], 0);
+	atomic_dec(&cpu_in_kgdb[ks->cpu]);
 
 	if (!kgdb_single_step) {
 		for (i = NR_CPUS-1; i >= 0; i--)
-			atomic_set(&passive_cpu_wait[i], 0);
+			atomic_dec(&passive_cpu_wait[i]);
 		/*
 		 * Wait till all the CPUs have quit
 		 * from the debugger.
@@ -1551,6 +1511,8 @@
 		else
 			kgdb_sstep_pid = 0;
 	}
+	if (trace_on)
+		tracing_on();
 	/* Free kgdb_active */
 	atomic_set(&kgdb_active, -1);
 	touch_softlockup_watchdog_sync();
@@ -1560,13 +1522,52 @@
 	return error;
 }
 
+/*
+ * kgdb_handle_exception() - main entry point from a kernel exception
+ *
+ * Locking hierarchy:
+ *	interface locks, if any (begin_session)
+ *	kgdb lock (kgdb_active)
+ */
+int
+kgdb_handle_exception(int evector, int signo, int ecode, struct pt_regs *regs)
+{
+	struct kgdb_state kgdb_var;
+	struct kgdb_state *ks = &kgdb_var;
+	int ret;
+
+	ks->cpu			= raw_smp_processor_id();
+	ks->ex_vector		= evector;
+	ks->signo		= signo;
+	ks->ex_vector		= evector;
+	ks->err_code		= ecode;
+	ks->kgdb_usethreadid	= 0;
+	ks->linux_regs		= regs;
+
+	if (kgdb_reenter_check(ks))
+		return 0; /* Ouch, double exception ! */
+	kgdb_info[ks->cpu].exception_state |= DCPU_WANT_MASTER;
+	ret = kgdb_cpu_enter(ks, regs);
+	kgdb_info[ks->cpu].exception_state &= ~DCPU_WANT_MASTER;
+	return ret;
+}
+
 int kgdb_nmicallback(int cpu, void *regs)
 {
 #ifdef CONFIG_SMP
+	struct kgdb_state kgdb_var;
+	struct kgdb_state *ks = &kgdb_var;
+
+	memset(ks, 0, sizeof(struct kgdb_state));
+	ks->cpu			= cpu;
+	ks->linux_regs		= regs;
+
 	if (!atomic_read(&cpu_in_kgdb[cpu]) &&
-			atomic_read(&kgdb_active) != cpu &&
-			atomic_read(&cpu_in_kgdb[atomic_read(&kgdb_active)])) {
-		kgdb_wait((struct pt_regs *)regs);
+	    atomic_read(&kgdb_active) != -1 &&
+	    atomic_read(&kgdb_active) != cpu) {
+		kgdb_info[cpu].exception_state |= DCPU_IS_SLAVE;
+		kgdb_cpu_enter(ks, regs);
+		kgdb_info[cpu].exception_state &= ~DCPU_IS_SLAVE;
 		return 0;
 	}
 #endif
@@ -1742,11 +1743,11 @@
  */
 void kgdb_breakpoint(void)
 {
-	atomic_set(&kgdb_setting_breakpoint, 1);
+	atomic_inc(&kgdb_setting_breakpoint);
 	wmb(); /* Sync point before breakpoint */
 	arch_kgdb_breakpoint();
 	wmb(); /* Sync point after breakpoint */
-	atomic_set(&kgdb_setting_breakpoint, 0);
+	atomic_dec(&kgdb_setting_breakpoint);
 }
 EXPORT_SYMBOL_GPL(kgdb_breakpoint);
 
diff -urN linux-2.6.34-rc3/kernel/latencytop.c linux-2.6.34-rc4/kernel/latencytop.c
--- linux-2.6.34-rc3/kernel/latencytop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/latencytop.c	2010-04-13 02:19:02.122883527 +0000
@@ -56,7 +56,6 @@
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/list.h>
-#include <linux/slab.h>
 #include <linux/stacktrace.h>
 
 static DEFINE_SPINLOCK(latency_lock);
diff -urN linux-2.6.34-rc3/kernel/lockdep.c linux-2.6.34-rc4/kernel/lockdep.c
--- linux-2.6.34-rc3/kernel/lockdep.c	2010-04-13 02:18:56.653633085 +0000
+++ linux-2.6.34-rc4/kernel/lockdep.c	2010-04-13 02:19:02.123883761 +0000
@@ -43,6 +43,7 @@
 #include <linux/ftrace.h>
 #include <linux/stringify.h>
 #include <linux/bitops.h>
+#include <linux/gfp.h>
 
 #include <asm/sections.h>
 
@@ -582,9 +583,6 @@
 	unsigned long start = (unsigned long) &_stext,
 		      end   = (unsigned long) &_end,
 		      addr  = (unsigned long) obj;
-#ifdef CONFIG_SMP
-	int i;
-#endif
 
 	/*
 	 * static variable?
@@ -595,24 +593,16 @@
 	if (arch_is_kernel_data(addr))
 		return 1;
 
-#ifdef CONFIG_SMP
 	/*
-	 * percpu var?
+	 * in-kernel percpu var?
 	 */
-	for_each_possible_cpu(i) {
-		start = (unsigned long) &__per_cpu_start + per_cpu_offset(i);
-		end   = (unsigned long) &__per_cpu_start + PERCPU_ENOUGH_ROOM
-					+ per_cpu_offset(i);
-
-		if ((addr >= start) && (addr < end))
-			return 1;
-	}
-#endif
+	if (is_kernel_percpu_address(addr))
+		return 1;
 
 	/*
-	 * module var?
+	 * module static or percpu var?
 	 */
-	return is_module_address(addr);
+	return is_module_address(addr) || is_module_percpu_address(addr);
 }
 
 /*
diff -urN linux-2.6.34-rc3/kernel/module.c linux-2.6.34-rc4/kernel/module.c
--- linux-2.6.34-rc3/kernel/module.c	2010-04-13 02:18:56.654633070 +0000
+++ linux-2.6.34-rc4/kernel/module.c	2010-04-13 02:19:02.124883697 +0000
@@ -370,27 +370,33 @@
 
 #ifdef CONFIG_SMP
 
-static void *percpu_modalloc(unsigned long size, unsigned long align,
-			     const char *name)
+static inline void __percpu *mod_percpu(struct module *mod)
 {
-	void *ptr;
+	return mod->percpu;
+}
 
+static int percpu_modalloc(struct module *mod,
+			   unsigned long size, unsigned long align)
+{
 	if (align > PAGE_SIZE) {
 		printk(KERN_WARNING "%s: per-cpu alignment %li > %li\n",
-		       name, align, PAGE_SIZE);
+		       mod->name, align, PAGE_SIZE);
 		align = PAGE_SIZE;
 	}
 
-	ptr = __alloc_reserved_percpu(size, align);
-	if (!ptr)
+	mod->percpu = __alloc_reserved_percpu(size, align);
+	if (!mod->percpu) {
 		printk(KERN_WARNING
 		       "Could not allocate %lu bytes percpu data\n", size);
-	return ptr;
+		return -ENOMEM;
+	}
+	mod->percpu_size = size;
+	return 0;
 }
 
-static void percpu_modfree(void *freeme)
+static void percpu_modfree(struct module *mod)
 {
-	free_percpu(freeme);
+	free_percpu(mod->percpu);
 }
 
 static unsigned int find_pcpusec(Elf_Ehdr *hdr,
@@ -400,24 +406,62 @@
 	return find_sec(hdr, sechdrs, secstrings, ".data.percpu");
 }
 
-static void percpu_modcopy(void *pcpudest, const void *from, unsigned long size)
+static void percpu_modcopy(struct module *mod,
+			   const void *from, unsigned long size)
 {
 	int cpu;
 
 	for_each_possible_cpu(cpu)
-		memcpy(pcpudest + per_cpu_offset(cpu), from, size);
+		memcpy(per_cpu_ptr(mod->percpu, cpu), from, size);
+}
+
+/**
+ * is_module_percpu_address - test whether address is from module static percpu
+ * @addr: address to test
+ *
+ * Test whether @addr belongs to module static percpu area.
+ *
+ * RETURNS:
+ * %true if @addr is from module static percpu area
+ */
+bool is_module_percpu_address(unsigned long addr)
+{
+	struct module *mod;
+	unsigned int cpu;
+
+	preempt_disable();
+
+	list_for_each_entry_rcu(mod, &modules, list) {
+		if (!mod->percpu_size)
+			continue;
+		for_each_possible_cpu(cpu) {
+			void *start = per_cpu_ptr(mod->percpu, cpu);
+
+			if ((void *)addr >= start &&
+			    (void *)addr < start + mod->percpu_size) {
+				preempt_enable();
+				return true;
+			}
+		}
+	}
+
+	preempt_enable();
+	return false;
 }
 
 #else /* ... !CONFIG_SMP */
 
-static inline void *percpu_modalloc(unsigned long size, unsigned long align,
-				    const char *name)
+static inline void __percpu *mod_percpu(struct module *mod)
 {
 	return NULL;
 }
-static inline void percpu_modfree(void *pcpuptr)
+static inline int percpu_modalloc(struct module *mod,
+				  unsigned long size, unsigned long align)
+{
+	return -ENOMEM;
+}
+static inline void percpu_modfree(struct module *mod)
 {
-	BUG();
 }
 static inline unsigned int find_pcpusec(Elf_Ehdr *hdr,
 					Elf_Shdr *sechdrs,
@@ -425,12 +469,16 @@
 {
 	return 0;
 }
-static inline void percpu_modcopy(void *pcpudst, const void *src,
-				  unsigned long size)
+static inline void percpu_modcopy(struct module *mod,
+				  const void *from, unsigned long size)
 {
 	/* pcpusec should be 0, and size of that section should be 0. */
 	BUG_ON(size != 0);
 }
+bool is_module_percpu_address(unsigned long addr)
+{
+	return false;
+}
 
 #endif /* CONFIG_SMP */
 
@@ -473,11 +521,13 @@
 	int cpu;
 
 	INIT_LIST_HEAD(&mod->modules_which_use_me);
-	for_each_possible_cpu(cpu)
-		per_cpu_ptr(mod->refptr, cpu)->count = 0;
+	for_each_possible_cpu(cpu) {
+		per_cpu_ptr(mod->refptr, cpu)->incs = 0;
+		per_cpu_ptr(mod->refptr, cpu)->decs = 0;
+	}
 
 	/* Hold reference count during initialization. */
-	__this_cpu_write(mod->refptr->count, 1);
+	__this_cpu_write(mod->refptr->incs, 1);
 	/* Backwards compatibility macros put refcount during init. */
 	mod->waiter = current;
 }
@@ -616,12 +666,28 @@
 
 unsigned int module_refcount(struct module *mod)
 {
-	unsigned int total = 0;
+	unsigned int incs = 0, decs = 0;
 	int cpu;
 
 	for_each_possible_cpu(cpu)
-		total += per_cpu_ptr(mod->refptr, cpu)->count;
-	return total;
+		decs += per_cpu_ptr(mod->refptr, cpu)->decs;
+	/*
+	 * ensure the incs are added up after the decs.
+	 * module_put ensures incs are visible before decs with smp_wmb.
+	 *
+	 * This 2-count scheme avoids the situation where the refcount
+	 * for CPU0 is read, then CPU0 increments the module refcount,
+	 * then CPU1 drops that refcount, then the refcount for CPU1 is
+	 * read. We would record a decrement but not its corresponding
+	 * increment so we would see a low count (disaster).
+	 *
+	 * Rare situation? But module_refcount can be preempted, and we
+	 * might be tallying up 4096+ CPUs. So it is not impossible.
+	 */
+	smp_rmb();
+	for_each_possible_cpu(cpu)
+		incs += per_cpu_ptr(mod->refptr, cpu)->incs;
+	return incs - decs;
 }
 EXPORT_SYMBOL(module_refcount);
 
@@ -798,10 +864,11 @@
 {
 	if (module) {
 		preempt_disable();
-		__this_cpu_dec(module->refptr->count);
+		smp_wmb(); /* see comment in module_refcount */
+		__this_cpu_inc(module->refptr->decs);
 
 		trace_module_put(module, _RET_IP_,
-				 __this_cpu_read(module->refptr->count));
+				 __this_cpu_read(module->refptr->decs));
 		/* Maybe they're waiting for us to drop reference? */
 		if (unlikely(!module_is_live(module)))
 			wake_up_process(module->waiter);
@@ -1400,8 +1467,7 @@
 	/* This may be NULL, but that's OK */
 	module_free(mod, mod->module_init);
 	kfree(mod->args);
-	if (mod->percpu)
-		percpu_modfree(mod->percpu);
+	percpu_modfree(mod);
 #if defined(CONFIG_MODULE_UNLOAD)
 	if (mod->refptr)
 		free_percpu(mod->refptr);
@@ -1520,7 +1586,7 @@
 		default:
 			/* Divert to percpu allocation if a percpu var. */
 			if (sym[i].st_shndx == pcpuindex)
-				secbase = (unsigned long)mod->percpu;
+				secbase = (unsigned long)mod_percpu(mod);
 			else
 				secbase = sechdrs[sym[i].st_shndx].sh_addr;
 			sym[i].st_value += secbase;
@@ -1954,7 +2020,7 @@
 	unsigned int modindex, versindex, infoindex, pcpuindex;
 	struct module *mod;
 	long err = 0;
-	void *percpu = NULL, *ptr = NULL; /* Stops spurious gcc warning */
+	void *ptr = NULL; /* Stops spurious gcc warning */
 	unsigned long symoffs, stroffs, *strmap;
 
 	mm_segment_t old_fs;
@@ -2094,15 +2160,11 @@
 
 	if (pcpuindex) {
 		/* We have a special allocation for this section. */
-		percpu = percpu_modalloc(sechdrs[pcpuindex].sh_size,
-					 sechdrs[pcpuindex].sh_addralign,
-					 mod->name);
-		if (!percpu) {
-			err = -ENOMEM;
+		err = percpu_modalloc(mod, sechdrs[pcpuindex].sh_size,
+				      sechdrs[pcpuindex].sh_addralign);
+		if (err)
 			goto free_mod;
-		}
 		sechdrs[pcpuindex].sh_flags &= ~(unsigned long)SHF_ALLOC;
-		mod->percpu = percpu;
 	}
 
 	/* Determine total sizes, and put offsets in sh_entsize.  For now
@@ -2317,7 +2379,7 @@
 	sort_extable(mod->extable, mod->extable + mod->num_exentries);
 
 	/* Finally, copy percpu area over. */
-	percpu_modcopy(mod->percpu, (void *)sechdrs[pcpuindex].sh_addr,
+	percpu_modcopy(mod, (void *)sechdrs[pcpuindex].sh_addr,
 		       sechdrs[pcpuindex].sh_size);
 
 	add_kallsyms(mod, sechdrs, hdr->e_shnum, symindex, strindex,
@@ -2409,8 +2471,7 @@
 	module_free(mod, mod->module_core);
 	/* mod will be freed with core. Don't access it beyond this line! */
  free_percpu:
-	if (percpu)
-		percpu_modfree(percpu);
+	percpu_modfree(mod);
  free_mod:
 	kfree(args);
 	kfree(strmap);
diff -urN linux-2.6.34-rc3/kernel/nsproxy.c linux-2.6.34-rc4/kernel/nsproxy.c
--- linux-2.6.34-rc3/kernel/nsproxy.c	2010-04-13 02:18:56.654633070 +0000
+++ linux-2.6.34-rc4/kernel/nsproxy.c	2010-04-13 02:19:02.124883697 +0000
@@ -13,6 +13,7 @@
  *             Pavel Emelianov <xemul@openvz.org>
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/nsproxy.h>
 #include <linux/init_task.h>
diff -urN linux-2.6.34-rc3/kernel/padata.c linux-2.6.34-rc4/kernel/padata.c
--- linux-2.6.34-rc3/kernel/padata.c	2010-04-13 02:18:56.654633070 +0000
+++ linux-2.6.34-rc4/kernel/padata.c	2010-04-13 02:19:02.125771643 +0000
@@ -25,6 +25,7 @@
 #include <linux/padata.h>
 #include <linux/mutex.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/rcupdate.h>
 
 #define MAX_SEQ_NR INT_MAX - NR_CPUS
diff -urN linux-2.6.34-rc3/kernel/perf_event.c linux-2.6.34-rc4/kernel/perf_event.c
--- linux-2.6.34-rc3/kernel/perf_event.c	2010-04-13 02:18:56.656633121 +0000
+++ linux-2.6.34-rc4/kernel/perf_event.c	2010-04-13 02:19:02.127883532 +0000
@@ -15,6 +15,7 @@
 #include <linux/smp.h>
 #include <linux/file.h>
 #include <linux/poll.h>
+#include <linux/slab.h>
 #include <linux/sysfs.h>
 #include <linux/dcache.h>
 #include <linux/percpu.h>
@@ -1164,11 +1165,9 @@
 	struct perf_event_context *ctx = task->perf_event_ctxp;
 	struct perf_event_context *next_ctx;
 	struct perf_event_context *parent;
-	struct pt_regs *regs;
 	int do_switch = 1;
 
-	regs = task_pt_regs(task);
-	perf_sw_event(PERF_COUNT_SW_CONTEXT_SWITCHES, 1, 1, regs, 0);
+	perf_sw_event(PERF_COUNT_SW_CONTEXT_SWITCHES, 1, 1, NULL, 0);
 
 	if (likely(!ctx || !cpuctx->task_ctx))
 		return;
@@ -2786,12 +2785,11 @@
 	return NULL;
 }
 
-#ifdef CONFIG_EVENT_TRACING
 __weak
 void perf_arch_fetch_caller_regs(struct pt_regs *regs, unsigned long ip, int skip)
 {
 }
-#endif
+
 
 /*
  * Output
@@ -3378,15 +3376,23 @@
 				     struct perf_task_event *task_event)
 {
 	struct perf_output_handle handle;
-	int size;
 	struct task_struct *task = task_event->task;
-	int ret;
+	unsigned long flags;
+	int size, ret;
+
+	/*
+	 * If this CPU attempts to acquire an rq lock held by a CPU spinning
+	 * in perf_output_lock() from interrupt context, it's game over.
+	 */
+	local_irq_save(flags);
 
 	size  = task_event->event_id.header.size;
 	ret = perf_output_begin(&handle, event, size, 0, 0);
 
-	if (ret)
+	if (ret) {
+		local_irq_restore(flags);
 		return;
+	}
 
 	task_event->event_id.pid = perf_event_pid(event, task);
 	task_event->event_id.ppid = perf_event_pid(event, current);
@@ -3397,6 +3403,7 @@
 	perf_output_put(&handle, task_event->event_id);
 
 	perf_output_end(&handle);
+	local_irq_restore(flags);
 }
 
 static int perf_event_task_match(struct perf_event *event)
diff -urN linux-2.6.34-rc3/kernel/pid_namespace.c linux-2.6.34-rc4/kernel/pid_namespace.c
--- linux-2.6.34-rc3/kernel/pid_namespace.c	2010-04-13 02:18:56.656633121 +0000
+++ linux-2.6.34-rc4/kernel/pid_namespace.c	2010-04-13 02:19:02.127883532 +0000
@@ -13,6 +13,7 @@
 #include <linux/syscalls.h>
 #include <linux/err.h>
 #include <linux/acct.h>
+#include <linux/slab.h>
 
 #define BITS_PER_PAGE		(PAGE_SIZE*8)
 
diff -urN linux-2.6.34-rc3/kernel/power/hibernate.c linux-2.6.34-rc4/kernel/power/hibernate.c
--- linux-2.6.34-rc3/kernel/power/hibernate.c	2010-04-13 02:18:56.657633258 +0000
+++ linux-2.6.34-rc4/kernel/power/hibernate.c	2010-04-13 02:19:02.129883603 +0000
@@ -22,6 +22,7 @@
 #include <linux/console.h>
 #include <linux/cpu.h>
 #include <linux/freezer.h>
+#include <linux/gfp.h>
 #include <scsi/scsi_scan.h>
 #include <asm/suspend.h>
 
diff -urN linux-2.6.34-rc3/kernel/power/hibernate_nvs.c linux-2.6.34-rc4/kernel/power/hibernate_nvs.c
--- linux-2.6.34-rc3/kernel/power/hibernate_nvs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/power/hibernate_nvs.c	2010-04-13 02:19:02.129883603 +0000
@@ -10,6 +10,7 @@
 #include <linux/kernel.h>
 #include <linux/list.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/suspend.h>
 
 /*
diff -urN linux-2.6.34-rc3/kernel/power/process.c linux-2.6.34-rc4/kernel/power/process.c
--- linux-2.6.34-rc3/kernel/power/process.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/power/process.c	2010-04-13 02:19:02.129883603 +0000
@@ -88,12 +88,11 @@
 		printk(KERN_ERR "Freezing of tasks failed after %d.%02d seconds "
 				"(%d tasks refusing to freeze):\n",
 				elapsed_csecs / 100, elapsed_csecs % 100, todo);
-		show_state();
 		read_lock(&tasklist_lock);
 		do_each_thread(g, p) {
 			task_lock(p);
 			if (freezing(p) && !freezer_should_skip(p))
-				printk(KERN_ERR " %s\n", p->comm);
+				sched_show_task(p);
 			cancel_freezing(p);
 			task_unlock(p);
 		} while_each_thread(g, p);
@@ -145,7 +144,7 @@
 		if (nosig_only && should_send_signal(p))
 			continue;
 
-		if (cgroup_frozen(p))
+		if (cgroup_freezing_or_frozen(p))
 			continue;
 
 		thaw_process(p);
diff -urN linux-2.6.34-rc3/kernel/power/snapshot.c linux-2.6.34-rc4/kernel/power/snapshot.c
--- linux-2.6.34-rc3/kernel/power/snapshot.c	2010-04-13 02:18:56.657633258 +0000
+++ linux-2.6.34-rc4/kernel/power/snapshot.c	2010-04-13 02:19:02.130572787 +0000
@@ -26,6 +26,7 @@
 #include <linux/console.h>
 #include <linux/highmem.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/mmu_context.h>
diff -urN linux-2.6.34-rc3/kernel/power/suspend.c linux-2.6.34-rc4/kernel/power/suspend.c
--- linux-2.6.34-rc3/kernel/power/suspend.c	2010-04-13 02:18:56.657633258 +0000
+++ linux-2.6.34-rc4/kernel/power/suspend.c	2010-04-13 02:19:02.130572787 +0000
@@ -15,6 +15,7 @@
 #include <linux/console.h>
 #include <linux/cpu.h>
 #include <linux/syscalls.h>
+#include <linux/gfp.h>
 
 #include "power.h"
 
diff -urN linux-2.6.34-rc3/kernel/power/swap.c linux-2.6.34-rc4/kernel/power/swap.c
--- linux-2.6.34-rc3/kernel/power/swap.c	2010-04-13 02:18:56.657633258 +0000
+++ linux-2.6.34-rc4/kernel/power/swap.c	2010-04-13 02:19:02.130572787 +0000
@@ -23,6 +23,7 @@
 #include <linux/swap.h>
 #include <linux/swapops.h>
 #include <linux/pm.h>
+#include <linux/slab.h>
 
 #include "power.h"
 
diff -urN linux-2.6.34-rc3/kernel/res_counter.c linux-2.6.34-rc4/kernel/res_counter.c
--- linux-2.6.34-rc3/kernel/res_counter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/res_counter.c	2010-04-13 02:19:02.133883623 +0000
@@ -10,7 +10,6 @@
 #include <linux/types.h>
 #include <linux/parser.h>
 #include <linux/fs.h>
-#include <linux/slab.h>
 #include <linux/res_counter.h>
 #include <linux/uaccess.h>
 #include <linux/mm.h>
diff -urN linux-2.6.34-rc3/kernel/sched.c linux-2.6.34-rc4/kernel/sched.c
--- linux-2.6.34-rc3/kernel/sched.c	2010-04-13 02:18:56.663633050 +0000
+++ linux-2.6.34-rc4/kernel/sched.c	2010-04-13 02:19:02.136883853 +0000
@@ -71,6 +71,7 @@
 #include <linux/debugfs.h>
 #include <linux/ctype.h>
 #include <linux/ftrace.h>
+#include <linux/slab.h>
 
 #include <asm/tlb.h>
 #include <asm/irq_regs.h>
@@ -4902,7 +4903,7 @@
 	int ret;
 	cpumask_var_t mask;
 
-	if (len < nr_cpu_ids)
+	if ((len * BITS_PER_BYTE) < nr_cpu_ids)
 		return -EINVAL;
 	if (len & (sizeof(unsigned long)-1))
 		return -EINVAL;
@@ -5387,7 +5388,7 @@
 
 		get_task_struct(mt);
 		task_rq_unlock(rq, &flags);
-		wake_up_process(rq->migration_thread);
+		wake_up_process(mt);
 		put_task_struct(mt);
 		wait_for_completion(&req.done);
 		tlb_migrate_finish(p->mm);
diff -urN linux-2.6.34-rc3/kernel/sched_cpupri.c linux-2.6.34-rc4/kernel/sched_cpupri.c
--- linux-2.6.34-rc3/kernel/sched_cpupri.c	2010-04-13 02:18:56.663633050 +0000
+++ linux-2.6.34-rc4/kernel/sched_cpupri.c	2010-04-13 02:19:02.136883853 +0000
@@ -27,6 +27,7 @@
  *  of the License.
  */
 
+#include <linux/gfp.h>
 #include "sched_cpupri.h"
 
 /* Convert between a 140 based task->prio, and our 102 based cpupri */
diff -urN linux-2.6.34-rc3/kernel/sched_debug.c linux-2.6.34-rc4/kernel/sched_debug.c
--- linux-2.6.34-rc3/kernel/sched_debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/sched_debug.c	2010-04-13 02:19:02.136883853 +0000
@@ -518,8 +518,4 @@
 	p->se.nr_wakeups_idle			= 0;
 	p->sched_info.bkl_count			= 0;
 #endif
-	p->se.sum_exec_runtime			= 0;
-	p->se.prev_sum_exec_runtime		= 0;
-	p->nvcsw				= 0;
-	p->nivcsw				= 0;
 }
diff -urN linux-2.6.34-rc3/kernel/smp.c linux-2.6.34-rc4/kernel/smp.c
--- linux-2.6.34-rc3/kernel/smp.c	2010-04-13 02:18:56.665633058 +0000
+++ linux-2.6.34-rc4/kernel/smp.c	2010-04-13 02:19:02.139884125 +0000
@@ -9,6 +9,7 @@
 #include <linux/module.h>
 #include <linux/percpu.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/smp.h>
 #include <linux/cpu.h>
 
diff -urN linux-2.6.34-rc3/kernel/srcu.c linux-2.6.34-rc4/kernel/srcu.c
--- linux-2.6.34-rc3/kernel/srcu.c	2010-04-13 02:18:56.666633079 +0000
+++ linux-2.6.34-rc4/kernel/srcu.c	2010-04-13 02:19:02.139884125 +0000
@@ -30,7 +30,6 @@
 #include <linux/preempt.h>
 #include <linux/rcupdate.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/srcu.h>
 
diff -urN linux-2.6.34-rc3/kernel/sys.c linux-2.6.34-rc4/kernel/sys.c
--- linux-2.6.34-rc3/kernel/sys.c	2010-04-13 02:18:56.666633079 +0000
+++ linux-2.6.34-rc4/kernel/sys.c	2010-04-13 02:19:02.139884125 +0000
@@ -36,6 +36,7 @@
 #include <linux/personality.h>
 #include <linux/ptrace.h>
 #include <linux/fs_struct.h>
+#include <linux/gfp.h>
 
 #include <linux/compat.h>
 #include <linux/syscalls.h>
diff -urN linux-2.6.34-rc3/kernel/sysctl_binary.c linux-2.6.34-rc4/kernel/sysctl_binary.c
--- linux-2.6.34-rc3/kernel/sysctl_binary.c	2010-04-13 02:18:56.667633067 +0000
+++ linux-2.6.34-rc4/kernel/sysctl_binary.c	2010-04-13 02:19:02.140883828 +0000
@@ -13,6 +13,7 @@
 #include <linux/file.h>
 #include <linux/ctype.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_SYSCTL_SYSCALL
 
diff -urN linux-2.6.34-rc3/kernel/taskstats.c linux-2.6.34-rc4/kernel/taskstats.c
--- linux-2.6.34-rc3/kernel/taskstats.c	2010-04-13 02:18:56.667633067 +0000
+++ linux-2.6.34-rc4/kernel/taskstats.c	2010-04-13 02:19:02.140883828 +0000
@@ -22,6 +22,7 @@
 #include <linux/delayacct.h>
 #include <linux/cpumask.h>
 #include <linux/percpu.h>
+#include <linux/slab.h>
 #include <linux/cgroupstats.h>
 #include <linux/cgroup.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/kernel/time/timecompare.c linux-2.6.34-rc4/kernel/time/timecompare.c
--- linux-2.6.34-rc3/kernel/time/timecompare.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/time/timecompare.c	2010-04-13 02:19:02.141884386 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/timecompare.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/math64.h>
 
 /*
diff -urN linux-2.6.34-rc3/kernel/time.c linux-2.6.34-rc4/kernel/time.c
--- linux-2.6.34-rc3/kernel/time.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/time.c	2010-04-13 02:19:02.140883828 +0000
@@ -35,7 +35,6 @@
 #include <linux/syscalls.h>
 #include <linux/security.h>
 #include <linux/fs.h>
-#include <linux/slab.h>
 #include <linux/math64.h>
 #include <linux/ptrace.h>
 
diff -urN linux-2.6.34-rc3/kernel/timer.c linux-2.6.34-rc4/kernel/timer.c
--- linux-2.6.34-rc3/kernel/timer.c	2010-04-13 02:18:56.668633034 +0000
+++ linux-2.6.34-rc4/kernel/timer.c	2010-04-13 02:19:02.142883330 +0000
@@ -39,6 +39,7 @@
 #include <linux/kallsyms.h>
 #include <linux/perf_event.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/unistd.h>
diff -urN linux-2.6.34-rc3/kernel/trace/blktrace.c linux-2.6.34-rc4/kernel/trace/blktrace.c
--- linux-2.6.34-rc3/kernel/trace/blktrace.c	2010-04-13 02:18:56.668633034 +0000
+++ linux-2.6.34-rc4/kernel/trace/blktrace.c	2010-04-13 02:19:02.142883330 +0000
@@ -21,6 +21,7 @@
 #include <linux/percpu.h>
 #include <linux/init.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/debugfs.h>
 #include <linux/smp_lock.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/kernel/trace/ftrace.c linux-2.6.34-rc4/kernel/trace/ftrace.c
--- linux-2.6.34-rc3/kernel/trace/ftrace.c	2010-04-13 02:18:56.669571705 +0000
+++ linux-2.6.34-rc4/kernel/trace/ftrace.c	2010-04-13 02:19:02.143883608 +0000
@@ -24,6 +24,7 @@
 #include <linux/uaccess.h>
 #include <linux/ftrace.h>
 #include <linux/sysctl.h>
+#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/list.h>
 #include <linux/hash.h>
diff -urN linux-2.6.34-rc3/kernel/trace/power-traces.c linux-2.6.34-rc4/kernel/trace/power-traces.c
--- linux-2.6.34-rc3/kernel/trace/power-traces.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/power-traces.c	2010-04-13 02:19:02.143883608 +0000
@@ -9,7 +9,6 @@
 #include <linux/workqueue.h>
 #include <linux/sched.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 
 #define CREATE_TRACE_POINTS
 #include <trace/events/power.h>
diff -urN linux-2.6.34-rc3/kernel/trace/ring_buffer.c linux-2.6.34-rc4/kernel/trace/ring_buffer.c
--- linux-2.6.34-rc3/kernel/trace/ring_buffer.c	2010-04-13 02:18:56.669571705 +0000
+++ linux-2.6.34-rc4/kernel/trace/ring_buffer.c	2010-04-13 02:19:02.143883608 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/percpu.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/hash.h>
 #include <linux/list.h>
@@ -1209,18 +1210,19 @@
 
 	for (i = 0; i < nr_pages; i++) {
 		if (RB_WARN_ON(cpu_buffer, list_empty(cpu_buffer->pages)))
-			return;
+			goto out;
 		p = cpu_buffer->pages->next;
 		bpage = list_entry(p, struct buffer_page, list);
 		list_del_init(&bpage->list);
 		free_buffer_page(bpage);
 	}
 	if (RB_WARN_ON(cpu_buffer, list_empty(cpu_buffer->pages)))
-		return;
+		goto out;
 
 	rb_reset_cpu(cpu_buffer);
 	rb_check_pages(cpu_buffer);
 
+out:
 	spin_unlock_irq(&cpu_buffer->reader_lock);
 }
 
@@ -1237,7 +1239,7 @@
 
 	for (i = 0; i < nr_pages; i++) {
 		if (RB_WARN_ON(cpu_buffer, list_empty(pages)))
-			return;
+			goto out;
 		p = pages->next;
 		bpage = list_entry(p, struct buffer_page, list);
 		list_del_init(&bpage->list);
@@ -1246,6 +1248,7 @@
 	rb_reset_cpu(cpu_buffer);
 	rb_check_pages(cpu_buffer);
 
+out:
 	spin_unlock_irq(&cpu_buffer->reader_lock);
 }
 
diff -urN linux-2.6.34-rc3/kernel/trace/trace.c linux-2.6.34-rc4/kernel/trace/trace.c
--- linux-2.6.34-rc3/kernel/trace/trace.c	2010-04-13 02:18:56.670570463 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace.c	2010-04-13 02:19:02.144883188 +0000
@@ -33,10 +33,10 @@
 #include <linux/kdebug.h>
 #include <linux/string.h>
 #include <linux/rwsem.h>
+#include <linux/slab.h>
 #include <linux/ctype.h>
 #include <linux/init.h>
 #include <linux/poll.h>
-#include <linux/gfp.h>
 #include <linux/fs.h>
 
 #include "trace.h"
diff -urN linux-2.6.34-rc3/kernel/trace/trace_clock.c linux-2.6.34-rc4/kernel/trace/trace_clock.c
--- linux-2.6.34-rc3/kernel/trace/trace_clock.c	2010-04-13 02:18:56.671633057 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_clock.c	2010-04-13 02:19:02.145883569 +0000
@@ -84,7 +84,7 @@
 	int this_cpu;
 	u64 now;
 
-	raw_local_irq_save(flags);
+	local_irq_save(flags);
 
 	this_cpu = raw_smp_processor_id();
 	now = cpu_clock(this_cpu);
@@ -110,7 +110,7 @@
 	arch_spin_unlock(&trace_clock_struct.lock);
 
  out:
-	raw_local_irq_restore(flags);
+	local_irq_restore(flags);
 
 	return now;
 }
diff -urN linux-2.6.34-rc3/kernel/trace/trace_event_perf.c linux-2.6.34-rc4/kernel/trace/trace_event_perf.c
--- linux-2.6.34-rc3/kernel/trace/trace_event_perf.c	2010-04-13 02:18:56.671633057 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_event_perf.c	2010-04-13 02:19:02.145883569 +0000
@@ -17,7 +17,12 @@
 static char *perf_trace_buf;
 static char *perf_trace_buf_nmi;
 
-typedef typeof(char [PERF_MAX_TRACE_SIZE]) perf_trace_t ;
+/*
+ * Force it to be aligned to unsigned long to avoid misaligned accesses
+ * suprises
+ */
+typedef typeof(unsigned long [PERF_MAX_TRACE_SIZE / sizeof(unsigned long)])
+	perf_trace_t;
 
 /* Count the events in use (per event id, not per instance) */
 static int	total_ref_count;
@@ -130,6 +135,8 @@
 	char *trace_buf, *raw_data;
 	int pc, cpu;
 
+	BUILD_BUG_ON(PERF_MAX_TRACE_SIZE % sizeof(unsigned long));
+
 	pc = preempt_count();
 
 	/* Protect the per cpu buffer, begin the rcu read side */
@@ -152,7 +159,7 @@
 	raw_data = per_cpu_ptr(trace_buf, cpu);
 
 	/* zero the dead bytes from align to not leak stack to user */
-	*(u64 *)(&raw_data[size - sizeof(u64)]) = 0ULL;
+	memset(&raw_data[size - sizeof(u64)], 0, sizeof(u64));
 
 	entry = (struct trace_entry *)raw_data;
 	tracing_generic_entry_update(entry, *irq_flags, pc);
diff -urN linux-2.6.34-rc3/kernel/trace/trace_events.c linux-2.6.34-rc4/kernel/trace/trace_events.c
--- linux-2.6.34-rc3/kernel/trace/trace_events.c	2010-04-13 02:18:56.671633057 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_events.c	2010-04-13 02:19:02.145883569 +0000
@@ -15,6 +15,7 @@
 #include <linux/uaccess.h>
 #include <linux/module.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 
 #include <asm/setup.h>
diff -urN linux-2.6.34-rc3/kernel/trace/trace_events_filter.c linux-2.6.34-rc4/kernel/trace/trace_events_filter.c
--- linux-2.6.34-rc3/kernel/trace/trace_events_filter.c	2010-04-13 02:18:56.671633057 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_events_filter.c	2010-04-13 02:19:02.145883569 +0000
@@ -22,6 +22,7 @@
 #include <linux/ctype.h>
 #include <linux/mutex.h>
 #include <linux/perf_event.h>
+#include <linux/slab.h>
 
 #include "trace.h"
 #include "trace_output.h"
diff -urN linux-2.6.34-rc3/kernel/trace/trace_functions_graph.c linux-2.6.34-rc4/kernel/trace/trace_functions_graph.c
--- linux-2.6.34-rc3/kernel/trace/trace_functions_graph.c	2010-04-13 02:18:56.672633039 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_functions_graph.c	2010-04-13 02:19:02.146883470 +0000
@@ -9,6 +9,7 @@
 #include <linux/debugfs.h>
 #include <linux/uaccess.h>
 #include <linux/ftrace.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 
 #include "trace.h"
diff -urN linux-2.6.34-rc3/kernel/trace/trace_ksym.c linux-2.6.34-rc4/kernel/trace/trace_ksym.c
--- linux-2.6.34-rc3/kernel/trace/trace_ksym.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_ksym.c	2010-04-13 02:19:02.147883829 +0000
@@ -23,6 +23,7 @@
 #include <linux/debugfs.h>
 #include <linux/ftrace.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 
 #include "trace_output.h"
diff -urN linux-2.6.34-rc3/kernel/trace/trace_mmiotrace.c linux-2.6.34-rc4/kernel/trace/trace_mmiotrace.c
--- linux-2.6.34-rc3/kernel/trace/trace_mmiotrace.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_mmiotrace.c	2010-04-13 02:19:02.147883829 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/mmiotrace.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/kernel/trace/trace_selftest.c linux-2.6.34-rc4/kernel/trace/trace_selftest.c
--- linux-2.6.34-rc3/kernel/trace/trace_selftest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_selftest.c	2010-04-13 02:19:02.147883829 +0000
@@ -3,6 +3,7 @@
 #include <linux/stringify.h>
 #include <linux/kthread.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 static inline int trace_valid_entry(struct trace_entry *entry)
 {
diff -urN linux-2.6.34-rc3/kernel/trace/trace_stat.c linux-2.6.34-rc4/kernel/trace/trace_stat.c
--- linux-2.6.34-rc3/kernel/trace/trace_stat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_stat.c	2010-04-13 02:19:02.147883829 +0000
@@ -10,6 +10,7 @@
 
 
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/rbtree.h>
 #include <linux/debugfs.h>
 #include "trace_stat.h"
diff -urN linux-2.6.34-rc3/kernel/trace/trace_syscalls.c linux-2.6.34-rc4/kernel/trace/trace_syscalls.c
--- linux-2.6.34-rc3/kernel/trace/trace_syscalls.c	2010-04-13 02:18:56.672633039 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_syscalls.c	2010-04-13 02:19:02.147883829 +0000
@@ -1,5 +1,6 @@
 #include <trace/syscall.h>
 #include <trace/events/syscalls.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/ftrace.h>
 #include <linux/perf_event.h>
diff -urN linux-2.6.34-rc3/kernel/trace/trace_workqueue.c linux-2.6.34-rc4/kernel/trace/trace_workqueue.c
--- linux-2.6.34-rc3/kernel/trace/trace_workqueue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/kernel/trace/trace_workqueue.c	2010-04-13 02:19:02.147883829 +0000
@@ -9,6 +9,7 @@
 #include <trace/events/workqueue.h>
 #include <linux/list.h>
 #include <linux/percpu.h>
+#include <linux/slab.h>
 #include <linux/kref.h>
 #include "trace_stat.h"
 #include "trace.h"
diff -urN linux-2.6.34-rc3/lib/Kconfig.debug linux-2.6.34-rc4/lib/Kconfig.debug
--- linux-2.6.34-rc3/lib/Kconfig.debug	2010-04-13 02:18:56.673633032 +0000
+++ linux-2.6.34-rc4/lib/Kconfig.debug	2010-04-13 02:19:02.148883460 +0000
@@ -356,7 +356,7 @@
 config DEBUG_KMEMLEAK
 	bool "Kernel memory leak detector"
 	depends on DEBUG_KERNEL && EXPERIMENTAL && !MEMORY_HOTPLUG && \
-		(X86 || ARM || PPC || S390 || SUPERH)
+		(X86 || ARM || PPC || S390 || SUPERH || MICROBLAZE)
 
 	select DEBUG_FS if SYSFS
 	select STACKTRACE if STACKTRACE_SUPPORT
diff -urN linux-2.6.34-rc3/lib/Makefile linux-2.6.34-rc4/lib/Makefile
--- linux-2.6.34-rc3/lib/Makefile	2010-04-13 02:18:56.673633032 +0000
+++ linux-2.6.34-rc4/lib/Makefile	2010-04-13 02:19:02.148883460 +0000
@@ -21,7 +21,7 @@
 
 obj-y += bcd.o div64.o sort.o parser.o halfmd4.o debug_locks.o random32.o \
 	 bust_spinlocks.o hexdump.o kasprintf.o bitmap.o scatterlist.o \
-	 string_helpers.o gcd.o list_sort.o
+	 string_helpers.o gcd.o lcm.o list_sort.o
 
 ifeq ($(CONFIG_DEBUG_KOBJECT),y)
 CFLAGS_kobject.o += -DDEBUG
diff -urN linux-2.6.34-rc3/lib/cpumask.c linux-2.6.34-rc4/lib/cpumask.c
--- linux-2.6.34-rc3/lib/cpumask.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/cpumask.c	2010-04-13 02:19:02.149883082 +0000
@@ -1,3 +1,4 @@
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/bitops.h>
 #include <linux/cpumask.h>
diff -urN linux-2.6.34-rc3/lib/crc32.c linux-2.6.34-rc4/lib/crc32.c
--- linux-2.6.34-rc3/lib/crc32.c	2010-04-13 02:18:56.674633029 +0000
+++ linux-2.6.34-rc4/lib/crc32.c	2010-04-13 02:19:02.149883082 +0000
@@ -25,7 +25,6 @@
 #include <linux/module.h>
 #include <linux/compiler.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/init.h>
 #include <asm/atomic.h>
 #include "crc32defs.h"
diff -urN linux-2.6.34-rc3/lib/debugobjects.c linux-2.6.34-rc4/lib/debugobjects.c
--- linux-2.6.34-rc3/lib/debugobjects.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/debugobjects.c	2010-04-13 02:19:02.149883082 +0000
@@ -12,6 +12,7 @@
 #include <linux/sched.h>
 #include <linux/seq_file.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <linux/hash.h>
 
 #define ODEBUG_HASH_BITS	14
diff -urN linux-2.6.34-rc3/lib/devres.c linux-2.6.34-rc4/lib/devres.c
--- linux-2.6.34-rc3/lib/devres.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/devres.c	2010-04-13 02:19:02.149883082 +0000
@@ -1,5 +1,6 @@
 #include <linux/pci.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 #include <linux/module.h>
 
 void devm_ioremap_release(struct device *dev, void *res)
diff -urN linux-2.6.34-rc3/lib/dynamic_debug.c linux-2.6.34-rc4/lib/dynamic_debug.c
--- linux-2.6.34-rc3/lib/dynamic_debug.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/dynamic_debug.c	2010-04-13 02:19:02.149883082 +0000
@@ -25,6 +25,7 @@
 #include <linux/uaccess.h>
 #include <linux/dynamic_debug.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 
 extern struct _ddebug __start___verbose[];
 extern struct _ddebug __stop___verbose[];
diff -urN linux-2.6.34-rc3/lib/genalloc.c linux-2.6.34-rc4/lib/genalloc.c
--- linux-2.6.34-rc3/lib/genalloc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/genalloc.c	2010-04-13 02:19:02.149883082 +0000
@@ -10,6 +10,7 @@
  * Version 2.  See the file COPYING for more details.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/bitmap.h>
 #include <linux/genalloc.h>
diff -urN linux-2.6.34-rc3/lib/inflate.c linux-2.6.34-rc4/lib/inflate.c
--- linux-2.6.34-rc3/lib/inflate.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/inflate.c	2010-04-13 02:19:02.150883511 +0000
@@ -103,6 +103,7 @@
       the two sets of lengths.
  */
 #include <linux/compiler.h>
+#include <linux/slab.h>
 
 #ifdef RCSID
 static char rcsid[] = "#Id: inflate.c,v 0.14 1993/06/10 13:27:04 jloup Exp #";
diff -urN linux-2.6.34-rc3/lib/kasprintf.c linux-2.6.34-rc4/lib/kasprintf.c
--- linux-2.6.34-rc3/lib/kasprintf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/kasprintf.c	2010-04-13 02:19:02.150883511 +0000
@@ -6,6 +6,7 @@
 
 #include <stdarg.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 
diff -urN linux-2.6.34-rc3/lib/kobject_uevent.c linux-2.6.34-rc4/lib/kobject_uevent.c
--- linux-2.6.34-rc3/lib/kobject_uevent.c	2010-04-13 02:18:56.675633047 +0000
+++ linux-2.6.34-rc4/lib/kobject_uevent.c	2010-04-13 02:19:02.150883511 +0000
@@ -18,6 +18,7 @@
 #include <linux/string.h>
 #include <linux/kobject.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/socket.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/lib/kref.c linux-2.6.34-rc4/lib/kref.c
--- linux-2.6.34-rc3/lib/kref.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/kref.c	2010-04-13 02:19:02.150883511 +0000
@@ -13,6 +13,7 @@
 
 #include <linux/kref.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 /**
  * kref_set - initialize object and set refcount to requested number.
diff -urN linux-2.6.34-rc3/lib/lcm.c linux-2.6.34-rc4/lib/lcm.c
--- linux-2.6.34-rc3/lib/lcm.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/lib/lcm.c	2010-04-13 02:19:02.150883511 +0000
@@ -0,0 +1,15 @@
+#include <linux/kernel.h>
+#include <linux/gcd.h>
+#include <linux/module.h>
+
+/* Lowest common multiple */
+unsigned long lcm(unsigned long a, unsigned long b)
+{
+	if (a && b)
+		return (a * b) / gcd(a, b);
+	else if (b)
+		return b;
+
+	return a;
+}
+EXPORT_SYMBOL_GPL(lcm);
diff -urN linux-2.6.34-rc3/lib/radix-tree.c linux-2.6.34-rc4/lib/radix-tree.c
--- linux-2.6.34-rc3/lib/radix-tree.c	2010-04-13 02:18:56.675633047 +0000
+++ linux-2.6.34-rc4/lib/radix-tree.c	2010-04-13 02:19:02.151883156 +0000
@@ -28,7 +28,6 @@
 #include <linux/slab.h>
 #include <linux/notifier.h>
 #include <linux/cpu.h>
-#include <linux/gfp.h>
 #include <linux/string.h>
 #include <linux/bitops.h>
 #include <linux/rcupdate.h>
@@ -556,6 +555,10 @@
  *
  *  0: tag not present or not set
  *  1: tag set
+ *
+ * Note that the return value of this function may not be relied on, even if
+ * the RCU lock is held, unless tag modification and node deletion are excluded
+ * from concurrency.
  */
 int radix_tree_tag_get(struct radix_tree_root *root,
 			unsigned long index, unsigned int tag)
@@ -596,12 +599,8 @@
 		 */
 		if (!tag_get(node, tag, offset))
 			saw_unset_tag = 1;
-		if (height == 1) {
-			int ret = tag_get(node, tag, offset);
-
-			BUG_ON(ret && saw_unset_tag);
-			return !!ret;
-		}
+		if (height == 1)
+			return !!tag_get(node, tag, offset);
 		node = rcu_dereference_raw(node->slots[offset]);
 		shift -= RADIX_TREE_MAP_SHIFT;
 		height--;
diff -urN linux-2.6.34-rc3/lib/ratelimit.c linux-2.6.34-rc4/lib/ratelimit.c
--- linux-2.6.34-rc3/lib/ratelimit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/ratelimit.c	2010-04-13 02:19:02.151883156 +0000
@@ -16,9 +16,14 @@
 /*
  * __ratelimit - rate limiting
  * @rs: ratelimit_state data
+ * @func: name of calling function
  *
- * This enforces a rate limit: not more than @rs->ratelimit_burst callbacks
- * in every @rs->ratelimit_jiffies
+ * This enforces a rate limit: not more than @rs->burst callbacks
+ * in every @rs->interval
+ *
+ * RETURNS:
+ * 0 means callbacks will be suppressed.
+ * 1 means go ahead and do it.
  */
 int ___ratelimit(struct ratelimit_state *rs, const char *func)
 {
@@ -35,7 +40,7 @@
 	 * the entity that is holding the lock already:
 	 */
 	if (!spin_trylock_irqsave(&rs->lock, flags))
-		return 1;
+		return 0;
 
 	if (!rs->begin)
 		rs->begin = jiffies;
diff -urN linux-2.6.34-rc3/lib/rwsem-spinlock.c linux-2.6.34-rc4/lib/rwsem-spinlock.c
--- linux-2.6.34-rc3/lib/rwsem-spinlock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/rwsem-spinlock.c	2010-04-13 02:19:02.151883156 +0000
@@ -143,13 +143,14 @@
 {
 	struct rwsem_waiter waiter;
 	struct task_struct *tsk;
+	unsigned long flags;
 
-	spin_lock_irq(&sem->wait_lock);
+	spin_lock_irqsave(&sem->wait_lock, flags);
 
 	if (sem->activity >= 0 && list_empty(&sem->wait_list)) {
 		/* granted */
 		sem->activity++;
-		spin_unlock_irq(&sem->wait_lock);
+		spin_unlock_irqrestore(&sem->wait_lock, flags);
 		goto out;
 	}
 
@@ -164,7 +165,7 @@
 	list_add_tail(&waiter.list, &sem->wait_list);
 
 	/* we don't need to touch the semaphore struct anymore */
-	spin_unlock_irq(&sem->wait_lock);
+	spin_unlock_irqrestore(&sem->wait_lock, flags);
 
 	/* wait to be given the lock */
 	for (;;) {
@@ -209,13 +210,14 @@
 {
 	struct rwsem_waiter waiter;
 	struct task_struct *tsk;
+	unsigned long flags;
 
-	spin_lock_irq(&sem->wait_lock);
+	spin_lock_irqsave(&sem->wait_lock, flags);
 
 	if (sem->activity == 0 && list_empty(&sem->wait_list)) {
 		/* granted */
 		sem->activity = -1;
-		spin_unlock_irq(&sem->wait_lock);
+		spin_unlock_irqrestore(&sem->wait_lock, flags);
 		goto out;
 	}
 
@@ -230,7 +232,7 @@
 	list_add_tail(&waiter.list, &sem->wait_list);
 
 	/* we don't need to touch the semaphore struct anymore */
-	spin_unlock_irq(&sem->wait_lock);
+	spin_unlock_irqrestore(&sem->wait_lock, flags);
 
 	/* wait to be given the lock */
 	for (;;) {
diff -urN linux-2.6.34-rc3/lib/scatterlist.c linux-2.6.34-rc4/lib/scatterlist.c
--- linux-2.6.34-rc3/lib/scatterlist.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/scatterlist.c	2010-04-13 02:19:02.151883156 +0000
@@ -7,6 +7,7 @@
  * Version 2. See the file COPYING for more details.
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/scatterlist.h>
 #include <linux/highmem.h>
 
diff -urN linux-2.6.34-rc3/lib/swiotlb.c linux-2.6.34-rc4/lib/swiotlb.c
--- linux-2.6.34-rc3/lib/swiotlb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/swiotlb.c	2010-04-13 02:19:02.152883486 +0000
@@ -28,6 +28,7 @@
 #include <linux/types.h>
 #include <linux/ctype.h>
 #include <linux/highmem.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/lib/textsearch.c linux-2.6.34-rc4/lib/textsearch.c
--- linux-2.6.34-rc3/lib/textsearch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/lib/textsearch.c	2010-04-13 02:19:02.152883486 +0000
@@ -103,6 +103,7 @@
 #include <linux/rcupdate.h>
 #include <linux/err.h>
 #include <linux/textsearch.h>
+#include <linux/slab.h>
 
 static LIST_HEAD(ts_ops);
 static DEFINE_SPINLOCK(ts_mod_lock);
diff -urN linux-2.6.34-rc3/mm/Makefile linux-2.6.34-rc4/mm/Makefile
--- linux-2.6.34-rc3/mm/Makefile	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/Makefile	2010-04-13 02:19:02.153884170 +0000
@@ -33,7 +33,11 @@
 obj-$(CONFIG_MEMORY_HOTPLUG) += memory_hotplug.o
 obj-$(CONFIG_FS_XIP) += filemap_xip.o
 obj-$(CONFIG_MIGRATION) += migrate.o
-obj-$(CONFIG_SMP) += percpu.o
+ifdef CONFIG_SMP
+obj-y += percpu.o
+else
+obj-y += percpu_up.o
+endif
 obj-$(CONFIG_QUICKLIST) += quicklist.o
 obj-$(CONFIG_CGROUP_MEM_RES_CTLR) += memcontrol.o page_cgroup.o
 obj-$(CONFIG_MEMORY_FAILURE) += memory-failure.o
diff -urN linux-2.6.34-rc3/mm/backing-dev.c linux-2.6.34-rc4/mm/backing-dev.c
--- linux-2.6.34-rc3/mm/backing-dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/backing-dev.c	2010-04-13 02:19:02.153884170 +0000
@@ -227,6 +227,9 @@
 static __init int bdi_class_init(void)
 {
 	bdi_class = class_create(THIS_MODULE, "bdi");
+	if (IS_ERR(bdi_class))
+		return PTR_ERR(bdi_class);
+
 	bdi_class->dev_attrs = bdi_dev_attrs;
 	bdi_debug_init();
 	return 0;
diff -urN linux-2.6.34-rc3/mm/bootmem.c linux-2.6.34-rc4/mm/bootmem.c
--- linux-2.6.34-rc3/mm/bootmem.c	2010-04-13 02:18:56.676633010 +0000
+++ linux-2.6.34-rc4/mm/bootmem.c	2010-04-13 02:19:02.153884170 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/init.h>
 #include <linux/pfn.h>
+#include <linux/slab.h>
 #include <linux/bootmem.h>
 #include <linux/module.h>
 #include <linux/kmemleak.h>
@@ -303,9 +304,22 @@
 unsigned long __init free_all_bootmem(void)
 {
 #ifdef CONFIG_NO_BOOTMEM
-	return free_all_memory_core_early(NODE_DATA(0)->node_id);
+	/*
+	 * We need to use MAX_NUMNODES instead of NODE_DATA(0)->node_id
+	 *  because in some case like Node0 doesnt have RAM installed
+	 *  low ram will be on Node1
+	 * Use MAX_NUMNODES will make sure all ranges in early_node_map[]
+	 *  will be used instead of only Node0 related
+	 */
+	return free_all_memory_core_early(MAX_NUMNODES);
 #else
-	return free_all_bootmem_core(NODE_DATA(0)->bdata);
+	unsigned long total_pages = 0;
+	bootmem_data_t *bdata;
+
+	list_for_each_entry(bdata, &bdata_list, list)
+		total_pages += free_all_bootmem_core(bdata);
+
+	return total_pages;
 #endif
 }
 
diff -urN linux-2.6.34-rc3/mm/bounce.c linux-2.6.34-rc4/mm/bounce.c
--- linux-2.6.34-rc3/mm/bounce.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/bounce.c	2010-04-13 02:19:02.153884170 +0000
@@ -6,6 +6,7 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/swap.h>
+#include <linux/gfp.h>
 #include <linux/bio.h>
 #include <linux/pagemap.h>
 #include <linux/mempool.h>
diff -urN linux-2.6.34-rc3/mm/failslab.c linux-2.6.34-rc4/mm/failslab.c
--- linux-2.6.34-rc3/mm/failslab.c	2010-04-13 02:18:56.677633079 +0000
+++ linux-2.6.34-rc4/mm/failslab.c	2010-04-13 02:19:02.154883354 +0000
@@ -1,5 +1,4 @@
 #include <linux/fault-inject.h>
-#include <linux/gfp.h>
 #include <linux/slab.h>
 
 static struct {
diff -urN linux-2.6.34-rc3/mm/filemap.c linux-2.6.34-rc4/mm/filemap.c
--- linux-2.6.34-rc3/mm/filemap.c	2010-04-13 02:18:56.677633079 +0000
+++ linux-2.6.34-rc4/mm/filemap.c	2010-04-13 02:19:02.154883354 +0000
@@ -10,13 +10,13 @@
  * the NFS filesystem used to do this differently, for example)
  */
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/compiler.h>
 #include <linux/fs.h>
 #include <linux/uaccess.h>
 #include <linux/aio.h>
 #include <linux/capability.h>
 #include <linux/kernel_stat.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/mman.h>
diff -urN linux-2.6.34-rc3/mm/filemap_xip.c linux-2.6.34-rc4/mm/filemap_xip.c
--- linux-2.6.34-rc3/mm/filemap_xip.c	2010-04-13 02:18:56.677633079 +0000
+++ linux-2.6.34-rc4/mm/filemap_xip.c	2010-04-13 02:19:02.154883354 +0000
@@ -17,6 +17,7 @@
 #include <linux/sched.h>
 #include <linux/seqlock.h>
 #include <linux/mutex.h>
+#include <linux/gfp.h>
 #include <asm/tlbflush.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/mm/hugetlb.c linux-2.6.34-rc4/mm/hugetlb.c
--- linux-2.6.34-rc3/mm/hugetlb.c	2010-04-13 02:18:56.678633034 +0000
+++ linux-2.6.34-rc4/mm/hugetlb.c	2010-04-13 02:19:02.155884055 +0000
@@ -2,7 +2,6 @@
  * Generic hugetlb support.
  * (C) William Irwin, April 2004
  */
-#include <linux/gfp.h>
 #include <linux/list.h>
 #include <linux/init.h>
 #include <linux/module.h>
@@ -18,6 +17,7 @@
 #include <linux/mutex.h>
 #include <linux/bootmem.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 
 #include <asm/page.h>
 #include <asm/pgtable.h>
diff -urN linux-2.6.34-rc3/mm/kmemleak.c linux-2.6.34-rc4/mm/kmemleak.c
--- linux-2.6.34-rc3/mm/kmemleak.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/kmemleak.c	2010-04-13 02:19:02.155884055 +0000
@@ -72,7 +72,6 @@
 #include <linux/module.h>
 #include <linux/kthread.h>
 #include <linux/prio_tree.h>
-#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/debugfs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/mm/memcontrol.c linux-2.6.34-rc4/mm/memcontrol.c
--- linux-2.6.34-rc3/mm/memcontrol.c	2010-04-13 02:18:56.679571951 +0000
+++ linux-2.6.34-rc4/mm/memcontrol.c	2010-04-13 02:19:02.157670674 +0000
@@ -1359,16 +1359,19 @@
 
 	lock_page_cgroup(pc);
 	mem = pc->mem_cgroup;
-	if (!mem)
-		goto done;
-
-	if (!PageCgroupUsed(pc))
+	if (!mem || !PageCgroupUsed(pc))
 		goto done;
 
 	/*
 	 * Preemption is already disabled. We can use __this_cpu_xxx
 	 */
-	__this_cpu_add(mem->stat->count[MEM_CGROUP_STAT_FILE_MAPPED], val);
+	if (val > 0) {
+		__this_cpu_inc(mem->stat->count[MEM_CGROUP_STAT_FILE_MAPPED]);
+		SetPageCgroupFileMapped(pc);
+	} else {
+		__this_cpu_dec(mem->stat->count[MEM_CGROUP_STAT_FILE_MAPPED]);
+		ClearPageCgroupFileMapped(pc);
+	}
 
 done:
 	unlock_page_cgroup(pc);
@@ -1801,16 +1804,13 @@
 static void __mem_cgroup_move_account(struct page_cgroup *pc,
 	struct mem_cgroup *from, struct mem_cgroup *to, bool uncharge)
 {
-	struct page *page;
-
 	VM_BUG_ON(from == to);
 	VM_BUG_ON(PageLRU(pc->page));
 	VM_BUG_ON(!PageCgroupLocked(pc));
 	VM_BUG_ON(!PageCgroupUsed(pc));
 	VM_BUG_ON(pc->mem_cgroup != from);
 
-	page = pc->page;
-	if (page_mapped(page) && !PageAnon(page)) {
+	if (PageCgroupFileMapped(pc)) {
 		/* Update mapped_file data for mem_cgroup */
 		preempt_disable();
 		__this_cpu_dec(from->stat->count[MEM_CGROUP_STAT_FILE_MAPPED]);
diff -urN linux-2.6.34-rc3/mm/memory-failure.c linux-2.6.34-rc4/mm/memory-failure.c
--- linux-2.6.34-rc3/mm/memory-failure.c	2010-04-13 02:18:56.679571951 +0000
+++ linux-2.6.34-rc4/mm/memory-failure.c	2010-04-13 02:19:02.157670674 +0000
@@ -44,6 +44,7 @@
 #include <linux/migrate.h>
 #include <linux/page-isolation.h>
 #include <linux/suspend.h>
+#include <linux/slab.h>
 #include "internal.h"
 
 int sysctl_memory_failure_early_kill __read_mostly = 0;
diff -urN linux-2.6.34-rc3/mm/memory.c linux-2.6.34-rc4/mm/memory.c
--- linux-2.6.34-rc3/mm/memory.c	2010-04-13 02:18:56.680570675 +0000
+++ linux-2.6.34-rc4/mm/memory.c	2010-04-13 02:19:02.158883683 +0000
@@ -56,6 +56,7 @@
 #include <linux/kallsyms.h>
 #include <linux/swapops.h>
 #include <linux/elf.h>
+#include <linux/gfp.h>
 
 #include <asm/io.h>
 #include <asm/pgalloc.h>
@@ -124,13 +125,12 @@
 
 #if defined(SPLIT_RSS_COUNTING)
 
-void __sync_task_rss_stat(struct task_struct *task, struct mm_struct *mm)
+static void __sync_task_rss_stat(struct task_struct *task, struct mm_struct *mm)
 {
 	int i;
 
 	for (i = 0; i < NR_MM_COUNTERS; i++) {
 		if (task->rss_stat.count[i]) {
-			BUG_ON(!mm);
 			add_mm_counter(mm, i, task->rss_stat.count[i]);
 			task->rss_stat.count[i] = 0;
 		}
diff -urN linux-2.6.34-rc3/mm/mempolicy.c linux-2.6.34-rc4/mm/mempolicy.c
--- linux-2.6.34-rc3/mm/mempolicy.c	2010-04-13 02:18:56.681570653 +0000
+++ linux-2.6.34-rc4/mm/mempolicy.c	2010-04-13 02:19:02.158883683 +0000
@@ -73,7 +73,6 @@
 #include <linux/sched.h>
 #include <linux/nodemask.h>
 #include <linux/cpuset.h>
-#include <linux/gfp.h>
 #include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/mm/migrate.c linux-2.6.34-rc4/mm/migrate.c
--- linux-2.6.34-rc3/mm/migrate.c	2010-04-13 02:18:56.681570653 +0000
+++ linux-2.6.34-rc4/mm/migrate.c	2010-04-13 02:19:02.158883683 +0000
@@ -32,6 +32,7 @@
 #include <linux/security.h>
 #include <linux/memcontrol.h>
 #include <linux/syscalls.h>
+#include <linux/gfp.h>
 
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/mm/mincore.c linux-2.6.34-rc4/mm/mincore.c
--- linux-2.6.34-rc3/mm/mincore.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/mincore.c	2010-04-13 02:19:02.159883865 +0000
@@ -7,8 +7,8 @@
 /*
  * The mincore() system call.
  */
-#include <linux/slab.h>
 #include <linux/pagemap.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/mman.h>
 #include <linux/syscalls.h>
diff -urN linux-2.6.34-rc3/mm/mmap.c linux-2.6.34-rc4/mm/mmap.c
--- linux-2.6.34-rc3/mm/mmap.c	2010-04-13 02:18:56.682633069 +0000
+++ linux-2.6.34-rc4/mm/mmap.c	2010-04-13 02:19:02.159883865 +0000
@@ -507,11 +507,12 @@
 	struct address_space *mapping = NULL;
 	struct prio_tree_root *root = NULL;
 	struct file *file = vma->vm_file;
-	struct anon_vma *anon_vma = NULL;
 	long adjust_next = 0;
 	int remove_next = 0;
 
 	if (next && !insert) {
+		struct vm_area_struct *exporter = NULL;
+
 		if (end >= next->vm_end) {
 			/*
 			 * vma expands, overlapping all the next, and
@@ -519,7 +520,7 @@
 			 */
 again:			remove_next = 1 + (end > next->vm_end);
 			end = next->vm_end;
-			anon_vma = next->anon_vma;
+			exporter = next;
 			importer = vma;
 		} else if (end > next->vm_start) {
 			/*
@@ -527,7 +528,7 @@
 			 * mprotect case 5 shifting the boundary up.
 			 */
 			adjust_next = (end - next->vm_start) >> PAGE_SHIFT;
-			anon_vma = next->anon_vma;
+			exporter = next;
 			importer = vma;
 		} else if (end < vma->vm_end) {
 			/*
@@ -536,28 +537,19 @@
 			 * mprotect case 4 shifting the boundary down.
 			 */
 			adjust_next = - ((vma->vm_end - end) >> PAGE_SHIFT);
-			anon_vma = next->anon_vma;
+			exporter = vma;
 			importer = next;
 		}
-	}
 
-	/*
-	 * When changing only vma->vm_end, we don't really need anon_vma lock.
-	 */
-	if (vma->anon_vma && (insert || importer || start != vma->vm_start))
-		anon_vma = vma->anon_vma;
-	if (anon_vma) {
 		/*
 		 * Easily overlooked: when mprotect shifts the boundary,
 		 * make sure the expanding vma has anon_vma set if the
 		 * shrinking vma had, to cover any anon pages imported.
 		 */
-		if (importer && !importer->anon_vma) {
-			/* Block reverse map lookups until things are set up. */
-			if (anon_vma_clone(importer, vma)) {
+		if (exporter && exporter->anon_vma && !importer->anon_vma) {
+			if (anon_vma_clone(importer, exporter))
 				return -ENOMEM;
-			}
-			importer->anon_vma = anon_vma;
+			importer->anon_vma = exporter->anon_vma;
 		}
 	}
 
@@ -825,6 +817,61 @@
 }
 
 /*
+ * Rough compatbility check to quickly see if it's even worth looking
+ * at sharing an anon_vma.
+ *
+ * They need to have the same vm_file, and the flags can only differ
+ * in things that mprotect may change.
+ *
+ * NOTE! The fact that we share an anon_vma doesn't _have_ to mean that
+ * we can merge the two vma's. For example, we refuse to merge a vma if
+ * there is a vm_ops->close() function, because that indicates that the
+ * driver is doing some kind of reference counting. But that doesn't
+ * really matter for the anon_vma sharing case.
+ */
+static int anon_vma_compatible(struct vm_area_struct *a, struct vm_area_struct *b)
+{
+	return a->vm_end == b->vm_start &&
+		mpol_equal(vma_policy(a), vma_policy(b)) &&
+		a->vm_file == b->vm_file &&
+		!((a->vm_flags ^ b->vm_flags) & ~(VM_READ|VM_WRITE|VM_EXEC)) &&
+		b->vm_pgoff == a->vm_pgoff + ((b->vm_start - a->vm_start) >> PAGE_SHIFT);
+}
+
+/*
+ * Do some basic sanity checking to see if we can re-use the anon_vma
+ * from 'old'. The 'a'/'b' vma's are in VM order - one of them will be
+ * the same as 'old', the other will be the new one that is trying
+ * to share the anon_vma.
+ *
+ * NOTE! This runs with mm_sem held for reading, so it is possible that
+ * the anon_vma of 'old' is concurrently in the process of being set up
+ * by another page fault trying to merge _that_. But that's ok: if it
+ * is being set up, that automatically means that it will be a singleton
+ * acceptable for merging, so we can do all of this optimistically. But
+ * we do that ACCESS_ONCE() to make sure that we never re-load the pointer.
+ *
+ * IOW: that the "list_is_singular()" test on the anon_vma_chain only
+ * matters for the 'stable anon_vma' case (ie the thing we want to avoid
+ * is to return an anon_vma that is "complex" due to having gone through
+ * a fork).
+ *
+ * We also make sure that the two vma's are compatible (adjacent,
+ * and with the same memory policies). That's all stable, even with just
+ * a read lock on the mm_sem.
+ */
+static struct anon_vma *reusable_anon_vma(struct vm_area_struct *old, struct vm_area_struct *a, struct vm_area_struct *b)
+{
+	if (anon_vma_compatible(a, b)) {
+		struct anon_vma *anon_vma = ACCESS_ONCE(old->anon_vma);
+
+		if (anon_vma && list_is_singular(&old->anon_vma_chain))
+			return anon_vma;
+	}
+	return NULL;
+}
+
+/*
  * find_mergeable_anon_vma is used by anon_vma_prepare, to check
  * neighbouring vmas for a suitable anon_vma, before it goes off
  * to allocate a new anon_vma.  It checks because a repetitive
@@ -834,28 +881,16 @@
  */
 struct anon_vma *find_mergeable_anon_vma(struct vm_area_struct *vma)
 {
+	struct anon_vma *anon_vma;
 	struct vm_area_struct *near;
-	unsigned long vm_flags;
 
 	near = vma->vm_next;
 	if (!near)
 		goto try_prev;
 
-	/*
-	 * Since only mprotect tries to remerge vmas, match flags
-	 * which might be mprotected into each other later on.
-	 * Neither mlock nor madvise tries to remerge at present,
-	 * so leave their flags as obstructing a merge.
-	 */
-	vm_flags = vma->vm_flags & ~(VM_READ|VM_WRITE|VM_EXEC);
-	vm_flags |= near->vm_flags & (VM_READ|VM_WRITE|VM_EXEC);
-
-	if (near->anon_vma && vma->vm_end == near->vm_start &&
- 			mpol_equal(vma_policy(vma), vma_policy(near)) &&
-			can_vma_merge_before(near, vm_flags,
-				NULL, vma->vm_file, vma->vm_pgoff +
-				((vma->vm_end - vma->vm_start) >> PAGE_SHIFT)))
-		return near->anon_vma;
+	anon_vma = reusable_anon_vma(near, vma, near);
+	if (anon_vma)
+		return anon_vma;
 try_prev:
 	/*
 	 * It is potentially slow to have to call find_vma_prev here.
@@ -868,14 +903,9 @@
 	if (!near)
 		goto none;
 
-	vm_flags = vma->vm_flags & ~(VM_READ|VM_WRITE|VM_EXEC);
-	vm_flags |= near->vm_flags & (VM_READ|VM_WRITE|VM_EXEC);
-
-	if (near->anon_vma && near->vm_end == vma->vm_start &&
-  			mpol_equal(vma_policy(near), vma_policy(vma)) &&
-			can_vma_merge_after(near, vm_flags,
-				NULL, vma->vm_file, vma->vm_pgoff))
-		return near->anon_vma;
+	anon_vma = reusable_anon_vma(near, near, vma);
+	if (anon_vma)
+		return anon_vma;
 none:
 	/*
 	 * There's no absolute need to look only at touching neighbours:
diff -urN linux-2.6.34-rc3/mm/mmu_notifier.c linux-2.6.34-rc4/mm/mmu_notifier.c
--- linux-2.6.34-rc3/mm/mmu_notifier.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/mmu_notifier.c	2010-04-13 02:19:02.160883670 +0000
@@ -16,6 +16,7 @@
 #include <linux/err.h>
 #include <linux/rcupdate.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 
 /*
  * This function can't run concurrently against mmu_notifier_register
diff -urN linux-2.6.34-rc3/mm/mprotect.c linux-2.6.34-rc4/mm/mprotect.c
--- linux-2.6.34-rc3/mm/mprotect.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/mprotect.c	2010-04-13 02:19:02.160883670 +0000
@@ -10,7 +10,6 @@
 
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
-#include <linux/slab.h>
 #include <linux/shm.h>
 #include <linux/mman.h>
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/mm/mremap.c linux-2.6.34-rc4/mm/mremap.c
--- linux-2.6.34-rc3/mm/mremap.c	2010-04-13 02:18:56.682633069 +0000
+++ linux-2.6.34-rc4/mm/mremap.c	2010-04-13 02:19:02.160883670 +0000
@@ -9,7 +9,6 @@
 
 #include <linux/mm.h>
 #include <linux/hugetlb.h>
-#include <linux/slab.h>
 #include <linux/shm.h>
 #include <linux/ksm.h>
 #include <linux/mman.h>
diff -urN linux-2.6.34-rc3/mm/oom_kill.c linux-2.6.34-rc4/mm/oom_kill.c
--- linux-2.6.34-rc3/mm/oom_kill.c	2010-04-13 02:18:56.682633069 +0000
+++ linux-2.6.34-rc4/mm/oom_kill.c	2010-04-13 02:19:02.160883670 +0000
@@ -18,6 +18,7 @@
 #include <linux/oom.h>
 #include <linux/mm.h>
 #include <linux/err.h>
+#include <linux/gfp.h>
 #include <linux/sched.h>
 #include <linux/swap.h>
 #include <linux/timex.h>
diff -urN linux-2.6.34-rc3/mm/page_io.c linux-2.6.34-rc4/mm/page_io.c
--- linux-2.6.34-rc3/mm/page_io.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/page_io.c	2010-04-13 02:19:02.162882961 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/mm.h>
 #include <linux/kernel_stat.h>
+#include <linux/gfp.h>
 #include <linux/pagemap.h>
 #include <linux/swap.h>
 #include <linux/bio.h>
diff -urN linux-2.6.34-rc3/mm/pagewalk.c linux-2.6.34-rc4/mm/pagewalk.c
--- linux-2.6.34-rc3/mm/pagewalk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/pagewalk.c	2010-04-13 02:19:02.162882961 +0000
@@ -80,6 +80,37 @@
 	return err;
 }
 
+#ifdef CONFIG_HUGETLB_PAGE
+static unsigned long hugetlb_entry_end(struct hstate *h, unsigned long addr,
+				       unsigned long end)
+{
+	unsigned long boundary = (addr & huge_page_mask(h)) + huge_page_size(h);
+	return boundary < end ? boundary : end;
+}
+
+static int walk_hugetlb_range(struct vm_area_struct *vma,
+			      unsigned long addr, unsigned long end,
+			      struct mm_walk *walk)
+{
+	struct hstate *h = hstate_vma(vma);
+	unsigned long next;
+	unsigned long hmask = huge_page_mask(h);
+	pte_t *pte;
+	int err = 0;
+
+	do {
+		next = hugetlb_entry_end(h, addr, end);
+		pte = huge_pte_offset(walk->mm, addr & hmask);
+		if (pte && walk->hugetlb_entry)
+			err = walk->hugetlb_entry(pte, hmask, addr, next, walk);
+		if (err)
+			return err;
+	} while (addr = next, addr != end);
+
+	return 0;
+}
+#endif
+
 /**
  * walk_page_range - walk a memory map's page tables with a callback
  * @mm: memory map to walk
@@ -128,20 +159,16 @@
 		vma = find_vma(walk->mm, addr);
 #ifdef CONFIG_HUGETLB_PAGE
 		if (vma && is_vm_hugetlb_page(vma)) {
-			pte_t *pte;
-			struct hstate *hs;
-
 			if (vma->vm_end < next)
 				next = vma->vm_end;
-			hs = hstate_vma(vma);
-			pte = huge_pte_offset(walk->mm,
-					      addr & huge_page_mask(hs));
-			if (pte && !huge_pte_none(huge_ptep_get(pte))
-			    && walk->hugetlb_entry)
-				err = walk->hugetlb_entry(pte, addr,
-							  next, walk);
+			/*
+			 * Hugepage is very tightly coupled with vma, so
+			 * walk through hugetlb entries within a given vma.
+			 */
+			err = walk_hugetlb_range(vma, addr, next, walk);
 			if (err)
 				break;
+			pgd = pgd_offset(walk->mm, next);
 			continue;
 		}
 #endif
diff -urN linux-2.6.34-rc3/mm/percpu.c linux-2.6.34-rc4/mm/percpu.c
--- linux-2.6.34-rc3/mm/percpu.c	2010-04-13 02:18:56.684633028 +0000
+++ linux-2.6.34-rc4/mm/percpu.c	2010-04-13 02:19:02.162882961 +0000
@@ -1304,6 +1304,32 @@
 EXPORT_SYMBOL_GPL(free_percpu);
 
 /**
+ * is_kernel_percpu_address - test whether address is from static percpu area
+ * @addr: address to test
+ *
+ * Test whether @addr belongs to in-kernel static percpu area.  Module
+ * static percpu areas are not considered.  For those, use
+ * is_module_percpu_address().
+ *
+ * RETURNS:
+ * %true if @addr is from in-kernel static percpu area, %false otherwise.
+ */
+bool is_kernel_percpu_address(unsigned long addr)
+{
+	const size_t static_size = __per_cpu_end - __per_cpu_start;
+	void __percpu *base = __addr_to_pcpu_ptr(pcpu_base_addr);
+	unsigned int cpu;
+
+	for_each_possible_cpu(cpu) {
+		void *start = per_cpu_ptr(base, cpu);
+
+		if ((void *)addr >= start && (void *)addr < start + static_size)
+			return true;
+        }
+	return false;
+}
+
+/**
  * per_cpu_ptr_to_phys - convert translated percpu address to physical address
  * @addr: the address to be converted to physical address
  *
diff -urN linux-2.6.34-rc3/mm/percpu_up.c linux-2.6.34-rc4/mm/percpu_up.c
--- linux-2.6.34-rc3/mm/percpu_up.c	1970-01-01 00:00:00.000000000 +0000
+++ linux-2.6.34-rc4/mm/percpu_up.c	2010-04-13 02:19:02.162882961 +0000
@@ -0,0 +1,30 @@
+/*
+ * mm/percpu_up.c - dummy percpu memory allocator implementation for UP
+ */
+
+#include <linux/module.h>
+#include <linux/percpu.h>
+#include <linux/slab.h>
+
+void __percpu *__alloc_percpu(size_t size, size_t align)
+{
+	/*
+	 * Can't easily make larger alignment work with kmalloc.  WARN
+	 * on it.  Larger alignment should only be used for module
+	 * percpu sections on SMP for which this path isn't used.
+	 */
+	WARN_ON_ONCE(align > SMP_CACHE_BYTES);
+	return kzalloc(size, GFP_KERNEL);
+}
+EXPORT_SYMBOL_GPL(__alloc_percpu);
+
+void free_percpu(void __percpu *p)
+{
+	kfree(p);
+}
+EXPORT_SYMBOL_GPL(free_percpu);
+
+phys_addr_t per_cpu_ptr_to_phys(void *addr)
+{
+	return __pa(addr);
+}
diff -urN linux-2.6.34-rc3/mm/quicklist.c linux-2.6.34-rc4/mm/quicklist.c
--- linux-2.6.34-rc3/mm/quicklist.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/quicklist.c	2010-04-13 02:19:02.162882961 +0000
@@ -14,6 +14,7 @@
  */
 #include <linux/kernel.h>
 
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/mmzone.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/mm/readahead.c linux-2.6.34-rc4/mm/readahead.c
--- linux-2.6.34-rc3/mm/readahead.c	2010-04-13 02:18:56.684633028 +0000
+++ linux-2.6.34-rc4/mm/readahead.c	2010-04-13 02:19:02.162882961 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/kernel.h>
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/blkdev.h>
@@ -502,7 +503,7 @@
 		return;
 
 	/* be dumb */
-	if (filp->f_mode & FMODE_RANDOM) {
+	if (filp && (filp->f_mode & FMODE_RANDOM)) {
 		force_page_cache_readahead(mapping, filp, offset, req_size);
 		return;
 	}
diff -urN linux-2.6.34-rc3/mm/rmap.c linux-2.6.34-rc4/mm/rmap.c
--- linux-2.6.34-rc3/mm/rmap.c	2010-04-13 02:18:56.684633028 +0000
+++ linux-2.6.34-rc4/mm/rmap.c	2010-04-13 02:19:02.163884425 +0000
@@ -182,7 +182,7 @@
 {
 	struct anon_vma_chain *avc, *pavc;
 
-	list_for_each_entry(pavc, &src->anon_vma_chain, same_vma) {
+	list_for_each_entry_reverse(pavc, &src->anon_vma_chain, same_vma) {
 		avc = anon_vma_chain_alloc();
 		if (!avc)
 			goto enomem_failure;
@@ -232,6 +232,7 @@
  out_error_free_anon_vma:
 	anon_vma_free(anon_vma);
  out_error:
+	unlink_anon_vmas(vma);
 	return -ENOMEM;
 }
 
@@ -733,9 +734,20 @@
 static void __page_set_anon_rmap(struct page *page,
 	struct vm_area_struct *vma, unsigned long address)
 {
-	struct anon_vma *anon_vma = vma->anon_vma;
+	struct anon_vma_chain *avc;
+	struct anon_vma *anon_vma;
+
+	BUG_ON(!vma->anon_vma);
+
+	/*
+	 * We must use the _oldest_ possible anon_vma for the page mapping!
+	 *
+	 * So take the last AVC chain entry in the vma, which is the deepest
+	 * ancestor, and use the anon_vma from that.
+	 */
+	avc = list_entry(vma->anon_vma_chain.prev, struct anon_vma_chain, same_vma);
+	anon_vma = avc->anon_vma;
 
-	BUG_ON(!anon_vma);
 	anon_vma = (void *) anon_vma + PAGE_MAPPING_ANON;
 	page->mapping = (struct address_space *) anon_vma;
 	page->index = linear_page_index(vma, address);
diff -urN linux-2.6.34-rc3/mm/slab.c linux-2.6.34-rc4/mm/slab.c
--- linux-2.6.34-rc3/mm/slab.c	2010-04-13 02:18:56.685633060 +0000
+++ linux-2.6.34-rc4/mm/slab.c	2010-04-13 02:19:02.163884425 +0000
@@ -3602,21 +3602,10 @@
  */
 int kmem_ptr_validate(struct kmem_cache *cachep, const void *ptr)
 {
-	unsigned long addr = (unsigned long)ptr;
-	unsigned long min_addr = PAGE_OFFSET;
-	unsigned long align_mask = BYTES_PER_WORD - 1;
 	unsigned long size = cachep->buffer_size;
 	struct page *page;
 
-	if (unlikely(addr < min_addr))
-		goto out;
-	if (unlikely(addr > (unsigned long)high_memory - size))
-		goto out;
-	if (unlikely(addr & align_mask))
-		goto out;
-	if (unlikely(!kern_addr_valid(addr)))
-		goto out;
-	if (unlikely(!kern_addr_valid(addr + size - 1)))
+	if (unlikely(!kern_ptr_validate(ptr, size)))
 		goto out;
 	page = virt_to_page(ptr);
 	if (unlikely(!PageSlab(page)))
diff -urN linux-2.6.34-rc3/mm/slub.c linux-2.6.34-rc4/mm/slub.c
--- linux-2.6.34-rc3/mm/slub.c	2010-04-13 02:18:56.686633104 +0000
+++ linux-2.6.34-rc4/mm/slub.c	2010-04-13 02:19:02.164883459 +0000
@@ -2386,6 +2386,9 @@
 {
 	struct page *page;
 
+	if (!kern_ptr_validate(object, s->size))
+		return 0;
+
 	page = get_object_page(object);
 
 	if (!page || s != page->slab)
diff -urN linux-2.6.34-rc3/mm/sparse-vmemmap.c linux-2.6.34-rc4/mm/sparse-vmemmap.c
--- linux-2.6.34-rc3/mm/sparse-vmemmap.c	2010-04-13 02:18:56.686633104 +0000
+++ linux-2.6.34-rc4/mm/sparse-vmemmap.c	2010-04-13 02:19:02.165883921 +0000
@@ -22,6 +22,7 @@
 #include <linux/bootmem.h>
 #include <linux/highmem.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/vmalloc.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/mm/sparse.c linux-2.6.34-rc4/mm/sparse.c
--- linux-2.6.34-rc3/mm/sparse.c	2010-04-13 02:18:56.686633104 +0000
+++ linux-2.6.34-rc4/mm/sparse.c	2010-04-13 02:19:02.165883921 +0000
@@ -2,6 +2,7 @@
  * sparse memory mappings.
  */
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/mmzone.h>
 #include <linux/bootmem.h>
 #include <linux/highmem.h>
diff -urN linux-2.6.34-rc3/mm/swap.c linux-2.6.34-rc4/mm/swap.c
--- linux-2.6.34-rc3/mm/swap.c	2010-04-13 02:18:56.686633104 +0000
+++ linux-2.6.34-rc4/mm/swap.c	2010-04-13 02:19:02.165883921 +0000
@@ -30,6 +30,7 @@
 #include <linux/notifier.h>
 #include <linux/backing-dev.h>
 #include <linux/memcontrol.h>
+#include <linux/gfp.h>
 
 #include "internal.h"
 
diff -urN linux-2.6.34-rc3/mm/swap_state.c linux-2.6.34-rc4/mm/swap_state.c
--- linux-2.6.34-rc3/mm/swap_state.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/swap_state.c	2010-04-13 02:19:02.165883921 +0000
@@ -8,6 +8,7 @@
  */
 #include <linux/module.h>
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include <linux/kernel_stat.h>
 #include <linux/swap.h>
 #include <linux/swapops.h>
diff -urN linux-2.6.34-rc3/mm/truncate.c linux-2.6.34-rc4/mm/truncate.c
--- linux-2.6.34-rc3/mm/truncate.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/truncate.c	2010-04-13 02:19:02.166883491 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/kernel.h>
 #include <linux/backing-dev.h>
+#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/swap.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/mm/util.c linux-2.6.34-rc4/mm/util.c
--- linux-2.6.34-rc3/mm/util.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/mm/util.c	2010-04-13 02:19:02.166883491 +0000
@@ -186,6 +186,27 @@
 }
 EXPORT_SYMBOL(kzfree);
 
+int kern_ptr_validate(const void *ptr, unsigned long size)
+{
+	unsigned long addr = (unsigned long)ptr;
+	unsigned long min_addr = PAGE_OFFSET;
+	unsigned long align_mask = sizeof(void *) - 1;
+
+	if (unlikely(addr < min_addr))
+		goto out;
+	if (unlikely(addr > (unsigned long)high_memory - size))
+		goto out;
+	if (unlikely(addr & align_mask))
+		goto out;
+	if (unlikely(!kern_addr_valid(addr)))
+		goto out;
+	if (unlikely(!kern_addr_valid(addr + size - 1)))
+		goto out;
+	return 1;
+out:
+	return 0;
+}
+
 /*
  * strndup_user - duplicate an existing string from user space
  * @s: The string to duplicate
diff -urN linux-2.6.34-rc3/mm/vmscan.c linux-2.6.34-rc4/mm/vmscan.c
--- linux-2.6.34-rc3/mm/vmscan.c	2010-04-13 02:18:56.687633028 +0000
+++ linux-2.6.34-rc4/mm/vmscan.c	2010-04-13 02:19:02.167883353 +0000
@@ -13,7 +13,7 @@
 
 #include <linux/mm.h>
 #include <linux/module.h>
-#include <linux/slab.h>
+#include <linux/gfp.h>
 #include <linux/kernel_stat.h>
 #include <linux/swap.h>
 #include <linux/pagemap.h>
@@ -1535,13 +1535,6 @@
 	unsigned long ap, fp;
 	struct zone_reclaim_stat *reclaim_stat = get_reclaim_stat(zone, sc);
 
-	/* If we have no swap space, do not bother scanning anon pages. */
-	if (!sc->may_swap || (nr_swap_pages <= 0)) {
-		percent[0] = 0;
-		percent[1] = 100;
-		return;
-	}
-
 	anon  = zone_nr_lru_pages(zone, sc, LRU_ACTIVE_ANON) +
 		zone_nr_lru_pages(zone, sc, LRU_INACTIVE_ANON);
 	file  = zone_nr_lru_pages(zone, sc, LRU_ACTIVE_FILE) +
@@ -1639,20 +1632,22 @@
 	unsigned long nr_reclaimed = sc->nr_reclaimed;
 	unsigned long nr_to_reclaim = sc->nr_to_reclaim;
 	struct zone_reclaim_stat *reclaim_stat = get_reclaim_stat(zone, sc);
+	int noswap = 0;
 
-	get_scan_ratio(zone, sc, percent);
+	/* If we have no swap space, do not bother scanning anon pages. */
+	if (!sc->may_swap || (nr_swap_pages <= 0)) {
+		noswap = 1;
+		percent[0] = 0;
+		percent[1] = 100;
+	} else
+		get_scan_ratio(zone, sc, percent);
 
 	for_each_evictable_lru(l) {
 		int file = is_file_lru(l);
 		unsigned long scan;
 
-		if (percent[file] == 0) {
-			nr[l] = 0;
-			continue;
-		}
-
 		scan = zone_nr_lru_pages(zone, sc, l);
-		if (priority) {
+		if (priority || noswap) {
 			scan >>= priority;
 			scan = (scan * percent[file]) / 100;
 		}
diff -urN linux-2.6.34-rc3/mm/vmstat.c linux-2.6.34-rc4/mm/vmstat.c
--- linux-2.6.34-rc3/mm/vmstat.c	2010-04-13 02:18:56.687633028 +0000
+++ linux-2.6.34-rc4/mm/vmstat.c	2010-04-13 02:19:02.167883353 +0000
@@ -12,6 +12,7 @@
 #include <linux/mm.h>
 #include <linux/err.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/cpu.h>
 #include <linux/vmstat.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/net/802/garp.c linux-2.6.34-rc4/net/802/garp.c
--- linux-2.6.34-rc3/net/802/garp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/garp.c	2010-04-13 02:19:02.167883353 +0000
@@ -14,6 +14,7 @@
 #include <linux/etherdevice.h>
 #include <linux/rtnetlink.h>
 #include <linux/llc.h>
+#include <linux/slab.h>
 #include <net/llc.h>
 #include <net/llc_pdu.h>
 #include <net/garp.h>
diff -urN linux-2.6.34-rc3/net/802/p8022.c linux-2.6.34-rc4/net/802/p8022.c
--- linux-2.6.34-rc3/net/802/p8022.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/p8022.c	2010-04-13 02:19:02.167883353 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/datalink.h>
 #include <linux/mm.h>
 #include <linux/in.h>
diff -urN linux-2.6.34-rc3/net/802/p8023.c linux-2.6.34-rc4/net/802/p8023.c
--- linux-2.6.34-rc3/net/802/p8023.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/p8023.c	2010-04-13 02:19:02.167883353 +0000
@@ -18,6 +18,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/datalink.h>
 #include <net/p8022.h>
diff -urN linux-2.6.34-rc3/net/802/psnap.c linux-2.6.34-rc4/net/802/psnap.c
--- linux-2.6.34-rc3/net/802/psnap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/psnap.c	2010-04-13 02:19:02.167883353 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/datalink.h>
 #include <net/llc.h>
 #include <net/psnap.h>
diff -urN linux-2.6.34-rc3/net/802/stp.c linux-2.6.34-rc4/net/802/stp.c
--- linux-2.6.34-rc3/net/802/stp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/stp.c	2010-04-13 02:19:02.167883353 +0000
@@ -11,6 +11,7 @@
 #include <linux/skbuff.h>
 #include <linux/etherdevice.h>
 #include <linux/llc.h>
+#include <linux/slab.h>
 #include <net/llc.h>
 #include <net/llc_pdu.h>
 #include <net/stp.h>
diff -urN linux-2.6.34-rc3/net/802/tr.c linux-2.6.34-rc4/net/802/tr.c
--- linux-2.6.34-rc3/net/802/tr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/802/tr.c	2010-04-13 02:19:02.167883353 +0000
@@ -36,6 +36,7 @@
 #include <linux/seq_file.h>
 #include <linux/init.h>
 #include <linux/sysctl.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <net/net_namespace.h>
 
diff -urN linux-2.6.34-rc3/net/8021q/vlan.c linux-2.6.34-rc4/net/8021q/vlan.c
--- linux-2.6.34-rc3/net/8021q/vlan.c	2010-04-13 02:18:56.688575560 +0000
+++ linux-2.6.34-rc4/net/8021q/vlan.c	2010-04-13 02:19:02.168884187 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/rculist.h>
 #include <net/p8022.h>
diff -urN linux-2.6.34-rc3/net/8021q/vlan_dev.c linux-2.6.34-rc4/net/8021q/vlan_dev.c
--- linux-2.6.34-rc3/net/8021q/vlan_dev.c	2010-04-13 02:18:56.688575560 +0000
+++ linux-2.6.34-rc4/net/8021q/vlan_dev.c	2010-04-13 02:19:02.168884187 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/net/9p/client.c linux-2.6.34-rc4/net/9p/client.c
--- linux-2.6.34-rc3/net/9p/client.c	2010-04-13 02:18:56.688575560 +0000
+++ linux-2.6.34-rc4/net/9p/client.c	2010-04-13 02:19:02.168884187 +0000
@@ -29,6 +29,7 @@
 #include <linux/poll.h>
 #include <linux/idr.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/uaccess.h>
 #include <net/9p/9p.h>
@@ -71,9 +72,10 @@
 EXPORT_SYMBOL(p9_is_proto_dotu);
 
 /* Interpret mount option for protocol version */
-static unsigned char get_protocol_version(const substring_t *name)
+static int get_protocol_version(const substring_t *name)
 {
-	unsigned char version = -EINVAL;
+	int version = -EINVAL;
+
 	if (!strncmp("9p2000", name->from, name->to-name->from)) {
 		version = p9_proto_legacy;
 		P9_DPRINTK(P9_DEBUG_9P, "Protocol version: Legacy\n");
@@ -533,7 +535,12 @@
 
 	P9_DPRINTK(P9_DEBUG_MUX, "client %p op %d\n", c, type);
 
-	if (c->status != Connected)
+	/* we allow for any status other than disconnected */
+	if (c->status == Disconnected)
+		return ERR_PTR(-EIO);
+
+	/* if status is begin_disconnected we allow only clunk request */
+	if ((c->status == BeginDisconnect) && (type != P9_TCLUNK))
 		return ERR_PTR(-EIO);
 
 	if (signal_pending(current)) {
@@ -799,8 +806,10 @@
 
 	v9fs_put_trans(clnt->trans_mod);
 
-	list_for_each_entry_safe(fid, fidptr, &clnt->fidlist, flist)
+	list_for_each_entry_safe(fid, fidptr, &clnt->fidlist, flist) {
+		printk(KERN_INFO "Found fid %d not clunked\n", fid->fid);
 		p9_fid_destroy(fid);
+	}
 
 	if (clnt->fidpool)
 		p9_idpool_destroy(clnt->fidpool);
@@ -818,6 +827,13 @@
 }
 EXPORT_SYMBOL(p9_client_disconnect);
 
+void p9_client_begin_disconnect(struct p9_client *clnt)
+{
+	P9_DPRINTK(P9_DEBUG_9P, "clnt %p\n", clnt);
+	clnt->status = BeginDisconnect;
+}
+EXPORT_SYMBOL(p9_client_begin_disconnect);
+
 struct p9_fid *p9_client_attach(struct p9_client *clnt, struct p9_fid *afid,
 	char *uname, u32 n_uname, char *aname)
 {
diff -urN linux-2.6.34-rc3/net/9p/protocol.c linux-2.6.34-rc4/net/9p/protocol.c
--- linux-2.6.34-rc3/net/9p/protocol.c	2010-04-13 02:18:56.689570627 +0000
+++ linux-2.6.34-rc4/net/9p/protocol.c	2010-04-13 02:19:02.169883563 +0000
@@ -28,6 +28,7 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/types.h>
 #include <net/9p/9p.h>
diff -urN linux-2.6.34-rc3/net/9p/trans_fd.c linux-2.6.34-rc4/net/9p/trans_fd.c
--- linux-2.6.34-rc3/net/9p/trans_fd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/9p/trans_fd.c	2010-04-13 02:19:02.169883563 +0000
@@ -38,6 +38,7 @@
 #include <linux/idr.h>
 #include <linux/file.h>
 #include <linux/parser.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 #include <net/9p/transport.h>
diff -urN linux-2.6.34-rc3/net/9p/trans_rdma.c linux-2.6.34-rc4/net/9p/trans_rdma.c
--- linux-2.6.34-rc3/net/9p/trans_rdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/9p/trans_rdma.c	2010-04-13 02:19:02.169883563 +0000
@@ -40,6 +40,7 @@
 #include <linux/file.h>
 #include <linux/parser.h>
 #include <linux/semaphore.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <net/9p/client.h>
 #include <net/9p/transport.h>
diff -urN linux-2.6.34-rc3/net/9p/trans_virtio.c linux-2.6.34-rc4/net/9p/trans_virtio.c
--- linux-2.6.34-rc3/net/9p/trans_virtio.c	2010-04-13 02:18:56.689570627 +0000
+++ linux-2.6.34-rc4/net/9p/trans_virtio.c	2010-04-13 02:19:02.169883563 +0000
@@ -37,6 +37,7 @@
 #include <linux/inet.h>
 #include <linux/idr.h>
 #include <linux/file.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 #include <linux/parser.h>
 #include <net/9p/client.h>
diff -urN linux-2.6.34-rc3/net/9p/util.c linux-2.6.34-rc4/net/9p/util.c
--- linux-2.6.34-rc3/net/9p/util.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/9p/util.c	2010-04-13 02:19:02.169883563 +0000
@@ -30,6 +30,7 @@
 #include <linux/sched.h>
 #include <linux/parser.h>
 #include <linux/idr.h>
+#include <linux/slab.h>
 #include <net/9p/9p.h>
 
 /**
diff -urN linux-2.6.34-rc3/net/appletalk/aarp.c linux-2.6.34-rc4/net/appletalk/aarp.c
--- linux-2.6.34-rc3/net/appletalk/aarp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/appletalk/aarp.c	2010-04-13 02:19:02.170884000 +0000
@@ -30,6 +30,7 @@
  */
 
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/datalink.h>
 #include <net/psnap.h>
diff -urN linux-2.6.34-rc3/net/appletalk/ddp.c linux-2.6.34-rc4/net/appletalk/ddp.c
--- linux-2.6.34-rc3/net/appletalk/ddp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/appletalk/ddp.c	2010-04-13 02:19:02.170884000 +0000
@@ -57,6 +57,7 @@
 #include <linux/smp_lock.h>
 #include <linux/termios.h>	/* For TIOCOUTQ/INQ */
 #include <linux/compat.h>
+#include <linux/slab.h>
 #include <net/datalink.h>
 #include <net/psnap.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/atm/addr.c linux-2.6.34-rc4/net/atm/addr.c
--- linux-2.6.34-rc3/net/atm/addr.c	2010-04-13 02:18:56.689570627 +0000
+++ linux-2.6.34-rc4/net/atm/addr.c	2010-04-13 02:19:02.170884000 +0000
@@ -4,6 +4,7 @@
 
 #include <linux/atm.h>
 #include <linux/atmdev.h>
+#include <linux/slab.h>
 #include <linux/uaccess.h>
 
 #include "signaling.h"
diff -urN linux-2.6.34-rc3/net/atm/atm_sysfs.c linux-2.6.34-rc4/net/atm/atm_sysfs.c
--- linux-2.6.34-rc3/net/atm/atm_sysfs.c	2010-04-13 02:18:56.689570627 +0000
+++ linux-2.6.34-rc4/net/atm/atm_sysfs.c	2010-04-13 02:19:02.170884000 +0000
@@ -1,6 +1,7 @@
 /* ATM driver model support. */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kobject.h>
 #include <linux/atmdev.h>
diff -urN linux-2.6.34-rc3/net/atm/br2684.c linux-2.6.34-rc4/net/atm/br2684.c
--- linux-2.6.34-rc3/net/atm/br2684.c	2010-04-13 02:18:56.690570482 +0000
+++ linux-2.6.34-rc4/net/atm/br2684.c	2010-04-13 02:19:02.171883088 +0000
@@ -18,6 +18,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/ip.h>
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <net/arp.h>
 #include <linux/atm.h>
 #include <linux/atmdev.h>
diff -urN linux-2.6.34-rc3/net/atm/clip.c linux-2.6.34-rc4/net/atm/clip.c
--- linux-2.6.34-rc3/net/atm/clip.c	2010-04-13 02:18:56.690570482 +0000
+++ linux-2.6.34-rc4/net/atm/clip.c	2010-04-13 02:19:02.171883088 +0000
@@ -30,6 +30,7 @@
 #include <linux/seq_file.h>
 #include <linux/rcupdate.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 #include <net/route.h> /* for struct rtable and routing */
 #include <net/icmp.h> /* icmp_send */
 #include <linux/param.h> /* for HZ */
diff -urN linux-2.6.34-rc3/net/atm/common.c linux-2.6.34-rc4/net/atm/common.c
--- linux-2.6.34-rc3/net/atm/common.c	2010-04-13 02:18:56.690570482 +0000
+++ linux-2.6.34-rc4/net/atm/common.c	2010-04-13 02:19:02.171883088 +0000
@@ -18,6 +18,7 @@
 #include <linux/skbuff.h>
 #include <linux/bitops.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/sock.h>		/* struct sock */
 #include <linux/uaccess.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/net/atm/lec.c linux-2.6.34-rc4/net/atm/lec.c
--- linux-2.6.34-rc3/net/atm/lec.c	2010-04-13 02:18:56.692633062 +0000
+++ linux-2.6.34-rc4/net/atm/lec.c	2010-04-13 02:19:02.173883733 +0000
@@ -6,6 +6,7 @@
 
 #define pr_fmt(fmt) KBUILD_MODNAME ":%s: " fmt, __func__
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/bitops.h>
 #include <linux/capability.h>
diff -urN linux-2.6.34-rc3/net/atm/mpc.c linux-2.6.34-rc4/net/atm/mpc.c
--- linux-2.6.34-rc3/net/atm/mpc.c	2010-04-13 02:18:56.693633082 +0000
+++ linux-2.6.34-rc4/net/atm/mpc.c	2010-04-13 02:19:02.174883903 +0000
@@ -2,6 +2,7 @@
 
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/timer.h>
 #include <linux/init.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/net/atm/mpoa_caches.c linux-2.6.34-rc4/net/atm/mpoa_caches.c
--- linux-2.6.34-rc3/net/atm/mpoa_caches.c	2010-04-13 02:18:56.693633082 +0000
+++ linux-2.6.34-rc4/net/atm/mpoa_caches.c	2010-04-13 02:19:02.174883903 +0000
@@ -1,5 +1,6 @@
 #include <linux/types.h>
 #include <linux/atmmpc.h>
+#include <linux/slab.h>
 #include <linux/time.h>
 
 #include "mpoa_caches.h"
diff -urN linux-2.6.34-rc3/net/atm/mpoa_proc.c linux-2.6.34-rc4/net/atm/mpoa_proc.c
--- linux-2.6.34-rc3/net/atm/mpoa_proc.c	2010-04-13 02:18:56.693633082 +0000
+++ linux-2.6.34-rc4/net/atm/mpoa_proc.c	2010-04-13 02:19:02.174883903 +0000
@@ -12,6 +12,7 @@
 #include <linux/uaccess.h>
 #include <linux/atmmpc.h>
 #include <linux/atm.h>
+#include <linux/gfp.h>
 #include "mpc.h"
 #include "mpoa_caches.h"
 
diff -urN linux-2.6.34-rc3/net/atm/pppoatm.c linux-2.6.34-rc4/net/atm/pppoatm.c
--- linux-2.6.34-rc3/net/atm/pppoatm.c	2010-04-13 02:18:56.693633082 +0000
+++ linux-2.6.34-rc4/net/atm/pppoatm.c	2010-04-13 02:19:02.175883846 +0000
@@ -38,6 +38,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/atm.h>
 #include <linux/atmdev.h>
 #include <linux/capability.h>
diff -urN linux-2.6.34-rc3/net/atm/proc.c linux-2.6.34-rc4/net/atm/proc.c
--- linux-2.6.34-rc3/net/atm/proc.c	2010-04-13 02:18:56.694633045 +0000
+++ linux-2.6.34-rc4/net/atm/proc.c	2010-04-13 02:19:02.175883846 +0000
@@ -22,6 +22,7 @@
 #include <linux/netdevice.h>
 #include <linux/atmclip.h>
 #include <linux/init.h> /* for __init */
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/atmclip.h>
 #include <linux/uaccess.h>
diff -urN linux-2.6.34-rc3/net/atm/raw.c linux-2.6.34-rc4/net/atm/raw.c
--- linux-2.6.34-rc3/net/atm/raw.c	2010-04-13 02:18:56.694633045 +0000
+++ linux-2.6.34-rc4/net/atm/raw.c	2010-04-13 02:19:02.175883846 +0000
@@ -10,6 +10,7 @@
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 
 #include "common.h"
 #include "protocols.h"
diff -urN linux-2.6.34-rc3/net/atm/resources.c linux-2.6.34-rc4/net/atm/resources.c
--- linux-2.6.34-rc3/net/atm/resources.c	2010-04-13 02:18:56.694633045 +0000
+++ linux-2.6.34-rc4/net/atm/resources.c	2010-04-13 02:19:02.175883846 +0000
@@ -19,6 +19,7 @@
 #include <linux/capability.h>
 #include <linux/delay.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>	 /* for struct sock */
 
diff -urN linux-2.6.34-rc3/net/atm/signaling.c linux-2.6.34-rc4/net/atm/signaling.c
--- linux-2.6.34-rc3/net/atm/signaling.c	2010-04-13 02:18:56.694633045 +0000
+++ linux-2.6.34-rc4/net/atm/signaling.c	2010-04-13 02:19:02.176883807 +0000
@@ -14,6 +14,7 @@
 #include <linux/atmsvc.h>
 #include <linux/atmdev.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #include "resources.h"
 #include "signaling.h"
diff -urN linux-2.6.34-rc3/net/ax25/af_ax25.c linux-2.6.34-rc4/net/ax25/af_ax25.c
--- linux-2.6.34-rc3/net/ax25/af_ax25.c	2010-04-13 02:18:56.695633041 +0000
+++ linux-2.6.34-rc4/net/ax25/af_ax25.c	2010-04-13 02:19:02.176883807 +0000
@@ -25,6 +25,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_dev.c linux-2.6.34-rc4/net/ax25/ax25_dev.c
--- linux-2.6.34-rc3/net/ax25/ax25_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_dev.c	2010-04-13 02:19:02.176883807 +0000
@@ -9,6 +9,7 @@
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/socket.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <linux/kernel.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_ds_subr.c linux-2.6.34-rc4/net/ax25/ax25_ds_subr.c
--- linux-2.6.34-rc3/net/ax25/ax25_ds_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_ds_subr.c	2010-04-13 02:19:02.177883516 +0000
@@ -17,6 +17,7 @@
 #include <linux/sockios.h>
 #include <linux/spinlock.h>
 #include <linux/net.h>
+#include <linux/gfp.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_iface.c linux-2.6.34-rc4/net/ax25/ax25_iface.c
--- linux-2.6.34-rc3/net/ax25/ax25_iface.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_iface.c	2010-04-13 02:19:02.177883516 +0000
@@ -17,6 +17,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_in.c linux-2.6.34-rc4/net/ax25/ax25_in.c
--- linux-2.6.34-rc3/net/ax25/ax25_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_in.c	2010-04-13 02:19:02.177883516 +0000
@@ -18,6 +18,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_ip.c linux-2.6.34-rc4/net/ax25/ax25_ip.c
--- linux-2.6.34-rc3/net/ax25/ax25_ip.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_ip.c	2010-04-13 02:19:02.177883516 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_out.c linux-2.6.34-rc4/net/ax25/ax25_out.c
--- linux-2.6.34-rc3/net/ax25/ax25_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_out.c	2010-04-13 02:19:02.177883516 +0000
@@ -19,6 +19,7 @@
 #include <linux/sockios.h>
 #include <linux/spinlock.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_route.c linux-2.6.34-rc4/net/ax25/ax25_route.c
--- linux-2.6.34-rc3/net/ax25/ax25_route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_route.c	2010-04-13 02:19:02.177883516 +0000
@@ -23,6 +23,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_subr.c linux-2.6.34-rc4/net/ax25/ax25_subr.c
--- linux-2.6.34-rc3/net/ax25/ax25_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_subr.c	2010-04-13 02:19:02.177883516 +0000
@@ -18,6 +18,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/ax25_uid.c linux-2.6.34-rc4/net/ax25/ax25_uid.c
--- linux-2.6.34-rc3/net/ax25/ax25_uid.c	2010-04-13 02:18:56.695633041 +0000
+++ linux-2.6.34-rc4/net/ax25/ax25_uid.c	2010-04-13 02:19:02.177883516 +0000
@@ -18,6 +18,7 @@
 #include <linux/sockios.h>
 #include <linux/net.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ax25/sysctl_net_ax25.c linux-2.6.34-rc4/net/ax25/sysctl_net_ax25.c
--- linux-2.6.34-rc3/net/ax25/sysctl_net_ax25.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ax25/sysctl_net_ax25.c	2010-04-13 02:19:02.177883516 +0000
@@ -7,6 +7,7 @@
  * Copyright (C) 1996 Mike Shaver (shaver@zeroknowledge.com)
  */
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/spinlock.h>
 #include <net/ax25.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/af_bluetooth.c linux-2.6.34-rc4/net/bluetooth/af_bluetooth.c
--- linux-2.6.34-rc3/net/bluetooth/af_bluetooth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bluetooth/af_bluetooth.c	2010-04-13 02:19:02.177883516 +0000
@@ -31,7 +31,6 @@
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/bnep/core.c linux-2.6.34-rc4/net/bluetooth/bnep/core.c
--- linux-2.6.34-rc3/net/bluetooth/bnep/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bluetooth/bnep/core.c	2010-04-13 02:19:02.178883707 +0000
@@ -35,6 +35,7 @@
 #include <linux/freezer.h>
 #include <linux/errno.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #include <linux/socket.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/bnep/netdev.c linux-2.6.34-rc4/net/bluetooth/bnep/netdev.c
--- linux-2.6.34-rc3/net/bluetooth/bnep/netdev.c	2010-04-13 02:18:56.695633041 +0000
+++ linux-2.6.34-rc4/net/bluetooth/bnep/netdev.c	2010-04-13 02:19:02.178883707 +0000
@@ -26,6 +26,7 @@
 */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/socket.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/bnep/sock.c linux-2.6.34-rc4/net/bluetooth/bnep/sock.c
--- linux-2.6.34-rc3/net/bluetooth/bnep/sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bluetooth/bnep/sock.c	2010-04-13 02:19:02.178883707 +0000
@@ -30,7 +30,6 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/poll.h>
 #include <linux/fcntl.h>
 #include <linux/skbuff.h>
@@ -39,6 +38,7 @@
 #include <linux/file.h>
 #include <linux/init.h>
 #include <linux/compat.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/cmtp/sock.c linux-2.6.34-rc4/net/bluetooth/cmtp/sock.c
--- linux-2.6.34-rc3/net/bluetooth/cmtp/sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bluetooth/cmtp/sock.c	2010-04-13 02:19:02.178883707 +0000
@@ -26,7 +26,6 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/poll.h>
 #include <linux/fcntl.h>
 #include <linux/skbuff.h>
@@ -34,6 +33,7 @@
 #include <linux/ioctl.h>
 #include <linux/file.h>
 #include <linux/compat.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 
 #include <linux/isdn/capilli.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/hci_sysfs.c linux-2.6.34-rc4/net/bluetooth/hci_sysfs.c
--- linux-2.6.34-rc3/net/bluetooth/hci_sysfs.c	2010-04-13 02:18:56.696633094 +0000
+++ linux-2.6.34-rc4/net/bluetooth/hci_sysfs.c	2010-04-13 02:19:02.179883470 +0000
@@ -1,6 +1,7 @@
 /* Bluetooth HCI driver model support. */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/debugfs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/hidp/sock.c linux-2.6.34-rc4/net/bluetooth/hidp/sock.c
--- linux-2.6.34-rc3/net/bluetooth/hidp/sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bluetooth/hidp/sock.c	2010-04-13 02:19:02.179883470 +0000
@@ -26,7 +26,6 @@
 #include <linux/capability.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/poll.h>
 #include <linux/fcntl.h>
 #include <linux/skbuff.h>
@@ -35,6 +34,7 @@
 #include <linux/file.h>
 #include <linux/init.h>
 #include <linux/compat.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 
 #include "hidp.h"
diff -urN linux-2.6.34-rc3/net/bluetooth/l2cap.c linux-2.6.34-rc4/net/bluetooth/l2cap.c
--- linux-2.6.34-rc3/net/bluetooth/l2cap.c	2010-04-13 02:18:56.697633027 +0000
+++ linux-2.6.34-rc4/net/bluetooth/l2cap.c	2010-04-13 02:19:02.180883434 +0000
@@ -1002,7 +1002,8 @@
 
 	BT_DBG("sk %p", sk);
 
-	if (!addr || addr->sa_family != AF_BLUETOOTH)
+	if (!addr || alen < sizeof(addr->sa_family) ||
+	    addr->sa_family != AF_BLUETOOTH)
 		return -EINVAL;
 
 	memset(&la, 0, sizeof(la));
diff -urN linux-2.6.34-rc3/net/bluetooth/rfcomm/core.c linux-2.6.34-rc4/net/bluetooth/rfcomm/core.c
--- linux-2.6.34-rc3/net/bluetooth/rfcomm/core.c	2010-04-13 02:18:56.697633027 +0000
+++ linux-2.6.34-rc4/net/bluetooth/rfcomm/core.c	2010-04-13 02:19:02.180883434 +0000
@@ -38,6 +38,7 @@
 #include <linux/net.h>
 #include <linux/mutex.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/bluetooth/rfcomm/sock.c linux-2.6.34-rc4/net/bluetooth/rfcomm/sock.c
--- linux-2.6.34-rc3/net/bluetooth/rfcomm/sock.c	2010-04-13 02:18:56.698633074 +0000
+++ linux-2.6.34-rc4/net/bluetooth/rfcomm/sock.c	2010-04-13 02:19:02.180883434 +0000
@@ -397,7 +397,8 @@
 
 	BT_DBG("sk %p", sk);
 
-	if (addr->sa_family != AF_BLUETOOTH || alen < sizeof(struct sockaddr_rc))
+	if (alen < sizeof(struct sockaddr_rc) ||
+	    addr->sa_family != AF_BLUETOOTH)
 		return -EINVAL;
 
 	lock_sock(sk);
diff -urN linux-2.6.34-rc3/net/bluetooth/sco.c linux-2.6.34-rc4/net/bluetooth/sco.c
--- linux-2.6.34-rc3/net/bluetooth/sco.c	2010-04-13 02:18:56.698633074 +0000
+++ linux-2.6.34-rc4/net/bluetooth/sco.c	2010-04-13 02:19:02.181883428 +0000
@@ -499,7 +499,8 @@
 
 	BT_DBG("sk %p", sk);
 
-	if (addr->sa_family != AF_BLUETOOTH || alen < sizeof(struct sockaddr_sco))
+	if (alen < sizeof(struct sockaddr_sco) ||
+	    addr->sa_family != AF_BLUETOOTH)
 		return -EINVAL;
 
 	if (sk->sk_state != BT_OPEN && sk->sk_state != BT_BOUND)
diff -urN linux-2.6.34-rc3/net/bridge/br_fdb.c linux-2.6.34-rc4/net/bridge/br_fdb.c
--- linux-2.6.34-rc3/net/bridge/br_fdb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bridge/br_fdb.c	2010-04-13 02:19:02.181883428 +0000
@@ -20,6 +20,7 @@
 #include <linux/etherdevice.h>
 #include <linux/jhash.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <asm/atomic.h>
 #include <asm/unaligned.h>
 #include "br_private.h"
diff -urN linux-2.6.34-rc3/net/bridge/br_forward.c linux-2.6.34-rc4/net/bridge/br_forward.c
--- linux-2.6.34-rc3/net/bridge/br_forward.c	2010-04-13 02:18:56.698633074 +0000
+++ linux-2.6.34-rc4/net/bridge/br_forward.c	2010-04-13 02:19:02.181883428 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/bridge/br_if.c linux-2.6.34-rc4/net/bridge/br_if.c
--- linux-2.6.34-rc3/net/bridge/br_if.c	2010-04-13 02:18:56.698633074 +0000
+++ linux-2.6.34-rc4/net/bridge/br_if.c	2010-04-13 02:19:02.181883428 +0000
@@ -19,6 +19,7 @@
 #include <linux/init.h>
 #include <linux/rtnetlink.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #include "br_private.h"
diff -urN linux-2.6.34-rc3/net/bridge/br_input.c linux-2.6.34-rc4/net/bridge/br_input.c
--- linux-2.6.34-rc3/net/bridge/br_input.c	2010-04-13 02:18:56.698633074 +0000
+++ linux-2.6.34-rc4/net/bridge/br_input.c	2010-04-13 02:19:02.181883428 +0000
@@ -11,6 +11,7 @@
  *	2 of the License, or (at your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
 #include <linux/etherdevice.h>
diff -urN linux-2.6.34-rc3/net/bridge/br_ioctl.c linux-2.6.34-rc4/net/bridge/br_ioctl.c
--- linux-2.6.34-rc3/net/bridge/br_ioctl.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bridge/br_ioctl.c	2010-04-13 02:19:02.182883772 +0000
@@ -15,6 +15,7 @@
 #include <linux/kernel.h>
 #include <linux/if_bridge.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <linux/times.h>
 #include <net/net_namespace.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/bridge/br_netfilter.c linux-2.6.34-rc4/net/bridge/br_netfilter.c
--- linux-2.6.34-rc3/net/bridge/br_netfilter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bridge/br_netfilter.c	2010-04-13 02:19:02.182883772 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/ip.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/bridge/br_netlink.c linux-2.6.34-rc4/net/bridge/br_netlink.c
--- linux-2.6.34-rc3/net/bridge/br_netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bridge/br_netlink.c	2010-04-13 02:19:02.182883772 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <net/rtnetlink.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/bridge/br_stp_bpdu.c linux-2.6.34-rc4/net/bridge/br_stp_bpdu.c
--- linux-2.6.34-rc3/net/bridge/br_stp_bpdu.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/bridge/br_stp_bpdu.c	2010-04-13 02:19:02.183883540 +0000
@@ -15,6 +15,7 @@
 #include <linux/netfilter_bridge.h>
 #include <linux/etherdevice.h>
 #include <linux/llc.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/llc.h>
 #include <net/llc_pdu.h>
diff -urN linux-2.6.34-rc3/net/bridge/netfilter/ebt_ulog.c linux-2.6.34-rc4/net/bridge/netfilter/ebt_ulog.c
--- linux-2.6.34-rc3/net/bridge/netfilter/ebt_ulog.c	2010-04-13 02:18:56.701570405 +0000
+++ linux-2.6.34-rc4/net/bridge/netfilter/ebt_ulog.c	2010-04-13 02:19:02.185883682 +0000
@@ -29,6 +29,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/socket.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/bridge/netfilter/ebtables.c linux-2.6.34-rc4/net/bridge/netfilter/ebtables.c
--- linux-2.6.34-rc3/net/bridge/netfilter/ebtables.c	2010-04-13 02:18:56.702633052 +0000
+++ linux-2.6.34-rc4/net/bridge/netfilter/ebtables.c	2010-04-13 02:19:02.186883216 +0000
@@ -23,6 +23,7 @@
 #include <linux/netfilter_bridge/ebtables.h>
 #include <linux/spinlock.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/smp.h>
 #include <linux/cpumask.h>
diff -urN linux-2.6.34-rc3/net/can/bcm.c linux-2.6.34-rc4/net/can/bcm.c
--- linux-2.6.34-rc3/net/can/bcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/can/bcm.c	2010-04-13 02:19:02.187883326 +0000
@@ -56,6 +56,7 @@
 #include <linux/can.h>
 #include <linux/can/core.h>
 #include <linux/can/bcm.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/net_namespace.h>
 
@@ -1478,6 +1479,9 @@
 	struct sock *sk = sock->sk;
 	struct bcm_sock *bo = bcm_sk(sk);
 
+	if (len < sizeof(*addr))
+		return -EINVAL;
+
 	if (bo->bound)
 		return -EISCONN;
 
diff -urN linux-2.6.34-rc3/net/can/raw.c linux-2.6.34-rc4/net/can/raw.c
--- linux-2.6.34-rc3/net/can/raw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/can/raw.c	2010-04-13 02:19:02.187883326 +0000
@@ -45,6 +45,7 @@
 #include <linux/init.h>
 #include <linux/uio.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/socket.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/net/compat.c linux-2.6.34-rc4/net/compat.c
--- linux-2.6.34-rc3/net/compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/compat.c	2010-04-13 02:19:02.187883326 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/types.h>
 #include <linux/file.h>
diff -urN linux-2.6.34-rc3/net/core/datagram.c linux-2.6.34-rc4/net/core/datagram.c
--- linux-2.6.34-rc3/net/core/datagram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/datagram.c	2010-04-13 02:19:02.187883326 +0000
@@ -48,6 +48,7 @@
 #include <linux/poll.h>
 #include <linux/highmem.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include <net/protocol.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/core/dev.c linux-2.6.34-rc4/net/core/dev.c
--- linux-2.6.34-rc3/net/core/dev.c	2010-04-13 02:18:56.704633354 +0000
+++ linux-2.6.34-rc4/net/core/dev.c	2010-04-13 02:19:02.188883616 +0000
@@ -80,6 +80,7 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/hash.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/mutex.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/core/drop_monitor.c linux-2.6.34-rc4/net/core/drop_monitor.c
--- linux-2.6.34-rc3/net/core/drop_monitor.c	2010-04-13 02:18:56.704633354 +0000
+++ linux-2.6.34-rc4/net/core/drop_monitor.c	2010-04-13 02:19:02.189883522 +0000
@@ -21,6 +21,7 @@
 #include <linux/percpu.h>
 #include <linux/timer.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <net/genetlink.h>
 #include <net/netevent.h>
 
diff -urN linux-2.6.34-rc3/net/core/dst.c linux-2.6.34-rc4/net/core/dst.c
--- linux-2.6.34-rc3/net/core/dst.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/dst.c	2010-04-13 02:19:02.189883522 +0000
@@ -12,6 +12,7 @@
 #include <linux/workqueue.h>
 #include <linux/mm.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/core/ethtool.c linux-2.6.34-rc4/net/core/ethtool.c
--- linux-2.6.34-rc3/net/core/ethtool.c	2010-04-13 02:18:56.705633086 +0000
+++ linux-2.6.34-rc4/net/core/ethtool.c	2010-04-13 02:19:02.189883522 +0000
@@ -18,6 +18,7 @@
 #include <linux/ethtool.h>
 #include <linux/netdevice.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 /*
diff -urN linux-2.6.34-rc3/net/core/fib_rules.c linux-2.6.34-rc4/net/core/fib_rules.c
--- linux-2.6.34-rc3/net/core/fib_rules.c	2010-04-13 02:18:56.705633086 +0000
+++ linux-2.6.34-rc4/net/core/fib_rules.c	2010-04-13 02:19:02.189883522 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/core/filter.c linux-2.6.34-rc4/net/core/filter.c
--- linux-2.6.34-rc3/net/core/filter.c	2010-04-13 02:18:56.705633086 +0000
+++ linux-2.6.34-rc4/net/core/filter.c	2010-04-13 02:19:02.189883522 +0000
@@ -25,6 +25,7 @@
 #include <linux/inet.h>
 #include <linux/netdevice.h>
 #include <linux/if_packet.h>
+#include <linux/gfp.h>
 #include <net/ip.h>
 #include <net/protocol.h>
 #include <net/netlink.h>
diff -urN linux-2.6.34-rc3/net/core/gen_estimator.c linux-2.6.34-rc4/net/core/gen_estimator.c
--- linux-2.6.34-rc3/net/core/gen_estimator.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/gen_estimator.c	2010-04-13 02:19:02.190883455 +0000
@@ -32,6 +32,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/init.h>
 #include <linux/rbtree.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/gen_stats.h>
 
diff -urN linux-2.6.34-rc3/net/core/iovec.c linux-2.6.34-rc4/net/core/iovec.c
--- linux-2.6.34-rc3/net/core/iovec.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/iovec.c	2010-04-13 02:19:02.190883455 +0000
@@ -20,7 +20,6 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/net.h>
 #include <linux/in6.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/core/link_watch.c linux-2.6.34-rc4/net/core/link_watch.c
--- linux-2.6.34-rc3/net/core/link_watch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/link_watch.c	2010-04-13 02:19:02.190883455 +0000
@@ -19,7 +19,6 @@
 #include <linux/rtnetlink.h>
 #include <linux/jiffies.h>
 #include <linux/spinlock.h>
-#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/bitops.h>
 #include <asm/types.h>
diff -urN linux-2.6.34-rc3/net/core/neighbour.c linux-2.6.34-rc4/net/core/neighbour.c
--- linux-2.6.34-rc3/net/core/neighbour.c	2010-04-13 02:18:56.705633086 +0000
+++ linux-2.6.34-rc4/net/core/neighbour.c	2010-04-13 02:19:02.190883455 +0000
@@ -15,6 +15,7 @@
  *	Harald Welte		Add neighbour cache statistics like rtstat
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/net/core/net-sysfs.c linux-2.6.34-rc4/net/core/net-sysfs.c
--- linux-2.6.34-rc3/net/core/net-sysfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/net-sysfs.c	2010-04-13 02:19:02.190883455 +0000
@@ -13,6 +13,7 @@
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/rtnetlink.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/net/core/net-traces.c linux-2.6.34-rc4/net/core/net-traces.c
--- linux-2.6.34-rc3/net/core/net-traces.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/net-traces.c	2010-04-13 02:19:02.190883455 +0000
@@ -19,6 +19,7 @@
 #include <linux/workqueue.h>
 #include <linux/netlink.h>
 #include <linux/net_dropmon.h>
+#include <linux/slab.h>
 
 #include <asm/unaligned.h>
 #include <asm/bitops.h>
diff -urN linux-2.6.34-rc3/net/core/netpoll.c linux-2.6.34-rc4/net/core/netpoll.c
--- linux-2.6.34-rc3/net/core/netpoll.c	2010-04-13 02:18:56.706633070 +0000
+++ linux-2.6.34-rc4/net/core/netpoll.c	2010-04-13 02:19:02.191883721 +0000
@@ -22,6 +22,7 @@
 #include <linux/delay.h>
 #include <linux/rcupdate.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include <net/tcp.h>
 #include <net/udp.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/net/core/scm.c linux-2.6.34-rc4/net/core/scm.c
--- linux-2.6.34-rc3/net/core/scm.c	2010-04-13 02:18:56.707633036 +0000
+++ linux-2.6.34-rc4/net/core/scm.c	2010-04-13 02:19:02.192883552 +0000
@@ -26,6 +26,7 @@
 #include <linux/security.h>
 #include <linux/pid.h>
 #include <linux/nsproxy.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/core/sysctl_net_core.c linux-2.6.34-rc4/net/core/sysctl_net_core.c
--- linux-2.6.34-rc3/net/core/sysctl_net_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/core/sysctl_net_core.c	2010-04-13 02:19:02.192883552 +0000
@@ -12,6 +12,7 @@
 #include <linux/netdevice.h>
 #include <linux/ratelimit.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <net/ip.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/dcb/dcbnl.c linux-2.6.34-rc4/net/dcb/dcbnl.c
--- linux-2.6.34-rc3/net/dcb/dcbnl.c	2010-04-13 02:18:56.707633036 +0000
+++ linux-2.6.34-rc4/net/dcb/dcbnl.c	2010-04-13 02:19:02.192883552 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/netdevice.h>
 #include <linux/netlink.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/rtnetlink.h>
 #include <linux/dcbnl.h>
diff -urN linux-2.6.34-rc3/net/dccp/ccid.c linux-2.6.34-rc4/net/dccp/ccid.c
--- linux-2.6.34-rc3/net/dccp/ccid.c	2010-04-13 02:18:56.707633036 +0000
+++ linux-2.6.34-rc4/net/dccp/ccid.c	2010-04-13 02:19:02.193883467 +0000
@@ -11,6 +11,8 @@
  *	published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
+
 #include "ccid.h"
 #include "ccids/lib/tfrc.h"
 
diff -urN linux-2.6.34-rc3/net/dccp/ccids/ccid2.c linux-2.6.34-rc4/net/dccp/ccids/ccid2.c
--- linux-2.6.34-rc3/net/dccp/ccids/ccid2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dccp/ccids/ccid2.c	2010-04-13 02:19:02.193883467 +0000
@@ -23,6 +23,7 @@
 /*
  * This implementation should follow RFC 4341
  */
+#include <linux/slab.h>
 #include "../feat.h"
 #include "../ccid.h"
 #include "../dccp.h"
diff -urN linux-2.6.34-rc3/net/dccp/feat.c linux-2.6.34-rc4/net/dccp/feat.c
--- linux-2.6.34-rc3/net/dccp/feat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dccp/feat.c	2010-04-13 02:19:02.193883467 +0000
@@ -22,6 +22,7 @@
  *  2 of the License, or (at your option) any later version.
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 #include "ccid.h"
 #include "feat.h"
 
diff -urN linux-2.6.34-rc3/net/dccp/input.c linux-2.6.34-rc4/net/dccp/input.c
--- linux-2.6.34-rc3/net/dccp/input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dccp/input.c	2010-04-13 02:19:02.193883467 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/dccp.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 
diff -urN linux-2.6.34-rc3/net/dccp/ipv4.c linux-2.6.34-rc4/net/dccp/ipv4.c
--- linux-2.6.34-rc3/net/dccp/ipv4.c	2010-04-13 02:18:56.708633032 +0000
+++ linux-2.6.34-rc4/net/dccp/ipv4.c	2010-04-13 02:19:02.193883467 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/dccp.h>
 #include <linux/icmp.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/dccp/ipv6.c linux-2.6.34-rc4/net/dccp/ipv6.c
--- linux-2.6.34-rc3/net/dccp/ipv6.c	2010-04-13 02:18:56.708633032 +0000
+++ linux-2.6.34-rc4/net/dccp/ipv6.c	2010-04-13 02:19:02.194883745 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/module.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/xfrm.h>
 
 #include <net/addrconf.h>
diff -urN linux-2.6.34-rc3/net/dccp/minisocks.c linux-2.6.34-rc4/net/dccp/minisocks.c
--- linux-2.6.34-rc3/net/dccp/minisocks.c	2010-04-13 02:18:56.708633032 +0000
+++ linux-2.6.34-rc4/net/dccp/minisocks.c	2010-04-13 02:19:02.194883745 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/dccp.h>
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/net/dccp/output.c linux-2.6.34-rc4/net/dccp/output.c
--- linux-2.6.34-rc3/net/dccp/output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dccp/output.c	2010-04-13 02:19:02.194883745 +0000
@@ -13,6 +13,7 @@
 #include <linux/dccp.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/inet_sock.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/dccp/probe.c linux-2.6.34-rc4/net/dccp/probe.c
--- linux-2.6.34-rc3/net/dccp/probe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dccp/probe.c	2010-04-13 02:19:02.194883745 +0000
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/kfifo.h>
 #include <linux/vmalloc.h>
+#include <linux/gfp.h>
 #include <net/net_namespace.h>
 
 #include "dccp.h"
diff -urN linux-2.6.34-rc3/net/dccp/proto.c linux-2.6.34-rc4/net/dccp/proto.c
--- linux-2.6.34-rc3/net/dccp/proto.c	2010-04-13 02:18:56.708633032 +0000
+++ linux-2.6.34-rc4/net/dccp/proto.c	2010-04-13 02:19:02.194883745 +0000
@@ -20,6 +20,7 @@
 #include <linux/if_arp.h>
 #include <linux/init.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 
 #include <net/inet_sock.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_dev.c linux-2.6.34-rc4/net/decnet/dn_dev.c
--- linux-2.6.34-rc3/net/decnet/dn_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_dev.c	2010-04-13 02:19:02.194883745 +0000
@@ -40,6 +40,7 @@
 #include <linux/skbuff.h>
 #include <linux/sysctl.h>
 #include <linux/notifier.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
 #include <net/net_namespace.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_fib.c linux-2.6.34-rc4/net/decnet/dn_fib.c
--- linux-2.6.34-rc3/net/decnet/dn_fib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_fib.c	2010-04-13 02:19:02.194883745 +0000
@@ -20,6 +20,7 @@
 #include <linux/string.h>
 #include <linux/net.h>
 #include <linux/socket.h>
+#include <linux/slab.h>
 #include <linux/sockios.h>
 #include <linux/init.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_neigh.c linux-2.6.34-rc4/net/decnet/dn_neigh.c
--- linux-2.6.34-rc3/net/decnet/dn_neigh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_neigh.c	2010-04-13 02:19:02.195883276 +0000
@@ -28,6 +28,7 @@
 #include <linux/module.h>
 #include <linux/socket.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <linux/if_ether.h>
 #include <linux/init.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_nsp_in.c linux-2.6.34-rc4/net/decnet/dn_nsp_in.c
--- linux-2.6.34-rc3/net/decnet/dn_nsp_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_nsp_in.c	2010-04-13 02:19:02.195883276 +0000
@@ -57,6 +57,7 @@
 #include <linux/netdevice.h>
 #include <linux/inet.h>
 #include <linux/route.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/tcp_states.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_nsp_out.c linux-2.6.34-rc4/net/decnet/dn_nsp_out.c
--- linux-2.6.34-rc3/net/decnet/dn_nsp_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_nsp_out.c	2010-04-13 02:19:02.195883276 +0000
@@ -50,6 +50,7 @@
 #include <linux/netdevice.h>
 #include <linux/inet.h>
 #include <linux/route.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <asm/system.h>
 #include <linux/fcntl.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_route.c linux-2.6.34-rc4/net/decnet/dn_route.c
--- linux-2.6.34-rc3/net/decnet/dn_route.c	2010-04-13 02:18:56.708633032 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_route.c	2010-04-13 02:19:02.195883276 +0000
@@ -66,6 +66,7 @@
 #include <linux/inet.h>
 #include <linux/route.h>
 #include <linux/in_route.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/mm.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/decnet/dn_table.c linux-2.6.34-rc4/net/decnet/dn_table.c
--- linux-2.6.34-rc3/net/decnet/dn_table.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/dn_table.c	2010-04-13 02:19:02.195883276 +0000
@@ -15,6 +15,7 @@
 #include <linux/string.h>
 #include <linux/net.h>
 #include <linux/socket.h>
+#include <linux/slab.h>
 #include <linux/sockios.h>
 #include <linux/init.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/decnet/netfilter/dn_rtmsg.c linux-2.6.34-rc4/net/decnet/netfilter/dn_rtmsg.c
--- linux-2.6.34-rc3/net/decnet/netfilter/dn_rtmsg.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/decnet/netfilter/dn_rtmsg.c	2010-04-13 02:19:02.195883276 +0000
@@ -14,6 +14,7 @@
  */
 #include <linux/module.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/netdevice.h>
 #include <linux/netfilter.h>
diff -urN linux-2.6.34-rc3/net/dsa/dsa.c linux-2.6.34-rc4/net/dsa/dsa.c
--- linux-2.6.34-rc3/net/dsa/dsa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dsa/dsa.c	2010-04-13 02:19:02.196884124 +0000
@@ -11,6 +11,7 @@
 #include <linux/list.h>
 #include <linux/netdevice.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <net/dsa.h>
 #include "dsa_priv.h"
 
diff -urN linux-2.6.34-rc3/net/dsa/tag_dsa.c linux-2.6.34-rc4/net/dsa/tag_dsa.c
--- linux-2.6.34-rc3/net/dsa/tag_dsa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dsa/tag_dsa.c	2010-04-13 02:19:02.196884124 +0000
@@ -11,6 +11,7 @@
 #include <linux/etherdevice.h>
 #include <linux/list.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include "dsa_priv.h"
 
 #define DSA_HLEN	4
diff -urN linux-2.6.34-rc3/net/dsa/tag_edsa.c linux-2.6.34-rc4/net/dsa/tag_edsa.c
--- linux-2.6.34-rc3/net/dsa/tag_edsa.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dsa/tag_edsa.c	2010-04-13 02:19:02.196884124 +0000
@@ -11,6 +11,7 @@
 #include <linux/etherdevice.h>
 #include <linux/list.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include "dsa_priv.h"
 
 #define DSA_HLEN	4
diff -urN linux-2.6.34-rc3/net/dsa/tag_trailer.c linux-2.6.34-rc4/net/dsa/tag_trailer.c
--- linux-2.6.34-rc3/net/dsa/tag_trailer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/dsa/tag_trailer.c	2010-04-13 02:19:02.196884124 +0000
@@ -11,6 +11,7 @@
 #include <linux/etherdevice.h>
 #include <linux/list.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include "dsa_priv.h"
 
 netdev_tx_t trailer_xmit(struct sk_buff *skb, struct net_device *dev)
diff -urN linux-2.6.34-rc3/net/econet/af_econet.c linux-2.6.34-rc4/net/econet/af_econet.c
--- linux-2.6.34-rc3/net/econet/af_econet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/econet/af_econet.c	2010-04-13 02:19:02.196884124 +0000
@@ -30,6 +30,7 @@
 #include <linux/wireless.h>
 #include <linux/skbuff.h>
 #include <linux/udp.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/inet_common.h>
 #include <linux/stat.h>
diff -urN linux-2.6.34-rc3/net/ethernet/pe2.c linux-2.6.34-rc4/net/ethernet/pe2.c
--- linux-2.6.34-rc3/net/ethernet/pe2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ethernet/pe2.c	2010-04-13 02:19:02.196884124 +0000
@@ -3,6 +3,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/datalink.h>
 
diff -urN linux-2.6.34-rc3/net/ieee802154/af_ieee802154.c linux-2.6.34-rc4/net/ieee802154/af_ieee802154.c
--- linux-2.6.34-rc3/net/ieee802154/af_ieee802154.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/af_ieee802154.c	2010-04-13 02:19:02.196884124 +0000
@@ -28,6 +28,7 @@
 #include <linux/if.h>
 #include <linux/termios.h>	/* For TIOCOUTQ/INQ */
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/datalink.h>
 #include <net/psnap.h>
 #include <net/sock.h>
@@ -126,6 +127,9 @@
 {
 	struct sock *sk = sock->sk;
 
+	if (addr_len < sizeof(uaddr->sa_family))
+		return -EINVAL;
+
 	if (uaddr->sa_family == AF_UNSPEC)
 		return sk->sk_prot->disconnect(sk, flags);
 
diff -urN linux-2.6.34-rc3/net/ieee802154/dgram.c linux-2.6.34-rc4/net/ieee802154/dgram.c
--- linux-2.6.34-rc3/net/ieee802154/dgram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/dgram.c	2010-04-13 02:19:02.196884124 +0000
@@ -25,6 +25,7 @@
 #include <linux/module.h>
 #include <linux/if_arp.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_ieee802154.h>
 #include <net/ieee802154.h>
diff -urN linux-2.6.34-rc3/net/ieee802154/netlink.c linux-2.6.34-rc4/net/ieee802154/netlink.c
--- linux-2.6.34-rc3/net/ieee802154/netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/netlink.c	2010-04-13 02:19:02.196884124 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <net/genetlink.h>
 #include <linux/nl802154.h>
 
diff -urN linux-2.6.34-rc3/net/ieee802154/nl-mac.c linux-2.6.34-rc4/net/ieee802154/nl-mac.c
--- linux-2.6.34-rc3/net/ieee802154/nl-mac.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/nl-mac.c	2010-04-13 02:19:02.197883550 +0000
@@ -22,6 +22,7 @@
  * Maxim Osipov <maxim.osipov@siemens.com>
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/if_arp.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ieee802154/nl-phy.c linux-2.6.34-rc4/net/ieee802154/nl-phy.c
--- linux-2.6.34-rc3/net/ieee802154/nl-phy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/nl-phy.c	2010-04-13 02:19:02.197883550 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
 #include <net/wpan-phy.h>
diff -urN linux-2.6.34-rc3/net/ieee802154/raw.c linux-2.6.34-rc4/net/ieee802154/raw.c
--- linux-2.6.34-rc3/net/ieee802154/raw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/raw.c	2010-04-13 02:19:02.197883550 +0000
@@ -25,6 +25,7 @@
 #include <linux/module.h>
 #include <linux/if_arp.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_ieee802154.h>
 
diff -urN linux-2.6.34-rc3/net/ieee802154/wpan-class.c linux-2.6.34-rc4/net/ieee802154/wpan-class.c
--- linux-2.6.34-rc3/net/ieee802154/wpan-class.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ieee802154/wpan-class.c	2010-04-13 02:19:02.197883550 +0000
@@ -16,6 +16,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/net/ipv4/af_inet.c linux-2.6.34-rc4/net/ipv4/af_inet.c
--- linux-2.6.34-rc3/net/ipv4/af_inet.c	2010-04-13 02:18:56.709571691 +0000
+++ linux-2.6.34-rc4/net/ipv4/af_inet.c	2010-04-13 02:19:02.197883550 +0000
@@ -86,6 +86,7 @@
 #include <linux/poll.h>
 #include <linux/netfilter_ipv4.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/system.h>
@@ -530,6 +531,8 @@
 {
 	struct sock *sk = sock->sk;
 
+	if (addr_len < sizeof(uaddr->sa_family))
+		return -EINVAL;
 	if (uaddr->sa_family == AF_UNSPEC)
 		return sk->sk_prot->disconnect(sk, flags);
 
@@ -573,6 +576,9 @@
 	int err;
 	long timeo;
 
+	if (addr_len < sizeof(uaddr->sa_family))
+		return -EINVAL;
+
 	lock_sock(sk);
 
 	if (uaddr->sa_family == AF_UNSPEC) {
diff -urN linux-2.6.34-rc3/net/ipv4/ah4.c linux-2.6.34-rc4/net/ipv4/ah4.c
--- linux-2.6.34-rc3/net/ipv4/ah4.c	2010-04-13 02:18:56.709571691 +0000
+++ linux-2.6.34-rc4/net/ipv4/ah4.c	2010-04-13 02:19:02.197883550 +0000
@@ -1,6 +1,7 @@
 #include <crypto/hash.h>
 #include <linux/err.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <net/xfrm.h>
 #include <net/ah.h>
diff -urN linux-2.6.34-rc3/net/ipv4/arp.c linux-2.6.34-rc4/net/ipv4/arp.c
--- linux-2.6.34-rc3/net/ipv4/arp.c	2010-04-13 02:18:56.709571691 +0000
+++ linux-2.6.34-rc4/net/ipv4/arp.c	2010-04-13 02:19:02.198884101 +0000
@@ -98,6 +98,7 @@
 #include <linux/net.h>
 #include <linux/rcupdate.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 #ifdef CONFIG_SYSCTL
 #include <linux/sysctl.h>
 #endif
diff -urN linux-2.6.34-rc3/net/ipv4/cipso_ipv4.c linux-2.6.34-rc4/net/ipv4/cipso_ipv4.c
--- linux-2.6.34-rc3/net/ipv4/cipso_ipv4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/cipso_ipv4.c	2010-04-13 02:19:02.198884101 +0000
@@ -44,6 +44,7 @@
 #include <linux/string.h>
 #include <linux/jhash.h>
 #include <linux/audit.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <net/icmp.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/devinet.c linux-2.6.34-rc4/net/ipv4/devinet.c
--- linux-2.6.34-rc3/net/ipv4/devinet.c	2010-04-13 02:18:56.710570430 +0000
+++ linux-2.6.34-rc4/net/ipv4/devinet.c	2010-04-13 02:19:02.198884101 +0000
@@ -50,6 +50,7 @@
 #include <linux/notifier.h>
 #include <linux/inetdevice.h>
 #include <linux/igmp.h>
+#include <linux/slab.h>
 #ifdef CONFIG_SYSCTL
 #include <linux/sysctl.h>
 #endif
diff -urN linux-2.6.34-rc3/net/ipv4/fib_frontend.c linux-2.6.34-rc4/net/ipv4/fib_frontend.c
--- linux-2.6.34-rc3/net/ipv4/fib_frontend.c	2010-04-13 02:18:56.710570430 +0000
+++ linux-2.6.34-rc4/net/ipv4/fib_frontend.c	2010-04-13 02:19:02.199883683 +0000
@@ -34,6 +34,7 @@
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #include <net/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/ipv4/fib_hash.c linux-2.6.34-rc4/net/ipv4/fib_hash.c
--- linux-2.6.34-rc3/net/ipv4/fib_hash.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/fib_hash.c	2010-04-13 02:19:02.199883683 +0000
@@ -32,6 +32,7 @@
 #include <linux/skbuff.h>
 #include <linux/netlink.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/fib_semantics.c linux-2.6.34-rc4/net/ipv4/fib_semantics.c
--- linux-2.6.34-rc3/net/ipv4/fib_semantics.c	2010-04-13 02:18:56.710570430 +0000
+++ linux-2.6.34-rc4/net/ipv4/fib_semantics.c	2010-04-13 02:19:02.199883683 +0000
@@ -32,6 +32,7 @@
 #include <linux/proc_fs.h>
 #include <linux/skbuff.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <net/arp.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/fib_trie.c linux-2.6.34-rc4/net/ipv4/fib_trie.c
--- linux-2.6.34-rc3/net/ipv4/fib_trie.c	2010-04-13 02:18:56.710570430 +0000
+++ linux-2.6.34-rc4/net/ipv4/fib_trie.c	2010-04-13 02:19:02.200883727 +0000
@@ -71,6 +71,7 @@
 #include <linux/netlink.h>
 #include <linux/init.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/ipv4/icmp.c linux-2.6.34-rc4/net/ipv4/icmp.c
--- linux-2.6.34-rc3/net/ipv4/icmp.c	2010-04-13 02:18:56.711633044 +0000
+++ linux-2.6.34-rc4/net/ipv4/icmp.c	2010-04-13 02:19:02.200883727 +0000
@@ -74,6 +74,7 @@
 #include <linux/netdevice.h>
 #include <linux/string.h>
 #include <linux/netfilter_ipv4.h>
+#include <linux/slab.h>
 #include <net/snmp.h>
 #include <net/ip.h>
 #include <net/route.h>
diff -urN linux-2.6.34-rc3/net/ipv4/igmp.c linux-2.6.34-rc4/net/ipv4/igmp.c
--- linux-2.6.34-rc3/net/ipv4/igmp.c	2010-04-13 02:18:56.711633044 +0000
+++ linux-2.6.34-rc4/net/ipv4/igmp.c	2010-04-13 02:19:02.200883727 +0000
@@ -71,6 +71,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
 #include <linux/types.h>
diff -urN linux-2.6.34-rc3/net/ipv4/inet_diag.c linux-2.6.34-rc4/net/ipv4/inet_diag.c
--- linux-2.6.34-rc3/net/ipv4/inet_diag.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/inet_diag.c	2010-04-13 02:19:02.201883924 +0000
@@ -14,6 +14,7 @@
 #include <linux/types.h>
 #include <linux/fcntl.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/cache.h>
 #include <linux/init.h>
 #include <linux/time.h>
diff -urN linux-2.6.34-rc3/net/ipv4/inet_fragment.c linux-2.6.34-rc4/net/ipv4/inet_fragment.c
--- linux-2.6.34-rc3/net/ipv4/inet_fragment.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/inet_fragment.c	2010-04-13 02:19:02.201883924 +0000
@@ -19,6 +19,7 @@
 #include <linux/random.h>
 #include <linux/skbuff.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 
 #include <net/inet_frag.h>
 
diff -urN linux-2.6.34-rc3/net/ipv4/inet_timewait_sock.c linux-2.6.34-rc4/net/ipv4/inet_timewait_sock.c
--- linux-2.6.34-rc3/net/ipv4/inet_timewait_sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/inet_timewait_sock.c	2010-04-13 02:19:02.201883924 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/kernel.h>
 #include <linux/kmemcheck.h>
+#include <linux/slab.h>
 #include <net/inet_hashtables.h>
 #include <net/inet_timewait_sock.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_forward.c linux-2.6.34-rc4/net/ipv4/ip_forward.c
--- linux-2.6.34-rc3/net/ipv4/ip_forward.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_forward.c	2010-04-13 02:19:02.201883924 +0000
@@ -25,6 +25,7 @@
 #include <linux/ip.h>
 #include <linux/icmp.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/ip.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_fragment.c linux-2.6.34-rc4/net/ipv4/ip_fragment.c
--- linux-2.6.34-rc3/net/ipv4/ip_fragment.c	2010-04-13 02:18:56.711633044 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_fragment.c	2010-04-13 02:19:02.201883924 +0000
@@ -32,6 +32,7 @@
 #include <linux/netdevice.h>
 #include <linux/jhash.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <net/route.h>
 #include <net/dst.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_gre.c linux-2.6.34-rc4/net/ipv4/ip_gre.c
--- linux-2.6.34-rc3/net/ipv4/ip_gre.c	2010-04-13 02:18:56.712633022 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_gre.c	2010-04-13 02:19:02.202676216 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_input.c linux-2.6.34-rc4/net/ipv4/ip_input.c
--- linux-2.6.34-rc3/net/ipv4/ip_input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_input.c	2010-04-13 02:19:02.202676216 +0000
@@ -119,6 +119,7 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 
 #include <linux/net.h>
 #include <linux/socket.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_options.c linux-2.6.34-rc4/net/ipv4/ip_options.c
--- linux-2.6.34-rc3/net/ipv4/ip_options.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_options.c	2010-04-13 02:19:02.202676216 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/capability.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <asm/uaccess.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_output.c linux-2.6.34-rc4/net/ipv4/ip_output.c
--- linux-2.6.34-rc3/net/ipv4/ip_output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_output.c	2010-04-13 02:19:02.202676216 +0000
@@ -51,6 +51,7 @@
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/highmem.h>
+#include <linux/slab.h>
 
 #include <linux/socket.h>
 #include <linux/sockios.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ip_sockglue.c linux-2.6.34-rc4/net/ipv4/ip_sockglue.c
--- linux-2.6.34-rc3/net/ipv4/ip_sockglue.c	2010-04-13 02:18:56.712633022 +0000
+++ linux-2.6.34-rc4/net/ipv4/ip_sockglue.c	2010-04-13 02:19:02.202676216 +0000
@@ -23,6 +23,7 @@
 #include <linux/icmp.h>
 #include <linux/inetdevice.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/ip.h>
 #include <net/icmp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ipconfig.c linux-2.6.34-rc4/net/ipv4/ipconfig.c
--- linux-2.6.34-rc3/net/ipv4/ipconfig.c	2010-04-13 02:18:56.712633022 +0000
+++ linux-2.6.34-rc4/net/ipv4/ipconfig.c	2010-04-13 02:19:02.202676216 +0000
@@ -53,6 +53,7 @@
 #include <linux/root_dev.h>
 #include <linux/delay.h>
 #include <linux/nfs_fs.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/arp.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ipip.c linux-2.6.34-rc4/net/ipv4/ipip.c
--- linux-2.6.34-rc3/net/ipv4/ipip.c	2010-04-13 02:18:56.712633022 +0000
+++ linux-2.6.34-rc4/net/ipv4/ipip.c	2010-04-13 02:19:02.203883463 +0000
@@ -95,6 +95,7 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ipv4/ipmr.c linux-2.6.34-rc4/net/ipv4/ipmr.c
--- linux-2.6.34-rc3/net/ipv4/ipmr.c	2010-04-13 02:18:56.713633063 +0000
+++ linux-2.6.34-rc4/net/ipv4/ipmr.c	2010-04-13 02:19:02.203883463 +0000
@@ -47,6 +47,7 @@
 #include <linux/mroute.h>
 #include <linux/init.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/arptable_filter.c linux-2.6.34-rc4/net/ipv4/netfilter/arptable_filter.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/arptable_filter.c	2010-04-13 02:18:56.714633038 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/arptable_filter.c	2010-04-13 02:19:02.204883096 +0000
@@ -8,6 +8,7 @@
 #include <linux/module.h>
 #include <linux/netfilter/x_tables.h>
 #include <linux/netfilter_arp/arp_tables.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("David S. Miller <davem@redhat.com>");
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/ip_queue.c linux-2.6.34-rc4/net/ipv4/netfilter/ip_queue.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/ip_queue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/ip_queue.c	2010-04-13 02:19:02.204883096 +0000
@@ -26,6 +26,7 @@
 #include <linux/security.h>
 #include <linux/net.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
 #include <net/route.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/ipt_CLUSTERIP.c linux-2.6.34-rc4/net/ipv4/netfilter/ipt_CLUSTERIP.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/ipt_CLUSTERIP.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/ipt_CLUSTERIP.c	2010-04-13 02:19:02.205883078 +0000
@@ -14,6 +14,7 @@
 #include <linux/jhash.h>
 #include <linux/bitops.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/udp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/ipt_REJECT.c linux-2.6.34-rc4/net/ipv4/netfilter/ipt_REJECT.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/ipt_REJECT.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/ipt_REJECT.c	2010-04-13 02:19:02.205883078 +0000
@@ -12,6 +12,7 @@
 
 #include <linux/module.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/ip.h>
 #include <linux/udp.h>
 #include <linux/icmp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/ipt_ULOG.c linux-2.6.34-rc4/net/ipv4/netfilter/ipt_ULOG.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/ipt_ULOG.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/ipt_ULOG.c	2010-04-13 02:19:02.205883078 +0000
@@ -33,6 +33,7 @@
 #include <linux/module.h>
 #include <linux/spinlock.h>
 #include <linux/socket.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/kernel.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/iptable_filter.c linux-2.6.34-rc4/net/ipv4/netfilter/iptable_filter.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/iptable_filter.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/iptable_filter.c	2010-04-13 02:19:02.206883107 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/netfilter_ipv4/ip_tables.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 
 MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/iptable_mangle.c linux-2.6.34-rc4/net/ipv4/netfilter/iptable_mangle.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/iptable_mangle.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/iptable_mangle.c	2010-04-13 02:19:02.206883107 +0000
@@ -12,6 +12,7 @@
 #include <linux/netfilter_ipv4/ip_tables.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/route.h>
 #include <linux/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/iptable_raw.c linux-2.6.34-rc4/net/ipv4/netfilter/iptable_raw.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/iptable_raw.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/iptable_raw.c	2010-04-13 02:19:02.206883107 +0000
@@ -5,6 +5,7 @@
  */
 #include <linux/module.h>
 #include <linux/netfilter_ipv4/ip_tables.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 
 #define RAW_VALID_HOOKS ((1 << NF_INET_PRE_ROUTING) | (1 << NF_INET_LOCAL_OUT))
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/iptable_security.c linux-2.6.34-rc4/net/ipv4/netfilter/iptable_security.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/iptable_security.c	2010-04-13 02:18:56.715633031 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/iptable_security.c	2010-04-13 02:19:02.206883107 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/module.h>
 #include <linux/netfilter_ipv4/ip_tables.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 
 MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_core.c linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_core.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_core.c	2010-04-13 02:18:56.716633030 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_core.c	2010-04-13 02:19:02.207883457 +0000
@@ -12,6 +12,7 @@
 #include <linux/types.h>
 #include <linux/timer.h>
 #include <linux/skbuff.h>
+#include <linux/gfp.h>
 #include <net/checksum.h>
 #include <net/icmp.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_helper.c linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_helper.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_helper.c	2010-04-13 02:18:56.716633030 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_helper.c	2010-04-13 02:19:02.207883457 +0000
@@ -8,6 +8,7 @@
  * published by the Free Software Foundation.
  */
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/kmod.h>
 #include <linux/types.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_rule.c linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_rule.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_rule.c	2010-04-13 02:18:56.716633030 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_rule.c	2010-04-13 02:19:02.207883457 +0000
@@ -15,6 +15,7 @@
 #include <linux/kmod.h>
 #include <linux/skbuff.h>
 #include <linux/proc_fs.h>
+#include <linux/slab.h>
 #include <net/checksum.h>
 #include <net/route.h>
 #include <linux/bitops.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_snmp_basic.c linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_snmp_basic.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_snmp_basic.c	2010-04-13 02:18:56.717633068 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_snmp_basic.c	2010-04-13 02:19:02.208884143 +0000
@@ -43,6 +43,7 @@
 #include <linux/moduleparam.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <linux/ip.h>
 #include <linux/udp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_standalone.c linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_standalone.c
--- linux-2.6.34-rc3/net/ipv4/netfilter/nf_nat_standalone.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter/nf_nat_standalone.c	2010-04-13 02:19:02.208884143 +0000
@@ -7,6 +7,7 @@
  */
 #include <linux/types.h>
 #include <linux/icmp.h>
+#include <linux/gfp.h>
 #include <linux/ip.h>
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv4.h>
diff -urN linux-2.6.34-rc3/net/ipv4/netfilter.c linux-2.6.34-rc4/net/ipv4/netfilter.c
--- linux-2.6.34-rc3/net/ipv4/netfilter.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/netfilter.c	2010-04-13 02:19:02.203883463 +0000
@@ -4,6 +4,7 @@
 #include <linux/netfilter_ipv4.h>
 #include <linux/ip.h>
 #include <linux/skbuff.h>
+#include <linux/gfp.h>
 #include <net/route.h>
 #include <net/xfrm.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/raw.c linux-2.6.34-rc4/net/ipv4/raw.c
--- linux-2.6.34-rc3/net/ipv4/raw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/raw.c	2010-04-13 02:19:02.208884143 +0000
@@ -60,7 +60,6 @@
 #include <net/net_namespace.h>
 #include <net/dst.h>
 #include <net/sock.h>
-#include <linux/gfp.h>
 #include <linux/ip.h>
 #include <linux/net.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/route.c linux-2.6.34-rc4/net/ipv4/route.c
--- linux-2.6.34-rc3/net/ipv4/route.c	2010-04-13 02:18:56.718633082 +0000
+++ linux-2.6.34-rc4/net/ipv4/route.c	2010-04-13 02:19:02.209883137 +0000
@@ -90,6 +90,7 @@
 #include <linux/jhash.h>
 #include <linux/rcupdate.h>
 #include <linux/times.h>
+#include <linux/slab.h>
 #include <net/dst.h>
 #include <net/net_namespace.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/ipv4/sysctl_net_ipv4.c linux-2.6.34-rc4/net/ipv4/sysctl_net_ipv4.c
--- linux-2.6.34-rc3/net/ipv4/sysctl_net_ipv4.c	2010-04-13 02:18:56.718633082 +0000
+++ linux-2.6.34-rc4/net/ipv4/sysctl_net_ipv4.c	2010-04-13 02:19:02.209883137 +0000
@@ -12,6 +12,7 @@
 #include <linux/inetdevice.h>
 #include <linux/seqlock.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/snmp.h>
 #include <net/icmp.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/ipv4/tcp.c linux-2.6.34-rc4/net/ipv4/tcp.c
--- linux-2.6.34-rc3/net/ipv4/tcp.c	2010-04-13 02:18:56.719571447 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp.c	2010-04-13 02:19:02.210883472 +0000
@@ -265,6 +265,7 @@
 #include <linux/err.h>
 #include <linux/crypto.h>
 #include <linux/time.h>
+#include <linux/slab.h>
 
 #include <net/icmp.h>
 #include <net/tcp.h>
@@ -1368,6 +1369,7 @@
 		sk_eat_skb(sk, skb, 0);
 		if (!desc->count)
 			break;
+		tp->copied_seq = seq;
 	}
 	tp->copied_seq = seq;
 
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_cong.c linux-2.6.34-rc4/net/ipv4/tcp_cong.c
--- linux-2.6.34-rc3/net/ipv4/tcp_cong.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_cong.c	2010-04-13 02:19:02.210883472 +0000
@@ -10,6 +10,7 @@
 #include <linux/mm.h>
 #include <linux/types.h>
 #include <linux/list.h>
+#include <linux/gfp.h>
 #include <net/tcp.h>
 
 int sysctl_tcp_max_ssthresh = 0;
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_input.c linux-2.6.34-rc4/net/ipv4/tcp_input.c
--- linux-2.6.34-rc3/net/ipv4/tcp_input.c	2010-04-13 02:18:56.719571447 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_input.c	2010-04-13 02:19:02.211883768 +0000
@@ -62,6 +62,7 @@
  */
 
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/sysctl.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_ipv4.c linux-2.6.34-rc4/net/ipv4/tcp_ipv4.c
--- linux-2.6.34-rc3/net/ipv4/tcp_ipv4.c	2010-04-13 02:18:56.720570447 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_ipv4.c	2010-04-13 02:19:02.211883768 +0000
@@ -60,6 +60,7 @@
 #include <linux/jhash.h>
 #include <linux/init.h>
 #include <linux/times.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/icmp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_minisocks.c linux-2.6.34-rc4/net/ipv4/tcp_minisocks.c
--- linux-2.6.34-rc3/net/ipv4/tcp_minisocks.c	2010-04-13 02:18:56.720570447 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_minisocks.c	2010-04-13 02:19:02.211883768 +0000
@@ -20,6 +20,7 @@
 
 #include <linux/mm.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/sysctl.h>
 #include <linux/workqueue.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_output.c linux-2.6.34-rc4/net/ipv4/tcp_output.c
--- linux-2.6.34-rc3/net/ipv4/tcp_output.c	2010-04-13 02:18:56.720570447 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_output.c	2010-04-13 02:19:02.212883851 +0000
@@ -37,6 +37,7 @@
 #include <net/tcp.h>
 
 #include <linux/compiler.h>
+#include <linux/gfp.h>
 #include <linux/module.h>
 
 /* People can turn this off for buggy TCP's found in printers etc. */
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_probe.c linux-2.6.34-rc4/net/ipv4/tcp_probe.c
--- linux-2.6.34-rc3/net/ipv4/tcp_probe.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_probe.c	2010-04-13 02:19:02.212883851 +0000
@@ -22,6 +22,7 @@
 #include <linux/kprobes.h>
 #include <linux/socket.h>
 #include <linux/tcp.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 #include <linux/module.h>
 #include <linux/ktime.h>
diff -urN linux-2.6.34-rc3/net/ipv4/tcp_timer.c linux-2.6.34-rc4/net/ipv4/tcp_timer.c
--- linux-2.6.34-rc3/net/ipv4/tcp_timer.c	2010-04-13 02:18:56.721570323 +0000
+++ linux-2.6.34-rc4/net/ipv4/tcp_timer.c	2010-04-13 02:19:02.212883851 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <net/tcp.h>
 
 int sysctl_tcp_syn_retries __read_mostly = TCP_SYN_RETRIES;
diff -urN linux-2.6.34-rc3/net/ipv4/tunnel4.c linux-2.6.34-rc4/net/ipv4/tunnel4.c
--- linux-2.6.34-rc3/net/ipv4/tunnel4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/tunnel4.c	2010-04-13 02:19:02.212883851 +0000
@@ -8,6 +8,7 @@
 #include <linux/mutex.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/icmp.h>
 #include <net/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/ipv4/udp.c linux-2.6.34-rc4/net/ipv4/udp.c
--- linux-2.6.34-rc3/net/ipv4/udp.c	2010-04-13 02:18:56.721570323 +0000
+++ linux-2.6.34-rc4/net/ipv4/udp.c	2010-04-13 02:19:02.213883286 +0000
@@ -95,6 +95,7 @@
 #include <linux/mm.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/tcp_states.h>
 #include <linux/skbuff.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/ipv4/xfrm4_input.c linux-2.6.34-rc4/net/ipv4/xfrm4_input.c
--- linux-2.6.34-rc3/net/ipv4/xfrm4_input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/xfrm4_input.c	2010-04-13 02:19:02.213883286 +0000
@@ -9,6 +9,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/string.h>
 #include <linux/netfilter.h>
diff -urN linux-2.6.34-rc3/net/ipv4/xfrm4_mode_tunnel.c linux-2.6.34-rc4/net/ipv4/xfrm4_mode_tunnel.c
--- linux-2.6.34-rc3/net/ipv4/xfrm4_mode_tunnel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv4/xfrm4_mode_tunnel.c	2010-04-13 02:19:02.213883286 +0000
@@ -4,6 +4,7 @@
  * Copyright (c) 2004-2006 Herbert Xu <herbert@gondor.apana.org.au>
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/net/ipv6/addrconf.c linux-2.6.34-rc4/net/ipv6/addrconf.c
--- linux-2.6.34-rc3/net/ipv6/addrconf.c	2010-04-13 02:18:56.722633042 +0000
+++ linux-2.6.34-rc4/net/ipv6/addrconf.c	2010-04-13 02:19:02.214853246 +0000
@@ -53,6 +53,7 @@
 #include <linux/route.h>
 #include <linux/inetdevice.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #ifdef CONFIG_SYSCTL
 #include <linux/sysctl.h>
 #endif
diff -urN linux-2.6.34-rc3/net/ipv6/addrlabel.c linux-2.6.34-rc4/net/ipv6/addrlabel.c
--- linux-2.6.34-rc3/net/ipv6/addrlabel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/addrlabel.c	2010-04-13 02:19:02.214853246 +0000
@@ -13,6 +13,7 @@
 #include <linux/list.h>
 #include <linux/rcupdate.h>
 #include <linux/in6.h>
+#include <linux/slab.h>
 #include <net/addrconf.h>
 #include <linux/if_addrlabel.h>
 #include <linux/netlink.h>
diff -urN linux-2.6.34-rc3/net/ipv6/af_inet6.c linux-2.6.34-rc4/net/ipv6/af_inet6.c
--- linux-2.6.34-rc3/net/ipv6/af_inet6.c	2010-04-13 02:18:56.722633042 +0000
+++ linux-2.6.34-rc4/net/ipv6/af_inet6.c	2010-04-13 02:19:02.214853246 +0000
@@ -36,6 +36,7 @@
 #include <linux/proc_fs.h>
 #include <linux/stat.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ah6.c linux-2.6.34-rc4/net/ipv6/ah6.c
--- linux-2.6.34-rc3/net/ipv6/ah6.c	2010-04-13 02:18:56.722633042 +0000
+++ linux-2.6.34-rc4/net/ipv6/ah6.c	2010-04-13 02:19:02.214853246 +0000
@@ -26,6 +26,7 @@
 
 #include <crypto/hash.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <net/ah.h>
 #include <linux/crypto.h>
diff -urN linux-2.6.34-rc3/net/ipv6/anycast.c linux-2.6.34-rc4/net/ipv6/anycast.c
--- linux-2.6.34-rc3/net/ipv6/anycast.c	2010-04-13 02:18:56.722633042 +0000
+++ linux-2.6.34-rc4/net/ipv6/anycast.c	2010-04-13 02:19:02.215883497 +0000
@@ -29,6 +29,7 @@
 #include <linux/init.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/ipv6/datagram.c linux-2.6.34-rc4/net/ipv6/datagram.c
--- linux-2.6.34-rc3/net/ipv6/datagram.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/datagram.c	2010-04-13 02:19:02.215883497 +0000
@@ -21,6 +21,7 @@
 #include <linux/in6.h>
 #include <linux/ipv6.h>
 #include <linux/route.h>
+#include <linux/slab.h>
 
 #include <net/ipv6.h>
 #include <net/ndisc.h>
diff -urN linux-2.6.34-rc3/net/ipv6/exthdrs.c linux-2.6.34-rc4/net/ipv6/exthdrs.c
--- linux-2.6.34-rc3/net/ipv6/exthdrs.c	2010-04-13 02:18:56.723633053 +0000
+++ linux-2.6.34-rc4/net/ipv6/exthdrs.c	2010-04-13 02:19:02.215883497 +0000
@@ -29,6 +29,7 @@
 #include <linux/netdevice.h>
 #include <linux/in6.h>
 #include <linux/icmpv6.h>
+#include <linux/slab.h>
 
 #include <net/dst.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/ipv6/icmp.c linux-2.6.34-rc4/net/ipv6/icmp.c
--- linux-2.6.34-rc3/net/ipv6/icmp.c	2010-04-13 02:18:56.723633053 +0000
+++ linux-2.6.34-rc4/net/ipv6/icmp.c	2010-04-13 02:19:02.215883497 +0000
@@ -40,6 +40,7 @@
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 
 #ifdef CONFIG_SYSCTL
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/net/ipv6/inet6_connection_sock.c linux-2.6.34-rc4/net/ipv6/inet6_connection_sock.c
--- linux-2.6.34-rc3/net/ipv6/inet6_connection_sock.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/inet6_connection_sock.c	2010-04-13 02:19:02.215883497 +0000
@@ -17,6 +17,7 @@
 #include <linux/in6.h>
 #include <linux/ipv6.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 
 #include <net/addrconf.h>
 #include <net/inet_connection_sock.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6_fib.c linux-2.6.34-rc4/net/ipv6/ip6_fib.c
--- linux-2.6.34-rc3/net/ipv6/ip6_fib.c	2010-04-13 02:18:56.723633053 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6_fib.c	2010-04-13 02:19:02.216883664 +0000
@@ -26,6 +26,7 @@
 #include <linux/in6.h>
 #include <linux/init.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 #ifdef 	CONFIG_PROC_FS
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6_flowlabel.c linux-2.6.34-rc4/net/ipv6/ip6_flowlabel.c
--- linux-2.6.34-rc3/net/ipv6/ip6_flowlabel.c	2010-04-13 02:18:56.723633053 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6_flowlabel.c	2010-04-13 02:19:02.216883664 +0000
@@ -20,6 +20,7 @@
 #include <linux/route.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6_input.c linux-2.6.34-rc4/net/ipv6/ip6_input.c
--- linux-2.6.34-rc3/net/ipv6/ip6_input.c	2010-04-13 02:18:56.723633053 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6_input.c	2010-04-13 02:19:02.216883664 +0000
@@ -28,6 +28,7 @@
 #include <linux/in6.h>
 #include <linux/icmpv6.h>
 #include <linux/mroute6.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6_output.c linux-2.6.34-rc4/net/ipv6/ip6_output.c
--- linux-2.6.34-rc3/net/ipv6/ip6_output.c	2010-04-13 02:18:56.724633058 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6_output.c	2010-04-13 02:19:02.216883664 +0000
@@ -37,6 +37,7 @@
 #include <linux/tcp.h>
 #include <linux/route.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6_tunnel.c linux-2.6.34-rc4/net/ipv6/ip6_tunnel.c
--- linux-2.6.34-rc3/net/ipv6/ip6_tunnel.c	2010-04-13 02:18:56.724633058 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6_tunnel.c	2010-04-13 02:19:02.217883606 +0000
@@ -37,6 +37,7 @@
 #include <linux/route.h>
 #include <linux/rtnetlink.h>
 #include <linux/netfilter_ipv6.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/atomic.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ip6mr.c linux-2.6.34-rc4/net/ipv6/ip6mr.c
--- linux-2.6.34-rc3/net/ipv6/ip6mr.c	2010-04-13 02:18:56.724633058 +0000
+++ linux-2.6.34-rc4/net/ipv6/ip6mr.c	2010-04-13 02:19:02.217883606 +0000
@@ -33,6 +33,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/protocol.h>
 #include <linux/skbuff.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ipv6_sockglue.c linux-2.6.34-rc4/net/ipv6/ipv6_sockglue.c
--- linux-2.6.34-rc3/net/ipv6/ipv6_sockglue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/ipv6_sockglue.c	2010-04-13 02:19:02.217883606 +0000
@@ -36,6 +36,7 @@
 #include <linux/init.h>
 #include <linux/sysctl.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <net/snmp.h>
diff -urN linux-2.6.34-rc3/net/ipv6/mcast.c linux-2.6.34-rc4/net/ipv6/mcast.c
--- linux-2.6.34-rc3/net/ipv6/mcast.c	2010-04-13 02:18:56.725633072 +0000
+++ linux-2.6.34-rc4/net/ipv6/mcast.c	2010-04-13 02:19:02.218883404 +0000
@@ -43,6 +43,7 @@
 #include <linux/init.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/ndisc.c linux-2.6.34-rc4/net/ipv6/ndisc.c
--- linux-2.6.34-rc3/net/ipv6/ndisc.c	2010-04-13 02:18:56.725633072 +0000
+++ linux-2.6.34-rc4/net/ipv6/ndisc.c	2010-04-13 02:19:02.218883404 +0000
@@ -59,6 +59,7 @@
 #include <linux/route.h>
 #include <linux/init.h>
 #include <linux/rcupdate.h>
+#include <linux/slab.h>
 #ifdef CONFIG_SYSCTL
 #include <linux/sysctl.h>
 #endif
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6_queue.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6_queue.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6_queue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6_queue.c	2010-04-13 02:19:02.218883404 +0000
@@ -25,6 +25,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
 #include <net/ipv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6t_REJECT.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6t_REJECT.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6t_REJECT.c	2010-04-13 02:18:56.726633077 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6t_REJECT.c	2010-04-13 02:19:02.219776782 +0000
@@ -15,6 +15,7 @@
  * 2 of the License, or (at your option) any later version.
  */
 
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/icmpv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_filter.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_filter.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_filter.c	2010-04-13 02:18:56.726633077 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_filter.c	2010-04-13 02:19:02.219776782 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/netfilter_ipv6/ip6_tables.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("Netfilter Core Team <coreteam@netfilter.org>");
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_mangle.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_mangle.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_mangle.c	2010-04-13 02:18:56.727633043 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_mangle.c	2010-04-13 02:19:02.220883579 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/module.h>
 #include <linux/netfilter_ipv6/ip6_tables.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("Netfilter Core Team <coreteam@netfilter.org>");
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_raw.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_raw.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_raw.c	2010-04-13 02:18:56.727633043 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_raw.c	2010-04-13 02:19:02.220883579 +0000
@@ -5,6 +5,7 @@
  */
 #include <linux/module.h>
 #include <linux/netfilter_ipv6/ip6_tables.h>
+#include <linux/slab.h>
 
 #define RAW_VALID_HOOKS ((1 << NF_INET_PRE_ROUTING) | (1 << NF_INET_LOCAL_OUT))
 
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_security.c linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_security.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/ip6table_security.c	2010-04-13 02:18:56.727633043 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/ip6table_security.c	2010-04-13 02:19:02.220883579 +0000
@@ -17,6 +17,7 @@
  */
 #include <linux/module.h>
 #include <linux/netfilter_ipv6/ip6_tables.h>
+#include <linux/slab.h>
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("James Morris <jmorris <at> redhat.com>");
diff -urN linux-2.6.34-rc3/net/ipv6/netfilter/nf_conntrack_reasm.c linux-2.6.34-rc4/net/ipv6/netfilter/nf_conntrack_reasm.c
--- linux-2.6.34-rc3/net/ipv6/netfilter/nf_conntrack_reasm.c	2010-04-13 02:18:56.727633043 +0000
+++ linux-2.6.34-rc4/net/ipv6/netfilter/nf_conntrack_reasm.c	2010-04-13 02:19:02.220883579 +0000
@@ -27,6 +27,7 @@
 #include <linux/ipv6.h>
 #include <linux/icmpv6.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <net/snmp.h>
diff -urN linux-2.6.34-rc3/net/ipv6/raw.c linux-2.6.34-rc4/net/ipv6/raw.c
--- linux-2.6.34-rc3/net/ipv6/raw.c	2010-04-13 02:18:56.728633027 +0000
+++ linux-2.6.34-rc4/net/ipv6/raw.c	2010-04-13 02:19:02.221883830 +0000
@@ -21,6 +21,7 @@
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/socket.h>
+#include <linux/slab.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
 #include <linux/in6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/reassembly.c linux-2.6.34-rc4/net/ipv6/reassembly.c
--- linux-2.6.34-rc3/net/ipv6/reassembly.c	2010-04-13 02:18:56.728633027 +0000
+++ linux-2.6.34-rc4/net/ipv6/reassembly.c	2010-04-13 02:19:02.221883830 +0000
@@ -41,6 +41,7 @@
 #include <linux/random.h>
 #include <linux/jhash.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/sock.h>
 #include <net/snmp.h>
diff -urN linux-2.6.34-rc3/net/ipv6/route.c linux-2.6.34-rc4/net/ipv6/route.c
--- linux-2.6.34-rc3/net/ipv6/route.c	2010-04-13 02:18:56.729572124 +0000
+++ linux-2.6.34-rc4/net/ipv6/route.c	2010-04-13 02:19:02.221883830 +0000
@@ -40,6 +40,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/nsproxy.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/snmp.h>
 #include <net/ipv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/sit.c linux-2.6.34-rc4/net/ipv6/sit.c
--- linux-2.6.34-rc3/net/ipv6/sit.c	2010-04-13 02:18:56.729572124 +0000
+++ linux-2.6.34-rc4/net/ipv6/sit.c	2010-04-13 02:19:02.222884084 +0000
@@ -28,6 +28,7 @@
 #include <linux/netdevice.h>
 #include <linux/if_arp.h>
 #include <linux/icmp.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 #include <linux/init.h>
 #include <linux/netfilter_ipv4.h>
diff -urN linux-2.6.34-rc3/net/ipv6/sysctl_net_ipv6.c linux-2.6.34-rc4/net/ipv6/sysctl_net_ipv6.c
--- linux-2.6.34-rc3/net/ipv6/sysctl_net_ipv6.c	2010-04-13 02:18:56.729572124 +0000
+++ linux-2.6.34-rc4/net/ipv6/sysctl_net_ipv6.c	2010-04-13 02:19:02.222884084 +0000
@@ -9,6 +9,7 @@
 #include <linux/sysctl.h>
 #include <linux/in6.h>
 #include <linux/ipv6.h>
+#include <linux/slab.h>
 #include <net/ndisc.h>
 #include <net/ipv6.h>
 #include <net/addrconf.h>
diff -urN linux-2.6.34-rc3/net/ipv6/tcp_ipv6.c linux-2.6.34-rc4/net/ipv6/tcp_ipv6.c
--- linux-2.6.34-rc3/net/ipv6/tcp_ipv6.c	2010-04-13 02:18:56.729572124 +0000
+++ linux-2.6.34-rc4/net/ipv6/tcp_ipv6.c	2010-04-13 02:19:02.222884084 +0000
@@ -38,6 +38,7 @@
 #include <linux/jhash.h>
 #include <linux/ipsec.h>
 #include <linux/times.h>
+#include <linux/slab.h>
 
 #include <linux/ipv6.h>
 #include <linux/icmpv6.h>
diff -urN linux-2.6.34-rc3/net/ipv6/tunnel6.c linux-2.6.34-rc4/net/ipv6/tunnel6.c
--- linux-2.6.34-rc3/net/ipv6/tunnel6.c	2010-04-13 02:18:56.729572124 +0000
+++ linux-2.6.34-rc4/net/ipv6/tunnel6.c	2010-04-13 02:19:02.222884084 +0000
@@ -25,6 +25,7 @@
 #include <linux/mutex.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/ipv6.h>
 #include <net/protocol.h>
 #include <net/xfrm.h>
diff -urN linux-2.6.34-rc3/net/ipv6/udp.c linux-2.6.34-rc4/net/ipv6/udp.c
--- linux-2.6.34-rc3/net/ipv6/udp.c	2010-04-13 02:18:56.730570470 +0000
+++ linux-2.6.34-rc4/net/ipv6/udp.c	2010-04-13 02:19:02.223883192 +0000
@@ -34,6 +34,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <asm/uaccess.h>
 
 #include <net/ndisc.h>
diff -urN linux-2.6.34-rc3/net/ipv6/xfrm6_mode_tunnel.c linux-2.6.34-rc4/net/ipv6/xfrm6_mode_tunnel.c
--- linux-2.6.34-rc3/net/ipv6/xfrm6_mode_tunnel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipv6/xfrm6_mode_tunnel.c	2010-04-13 02:19:02.223883192 +0000
@@ -5,6 +5,7 @@
  * Copyright (c) 2004-2006 Herbert Xu <herbert@gondor.apana.org.au>
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/net/ipv6/xfrm6_tunnel.c linux-2.6.34-rc4/net/ipv6/xfrm6_tunnel.c
--- linux-2.6.34-rc3/net/ipv6/xfrm6_tunnel.c	2010-04-13 02:18:56.730570470 +0000
+++ linux-2.6.34-rc4/net/ipv6/xfrm6_tunnel.c	2010-04-13 02:19:02.223883192 +0000
@@ -23,6 +23,7 @@
  */
 #include <linux/module.h>
 #include <linux/xfrm.h>
+#include <linux/slab.h>
 #include <linux/rculist.h>
 #include <net/ip.h>
 #include <net/xfrm.h>
diff -urN linux-2.6.34-rc3/net/ipx/af_ipx.c linux-2.6.34-rc4/net/ipx/af_ipx.c
--- linux-2.6.34-rc3/net/ipx/af_ipx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipx/af_ipx.c	2010-04-13 02:19:02.224883659 +0000
@@ -40,6 +40,7 @@
 #include <linux/net.h>
 #include <linux/netdevice.h>
 #include <linux/uio.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/smp_lock.h>
 #include <linux/socket.h>
diff -urN linux-2.6.34-rc3/net/ipx/ipx_route.c linux-2.6.34-rc4/net/ipx/ipx_route.c
--- linux-2.6.34-rc3/net/ipx/ipx_route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/ipx/ipx_route.c	2010-04-13 02:19:02.224883659 +0000
@@ -9,6 +9,7 @@
 
 #include <linux/list.h>
 #include <linux/route.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <net/ipx.h>
diff -urN linux-2.6.34-rc3/net/irda/af_irda.c linux-2.6.34-rc4/net/irda/af_irda.c
--- linux-2.6.34-rc3/net/irda/af_irda.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/af_irda.c	2010-04-13 02:19:02.224883659 +0000
@@ -48,6 +48,7 @@
 #include <linux/smp_lock.h>
 #include <linux/socket.h>
 #include <linux/sockios.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/net.h>
 #include <linux/irda.h>
diff -urN linux-2.6.34-rc3/net/irda/discovery.c linux-2.6.34-rc4/net/irda/discovery.c
--- linux-2.6.34-rc3/net/irda/discovery.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/discovery.c	2010-04-13 02:19:02.224883659 +0000
@@ -34,6 +34,7 @@
 #include <linux/socket.h>
 #include <linux/fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irlmp.h>
diff -urN linux-2.6.34-rc3/net/irda/ircomm/ircomm_core.c linux-2.6.34-rc4/net/irda/ircomm/ircomm_core.c
--- linux-2.6.34-rc3/net/irda/ircomm/ircomm_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/ircomm/ircomm_core.c	2010-04-13 02:19:02.225883904 +0000
@@ -33,6 +33,7 @@
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irmod.h>
diff -urN linux-2.6.34-rc3/net/irda/ircomm/ircomm_lmp.c linux-2.6.34-rc4/net/irda/ircomm/ircomm_lmp.c
--- linux-2.6.34-rc3/net/irda/ircomm/ircomm_lmp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/ircomm/ircomm_lmp.c	2010-04-13 02:19:02.225883904 +0000
@@ -31,6 +31,7 @@
  ********************************************************************/
 
 #include <linux/init.h>
+#include <linux/gfp.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irlmp.h>
diff -urN linux-2.6.34-rc3/net/irda/ircomm/ircomm_param.c linux-2.6.34-rc4/net/irda/ircomm/ircomm_param.c
--- linux-2.6.34-rc3/net/irda/ircomm/ircomm_param.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/ircomm/ircomm_param.c	2010-04-13 02:19:02.225883904 +0000
@@ -28,6 +28,7 @@
  *
  ********************************************************************/
 
+#include <linux/gfp.h>
 #include <linux/workqueue.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/net/irda/ircomm/ircomm_tty.c linux-2.6.34-rc4/net/irda/ircomm/ircomm_tty.c
--- linux-2.6.34-rc3/net/irda/ircomm/ircomm_tty.c	2010-04-13 02:18:56.731570565 +0000
+++ linux-2.6.34-rc4/net/irda/ircomm/ircomm_tty.c	2010-04-13 02:19:02.225883904 +0000
@@ -33,6 +33,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/seq_file.h>
 #include <linux/termios.h>
diff -urN linux-2.6.34-rc3/net/irda/irda_device.c linux-2.6.34-rc4/net/irda/irda_device.c
--- linux-2.6.34-rc3/net/irda/irda_device.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irda_device.c	2010-04-13 02:19:02.225883904 +0000
@@ -41,6 +41,7 @@
 #include <linux/tty.h>
 #include <linux/kmod.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include <asm/ioctls.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/irda/iriap.c linux-2.6.34-rc4/net/irda/iriap.c
--- linux-2.6.34-rc3/net/irda/iriap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/iriap.c	2010-04-13 02:19:02.225883904 +0000
@@ -31,6 +31,7 @@
 #include <linux/string.h>
 #include <linux/init.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/byteorder.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/net/irda/iriap_event.c linux-2.6.34-rc4/net/irda/iriap_event.c
--- linux-2.6.34-rc3/net/irda/iriap_event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/iriap_event.c	2010-04-13 02:19:02.225883904 +0000
@@ -24,6 +24,8 @@
  *
  ********************************************************************/
 
+#include <linux/slab.h>
+
 #include <net/irda/irda.h>
 #include <net/irda/irlmp.h>
 #include <net/irda/iriap.h>
diff -urN linux-2.6.34-rc3/net/irda/irias_object.c linux-2.6.34-rc4/net/irda/irias_object.c
--- linux-2.6.34-rc3/net/irda/irias_object.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irias_object.c	2010-04-13 02:19:02.226883519 +0000
@@ -22,6 +22,7 @@
  *
  ********************************************************************/
 
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/socket.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/net/irda/irlan/irlan_client.c linux-2.6.34-rc4/net/irda/irlan/irlan_client.c
--- linux-2.6.34-rc3/net/irda/irlan/irlan_client.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irlan/irlan_client.c	2010-04-13 02:19:02.226883519 +0000
@@ -28,6 +28,7 @@
 
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/init.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/irda/irlan/irlan_common.c linux-2.6.34-rc4/net/irda/irlan/irlan_common.c
--- linux-2.6.34-rc3/net/irda/irlan/irlan_common.c	2010-04-13 02:18:56.731570565 +0000
+++ linux-2.6.34-rc4/net/irda/irlan/irlan_common.c	2010-04-13 02:19:02.226883519 +0000
@@ -27,6 +27,7 @@
 
 #include <linux/kernel.h>
 #include <linux/string.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/irda/irlan/irlan_provider.c linux-2.6.34-rc4/net/irda/irlan/irlan_provider.c
--- linux-2.6.34-rc3/net/irda/irlan/irlan_provider.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irlan/irlan_provider.c	2010-04-13 02:19:02.226883519 +0000
@@ -34,6 +34,7 @@
 #include <linux/init.h>
 #include <linux/random.h>
 #include <linux/bitops.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/byteorder.h>
diff -urN linux-2.6.34-rc3/net/irda/irlap_event.c linux-2.6.34-rc4/net/irda/irlap_event.c
--- linux-2.6.34-rc3/net/irda/irlap_event.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irlap_event.c	2010-04-13 02:19:02.227883800 +0000
@@ -29,6 +29,7 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irlap_event.h>
diff -urN linux-2.6.34-rc3/net/irda/irlap_frame.c linux-2.6.34-rc4/net/irda/irlap_frame.c
--- linux-2.6.34-rc3/net/irda/irlap_frame.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irlap_frame.c	2010-04-13 02:19:02.227883800 +0000
@@ -29,6 +29,7 @@
 #include <linux/if_ether.h>
 #include <linux/netdevice.h>
 #include <linux/irda.h>
+#include <linux/slab.h>
 
 #include <net/pkt_sched.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/irda/irnet/irnet_irda.c linux-2.6.34-rc4/net/irda/irnet/irnet_irda.c
--- linux-2.6.34-rc3/net/irda/irnet/irnet_irda.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irnet/irnet_irda.c	2010-04-13 02:19:02.227883800 +0000
@@ -11,6 +11,7 @@
 #include "irnet_irda.h"		/* Private header */
 #include <linux/sched.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 /*
diff -urN linux-2.6.34-rc3/net/irda/irnet/irnet_ppp.c linux-2.6.34-rc4/net/irda/irnet/irnet_ppp.c
--- linux-2.6.34-rc3/net/irda/irnet/irnet_ppp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irnet/irnet_ppp.c	2010-04-13 02:19:02.227883800 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include "irnet_ppp.h"		/* Private header */
 /* Please put other headers in irnet.h - Thanks */
diff -urN linux-2.6.34-rc3/net/irda/irnetlink.c linux-2.6.34-rc4/net/irda/irnetlink.c
--- linux-2.6.34-rc3/net/irda/irnetlink.c	2010-04-13 02:18:56.731570565 +0000
+++ linux-2.6.34-rc4/net/irda/irnetlink.c	2010-04-13 02:19:02.227883800 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/socket.h>
 #include <linux/irda.h>
+#include <linux/gfp.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
 #include <net/irda/irda.h>
diff -urN linux-2.6.34-rc3/net/irda/irqueue.c linux-2.6.34-rc4/net/irda/irqueue.c
--- linux-2.6.34-rc3/net/irda/irqueue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irqueue.c	2010-04-13 02:19:02.228883400 +0000
@@ -192,6 +192,7 @@
  * Jean II
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <net/irda/irda.h>
 #include <net/irda/irqueue.h>
diff -urN linux-2.6.34-rc3/net/irda/irttp.c linux-2.6.34-rc4/net/irda/irttp.c
--- linux-2.6.34-rc3/net/irda/irttp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/irda/irttp.c	2010-04-13 02:19:02.228883400 +0000
@@ -28,6 +28,7 @@
 #include <linux/init.h>
 #include <linux/fs.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <asm/byteorder.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/net/key/af_key.c linux-2.6.34-rc4/net/key/af_key.c
--- linux-2.6.34-rc3/net/key/af_key.c	2010-04-13 02:18:56.732633038 +0000
+++ linux-2.6.34-rc4/net/key/af_key.c	2010-04-13 02:19:02.229884137 +0000
@@ -26,6 +26,7 @@
 #include <linux/in6.h>
 #include <linux/proc_fs.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/netns/generic.h>
 #include <net/xfrm.h>
diff -urN linux-2.6.34-rc3/net/lapb/lapb_iface.c linux-2.6.34-rc4/net/lapb/lapb_iface.c
--- linux-2.6.34-rc3/net/lapb/lapb_iface.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/lapb/lapb_iface.c	2010-04-13 02:19:02.229884137 +0000
@@ -29,6 +29,7 @@
 #include <linux/inet.h>
 #include <linux/if_arp.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/lapb/lapb_in.c linux-2.6.34-rc4/net/lapb/lapb_in.c
--- linux-2.6.34-rc3/net/lapb/lapb_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/lapb/lapb_in.c	2010-04-13 02:19:02.229884137 +0000
@@ -27,6 +27,7 @@
 #include <linux/inet.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/lapb/lapb_out.c linux-2.6.34-rc4/net/lapb/lapb_out.c
--- linux-2.6.34-rc3/net/lapb/lapb_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/lapb/lapb_out.c	2010-04-13 02:19:02.229884137 +0000
@@ -25,6 +25,7 @@
 #include <linux/net.h>
 #include <linux/inet.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/lapb/lapb_subr.c linux-2.6.34-rc4/net/lapb/lapb_subr.c
--- linux-2.6.34-rc3/net/lapb/lapb_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/lapb/lapb_subr.c	2010-04-13 02:19:02.229884137 +0000
@@ -24,6 +24,7 @@
 #include <linux/net.h>
 #include <linux/inet.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <asm/uaccess.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/net/llc/af_llc.c linux-2.6.34-rc4/net/llc/af_llc.c
--- linux-2.6.34-rc3/net/llc/af_llc.c	2010-04-13 02:18:56.732633038 +0000
+++ linux-2.6.34-rc4/net/llc/af_llc.c	2010-04-13 02:19:02.229884137 +0000
@@ -25,6 +25,7 @@
 #include <linux/module.h>
 #include <linux/rtnetlink.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/llc.h>
 #include <net/llc_sap.h>
 #include <net/llc_pdu.h>
diff -urN linux-2.6.34-rc3/net/llc/llc_c_ac.c linux-2.6.34-rc4/net/llc/llc_c_ac.c
--- linux-2.6.34-rc3/net/llc/llc_c_ac.c	2010-04-13 02:18:56.732633038 +0000
+++ linux-2.6.34-rc4/net/llc/llc_c_ac.c	2010-04-13 02:19:02.230883749 +0000
@@ -18,6 +18,7 @@
  * See the GNU General Public License for more details.
  */
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/llc_conn.h>
 #include <net/llc_sap.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/llc/llc_conn.c linux-2.6.34-rc4/net/llc/llc_conn.c
--- linux-2.6.34-rc3/net/llc/llc_conn.c	2010-04-13 02:18:56.732633038 +0000
+++ linux-2.6.34-rc4/net/llc/llc_conn.c	2010-04-13 02:19:02.230883749 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/llc_sap.h>
 #include <net/llc_conn.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/llc/llc_if.c linux-2.6.34-rc4/net/llc/llc_if.c
--- linux-2.6.34-rc3/net/llc/llc_if.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/llc/llc_if.c	2010-04-13 02:19:02.230883749 +0000
@@ -11,6 +11,7 @@
  *
  * See the GNU General Public License for more details.
  */
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/llc/llc_input.c linux-2.6.34-rc4/net/llc/llc_input.c
--- linux-2.6.34-rc3/net/llc/llc_input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/llc/llc_input.c	2010-04-13 02:19:02.230883749 +0000
@@ -12,6 +12,7 @@
  * See the GNU General Public License for more details.
  */
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/llc.h>
 #include <net/llc_pdu.h>
diff -urN linux-2.6.34-rc3/net/llc/llc_sap.c linux-2.6.34-rc4/net/llc/llc_sap.c
--- linux-2.6.34-rc3/net/llc/llc_sap.c	2010-04-13 02:18:56.733633049 +0000
+++ linux-2.6.34-rc4/net/llc/llc_sap.c	2010-04-13 02:19:02.231884285 +0000
@@ -23,6 +23,7 @@
 #include <net/sock.h>
 #include <net/tcp_states.h>
 #include <linux/llc.h>
+#include <linux/slab.h>
 
 static int llc_mac_header_len(unsigned short devtype)
 {
diff -urN linux-2.6.34-rc3/net/llc/llc_station.c linux-2.6.34-rc4/net/llc/llc_station.c
--- linux-2.6.34-rc3/net/llc/llc_station.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/llc/llc_station.c	2010-04-13 02:19:02.231884285 +0000
@@ -13,6 +13,7 @@
  */
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <net/llc.h>
 #include <net/llc_sap.h>
 #include <net/llc_conn.h>
diff -urN linux-2.6.34-rc3/net/mac80211/agg-rx.c linux-2.6.34-rc4/net/mac80211/agg-rx.c
--- linux-2.6.34-rc3/net/mac80211/agg-rx.c	2010-04-13 02:18:56.733633049 +0000
+++ linux-2.6.34-rc4/net/mac80211/agg-rx.c	2010-04-13 02:19:02.231884285 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "ieee80211_i.h"
 #include "driver-ops.h"
diff -urN linux-2.6.34-rc3/net/mac80211/agg-tx.c linux-2.6.34-rc4/net/mac80211/agg-tx.c
--- linux-2.6.34-rc3/net/mac80211/agg-tx.c	2010-04-13 02:18:56.733633049 +0000
+++ linux-2.6.34-rc4/net/mac80211/agg-tx.c	2010-04-13 02:19:02.231884285 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "ieee80211_i.h"
 #include "driver-ops.h"
diff -urN linux-2.6.34-rc3/net/mac80211/cfg.c linux-2.6.34-rc4/net/mac80211/cfg.c
--- linux-2.6.34-rc3/net/mac80211/cfg.c	2010-04-13 02:18:56.734633060 +0000
+++ linux-2.6.34-rc4/net/mac80211/cfg.c	2010-04-13 02:19:02.232835145 +0000
@@ -9,6 +9,7 @@
 #include <linux/ieee80211.h>
 #include <linux/nl80211.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <linux/rcupdate.h>
 #include <net/cfg80211.h>
diff -urN linux-2.6.34-rc3/net/mac80211/debugfs_key.c linux-2.6.34-rc4/net/mac80211/debugfs_key.c
--- linux-2.6.34-rc3/net/mac80211/debugfs_key.c	2010-04-13 02:18:56.734633060 +0000
+++ linux-2.6.34-rc4/net/mac80211/debugfs_key.c	2010-04-13 02:19:02.232835145 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/kobject.h>
+#include <linux/slab.h>
 #include "ieee80211_i.h"
 #include "key.h"
 #include "debugfs.h"
diff -urN linux-2.6.34-rc3/net/mac80211/debugfs_netdev.c linux-2.6.34-rc4/net/mac80211/debugfs_netdev.c
--- linux-2.6.34-rc3/net/mac80211/debugfs_netdev.c	2010-04-13 02:18:56.734633060 +0000
+++ linux-2.6.34-rc4/net/mac80211/debugfs_netdev.c	2010-04-13 02:19:02.232835145 +0000
@@ -13,6 +13,7 @@
 #include <linux/interrupt.h>
 #include <linux/netdevice.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <linux/notifier.h>
 #include <net/mac80211.h>
 #include <net/cfg80211.h>
diff -urN linux-2.6.34-rc3/net/mac80211/ibss.c linux-2.6.34-rc4/net/mac80211/ibss.c
--- linux-2.6.34-rc3/net/mac80211/ibss.c	2010-04-13 02:18:56.736633064 +0000
+++ linux-2.6.34-rc4/net/mac80211/ibss.c	2010-04-13 02:19:02.234883520 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <linux/if_ether.h>
 #include <linux/skbuff.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/net/mac80211/iface.c linux-2.6.34-rc4/net/mac80211/iface.c
--- linux-2.6.34-rc3/net/mac80211/iface.c	2010-04-13 02:18:56.736633064 +0000
+++ linux-2.6.34-rc4/net/mac80211/iface.c	2010-04-13 02:19:02.234883520 +0000
@@ -10,6 +10,7 @@
  * it under the terms of the GNU General Public License version 2 as
  * published by the Free Software Foundation.
  */
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/if_arp.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/mac80211/key.c linux-2.6.34-rc4/net/mac80211/key.c
--- linux-2.6.34-rc3/net/mac80211/key.c	2010-04-13 02:18:56.737633078 +0000
+++ linux-2.6.34-rc4/net/mac80211/key.c	2010-04-13 02:19:02.235795135 +0000
@@ -14,6 +14,7 @@
 #include <linux/list.h>
 #include <linux/rcupdate.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "ieee80211_i.h"
 #include "driver-ops.h"
diff -urN linux-2.6.34-rc3/net/mac80211/led.c linux-2.6.34-rc4/net/mac80211/led.c
--- linux-2.6.34-rc3/net/mac80211/led.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/mac80211/led.c	2010-04-13 02:19:02.235795135 +0000
@@ -8,6 +8,7 @@
 
 /* just for IFNAMSIZ */
 #include <linux/if.h>
+#include <linux/slab.h>
 #include "led.h"
 
 void ieee80211_led_rx(struct ieee80211_local *local)
diff -urN linux-2.6.34-rc3/net/mac80211/mesh.c linux-2.6.34-rc4/net/mac80211/mesh.c
--- linux-2.6.34-rc3/net/mac80211/mesh.c	2010-04-13 02:18:56.737633078 +0000
+++ linux-2.6.34-rc4/net/mac80211/mesh.c	2010-04-13 02:19:02.235795135 +0000
@@ -8,6 +8,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include "ieee80211_i.h"
 #include "mesh.h"
diff -urN linux-2.6.34-rc3/net/mac80211/mesh_hwmp.c linux-2.6.34-rc4/net/mac80211/mesh_hwmp.c
--- linux-2.6.34-rc3/net/mac80211/mesh_hwmp.c	2010-04-13 02:18:56.737633078 +0000
+++ linux-2.6.34-rc4/net/mac80211/mesh_hwmp.c	2010-04-13 02:19:02.235795135 +0000
@@ -7,6 +7,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include "mesh.h"
 
 #ifdef CONFIG_MAC80211_VERBOSE_MHWMP_DEBUG
@@ -391,7 +392,7 @@
 				if (SN_GT(mpath->sn, orig_sn) ||
 				    (mpath->sn == orig_sn &&
 				     action == MPATH_PREQ &&
-				     new_metric > mpath->metric)) {
+				     new_metric >= mpath->metric)) {
 					process = false;
 					fresh_info = false;
 				}
@@ -611,7 +612,7 @@
 
 	mesh_path_sel_frame_tx(MPATH_PREP, flags, orig_addr,
 		cpu_to_le32(orig_sn), 0, target_addr,
-		cpu_to_le32(target_sn), mpath->next_hop->sta.addr, hopcount,
+		cpu_to_le32(target_sn), next_hop, hopcount,
 		ttl, cpu_to_le32(lifetime), cpu_to_le32(metric),
 		0, sdata);
 	rcu_read_unlock();
diff -urN linux-2.6.34-rc3/net/mac80211/mesh_pathtbl.c linux-2.6.34-rc4/net/mac80211/mesh_pathtbl.c
--- linux-2.6.34-rc3/net/mac80211/mesh_pathtbl.c	2010-04-13 02:18:56.737633078 +0000
+++ linux-2.6.34-rc4/net/mac80211/mesh_pathtbl.c	2010-04-13 02:19:02.236883671 +0000
@@ -10,6 +10,7 @@
 #include <linux/etherdevice.h>
 #include <linux/list.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/net/mac80211/mesh_plink.c linux-2.6.34-rc4/net/mac80211/mesh_plink.c
--- linux-2.6.34-rc3/net/mac80211/mesh_plink.c	2010-04-13 02:18:56.738633065 +0000
+++ linux-2.6.34-rc4/net/mac80211/mesh_plink.c	2010-04-13 02:19:02.236883671 +0000
@@ -6,6 +6,7 @@
  * it under the terms of the GNU General Public License version 2 as
  * published by the Free Software Foundation.
  */
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/random.h>
 #include "ieee80211_i.h"
diff -urN linux-2.6.34-rc3/net/mac80211/mlme.c linux-2.6.34-rc4/net/mac80211/mlme.c
--- linux-2.6.34-rc3/net/mac80211/mlme.c	2010-04-13 02:18:56.739571658 +0000
+++ linux-2.6.34-rc4/net/mac80211/mlme.c	2010-04-13 02:19:02.237883556 +0000
@@ -19,6 +19,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/pm_qos_params.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/net/mac80211/rate.c linux-2.6.34-rc4/net/mac80211/rate.c
--- linux-2.6.34-rc3/net/mac80211/rate.c	2010-04-13 02:18:56.739571658 +0000
+++ linux-2.6.34-rc4/net/mac80211/rate.c	2010-04-13 02:19:02.237883556 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/kernel.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include "rate.h"
 #include "ieee80211_i.h"
 #include "debugfs.h"
diff -urN linux-2.6.34-rc3/net/mac80211/rc80211_minstrel.c linux-2.6.34-rc4/net/mac80211/rc80211_minstrel.c
--- linux-2.6.34-rc3/net/mac80211/rc80211_minstrel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/mac80211/rc80211_minstrel.c	2010-04-13 02:19:02.238883141 +0000
@@ -50,6 +50,7 @@
 #include <linux/debugfs.h>
 #include <linux/random.h>
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "rate.h"
 #include "rc80211_minstrel.h"
diff -urN linux-2.6.34-rc3/net/mac80211/rc80211_minstrel_debugfs.c linux-2.6.34-rc4/net/mac80211/rc80211_minstrel_debugfs.c
--- linux-2.6.34-rc3/net/mac80211/rc80211_minstrel_debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/mac80211/rc80211_minstrel_debugfs.c	2010-04-13 02:19:02.238883141 +0000
@@ -49,6 +49,7 @@
 #include <linux/skbuff.h>
 #include <linux/debugfs.h>
 #include <linux/ieee80211.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "rc80211_minstrel.h"
 
diff -urN linux-2.6.34-rc3/net/mac80211/rc80211_pid_algo.c linux-2.6.34-rc4/net/mac80211/rc80211_pid_algo.c
--- linux-2.6.34-rc3/net/mac80211/rc80211_pid_algo.c	2010-04-13 02:18:56.740570472 +0000
+++ linux-2.6.34-rc4/net/mac80211/rc80211_pid_algo.c	2010-04-13 02:19:02.238883141 +0000
@@ -13,6 +13,7 @@
 #include <linux/types.h>
 #include <linux/skbuff.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include "rate.h"
 #include "mesh.h"
diff -urN linux-2.6.34-rc3/net/mac80211/rc80211_pid_debugfs.c linux-2.6.34-rc4/net/mac80211/rc80211_pid_debugfs.c
--- linux-2.6.34-rc3/net/mac80211/rc80211_pid_debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/mac80211/rc80211_pid_debugfs.c	2010-04-13 02:19:02.238883141 +0000
@@ -12,6 +12,7 @@
 #include <linux/netdevice.h>
 #include <linux/types.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 
 #include <net/mac80211.h>
 #include "rate.h"
diff -urN linux-2.6.34-rc3/net/mac80211/rx.c linux-2.6.34-rc4/net/mac80211/rx.c
--- linux-2.6.34-rc3/net/mac80211/rx.c	2010-04-13 02:18:56.740570472 +0000
+++ linux-2.6.34-rc4/net/mac80211/rx.c	2010-04-13 02:19:02.239883080 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/jiffies.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/mac80211/scan.c linux-2.6.34-rc4/net/mac80211/scan.c
--- linux-2.6.34-rc3/net/mac80211/scan.c	2010-04-13 02:18:56.741633062 +0000
+++ linux-2.6.34-rc4/net/mac80211/scan.c	2010-04-13 02:19:02.239883080 +0000
@@ -14,6 +14,7 @@
 
 #include <linux/if_arp.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 
 #include "ieee80211_i.h"
diff -urN linux-2.6.34-rc3/net/mac80211/tx.c linux-2.6.34-rc4/net/mac80211/tx.c
--- linux-2.6.34-rc3/net/mac80211/tx.c	2010-04-13 02:18:56.743633025 +0000
+++ linux-2.6.34-rc4/net/mac80211/tx.c	2010-04-13 02:19:02.241883795 +0000
@@ -1991,6 +1991,7 @@
 void ieee80211_tx_pending(unsigned long data)
 {
 	struct ieee80211_local *local = (struct ieee80211_local *)data;
+	struct ieee80211_sub_if_data *sdata;
 	unsigned long flags;
 	int i;
 	bool txok;
@@ -2029,6 +2030,11 @@
 			if (!txok)
 				break;
 		}
+
+		if (skb_queue_empty(&local->pending[i]))
+			list_for_each_entry_rcu(sdata, &local->interfaces, list)
+				netif_tx_wake_queue(
+					netdev_get_tx_queue(sdata->dev, i));
 	}
 	spin_unlock_irqrestore(&local->queue_stop_reason_lock, flags);
 
diff -urN linux-2.6.34-rc3/net/mac80211/util.c linux-2.6.34-rc4/net/mac80211/util.c
--- linux-2.6.34-rc3/net/mac80211/util.c	2010-04-13 02:18:56.743633025 +0000
+++ linux-2.6.34-rc4/net/mac80211/util.c	2010-04-13 02:19:02.242883563 +0000
@@ -279,13 +279,13 @@
 		/* someone still has this queue stopped */
 		return;
 
-	if (!skb_queue_empty(&local->pending[queue]))
+	if (skb_queue_empty(&local->pending[queue])) {
+		rcu_read_lock();
+		list_for_each_entry_rcu(sdata, &local->interfaces, list)
+			netif_tx_wake_queue(netdev_get_tx_queue(sdata->dev, queue));
+		rcu_read_unlock();
+	} else
 		tasklet_schedule(&local->tx_pending_tasklet);
-
-	rcu_read_lock();
-	list_for_each_entry_rcu(sdata, &local->interfaces, list)
-		netif_tx_wake_queue(netdev_get_tx_queue(sdata->dev, queue));
-	rcu_read_unlock();
 }
 
 void ieee80211_wake_queue_by_reason(struct ieee80211_hw *hw, int queue,
@@ -1097,9 +1097,9 @@
 		 */
 		res = drv_start(local);
 		if (res) {
-			WARN(local->suspended, "Harware became unavailable "
-			     "upon resume. This is could be a software issue"
-			     "prior to suspend or a hardware issue\n");
+			WARN(local->suspended, "Hardware became unavailable "
+			     "upon resume. This could be a software issue "
+			     "prior to suspend or a hardware issue.\n");
 			return res;
 		}
 
diff -urN linux-2.6.34-rc3/net/mac80211/wep.c linux-2.6.34-rc4/net/mac80211/wep.c
--- linux-2.6.34-rc3/net/mac80211/wep.c	2010-04-13 02:18:56.743633025 +0000
+++ linux-2.6.34-rc4/net/mac80211/wep.c	2010-04-13 02:19:02.242883563 +0000
@@ -17,6 +17,7 @@
 #include <linux/err.h>
 #include <linux/mm.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 
 #include <net/mac80211.h>
diff -urN linux-2.6.34-rc3/net/mac80211/work.c linux-2.6.34-rc4/net/mac80211/work.c
--- linux-2.6.34-rc3/net/mac80211/work.c	2010-04-13 02:18:56.744633087 +0000
+++ linux-2.6.34-rc4/net/mac80211/work.c	2010-04-13 02:19:02.243883628 +0000
@@ -19,6 +19,7 @@
 #include <linux/if_arp.h>
 #include <linux/etherdevice.h>
 #include <linux/crc32.h>
+#include <linux/slab.h>
 #include <net/mac80211.h>
 #include <asm/unaligned.h>
 
diff -urN linux-2.6.34-rc3/net/mac80211/wpa.c linux-2.6.34-rc4/net/mac80211/wpa.c
--- linux-2.6.34-rc3/net/mac80211/wpa.c	2010-04-13 02:18:56.744633087 +0000
+++ linux-2.6.34-rc4/net/mac80211/wpa.c	2010-04-13 02:19:02.243883628 +0000
@@ -9,10 +9,10 @@
 
 #include <linux/netdevice.h>
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/compiler.h>
 #include <linux/ieee80211.h>
+#include <linux/gfp.h>
 #include <asm/unaligned.h>
 #include <net/mac80211.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/core.c linux-2.6.34-rc4/net/netfilter/core.c
--- linux-2.6.34-rc3/net/netfilter/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/core.c	2010-04-13 02:19:02.243883628 +0000
@@ -19,6 +19,7 @@
 #include <linux/inetdevice.h>
 #include <linux/proc_fs.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_app.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_app.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_app.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_app.c	2010-04-13 02:19:02.243883628 +0000
@@ -27,6 +27,7 @@
 #include <linux/in.h>
 #include <linux/ip.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/protocol.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_conn.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_conn.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_conn.c	2010-04-13 02:18:56.745633062 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_conn.c	2010-04-13 02:19:02.244883490 +0000
@@ -32,6 +32,7 @@
 #include <linux/module.h>
 #include <linux/vmalloc.h>
 #include <linux/proc_fs.h>		/* for proc_net_* */
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 #include <linux/jhash.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_core.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_core.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_core.c	2010-04-13 02:18:56.745633062 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_core.c	2010-04-13 02:19:02.244883490 +0000
@@ -33,6 +33,7 @@
 #include <linux/tcp.h>
 #include <linux/sctp.h>
 #include <linux/icmp.h>
+#include <linux/slab.h>
 
 #include <net/ip.h>
 #include <net/tcp.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_ctl.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_ctl.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_ctl.c	2010-04-13 02:18:56.745633062 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_ctl.c	2010-04-13 02:19:02.245883612 +0000
@@ -31,6 +31,7 @@
 #include <linux/workqueue.h>
 #include <linux/swap.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv4.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_dh.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_dh.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_dh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_dh.c	2010-04-13 02:19:02.245883612 +0000
@@ -39,6 +39,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_est.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_est.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_est.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_est.c	2010-04-13 02:19:02.245883612 +0000
@@ -17,7 +17,6 @@
 
 #include <linux/kernel.h>
 #include <linux/jiffies.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/interrupt.h>
 #include <linux/sysctl.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_ftp.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_ftp.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_ftp.c	2010-04-13 02:18:56.746633040 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_ftp.c	2010-04-13 02:19:02.245883612 +0000
@@ -32,6 +32,7 @@
 #include <linux/in.h>
 #include <linux/ip.h>
 #include <linux/netfilter.h>
+#include <linux/gfp.h>
 #include <net/protocol.h>
 #include <net/tcp.h>
 #include <asm/unaligned.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_lblc.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_lblc.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_lblc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_lblc.c	2010-04-13 02:19:02.245883612 +0000
@@ -43,6 +43,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_lblcr.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_lblcr.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_lblcr.c	2010-04-13 02:18:56.746633040 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_lblcr.c	2010-04-13 02:19:02.245883612 +0000
@@ -46,6 +46,7 @@
 #include <linux/skbuff.h>
 #include <linux/jiffies.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 
 /* for sysctl */
 #include <linux/fs.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_proto.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_proto.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_proto.c	2010-04-13 02:18:56.746633040 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_proto.c	2010-04-13 02:19:02.245883612 +0000
@@ -19,6 +19,7 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
+#include <linux/gfp.h>
 #include <linux/in.h>
 #include <linux/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_sh.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_sh.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_sh.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_sh.c	2010-04-13 02:19:02.246883743 +0000
@@ -36,6 +36,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_wrr.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_wrr.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_wrr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_wrr.c	2010-04-13 02:19:02.246883743 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/net.h>
 #include <linux/gcd.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_xmit.c linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_xmit.c
--- linux-2.6.34-rc3/net/netfilter/ipvs/ip_vs_xmit.c	2010-04-13 02:18:56.747633105 +0000
+++ linux-2.6.34-rc4/net/netfilter/ipvs/ip_vs_xmit.c	2010-04-13 02:19:02.247883571 +0000
@@ -17,6 +17,7 @@
 #define pr_fmt(fmt) KMSG_COMPONENT ": " fmt
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/tcp.h>                  /* for tcphdr */
 #include <net/ip.h>
 #include <net/tcp.h>                    /* for csum_tcpudp_magic */
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_acct.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_acct.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_acct.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_acct.c	2010-04-13 02:19:02.247883571 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/moduleparam.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_amanda.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_amanda.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_amanda.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_amanda.c	2010-04-13 02:19:02.247883571 +0000
@@ -16,6 +16,7 @@
 #include <linux/in.h>
 #include <linux/udp.h>
 #include <linux/netfilter.h>
+#include <linux/gfp.h>
 
 #include <net/netfilter/nf_conntrack.h>
 #include <net/netfilter/nf_conntrack_expect.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_ecache.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_ecache.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_ecache.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_ecache.c	2010-04-13 02:19:02.247883571 +0000
@@ -18,6 +18,7 @@
 #include <linux/percpu.h>
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 
 #include <net/netfilter/nf_conntrack.h>
 #include <net/netfilter/nf_conntrack_core.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_ftp.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_ftp.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_ftp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_ftp.c	2010-04-13 02:19:02.248883555 +0000
@@ -13,6 +13,7 @@
 #include <linux/moduleparam.h>
 #include <linux/netfilter.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <linux/ipv6.h>
 #include <linux/ctype.h>
 #include <linux/inet.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_h323_main.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_h323_main.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_h323_main.c	2010-04-13 02:18:56.748633059 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_h323_main.c	2010-04-13 02:19:02.248883555 +0000
@@ -17,6 +17,7 @@
 #include <linux/inet.h>
 #include <linux/in.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <linux/udp.h>
 #include <linux/tcp.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_helper.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_helper.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_helper.c	2010-04-13 02:18:56.748633059 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_helper.c	2010-04-13 02:19:02.248883555 +0000
@@ -15,7 +15,6 @@
 #include <linux/skbuff.h>
 #include <linux/vmalloc.h>
 #include <linux/stddef.h>
-#include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/err.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_irc.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_irc.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_irc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_irc.c	2010-04-13 02:19:02.248883555 +0000
@@ -15,6 +15,7 @@
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 
 #include <net/netfilter/nf_conntrack.h>
 #include <net/netfilter/nf_conntrack_expect.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_netlink.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_netlink.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_netlink.c	2010-04-13 02:18:56.749571817 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_netlink.c	2010-04-13 02:19:02.249883305 +0000
@@ -27,6 +27,7 @@
 #include <linux/netlink.h>
 #include <linux/spinlock.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter.h>
 #include <net/netlink.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto.c	2010-04-13 02:19:02.249883305 +0000
@@ -12,6 +12,7 @@
 #include <linux/types.h>
 #include <linux/netfilter.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/skbuff.h>
 #include <linux/vmalloc.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto_dccp.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto_dccp.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto_dccp.c	2010-04-13 02:18:56.749571817 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto_dccp.c	2010-04-13 02:19:02.249883305 +0000
@@ -15,6 +15,7 @@
 #include <linux/spinlock.h>
 #include <linux/skbuff.h>
 #include <linux/dccp.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/netns/generic.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto_gre.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto_gre.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_proto_gre.c	2010-04-13 02:18:56.749571817 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_proto_gre.c	2010-04-13 02:19:02.250884060 +0000
@@ -31,6 +31,7 @@
 #include <linux/in.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/dst.h>
 #include <net/net_namespace.h>
 #include <net/netns/generic.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_sane.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_sane.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_sane.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_sane.c	2010-04-13 02:19:02.250884060 +0000
@@ -20,6 +20,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <linux/tcp.h>
 #include <net/netfilter/nf_conntrack.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_conntrack_standalone.c linux-2.6.34-rc4/net/netfilter/nf_conntrack_standalone.c
--- linux-2.6.34-rc3/net/netfilter/nf_conntrack_standalone.c	2010-04-13 02:18:56.751570549 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_conntrack_standalone.c	2010-04-13 02:19:02.251883759 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/types.h>
 #include <linux/netfilter.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nf_queue.c linux-2.6.34-rc4/net/netfilter/nf_queue.c
--- linux-2.6.34-rc3/net/netfilter/nf_queue.c	2010-04-13 02:18:56.751570549 +0000
+++ linux-2.6.34-rc4/net/netfilter/nf_queue.c	2010-04-13 02:19:02.251883759 +0000
@@ -1,4 +1,5 @@
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nfnetlink_log.c linux-2.6.34-rc4/net/netfilter/nfnetlink_log.c
--- linux-2.6.34-rc3/net/netfilter/nfnetlink_log.c	2010-04-13 02:18:56.751570549 +0000
+++ linux-2.6.34-rc4/net/netfilter/nfnetlink_log.c	2010-04-13 02:19:02.252884088 +0000
@@ -28,6 +28,7 @@
 #include <linux/list.h>
 #include <linux/jhash.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/netfilter/nf_log.h>
 #include <net/netfilter/nfnetlink_log.h>
diff -urN linux-2.6.34-rc3/net/netfilter/nfnetlink_queue.c linux-2.6.34-rc4/net/netfilter/nfnetlink_queue.c
--- linux-2.6.34-rc3/net/netfilter/nfnetlink_queue.c	2010-04-13 02:18:56.751570549 +0000
+++ linux-2.6.34-rc4/net/netfilter/nfnetlink_queue.c	2010-04-13 02:19:02.252884088 +0000
@@ -18,6 +18,7 @@
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/notifier.h>
 #include <linux/netdevice.h>
 #include <linux/netfilter.h>
diff -urN linux-2.6.34-rc3/net/netfilter/x_tables.c linux-2.6.34-rc4/net/netfilter/x_tables.c
--- linux-2.6.34-rc3/net/netfilter/x_tables.c	2010-04-13 02:18:56.752633064 +0000
+++ linux-2.6.34-rc4/net/netfilter/x_tables.c	2010-04-13 02:19:02.252884088 +0000
@@ -22,6 +22,7 @@
 #include <linux/vmalloc.h>
 #include <linux/mutex.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 
 #include <linux/netfilter/x_tables.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_CT.c linux-2.6.34-rc4/net/netfilter/xt_CT.c
--- linux-2.6.34-rc3/net/netfilter/xt_CT.c	2010-04-13 02:18:56.752633064 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_CT.c	2010-04-13 02:19:02.252884088 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/skbuff.h>
 #include <linux/selinux.h>
 #include <linux/netfilter_ipv4/ip_tables.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_LED.c linux-2.6.34-rc4/net/netfilter/xt_LED.c
--- linux-2.6.34-rc3/net/netfilter/xt_LED.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_LED.c	2010-04-13 02:19:02.252884088 +0000
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/netfilter/x_tables.h>
+#include <linux/slab.h>
 #include <linux/leds.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/xt_RATEEST.c linux-2.6.34-rc4/net/netfilter/xt_RATEEST.c
--- linux-2.6.34-rc3/net/netfilter/xt_RATEEST.c	2010-04-13 02:18:56.752633064 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_RATEEST.c	2010-04-13 02:19:02.252884088 +0000
@@ -11,6 +11,7 @@
 #include <linux/jhash.h>
 #include <linux/rtnetlink.h>
 #include <linux/random.h>
+#include <linux/slab.h>
 #include <net/gen_stats.h>
 #include <net/netlink.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/xt_TCPMSS.c linux-2.6.34-rc4/net/netfilter/xt_TCPMSS.c
--- linux-2.6.34-rc3/net/netfilter/xt_TCPMSS.c	2010-04-13 02:18:56.752633064 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_TCPMSS.c	2010-04-13 02:19:02.253883520 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/ip.h>
+#include <linux/gfp.h>
 #include <linux/ipv6.h>
 #include <linux/tcp.h>
 #include <net/dst.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_connlimit.c linux-2.6.34-rc4/net/netfilter/xt_connlimit.c
--- linux-2.6.34-rc3/net/netfilter/xt_connlimit.c	2010-04-13 02:18:56.752633064 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_connlimit.c	2010-04-13 02:19:02.253883520 +0000
@@ -17,6 +17,7 @@
 #include <linux/ip.h>
 #include <linux/ipv6.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_dccp.c linux-2.6.34-rc4/net/netfilter/xt_dccp.c
--- linux-2.6.34-rc3/net/netfilter/xt_dccp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_dccp.c	2010-04-13 02:19:02.253883520 +0000
@@ -10,6 +10,7 @@
 
 #include <linux/module.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <net/ip.h>
 #include <linux/dccp.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_limit.c linux-2.6.34-rc4/net/netfilter/xt_limit.c
--- linux-2.6.34-rc3/net/netfilter/xt_limit.c	2010-04-13 02:18:56.753633069 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_limit.c	2010-04-13 02:19:02.253883520 +0000
@@ -6,6 +6,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_quota.c linux-2.6.34-rc4/net/netfilter/xt_quota.c
--- linux-2.6.34-rc3/net/netfilter/xt_quota.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_quota.c	2010-04-13 02:19:02.254883159 +0000
@@ -4,6 +4,7 @@
  * Sam Johnston <samj@samj.net>
  */
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 
 #include <linux/netfilter/x_tables.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_recent.c linux-2.6.34-rc4/net/netfilter/xt_recent.c
--- linux-2.6.34-rc3/net/netfilter/xt_recent.c	2010-04-13 02:18:56.753633069 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_recent.c	2010-04-13 02:19:02.254883159 +0000
@@ -27,6 +27,7 @@
 #include <linux/bitops.h>
 #include <linux/skbuff.h>
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/netns/generic.h>
 
diff -urN linux-2.6.34-rc3/net/netfilter/xt_statistic.c linux-2.6.34-rc4/net/netfilter/xt_statistic.c
--- linux-2.6.34-rc3/net/netfilter/xt_statistic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_statistic.c	2010-04-13 02:19:02.254883159 +0000
@@ -12,6 +12,7 @@
 #include <linux/spinlock.h>
 #include <linux/skbuff.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 
 #include <linux/netfilter/xt_statistic.h>
 #include <linux/netfilter/x_tables.h>
diff -urN linux-2.6.34-rc3/net/netfilter/xt_string.c linux-2.6.34-rc4/net/netfilter/xt_string.c
--- linux-2.6.34-rc3/net/netfilter/xt_string.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netfilter/xt_string.c	2010-04-13 02:19:02.254883159 +0000
@@ -7,6 +7,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_cipso_v4.c linux-2.6.34-rc4/net/netlabel/netlabel_cipso_v4.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_cipso_v4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_cipso_v4.c	2010-04-13 02:19:02.254883159 +0000
@@ -33,6 +33,7 @@
 #include <linux/string.h>
 #include <linux/skbuff.h>
 #include <linux/audit.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_domainhash.c linux-2.6.34-rc4/net/netlabel/netlabel_domainhash.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_domainhash.c	2010-04-13 02:18:56.753633069 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_domainhash.c	2010-04-13 02:19:02.254883159 +0000
@@ -35,6 +35,7 @@
 #include <linux/spinlock.h>
 #include <linux/string.h>
 #include <linux/audit.h>
+#include <linux/slab.h>
 #include <net/netlabel.h>
 #include <net/cipso_ipv4.h>
 #include <asm/bug.h>
@@ -50,9 +51,12 @@
 };
 
 /* Domain hash table */
-/* XXX - updates should be so rare that having one spinlock for the entire
- * hash table should be okay */
+/* updates should be so rare that having one spinlock for the entire hash table
+ * should be okay */
 static DEFINE_SPINLOCK(netlbl_domhsh_lock);
+#define netlbl_domhsh_rcu_deref(p) \
+	rcu_dereference_check(p, rcu_read_lock_held() || \
+				 lockdep_is_held(&netlbl_domhsh_lock))
 static struct netlbl_domhsh_tbl *netlbl_domhsh = NULL;
 static struct netlbl_dom_map *netlbl_domhsh_def = NULL;
 
@@ -106,7 +110,8 @@
  * Description:
  * This is the hashing function for the domain hash table, it returns the
  * correct bucket number for the domain.  The caller is responsibile for
- * calling the rcu_read_[un]lock() functions.
+ * ensuring that the hash table is protected with either a RCU read lock or the
+ * hash table lock.
  *
  */
 static u32 netlbl_domhsh_hash(const char *key)
@@ -120,7 +125,7 @@
 
 	for (iter = 0, val = 0, len = strlen(key); iter < len; iter++)
 		val = (val << 4 | (val >> (8 * sizeof(u32) - 4))) ^ key[iter];
-	return val & (rcu_dereference(netlbl_domhsh)->size - 1);
+	return val & (netlbl_domhsh_rcu_deref(netlbl_domhsh)->size - 1);
 }
 
 /**
@@ -130,7 +135,8 @@
  * Description:
  * Searches the domain hash table and returns a pointer to the hash table
  * entry if found, otherwise NULL is returned.  The caller is responsibile for
- * the rcu hash table locks (i.e. the caller much call rcu_read_[un]lock()).
+ * ensuring that the hash table is protected with either a RCU read lock or the
+ * hash table lock.
  *
  */
 static struct netlbl_dom_map *netlbl_domhsh_search(const char *domain)
@@ -141,7 +147,7 @@
 
 	if (domain != NULL) {
 		bkt = netlbl_domhsh_hash(domain);
-		bkt_list = &rcu_dereference(netlbl_domhsh)->tbl[bkt];
+		bkt_list = &netlbl_domhsh_rcu_deref(netlbl_domhsh)->tbl[bkt];
 		list_for_each_entry_rcu(iter, bkt_list, list)
 			if (iter->valid && strcmp(iter->domain, domain) == 0)
 				return iter;
@@ -159,8 +165,8 @@
  * Searches the domain hash table and returns a pointer to the hash table
  * entry if an exact match is found, if an exact match is not present in the
  * hash table then the default entry is returned if valid otherwise NULL is
- * returned.  The caller is responsibile for the rcu hash table locks
- * (i.e. the caller much call rcu_read_[un]lock()).
+ * returned.  The caller is responsibile ensuring that the hash table is
+ * protected with either a RCU read lock or the hash table lock.
  *
  */
 static struct netlbl_dom_map *netlbl_domhsh_search_def(const char *domain)
@@ -169,7 +175,7 @@
 
 	entry = netlbl_domhsh_search(domain);
 	if (entry == NULL) {
-		entry = rcu_dereference(netlbl_domhsh_def);
+		entry = netlbl_domhsh_rcu_deref(netlbl_domhsh_def);
 		if (entry != NULL && !entry->valid)
 			entry = NULL;
 	}
@@ -306,8 +312,11 @@
 	struct netlbl_af6list *tmp6;
 #endif /* IPv6 */
 
+	/* XXX - we can remove this RCU read lock as the spinlock protects the
+	 *       entire function, but before we do we need to fixup the
+	 *       netlbl_af[4,6]list RCU functions to do "the right thing" with
+	 *       respect to rcu_dereference() when only a spinlock is held. */
 	rcu_read_lock();
-
 	spin_lock(&netlbl_domhsh_lock);
 	if (entry->domain != NULL)
 		entry_old = netlbl_domhsh_search(entry->domain);
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_kapi.c linux-2.6.34-rc4/net/netlabel/netlabel_kapi.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_kapi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_kapi.c	2010-04-13 02:19:02.255883431 +0000
@@ -30,6 +30,7 @@
 
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/audit.h>
 #include <linux/in.h>
 #include <linux/in6.h>
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_mgmt.c linux-2.6.34-rc4/net/netlabel/netlabel_mgmt.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_mgmt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_mgmt.c	2010-04-13 02:19:02.255883431 +0000
@@ -34,6 +34,7 @@
 #include <linux/skbuff.h>
 #include <linux/in.h>
 #include <linux/in6.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_unlabeled.c linux-2.6.34-rc4/net/netlabel/netlabel_unlabeled.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_unlabeled.c	2010-04-13 02:18:56.754633092 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_unlabeled.c	2010-04-13 02:19:02.255883431 +0000
@@ -43,6 +43,7 @@
 #include <linux/notifier.h>
 #include <linux/netdevice.h>
 #include <linux/security.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
@@ -114,6 +115,9 @@
 /* updates should be so rare that having one spinlock for the entire
  * hash table should be okay */
 static DEFINE_SPINLOCK(netlbl_unlhsh_lock);
+#define netlbl_unlhsh_rcu_deref(p) \
+	rcu_dereference_check(p, rcu_read_lock_held() || \
+				 lockdep_is_held(&netlbl_unlhsh_lock))
 static struct netlbl_unlhsh_tbl *netlbl_unlhsh = NULL;
 static struct netlbl_unlhsh_iface *netlbl_unlhsh_def = NULL;
 
@@ -235,15 +239,13 @@
  * Description:
  * This is the hashing function for the unlabeled hash table, it returns the
  * bucket number for the given device/interface.  The caller is responsible for
- * calling the rcu_read_[un]lock() functions.
+ * ensuring that the hash table is protected with either a RCU read lock or
+ * the hash table lock.
  *
  */
 static u32 netlbl_unlhsh_hash(int ifindex)
 {
-	/* this is taken _almost_ directly from
-	 * security/selinux/netif.c:sel_netif_hasfn() as they do pretty much
-	 * the same thing */
-	return ifindex & (rcu_dereference(netlbl_unlhsh)->size - 1);
+	return ifindex & (netlbl_unlhsh_rcu_deref(netlbl_unlhsh)->size - 1);
 }
 
 /**
@@ -253,7 +255,8 @@
  * Description:
  * Searches the unlabeled connection hash table and returns a pointer to the
  * interface entry which matches @ifindex, otherwise NULL is returned.  The
- * caller is responsible for calling the rcu_read_[un]lock() functions.
+ * caller is responsible for ensuring that the hash table is protected with
+ * either a RCU read lock or the hash table lock.
  *
  */
 static struct netlbl_unlhsh_iface *netlbl_unlhsh_search_iface(int ifindex)
@@ -263,7 +266,7 @@
 	struct netlbl_unlhsh_iface *iter;
 
 	bkt = netlbl_unlhsh_hash(ifindex);
-	bkt_list = &rcu_dereference(netlbl_unlhsh)->tbl[bkt];
+	bkt_list = &netlbl_unlhsh_rcu_deref(netlbl_unlhsh)->tbl[bkt];
 	list_for_each_entry_rcu(iter, bkt_list, list)
 		if (iter->valid && iter->ifindex == ifindex)
 			return iter;
@@ -272,33 +275,6 @@
 }
 
 /**
- * netlbl_unlhsh_search_iface_def - Search for a matching interface entry
- * @ifindex: the network interface
- *
- * Description:
- * Searches the unlabeled connection hash table and returns a pointer to the
- * interface entry which matches @ifindex.  If an exact match can not be found
- * and there is a valid default entry, the default entry is returned, otherwise
- * NULL is returned.  The caller is responsible for calling the
- * rcu_read_[un]lock() functions.
- *
- */
-static struct netlbl_unlhsh_iface *netlbl_unlhsh_search_iface_def(int ifindex)
-{
-	struct netlbl_unlhsh_iface *entry;
-
-	entry = netlbl_unlhsh_search_iface(ifindex);
-	if (entry != NULL)
-		return entry;
-
-	entry = rcu_dereference(netlbl_unlhsh_def);
-	if (entry != NULL && entry->valid)
-		return entry;
-
-	return NULL;
-}
-
-/**
  * netlbl_unlhsh_add_addr4 - Add a new IPv4 address entry to the hash table
  * @iface: the associated interface entry
  * @addr: IPv4 address in network byte order
@@ -308,8 +284,7 @@
  * Description:
  * Add a new address entry into the unlabeled connection hash table using the
  * interface entry specified by @iface.  On success zero is returned, otherwise
- * a negative value is returned.  The caller is responsible for calling the
- * rcu_read_[un]lock() functions.
+ * a negative value is returned.
  *
  */
 static int netlbl_unlhsh_add_addr4(struct netlbl_unlhsh_iface *iface,
@@ -349,8 +324,7 @@
  * Description:
  * Add a new address entry into the unlabeled connection hash table using the
  * interface entry specified by @iface.  On success zero is returned, otherwise
- * a negative value is returned.  The caller is responsible for calling the
- * rcu_read_[un]lock() functions.
+ * a negative value is returned.
  *
  */
 static int netlbl_unlhsh_add_addr6(struct netlbl_unlhsh_iface *iface,
@@ -391,8 +365,7 @@
  * Description:
  * Add a new, empty, interface entry into the unlabeled connection hash table.
  * On success a pointer to the new interface entry is returned, on failure NULL
- * is returned.  The caller is responsible for calling the rcu_read_[un]lock()
- * functions.
+ * is returned.
  *
  */
 static struct netlbl_unlhsh_iface *netlbl_unlhsh_add_iface(int ifindex)
@@ -415,10 +388,10 @@
 		if (netlbl_unlhsh_search_iface(ifindex) != NULL)
 			goto add_iface_failure;
 		list_add_tail_rcu(&iface->list,
-				  &rcu_dereference(netlbl_unlhsh)->tbl[bkt]);
+			     &netlbl_unlhsh_rcu_deref(netlbl_unlhsh)->tbl[bkt]);
 	} else {
 		INIT_LIST_HEAD(&iface->list);
-		if (rcu_dereference(netlbl_unlhsh_def) != NULL)
+		if (netlbl_unlhsh_rcu_deref(netlbl_unlhsh_def) != NULL)
 			goto add_iface_failure;
 		rcu_assign_pointer(netlbl_unlhsh_def, iface);
 	}
@@ -548,8 +521,7 @@
  *
  * Description:
  * Remove an IP address entry from the unlabeled connection hash table.
- * Returns zero on success, negative values on failure.  The caller is
- * responsible for calling the rcu_read_[un]lock() functions.
+ * Returns zero on success, negative values on failure.
  *
  */
 static int netlbl_unlhsh_remove_addr4(struct net *net,
@@ -611,8 +583,7 @@
  *
  * Description:
  * Remove an IP address entry from the unlabeled connection hash table.
- * Returns zero on success, negative values on failure.  The caller is
- * responsible for calling the rcu_read_[un]lock() functions.
+ * Returns zero on success, negative values on failure.
  *
  */
 static int netlbl_unlhsh_remove_addr6(struct net *net,
@@ -1547,8 +1518,10 @@
 	struct netlbl_unlhsh_iface *iface;
 
 	rcu_read_lock();
-	iface = netlbl_unlhsh_search_iface_def(skb->skb_iif);
+	iface = netlbl_unlhsh_search_iface(skb->skb_iif);
 	if (iface == NULL)
+		iface = rcu_dereference(netlbl_unlhsh_def);
+	if (iface == NULL || !iface->valid)
 		goto unlabel_getattr_nolabel;
 	switch (family) {
 	case PF_INET: {
diff -urN linux-2.6.34-rc3/net/netlabel/netlabel_user.c linux-2.6.34-rc4/net/netlabel/netlabel_user.c
--- linux-2.6.34-rc3/net/netlabel/netlabel_user.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netlabel/netlabel_user.c	2010-04-13 02:19:02.255883431 +0000
@@ -35,6 +35,7 @@
 #include <linux/audit.h>
 #include <linux/tty.h>
 #include <linux/security.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <net/netlink.h>
 #include <net/genetlink.h>
diff -urN linux-2.6.34-rc3/net/netlink/af_netlink.c linux-2.6.34-rc4/net/netlink/af_netlink.c
--- linux-2.6.34-rc3/net/netlink/af_netlink.c	2010-04-13 02:18:56.754633092 +0000
+++ linux-2.6.34-rc4/net/netlink/af_netlink.c	2010-04-13 02:19:02.256883355 +0000
@@ -683,6 +683,9 @@
 	struct netlink_sock *nlk = nlk_sk(sk);
 	struct sockaddr_nl *nladdr = (struct sockaddr_nl *)addr;
 
+	if (alen < sizeof(addr->sa_family))
+		return -EINVAL;
+
 	if (addr->sa_family == AF_UNSPEC) {
 		sk->sk_state	= NETLINK_UNCONNECTED;
 		nlk->dst_pid	= 0;
diff -urN linux-2.6.34-rc3/net/netlink/genetlink.c linux-2.6.34-rc4/net/netlink/genetlink.c
--- linux-2.6.34-rc3/net/netlink/genetlink.c	2010-04-13 02:18:56.754633092 +0000
+++ linux-2.6.34-rc4/net/netlink/genetlink.c	2010-04-13 02:19:02.256883355 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/types.h>
 #include <linux/socket.h>
diff -urN linux-2.6.34-rc3/net/netrom/af_netrom.c linux-2.6.34-rc4/net/netrom/af_netrom.c
--- linux-2.6.34-rc3/net/netrom/af_netrom.c	2010-04-13 02:18:56.754633092 +0000
+++ linux-2.6.34-rc4/net/netrom/af_netrom.c	2010-04-13 02:19:02.256883355 +0000
@@ -15,6 +15,7 @@
 #include <linux/types.h>
 #include <linux/socket.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/timer.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_dev.c linux-2.6.34-rc4/net/netrom/nr_dev.c
--- linux-2.6.34-rc3/net/netrom/nr_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_dev.c	2010-04-13 02:19:02.256883355 +0000
@@ -19,6 +19,7 @@
 #include <linux/fcntl.h>
 #include <linux/in.h>
 #include <linux/if_ether.h>	/* For the statistics structure. */
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_in.c linux-2.6.34-rc4/net/netrom/nr_in.c
--- linux-2.6.34-rc3/net/netrom/nr_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_in.c	2010-04-13 02:19:02.256883355 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_loopback.c linux-2.6.34-rc4/net/netrom/nr_loopback.c
--- linux-2.6.34-rc3/net/netrom/nr_loopback.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_loopback.c	2010-04-13 02:19:02.256883355 +0000
@@ -7,6 +7,7 @@
  * Copyright Tomi Manninen OH2BNS (oh2bns@sral.fi)
  */
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <linux/timer.h>
 #include <net/ax25.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_out.c linux-2.6.34-rc4/net/netrom/nr_out.c
--- linux-2.6.34-rc3/net/netrom/nr_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_out.c	2010-04-13 02:19:02.256883355 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_route.c linux-2.6.34-rc4/net/netrom/nr_route.c
--- linux-2.6.34-rc3/net/netrom/nr_route.c	2010-04-13 02:18:56.755633076 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_route.c	2010-04-13 02:19:02.257883483 +0000
@@ -17,6 +17,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/netrom/nr_subr.c linux-2.6.34-rc4/net/netrom/nr_subr.c
--- linux-2.6.34-rc3/net/netrom/nr_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/netrom/nr_subr.c	2010-04-13 02:19:02.257883483 +0000
@@ -15,6 +15,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/packet/af_packet.c linux-2.6.34-rc4/net/packet/af_packet.c
--- linux-2.6.34-rc3/net/packet/af_packet.c	2010-04-13 02:18:56.755633076 +0000
+++ linux-2.6.34-rc4/net/packet/af_packet.c	2010-04-13 02:19:02.257883483 +0000
@@ -60,6 +60,7 @@
 #include <linux/wireless.h>
 #include <linux/kernel.h>
 #include <linux/kmod.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/ip.h>
 #include <net/protocol.h>
diff -urN linux-2.6.34-rc3/net/phonet/af_phonet.c linux-2.6.34-rc4/net/phonet/af_phonet.c
--- linux-2.6.34-rc3/net/phonet/af_phonet.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/phonet/af_phonet.c	2010-04-13 02:19:02.258883626 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <asm/unaligned.h>
 #include <net/sock.h>
 
diff -urN linux-2.6.34-rc3/net/phonet/datagram.c linux-2.6.34-rc4/net/phonet/datagram.c
--- linux-2.6.34-rc3/net/phonet/datagram.c	2010-04-13 02:18:56.755633076 +0000
+++ linux-2.6.34-rc4/net/phonet/datagram.c	2010-04-13 02:19:02.258883626 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <asm/ioctls.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/phonet/pep.c linux-2.6.34-rc4/net/phonet/pep.c
--- linux-2.6.34-rc3/net/phonet/pep.c	2010-04-13 02:18:56.756633045 +0000
+++ linux-2.6.34-rc4/net/phonet/pep.c	2010-04-13 02:19:02.258883626 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <net/sock.h>
 #include <net/tcp_states.h>
diff -urN linux-2.6.34-rc3/net/phonet/pn_dev.c linux-2.6.34-rc4/net/phonet/pn_dev.c
--- linux-2.6.34-rc3/net/phonet/pn_dev.c	2010-04-13 02:18:56.756633045 +0000
+++ linux-2.6.34-rc4/net/phonet/pn_dev.c	2010-04-13 02:19:02.258883626 +0000
@@ -25,6 +25,7 @@
 
 #include <linux/kernel.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/phonet.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/phonet/pn_netlink.c linux-2.6.34-rc4/net/phonet/pn_netlink.c
--- linux-2.6.34-rc3/net/phonet/pn_netlink.c	2010-04-13 02:18:56.756633045 +0000
+++ linux-2.6.34-rc4/net/phonet/pn_netlink.c	2010-04-13 02:19:02.258883626 +0000
@@ -26,6 +26,7 @@
 #include <linux/kernel.h>
 #include <linux/netlink.h>
 #include <linux/phonet.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/phonet/pn_dev.h>
 
diff -urN linux-2.6.34-rc3/net/phonet/socket.c linux-2.6.34-rc4/net/phonet/socket.c
--- linux-2.6.34-rc3/net/phonet/socket.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/phonet/socket.c	2010-04-13 02:19:02.258883626 +0000
@@ -23,6 +23,7 @@
  * 02110-1301 USA
  */
 
+#include <linux/gfp.h>
 #include <linux/kernel.h>
 #include <linux/net.h>
 #include <linux/poll.h>
diff -urN linux-2.6.34-rc3/net/rds/af_rds.c linux-2.6.34-rc4/net/rds/af_rds.c
--- linux-2.6.34-rc3/net/rds/af_rds.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/af_rds.c	2010-04-13 02:19:02.259883640 +0000
@@ -33,6 +33,7 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/in.h>
 #include <linux/poll.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/rds/cong.c linux-2.6.34-rc4/net/rds/cong.c
--- linux-2.6.34-rc3/net/rds/cong.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/cong.c	2010-04-13 02:19:02.259883640 +0000
@@ -30,6 +30,7 @@
  * SOFTWARE.
  *
  */
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/rbtree.h>
 
diff -urN linux-2.6.34-rc3/net/rds/connection.c linux-2.6.34-rc4/net/rds/connection.c
--- linux-2.6.34-rc3/net/rds/connection.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/connection.c	2010-04-13 02:19:02.259883640 +0000
@@ -32,6 +32,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/inet_hashtables.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rds/ib.c linux-2.6.34-rc4/net/rds/ib.c
--- linux-2.6.34-rc3/net/rds/ib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/ib.c	2010-04-13 02:19:02.259883640 +0000
@@ -37,6 +37,7 @@
 #include <linux/inetdevice.h>
 #include <linux/if_arp.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "rds.h"
 #include "ib.h"
diff -urN linux-2.6.34-rc3/net/rds/ib_cm.c linux-2.6.34-rc4/net/rds/ib_cm.c
--- linux-2.6.34-rc3/net/rds/ib_cm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/ib_cm.c	2010-04-13 02:19:02.259883640 +0000
@@ -32,6 +32,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rds/ib_rdma.c linux-2.6.34-rc4/net/rds/ib_rdma.c
--- linux-2.6.34-rc3/net/rds/ib_rdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/ib_rdma.c	2010-04-13 02:19:02.259883640 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "rds.h"
 #include "rdma.h"
diff -urN linux-2.6.34-rc3/net/rds/ib_recv.c linux-2.6.34-rc4/net/rds/ib_recv.c
--- linux-2.6.34-rc3/net/rds/ib_recv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/ib_recv.c	2010-04-13 02:19:02.259883640 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
 #include <rdma/rdma_cm.h>
diff -urN linux-2.6.34-rc3/net/rds/info.c linux-2.6.34-rc4/net/rds/info.c
--- linux-2.6.34-rc3/net/rds/info.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/info.c	2010-04-13 02:19:02.259883640 +0000
@@ -32,6 +32,7 @@
  */
 #include <linux/percpu.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/proc_fs.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rds/iw.c linux-2.6.34-rc4/net/rds/iw.c
--- linux-2.6.34-rc3/net/rds/iw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/iw.c	2010-04-13 02:19:02.260883768 +0000
@@ -37,6 +37,7 @@
 #include <linux/inetdevice.h>
 #include <linux/if_arp.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include "rds.h"
 #include "iw.h"
diff -urN linux-2.6.34-rc3/net/rds/iw_cm.c linux-2.6.34-rc4/net/rds/iw_cm.c
--- linux-2.6.34-rc3/net/rds/iw_cm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/iw_cm.c	2010-04-13 02:19:02.260883768 +0000
@@ -32,6 +32,7 @@
  */
 #include <linux/kernel.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rds/iw_rdma.c linux-2.6.34-rc4/net/rds/iw_rdma.c
--- linux-2.6.34-rc3/net/rds/iw_rdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/iw_rdma.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "rds.h"
 #include "rdma.h"
diff -urN linux-2.6.34-rc3/net/rds/iw_recv.c linux-2.6.34-rc4/net/rds/iw_recv.c
--- linux-2.6.34-rc3/net/rds/iw_recv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/iw_recv.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/dma-mapping.h>
 #include <rdma/rdma_cm.h>
diff -urN linux-2.6.34-rc3/net/rds/loop.c linux-2.6.34-rc4/net/rds/loop.c
--- linux-2.6.34-rc3/net/rds/loop.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/loop.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rds/message.c linux-2.6.34-rc4/net/rds/message.c
--- linux-2.6.34-rc3/net/rds/message.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/message.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "rds.h"
 #include "rdma.h"
diff -urN linux-2.6.34-rc3/net/rds/page.c linux-2.6.34-rc4/net/rds/page.c
--- linux-2.6.34-rc3/net/rds/page.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/page.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/highmem.h>
+#include <linux/gfp.h>
 
 #include "rds.h"
 
diff -urN linux-2.6.34-rc3/net/rds/rdma.c linux-2.6.34-rc4/net/rds/rdma.c
--- linux-2.6.34-rc3/net/rds/rdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/rdma.c	2010-04-13 02:19:02.260883768 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/pagemap.h>
+#include <linux/slab.h>
 #include <linux/rbtree.h>
 #include <linux/dma-mapping.h> /* for DMA_*_DEVICE */
 
diff -urN linux-2.6.34-rc3/net/rds/recv.c linux-2.6.34-rc4/net/rds/recv.c
--- linux-2.6.34-rc3/net/rds/recv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/recv.c	2010-04-13 02:19:02.261884112 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/in.h>
 
diff -urN linux-2.6.34-rc3/net/rds/send.c linux-2.6.34-rc4/net/rds/send.c
--- linux-2.6.34-rc3/net/rds/send.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/send.c	2010-04-13 02:19:02.261884112 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <linux/in.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/net/rds/tcp.c linux-2.6.34-rc4/net/rds/tcp.c
--- linux-2.6.34-rc3/net/rds/tcp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/tcp.c	2010-04-13 02:19:02.261884112 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <net/tcp.h>
 
diff -urN linux-2.6.34-rc3/net/rds/tcp_listen.c linux-2.6.34-rc4/net/rds/tcp_listen.c
--- linux-2.6.34-rc3/net/rds/tcp_listen.c	2010-04-13 02:18:56.756633045 +0000
+++ linux-2.6.34-rc4/net/rds/tcp_listen.c	2010-04-13 02:19:02.261884112 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/in.h>
 #include <net/tcp.h>
 
diff -urN linux-2.6.34-rc3/net/rds/tcp_recv.c linux-2.6.34-rc4/net/rds/tcp_recv.c
--- linux-2.6.34-rc3/net/rds/tcp_recv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rds/tcp_recv.c	2010-04-13 02:19:02.261884112 +0000
@@ -31,6 +31,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <net/tcp.h>
 
 #include "rds.h"
diff -urN linux-2.6.34-rc3/net/rfkill/core.c linux-2.6.34-rc4/net/rfkill/core.c
--- linux-2.6.34-rc3/net/rfkill/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rfkill/core.c	2010-04-13 02:19:02.261884112 +0000
@@ -33,6 +33,7 @@
 #include <linux/wait.h>
 #include <linux/poll.h>
 #include <linux/fs.h>
+#include <linux/slab.h>
 
 #include "rfkill.h"
 
diff -urN linux-2.6.34-rc3/net/rose/af_rose.c linux-2.6.34-rc4/net/rose/af_rose.c
--- linux-2.6.34-rc3/net/rose/af_rose.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/rose/af_rose.c	2010-04-13 02:19:02.262883280 +0000
@@ -18,6 +18,7 @@
 #include <linux/types.h>
 #include <linux/socket.h>
 #include <linux/in.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/sched.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_dev.c linux-2.6.34-rc4/net/rose/rose_dev.c
--- linux-2.6.34-rc3/net/rose/rose_dev.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_dev.c	2010-04-13 02:19:02.262883280 +0000
@@ -19,6 +19,7 @@
 #include <linux/fcntl.h>
 #include <linux/in.h>
 #include <linux/if_ether.h>
+#include <linux/slab.h>
 
 #include <asm/system.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_link.c linux-2.6.34-rc4/net/rose/rose_link.c
--- linux-2.6.34-rc3/net/rose/rose_link.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_link.c	2010-04-13 02:19:02.262883280 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_loopback.c linux-2.6.34-rc4/net/rose/rose_loopback.c
--- linux-2.6.34-rc3/net/rose/rose_loopback.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_loopback.c	2010-04-13 02:19:02.262883280 +0000
@@ -7,6 +7,7 @@
  * Copyright (C) Jonathan Naylor G4KLX (g4klx@g4klx.demon.co.uk)
  */
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <linux/timer.h>
 #include <net/ax25.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_out.c linux-2.6.34-rc4/net/rose/rose_out.c
--- linux-2.6.34-rc3/net/rose/rose_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_out.c	2010-04-13 02:19:02.262883280 +0000
@@ -15,6 +15,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/gfp.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_route.c linux-2.6.34-rc4/net/rose/rose_route.c
--- linux-2.6.34-rc3/net/rose/rose_route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_route.c	2010-04-13 02:19:02.262883280 +0000
@@ -16,6 +16,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/rose/rose_subr.c linux-2.6.34-rc4/net/rose/rose_subr.c
--- linux-2.6.34-rc3/net/rose/rose_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rose/rose_subr.c	2010-04-13 02:19:02.264212482 +0000
@@ -15,6 +15,7 @@
 #include <linux/string.h>
 #include <linux/sockios.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <net/ax25.h>
 #include <linux/inet.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/af_rxrpc.c linux-2.6.34-rc4/net/rxrpc/af_rxrpc.c
--- linux-2.6.34-rc3/net/rxrpc/af_rxrpc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/af_rxrpc.c	2010-04-13 02:19:02.264212482 +0000
@@ -11,6 +11,7 @@
 
 #include <linux/module.h>
 #include <linux/net.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/poll.h>
 #include <linux/proc_fs.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-accept.c linux-2.6.34-rc4/net/rxrpc/ar-accept.c
--- linux-2.6.34-rc3/net/rxrpc/ar-accept.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-accept.c	2010-04-13 02:19:02.264212482 +0000
@@ -17,6 +17,7 @@
 #include <linux/in.h>
 #include <linux/in6.h>
 #include <linux/icmp.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-ack.c linux-2.6.34-rc4/net/rxrpc/ar-ack.c
--- linux-2.6.34-rc3/net/rxrpc/ar-ack.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-ack.c	2010-04-13 02:19:02.264212482 +0000
@@ -13,6 +13,7 @@
 #include <linux/circ_buf.h>
 #include <linux/net.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/udp.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-call.c linux-2.6.34-rc4/net/rxrpc/ar-call.c
--- linux-2.6.34-rc3/net/rxrpc/ar-call.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-call.c	2010-04-13 02:19:02.264883089 +0000
@@ -9,6 +9,7 @@
  * 2 of the License, or (at your option) any later version.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/circ_buf.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-connection.c linux-2.6.34-rc4/net/rxrpc/ar-connection.c
--- linux-2.6.34-rc3/net/rxrpc/ar-connection.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-connection.c	2010-04-13 02:19:02.264883089 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/net.h>
 #include <linux/skbuff.h>
 #include <linux/crypto.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-input.c linux-2.6.34-rc4/net/rxrpc/ar-input.c
--- linux-2.6.34-rc3/net/rxrpc/ar-input.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-input.c	2010-04-13 02:19:02.264883089 +0000
@@ -17,6 +17,7 @@
 #include <linux/in.h>
 #include <linux/in6.h>
 #include <linux/icmp.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-key.c linux-2.6.34-rc4/net/rxrpc/ar-key.c
--- linux-2.6.34-rc3/net/rxrpc/ar-key.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-key.c	2010-04-13 02:19:02.264883089 +0000
@@ -18,6 +18,7 @@
 #include <linux/key-type.h>
 #include <linux/crypto.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <keys/rxrpc-type.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-local.c linux-2.6.34-rc4/net/rxrpc/ar-local.c
--- linux-2.6.34-rc3/net/rxrpc/ar-local.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-local.c	2010-04-13 02:19:02.264883089 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/net.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include "ar-internal.h"
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-output.c linux-2.6.34-rc4/net/rxrpc/ar-output.c
--- linux-2.6.34-rc3/net/rxrpc/ar-output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-output.c	2010-04-13 02:19:02.264883089 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/net.h>
+#include <linux/gfp.h>
 #include <linux/skbuff.h>
 #include <linux/circ_buf.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-peer.c linux-2.6.34-rc4/net/rxrpc/ar-peer.c
--- linux-2.6.34-rc3/net/rxrpc/ar-peer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-peer.c	2010-04-13 02:19:02.264883089 +0000
@@ -16,6 +16,7 @@
 #include <linux/in.h>
 #include <linux/in6.h>
 #include <linux/icmp.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/rxrpc/ar-transport.c linux-2.6.34-rc4/net/rxrpc/ar-transport.c
--- linux-2.6.34-rc3/net/rxrpc/ar-transport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/ar-transport.c	2010-04-13 02:19:02.264883089 +0000
@@ -12,6 +12,7 @@
 #include <linux/module.h>
 #include <linux/net.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include "ar-internal.h"
diff -urN linux-2.6.34-rc3/net/rxrpc/rxkad.c linux-2.6.34-rc4/net/rxrpc/rxkad.c
--- linux-2.6.34-rc3/net/rxrpc/rxkad.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/rxrpc/rxkad.c	2010-04-13 02:19:02.265883460 +0000
@@ -16,6 +16,7 @@
 #include <linux/crypto.h>
 #include <linux/scatterlist.h>
 #include <linux/ctype.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/af_rxrpc.h>
 #include <keys/rxrpc-type.h>
diff -urN linux-2.6.34-rc3/net/sched/act_api.c linux-2.6.34-rc4/net/sched/act_api.c
--- linux-2.6.34-rc3/net/sched/act_api.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_api.c	2010-04-13 02:19:02.265883460 +0000
@@ -15,6 +15,7 @@
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/init.h>
 #include <linux/kmod.h>
diff -urN linux-2.6.34-rc3/net/sched/act_ipt.c linux-2.6.34-rc4/net/sched/act_ipt.c
--- linux-2.6.34-rc3/net/sched/act_ipt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_ipt.c	2010-04-13 02:19:02.265883460 +0000
@@ -19,6 +19,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/pkt_sched.h>
 #include <linux/tc_act/tc_ipt.h>
diff -urN linux-2.6.34-rc3/net/sched/act_mirred.c linux-2.6.34-rc4/net/sched/act_mirred.c
--- linux-2.6.34-rc3/net/sched/act_mirred.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_mirred.c	2010-04-13 02:19:02.265883460 +0000
@@ -20,6 +20,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <net/net_namespace.h>
 #include <net/netlink.h>
 #include <net/pkt_sched.h>
diff -urN linux-2.6.34-rc3/net/sched/act_pedit.c linux-2.6.34-rc4/net/sched/act_pedit.c
--- linux-2.6.34-rc3/net/sched/act_pedit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_pedit.c	2010-04-13 02:19:02.265883460 +0000
@@ -17,6 +17,7 @@
 #include <linux/rtnetlink.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/pkt_sched.h>
 #include <linux/tc_act/tc_pedit.h>
diff -urN linux-2.6.34-rc3/net/sched/act_police.c linux-2.6.34-rc4/net/sched/act_police.c
--- linux-2.6.34-rc3/net/sched/act_police.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_police.c	2010-04-13 02:19:02.265883460 +0000
@@ -18,6 +18,7 @@
 #include <linux/skbuff.h>
 #include <linux/rtnetlink.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/act_api.h>
 #include <net/netlink.h>
 
diff -urN linux-2.6.34-rc3/net/sched/act_simple.c linux-2.6.34-rc4/net/sched/act_simple.c
--- linux-2.6.34-rc3/net/sched/act_simple.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/act_simple.c	2010-04-13 02:19:02.265883460 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_api.c linux-2.6.34-rc4/net/sched/cls_api.c
--- linux-2.6.34-rc3/net/sched/cls_api.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_api.c	2010-04-13 02:19:02.266883924 +0000
@@ -24,6 +24,7 @@
 #include <linux/kmod.h>
 #include <linux/netlink.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/sock.h>
 #include <net/netlink.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_basic.c linux-2.6.34-rc4/net/sched/cls_basic.c
--- linux-2.6.34-rc3/net/sched/cls_basic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_basic.c	2010-04-13 02:19:02.266883924 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_cgroup.c linux-2.6.34-rc4/net/sched/cls_cgroup.c
--- linux-2.6.34-rc3/net/sched/cls_cgroup.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/sched/cls_cgroup.c	2010-04-13 02:19:02.266883924 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_flow.c linux-2.6.34-rc4/net/sched/cls_flow.c
--- linux-2.6.34-rc3/net/sched/cls_flow.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_flow.c	2010-04-13 02:19:02.266883924 +0000
@@ -20,6 +20,7 @@
 #include <linux/ip.h>
 #include <linux/ipv6.h>
 #include <linux/if_vlan.h>
+#include <linux/slab.h>
 
 #include <net/pkt_cls.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_fw.c linux-2.6.34-rc4/net/sched/cls_fw.c
--- linux-2.6.34-rc3/net/sched/cls_fw.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_fw.c	2010-04-13 02:19:02.266883924 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_route.c linux-2.6.34-rc4/net/sched/cls_route.c
--- linux-2.6.34-rc3/net/sched/cls_route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_route.c	2010-04-13 02:19:02.266883924 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_tcindex.c linux-2.6.34-rc4/net/sched/cls_tcindex.c
--- linux-2.6.34-rc3/net/sched/cls_tcindex.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_tcindex.c	2010-04-13 02:19:02.266883924 +0000
@@ -9,6 +9,7 @@
 #include <linux/kernel.h>
 #include <linux/skbuff.h>
 #include <linux/errno.h>
+#include <linux/slab.h>
 #include <net/act_api.h>
 #include <net/netlink.h>
 #include <net/pkt_cls.h>
diff -urN linux-2.6.34-rc3/net/sched/cls_u32.c linux-2.6.34-rc4/net/sched/cls_u32.c
--- linux-2.6.34-rc3/net/sched/cls_u32.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/cls_u32.c	2010-04-13 02:19:02.266883924 +0000
@@ -31,6 +31,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/em_meta.c linux-2.6.34-rc4/net/sched/em_meta.c
--- linux-2.6.34-rc3/net/sched/em_meta.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/em_meta.c	2010-04-13 02:19:02.267883512 +0000
@@ -58,6 +58,7 @@
  * 	      only available if that subsystem is enabled in the kernel.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sched/em_nbyte.c linux-2.6.34-rc4/net/sched/em_nbyte.c
--- linux-2.6.34-rc3/net/sched/em_nbyte.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/em_nbyte.c	2010-04-13 02:19:02.267883512 +0000
@@ -9,6 +9,7 @@
  * Authors:	Thomas Graf <tgraf@suug.ch>
  */
 
+#include <linux/gfp.h>
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sched/em_text.c linux-2.6.34-rc4/net/sched/em_text.c
--- linux-2.6.34-rc3/net/sched/em_text.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/em_text.c	2010-04-13 02:19:02.267883512 +0000
@@ -9,6 +9,7 @@
  * Authors:	Thomas Graf <tgraf@suug.ch>
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sched/ematch.c linux-2.6.34-rc4/net/sched/ematch.c
--- linux-2.6.34-rc3/net/sched/ematch.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/ematch.c	2010-04-13 02:19:02.267883512 +0000
@@ -82,6 +82,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_api.c linux-2.6.34-rc4/net/sched/sch_api.c
--- linux-2.6.34-rc3/net/sched/sch_api.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/sched/sch_api.c	2010-04-13 02:19:02.267883512 +0000
@@ -28,6 +28,7 @@
 #include <linux/list.h>
 #include <linux/hrtimer.h>
 #include <linux/lockdep.h>
+#include <linux/slab.h>
 
 #include <net/net_namespace.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_atm.c linux-2.6.34-rc4/net/sched/sch_atm.c
--- linux-2.6.34-rc3/net/sched/sch_atm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_atm.c	2010-04-13 02:19:02.267883512 +0000
@@ -3,6 +3,7 @@
 /* Written 1998-2000 by Werner Almesberger, EPFL ICA */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_cbq.c linux-2.6.34-rc4/net/sched/sch_cbq.c
--- linux-2.6.34-rc3/net/sched/sch_cbq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_cbq.c	2010-04-13 02:19:02.268883667 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_drr.c linux-2.6.34-rc4/net/sched/sch_drr.c
--- linux-2.6.34-rc3/net/sched/sch_drr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_drr.c	2010-04-13 02:19:02.268883667 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/errno.h>
 #include <linux/netdevice.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_dsmark.c linux-2.6.34-rc4/net/sched/sch_dsmark.c
--- linux-2.6.34-rc3/net/sched/sch_dsmark.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_dsmark.c	2010-04-13 02:19:02.268883667 +0000
@@ -5,6 +5,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_fifo.c linux-2.6.34-rc4/net/sched/sch_fifo.c
--- linux-2.6.34-rc3/net/sched/sch_fifo.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/sched/sch_fifo.c	2010-04-13 02:19:02.268883667 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_generic.c linux-2.6.34-rc4/net/sched/sch_generic.c
--- linux-2.6.34-rc3/net/sched/sch_generic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_generic.c	2010-04-13 02:19:02.268883667 +0000
@@ -24,6 +24,7 @@
 #include <linux/init.h>
 #include <linux/rcupdate.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <net/pkt_sched.h>
 
 /* Main transmission queue. */
diff -urN linux-2.6.34-rc3/net/sched/sch_gred.c linux-2.6.34-rc4/net/sched/sch_gred.c
--- linux-2.6.34-rc3/net/sched/sch_gred.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_gred.c	2010-04-13 02:19:02.268883667 +0000
@@ -18,6 +18,7 @@
  *  For all the glorious comments look at include/net/red.h
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_htb.c linux-2.6.34-rc4/net/sched/sch_htb.c
--- linux-2.6.34-rc3/net/sched/sch_htb.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_htb.c	2010-04-13 02:19:02.268883667 +0000
@@ -36,6 +36,7 @@
 #include <linux/compiler.h>
 #include <linux/rbtree.h>
 #include <linux/workqueue.h>
+#include <linux/slab.h>
 #include <net/netlink.h>
 #include <net/pkt_sched.h>
 
diff -urN linux-2.6.34-rc3/net/sched/sch_mq.c linux-2.6.34-rc4/net/sched/sch_mq.c
--- linux-2.6.34-rc3/net/sched/sch_mq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_mq.c	2010-04-13 02:19:02.269883990 +0000
@@ -9,6 +9,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_multiq.c linux-2.6.34-rc4/net/sched/sch_multiq.c
--- linux-2.6.34-rc3/net/sched/sch_multiq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_multiq.c	2010-04-13 02:19:02.269883990 +0000
@@ -18,6 +18,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_netem.c linux-2.6.34-rc4/net/sched/sch_netem.c
--- linux-2.6.34-rc3/net/sched/sch_netem.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_netem.c	2010-04-13 02:19:02.269883990 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_prio.c linux-2.6.34-rc4/net/sched/sch_prio.c
--- linux-2.6.34-rc3/net/sched/sch_prio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_prio.c	2010-04-13 02:19:02.269883990 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_sfq.c linux-2.6.34-rc4/net/sched/sch_sfq.c
--- linux-2.6.34-rc3/net/sched/sch_sfq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_sfq.c	2010-04-13 02:19:02.269883990 +0000
@@ -20,6 +20,7 @@
 #include <linux/ipv6.h>
 #include <linux/skbuff.h>
 #include <linux/jhash.h>
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <net/netlink.h>
 #include <net/pkt_sched.h>
diff -urN linux-2.6.34-rc3/net/sched/sch_teql.c linux-2.6.34-rc4/net/sched/sch_teql.c
--- linux-2.6.34-rc3/net/sched/sch_teql.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sched/sch_teql.c	2010-04-13 02:19:02.269883990 +0000
@@ -11,6 +11,7 @@
 #include <linux/module.h>
 #include <linux/types.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include <linux/if_arp.h>
diff -urN linux-2.6.34-rc3/net/sctp/auth.c linux-2.6.34-rc4/net/sctp/auth.c
--- linux-2.6.34-rc3/net/sctp/auth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/auth.c	2010-04-13 02:19:02.269883990 +0000
@@ -34,6 +34,7 @@
  * be incorporated into the next SCTP release.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/crypto.h>
 #include <linux/scatterlist.h>
diff -urN linux-2.6.34-rc3/net/sctp/bind_addr.c linux-2.6.34-rc4/net/sctp/bind_addr.c
--- linux-2.6.34-rc3/net/sctp/bind_addr.c	2010-04-13 02:18:56.757633092 +0000
+++ linux-2.6.34-rc4/net/sctp/bind_addr.c	2010-04-13 02:19:02.269883990 +0000
@@ -43,6 +43,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/in.h>
 #include <net/sock.h>
 #include <net/ipv6.h>
diff -urN linux-2.6.34-rc3/net/sctp/chunk.c linux-2.6.34-rc4/net/sctp/chunk.c
--- linux-2.6.34-rc3/net/sctp/chunk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/chunk.c	2010-04-13 02:19:02.270883467 +0000
@@ -42,6 +42,7 @@
 #include <linux/net.h>
 #include <linux/inet.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/sctp/sctp.h>
 #include <net/sctp/sm.h>
diff -urN linux-2.6.34-rc3/net/sctp/input.c linux-2.6.34-rc4/net/sctp/input.c
--- linux-2.6.34-rc3/net/sctp/input.c	2010-04-13 02:18:56.758633040 +0000
+++ linux-2.6.34-rc4/net/sctp/input.c	2010-04-13 02:19:02.270883467 +0000
@@ -53,6 +53,7 @@
 #include <linux/socket.h>
 #include <linux/ip.h>
 #include <linux/time.h> /* For struct timeval */
+#include <linux/slab.h>
 #include <net/ip.h>
 #include <net/icmp.h>
 #include <net/snmp.h>
diff -urN linux-2.6.34-rc3/net/sctp/inqueue.c linux-2.6.34-rc4/net/sctp/inqueue.c
--- linux-2.6.34-rc3/net/sctp/inqueue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/inqueue.c	2010-04-13 02:19:02.270883467 +0000
@@ -46,6 +46,7 @@
 #include <net/sctp/sctp.h>
 #include <net/sctp/sm.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 
 /* Initialize an SCTP inqueue.  */
 void sctp_inq_init(struct sctp_inq *queue)
diff -urN linux-2.6.34-rc3/net/sctp/ipv6.c linux-2.6.34-rc4/net/sctp/ipv6.c
--- linux-2.6.34-rc3/net/sctp/ipv6.c	2010-04-13 02:18:56.758633040 +0000
+++ linux-2.6.34-rc4/net/sctp/ipv6.c	2010-04-13 02:19:02.270883467 +0000
@@ -58,6 +58,7 @@
 #include <linux/netdevice.h>
 #include <linux/init.h>
 #include <linux/ipsec.h>
+#include <linux/slab.h>
 
 #include <linux/ipv6.h>
 #include <linux/icmpv6.h>
diff -urN linux-2.6.34-rc3/net/sctp/output.c linux-2.6.34-rc4/net/sctp/output.c
--- linux-2.6.34-rc3/net/sctp/output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/output.c	2010-04-13 02:19:02.270883467 +0000
@@ -48,6 +48,7 @@
 #include <linux/ip.h>
 #include <linux/ipv6.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/inet_ecn.h>
 #include <net/ip.h>
 #include <net/icmp.h>
diff -urN linux-2.6.34-rc3/net/sctp/outqueue.c linux-2.6.34-rc4/net/sctp/outqueue.c
--- linux-2.6.34-rc3/net/sctp/outqueue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/outqueue.c	2010-04-13 02:19:02.271883736 +0000
@@ -50,6 +50,7 @@
 #include <linux/list.h>   /* For struct list_head */
 #include <linux/socket.h>
 #include <linux/ip.h>
+#include <linux/slab.h>
 #include <net/sock.h>	  /* For skb_set_owner_w */
 
 #include <net/sctp/sctp.h>
diff -urN linux-2.6.34-rc3/net/sctp/primitive.c linux-2.6.34-rc4/net/sctp/primitive.c
--- linux-2.6.34-rc3/net/sctp/primitive.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/primitive.c	2010-04-13 02:19:02.271883736 +0000
@@ -50,6 +50,7 @@
 #include <linux/socket.h>
 #include <linux/ip.h>
 #include <linux/time.h> /* For struct timeval */
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <net/sctp/sctp.h>
 #include <net/sctp/sm.h>
diff -urN linux-2.6.34-rc3/net/sctp/protocol.c linux-2.6.34-rc4/net/sctp/protocol.c
--- linux-2.6.34-rc3/net/sctp/protocol.c	2010-04-13 02:18:56.758633040 +0000
+++ linux-2.6.34-rc4/net/sctp/protocol.c	2010-04-13 02:19:02.271883736 +0000
@@ -54,6 +54,7 @@
 #include <linux/bootmem.h>
 #include <linux/highmem.h>
 #include <linux/swap.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/protocol.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/sctp/sm_make_chunk.c linux-2.6.34-rc4/net/sctp/sm_make_chunk.c
--- linux-2.6.34-rc3/net/sctp/sm_make_chunk.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/sm_make_chunk.c	2010-04-13 02:19:02.271883736 +0000
@@ -58,6 +58,7 @@
 #include <linux/inet.h>
 #include <linux/scatterlist.h>
 #include <linux/crypto.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/sctp/sm_sideeffect.c linux-2.6.34-rc4/net/sctp/sm_sideeffect.c
--- linux-2.6.34-rc3/net/sctp/sm_sideeffect.c	2010-04-13 02:18:56.758633040 +0000
+++ linux-2.6.34-rc4/net/sctp/sm_sideeffect.c	2010-04-13 02:19:02.272884131 +0000
@@ -51,6 +51,7 @@
 #include <linux/types.h>
 #include <linux/socket.h>
 #include <linux/ip.h>
+#include <linux/gfp.h>
 #include <net/sock.h>
 #include <net/sctp/sctp.h>
 #include <net/sctp/sm.h>
diff -urN linux-2.6.34-rc3/net/sctp/sm_statefuns.c linux-2.6.34-rc4/net/sctp/sm_statefuns.c
--- linux-2.6.34-rc3/net/sctp/sm_statefuns.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/sm_statefuns.c	2010-04-13 02:19:02.273883371 +0000
@@ -56,6 +56,7 @@
 #include <linux/ipv6.h>
 #include <linux/net.h>
 #include <linux/inet.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/inet_ecn.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/sctp/socket.c linux-2.6.34-rc4/net/sctp/socket.c
--- linux-2.6.34-rc3/net/sctp/socket.c	2010-04-13 02:18:56.759571939 +0000
+++ linux-2.6.34-rc4/net/sctp/socket.c	2010-04-13 02:19:02.274883688 +0000
@@ -67,6 +67,7 @@
 #include <linux/poll.h>
 #include <linux/init.h>
 #include <linux/crypto.h>
+#include <linux/slab.h>
 
 #include <net/ip.h>
 #include <net/icmp.h>
diff -urN linux-2.6.34-rc3/net/sctp/ssnmap.c linux-2.6.34-rc4/net/sctp/ssnmap.c
--- linux-2.6.34-rc3/net/sctp/ssnmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/ssnmap.c	2010-04-13 02:19:02.274883688 +0000
@@ -37,6 +37,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <net/sctp/sctp.h>
 #include <net/sctp/sm.h>
 
diff -urN linux-2.6.34-rc3/net/sctp/transport.c linux-2.6.34-rc4/net/sctp/transport.c
--- linux-2.6.34-rc3/net/sctp/transport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/transport.c	2010-04-13 02:19:02.274883688 +0000
@@ -48,6 +48,7 @@
  * be incorporated into the next SCTP release.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/random.h>
 #include <net/sctp/sctp.h>
diff -urN linux-2.6.34-rc3/net/sctp/tsnmap.c linux-2.6.34-rc4/net/sctp/tsnmap.c
--- linux-2.6.34-rc3/net/sctp/tsnmap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/tsnmap.c	2010-04-13 02:19:02.274883688 +0000
@@ -42,6 +42,7 @@
  * be incorporated into the next SCTP release.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/bitmap.h>
 #include <net/sctp/sctp.h>
diff -urN linux-2.6.34-rc3/net/sctp/ulpevent.c linux-2.6.34-rc4/net/sctp/ulpevent.c
--- linux-2.6.34-rc3/net/sctp/ulpevent.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/ulpevent.c	2010-04-13 02:19:02.274883688 +0000
@@ -43,6 +43,7 @@
  * be incorporated into the next SCTP release.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/skbuff.h>
 #include <net/sctp/structs.h>
diff -urN linux-2.6.34-rc3/net/sctp/ulpqueue.c linux-2.6.34-rc4/net/sctp/ulpqueue.c
--- linux-2.6.34-rc3/net/sctp/ulpqueue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sctp/ulpqueue.c	2010-04-13 02:19:02.274883688 +0000
@@ -41,6 +41,7 @@
  * be incorporated into the next SCTP release.
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/skbuff.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/socket.c linux-2.6.34-rc4/net/socket.c
--- linux-2.6.34-rc3/net/socket.c	2010-04-13 02:18:56.760570444 +0000
+++ linux-2.6.34-rc4/net/socket.c	2010-04-13 02:19:02.275883282 +0000
@@ -87,6 +87,7 @@
 #include <linux/wireless.h>
 #include <linux/nsproxy.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 
 #include <asm/uaccess.h>
 #include <asm/unistd.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/addr.c linux-2.6.34-rc4/net/sunrpc/addr.c
--- linux-2.6.34-rc3/net/sunrpc/addr.c	2010-04-13 02:18:56.760570444 +0000
+++ linux-2.6.34-rc4/net/sunrpc/addr.c	2010-04-13 02:19:02.275883282 +0000
@@ -18,6 +18,7 @@
 
 #include <net/ipv6.h>
 #include <linux/sunrpc/clnt.h>
+#include <linux/slab.h>
 
 #if defined(CONFIG_IPV6) || defined(CONFIG_IPV6_MODULE)
 
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_generic.c linux-2.6.34-rc4/net/sunrpc/auth_generic.c
--- linux-2.6.34-rc3/net/sunrpc/auth_generic.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_generic.c	2010-04-13 02:19:02.275883282 +0000
@@ -5,6 +5,7 @@
  */
 
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/module.h>
 #include <linux/sched.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_generic_token.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_generic_token.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_generic_token.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_generic_token.c	2010-04-13 02:19:02.275883282 +0000
@@ -33,7 +33,6 @@
 
 #include <linux/types.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/sunrpc/sched.h>
 #include <linux/sunrpc/gss_asn1.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_crypto.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_crypto.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_crypto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_crypto.c	2010-04-13 02:19:02.275883282 +0000
@@ -37,7 +37,6 @@
 #include <linux/err.h>
 #include <linux/types.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/scatterlist.h>
 #include <linux/crypto.h>
 #include <linux/highmem.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_seal.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_seal.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_seal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_seal.c	2010-04-13 02:19:02.275883282 +0000
@@ -59,7 +59,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/jiffies.h>
 #include <linux/sunrpc/gss_krb5.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_seqnum.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_seqnum.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_seqnum.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_seqnum.c	2010-04-13 02:19:02.276883563 +0000
@@ -32,7 +32,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/sunrpc/gss_krb5.h>
 #include <linux/crypto.h>
 
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_unseal.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_unseal.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_unseal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_unseal.c	2010-04-13 02:19:02.276883563 +0000
@@ -58,7 +58,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/jiffies.h>
 #include <linux/sunrpc/gss_krb5.h>
 #include <linux/crypto.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_wrap.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_wrap.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_krb5_wrap.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_krb5_wrap.c	2010-04-13 02:19:02.276883563 +0000
@@ -1,5 +1,4 @@
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/jiffies.h>
 #include <linux/sunrpc/gss_krb5.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_spkm3_seal.c linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_spkm3_seal.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/gss_spkm3_seal.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/gss_spkm3_seal.c	2010-04-13 02:19:02.276883563 +0000
@@ -34,7 +34,6 @@
  */
 
 #include <linux/types.h>
-#include <linux/slab.h>
 #include <linux/jiffies.h>
 #include <linux/sunrpc/gss_spkm3.h>
 #include <linux/random.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_gss/svcauth_gss.c linux-2.6.34-rc4/net/sunrpc/auth_gss/svcauth_gss.c
--- linux-2.6.34-rc3/net/sunrpc/auth_gss/svcauth_gss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_gss/svcauth_gss.c	2010-04-13 02:19:02.276883563 +0000
@@ -37,6 +37,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/module.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/auth_unix.c linux-2.6.34-rc4/net/sunrpc/auth_unix.c
--- linux-2.6.34-rc3/net/sunrpc/auth_unix.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/auth_unix.c	2010-04-13 02:19:02.276883563 +0000
@@ -6,6 +6,7 @@
  * Copyright (C) 1996, Olaf Kirch <okir@monad.swb.de>
  */
 
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <linux/module.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/backchannel_rqst.c linux-2.6.34-rc4/net/sunrpc/backchannel_rqst.c
--- linux-2.6.34-rc3/net/sunrpc/backchannel_rqst.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/backchannel_rqst.c	2010-04-13 02:19:02.276883563 +0000
@@ -22,6 +22,7 @@
 ******************************************************************************/
 
 #include <linux/tcp.h>
+#include <linux/slab.h>
 #include <linux/sunrpc/xprt.h>
 
 #ifdef RPC_DEBUG
diff -urN linux-2.6.34-rc3/net/sunrpc/rpcb_clnt.c linux-2.6.34-rc4/net/sunrpc/rpcb_clnt.c
--- linux-2.6.34-rc3/net/sunrpc/rpcb_clnt.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/rpcb_clnt.c	2010-04-13 02:19:02.277883502 +0000
@@ -21,6 +21,7 @@
 #include <linux/kernel.h>
 #include <linux/errno.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/ipv6.h>
 
 #include <linux/sunrpc/clnt.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/socklib.c linux-2.6.34-rc4/net/sunrpc/socklib.c
--- linux-2.6.34-rc3/net/sunrpc/socklib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/socklib.c	2010-04-13 02:19:02.277883502 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/compiler.h>
 #include <linux/netdevice.h>
+#include <linux/gfp.h>
 #include <linux/skbuff.h>
 #include <linux/types.h>
 #include <linux/pagemap.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/stats.c linux-2.6.34-rc4/net/sunrpc/stats.c
--- linux-2.6.34-rc3/net/sunrpc/stats.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/stats.c	2010-04-13 02:19:02.277883502 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include <linux/init.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/svc.c linux-2.6.34-rc4/net/sunrpc/svc.c
--- linux-2.6.34-rc3/net/sunrpc/svc.c	2010-04-13 02:18:56.761570686 +0000
+++ linux-2.6.34-rc4/net/sunrpc/svc.c	2010-04-13 02:19:02.277883502 +0000
@@ -19,6 +19,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 #include <linux/sunrpc/types.h>
 #include <linux/sunrpc/xdr.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/svc_xprt.c linux-2.6.34-rc4/net/sunrpc/svc_xprt.c
--- linux-2.6.34-rc3/net/sunrpc/svc_xprt.c	2010-04-13 02:18:56.761570686 +0000
+++ linux-2.6.34-rc4/net/sunrpc/svc_xprt.c	2010-04-13 02:19:02.278883780 +0000
@@ -9,6 +9,7 @@
 #include <linux/errno.h>
 #include <linux/freezer.h>
 #include <linux/kthread.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/sunrpc/stats.h>
 #include <linux/sunrpc/svc_xprt.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/svcauth_unix.c linux-2.6.34-rc4/net/sunrpc/svcauth_unix.c
--- linux-2.6.34-rc3/net/sunrpc/svcauth_unix.c	2010-04-13 02:18:56.761570686 +0000
+++ linux-2.6.34-rc4/net/sunrpc/svcauth_unix.c	2010-04-13 02:19:02.278883780 +0000
@@ -10,6 +10,7 @@
 #include <linux/seq_file.h>
 #include <linux/hash.h>
 #include <linux/string.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/ipv6.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/xdr.c linux-2.6.34-rc4/net/sunrpc/xdr.c
--- linux-2.6.34-rc3/net/sunrpc/xdr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/xdr.c	2010-04-13 02:19:02.278883780 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/string.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/xprtrdma/svc_rdma.c linux-2.6.34-rc4/net/sunrpc/xprtrdma/svc_rdma.c
--- linux-2.6.34-rc3/net/sunrpc/xprtrdma/svc_rdma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/xprtrdma/svc_rdma.c	2010-04-13 02:19:02.279883977 +0000
@@ -40,6 +40,7 @@
  */
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/sysctl.h>
 #include <linux/sunrpc/clnt.h>
diff -urN linux-2.6.34-rc3/net/sunrpc/xprtrdma/svc_rdma_transport.c linux-2.6.34-rc4/net/sunrpc/xprtrdma/svc_rdma_transport.c
--- linux-2.6.34-rc3/net/sunrpc/xprtrdma/svc_rdma_transport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/xprtrdma/svc_rdma_transport.c	2010-04-13 02:19:02.279883977 +0000
@@ -43,6 +43,7 @@
 #include <linux/sunrpc/debug.h>
 #include <linux/sunrpc/rpc_rdma.h>
 #include <linux/sched.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <rdma/ib_verbs.h>
 #include <rdma/rdma_cm.h>
@@ -678,7 +679,10 @@
 	int ret;
 
 	dprintk("svcrdma: Creating RDMA socket\n");
-
+	if (sa->sa_family != AF_INET) {
+		dprintk("svcrdma: Address family %d is not supported.\n", sa->sa_family);
+		return ERR_PTR(-EAFNOSUPPORT);
+	}
 	cma_xprt = rdma_create_xprt(serv, 1);
 	if (!cma_xprt)
 		return ERR_PTR(-ENOMEM);
diff -urN linux-2.6.34-rc3/net/sunrpc/xprtrdma/transport.c linux-2.6.34-rc4/net/sunrpc/xprtrdma/transport.c
--- linux-2.6.34-rc3/net/sunrpc/xprtrdma/transport.c	2010-04-13 02:18:56.762633048 +0000
+++ linux-2.6.34-rc4/net/sunrpc/xprtrdma/transport.c	2010-04-13 02:19:02.279883977 +0000
@@ -49,6 +49,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/seq_file.h>
 
 #include "xprt_rdma.h"
diff -urN linux-2.6.34-rc3/net/sunrpc/xprtrdma/verbs.c linux-2.6.34-rc4/net/sunrpc/xprtrdma/verbs.c
--- linux-2.6.34-rc3/net/sunrpc/xprtrdma/verbs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/sunrpc/xprtrdma/verbs.c	2010-04-13 02:19:02.279883977 +0000
@@ -48,6 +48,7 @@
  */
 
 #include <linux/pci.h>	/* for Tavor hack below */
+#include <linux/slab.h>
 
 #include "xprt_rdma.h"
 
diff -urN linux-2.6.34-rc3/net/tipc/core.h linux-2.6.34-rc4/net/tipc/core.h
--- linux-2.6.34-rc3/net/tipc/core.h	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/tipc/core.h	2010-04-13 02:19:02.280883616 +0000
@@ -56,6 +56,7 @@
 #include <linux/netdevice.h>
 #include <linux/in.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 
 /*
diff -urN linux-2.6.34-rc3/net/tipc/eth_media.c linux-2.6.34-rc4/net/tipc/eth_media.c
--- linux-2.6.34-rc3/net/tipc/eth_media.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/tipc/eth_media.c	2010-04-13 02:19:02.281883936 +0000
@@ -38,6 +38,7 @@
 #include <net/tipc/tipc_bearer.h>
 #include <net/tipc/tipc_msg.h>
 #include <linux/netdevice.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 
 #define MAX_ETH_BEARERS		2
diff -urN linux-2.6.34-rc3/net/tipc/socket.c linux-2.6.34-rc4/net/tipc/socket.c
--- linux-2.6.34-rc3/net/tipc/socket.c	2010-04-13 02:18:56.764633022 +0000
+++ linux-2.6.34-rc4/net/tipc/socket.c	2010-04-13 02:19:02.281883936 +0000
@@ -40,9 +40,9 @@
 #include <linux/socket.h>
 #include <linux/errno.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/poll.h>
 #include <linux/fcntl.h>
+#include <linux/gfp.h>
 #include <asm/string.h>
 #include <asm/atomic.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/net/unix/garbage.c linux-2.6.34-rc4/net/unix/garbage.c
--- linux-2.6.34-rc3/net/unix/garbage.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/unix/garbage.c	2010-04-13 02:19:02.282883587 +0000
@@ -74,7 +74,6 @@
 #include <linux/un.h>
 #include <linux/net.h>
 #include <linux/fs.h>
-#include <linux/slab.h>
 #include <linux/skbuff.h>
 #include <linux/netdevice.h>
 #include <linux/file.h>
diff -urN linux-2.6.34-rc3/net/unix/sysctl_net_unix.c linux-2.6.34-rc4/net/unix/sysctl_net_unix.c
--- linux-2.6.34-rc3/net/unix/sysctl_net_unix.c	2010-04-13 02:18:56.764633022 +0000
+++ linux-2.6.34-rc4/net/unix/sysctl_net_unix.c	2010-04-13 02:19:02.282883587 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/sysctl.h>
 
 #include <net/af_unix.h>
diff -urN linux-2.6.34-rc3/net/wimax/op-msg.c linux-2.6.34-rc4/net/wimax/op-msg.c
--- linux-2.6.34-rc3/net/wimax/op-msg.c	2010-04-13 02:18:56.764633022 +0000
+++ linux-2.6.34-rc4/net/wimax/op-msg.c	2010-04-13 02:19:02.282883587 +0000
@@ -72,6 +72,7 @@
  *   wimax_msg_send()
  */
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <net/genetlink.h>
 #include <linux/netdevice.h>
 #include <linux/wimax.h>
diff -urN linux-2.6.34-rc3/net/wimax/stack.c linux-2.6.34-rc4/net/wimax/stack.c
--- linux-2.6.34-rc3/net/wimax/stack.c	2010-04-13 02:18:56.765633123 +0000
+++ linux-2.6.34-rc4/net/wimax/stack.c	2010-04-13 02:19:02.283883605 +0000
@@ -51,6 +51,7 @@
  *   wimax_rfkill_rm()
  */
 #include <linux/device.h>
+#include <linux/gfp.h>
 #include <net/genetlink.h>
 #include <linux/netdevice.h>
 #include <linux/wimax.h>
diff -urN linux-2.6.34-rc3/net/wireless/core.c linux-2.6.34-rc4/net/wireless/core.c
--- linux-2.6.34-rc3/net/wireless/core.c	2010-04-13 02:18:56.765633123 +0000
+++ linux-2.6.34-rc4/net/wireless/core.c	2010-04-13 02:19:02.283883605 +0000
@@ -8,6 +8,7 @@
 #include <linux/module.h>
 #include <linux/err.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/nl80211.h>
 #include <linux/debugfs.h>
 #include <linux/notifier.h>
diff -urN linux-2.6.34-rc3/net/wireless/debugfs.c linux-2.6.34-rc4/net/wireless/debugfs.c
--- linux-2.6.34-rc3/net/wireless/debugfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/wireless/debugfs.c	2010-04-13 02:19:02.284883286 +0000
@@ -9,6 +9,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include "core.h"
 #include "debugfs.h"
 
diff -urN linux-2.6.34-rc3/net/wireless/ibss.c linux-2.6.34-rc4/net/wireless/ibss.c
--- linux-2.6.34-rc3/net/wireless/ibss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/wireless/ibss.c	2010-04-13 02:19:02.284883286 +0000
@@ -6,6 +6,7 @@
 
 #include <linux/etherdevice.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/cfg80211.h>
 #include "wext-compat.h"
 #include "nl80211.h"
diff -urN linux-2.6.34-rc3/net/wireless/mlme.c linux-2.6.34-rc4/net/wireless/mlme.c
--- linux-2.6.34-rc3/net/wireless/mlme.c	2010-04-13 02:18:56.766633044 +0000
+++ linux-2.6.34-rc4/net/wireless/mlme.c	2010-04-13 02:19:02.285883837 +0000
@@ -8,6 +8,7 @@
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/nl80211.h>
+#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <net/cfg80211.h>
 #include <net/iw_handler.h>
diff -urN linux-2.6.34-rc3/net/wireless/nl80211.c linux-2.6.34-rc4/net/wireless/nl80211.c
--- linux-2.6.34-rc3/net/wireless/nl80211.c	2010-04-13 02:18:56.767633055 +0000
+++ linux-2.6.34-rc4/net/wireless/nl80211.c	2010-04-13 02:19:02.286883440 +0000
@@ -7,6 +7,7 @@
 #include <linux/if.h>
 #include <linux/module.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/if_ether.h>
 #include <linux/ieee80211.h>
diff -urN linux-2.6.34-rc3/net/wireless/reg.c linux-2.6.34-rc4/net/wireless/reg.c
--- linux-2.6.34-rc3/net/wireless/reg.c	2010-04-13 02:18:56.768633027 +0000
+++ linux-2.6.34-rc4/net/wireless/reg.c	2010-04-13 02:19:02.287883703 +0000
@@ -33,6 +33,7 @@
  *
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/list.h>
 #include <linux/random.h>
 #include <linux/nl80211.h>
@@ -324,7 +325,7 @@
 };
 
 static LIST_HEAD(reg_regdb_search_list);
-static DEFINE_SPINLOCK(reg_regdb_search_lock);
+static DEFINE_MUTEX(reg_regdb_search_mutex);
 
 static void reg_regdb_search(struct work_struct *work)
 {
@@ -332,7 +333,7 @@
 	const struct ieee80211_regdomain *curdom, *regdom;
 	int i, r;
 
-	spin_lock(&reg_regdb_search_lock);
+	mutex_lock(&reg_regdb_search_mutex);
 	while (!list_empty(&reg_regdb_search_list)) {
 		request = list_first_entry(&reg_regdb_search_list,
 					   struct reg_regdb_search_request,
@@ -346,18 +347,16 @@
 				r = reg_copy_regd(&regdom, curdom);
 				if (r)
 					break;
-				spin_unlock(&reg_regdb_search_lock);
 				mutex_lock(&cfg80211_mutex);
 				set_regdom(regdom);
 				mutex_unlock(&cfg80211_mutex);
-				spin_lock(&reg_regdb_search_lock);
 				break;
 			}
 		}
 
 		kfree(request);
 	}
-	spin_unlock(&reg_regdb_search_lock);
+	mutex_unlock(&reg_regdb_search_mutex);
 }
 
 static DECLARE_WORK(reg_regdb_work, reg_regdb_search);
@@ -375,9 +374,9 @@
 
 	memcpy(request->alpha2, alpha2, 2);
 
-	spin_lock(&reg_regdb_search_lock);
+	mutex_lock(&reg_regdb_search_mutex);
 	list_add_tail(&request->list, &reg_regdb_search_list);
-	spin_unlock(&reg_regdb_search_lock);
+	mutex_unlock(&reg_regdb_search_mutex);
 
 	schedule_work(&reg_regdb_work);
 }
diff -urN linux-2.6.34-rc3/net/wireless/scan.c linux-2.6.34-rc4/net/wireless/scan.c
--- linux-2.6.34-rc3/net/wireless/scan.c	2010-04-13 02:18:56.769571683 +0000
+++ linux-2.6.34-rc4/net/wireless/scan.c	2010-04-13 02:19:02.287883703 +0000
@@ -4,6 +4,7 @@
  * Copyright 2008 Johannes Berg <johannes@sipsolutions.net>
  */
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/netdevice.h>
 #include <linux/wireless.h>
diff -urN linux-2.6.34-rc3/net/wireless/sme.c linux-2.6.34-rc4/net/wireless/sme.c
--- linux-2.6.34-rc3/net/wireless/sme.c	2010-04-13 02:18:56.769571683 +0000
+++ linux-2.6.34-rc4/net/wireless/sme.c	2010-04-13 02:19:02.288883705 +0000
@@ -7,6 +7,7 @@
 
 #include <linux/etherdevice.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <linux/wireless.h>
 #include <net/iw_handler.h>
diff -urN linux-2.6.34-rc3/net/wireless/util.c linux-2.6.34-rc4/net/wireless/util.c
--- linux-2.6.34-rc3/net/wireless/util.c	2010-04-13 02:18:56.769571683 +0000
+++ linux-2.6.34-rc4/net/wireless/util.c	2010-04-13 02:19:02.288883705 +0000
@@ -5,6 +5,7 @@
  */
 #include <linux/bitops.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <net/cfg80211.h>
 #include <net/ip.h>
 #include "core.h"
diff -urN linux-2.6.34-rc3/net/wireless/wext-compat.c linux-2.6.34-rc4/net/wireless/wext-compat.c
--- linux-2.6.34-rc3/net/wireless/wext-compat.c	2010-04-13 02:18:56.770570545 +0000
+++ linux-2.6.34-rc4/net/wireless/wext-compat.c	2010-04-13 02:19:02.288883705 +0000
@@ -12,6 +12,7 @@
 #include <linux/nl80211.h>
 #include <linux/if_arp.h>
 #include <linux/etherdevice.h>
+#include <linux/slab.h>
 #include <net/iw_handler.h>
 #include <net/cfg80211.h>
 #include "wext-compat.h"
diff -urN linux-2.6.34-rc3/net/wireless/wext-core.c linux-2.6.34-rc4/net/wireless/wext-core.c
--- linux-2.6.34-rc3/net/wireless/wext-core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/wireless/wext-core.c	2010-04-13 02:19:02.288883705 +0000
@@ -10,6 +10,7 @@
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
 #include <linux/rtnetlink.h>
+#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <linux/uaccess.h>
 #include <net/cfg80211.h>
diff -urN linux-2.6.34-rc3/net/wireless/wext-priv.c linux-2.6.34-rc4/net/wireless/wext-priv.c
--- linux-2.6.34-rc3/net/wireless/wext-priv.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/wireless/wext-priv.c	2010-04-13 02:19:02.288883705 +0000
@@ -7,6 +7,7 @@
  *
  * (As all part of the Linux kernel, this file is GPL)
  */
+#include <linux/slab.h>
 #include <linux/wireless.h>
 #include <linux/netdevice.h>
 #include <net/iw_handler.h>
diff -urN linux-2.6.34-rc3/net/wireless/wext-sme.c linux-2.6.34-rc4/net/wireless/wext-sme.c
--- linux-2.6.34-rc3/net/wireless/wext-sme.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/wireless/wext-sme.c	2010-04-13 02:19:02.289883188 +0000
@@ -7,6 +7,7 @@
 
 #include <linux/etherdevice.h>
 #include <linux/if_arp.h>
+#include <linux/slab.h>
 #include <net/cfg80211.h>
 #include "wext-compat.h"
 #include "nl80211.h"
diff -urN linux-2.6.34-rc3/net/x25/af_x25.c linux-2.6.34-rc4/net/x25/af_x25.c
--- linux-2.6.34-rc3/net/x25/af_x25.c	2010-04-13 02:18:56.770570545 +0000
+++ linux-2.6.34-rc4/net/x25/af_x25.c	2010-04-13 02:19:02.289883188 +0000
@@ -47,6 +47,7 @@
 #include <linux/netdevice.h>
 #include <linux/if_arp.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <net/tcp_states.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/x25/x25_dev.c linux-2.6.34-rc4/net/x25/x25_dev.c
--- linux-2.6.34-rc3/net/x25/x25_dev.c	2010-04-13 02:18:56.770570545 +0000
+++ linux-2.6.34-rc4/net/x25/x25_dev.c	2010-04-13 02:19:02.289883188 +0000
@@ -20,6 +20,7 @@
 #include <linux/kernel.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <net/sock.h>
 #include <linux/if_arp.h>
 #include <net/x25.h>
diff -urN linux-2.6.34-rc3/net/x25/x25_forward.c linux-2.6.34-rc4/net/x25/x25_forward.c
--- linux-2.6.34-rc3/net/x25/x25_forward.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_forward.c	2010-04-13 02:19:02.289883188 +0000
@@ -10,6 +10,7 @@
  */
 #include <linux/if_arp.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/x25.h>
 
 LIST_HEAD(x25_forward_list);
diff -urN linux-2.6.34-rc3/net/x25/x25_in.c linux-2.6.34-rc4/net/x25/x25_in.c
--- linux-2.6.34-rc3/net/x25/x25_in.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_in.c	2010-04-13 02:19:02.290570907 +0000
@@ -23,6 +23,7 @@
  *					  i-frames.
  */
 
+#include <linux/slab.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/x25/x25_link.c linux-2.6.34-rc4/net/x25/x25_link.c
--- linux-2.6.34-rc3/net/x25/x25_link.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_link.c	2010-04-13 02:19:02.290570907 +0000
@@ -24,6 +24,7 @@
 #include <linux/kernel.h>
 #include <linux/jiffies.h>
 #include <linux/timer.h>
+#include <linux/slab.h>
 #include <linux/netdevice.h>
 #include <linux/skbuff.h>
 #include <asm/uaccess.h>
diff -urN linux-2.6.34-rc3/net/x25/x25_out.c linux-2.6.34-rc4/net/x25/x25_out.c
--- linux-2.6.34-rc3/net/x25/x25_out.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_out.c	2010-04-13 02:19:02.290570907 +0000
@@ -22,6 +22,7 @@
  *					needed cleaned seq-number fields.
  */
 
+#include <linux/slab.h>
 #include <linux/socket.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
diff -urN linux-2.6.34-rc3/net/x25/x25_route.c linux-2.6.34-rc4/net/x25/x25_route.c
--- linux-2.6.34-rc3/net/x25/x25_route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_route.c	2010-04-13 02:19:02.290570907 +0000
@@ -19,6 +19,7 @@
 
 #include <linux/if_arp.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <net/x25.h>
 
 LIST_HEAD(x25_route_list);
diff -urN linux-2.6.34-rc3/net/x25/x25_subr.c linux-2.6.34-rc4/net/x25/x25_subr.c
--- linux-2.6.34-rc3/net/x25/x25_subr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/x25/x25_subr.c	2010-04-13 02:19:02.290570907 +0000
@@ -23,6 +23,7 @@
  *						restriction on response.
  */
 
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/net/xfrm/xfrm_ipcomp.c linux-2.6.34-rc4/net/xfrm/xfrm_ipcomp.c
--- linux-2.6.34-rc3/net/xfrm/xfrm_ipcomp.c	2010-04-13 02:18:56.770570545 +0000
+++ linux-2.6.34-rc4/net/xfrm/xfrm_ipcomp.c	2010-04-13 02:19:02.290570907 +0000
@@ -17,11 +17,11 @@
 
 #include <linux/crypto.h>
 #include <linux/err.h>
-#include <linux/gfp.h>
 #include <linux/list.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
 #include <linux/percpu.h>
+#include <linux/slab.h>
 #include <linux/smp.h>
 #include <linux/vmalloc.h>
 #include <net/ip.h>
diff -urN linux-2.6.34-rc3/net/xfrm/xfrm_output.c linux-2.6.34-rc4/net/xfrm/xfrm_output.c
--- linux-2.6.34-rc3/net/xfrm/xfrm_output.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/net/xfrm/xfrm_output.c	2010-04-13 02:19:02.291570477 +0000
@@ -14,6 +14,7 @@
 #include <linux/netdevice.h>
 #include <linux/netfilter.h>
 #include <linux/skbuff.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <net/dst.h>
 #include <net/xfrm.h>
diff -urN linux-2.6.34-rc3/net/xfrm/xfrm_state.c linux-2.6.34-rc4/net/xfrm/xfrm_state.c
--- linux-2.6.34-rc3/net/xfrm/xfrm_state.c	2010-04-13 02:18:56.772633050 +0000
+++ linux-2.6.34-rc4/net/xfrm/xfrm_state.c	2010-04-13 02:19:02.291570477 +0000
@@ -22,6 +22,7 @@
 #include <linux/audit.h>
 #include <asm/uaccess.h>
 #include <linux/ktime.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/kernel.h>
 
diff -urN linux-2.6.34-rc3/net/xfrm/xfrm_sysctl.c linux-2.6.34-rc4/net/xfrm/xfrm_sysctl.c
--- linux-2.6.34-rc3/net/xfrm/xfrm_sysctl.c	2010-04-13 02:18:56.772633050 +0000
+++ linux-2.6.34-rc4/net/xfrm/xfrm_sysctl.c	2010-04-13 02:19:02.292883635 +0000
@@ -1,4 +1,5 @@
 #include <linux/sysctl.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/xfrm.h>
 
diff -urN linux-2.6.34-rc3/samples/kobject/kset-example.c linux-2.6.34-rc4/samples/kobject/kset-example.c
--- linux-2.6.34-rc3/samples/kobject/kset-example.c	2010-04-13 02:18:56.772633050 +0000
+++ linux-2.6.34-rc4/samples/kobject/kset-example.c	2010-04-13 02:19:02.292883635 +0000
@@ -10,6 +10,7 @@
 #include <linux/kobject.h>
 #include <linux/string.h>
 #include <linux/sysfs.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/init.h>
 
diff -urN linux-2.6.34-rc3/security/device_cgroup.c linux-2.6.34-rc4/security/device_cgroup.c
--- linux-2.6.34-rc3/security/device_cgroup.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/device_cgroup.c	2010-04-13 02:19:02.295883896 +0000
@@ -10,6 +10,7 @@
 #include <linux/list.h>
 #include <linux/uaccess.h>
 #include <linux/seq_file.h>
+#include <linux/slab.h>
 #include <linux/rcupdate.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_api.c linux-2.6.34-rc4/security/integrity/ima/ima_api.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_api.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_api.c	2010-04-13 02:19:02.295883896 +0000
@@ -13,6 +13,7 @@
  *	and store_template.
  */
 #include <linux/module.h>
+#include <linux/slab.h>
 
 #include "ima.h"
 static const char *IMA_TEMPLATE_NAME = "ima";
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_audit.c linux-2.6.34-rc4/security/integrity/ima/ima_audit.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_audit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_audit.c	2010-04-13 02:19:02.295883896 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/fs.h>
+#include <linux/gfp.h>
 #include <linux/audit.h>
 #include "ima.h"
 
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_crypto.c linux-2.6.34-rc4/security/integrity/ima/ima_crypto.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_crypto.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_crypto.c	2010-04-13 02:19:02.295883896 +0000
@@ -18,6 +18,7 @@
 #include <linux/crypto.h>
 #include <linux/scatterlist.h>
 #include <linux/err.h>
+#include <linux/slab.h>
 #include "ima.h"
 
 static int init_desc(struct hash_desc *desc)
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_fs.c linux-2.6.34-rc4/security/integrity/ima/ima_fs.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_fs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_fs.c	2010-04-13 02:19:02.295883896 +0000
@@ -16,6 +16,7 @@
  *	current measurement list and IMA statistics
  */
 #include <linux/fcntl.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/seq_file.h>
 #include <linux/rculist.h>
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_iint.c linux-2.6.34-rc4/security/integrity/ima/ima_iint.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_iint.c	2010-04-13 02:18:56.775633029 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_iint.c	2010-04-13 02:19:02.295883896 +0000
@@ -14,6 +14,7 @@
  *	- cache integrity information associated with an inode
  *	  using a radix tree.
  */
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/spinlock.h>
 #include <linux/radix-tree.h>
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_init.c linux-2.6.34-rc4/security/integrity/ima/ima_init.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_init.c	2010-04-13 02:19:02.296883628 +0000
@@ -16,6 +16,7 @@
  */
 #include <linux/module.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <linux/err.h>
 #include "ima.h"
 
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_main.c linux-2.6.34-rc4/security/integrity/ima/ima_main.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_main.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_main.c	2010-04-13 02:19:02.296883628 +0000
@@ -21,6 +21,7 @@
 #include <linux/binfmts.h>
 #include <linux/mount.h>
 #include <linux/mman.h>
+#include <linux/slab.h>
 
 #include "ima.h"
 
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_policy.c linux-2.6.34-rc4/security/integrity/ima/ima_policy.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_policy.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_policy.c	2010-04-13 02:19:02.296883628 +0000
@@ -15,6 +15,7 @@
 #include <linux/security.h>
 #include <linux/magic.h>
 #include <linux/parser.h>
+#include <linux/slab.h>
 
 #include "ima.h"
 
diff -urN linux-2.6.34-rc3/security/integrity/ima/ima_queue.c linux-2.6.34-rc4/security/integrity/ima/ima_queue.c
--- linux-2.6.34-rc3/security/integrity/ima/ima_queue.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/integrity/ima/ima_queue.c	2010-04-13 02:19:02.296883628 +0000
@@ -20,6 +20,7 @@
  */
 #include <linux/module.h>
 #include <linux/rculist.h>
+#include <linux/slab.h>
 #include "ima.h"
 
 LIST_HEAD(ima_measurements);	/* list of all measurements */
diff -urN linux-2.6.34-rc3/security/keys/proc.c linux-2.6.34-rc4/security/keys/proc.c
--- linux-2.6.34-rc3/security/keys/proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/keys/proc.c	2010-04-13 02:19:02.296883628 +0000
@@ -12,7 +12,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/proc_fs.h>
 #include <linux/seq_file.h>
diff -urN linux-2.6.34-rc3/security/keys/process_keys.c linux-2.6.34-rc4/security/keys/process_keys.c
--- linux-2.6.34-rc3/security/keys/process_keys.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/keys/process_keys.c	2010-04-13 02:19:02.296883628 +0000
@@ -12,7 +12,6 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/sched.h>
-#include <linux/slab.h>
 #include <linux/keyctl.h>
 #include <linux/fs.h>
 #include <linux/err.h>
diff -urN linux-2.6.34-rc3/security/lsm_audit.c linux-2.6.34-rc4/security/lsm_audit.c
--- linux-2.6.34-rc3/security/lsm_audit.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/lsm_audit.c	2010-04-13 02:19:02.296883628 +0000
@@ -14,6 +14,7 @@
 #include <linux/types.h>
 #include <linux/stddef.h>
 #include <linux/kernel.h>
+#include <linux/gfp.h>
 #include <linux/fs.h>
 #include <linux/init.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/security/selinux/netif.c linux-2.6.34-rc4/security/selinux/netif.c
--- linux-2.6.34-rc3/security/selinux/netif.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/netif.c	2010-04-13 02:19:02.298884247 +0000
@@ -16,6 +16,7 @@
  */
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/security/selinux/netlabel.c linux-2.6.34-rc4/security/selinux/netlabel.c
--- linux-2.6.34-rc3/security/selinux/netlabel.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/netlabel.c	2010-04-13 02:19:02.298884247 +0000
@@ -29,6 +29,7 @@
 
 #include <linux/spinlock.h>
 #include <linux/rcupdate.h>
+#include <linux/gfp.h>
 #include <linux/ip.h>
 #include <linux/ipv6.h>
 #include <net/sock.h>
diff -urN linux-2.6.34-rc3/security/selinux/netlink.c linux-2.6.34-rc4/security/selinux/netlink.c
--- linux-2.6.34-rc3/security/selinux/netlink.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/netlink.c	2010-04-13 02:19:02.298884247 +0000
@@ -11,6 +11,7 @@
  */
 #include <linux/init.h>
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/stddef.h>
 #include <linux/kernel.h>
 #include <linux/list.h>
diff -urN linux-2.6.34-rc3/security/selinux/netnode.c linux-2.6.34-rc4/security/selinux/netnode.c
--- linux-2.6.34-rc3/security/selinux/netnode.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/netnode.c	2010-04-13 02:19:02.298884247 +0000
@@ -31,6 +31,7 @@
 #include <linux/types.h>
 #include <linux/rcupdate.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/in.h>
 #include <linux/in6.h>
diff -urN linux-2.6.34-rc3/security/selinux/netport.c linux-2.6.34-rc4/security/selinux/netport.c
--- linux-2.6.34-rc3/security/selinux/netport.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/netport.c	2010-04-13 02:19:02.298884247 +0000
@@ -30,6 +30,7 @@
 #include <linux/types.h>
 #include <linux/rcupdate.h>
 #include <linux/list.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include <linux/in.h>
 #include <linux/in6.h>
diff -urN linux-2.6.34-rc3/security/selinux/ss/symtab.c linux-2.6.34-rc4/security/selinux/ss/symtab.c
--- linux-2.6.34-rc3/security/selinux/ss/symtab.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/ss/symtab.c	2010-04-13 02:19:02.300883579 +0000
@@ -4,7 +4,6 @@
  * Author : Stephen Smalley, <sds@epoch.ncsc.mil>
  */
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/string.h>
 #include <linux/errno.h>
 #include "symtab.h"
diff -urN linux-2.6.34-rc3/security/selinux/xfrm.c linux-2.6.34-rc4/security/selinux/xfrm.c
--- linux-2.6.34-rc3/security/selinux/xfrm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/selinux/xfrm.c	2010-04-13 02:19:02.301883551 +0000
@@ -38,6 +38,7 @@
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv4.h>
 #include <linux/netfilter_ipv6.h>
+#include <linux/slab.h>
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/skbuff.h>
diff -urN linux-2.6.34-rc3/security/smack/smack_access.c linux-2.6.34-rc4/security/smack/smack_access.c
--- linux-2.6.34-rc3/security/smack/smack_access.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/smack/smack_access.c	2010-04-13 02:19:02.301883551 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/types.h>
+#include <linux/slab.h>
 #include <linux/fs.h>
 #include <linux/sched.h>
 #include "smack.h"
diff -urN linux-2.6.34-rc3/security/smack/smack_lsm.c linux-2.6.34-rc4/security/smack/smack_lsm.c
--- linux-2.6.34-rc3/security/smack/smack_lsm.c	2010-04-13 02:18:56.779571550 +0000
+++ linux-2.6.34-rc4/security/smack/smack_lsm.c	2010-04-13 02:19:02.301883551 +0000
@@ -25,6 +25,7 @@
 #include <linux/ip.h>
 #include <linux/tcp.h>
 #include <linux/udp.h>
+#include <linux/slab.h>
 #include <linux/mutex.h>
 #include <linux/pipe_fs_i.h>
 #include <net/netlabel.h>
diff -urN linux-2.6.34-rc3/security/smack/smackfs.c linux-2.6.34-rc4/security/smack/smackfs.c
--- linux-2.6.34-rc3/security/smack/smackfs.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/security/smack/smackfs.c	2010-04-13 02:19:02.301883551 +0000
@@ -20,6 +20,7 @@
 #include <linux/vmalloc.h>
 #include <linux/security.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 #include <net/net_namespace.h>
 #include <net/netlabel.h>
 #include <net/cipso_ipv4.h>
diff -urN linux-2.6.34-rc3/security/tomoyo/common.c linux-2.6.34-rc4/security/tomoyo/common.c
--- linux-2.6.34-rc3/security/tomoyo/common.c	2010-04-13 02:18:56.780570403 +0000
+++ linux-2.6.34-rc4/security/tomoyo/common.c	2010-04-13 02:19:02.302883868 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/uaccess.h>
+#include <linux/slab.h>
 #include <linux/security.h>
 #include <linux/hardirq.h>
 #include "common.h"
diff -urN linux-2.6.34-rc3/security/tomoyo/domain.c linux-2.6.34-rc4/security/tomoyo/domain.c
--- linux-2.6.34-rc3/security/tomoyo/domain.c	2010-04-13 02:18:56.781633045 +0000
+++ linux-2.6.34-rc4/security/tomoyo/domain.c	2010-04-13 02:19:02.303883768 +0000
@@ -11,6 +11,7 @@
 
 #include "common.h"
 #include <linux/binfmts.h>
+#include <linux/slab.h>
 
 /* Variables definitions.*/
 
diff -urN linux-2.6.34-rc3/security/tomoyo/file.c linux-2.6.34-rc4/security/tomoyo/file.c
--- linux-2.6.34-rc3/security/tomoyo/file.c	2010-04-13 02:18:56.782633053 +0000
+++ linux-2.6.34-rc4/security/tomoyo/file.c	2010-04-13 02:19:02.304883821 +0000
@@ -10,6 +10,7 @@
  */
 
 #include "common.h"
+#include <linux/slab.h>
 
 /* Keyword array for single path operations. */
 static const char *tomoyo_path_keyword[TOMOYO_MAX_PATH_OPERATION] = {
diff -urN linux-2.6.34-rc3/security/tomoyo/gc.c linux-2.6.34-rc4/security/tomoyo/gc.c
--- linux-2.6.34-rc3/security/tomoyo/gc.c	2010-04-13 02:18:56.782633053 +0000
+++ linux-2.6.34-rc4/security/tomoyo/gc.c	2010-04-13 02:19:02.305884063 +0000
@@ -9,6 +9,7 @@
 
 #include "common.h"
 #include <linux/kthread.h>
+#include <linux/slab.h>
 
 enum tomoyo_gc_id {
 	TOMOYO_ID_DOMAIN_INITIALIZER,
diff -urN linux-2.6.34-rc3/security/tomoyo/realpath.c linux-2.6.34-rc4/security/tomoyo/realpath.c
--- linux-2.6.34-rc3/security/tomoyo/realpath.c	2010-04-13 02:18:56.782633053 +0000
+++ linux-2.6.34-rc4/security/tomoyo/realpath.c	2010-04-13 02:19:02.305884063 +0000
@@ -15,6 +15,7 @@
 #include <linux/fs_struct.h>
 #include <linux/hash.h>
 #include <linux/magic.h>
+#include <linux/slab.h>
 #include "common.h"
 
 /**
diff -urN linux-2.6.34-rc3/sound/aoa/codecs/onyx.c linux-2.6.34-rc4/sound/aoa/codecs/onyx.c
--- linux-2.6.34-rc3/sound/aoa/codecs/onyx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/codecs/onyx.c	2010-04-13 02:19:02.306883915 +0000
@@ -33,6 +33,7 @@
  */
 #include <linux/delay.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 MODULE_AUTHOR("Johannes Berg <johannes@sipsolutions.net>");
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("pcm3052 (onyx) codec driver for snd-aoa");
diff -urN linux-2.6.34-rc3/sound/aoa/codecs/tas.c linux-2.6.34-rc4/sound/aoa/codecs/tas.c
--- linux-2.6.34-rc3/sound/aoa/codecs/tas.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/codecs/tas.c	2010-04-13 02:19:02.306883915 +0000
@@ -66,6 +66,7 @@
 #include <linux/delay.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 MODULE_AUTHOR("Johannes Berg <johannes@sipsolutions.net>");
 MODULE_LICENSE("GPL");
diff -urN linux-2.6.34-rc3/sound/aoa/codecs/toonie.c linux-2.6.34-rc4/sound/aoa/codecs/toonie.c
--- linux-2.6.34-rc3/sound/aoa/codecs/toonie.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/codecs/toonie.c	2010-04-13 02:19:02.306883915 +0000
@@ -11,6 +11,7 @@
  */
 #include <linux/delay.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 MODULE_AUTHOR("Johannes Berg <johannes@sipsolutions.net>");
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("toonie codec driver for snd-aoa");
diff -urN linux-2.6.34-rc3/sound/aoa/core/gpio-pmf.c linux-2.6.34-rc4/sound/aoa/core/gpio-pmf.c
--- linux-2.6.34-rc3/sound/aoa/core/gpio-pmf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/core/gpio-pmf.c	2010-04-13 02:19:02.306883915 +0000
@@ -6,6 +6,7 @@
  * GPL v2, can be found in COPYING.
  */
 
+#include <linux/slab.h>
 #include <asm/pmac_feature.h>
 #include <asm/pmac_pfunc.h>
 #include "../aoa.h"
diff -urN linux-2.6.34-rc3/sound/aoa/fabrics/layout.c linux-2.6.34-rc4/sound/aoa/fabrics/layout.c
--- linux-2.6.34-rc3/sound/aoa/fabrics/layout.c	2010-04-13 02:18:56.783633052 +0000
+++ linux-2.6.34-rc4/sound/aoa/fabrics/layout.c	2010-04-13 02:19:02.306883915 +0000
@@ -12,6 +12,7 @@
 #include <asm/prom.h>
 #include <linux/list.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include "../aoa.h"
 #include "../soundbus/soundbus.h"
 
diff -urN linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/control.c linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/control.c
--- linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/control.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/control.c	2010-04-13 02:19:02.306883915 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/kernel.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <asm/io.h>
 #include <asm/prom.h>
diff -urN linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/core.c linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/core.c
--- linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/core.c	2010-04-13 02:19:02.306883915 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/pcm.c linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/pcm.c
--- linux-2.6.34-rc3/sound/aoa/soundbus/i2sbus/pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/aoa/soundbus/i2sbus/pcm.c	2010-04-13 02:19:02.306883915 +0000
@@ -8,6 +8,7 @@
 
 #include <asm/io.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <asm/macio.h>
 #include <linux/pci.h>
diff -urN linux-2.6.34-rc3/sound/arm/pxa2xx-pcm-lib.c linux-2.6.34-rc4/sound/arm/pxa2xx-pcm-lib.c
--- linux-2.6.34-rc3/sound/arm/pxa2xx-pcm-lib.c	2010-04-13 02:18:56.783633052 +0000
+++ linux-2.6.34-rc4/sound/arm/pxa2xx-pcm-lib.c	2010-04-13 02:19:02.307883290 +0000
@@ -4,6 +4,7 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/dma-mapping.h>
 
diff -urN linux-2.6.34-rc3/sound/core/control_compat.c linux-2.6.34-rc4/sound/core/control_compat.c
--- linux-2.6.34-rc3/sound/core/control_compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/control_compat.c	2010-04-13 02:19:02.307883290 +0000
@@ -21,6 +21,7 @@
 /* this file included from control.c */
 
 #include <linux/compat.h>
+#include <linux/slab.h>
 
 struct snd_ctl_elem_list32 {
 	u32 offset;
diff -urN linux-2.6.34-rc3/sound/core/hrtimer.c linux-2.6.34-rc4/sound/core/hrtimer.c
--- linux-2.6.34-rc3/sound/core/hrtimer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/hrtimer.c	2010-04-13 02:19:02.307883290 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/hrtimer.h>
diff -urN linux-2.6.34-rc3/sound/core/info.c linux-2.6.34-rc4/sound/core/info.c
--- linux-2.6.34-rc3/sound/core/info.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/info.c	2010-04-13 02:19:02.307883290 +0000
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/time.h>
 #include <linux/mm.h>
+#include <linux/slab.h>
 #include <linux/smp_lock.h>
 #include <linux/string.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/core/jack.c linux-2.6.34-rc4/sound/core/jack.c
--- linux-2.6.34-rc3/sound/core/jack.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/jack.c	2010-04-13 02:19:02.307883290 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/input.h>
+#include <linux/slab.h>
 #include <sound/jack.h>
 #include <sound/core.h>
 
diff -urN linux-2.6.34-rc3/sound/core/misc.c linux-2.6.34-rc4/sound/core/misc.c
--- linux-2.6.34-rc3/sound/core/misc.c	2010-04-13 02:18:56.783633052 +0000
+++ linux-2.6.34-rc4/sound/core/misc.c	2010-04-13 02:19:02.308883469 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/init.h>
 #include <linux/time.h>
+#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <sound/core.h>
 
diff -urN linux-2.6.34-rc3/sound/core/oss/route.c linux-2.6.34-rc4/sound/core/oss/route.c
--- linux-2.6.34-rc3/sound/core/oss/route.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/oss/route.c	2010-04-13 02:19:02.308883469 +0000
@@ -19,7 +19,6 @@
  *
  */
 
-#include <linux/slab.h>
 #include <linux/time.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/core/pcm_compat.c linux-2.6.34-rc4/sound/core/pcm_compat.c
--- linux-2.6.34-rc3/sound/core/pcm_compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/pcm_compat.c	2010-04-13 02:19:02.308883469 +0000
@@ -21,6 +21,7 @@
 /* This file included from pcm_native.c */
 
 #include <linux/compat.h>
+#include <linux/slab.h>
 
 static int snd_pcm_ioctl_delay_compat(struct snd_pcm_substream *substream,
 				      s32 __user *src)
diff -urN linux-2.6.34-rc3/sound/core/pcm_memory.c linux-2.6.34-rc4/sound/core/pcm_memory.c
--- linux-2.6.34-rc3/sound/core/pcm_memory.c	2010-04-13 02:18:56.785633053 +0000
+++ linux-2.6.34-rc4/sound/core/pcm_memory.c	2010-04-13 02:19:02.310570887 +0000
@@ -22,6 +22,7 @@
 #include <asm/io.h>
 #include <linux/time.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/vmalloc.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_init.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_init.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_init.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_init.c	2010-04-13 02:19:02.310570887 +0000
@@ -29,6 +29,7 @@
 #include "seq_oss_event.h"
 #include <linux/init.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 
 /*
  * common variables
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_midi.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_midi.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_midi.c	2010-04-13 02:19:02.310570887 +0000
@@ -28,6 +28,7 @@
 #include <sound/seq_midi_event.h>
 #include "../seq_lock.h"
 #include <linux/init.h>
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_readq.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_readq.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_readq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_readq.c	2010-04-13 02:19:02.311570577 +0000
@@ -25,6 +25,7 @@
 #include <sound/seq_oss_legacy.h>
 #include "../seq_lock.h"
 #include <linux/wait.h>
+#include <linux/slab.h>
 
 /*
  * constants
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_synth.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_synth.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_synth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_synth.c	2010-04-13 02:19:02.311570577 +0000
@@ -24,6 +24,7 @@
 #include "seq_oss_midi.h"
 #include "../seq_lock.h"
 #include <linux/init.h>
+#include <linux/slab.h>
 
 /*
  * constants
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_timer.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_timer.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_timer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_timer.c	2010-04-13 02:19:02.311570577 +0000
@@ -23,6 +23,7 @@
 #include "seq_oss_timer.h"
 #include "seq_oss_event.h"
 #include <sound/seq_oss_legacy.h>
+#include <linux/slab.h>
 
 /*
  */
diff -urN linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_writeq.c linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_writeq.c
--- linux-2.6.34-rc3/sound/core/seq/oss/seq_oss_writeq.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/oss/seq_oss_writeq.c	2010-04-13 02:19:02.311570577 +0000
@@ -27,6 +27,7 @@
 #include "../seq_lock.h"
 #include "../seq_clientmgr.h"
 #include <linux/wait.h>
+#include <linux/slab.h>
 
 
 /*
diff -urN linux-2.6.34-rc3/sound/core/seq/seq_compat.c linux-2.6.34-rc4/sound/core/seq/seq_compat.c
--- linux-2.6.34-rc3/sound/core/seq/seq_compat.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/seq_compat.c	2010-04-13 02:19:02.311570577 +0000
@@ -21,6 +21,7 @@
 /* This file included from seq.c */
 
 #include <linux/compat.h>
+#include <linux/slab.h>
 
 struct snd_seq_port_info32 {
 	struct snd_seq_addr addr;	/* client/port numbers */
diff -urN linux-2.6.34-rc3/sound/core/seq/seq_system.c linux-2.6.34-rc4/sound/core/seq/seq_system.c
--- linux-2.6.34-rc3/sound/core/seq/seq_system.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/core/seq/seq_system.c	2010-04-13 02:19:02.311570577 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include "seq_system.h"
 #include "seq_timer.h"
diff -urN linux-2.6.34-rc3/sound/drivers/ml403-ac97cr.c linux-2.6.34-rc4/sound/drivers/ml403-ac97cr.c
--- linux-2.6.34-rc3/sound/drivers/ml403-ac97cr.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/ml403-ac97cr.c	2010-04-13 02:19:02.312883789 +0000
@@ -39,6 +39,7 @@
 #include <linux/platform_device.h>
 
 #include <linux/ioport.h>
+#include <linux/slab.h>
 #include <linux/io.h>
 #include <linux/interrupt.h>
 
diff -urN linux-2.6.34-rc3/sound/drivers/mtpav.c linux-2.6.34-rc4/sound/drivers/mtpav.c
--- linux-2.6.34-rc3/sound/drivers/mtpav.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/mtpav.c	2010-04-13 02:19:02.312883789 +0000
@@ -54,7 +54,6 @@
 #include <linux/interrupt.h>
 #include <linux/err.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/drivers/mts64.c linux-2.6.34-rc4/sound/drivers/mts64.c
--- linux-2.6.34-rc3/sound/drivers/mts64.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/mts64.c	2010-04-13 02:19:02.313884034 +0000
@@ -23,6 +23,7 @@
 #include <linux/parport.h>
 #include <linux/spinlock.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/initval.h>
 #include <sound/rawmidi.h>
diff -urN linux-2.6.34-rc3/sound/drivers/opl3/opl3_oss.c linux-2.6.34-rc4/sound/drivers/opl3/opl3_oss.c
--- linux-2.6.34-rc3/sound/drivers/opl3/opl3_oss.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/opl3/opl3_oss.c	2010-04-13 02:19:02.313884034 +0000
@@ -19,7 +19,6 @@
  */
 
 #include "opl3_voice.h"
-#include <linux/slab.h>
 
 static int snd_opl3_open_seq_oss(struct snd_seq_oss_arg *arg, void *closure);
 static int snd_opl3_close_seq_oss(struct snd_seq_oss_arg *arg);
diff -urN linux-2.6.34-rc3/sound/drivers/opl3/opl3_synth.c linux-2.6.34-rc4/sound/drivers/opl3/opl3_synth.c
--- linux-2.6.34-rc3/sound/drivers/opl3/opl3_synth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/opl3/opl3_synth.c	2010-04-13 02:19:02.313884034 +0000
@@ -19,6 +19,7 @@
  *
  */
 
+#include <linux/slab.h>
 #include <sound/opl3.h>
 #include <sound/asound_fm.h>
 
diff -urN linux-2.6.34-rc3/sound/drivers/opl4/opl4_lib.c linux-2.6.34-rc4/sound/drivers/opl4/opl4_lib.c
--- linux-2.6.34-rc3/sound/drivers/opl4/opl4_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/opl4/opl4_lib.c	2010-04-13 02:19:02.313884034 +0000
@@ -20,6 +20,7 @@
 #include "opl4_local.h"
 #include <sound/initval.h>
 #include <linux/ioport.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <asm/io.h>
 
diff -urN linux-2.6.34-rc3/sound/drivers/pcsp/pcsp_lib.c linux-2.6.34-rc4/sound/drivers/pcsp/pcsp_lib.c
--- linux-2.6.34-rc3/sound/drivers/pcsp/pcsp_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/pcsp/pcsp_lib.c	2010-04-13 02:19:02.313884034 +0000
@@ -7,6 +7,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/moduleparam.h>
 #include <linux/interrupt.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/drivers/portman2x4.c linux-2.6.34-rc4/sound/drivers/portman2x4.c
--- linux-2.6.34-rc3/sound/drivers/portman2x4.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/portman2x4.c	2010-04-13 02:19:02.313884034 +0000
@@ -42,6 +42,7 @@
 #include <linux/parport.h>
 #include <linux/spinlock.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/initval.h>
 #include <sound/rawmidi.h>
diff -urN linux-2.6.34-rc3/sound/drivers/vx/vx_hwdep.c linux-2.6.34-rc4/sound/drivers/vx/vx_hwdep.c
--- linux-2.6.34-rc3/sound/drivers/vx/vx_hwdep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/drivers/vx/vx_hwdep.c	2010-04-13 02:19:02.313884034 +0000
@@ -22,6 +22,7 @@
 
 #include <linux/device.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <sound/core.h>
 #include <sound/hwdep.h>
diff -urN linux-2.6.34-rc3/sound/i2c/other/ak4113.c linux-2.6.34-rc4/sound/i2c/other/ak4113.c
--- linux-2.6.34-rc3/sound/i2c/other/ak4113.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/i2c/other/ak4113.c	2010-04-13 02:19:02.314883238 +0000
@@ -70,7 +70,7 @@
 }
 
 int snd_ak4113_create(struct snd_card *card, ak4113_read_t *read,
-		ak4113_write_t *write, const unsigned char pgm[5],
+		ak4113_write_t *write, const unsigned char *pgm,
 		void *private_data, struct ak4113 **r_ak4113)
 {
 	struct ak4113 *chip;
diff -urN linux-2.6.34-rc3/sound/i2c/other/tea575x-tuner.c linux-2.6.34-rc4/sound/i2c/other/tea575x-tuner.c
--- linux-2.6.34-rc3/sound/i2c/other/tea575x-tuner.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/i2c/other/tea575x-tuner.c	2010-04-13 02:19:02.314883238 +0000
@@ -24,6 +24,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/version.h>
 #include <sound/core.h>
 #include <sound/tea575x-tuner.h>
diff -urN linux-2.6.34-rc3/sound/isa/cmi8330.c linux-2.6.34-rc4/sound/isa/cmi8330.c
--- linux-2.6.34-rc3/sound/isa/cmi8330.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/cmi8330.c	2010-04-13 02:19:02.314883238 +0000
@@ -46,7 +46,6 @@
 #include <linux/init.h>
 #include <linux/err.h>
 #include <linux/isa.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/isa/cs423x/cs4236.c linux-2.6.34-rc4/sound/isa/cs423x/cs4236.c
--- linux-2.6.34-rc3/sound/isa/cs423x/cs4236.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/cs423x/cs4236.c	2010-04-13 02:19:02.315883546 +0000
@@ -22,7 +22,6 @@
 #include <linux/init.h>
 #include <linux/err.h>
 #include <linux/isa.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/isa/es18xx.c linux-2.6.34-rc4/sound/isa/es18xx.c
--- linux-2.6.34-rc3/sound/isa/es18xx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/es18xx.c	2010-04-13 02:19:02.315883546 +0000
@@ -80,7 +80,6 @@
 #include <linux/init.h>
 #include <linux/err.h>
 #include <linux/isa.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/isapnp.h>
 #include <linux/moduleparam.h>
diff -urN linux-2.6.34-rc3/sound/isa/gus/interwave.c linux-2.6.34-rc4/sound/isa/gus/interwave.c
--- linux-2.6.34-rc3/sound/isa/gus/interwave.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/gus/interwave.c	2010-04-13 02:19:02.315883546 +0000
@@ -26,7 +26,6 @@
 #include <linux/err.h>
 #include <linux/isa.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/moduleparam.h>
 #include <asm/dma.h>
diff -urN linux-2.6.34-rc3/sound/isa/msnd/msnd_midi.c linux-2.6.34-rc4/sound/isa/msnd/msnd_midi.c
--- linux-2.6.34-rc3/sound/isa/msnd/msnd_midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/msnd/msnd_midi.c	2010-04-13 02:19:02.315883546 +0000
@@ -25,6 +25,7 @@
  */
 
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/ioport.h>
 #include <linux/errno.h>
diff -urN linux-2.6.34-rc3/sound/isa/opl3sa2.c linux-2.6.34-rc4/sound/isa/opl3sa2.c
--- linux-2.6.34-rc3/sound/isa/opl3sa2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/opl3sa2.c	2010-04-13 02:19:02.316883476 +0000
@@ -24,7 +24,6 @@
 #include <linux/isa.h>
 #include <linux/interrupt.h>
 #include <linux/pm.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/isa/opti9xx/miro.c linux-2.6.34-rc4/sound/isa/opti9xx/miro.c
--- linux-2.6.34-rc3/sound/isa/opti9xx/miro.c	2010-04-13 02:18:56.788633050 +0000
+++ linux-2.6.34-rc4/sound/isa/opti9xx/miro.c	2010-04-13 02:19:02.316883476 +0000
@@ -27,7 +27,6 @@
 #include <linux/isa.h>
 #include <linux/pnp.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/moduleparam.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/sound/isa/opti9xx/opti92x-ad1848.c linux-2.6.34-rc4/sound/isa/opti9xx/opti92x-ad1848.c
--- linux-2.6.34-rc3/sound/isa/opti9xx/opti92x-ad1848.c	2010-04-13 02:18:56.788633050 +0000
+++ linux-2.6.34-rc4/sound/isa/opti9xx/opti92x-ad1848.c	2010-04-13 02:19:02.316883476 +0000
@@ -27,7 +27,6 @@
 #include <linux/err.h>
 #include <linux/isa.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/moduleparam.h>
 #include <asm/io.h>
diff -urN linux-2.6.34-rc3/sound/isa/sb/emu8000_pcm.c linux-2.6.34-rc4/sound/isa/sb/emu8000_pcm.c
--- linux-2.6.34-rc3/sound/isa/sb/emu8000_pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/sb/emu8000_pcm.c	2010-04-13 02:19:02.317883451 +0000
@@ -20,6 +20,7 @@
 
 #include "emu8000_local.h"
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <sound/initval.h>
 #include <sound/pcm.h>
 
diff -urN linux-2.6.34-rc3/sound/isa/sb/sb16.c linux-2.6.34-rc4/sound/isa/sb/sb16.c
--- linux-2.6.34-rc3/sound/isa/sb/sb16.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/sb/sb16.c	2010-04-13 02:19:02.317883451 +0000
@@ -21,7 +21,6 @@
 
 #include <asm/dma.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/pnp.h>
 #include <linux/err.h>
 #include <linux/isa.h>
diff -urN linux-2.6.34-rc3/sound/isa/sb/sb8.c linux-2.6.34-rc4/sound/isa/sb/sb8.c
--- linux-2.6.34-rc3/sound/isa/sb/sb8.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/sb/sb8.c	2010-04-13 02:19:02.317883451 +0000
@@ -22,7 +22,6 @@
 #include <linux/init.h>
 #include <linux/err.h>
 #include <linux/isa.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/isa/wavefront/wavefront.c linux-2.6.34-rc4/sound/isa/wavefront/wavefront.c
--- linux-2.6.34-rc3/sound/isa/wavefront/wavefront.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/wavefront/wavefront.c	2010-04-13 02:19:02.318604614 +0000
@@ -21,7 +21,6 @@
 
 #include <linux/init.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/err.h>
 #include <linux/isa.h>
 #include <linux/pnp.h>
diff -urN linux-2.6.34-rc3/sound/isa/wavefront/wavefront_fx.c linux-2.6.34-rc4/sound/isa/wavefront/wavefront_fx.c
--- linux-2.6.34-rc3/sound/isa/wavefront/wavefront_fx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/wavefront/wavefront_fx.c	2010-04-13 02:19:02.318604614 +0000
@@ -20,6 +20,7 @@
 #include <linux/init.h>
 #include <linux/time.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/firmware.h>
 #include <sound/core.h>
 #include <sound/snd_wavefront.h>
diff -urN linux-2.6.34-rc3/sound/isa/wavefront/wavefront_synth.c linux-2.6.34-rc4/sound/isa/wavefront/wavefront_synth.c
--- linux-2.6.34-rc3/sound/isa/wavefront/wavefront_synth.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/isa/wavefront/wavefront_synth.c	2010-04-13 02:19:02.318604614 +0000
@@ -28,6 +28,7 @@
 #include <linux/wait.h>
 #include <linux/firmware.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/snd_wavefront.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/mips/hal2.c linux-2.6.34-rc4/sound/mips/hal2.c
--- linux-2.6.34-rc3/sound/mips/hal2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/mips/hal2.c	2010-04-13 02:19:02.319883965 +0000
@@ -25,6 +25,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/sgi/hpc3.h>
 #include <asm/sgi/ip22.h>
diff -urN linux-2.6.34-rc3/sound/mips/sgio2audio.c linux-2.6.34-rc4/sound/mips/sgio2audio.c
--- linux-2.6.34-rc3/sound/mips/sgio2audio.c	2010-04-13 02:18:56.790570445 +0000
+++ linux-2.6.34-rc4/sound/mips/sgio2audio.c	2010-04-13 02:19:02.319883965 +0000
@@ -25,11 +25,11 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/spinlock.h>
-#include <linux/gfp.h>
 #include <linux/interrupt.h>
 #include <linux/dma-mapping.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <asm/ip32/ip32_ints.h>
 #include <asm/ip32/mace.h>
diff -urN linux-2.6.34-rc3/sound/oss/ad1848.c linux-2.6.34-rc4/sound/oss/ad1848.c
--- linux-2.6.34-rc3/sound/oss/ad1848.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/ad1848.c	2010-04-13 02:19:02.320884189 +0000
@@ -45,6 +45,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/stddef.h>
+#include <linux/slab.h>
 #include <linux/isapnp.h>
 #include <linux/pnp.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/sound/oss/dmabuf.c linux-2.6.34-rc4/sound/oss/dmabuf.c
--- linux-2.6.34-rc3/sound/oss/dmabuf.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/dmabuf.c	2010-04-13 02:19:02.320884189 +0000
@@ -26,6 +26,7 @@
 #define SAMPLE_ROUNDUP 0
 
 #include <linux/mm.h>
+#include <linux/gfp.h>
 #include "sound_config.h"
 
 #define DMAP_FREE_ON_CLOSE      0
diff -urN linux-2.6.34-rc3/sound/oss/kahlua.c linux-2.6.34-rc4/sound/oss/kahlua.c
--- linux-2.6.34-rc3/sound/oss/kahlua.c	2010-04-13 02:18:56.790570445 +0000
+++ linux-2.6.34-rc4/sound/oss/kahlua.c	2010-04-13 02:19:02.320884189 +0000
@@ -31,6 +31,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 
 #include "sound_config.h"
 
diff -urN linux-2.6.34-rc3/sound/oss/mpu401.c linux-2.6.34-rc4/sound/oss/mpu401.c
--- linux-2.6.34-rc3/sound/oss/mpu401.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/mpu401.c	2010-04-13 02:19:02.321883438 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/spinlock.h>
diff -urN linux-2.6.34-rc3/sound/oss/msnd.c linux-2.6.34-rc4/sound/oss/msnd.c
--- linux-2.6.34-rc3/sound/oss/msnd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/msnd.c	2010-04-13 02:19:02.321883438 +0000
@@ -24,7 +24,6 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/vmalloc.h>
 #include <linux/types.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/sound/oss/msnd_pinnacle.c linux-2.6.34-rc4/sound/oss/msnd_pinnacle.c
--- linux-2.6.34-rc3/sound/oss/msnd_pinnacle.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/msnd_pinnacle.c	2010-04-13 02:19:02.321883438 +0000
@@ -35,12 +35,12 @@
 
 #include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/slab.h>
 #include <linux/types.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/smp_lock.h>
+#include <linux/gfp.h>
 #include <asm/irq.h>
 #include <asm/io.h>
 #include "sound_config.h"
diff -urN linux-2.6.34-rc3/sound/oss/opl3.c linux-2.6.34-rc4/sound/oss/opl3.c
--- linux-2.6.34-rc3/sound/oss/opl3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/opl3.c	2010-04-13 02:19:02.321883438 +0000
@@ -24,6 +24,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/delay.h>
 
diff -urN linux-2.6.34-rc3/sound/oss/sb_card.c linux-2.6.34-rc4/sound/oss/sb_card.c
--- linux-2.6.34-rc3/sound/oss/sb_card.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/sb_card.c	2010-04-13 02:19:02.321883438 +0000
@@ -24,6 +24,7 @@
 
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include "sound_config.h"
 #include "sb_mixer.h"
diff -urN linux-2.6.34-rc3/sound/oss/sb_common.c linux-2.6.34-rc4/sound/oss/sb_common.c
--- linux-2.6.34-rc3/sound/oss/sb_common.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/sb_common.c	2010-04-13 02:19:02.322883591 +0000
@@ -31,6 +31,7 @@
 #include <linux/module.h>
 #include <linux/delay.h>
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include "sound_config.h"
 #include "sound_firmware.h"
diff -urN linux-2.6.34-rc3/sound/oss/sb_midi.c linux-2.6.34-rc4/sound/oss/sb_midi.c
--- linux-2.6.34-rc3/sound/oss/sb_midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/sb_midi.c	2010-04-13 02:19:02.322883591 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 
 #include "sound_config.h"
 
diff -urN linux-2.6.34-rc3/sound/oss/sb_mixer.c linux-2.6.34-rc4/sound/oss/sb_mixer.c
--- linux-2.6.34-rc3/sound/oss/sb_mixer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/sb_mixer.c	2010-04-13 02:19:02.322883591 +0000
@@ -16,6 +16,8 @@
  * Stanislav Voronyi <stas@esc.kharkov.com>	: Support for AWE 3DSE device (Jun 7 1999)
  */
 
+#include <linux/slab.h>
+
 #include "sound_config.h"
 
 #define __SB_MIXER_C__
diff -urN linux-2.6.34-rc3/sound/oss/soundcard.c linux-2.6.34-rc4/sound/oss/soundcard.c
--- linux-2.6.34-rc3/sound/oss/soundcard.c	2010-04-13 02:18:56.791633128 +0000
+++ linux-2.6.34-rc4/sound/oss/soundcard.c	2010-04-13 02:19:02.322883591 +0000
@@ -36,7 +36,6 @@
 #include <asm/dma.h>
 #include <asm/io.h>
 #include <linux/wait.h>
-#include <linux/slab.h>
 #include <linux/ioport.h>
 #include <linux/major.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/sound/oss/uart401.c linux-2.6.34-rc4/sound/oss/uart401.c
--- linux-2.6.34-rc3/sound/oss/uart401.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/uart401.c	2010-04-13 02:19:02.322883591 +0000
@@ -24,6 +24,7 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include "sound_config.h"
 
diff -urN linux-2.6.34-rc3/sound/oss/v_midi.c linux-2.6.34-rc4/sound/oss/v_midi.c
--- linux-2.6.34-rc3/sound/oss/v_midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/v_midi.c	2010-04-13 02:19:02.322883591 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/spinlock.h>
 #include "sound_config.h"
 
diff -urN linux-2.6.34-rc3/sound/oss/vidc.c linux-2.6.34-rc4/sound/oss/vidc.c
--- linux-2.6.34-rc3/sound/oss/vidc.c	2010-04-13 02:18:56.791633128 +0000
+++ linux-2.6.34-rc4/sound/oss/vidc.c	2010-04-13 02:19:02.323883791 +0000
@@ -17,6 +17,7 @@
  * We currently support a mixer device, but it is currently non-functional.
  */
 
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
diff -urN linux-2.6.34-rc3/sound/oss/vwsnd.c linux-2.6.34-rc4/sound/oss/vwsnd.c
--- linux-2.6.34-rc3/sound/oss/vwsnd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/vwsnd.c	2010-04-13 02:19:02.323883791 +0000
@@ -149,6 +149,7 @@
 #include <linux/wait.h>
 #include <linux/interrupt.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <asm/visws/cobalt.h>
 
diff -urN linux-2.6.34-rc3/sound/oss/waveartist.c linux-2.6.34-rc4/sound/oss/waveartist.c
--- linux-2.6.34-rc3/sound/oss/waveartist.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/oss/waveartist.c	2010-04-13 02:19:02.323883791 +0000
@@ -35,6 +35,7 @@
 
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/sched.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/sound/pci/ac97/ac97_proc.c linux-2.6.34-rc4/sound/pci/ac97/ac97_proc.c
--- linux-2.6.34-rc3/sound/pci/ac97/ac97_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ac97/ac97_proc.c	2010-04-13 02:19:02.324883190 +0000
@@ -22,7 +22,6 @@
  *
  */
 
-#include <linux/slab.h>
 #include <linux/mutex.h>
 
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/als4000.c linux-2.6.34-rc4/sound/pci/als4000.c
--- linux-2.6.34-rc3/sound/pci/als4000.c	2010-04-13 02:18:56.792633019 +0000
+++ linux-2.6.34-rc4/sound/pci/als4000.c	2010-04-13 02:19:02.325757566 +0000
@@ -68,7 +68,6 @@
 #include <asm/io.h>
 #include <linux/init.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/gameport.h>
 #include <linux/moduleparam.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/sound/pci/aw2/aw2-saa7146.c linux-2.6.34-rc4/sound/pci/aw2/aw2-saa7146.c
--- linux-2.6.34-rc3/sound/pci/aw2/aw2-saa7146.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/aw2/aw2-saa7146.c	2010-04-13 02:19:02.326883821 +0000
@@ -25,7 +25,6 @@
 
 #include <linux/init.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
 #include <asm/system.h>
diff -urN linux-2.6.34-rc3/sound/pci/ca0106/ca0106_mixer.c linux-2.6.34-rc4/sound/pci/ca0106/ca0106_mixer.c
--- linux-2.6.34-rc3/sound/pci/ca0106/ca0106_mixer.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ca0106/ca0106_mixer.c	2010-04-13 02:19:02.327883805 +0000
@@ -63,7 +63,6 @@
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/pci/ca0106/ca0106_proc.c linux-2.6.34-rc4/sound/pci/ca0106/ca0106_proc.c
--- linux-2.6.34-rc3/sound/pci/ca0106/ca0106_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ca0106/ca0106_proc.c	2010-04-13 02:19:02.327883805 +0000
@@ -63,7 +63,6 @@
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <sound/core.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/pci/cs5530.c linux-2.6.34-rc4/sound/pci/cs5530.c
--- linux-2.6.34-rc3/sound/pci/cs5530.c	2010-04-13 02:18:56.796633036 +0000
+++ linux-2.6.34-rc4/sound/pci/cs5530.c	2010-04-13 02:19:02.330571087 +0000
@@ -39,6 +39,7 @@
 #include <linux/delay.h>
 #include <linux/moduleparam.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/sb.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/pci/cs5535audio/cs5535audio_pcm.c linux-2.6.34-rc4/sound/pci/cs5535audio/cs5535audio_pcm.c
--- linux-2.6.34-rc3/sound/pci/cs5535audio/cs5535audio_pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/cs5535audio/cs5535audio_pcm.c	2010-04-13 02:19:02.330571087 +0000
@@ -23,7 +23,6 @@
  */
 
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <sound/core.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/cs5535audio/cs5535audio_pm.c linux-2.6.34-rc4/sound/pci/cs5535audio/cs5535audio_pm.c
--- linux-2.6.34-rc3/sound/pci/cs5535audio/cs5535audio_pm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/cs5535audio/cs5535audio_pm.c	2010-04-13 02:19:02.330571087 +0000
@@ -19,7 +19,6 @@
  */
 
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/ctxfi/ctatc.c linux-2.6.34-rc4/sound/pci/ctxfi/ctatc.c
--- linux-2.6.34-rc3/sound/pci/ctxfi/ctatc.c	2010-04-13 02:18:56.796633036 +0000
+++ linux-2.6.34-rc4/sound/pci/ctxfi/ctatc.c	2010-04-13 02:19:02.331570471 +0000
@@ -24,6 +24,7 @@
 #include "ctdaio.h"
 #include "cttimer.h"
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/pcm.h>
 #include <sound/control.h>
 #include <sound/asoundef.h>
diff -urN linux-2.6.34-rc3/sound/pci/ctxfi/ctpcm.c linux-2.6.34-rc4/sound/pci/ctxfi/ctpcm.c
--- linux-2.6.34-rc3/sound/pci/ctxfi/ctpcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ctxfi/ctpcm.c	2010-04-13 02:19:02.331570471 +0000
@@ -17,6 +17,7 @@
 
 #include "ctpcm.h"
 #include "cttimer.h"
+#include <linux/slab.h>
 #include <sound/pcm.h>
 
 /* Hardware descriptions for playback */
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/darla20.c linux-2.6.34-rc4/sound/pci/echoaudio/darla20.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/darla20.c	2010-04-13 02:18:56.797633035 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/darla20.c	2010-04-13 02:19:02.331570471 +0000
@@ -40,9 +40,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/darla24.c linux-2.6.34-rc4/sound/pci/echoaudio/darla24.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/darla24.c	2010-04-13 02:18:56.797633035 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/darla24.c	2010-04-13 02:19:02.331570471 +0000
@@ -44,9 +44,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/echo3g.c linux-2.6.34-rc4/sound/pci/echoaudio/echo3g.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/echo3g.c	2010-04-13 02:18:56.797633035 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/echo3g.c	2010-04-13 02:19:02.331570471 +0000
@@ -51,9 +51,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/echoaudio.c linux-2.6.34-rc4/sound/pci/echoaudio/echoaudio.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/echoaudio.c	2010-04-13 02:18:56.798633037 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/echoaudio.c	2010-04-13 02:19:02.332883284 +0000
@@ -2184,10 +2184,9 @@
 			goto ctl_error;
 #endif
 
-	if ((err = snd_card_register(card)) < 0) {
-		snd_card_free(card);
+	err = snd_card_register(card);
+	if (err < 0)
 		goto ctl_error;
-	}
 	snd_printk(KERN_INFO "Card registered: %s\n", card->longname);
 
 	pci_set_drvdata(pci, chip);
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/gina20.c linux-2.6.34-rc4/sound/pci/echoaudio/gina20.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/gina20.c	2010-04-13 02:18:56.798633037 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/gina20.c	2010-04-13 02:19:02.333629430 +0000
@@ -44,9 +44,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/gina24.c linux-2.6.34-rc4/sound/pci/echoaudio/gina24.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/gina24.c	2010-04-13 02:18:56.798633037 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/gina24.c	2010-04-13 02:19:02.333629430 +0000
@@ -50,9 +50,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/indigo.c linux-2.6.34-rc4/sound/pci/echoaudio/indigo.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/indigo.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/indigo.c	2010-04-13 02:19:02.333629430 +0000
@@ -42,9 +42,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/indigodj.c linux-2.6.34-rc4/sound/pci/echoaudio/indigodj.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/indigodj.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/indigodj.c	2010-04-13 02:19:02.333629430 +0000
@@ -42,9 +42,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/indigodjx.c linux-2.6.34-rc4/sound/pci/echoaudio/indigodjx.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/indigodjx.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/indigodjx.c	2010-04-13 02:19:02.333629430 +0000
@@ -42,10 +42,10 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/indigoio.c linux-2.6.34-rc4/sound/pci/echoaudio/indigoio.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/indigoio.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/indigoio.c	2010-04-13 02:19:02.333629430 +0000
@@ -43,9 +43,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/indigoiox.c linux-2.6.34-rc4/sound/pci/echoaudio/indigoiox.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/indigoiox.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/indigoiox.c	2010-04-13 02:19:02.334883633 +0000
@@ -43,10 +43,10 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/layla20.c linux-2.6.34-rc4/sound/pci/echoaudio/layla20.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/layla20.c	2010-04-13 02:18:56.799572020 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/layla20.c	2010-04-13 02:19:02.334883633 +0000
@@ -49,9 +49,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/layla24.c linux-2.6.34-rc4/sound/pci/echoaudio/layla24.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/layla24.c	2010-04-13 02:18:56.800570477 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/layla24.c	2010-04-13 02:19:02.334883633 +0000
@@ -51,9 +51,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/mia.c linux-2.6.34-rc4/sound/pci/echoaudio/mia.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/mia.c	2010-04-13 02:18:56.800570477 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/mia.c	2010-04-13 02:19:02.334883633 +0000
@@ -50,9 +50,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/echoaudio/mona.c linux-2.6.34-rc4/sound/pci/echoaudio/mona.c
--- linux-2.6.34-rc3/sound/pci/echoaudio/mona.c	2010-04-13 02:18:56.800570477 +0000
+++ linux-2.6.34-rc4/sound/pci/echoaudio/mona.c	2010-04-13 02:19:02.334883633 +0000
@@ -48,9 +48,9 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/firmware.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/emu10k1/memory.c linux-2.6.34-rc4/sound/pci/emu10k1/memory.c
--- linux-2.6.34-rc3/sound/pci/emu10k1/memory.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/emu10k1/memory.c	2010-04-13 02:19:02.335883581 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/pci.h>
+#include <linux/gfp.h>
 #include <linux/time.h>
 #include <linux/mutex.h>
 
diff -urN linux-2.6.34-rc3/sound/pci/hda/hda_beep.c linux-2.6.34-rc4/sound/pci/hda/hda_beep.c
--- linux-2.6.34-rc3/sound/pci/hda/hda_beep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/hda/hda_beep.c	2010-04-13 02:19:02.337883621 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/input.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <linux/workqueue.h>
 #include <sound/core.h>
 #include "hda_beep.h"
diff -urN linux-2.6.34-rc3/sound/pci/hda/hda_eld.c linux-2.6.34-rc4/sound/pci/hda/hda_eld.c
--- linux-2.6.34-rc3/sound/pci/hda/hda_eld.c	2010-04-13 02:18:56.803633065 +0000
+++ linux-2.6.34-rc4/sound/pci/hda/hda_eld.c	2010-04-13 02:19:02.338883521 +0000
@@ -22,6 +22,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <asm/unaligned.h>
 #include "hda_codec.h"
diff -urN linux-2.6.34-rc3/sound/pci/hda/hda_intel.c linux-2.6.34-rc4/sound/pci/hda/hda_intel.c
--- linux-2.6.34-rc3/sound/pci/hda/hda_intel.c	2010-04-13 02:18:56.804633043 +0000
+++ linux-2.6.34-rc4/sound/pci/hda/hda_intel.c	2010-04-13 02:19:02.339883829 +0000
@@ -2362,6 +2362,7 @@
 	SND_PCI_QUIRK(0x1043, 0x81f6, "ASUS", 0), /* nvidia */
 	SND_PCI_QUIRK(0x1043, 0x822d, "ASUS", 0), /* Athlon64 X2 + nvidia MCP55 */
 	SND_PCI_QUIRK(0x1849, 0x0888, "ASRock", 0), /* Athlon64 X2 + nvidia */
+	SND_PCI_QUIRK(0xa0a0, 0x0575, "Aopen MZ915-M", 0), /* ICH6 */
 	{}
 };
 
diff -urN linux-2.6.34-rc3/sound/pci/hda/patch_analog.c linux-2.6.34-rc4/sound/pci/hda/patch_analog.c
--- linux-2.6.34-rc3/sound/pci/hda/patch_analog.c	2010-04-13 02:18:56.805570979 +0000
+++ linux-2.6.34-rc4/sound/pci/hda/patch_analog.c	2010-04-13 02:19:02.340884299 +0000
@@ -1896,6 +1896,14 @@
 	case AD1981_THINKPAD:
 		spec->mixers[0] = ad1981_thinkpad_mixers;
 		spec->input_mux = &ad1981_thinkpad_capture_source;
+		/* set the upper-limit for mixer amp to 0dB for avoiding the
+		 * possible damage by overloading
+		 */
+		snd_hda_override_amp_caps(codec, 0x11, HDA_INPUT,
+					  (0x17 << AC_AMPCAP_OFFSET_SHIFT) |
+					  (0x17 << AC_AMPCAP_NUM_STEPS_SHIFT) |
+					  (0x05 << AC_AMPCAP_STEP_SIZE_SHIFT) |
+					  (1 << AC_AMPCAP_MUTE_SHIFT));
 		break;
 	case AD1981_TOSHIBA:
 		spec->mixers[0] = ad1981_hp_mixers;
diff -urN linux-2.6.34-rc3/sound/pci/hda/patch_realtek.c linux-2.6.34-rc4/sound/pci/hda/patch_realtek.c
--- linux-2.6.34-rc3/sound/pci/hda/patch_realtek.c	2010-04-13 02:18:56.811570607 +0000
+++ linux-2.6.34-rc4/sound/pci/hda/patch_realtek.c	2010-04-13 02:19:02.347883303 +0000
@@ -1621,6 +1621,11 @@
  */
 
 static struct hda_verb alc888_acer_aspire_6530g_verbs[] = {
+/* Route to built-in subwoofer as well as speakers */
+	{0x0c, AC_VERB_SET_AMP_GAIN_MUTE, AMP_IN_UNMUTE(0)},
+	{0x0c, AC_VERB_SET_AMP_GAIN_MUTE, AMP_IN_UNMUTE(1)},
+	{0x0f, AC_VERB_SET_AMP_GAIN_MUTE, AMP_IN_UNMUTE(0)},
+	{0x0f, AC_VERB_SET_AMP_GAIN_MUTE, AMP_IN_UNMUTE(1)},
 /* Bias voltage on for external mic port */
 	{0x18, AC_VERB_SET_PIN_WIDGET_CONTROL, PIN_IN | PIN_VREF80},
 /* Front Mic: set to PIN_IN (empty by default) */
@@ -1632,10 +1637,12 @@
 /* Enable speaker output */
 	{0x14, AC_VERB_SET_PIN_WIDGET_CONTROL, PIN_OUT},
 	{0x14, AC_VERB_SET_AMP_GAIN_MUTE, AMP_OUT_UNMUTE},
+	{0x14, AC_VERB_SET_EAPD_BTLENABLE, 2},
 /* Enable headphone output */
 	{0x15, AC_VERB_SET_PIN_WIDGET_CONTROL, PIN_OUT | PIN_HP},
 	{0x15, AC_VERB_SET_AMP_GAIN_MUTE, AMP_OUT_UNMUTE},
 	{0x15, AC_VERB_SET_CONNECT_SEL, 0x00},
+	{0x15, AC_VERB_SET_EAPD_BTLENABLE, 2},
 	{ }
 };
 
@@ -4984,6 +4991,70 @@
 	}
 }
 
+/* fill adc_nids (and capsrc_nids) containing all active input pins */
+static void fillup_priv_adc_nids(struct hda_codec *codec, hda_nid_t *nids,
+				 int num_nids)
+{
+	struct alc_spec *spec = codec->spec;
+	int n;
+	hda_nid_t fallback_adc = 0, fallback_cap = 0;
+
+	for (n = 0; n < num_nids; n++) {
+		hda_nid_t adc, cap;
+		hda_nid_t conn[HDA_MAX_NUM_INPUTS];
+		int nconns, i, j;
+
+		adc = nids[n];
+		if (get_wcaps_type(get_wcaps(codec, adc)) != AC_WID_AUD_IN)
+			continue;
+		cap = adc;
+		nconns = snd_hda_get_connections(codec, cap, conn,
+						 ARRAY_SIZE(conn));
+		if (nconns == 1) {
+			cap = conn[0];
+			nconns = snd_hda_get_connections(codec, cap, conn,
+							 ARRAY_SIZE(conn));
+		}
+		if (nconns <= 0)
+			continue;
+		if (!fallback_adc) {
+			fallback_adc = adc;
+			fallback_cap = cap;
+		}
+		for (i = 0; i < AUTO_PIN_LAST; i++) {
+			hda_nid_t nid = spec->autocfg.input_pins[i];
+			if (!nid)
+				continue;
+			for (j = 0; j < nconns; j++) {
+				if (conn[j] == nid)
+					break;
+			}
+			if (j >= nconns)
+				break;
+		}
+		if (i >= AUTO_PIN_LAST) {
+			int num_adcs = spec->num_adc_nids;
+			spec->private_adc_nids[num_adcs] = adc;
+			spec->private_capsrc_nids[num_adcs] = cap;
+			spec->num_adc_nids++;
+			spec->adc_nids = spec->private_adc_nids;
+			if (adc != cap)
+				spec->capsrc_nids = spec->private_capsrc_nids;
+		}
+	}
+	if (!spec->num_adc_nids) {
+		printk(KERN_WARNING "hda_codec: %s: no valid ADC found;"
+		       " using fallback 0x%x\n",
+		       codec->chip_name, fallback_adc);
+		spec->private_adc_nids[0] = fallback_adc;
+		spec->adc_nids = spec->private_adc_nids;
+		if (fallback_adc != fallback_cap) {
+			spec->private_capsrc_nids[0] = fallback_cap;
+			spec->capsrc_nids = spec->private_adc_nids;
+		}
+	}
+}
+
 #ifdef CONFIG_SND_HDA_INPUT_BEEP
 #define set_beep_amp(spec, nid, idx, dir) \
 	((spec)->beep_amp = HDA_COMPOSE_AMP_VAL(nid, 3, idx, dir))
@@ -8398,9 +8469,7 @@
 
 static struct snd_kcontrol_new alc888_acer_aspire_6530_mixer[] = {
 	HDA_CODEC_VOLUME("Front Playback Volume", 0x0c, 0x0, HDA_OUTPUT),
-	HDA_BIND_MUTE("Front Playback Switch", 0x0c, 2, HDA_INPUT),
 	HDA_CODEC_VOLUME("LFE Playback Volume", 0x0f, 0x0, HDA_OUTPUT),
-	HDA_BIND_MUTE("LFE Playback Switch", 0x0f, 2, HDA_INPUT),
 	HDA_CODEC_VOLUME("Line Playback Volume", 0x0b, 0x02, HDA_INPUT),
 	HDA_CODEC_MUTE("Line Playback Switch", 0x0b, 0x02, HDA_INPUT),
 	HDA_CODEC_VOLUME("CD Playback Volume", 0x0b, 0x04, HDA_INPUT),
@@ -10041,13 +10110,12 @@
 	int idx;
 
 	alc_set_pin_output(codec, nid, pin_type);
+	if (dac_idx >= spec->multiout.num_dacs)
+		return;
 	if (spec->multiout.dac_nids[dac_idx] == 0x25)
 		idx = 4;
-	else {
-		if (spec->multiout.num_dacs >= dac_idx)
-			return;
+	else
 		idx = spec->multiout.dac_nids[dac_idx] - 2;
-	}
 	snd_hda_codec_write(codec, nid, 0, AC_VERB_SET_CONNECT_SEL, idx);
 
 }
@@ -12459,11 +12527,11 @@
 	unsigned char bits;
 
 	present = snd_hda_jack_detect(codec, 0x15);
-	bits = present ? AMP_IN_MUTE(0) : 0;
+	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0f, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0f, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 }
 
 static void alc268_acer_lc_unsol_event(struct hda_codec *codec,
@@ -13333,9 +13401,9 @@
 	0x22,
 };
 
-/* NOTE: ADC2 (0x07) is connected from a recording *MIXER* (0x24),
- *       not a mux!
- */
+static hda_nid_t alc269_adc_candidates[] = {
+	0x08, 0x09, 0x07,
+};
 
 #define alc269_modes		alc260_modes
 #define alc269_capture_source	alc880_lg_lw_capture_source
@@ -13482,11 +13550,11 @@
 	unsigned char bits;
 
 	present = snd_hda_jack_detect(codec, 0x15);
-	bits = present ? AMP_IN_MUTE(0) : 0;
+	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-			AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-			AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 
 	snd_hda_codec_write(codec, 0x20, 0,
 			AC_VERB_SET_COEF_INDEX, 0x0c);
@@ -13511,11 +13579,11 @@
 	/* Check port replicator headphone socket */
 	present |= snd_hda_jack_detect(codec, 0x1a);
 
-	bits = present ? AMP_IN_MUTE(0) : 0;
+	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-			AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-			AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 
 	snd_hda_codec_write(codec, 0x20, 0,
 			AC_VERB_SET_COEF_INDEX, 0x0c);
@@ -13646,11 +13714,11 @@
 	unsigned char bits;
 
 	present = snd_hda_jack_detect(codec, nid);
-	bits = present ? AMP_IN_MUTE(0) : 0;
+	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 }
 
 /* unsolicited event for HP jack sensing */
@@ -13842,7 +13910,6 @@
 	struct alc_spec *spec = codec->spec;
 	int err;
 	static hda_nid_t alc269_ignore[] = { 0x1d, 0 };
-	hda_nid_t real_capsrc_nids;
 
 	err = snd_hda_parse_pin_def_config(codec, &spec->autocfg,
 					   alc269_ignore);
@@ -13866,18 +13933,19 @@
 
 	if ((alc_read_coef_idx(codec, 0) & 0x00f0) == 0x0010) {
 		add_verb(spec, alc269vb_init_verbs);
-		real_capsrc_nids = alc269vb_capsrc_nids[0];
 		alc_ssid_check(codec, 0, 0x1b, 0x14, 0x21);
 	} else {
 		add_verb(spec, alc269_init_verbs);
-		real_capsrc_nids = alc269_capsrc_nids[0];
 		alc_ssid_check(codec, 0x15, 0x1b, 0x14, 0);
 	}
 
 	spec->num_mux_defs = 1;
 	spec->input_mux = &spec->private_imux[0];
+	fillup_priv_adc_nids(codec, alc269_adc_candidates,
+			     sizeof(alc269_adc_candidates));
+
 	/* set default input source */
-	snd_hda_codec_write_cache(codec, real_capsrc_nids,
+	snd_hda_codec_write_cache(codec, spec->capsrc_nids[0],
 				  0, AC_VERB_SET_CONNECT_SEL,
 				  spec->input_mux->items[0].index);
 
@@ -14156,14 +14224,16 @@
 	spec->stream_digital_playback = &alc269_pcm_digital_playback;
 	spec->stream_digital_capture = &alc269_pcm_digital_capture;
 
-	if (!is_alc269vb) {
-		spec->adc_nids = alc269_adc_nids;
-		spec->num_adc_nids = ARRAY_SIZE(alc269_adc_nids);
-		spec->capsrc_nids = alc269_capsrc_nids;
-	} else {
-		spec->adc_nids = alc269vb_adc_nids;
-		spec->num_adc_nids = ARRAY_SIZE(alc269vb_adc_nids);
-		spec->capsrc_nids = alc269vb_capsrc_nids;
+	if (!spec->adc_nids) { /* wasn't filled automatically? use default */
+		if (!is_alc269vb) {
+			spec->adc_nids = alc269_adc_nids;
+			spec->num_adc_nids = ARRAY_SIZE(alc269_adc_nids);
+			spec->capsrc_nids = alc269_capsrc_nids;
+		} else {
+			spec->adc_nids = alc269vb_adc_nids;
+			spec->num_adc_nids = ARRAY_SIZE(alc269vb_adc_nids);
+			spec->capsrc_nids = alc269vb_capsrc_nids;
+		}
 	}
 
 	if (!spec->cap_mixer)
@@ -17115,9 +17185,9 @@
 	present = snd_hda_jack_detect(codec, 0x21);
 	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 }
 
 static void alc663_21jd_two_speaker_automute(struct hda_codec *codec)
@@ -17128,13 +17198,13 @@
 	present = snd_hda_jack_detect(codec, 0x21);
 	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0e, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0e, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 }
 
 static void alc663_15jd_two_speaker_automute(struct hda_codec *codec)
@@ -17145,13 +17215,13 @@
 	present = snd_hda_jack_detect(codec, 0x15);
 	bits = present ? HDA_AMP_MUTE : 0;
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0e, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 	snd_hda_codec_amp_stereo(codec, 0x0e, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), bits);
+				 HDA_AMP_MUTE, bits);
 }
 
 static void alc662_f5z_speaker_automute(struct hda_codec *codec)
@@ -17190,14 +17260,14 @@
 
 	if (present1 || present2) {
 		snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), AMP_IN_MUTE(0));
+					 HDA_AMP_MUTE, HDA_AMP_MUTE);
 		snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), AMP_IN_MUTE(0));
+					 HDA_AMP_MUTE, HDA_AMP_MUTE);
 	} else {
 		snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 0,
-				AMP_IN_MUTE(0), 0);
+					 HDA_AMP_MUTE, 0);
 		snd_hda_codec_amp_stereo(codec, 0x0c, HDA_INPUT, 1,
-				AMP_IN_MUTE(0), 0);
+					 HDA_AMP_MUTE, 0);
 	}
 }
 
diff -urN linux-2.6.34-rc3/sound/pci/ice1712/ak4xxx.c linux-2.6.34-rc4/sound/pci/ice1712/ak4xxx.c
--- linux-2.6.34-rc3/sound/pci/ice1712/ak4xxx.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ice1712/ak4xxx.c	2010-04-13 02:19:02.350883808 +0000
@@ -24,6 +24,7 @@
 #include <asm/io.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <sound/core.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/pci/ice1712/amp.c linux-2.6.34-rc4/sound/pci/ice1712/amp.c
--- linux-2.6.34-rc3/sound/pci/ice1712/amp.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ice1712/amp.c	2010-04-13 02:19:02.350883808 +0000
@@ -25,7 +25,6 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <sound/core.h>
 
 #include "ice1712.h"
diff -urN linux-2.6.34-rc3/sound/pci/ice1712/vt1720_mobo.c linux-2.6.34-rc4/sound/pci/ice1712/vt1720_mobo.c
--- linux-2.6.34-rc3/sound/pci/ice1712/vt1720_mobo.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ice1712/vt1720_mobo.c	2010-04-13 02:19:02.351886752 +0000
@@ -25,7 +25,6 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <sound/core.h>
 
 #include "ice1712.h"
diff -urN linux-2.6.34-rc3/sound/pci/ice1712/wtm.c linux-2.6.34-rc4/sound/pci/ice1712/wtm.c
--- linux-2.6.34-rc3/sound/pci/ice1712/wtm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/ice1712/wtm.c	2010-04-13 02:19:02.351886752 +0000
@@ -29,7 +29,6 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <sound/core.h>
 
 #include "ice1712.h"
diff -urN linux-2.6.34-rc3/sound/pci/lx6464es/lx6464es.c linux-2.6.34-rc4/sound/pci/lx6464es/lx6464es.c
--- linux-2.6.34-rc3/sound/pci/lx6464es/lx6464es.c	2010-04-13 02:18:56.816633052 +0000
+++ linux-2.6.34-rc4/sound/pci/lx6464es/lx6464es.c	2010-04-13 02:19:02.352883303 +0000
@@ -26,6 +26,7 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <sound/initval.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/pci/mixart/mixart.c linux-2.6.34-rc4/sound/pci/mixart/mixart.c
--- linux-2.6.34-rc3/sound/pci/mixart/mixart.c	2010-04-13 02:18:56.816633052 +0000
+++ linux-2.6.34-rc4/sound/pci/mixart/mixart.c	2010-04-13 02:19:02.353883713 +0000
@@ -27,6 +27,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/moduleparam.h>
 #include <linux/mutex.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/initval.h>
@@ -1161,13 +1162,15 @@
 				unsigned long count, unsigned long pos)
 {
 	struct mixart_mgr *mgr = entry->private_data;
+	unsigned long maxsize;
 
-	count = count & ~3; /* make sure the read size is a multiple of 4 bytes */
-	if(count <= 0)
+	if (pos >= MIXART_BA0_SIZE)
 		return 0;
-	if(pos + count > MIXART_BA0_SIZE)
-		count = (long)(MIXART_BA0_SIZE - pos);
-	if(copy_to_user_fromio(buf, MIXART_MEM( mgr, pos ), count))
+	maxsize = MIXART_BA0_SIZE - pos;
+	if (count > maxsize)
+		count = maxsize;
+	count = count & ~3; /* make sure the read size is a multiple of 4 bytes */
+	if (copy_to_user_fromio(buf, MIXART_MEM(mgr, pos), count))
 		return -EFAULT;
 	return count;
 }
@@ -1180,13 +1183,15 @@
 				unsigned long count, unsigned long pos)
 {
 	struct mixart_mgr *mgr = entry->private_data;
+	unsigned long maxsize;
 
-	count = count & ~3; /* make sure the read size is a multiple of 4 bytes */
-	if(count <= 0)
+	if (pos > MIXART_BA1_SIZE)
 		return 0;
-	if(pos + count > MIXART_BA1_SIZE)
-		count = (long)(MIXART_BA1_SIZE - pos);
-	if(copy_to_user_fromio(buf, MIXART_REG( mgr, pos ), count))
+	maxsize = MIXART_BA1_SIZE - pos;
+	if (count > maxsize)
+		count = maxsize;
+	count = count & ~3; /* make sure the read size is a multiple of 4 bytes */
+	if (copy_to_user_fromio(buf, MIXART_REG(mgr, pos), count))
 		return -EFAULT;
 	return count;
 }
diff -urN linux-2.6.34-rc3/sound/pci/mixart/mixart_hwdep.c linux-2.6.34-rc4/sound/pci/mixart/mixart_hwdep.c
--- linux-2.6.34-rc3/sound/pci/mixart/mixart_hwdep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/mixart/mixart_hwdep.c	2010-04-13 02:19:02.353883713 +0000
@@ -24,6 +24,7 @@
 #include <linux/pci.h>
 #include <linux/firmware.h>
 #include <linux/vmalloc.h>
+#include <linux/slab.h>
 #include <asm/io.h>
 #include <sound/core.h>
 #include "mixart.h"
diff -urN linux-2.6.34-rc3/sound/pci/oxygen/oxygen_lib.c linux-2.6.34-rc4/sound/pci/oxygen/oxygen_lib.c
--- linux-2.6.34-rc3/sound/pci/oxygen/oxygen_lib.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pci/oxygen/oxygen_lib.c	2010-04-13 02:19:02.354883609 +0000
@@ -21,6 +21,7 @@
 #include <linux/interrupt.h>
 #include <linux/mutex.h>
 #include <linux/pci.h>
+#include <linux/slab.h>
 #include <sound/ac97_codec.h>
 #include <sound/asoundef.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/rme32.c linux-2.6.34-rc4/sound/pci/rme32.c
--- linux-2.6.34-rc3/sound/pci/rme32.c	2010-04-13 02:18:56.819571754 +0000
+++ linux-2.6.34-rc4/sound/pci/rme32.c	2010-04-13 02:19:02.355883907 +0000
@@ -70,10 +70,10 @@
 
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/rme96.c linux-2.6.34-rc4/sound/pci/rme96.c
--- linux-2.6.34-rc3/sound/pci/rme96.c	2010-04-13 02:18:56.819571754 +0000
+++ linux-2.6.34-rc4/sound/pci/rme96.c	2010-04-13 02:19:02.356883513 +0000
@@ -27,7 +27,6 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/rme9652/hdsp.c linux-2.6.34-rc4/sound/pci/rme9652/hdsp.c
--- linux-2.6.34-rc3/sound/pci/rme9652/hdsp.c	2010-04-13 02:18:56.820570473 +0000
+++ linux-2.6.34-rc4/sound/pci/rme9652/hdsp.c	2010-04-13 02:19:02.356883513 +0000
@@ -24,7 +24,6 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/interrupt.h>
-#include <linux/slab.h>
 #include <linux/pci.h>
 #include <linux/firmware.h>
 #include <linux/moduleparam.h>
diff -urN linux-2.6.34-rc3/sound/pci/rme9652/rme9652.c linux-2.6.34-rc4/sound/pci/rme9652/rme9652.c
--- linux-2.6.34-rc3/sound/pci/rme9652/rme9652.c	2010-04-13 02:18:56.820570473 +0000
+++ linux-2.6.34-rc4/sound/pci/rme9652/rme9652.c	2010-04-13 02:19:02.358884025 +0000
@@ -24,7 +24,6 @@
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/pci.h>
-#include <linux/slab.h>
 #include <linux/moduleparam.h>
 
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/pci/sis7019.c linux-2.6.34-rc4/sound/pci/sis7019.c
--- linux-2.6.34-rc3/sound/pci/sis7019.c	2010-04-13 02:18:56.821633039 +0000
+++ linux-2.6.34-rc4/sound/pci/sis7019.c	2010-04-13 02:19:02.358884025 +0000
@@ -24,6 +24,7 @@
 #include <linux/init.h>
 #include <linux/pci.h>
 #include <linux/time.h>
+#include <linux/slab.h>
 #include <linux/moduleparam.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
diff -urN linux-2.6.34-rc3/sound/pcmcia/pdaudiocf/pdaudiocf_core.c linux-2.6.34-rc4/sound/pcmcia/pdaudiocf/pdaudiocf_core.c
--- linux-2.6.34-rc3/sound/pcmcia/pdaudiocf/pdaudiocf_core.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pcmcia/pdaudiocf/pdaudiocf_core.c	2010-04-13 02:19:02.359883225 +0000
@@ -19,6 +19,7 @@
  */
 
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/info.h>
 #include "pdaudiocf.h"
diff -urN linux-2.6.34-rc3/sound/pcmcia/pdaudiocf/pdaudiocf_pcm.c linux-2.6.34-rc4/sound/pcmcia/pdaudiocf/pdaudiocf_pcm.c
--- linux-2.6.34-rc3/sound/pcmcia/pdaudiocf/pdaudiocf_pcm.c	2010-04-13 02:18:56.822633038 +0000
+++ linux-2.6.34-rc4/sound/pcmcia/pdaudiocf/pdaudiocf_pcm.c	2010-04-13 02:19:02.359883225 +0000
@@ -20,7 +20,6 @@
  *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
  */
 
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <sound/core.h>
 #include <sound/asoundef.h>
diff -urN linux-2.6.34-rc3/sound/pcmcia/vx/vxpocket.c linux-2.6.34-rc4/sound/pcmcia/vx/vxpocket.c
--- linux-2.6.34-rc3/sound/pcmcia/vx/vxpocket.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/pcmcia/vx/vxpocket.c	2010-04-13 02:19:02.359883225 +0000
@@ -21,6 +21,7 @@
 
 #include <linux/init.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include "vxpocket.h"
 #include <pcmcia/ciscode.h>
diff -urN linux-2.6.34-rc3/sound/ppc/burgundy.c linux-2.6.34-rc4/sound/ppc/burgundy.c
--- linux-2.6.34-rc3/sound/ppc/burgundy.c	2010-04-13 02:18:56.822633038 +0000
+++ linux-2.6.34-rc4/sound/ppc/burgundy.c	2010-04-13 02:19:02.360883650 +0000
@@ -21,7 +21,6 @@
 
 #include <asm/io.h>
 #include <linux/init.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <sound/core.h>
 #include "pmac.h"
diff -urN linux-2.6.34-rc3/sound/ppc/keywest.c linux-2.6.34-rc4/sound/ppc/keywest.c
--- linux-2.6.34-rc3/sound/ppc/keywest.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/ppc/keywest.c	2010-04-13 02:19:02.360883650 +0000
@@ -22,7 +22,6 @@
 #include <linux/init.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
-#include <linux/slab.h>
 #include <sound/core.h>
 #include "pmac.h"
 
diff -urN linux-2.6.34-rc3/sound/ppc/snd_ps3.c linux-2.6.34-rc4/sound/ppc/snd_ps3.c
--- linux-2.6.34-rc3/sound/ppc/snd_ps3.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/ppc/snd_ps3.c	2010-04-13 02:19:02.360883650 +0000
@@ -20,10 +20,10 @@
 
 #include <linux/dma-mapping.h>
 #include <linux/dmapool.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
-#include <linux/slab.h>
 
 #include <sound/asound.h>
 #include <sound/control.h>
diff -urN linux-2.6.34-rc3/sound/sh/sh_dac_audio.c linux-2.6.34-rc4/sound/sh/sh_dac_audio.c
--- linux-2.6.34-rc3/sound/sh/sh_dac_audio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/sh/sh_dac_audio.c	2010-04-13 02:19:02.360883650 +0000
@@ -26,6 +26,7 @@
 #include <linux/interrupt.h>
 #include <linux/io.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/initval.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/atmel/atmel-pcm.c linux-2.6.34-rc4/sound/soc/atmel/atmel-pcm.c
--- linux-2.6.34-rc3/sound/soc/atmel/atmel-pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/atmel/atmel-pcm.c	2010-04-13 02:19:02.361883471 +0000
@@ -180,7 +180,7 @@
 	snd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);
 	runtime->dma_bytes = params_buffer_bytes(params);
 
-	prtd->params = rtd->dai->cpu_dai->dma_data;
+	prtd->params = snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 	prtd->params->dma_intr_handler = atmel_pcm_dma_irq;
 
 	prtd->dma_buffer = runtime->dma_addr;
diff -urN linux-2.6.34-rc3/sound/soc/atmel/atmel_ssc_dai.c linux-2.6.34-rc4/sound/soc/atmel/atmel_ssc_dai.c
--- linux-2.6.34-rc3/sound/soc/atmel/atmel_ssc_dai.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/atmel/atmel_ssc_dai.c	2010-04-13 02:19:02.361883471 +0000
@@ -363,12 +363,12 @@
 	ssc_p->dma_params[dir] = dma_params;
 
 	/*
-	 * The cpu_dai->dma_data field is only used to communicate the
-	 * appropriate DMA parameters to the pcm driver hw_params()
+	 * The snd_soc_pcm_stream->dma_data field is only used to communicate
+	 * the appropriate DMA parameters to the pcm driver hw_params()
 	 * function.  It should not be used for other purposes
 	 * as it is common to all substreams.
 	 */
-	rtd->dai->cpu_dai->dma_data = dma_params;
+	snd_soc_dai_set_dma_data(rtd->dai->cpu_dai, substream, dma_params);
 
 	channels = params_channels(params);
 
diff -urN linux-2.6.34-rc3/sound/soc/au1x/psc-ac97.c linux-2.6.34-rc4/sound/soc/au1x/psc-ac97.c
--- linux-2.6.34-rc3/sound/soc/au1x/psc-ac97.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/au1x/psc-ac97.c	2010-04-13 02:19:02.361883471 +0000
@@ -17,6 +17,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/device.h>
 #include <linux/delay.h>
 #include <linux/mutex.h>
diff -urN linux-2.6.34-rc3/sound/soc/au1x/psc-i2s.c linux-2.6.34-rc4/sound/soc/au1x/psc-i2s.c
--- linux-2.6.34-rc3/sound/soc/au1x/psc-i2s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/au1x/psc-i2s.c	2010-04-13 02:19:02.361883471 +0000
@@ -18,6 +18,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/suspend.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-ac97-pcm.c linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-ac97-pcm.c
--- linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-ac97-pcm.c	2010-04-13 02:18:56.823633028 +0000
+++ linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-ac97-pcm.c	2010-04-13 02:19:02.362883769 +0000
@@ -29,8 +29,8 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-ac97.c linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-ac97.c
--- linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-ac97.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-ac97.c	2010-04-13 02:19:02.362883769 +0000
@@ -16,6 +16,7 @@
 #include <linux/interrupt.h>
 #include <linux/wait.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-i2s-pcm.c linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-i2s-pcm.c
--- linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-i2s-pcm.c	2010-04-13 02:18:56.823633028 +0000
+++ linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-i2s-pcm.c	2010-04-13 02:19:02.362883769 +0000
@@ -29,8 +29,8 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-tdm-pcm.c linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-tdm-pcm.c
--- linux-2.6.34-rc3/sound/soc/blackfin/bf5xx-tdm-pcm.c	2010-04-13 02:18:56.823633028 +0000
+++ linux-2.6.34-rc4/sound/soc/blackfin/bf5xx-tdm-pcm.c	2010-04-13 02:19:02.362883769 +0000
@@ -29,8 +29,8 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ac97.c linux-2.6.34-rc4/sound/soc/codecs/ac97.c
--- linux-2.6.34-rc3/sound/soc/codecs/ac97.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ac97.c	2010-04-13 02:19:02.362883769 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <sound/core.h>
@@ -80,9 +81,11 @@
 static int ac97_soc_probe(struct platform_device *pdev)
 {
 	struct snd_soc_device *socdev = platform_get_drvdata(pdev);
+	struct snd_soc_card *card = socdev->card;
 	struct snd_soc_codec *codec;
 	struct snd_ac97_bus *ac97_bus;
 	struct snd_ac97_template ac97_template;
+	int i;
 	int ret = 0;
 
 	printk(KERN_INFO "AC97 SoC Audio Codec %s\n", AC97_VERSION);
@@ -102,12 +105,6 @@
 	INIT_LIST_HEAD(&codec->dapm_widgets);
 	INIT_LIST_HEAD(&codec->dapm_paths);
 
-	ret = snd_soc_new_ac97_codec(codec, &soc_ac97_ops, 0);
-	if (ret < 0) {
-		printk(KERN_ERR "ASoC: failed to init gen ac97 glue\n");
-		goto err;
-	}
-
 	/* register pcms */
 	ret = snd_soc_new_pcms(socdev, SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1);
 	if (ret < 0)
@@ -123,6 +120,13 @@
 	if (ret < 0)
 		goto bus_err;
 
+	for (i = 0; i < card->num_links; i++) {
+		if (card->dai_link[i].codec_dai->ac97_control) {
+			snd_ac97_dev_add_pdata(codec->ac97,
+				card->dai_link[i].cpu_dai->ac97_pdata);
+		}
+	}
+
 	return 0;
 
 bus_err:
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ad1836.c linux-2.6.34-rc4/sound/soc/codecs/ad1836.c
--- linux-2.6.34-rc3/sound/soc/codecs/ad1836.c	2010-04-13 02:18:56.824633048 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ad1836.c	2010-04-13 02:19:02.363883789 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ad1938.c linux-2.6.34-rc4/sound/soc/codecs/ad1938.c
--- linux-2.6.34-rc3/sound/soc/codecs/ad1938.c	2010-04-13 02:18:56.824633048 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ad1938.c	2010-04-13 02:19:02.363883789 +0000
@@ -27,6 +27,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ad1980.c linux-2.6.34-rc4/sound/soc/codecs/ad1980.c
--- linux-2.6.34-rc3/sound/soc/codecs/ad1980.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ad1980.c	2010-04-13 02:19:02.363883789 +0000
@@ -12,6 +12,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ad73311.c linux-2.6.34-rc4/sound/soc/codecs/ad73311.c
--- linux-2.6.34-rc3/sound/soc/codecs/ad73311.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ad73311.c	2010-04-13 02:19:02.363883789 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ads117x.c linux-2.6.34-rc4/sound/soc/codecs/ads117x.c
--- linux-2.6.34-rc3/sound/soc/codecs/ads117x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ads117x.c	2010-04-13 02:19:02.363883789 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/device.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ak4104.c linux-2.6.34-rc4/sound/soc/codecs/ak4104.c
--- linux-2.6.34-rc3/sound/soc/codecs/ak4104.c	2010-04-13 02:18:56.824633048 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ak4104.c	2010-04-13 02:19:02.363883789 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/soc.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ak4535.c linux-2.6.34-rc4/sound/soc/codecs/ak4535.c
--- linux-2.6.34-rc3/sound/soc/codecs/ak4535.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ak4535.c	2010-04-13 02:19:02.363883789 +0000
@@ -19,6 +19,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ak4642.c linux-2.6.34-rc4/sound/soc/codecs/ak4642.c
--- linux-2.6.34-rc3/sound/soc/codecs/ak4642.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ak4642.c	2010-04-13 02:19:02.364883205 +0000
@@ -29,6 +29,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ak4671.c linux-2.6.34-rc4/sound/soc/codecs/ak4671.c
--- linux-2.6.34-rc3/sound/soc/codecs/ak4671.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ak4671.c	2010-04-13 02:19:02.364883205 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/i2c.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/soc.h>
 #include <sound/soc-dapm.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/cs4270.c linux-2.6.34-rc4/sound/soc/codecs/cs4270.c
--- linux-2.6.34-rc3/sound/soc/codecs/cs4270.c	2010-04-13 02:18:56.824633048 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/cs4270.c	2010-04-13 02:19:02.364883205 +0000
@@ -23,6 +23,7 @@
 
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/soc.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/cx20442.c linux-2.6.34-rc4/sound/soc/codecs/cx20442.c
--- linux-2.6.34-rc3/sound/soc/codecs/cx20442.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/cx20442.c	2010-04-13 02:19:02.364883205 +0000
@@ -14,6 +14,7 @@
  */
 
 #include <linux/tty.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/da7210.c linux-2.6.34-rc4/sound/soc/codecs/da7210.c
--- linux-2.6.34-rc3/sound/soc/codecs/da7210.c	2010-04-13 02:18:56.825633059 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/da7210.c	2010-04-13 02:19:02.364883205 +0000
@@ -23,6 +23,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/pcm3008.c linux-2.6.34-rc4/sound/soc/codecs/pcm3008.c
--- linux-2.6.34-rc3/sound/soc/codecs/pcm3008.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/pcm3008.c	2010-04-13 02:19:02.365884097 +0000
@@ -19,6 +19,7 @@
 #include <linux/kernel.h>
 #include <linux/device.h>
 #include <linux/gpio.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/ssm2602.c linux-2.6.34-rc4/sound/soc/codecs/ssm2602.c
--- linux-2.6.34-rc3/sound/soc/codecs/ssm2602.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/ssm2602.c	2010-04-13 02:19:02.365884097 +0000
@@ -33,6 +33,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/stac9766.c linux-2.6.34-rc4/sound/soc/codecs/stac9766.c
--- linux-2.6.34-rc3/sound/soc/codecs/stac9766.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/stac9766.c	2010-04-13 02:19:02.365884097 +0000
@@ -15,6 +15,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/device.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/tlv320aic23.c linux-2.6.34-rc4/sound/soc/codecs/tlv320aic23.c
--- linux-2.6.34-rc3/sound/soc/codecs/tlv320aic23.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/tlv320aic23.c	2010-04-13 02:19:02.365884097 +0000
@@ -25,6 +25,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/tlv320aic26.c linux-2.6.34-rc4/sound/soc/codecs/tlv320aic26.c
--- linux-2.6.34-rc3/sound/soc/codecs/tlv320aic26.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/tlv320aic26.c	2010-04-13 02:19:02.365884097 +0000
@@ -13,6 +13,7 @@
 #include <linux/device.h>
 #include <linux/sysfs.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/tlv320aic3x.c linux-2.6.34-rc4/sound/soc/codecs/tlv320aic3x.c
--- linux-2.6.34-rc3/sound/soc/codecs/tlv320aic3x.c	2010-04-13 02:18:56.825633059 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/tlv320aic3x.c	2010-04-13 02:19:02.365884097 +0000
@@ -39,6 +39,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/tlv320dac33.c linux-2.6.34-rc4/sound/soc/codecs/tlv320dac33.c
--- linux-2.6.34-rc3/sound/soc/codecs/tlv320dac33.c	2010-04-13 02:18:56.826633043 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/tlv320dac33.c	2010-04-13 02:19:02.366883718 +0000
@@ -31,6 +31,7 @@
 #include <linux/interrupt.h>
 #include <linux/gpio.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/tpa6130a2.c linux-2.6.34-rc4/sound/soc/codecs/tpa6130a2.c
--- linux-2.6.34-rc3/sound/soc/codecs/tpa6130a2.c	2010-04-13 02:18:56.826633043 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/tpa6130a2.c	2010-04-13 02:19:02.366883718 +0000
@@ -26,6 +26,7 @@
 #include <linux/i2c.h>
 #include <linux/gpio.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/tpa6130a2-plat.h>
 #include <sound/soc.h>
 #include <sound/soc-dapm.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/twl4030.c linux-2.6.34-rc4/sound/soc/codecs/twl4030.c
--- linux-2.6.34-rc3/sound/soc/codecs/twl4030.c	2010-04-13 02:18:56.826633043 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/twl4030.c	2010-04-13 02:19:02.367883815 +0000
@@ -27,6 +27,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/i2c/twl.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/uda134x.c linux-2.6.34-rc4/sound/soc/codecs/uda134x.c
--- linux-2.6.34-rc3/sound/soc/codecs/uda134x.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/uda134x.c	2010-04-13 02:19:02.367883815 +0000
@@ -15,6 +15,7 @@
 
 #include <linux/module.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
 #include <sound/soc.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm2000.c linux-2.6.34-rc4/sound/soc/codecs/wm2000.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm2000.c	2010-04-13 02:18:56.827633060 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm2000.c	2010-04-13 02:19:02.367883815 +0000
@@ -32,6 +32,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8350.c linux-2.6.34-rc4/sound/soc/codecs/wm8350.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8350.c	2010-04-13 02:18:56.827633060 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8350.c	2010-04-13 02:19:02.368883849 +0000
@@ -13,6 +13,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/pm.h>
 #include <linux/platform_device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8400.c linux-2.6.34-rc4/sound/soc/codecs/wm8400.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8400.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8400.c	2010-04-13 02:19:02.368883849 +0000
@@ -14,6 +14,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/pm.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8510.c linux-2.6.34-rc4/sound/soc/codecs/wm8510.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8510.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8510.c	2010-04-13 02:19:02.368883849 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8523.c linux-2.6.34-rc4/sound/soc/codecs/wm8523.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8523.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8523.c	2010-04-13 02:19:02.368883849 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8580.c linux-2.6.34-rc4/sound/soc/codecs/wm8580.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8580.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8580.c	2010-04-13 02:19:02.369890570 +0000
@@ -25,6 +25,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8711.c linux-2.6.34-rc4/sound/soc/codecs/wm8711.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8711.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8711.c	2010-04-13 02:19:02.369890570 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8727.c linux-2.6.34-rc4/sound/soc/codecs/wm8727.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8727.c	2010-04-13 02:18:56.827633060 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8727.c	2010-04-13 02:19:02.369890570 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8728.c linux-2.6.34-rc4/sound/soc/codecs/wm8728.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8728.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8728.c	2010-04-13 02:19:02.369890570 +0000
@@ -18,6 +18,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8731.c linux-2.6.34-rc4/sound/soc/codecs/wm8731.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8731.c	2010-04-13 02:18:56.827633060 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8731.c	2010-04-13 02:19:02.369890570 +0000
@@ -18,6 +18,7 @@
 #include <linux/delay.h>
 #include <linux/pm.h>
 #include <linux/i2c.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
 #include <linux/spi/spi.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8750.c linux-2.6.34-rc4/sound/soc/codecs/wm8750.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8750.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8750.c	2010-04-13 02:19:02.369890570 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8753.c linux-2.6.34-rc4/sound/soc/codecs/wm8753.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8753.c	2010-04-13 02:18:56.828633011 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8753.c	2010-04-13 02:19:02.370883600 +0000
@@ -40,6 +40,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8776.c linux-2.6.34-rc4/sound/soc/codecs/wm8776.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8776.c	2010-04-13 02:18:56.828633011 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8776.c	2010-04-13 02:19:02.370883600 +0000
@@ -20,6 +20,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8900.c linux-2.6.34-rc4/sound/soc/codecs/wm8900.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8900.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8900.c	2010-04-13 02:19:02.370883600 +0000
@@ -24,6 +24,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8903.c linux-2.6.34-rc4/sound/soc/codecs/wm8903.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8903.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8903.c	2010-04-13 02:19:02.370883600 +0000
@@ -23,6 +23,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8904.c linux-2.6.34-rc4/sound/soc/codecs/wm8904.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8904.c	2010-04-13 02:18:56.829571829 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8904.c	2010-04-13 02:19:02.372883624 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8940.c linux-2.6.34-rc4/sound/soc/codecs/wm8940.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8940.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8940.c	2010-04-13 02:19:02.373883586 +0000
@@ -30,6 +30,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8955.c linux-2.6.34-rc4/sound/soc/codecs/wm8955.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8955.c	2010-04-13 02:18:56.831570609 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8955.c	2010-04-13 02:19:02.374883761 +0000
@@ -18,6 +18,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8960.c linux-2.6.34-rc4/sound/soc/codecs/wm8960.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8960.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8960.c	2010-04-13 02:19:02.374883761 +0000
@@ -15,6 +15,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8961.c linux-2.6.34-rc4/sound/soc/codecs/wm8961.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8961.c	2010-04-13 02:18:56.831570609 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8961.c	2010-04-13 02:19:02.374883761 +0000
@@ -18,6 +18,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8971.c linux-2.6.34-rc4/sound/soc/codecs/wm8971.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8971.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8971.c	2010-04-13 02:19:02.375883777 +0000
@@ -20,6 +20,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8974.c linux-2.6.34-rc4/sound/soc/codecs/wm8974.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8974.c	2010-04-13 02:18:56.832633103 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8974.c	2010-04-13 02:19:02.375883777 +0000
@@ -18,6 +18,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8978.c linux-2.6.34-rc4/sound/soc/codecs/wm8978.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8978.c	2010-04-13 02:18:56.832633103 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8978.c	2010-04-13 02:19:02.375883777 +0000
@@ -19,6 +19,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8988.c linux-2.6.34-rc4/sound/soc/codecs/wm8988.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8988.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8988.c	2010-04-13 02:19:02.376883923 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/spi/spi.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8990.c linux-2.6.34-rc4/sound/soc/codecs/wm8990.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8990.c	2010-04-13 02:18:56.833633054 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8990.c	2010-04-13 02:19:02.376883923 +0000
@@ -18,6 +18,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8993.c linux-2.6.34-rc4/sound/soc/codecs/wm8993.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8993.c	2010-04-13 02:18:56.833633054 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8993.c	2010-04-13 02:19:02.376883923 +0000
@@ -18,6 +18,7 @@
 #include <linux/i2c.h>
 #include <linux/regulator/consumer.h>
 #include <linux/spi/spi.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm8994.c linux-2.6.34-rc4/sound/soc/codecs/wm8994.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm8994.c	2010-04-13 02:18:56.835633040 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm8994.c	2010-04-13 02:19:02.378883760 +0000
@@ -19,6 +19,7 @@
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
 #include <linux/regulator/consumer.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
@@ -3007,34 +3008,39 @@
 		break;
 
 	case SND_SOC_BIAS_OFF:
-		/* Switch over to startup biases */
-		snd_soc_update_bits(codec, WM8994_ANTIPOP_2,
-				    WM8994_BIAS_SRC | WM8994_STARTUP_BIAS_ENA |
-				    WM8994_VMID_BUF_ENA |
-				    WM8994_VMID_RAMP_MASK,
-				    WM8994_BIAS_SRC | WM8994_STARTUP_BIAS_ENA |
-				    WM8994_VMID_BUF_ENA |
-				    (1 << WM8994_VMID_RAMP_SHIFT));
+		if (codec->bias_level == SND_SOC_BIAS_STANDBY) {
+			/* Switch over to startup biases */
+			snd_soc_update_bits(codec, WM8994_ANTIPOP_2,
+					    WM8994_BIAS_SRC |
+					    WM8994_STARTUP_BIAS_ENA |
+					    WM8994_VMID_BUF_ENA |
+					    WM8994_VMID_RAMP_MASK,
+					    WM8994_BIAS_SRC |
+					    WM8994_STARTUP_BIAS_ENA |
+					    WM8994_VMID_BUF_ENA |
+					    (1 << WM8994_VMID_RAMP_SHIFT));
 
-		/* Disable main biases */
-		snd_soc_update_bits(codec, WM8994_POWER_MANAGEMENT_1,
-				    WM8994_BIAS_ENA | WM8994_VMID_SEL_MASK, 0);
+			/* Disable main biases */
+			snd_soc_update_bits(codec, WM8994_POWER_MANAGEMENT_1,
+					    WM8994_BIAS_ENA |
+					    WM8994_VMID_SEL_MASK, 0);
 
-		/* Discharge line */
-		snd_soc_update_bits(codec, WM8994_ANTIPOP_1,
-				    WM8994_LINEOUT1_DISCH |
-				    WM8994_LINEOUT2_DISCH,
-				    WM8994_LINEOUT1_DISCH |
-				    WM8994_LINEOUT2_DISCH);
-
-		msleep(5);
-
-		/* Switch off startup biases */
-		snd_soc_update_bits(codec, WM8994_ANTIPOP_2,
-				    WM8994_BIAS_SRC | WM8994_STARTUP_BIAS_ENA |
-				    WM8994_VMID_BUF_ENA |
-				    WM8994_VMID_RAMP_MASK, 0);
+			/* Discharge line */
+			snd_soc_update_bits(codec, WM8994_ANTIPOP_1,
+					    WM8994_LINEOUT1_DISCH |
+					    WM8994_LINEOUT2_DISCH,
+					    WM8994_LINEOUT1_DISCH |
+					    WM8994_LINEOUT2_DISCH);
 
+			msleep(5);
+
+			/* Switch off startup biases */
+			snd_soc_update_bits(codec, WM8994_ANTIPOP_2,
+					    WM8994_BIAS_SRC |
+					    WM8994_STARTUP_BIAS_ENA |
+					    WM8994_VMID_BUF_ENA |
+					    WM8994_VMID_RAMP_MASK, 0);
+		}
 		break;
 	}
 	codec->bias_level = level;
@@ -3401,7 +3407,7 @@
 			.rates = WM8994_RATES,
 			.formats = WM8994_FORMATS,
 		},
-		.playback = {
+		.capture = {
 			.stream_name = "AIF3 Capture",
 			.channels_min = 2,
 			.channels_max = 2,
@@ -3730,11 +3736,12 @@
 	case 3:
 		wm8994->hubs.dcs_codes = -5;
 		wm8994->hubs.hp_startup_mode = 1;
+		wm8994->hubs.dcs_readback_mode = 1;
 		break;
 	default:
+		wm8994->hubs.dcs_readback_mode = 1;
 		break;
 	}
-			   
 
 	/* Remember if AIFnLRCLK is configured as a GPIO.  This should be
 	 * configured on init - if a system wants to do this dynamically
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm9081.c linux-2.6.34-rc4/sound/soc/codecs/wm9081.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm9081.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm9081.c	2010-04-13 02:19:02.379883573 +0000
@@ -18,6 +18,7 @@
 #include <linux/pm.h>
 #include <linux/i2c.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm9705.c linux-2.6.34-rc4/sound/soc/codecs/wm9705.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm9705.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm9705.c	2010-04-13 02:19:02.379883573 +0000
@@ -10,6 +10,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm9712.c linux-2.6.34-rc4/sound/soc/codecs/wm9712.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm9712.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm9712.c	2010-04-13 02:19:02.379883573 +0000
@@ -11,6 +11,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/device.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm9713.c linux-2.6.34-rc4/sound/soc/codecs/wm9713.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm9713.c	2010-04-13 02:18:56.835633040 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm9713.c	2010-04-13 02:19:02.379883573 +0000
@@ -16,6 +16,7 @@
  */
 
 #include <linux/init.h>
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/device.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm_hubs.c linux-2.6.34-rc4/sound/soc/codecs/wm_hubs.c
--- linux-2.6.34-rc3/sound/soc/codecs/wm_hubs.c	2010-04-13 02:18:56.836633012 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm_hubs.c	2010-04-13 02:19:02.380883853 +0000
@@ -62,21 +62,27 @@
 static const struct soc_enum speaker_mode =
 	SOC_ENUM_SINGLE(WM8993_SPKMIXR_ATTENUATION, 8, 2, speaker_mode_text);
 
-static void wait_for_dc_servo(struct snd_soc_codec *codec)
+static void wait_for_dc_servo(struct snd_soc_codec *codec, unsigned int op)
 {
 	unsigned int reg;
 	int count = 0;
+	unsigned int val;
+
+	val = op | WM8993_DCS_ENA_CHAN_0 | WM8993_DCS_ENA_CHAN_1;
+
+	/* Trigger the command */
+	snd_soc_write(codec, WM8993_DC_SERVO_0, val);
 
 	dev_dbg(codec->dev, "Waiting for DC servo...\n");
 
 	do {
 		count++;
 		msleep(1);
-		reg = snd_soc_read(codec, WM8993_DC_SERVO_READBACK_0);
+		reg = snd_soc_read(codec, WM8993_DC_SERVO_0);
 		dev_dbg(codec->dev, "DC servo: %x\n", reg);
-	} while (reg & WM8993_DCS_DATAPATH_BUSY && count < 400);
+	} while (reg & op && count < 400);
 
-	if (reg & WM8993_DCS_DATAPATH_BUSY)
+	if (reg & op)
 		dev_err(codec->dev, "Timed out waiting for DC Servo\n");
 }
 
@@ -86,51 +92,58 @@
 static void calibrate_dc_servo(struct snd_soc_codec *codec)
 {
 	struct wm_hubs_data *hubs = codec->private_data;
-	u16 reg, dcs_cfg;
+	u16 reg, reg_l, reg_r, dcs_cfg;
 
 	/* Set for 32 series updates */
 	snd_soc_update_bits(codec, WM8993_DC_SERVO_1,
 			    WM8993_DCS_SERIES_NO_01_MASK,
 			    32 << WM8993_DCS_SERIES_NO_01_SHIFT);
-
-	/* Enable the DC servo.  Write all bits to avoid triggering startup
-	 * or write calibration.
-	 */
-	snd_soc_update_bits(codec, WM8993_DC_SERVO_0,
-			    0xFFFF,
-			    WM8993_DCS_ENA_CHAN_0 |
-			    WM8993_DCS_ENA_CHAN_1 |
-			    WM8993_DCS_TRIG_SERIES_1 |
-			    WM8993_DCS_TRIG_SERIES_0);
-
-	wait_for_dc_servo(codec);
+	wait_for_dc_servo(codec,
+			  WM8993_DCS_TRIG_SERIES_0 | WM8993_DCS_TRIG_SERIES_1);
 
 	/* Apply correction to DC servo result */
 	if (hubs->dcs_codes) {
 		dev_dbg(codec->dev, "Applying %d code DC servo correction\n",
 			hubs->dcs_codes);
 
+		/* Different chips in the family support different
+		 * readback methods.
+		 */
+		switch (hubs->dcs_readback_mode) {
+		case 0:
+			reg_l = snd_soc_read(codec, WM8993_DC_SERVO_READBACK_1)
+				& WM8993_DCS_INTEG_CHAN_0_MASK;;
+			reg_r = snd_soc_read(codec, WM8993_DC_SERVO_READBACK_2)
+				& WM8993_DCS_INTEG_CHAN_1_MASK;
+			break;
+		case 1:
+			reg = snd_soc_read(codec, WM8993_DC_SERVO_3);
+			reg_l = (reg & WM8993_DCS_DAC_WR_VAL_1_MASK)
+				>> WM8993_DCS_DAC_WR_VAL_1_SHIFT;
+			reg_r = reg & WM8993_DCS_DAC_WR_VAL_0_MASK;
+			break;
+		default:
+			WARN(1, "Unknown DCS readback method");
+			break;
+		}
+
 		/* HPOUT1L */
-		reg = snd_soc_read(codec, WM8993_DC_SERVO_READBACK_1) &
-			WM8993_DCS_INTEG_CHAN_0_MASK;;
-		reg += hubs->dcs_codes;
-		dcs_cfg = reg << WM8993_DCS_DAC_WR_VAL_1_SHIFT;
+		if (reg_l + hubs->dcs_codes > 0 &&
+		    reg_l + hubs->dcs_codes < 0xff)
+			reg_l += hubs->dcs_codes;
+		dcs_cfg = reg_l << WM8993_DCS_DAC_WR_VAL_1_SHIFT;
 
 		/* HPOUT1R */
-		reg = snd_soc_read(codec, WM8993_DC_SERVO_READBACK_2) &
-			WM8993_DCS_INTEG_CHAN_1_MASK;
-		reg += hubs->dcs_codes;
-		dcs_cfg |= reg;
+		if (reg_r + hubs->dcs_codes > 0 &&
+		    reg_r + hubs->dcs_codes < 0xff)
+			reg_r += hubs->dcs_codes;
+		dcs_cfg |= reg_r;
 
 		/* Do it */
 		snd_soc_write(codec, WM8993_DC_SERVO_3, dcs_cfg);
-		snd_soc_update_bits(codec, WM8993_DC_SERVO_0,
-				    WM8993_DCS_TRIG_DAC_WR_0 |
-				    WM8993_DCS_TRIG_DAC_WR_1,
-				    WM8993_DCS_TRIG_DAC_WR_0 |
-				    WM8993_DCS_TRIG_DAC_WR_1);
-
-		wait_for_dc_servo(codec);
+		wait_for_dc_servo(codec,
+				  WM8993_DCS_TRIG_DAC_WR_0 |
+				  WM8993_DCS_TRIG_DAC_WR_1);
 	}
 }
 
@@ -141,10 +154,16 @@
 			       struct snd_ctl_elem_value *ucontrol)
 {
 	struct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);
+	struct wm_hubs_data *hubs = codec->private_data;
 	int ret;
 
 	ret = snd_soc_put_volsw_2r(kcontrol, ucontrol);
 
+	/* If we're applying an offset correction then updating the
+	 * callibration would be likely to introduce further offsets. */
+	if (hubs->dcs_codes)
+		return ret;
+
 	/* Only need to do this if the outputs are active */
 	if (snd_soc_read(codec, WM8993_POWER_MANAGEMENT_1)
 	    & (WM8993_HPOUT1L_ENA | WM8993_HPOUT1R_ENA))
diff -urN linux-2.6.34-rc3/sound/soc/codecs/wm_hubs.h linux-2.6.34-rc4/sound/soc/codecs/wm_hubs.h
--- linux-2.6.34-rc3/sound/soc/codecs/wm_hubs.h	2010-04-13 02:18:56.836633012 +0000
+++ linux-2.6.34-rc4/sound/soc/codecs/wm_hubs.h	2010-04-13 02:19:02.380883853 +0000
@@ -21,6 +21,7 @@
 /* This *must* be the first element of the codec->private_data struct */
 struct wm_hubs_data {
 	int dcs_codes;
+	int dcs_readback_mode;
 	int hp_startup_mode;
 };
 
diff -urN linux-2.6.34-rc3/sound/soc/davinci/davinci-i2s.c linux-2.6.34-rc4/sound/soc/davinci/davinci-i2s.c
--- linux-2.6.34-rc3/sound/soc/davinci/davinci-i2s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/davinci/davinci-i2s.c	2010-04-13 02:19:02.380883853 +0000
@@ -12,6 +12,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <linux/clk.h>
@@ -585,7 +586,8 @@
 	dev->dma_params[SNDRV_PCM_STREAM_CAPTURE].channel = res->start;
 
 	davinci_i2s_dai.private_data = dev;
-	davinci_i2s_dai.dma_data = dev->dma_params;
+	davinci_i2s_dai.capture.dma_data = dev->dma_params;
+	davinci_i2s_dai.playback.dma_data = dev->dma_params;
 	ret = snd_soc_register_dai(&davinci_i2s_dai);
 	if (ret != 0)
 		goto err_free_mem;
diff -urN linux-2.6.34-rc3/sound/soc/davinci/davinci-mcasp.c linux-2.6.34-rc4/sound/soc/davinci/davinci-mcasp.c
--- linux-2.6.34-rc3/sound/soc/davinci/davinci-mcasp.c	2010-04-13 02:18:56.836633012 +0000
+++ linux-2.6.34-rc4/sound/soc/davinci/davinci-mcasp.c	2010-04-13 02:19:02.380883853 +0000
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/device.h>
+#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/io.h>
 #include <linux/clk.h>
@@ -917,7 +918,8 @@
 
 	dma_data->channel = res->start;
 	davinci_mcasp_dai[pdata->op_mode].private_data = dev;
-	davinci_mcasp_dai[pdata->op_mode].dma_data = dev->dma_params;
+	davinci_mcasp_dai[pdata->op_mode].capture.dma_data = dev->dma_params;
+	davinci_mcasp_dai[pdata->op_mode].playback.dma_data = dev->dma_params;
 	davinci_mcasp_dai[pdata->op_mode].dev = &pdev->dev;
 	ret = snd_soc_register_dai(&davinci_mcasp_dai[pdata->op_mode]);
 
diff -urN linux-2.6.34-rc3/sound/soc/davinci/davinci-pcm.c linux-2.6.34-rc4/sound/soc/davinci/davinci-pcm.c
--- linux-2.6.34-rc3/sound/soc/davinci/davinci-pcm.c	2010-04-13 02:18:56.836633012 +0000
+++ linux-2.6.34-rc4/sound/soc/davinci/davinci-pcm.c	2010-04-13 02:19:02.380883853 +0000
@@ -649,8 +649,10 @@
 	struct snd_pcm_hardware *ppcm;
 	int ret = 0;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct davinci_pcm_dma_params *pa = rtd->dai->cpu_dai->dma_data;
+	struct davinci_pcm_dma_params *pa;
 	struct davinci_pcm_dma_params *params;
+
+	pa = snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 	if (!pa)
 		return -ENODEV;
 	params = &pa[substream->stream];
diff -urN linux-2.6.34-rc3/sound/soc/fsl/fsl_dma.c linux-2.6.34-rc4/sound/soc/fsl/fsl_dma.c
--- linux-2.6.34-rc3/sound/soc/fsl/fsl_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/fsl/fsl_dma.c	2010-04-13 02:19:02.381883359 +0000
@@ -19,6 +19,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/interrupt.h>
 #include <linux/delay.h>
+#include <linux/gfp.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/fsl/fsl_ssi.c linux-2.6.34-rc4/sound/soc/fsl/fsl_ssi.c
--- linux-2.6.34-rc3/sound/soc/fsl/fsl_ssi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/fsl/fsl_ssi.c	2010-04-13 02:19:02.381883359 +0000
@@ -14,6 +14,7 @@
 #include <linux/interrupt.h>
 #include <linux/device.h>
 #include <linux/delay.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/soc/fsl/mpc5200_dma.c linux-2.6.34-rc4/sound/soc/fsl/mpc5200_dma.c
--- linux-2.6.34-rc3/sound/soc/fsl/mpc5200_dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/fsl/mpc5200_dma.c	2010-04-13 02:19:02.381883359 +0000
@@ -8,6 +8,7 @@
 
 #include <linux/module.h>
 #include <linux/of_device.h>
+#include <linux/slab.h>
 
 #include <sound/soc.h>
 
diff -urN linux-2.6.34-rc3/sound/soc/fsl/mpc8610_hpcd.c linux-2.6.34-rc4/sound/soc/fsl/mpc8610_hpcd.c
--- linux-2.6.34-rc3/sound/soc/fsl/mpc8610_hpcd.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/fsl/mpc8610_hpcd.c	2010-04-13 02:19:02.381883359 +0000
@@ -9,6 +9,7 @@
  * express or implied.
  */
 
+#include <linux/slab.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
 #include <linux/of_device.h>
diff -urN linux-2.6.34-rc3/sound/soc/fsl/soc-of-simple.c linux-2.6.34-rc4/sound/soc/fsl/soc-of-simple.c
--- linux-2.6.34-rc3/sound/soc/fsl/soc-of-simple.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/fsl/soc-of-simple.c	2010-04-13 02:19:02.381883359 +0000
@@ -12,6 +12,7 @@
 #include <linux/bitops.h>
 #include <linux/platform_device.h>
 #include <linux/of.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/imx/imx-pcm-dma-mx2.c linux-2.6.34-rc4/sound/soc/imx/imx-pcm-dma-mx2.c
--- linux-2.6.34-rc3/sound/soc/imx/imx-pcm-dma-mx2.c	2010-04-13 02:18:56.837633023 +0000
+++ linux-2.6.34-rc4/sound/soc/imx/imx-pcm-dma-mx2.c	2010-04-13 02:19:02.382883535 +0000
@@ -19,6 +19,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/initval.h>
@@ -83,11 +84,13 @@
 static int imx_ssi_dma_alloc(struct snd_pcm_substream *substream)
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct imx_pcm_dma_params *dma_params = rtd->dai->cpu_dai->dma_data;
+	struct imx_pcm_dma_params *dma_params;
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct imx_pcm_runtime_data *iprtd = runtime->private_data;
 	int ret;
 
+	dma_params = snd_soc_get_dma_data(rtd->dai->cpu_dai, substream);
+
 	iprtd->dma = imx_dma_request_by_prio(DRV_NAME, DMA_PRIO_HIGH);
 	if (iprtd->dma < 0) {
 		pr_err("Failed to claim the audio DMA\n");
@@ -192,10 +195,12 @@
 {
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct imx_pcm_dma_params *dma_params = rtd->dai->cpu_dai->dma_data;
+	struct imx_pcm_dma_params *dma_params;
 	struct imx_pcm_runtime_data *iprtd = runtime->private_data;
 	int err;
 
+	dma_params = snd_soc_get_dma_data(rtd->dai->cpu_dai, substream);
+
 	iprtd->substream = substream;
 	iprtd->buf = (unsigned int *)substream->dma_buffer.area;
 	iprtd->period_cnt = 0;
diff -urN linux-2.6.34-rc3/sound/soc/imx/imx-pcm-fiq.c linux-2.6.34-rc4/sound/soc/imx/imx-pcm-fiq.c
--- linux-2.6.34-rc3/sound/soc/imx/imx-pcm-fiq.c	2010-04-13 02:18:56.837633023 +0000
+++ linux-2.6.34-rc4/sound/soc/imx/imx-pcm-fiq.c	2010-04-13 02:19:02.382883535 +0000
@@ -19,6 +19,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/imx/imx-ssi.c linux-2.6.34-rc4/sound/soc/imx/imx-ssi.c
--- linux-2.6.34-rc3/sound/soc/imx/imx-ssi.c	2010-04-13 02:18:56.837633023 +0000
+++ linux-2.6.34-rc4/sound/soc/imx/imx-ssi.c	2010-04-13 02:19:02.382883535 +0000
@@ -39,6 +39,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/initval.h>
@@ -234,17 +235,20 @@
 			     struct snd_soc_dai *cpu_dai)
 {
 	struct imx_ssi *ssi = cpu_dai->private_data;
+	struct imx_pcm_dma_params *dma_data;
 	u32 reg, sccr;
 
 	/* Tx/Rx config */
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {
 		reg = SSI_STCCR;
-		cpu_dai->dma_data = &ssi->dma_params_tx;
+		dma_data = &ssi->dma_params_tx;
 	} else {
 		reg = SSI_SRCCR;
-		cpu_dai->dma_data = &ssi->dma_params_rx;
+		dma_data = &ssi->dma_params_rx;
 	}
 
+	snd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);
+
 	sccr = readl(ssi->base + reg) & ~SSI_STCCR_WL_MASK;
 
 	/* DAI data (word) size */
diff -urN linux-2.6.34-rc3/sound/soc/omap/mcpdm.c linux-2.6.34-rc4/sound/soc/omap/mcpdm.c
--- linux-2.6.34-rc3/sound/soc/omap/mcpdm.c	2010-04-13 02:18:56.839571885 +0000
+++ linux-2.6.34-rc4/sound/soc/omap/mcpdm.c	2010-04-13 02:19:02.384883525 +0000
@@ -25,6 +25,7 @@
 #include <linux/device.h>
 #include <linux/platform_device.h>
 #include <linux/wait.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/err.h>
 #include <linux/clk.h>
diff -urN linux-2.6.34-rc3/sound/soc/omap/omap-mcbsp.c linux-2.6.34-rc4/sound/soc/omap/omap-mcbsp.c
--- linux-2.6.34-rc3/sound/soc/omap/omap-mcbsp.c	2010-04-13 02:18:56.839571885 +0000
+++ linux-2.6.34-rc4/sound/soc/omap/omap-mcbsp.c	2010-04-13 02:19:02.384883525 +0000
@@ -297,7 +297,9 @@
 	omap_mcbsp_dai_dma_params[id][substream->stream].sync_mode = sync_mode;
 	omap_mcbsp_dai_dma_params[id][substream->stream].data_type =
 							OMAP_DMA_DATA_TYPE_S16;
-	cpu_dai->dma_data = &omap_mcbsp_dai_dma_params[id][substream->stream];
+
+	snd_soc_dai_set_dma_data(cpu_dai, substream,
+		&omap_mcbsp_dai_dma_params[id][substream->stream]);
 
 	if (mcbsp_data->configured) {
 		/* McBSP already configured by another stream */
diff -urN linux-2.6.34-rc3/sound/soc/omap/omap-mcpdm.c linux-2.6.34-rc4/sound/soc/omap/omap-mcpdm.c
--- linux-2.6.34-rc3/sound/soc/omap/omap-mcpdm.c	2010-04-13 02:18:56.840570480 +0000
+++ linux-2.6.34-rc4/sound/soc/omap/omap-mcpdm.c	2010-04-13 02:19:02.385883383 +0000
@@ -150,7 +150,8 @@
 	int stream = substream->stream;
 	int channels, err, link_mask = 0;
 
-	cpu_dai->dma_data = &omap_mcpdm_dai_dma_params[stream];
+	snd_soc_dai_set_dma_data(cpu_dai, substream,
+				 &omap_mcpdm_dai_dma_params[stream]);
 
 	channels = params_channels(params);
 	switch (channels) {
diff -urN linux-2.6.34-rc3/sound/soc/omap/omap-pcm.c linux-2.6.34-rc4/sound/soc/omap/omap-pcm.c
--- linux-2.6.34-rc3/sound/soc/omap/omap-pcm.c	2010-04-13 02:18:56.840570480 +0000
+++ linux-2.6.34-rc4/sound/soc/omap/omap-pcm.c	2010-04-13 02:19:02.385883383 +0000
@@ -23,6 +23,7 @@
  */
 
 #include <linux/dma-mapping.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
@@ -60,12 +61,11 @@
 	struct omap_runtime_data *prtd = runtime->private_data;
 	unsigned long flags;
 
-	if ((cpu_is_omap1510()) &&
-			(substream->stream == SNDRV_PCM_STREAM_PLAYBACK)) {
+	if ((cpu_is_omap1510())) {
 		/*
 		 * OMAP1510 doesn't fully support DMA progress counter
 		 * and there is no software emulation implemented yet,
-		 * so have to maintain our own playback progress counter
+		 * so have to maintain our own progress counters
 		 * that can be used by omap_pcm_pointer() instead.
 		 */
 		spin_lock_irqsave(&prtd->lock, flags);
@@ -100,9 +100,11 @@
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct omap_runtime_data *prtd = runtime->private_data;
-	struct omap_pcm_dma_data *dma_data = rtd->dai->cpu_dai->dma_data;
+	struct omap_pcm_dma_data *dma_data;
 	int err = 0;
 
+	dma_data = snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
+
 	/* return if this is a bufferless transfer e.g.
 	 * codec <--> BT codec or GSM modem -- lg FIXME */
 	if (!dma_data)
@@ -189,8 +191,7 @@
 	dma_params.frame_count	= runtime->periods;
 	omap_set_dma_params(prtd->dma_ch, &dma_params);
 
-	if ((cpu_is_omap1510()) &&
-			(substream->stream == SNDRV_PCM_STREAM_PLAYBACK))
+	if ((cpu_is_omap1510()))
 		omap_enable_dma_irq(prtd->dma_ch, OMAP_DMA_FRAME_IRQ |
 			      OMAP_DMA_LAST_IRQ | OMAP_DMA_BLOCK_IRQ);
 	else
@@ -248,14 +249,15 @@
 	dma_addr_t ptr;
 	snd_pcm_uframes_t offset;
 
-	if (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {
+	if (cpu_is_omap1510()) {
+		offset = prtd->period_index * runtime->period_size;
+	} else if (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {
 		ptr = omap_get_dma_dst_pos(prtd->dma_ch);
 		offset = bytes_to_frames(runtime, ptr - runtime->dma_addr);
-	} else if (!(cpu_is_omap1510())) {
+	} else {
 		ptr = omap_get_dma_src_pos(prtd->dma_ch);
 		offset = bytes_to_frames(runtime, ptr - runtime->dma_addr);
-	} else
-		offset = prtd->period_index * runtime->period_size;
+	}
 
 	if (offset >= runtime->buffer_size)
 		offset = 0;
diff -urN linux-2.6.34-rc3/sound/soc/pxa/pxa-ssp.c linux-2.6.34-rc4/sound/soc/pxa/pxa-ssp.c
--- linux-2.6.34-rc3/sound/soc/pxa/pxa-ssp.c	2010-04-13 02:18:56.840570480 +0000
+++ linux-2.6.34-rc4/sound/soc/pxa/pxa-ssp.c	2010-04-13 02:19:02.385883383 +0000
@@ -16,6 +16,7 @@
 
 #include <linux/init.h>
 #include <linux/module.h>
+#include <linux/slab.h>
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/io.h>
@@ -121,10 +122,9 @@
 		ssp_disable(ssp);
 	}
 
-	if (cpu_dai->dma_data) {
-		kfree(cpu_dai->dma_data);
-		cpu_dai->dma_data = NULL;
-	}
+	kfree(snd_soc_dai_get_dma_data(cpu_dai, substream));
+	snd_soc_dai_set_dma_data(cpu_dai, substream, NULL);
+
 	return ret;
 }
 
@@ -141,10 +141,8 @@
 		clk_disable(ssp->clk);
 	}
 
-	if (cpu_dai->dma_data) {
-		kfree(cpu_dai->dma_data);
-		cpu_dai->dma_data = NULL;
-	}
+	kfree(snd_soc_dai_get_dma_data(cpu_dai, substream));
+	snd_soc_dai_set_dma_data(cpu_dai, substream, NULL);
 }
 
 #ifdef CONFIG_PM
@@ -569,19 +567,23 @@
 	u32 sspsp;
 	int width = snd_pcm_format_physical_width(params_format(params));
 	int ttsa = ssp_read_reg(ssp, SSTSA) & 0xf;
+	struct pxa2xx_pcm_dma_params *dma_data;
+
+	dma_data = snd_soc_dai_get_dma_data(dai, substream);
 
 	/* generate correct DMA params */
-	if (cpu_dai->dma_data)
-		kfree(cpu_dai->dma_data);
+	kfree(dma_data);
 
 	/* Network mode with one active slot (ttsa == 1) can be used
 	 * to force 16-bit frame width on the wire (for S16_LE), even
 	 * with two channels. Use 16-bit DMA transfers for this case.
 	 */
-	cpu_dai->dma_data = ssp_get_dma_params(ssp,
+	dma_data = ssp_get_dma_params(ssp,
 			((chn == 2) && (ttsa != 1)) || (width == 32),
 			substream->stream == SNDRV_PCM_STREAM_PLAYBACK);
 
+	snd_soc_dai_set_dma_data(dai, substream, dma_data);
+
 	/* we can only change the settings if the port is not in use */
 	if (ssp_read_reg(ssp, SSCR0) & SSCR0_SSE)
 		return 0;
diff -urN linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-ac97.c linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-ac97.c
--- linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-ac97.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-ac97.c	2010-04-13 02:19:02.386884134 +0000
@@ -122,11 +122,14 @@
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai *cpu_dai = rtd->dai->cpu_dai;
+	struct pxa2xx_pcm_dma_params *dma_data;
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		cpu_dai->dma_data = &pxa2xx_ac97_pcm_stereo_out;
+		dma_data = &pxa2xx_ac97_pcm_stereo_out;
 	else
-		cpu_dai->dma_data = &pxa2xx_ac97_pcm_stereo_in;
+		dma_data = &pxa2xx_ac97_pcm_stereo_in;
+
+	snd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);
 
 	return 0;
 }
@@ -137,11 +140,14 @@
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai *cpu_dai = rtd->dai->cpu_dai;
+	struct pxa2xx_pcm_dma_params *dma_data;
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		cpu_dai->dma_data = &pxa2xx_ac97_pcm_aux_mono_out;
+		dma_data = &pxa2xx_ac97_pcm_aux_mono_out;
 	else
-		cpu_dai->dma_data = &pxa2xx_ac97_pcm_aux_mono_in;
+		dma_data = &pxa2xx_ac97_pcm_aux_mono_in;
+
+	snd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);
 
 	return 0;
 }
@@ -156,7 +162,8 @@
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
 		return -ENODEV;
 	else
-		cpu_dai->dma_data = &pxa2xx_ac97_pcm_mic_mono_in;
+		snd_soc_dai_set_dma_data(cpu_dai, substream,
+					 &pxa2xx_ac97_pcm_mic_mono_in);
 
 	return 0;
 }
diff -urN linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-i2s.c linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-i2s.c
--- linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-i2s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-i2s.c	2010-04-13 02:19:02.386884134 +0000
@@ -164,6 +164,7 @@
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai *cpu_dai = rtd->dai->cpu_dai;
+	struct pxa2xx_pcm_dma_params *dma_data;
 
 	BUG_ON(IS_ERR(clk_i2s));
 	clk_enable(clk_i2s);
@@ -171,9 +172,11 @@
 	pxa_i2s_wait();
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		cpu_dai->dma_data = &pxa2xx_i2s_pcm_stereo_out;
+		dma_data = &pxa2xx_i2s_pcm_stereo_out;
 	else
-		cpu_dai->dma_data = &pxa2xx_i2s_pcm_stereo_in;
+		dma_data = &pxa2xx_i2s_pcm_stereo_in;
+
+	snd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);
 
 	/* is port used by another stream */
 	if (!(SACR0 & SACR0_ENB)) {
diff -urN linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-pcm.c linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-pcm.c
--- linux-2.6.34-rc3/sound/soc/pxa/pxa2xx-pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/pxa/pxa2xx-pcm.c	2010-04-13 02:19:02.386884134 +0000
@@ -25,9 +25,11 @@
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct pxa2xx_runtime_data *prtd = runtime->private_data;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct pxa2xx_pcm_dma_params *dma = rtd->dai->cpu_dai->dma_data;
+	struct pxa2xx_pcm_dma_params *dma;
 	int ret;
 
+	dma = snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
+
 	/* return if this is a bufferless transfer e.g.
 	 * codec <--> BT codec or GSM modem -- lg FIXME */
 	if (!dma)
diff -urN linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-ac97.c linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-ac97.c
--- linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-ac97.c	2010-04-13 02:18:56.841574427 +0000
+++ linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-ac97.c	2010-04-13 02:19:02.387883649 +0000
@@ -224,11 +224,14 @@
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai *cpu_dai = rtd->dai->cpu_dai;
+	struct s3c_dma_params *dma_data;
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		cpu_dai->dma_data = &s3c_ac97_pcm_out;
+		dma_data = &s3c_ac97_pcm_out;
 	else
-		cpu_dai->dma_data = &s3c_ac97_pcm_in;
+		dma_data = &s3c_ac97_pcm_in;
+
+	snd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);
 
 	return 0;
 }
@@ -238,8 +241,8 @@
 {
 	u32 ac_glbctrl;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	int channel = ((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->channel;
+	struct s3c_dma_params *dma_data =
+		snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 
 	ac_glbctrl = readl(s3c_ac97.regs + S3C_AC97_GLBCTRL);
 	if (substream->stream == SNDRV_PCM_STREAM_CAPTURE)
@@ -265,7 +268,7 @@
 
 	writel(ac_glbctrl, s3c_ac97.regs + S3C_AC97_GLBCTRL);
 
-	s3c2410_dma_ctrl(channel, S3C2410_DMAOP_STARTED);
+	s3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);
 
 	return 0;
 }
@@ -280,7 +283,7 @@
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
 		return -ENODEV;
 	else
-		cpu_dai->dma_data = &s3c_ac97_mic_in;
+		snd_soc_dai_set_dma_data(cpu_dai, substream, &s3c_ac97_mic_in);
 
 	return 0;
 }
@@ -290,8 +293,8 @@
 {
 	u32 ac_glbctrl;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	int channel = ((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->channel;
+	struct s3c_dma_params *dma_data =
+		snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 
 	ac_glbctrl = readl(s3c_ac97.regs + S3C_AC97_GLBCTRL);
 	ac_glbctrl &= ~S3C_AC97_GLBCTRL_MICINTM_MASK;
@@ -311,7 +314,7 @@
 
 	writel(ac_glbctrl, s3c_ac97.regs + S3C_AC97_GLBCTRL);
 
-	s3c2410_dma_ctrl(channel, S3C2410_DMAOP_STARTED);
+	s3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);
 
 	return 0;
 }
diff -urN linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-dma.c linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-dma.c
--- linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-dma.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-dma.c	2010-04-13 02:19:02.387883649 +0000
@@ -145,10 +145,12 @@
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct s3c24xx_runtime_data *prtd = runtime->private_data;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct s3c_dma_params *dma = rtd->dai->cpu_dai->dma_data;
 	unsigned long totbytes = params_buffer_bytes(params);
+	struct s3c_dma_params *dma =
+		snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 	int ret = 0;
 
+
 	pr_debug("Entered %s\n", __func__);
 
 	/* return if this is a bufferless transfer e.g.
diff -urN linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-i2s-v2.c linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-i2s-v2.c
--- linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-i2s-v2.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-i2s-v2.c	2010-04-13 02:19:02.387883649 +0000
@@ -339,14 +339,17 @@
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai_link *dai = rtd->dai;
 	struct s3c_i2sv2_info *i2s = to_info(dai->cpu_dai);
+	struct s3c_dma_params *dma_data;
 	u32 iismod;
 
 	pr_debug("Entered %s\n", __func__);
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		dai->cpu_dai->dma_data = i2s->dma_playback;
+		dma_data = i2s->dma_playback;
 	else
-		dai->cpu_dai->dma_data = i2s->dma_capture;
+		dma_data = i2s->dma_capture;
+
+	snd_soc_dai_set_dma_data(dai->cpu_dai, substream, dma_data);
 
 	/* Working copies of register */
 	iismod = readl(i2s->regs + S3C2412_IISMOD);
@@ -394,8 +397,8 @@
 	int capture = (substream->stream == SNDRV_PCM_STREAM_CAPTURE);
 	unsigned long irqs;
 	int ret = 0;
-	int channel = ((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->channel;
+	struct s3c_dma_params *dma_data =
+		snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 
 	pr_debug("Entered %s\n", __func__);
 
@@ -431,7 +434,7 @@
 		 * of the auto reload mechanism of S3C24XX.
 		 * This call won't bother S3C64XX.
 		 */
-		s3c2410_dma_ctrl(channel, S3C2410_DMAOP_STARTED);
+		s3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);
 
 		break;
 
diff -urN linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-pcm.c linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-pcm.c
--- linux-2.6.34-rc3/sound/soc/s3c24xx/s3c-pcm.c	2010-04-13 02:18:56.841574427 +0000
+++ linux-2.6.34-rc4/sound/soc/s3c24xx/s3c-pcm.c	2010-04-13 02:19:02.387883649 +0000
@@ -178,6 +178,7 @@
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
 	struct snd_soc_dai_link *dai = rtd->dai;
 	struct s3c_pcm_info *pcm = to_info(dai->cpu_dai);
+	struct s3c_dma_params *dma_data;
 	void __iomem *regs = pcm->regs;
 	struct clk *clk;
 	int sclk_div, sync_div;
@@ -187,9 +188,11 @@
 	dev_dbg(pcm->dev, "Entered %s\n", __func__);
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		dai->cpu_dai->dma_data = pcm->dma_playback;
+		dma_data = pcm->dma_playback;
 	else
-		dai->cpu_dai->dma_data = pcm->dma_capture;
+		dma_data = pcm->dma_capture;
+
+	snd_soc_dai_set_dma_data(dai->cpu_dai, substream, dma_data);
 
 	/* Strictly check for sample size */
 	switch (params_format(params)) {
diff -urN linux-2.6.34-rc3/sound/soc/s3c24xx/s3c24xx-i2s.c linux-2.6.34-rc4/sound/soc/s3c24xx/s3c24xx-i2s.c
--- linux-2.6.34-rc3/sound/soc/s3c24xx/s3c24xx-i2s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/s3c24xx/s3c24xx-i2s.c	2010-04-13 02:19:02.388884148 +0000
@@ -242,14 +242,17 @@
 				 struct snd_soc_dai *dai)
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
+	struct s3c_dma_params *dma_data;
 	u32 iismod;
 
 	pr_debug("Entered %s\n", __func__);
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
-		rtd->dai->cpu_dai->dma_data = &s3c24xx_i2s_pcm_stereo_out;
+		dma_data = &s3c24xx_i2s_pcm_stereo_out;
 	else
-		rtd->dai->cpu_dai->dma_data = &s3c24xx_i2s_pcm_stereo_in;
+		dma_data = &s3c24xx_i2s_pcm_stereo_in;
+
+	snd_soc_dai_set_dma_data(rtd->dai->cpu_dai, substream, dma_data);
 
 	/* Working copies of register */
 	iismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);
@@ -258,13 +261,11 @@
 	switch (params_format(params)) {
 	case SNDRV_PCM_FORMAT_S8:
 		iismod &= ~S3C2410_IISMOD_16BIT;
-		((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->dma_size = 1;
+		dma_data->dma_size = 1;
 		break;
 	case SNDRV_PCM_FORMAT_S16_LE:
 		iismod |= S3C2410_IISMOD_16BIT;
-		((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->dma_size = 2;
+		dma_data->dma_size = 2;
 		break;
 	default:
 		return -EINVAL;
@@ -280,8 +281,8 @@
 {
 	int ret = 0;
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	int channel = ((struct s3c_dma_params *)
-		  rtd->dai->cpu_dai->dma_data)->channel;
+	struct s3c_dma_params *dma_data =
+		snd_soc_dai_get_dma_data(rtd->dai->cpu_dai, substream);
 
 	pr_debug("Entered %s\n", __func__);
 
@@ -300,7 +301,7 @@
 		else
 			s3c24xx_snd_txctrl(1);
 
-		s3c2410_dma_ctrl(channel, S3C2410_DMAOP_STARTED);
+		s3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);
 		break;
 	case SNDRV_PCM_TRIGGER_STOP:
 	case SNDRV_PCM_TRIGGER_SUSPEND:
diff -urN linux-2.6.34-rc3/sound/soc/s6000/s6000-i2s.c linux-2.6.34-rc4/sound/soc/s6000/s6000-i2s.c
--- linux-2.6.34-rc3/sound/soc/s6000/s6000-i2s.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/s6000/s6000-i2s.c	2010-04-13 02:19:02.388884148 +0000
@@ -16,6 +16,7 @@
 #include <linux/clk.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
@@ -518,7 +519,8 @@
 
 	s6000_i2s_dai.dev = &pdev->dev;
 	s6000_i2s_dai.private_data = dev;
-	s6000_i2s_dai.dma_data = &dev->dma_params;
+	s6000_i2s_dai.capture.dma_data = &dev->dma_params;
+	s6000_i2s_dai.playback.dma_data = &dev->dma_params;
 
 	dev->sifbase = sifmem->start;
 	dev->scbbase = mmio;
diff -urN linux-2.6.34-rc3/sound/soc/s6000/s6000-pcm.c linux-2.6.34-rc4/sound/soc/s6000/s6000-pcm.c
--- linux-2.6.34-rc3/sound/soc/s6000/s6000-pcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/s6000/s6000-pcm.c	2010-04-13 02:19:02.388884148 +0000
@@ -58,13 +58,15 @@
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct s6000_runtime_data *prtd = runtime->private_data;
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	int channel;
 	unsigned int period_size;
 	unsigned int dma_offset;
 	dma_addr_t dma_pos;
 	dma_addr_t src, dst;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	period_size = snd_pcm_lib_period_bytes(substream);
 	dma_offset = prtd->period * period_size;
 	dma_pos = runtime->dma_addr + dma_offset;
@@ -101,7 +103,8 @@
 {
 	struct snd_pcm *pcm = data;
 	struct snd_soc_pcm_runtime *runtime = pcm->private_data;
-	struct s6000_pcm_dma_params *params = runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *params =
+		snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
 	struct s6000_runtime_data *prtd;
 	unsigned int has_xrun;
 	int i, ret = IRQ_NONE;
@@ -172,11 +175,13 @@
 {
 	struct s6000_runtime_data *prtd = substream->runtime->private_data;
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	unsigned long flags;
 	int srcinc;
 	u32 dma;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	spin_lock_irqsave(&prtd->lock, flags);
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {
@@ -212,10 +217,12 @@
 {
 	struct s6000_runtime_data *prtd = substream->runtime->private_data;
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	unsigned long flags;
 	u32 channel;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
 		channel = par->dma_out;
 	else
@@ -236,9 +243,11 @@
 static int s6000_pcm_trigger(struct snd_pcm_substream *substream, int cmd)
 {
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	int ret;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	ret = par->trigger(substream, cmd, 0);
 	if (ret < 0)
 		return ret;
@@ -275,13 +284,15 @@
 static snd_pcm_uframes_t s6000_pcm_pointer(struct snd_pcm_substream *substream)
 {
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct s6000_runtime_data *prtd = runtime->private_data;
 	unsigned long flags;
 	unsigned int offset;
 	dma_addr_t count;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	spin_lock_irqsave(&prtd->lock, flags);
 
 	if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
@@ -305,11 +316,12 @@
 static int s6000_pcm_open(struct snd_pcm_substream *substream)
 {
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	struct snd_pcm_runtime *runtime = substream->runtime;
 	struct s6000_runtime_data *prtd;
 	int ret;
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
 	snd_soc_set_runtime_hwparams(substream, &s6000_pcm_hardware);
 
 	ret = snd_pcm_hw_constraint_step(runtime, 0,
@@ -364,7 +376,7 @@
 				 struct snd_pcm_hw_params *hw_params)
 {
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par;
 	int ret;
 	ret = snd_pcm_lib_malloc_pages(substream,
 				       params_buffer_bytes(hw_params));
@@ -373,6 +385,8 @@
 		return ret;
 	}
 
+	par = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	if (par->same_rate) {
 		spin_lock(&par->lock);
 		if (par->rate == -1 ||
@@ -392,7 +406,8 @@
 static int s6000_pcm_hw_free(struct snd_pcm_substream *substream)
 {
 	struct snd_soc_pcm_runtime *soc_runtime = substream->private_data;
-	struct s6000_pcm_dma_params *par = soc_runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *par =
+		snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
 
 	spin_lock(&par->lock);
 	par->in_use &= ~(1 << substream->stream);
@@ -417,7 +432,8 @@
 static void s6000_pcm_free(struct snd_pcm *pcm)
 {
 	struct snd_soc_pcm_runtime *runtime = pcm->private_data;
-	struct s6000_pcm_dma_params *params = runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *params =
+		snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
 
 	free_irq(params->irq, pcm);
 	snd_pcm_lib_preallocate_free_for_all(pcm);
@@ -429,9 +445,11 @@
 			 struct snd_soc_dai *dai, struct snd_pcm *pcm)
 {
 	struct snd_soc_pcm_runtime *runtime = pcm->private_data;
-	struct s6000_pcm_dma_params *params = runtime->dai->cpu_dai->dma_data;
+	struct s6000_pcm_dma_params *params;
 	int res;
 
+	params = snd_soc_dai_get_dma_data(soc_runtime->dai->cpu_dai, substream);
+
 	if (!card->dev->dma_mask)
 		card->dev->dma_mask = &s6000_pcm_dmamask;
 	if (!card->dev->coherent_dma_mask)
diff -urN linux-2.6.34-rc3/sound/soc/sh/dma-sh7760.c linux-2.6.34-rc4/sound/soc/sh/dma-sh7760.c
--- linux-2.6.34-rc3/sound/soc/sh/dma-sh7760.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/sh/dma-sh7760.c	2010-04-13 02:19:02.389883496 +0000
@@ -13,6 +13,7 @@
  */
 
 #include <linux/module.h>
+#include <linux/gfp.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
diff -urN linux-2.6.34-rc3/sound/soc/sh/fsi.c linux-2.6.34-rc4/sound/soc/sh/fsi.c
--- linux-2.6.34-rc3/sound/soc/sh/fsi.c	2010-04-13 02:18:56.843570357 +0000
+++ linux-2.6.34-rc4/sound/soc/sh/fsi.c	2010-04-13 02:19:02.389883496 +0000
@@ -19,6 +19,7 @@
 #include <linux/list.h>
 #include <linux/pm_runtime.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/initval.h>
diff -urN linux-2.6.34-rc3/sound/soc/sh/siu_dai.c linux-2.6.34-rc4/sound/soc/sh/siu_dai.c
--- linux-2.6.34-rc3/sound/soc/sh/siu_dai.c	2010-04-13 02:18:56.843570357 +0000
+++ linux-2.6.34-rc4/sound/soc/sh/siu_dai.c	2010-04-13 02:19:02.390883137 +0000
@@ -22,6 +22,7 @@
 #include <linux/delay.h>
 #include <linux/firmware.h>
 #include <linux/pm_runtime.h>
+#include <linux/slab.h>
 
 #include <asm/clock.h>
 #include <asm/siu.h>
diff -urN linux-2.6.34-rc3/sound/soc/sh/siu_pcm.c linux-2.6.34-rc4/sound/soc/sh/siu_pcm.c
--- linux-2.6.34-rc3/sound/soc/sh/siu_pcm.c	2010-04-13 02:18:56.843570357 +0000
+++ linux-2.6.34-rc4/sound/soc/sh/siu_pcm.c	2010-04-13 02:19:02.390883137 +0000
@@ -24,7 +24,6 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
-#include <linux/slab.h>
 
 #include <sound/control.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/soc/soc-core.c linux-2.6.34-rc4/sound/soc/soc-core.c
--- linux-2.6.34-rc3/sound/soc/soc-core.c	2010-04-13 02:18:56.844633036 +0000
+++ linux-2.6.34-rc4/sound/soc/soc-core.c	2010-04-13 02:19:02.391883333 +0000
@@ -28,6 +28,7 @@
 #include <linux/bitops.h>
 #include <linux/debugfs.h>
 #include <linux/platform_device.h>
+#include <linux/slab.h>
 #include <sound/ac97_codec.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
@@ -1548,7 +1549,8 @@
 			mutex_unlock(&codec->mutex);
 			return ret;
 		}
-		if (card->dai_link[i].codec_dai->ac97_control) {
+		/* Check for codec->ac97 to handle the ac97.c fun */
+		if (card->dai_link[i].codec_dai->ac97_control && codec->ac97) {
 			snd_ac97_dev_add_pdata(codec->ac97,
 				card->dai_link[i].cpu_dai->ac97_pdata);
 		}
diff -urN linux-2.6.34-rc3/sound/soc/soc-dapm.c linux-2.6.34-rc4/sound/soc/soc-dapm.c
--- linux-2.6.34-rc3/sound/soc/soc-dapm.c	2010-04-13 02:18:56.845633053 +0000
+++ linux-2.6.34-rc4/sound/soc/soc-dapm.c	2010-04-13 02:19:02.391883333 +0000
@@ -38,6 +38,7 @@
 #include <linux/platform_device.h>
 #include <linux/jiffies.h>
 #include <linux/debugfs.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/soc/txx9/txx9aclc-ac97.c linux-2.6.34-rc4/sound/soc/txx9/txx9aclc-ac97.c
--- linux-2.6.34-rc3/sound/soc/txx9/txx9aclc-ac97.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/txx9/txx9aclc-ac97.c	2010-04-13 02:19:02.391883333 +0000
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/io.h>
+#include <linux/gfp.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/soc.h>
diff -urN linux-2.6.34-rc3/sound/soc/txx9/txx9aclc.c linux-2.6.34-rc4/sound/soc/txx9/txx9aclc.c
--- linux-2.6.34-rc3/sound/soc/txx9/txx9aclc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/soc/txx9/txx9aclc.c	2010-04-13 02:19:02.391883333 +0000
@@ -15,6 +15,7 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/scatterlist.h>
+#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/pcm_params.h>
diff -urN linux-2.6.34-rc3/sound/sound_firmware.c linux-2.6.34-rc4/sound/sound_firmware.c
--- linux-2.6.34-rc3/sound/sound_firmware.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/sound_firmware.c	2010-04-13 02:19:02.391883333 +0000
@@ -2,7 +2,6 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 #include <linux/mm.h>
-#include <linux/slab.h>
 #include <linux/sched.h>
 #include <asm/uaccess.h>
 #include "oss/sound_firmware.h"
diff -urN linux-2.6.34-rc3/sound/sparc/cs4231.c linux-2.6.34-rc4/sound/sparc/cs4231.c
--- linux-2.6.34-rc3/sound/sparc/cs4231.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/sparc/cs4231.c	2010-04-13 02:19:02.392883258 +0000
@@ -10,7 +10,6 @@
 
 #include <linux/module.h>
 #include <linux/kernel.h>
-#include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/init.h>
 #include <linux/interrupt.h>
diff -urN linux-2.6.34-rc3/sound/sparc/dbri.c linux-2.6.34-rc4/sound/sparc/dbri.c
--- linux-2.6.34-rc3/sound/sparc/dbri.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/sparc/dbri.c	2010-04-13 02:19:02.392883258 +0000
@@ -58,6 +58,7 @@
 #include <linux/irq.h>
 #include <linux/io.h>
 #include <linux/dma-mapping.h>
+#include <linux/gfp.h>
 
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/synth/emux/emux_proc.c linux-2.6.34-rc4/sound/synth/emux/emux_proc.c
--- linux-2.6.34-rc3/sound/synth/emux/emux_proc.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/synth/emux/emux_proc.c	2010-04-13 02:19:02.392883258 +0000
@@ -19,7 +19,6 @@
  */
 
 #include <linux/wait.h>
-#include <linux/slab.h>
 #include <sound/core.h>
 #include <sound/emux_synth.h>
 #include <sound/info.h>
diff -urN linux-2.6.34-rc3/sound/usb/caiaq/audio.c linux-2.6.34-rc4/sound/usb/caiaq/audio.c
--- linux-2.6.34-rc3/sound/usb/caiaq/audio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/caiaq/audio.c	2010-04-13 02:19:02.393883613 +0000
@@ -17,6 +17,7 @@
 */
 
 #include <linux/spinlock.h>
+#include <linux/slab.h>
 #include <linux/init.h>
 #include <linux/usb.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/usb/caiaq/device.c linux-2.6.34-rc4/sound/usb/caiaq/device.c
--- linux-2.6.34-rc3/sound/usb/caiaq/device.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/caiaq/device.c	2010-04-13 02:19:02.393883613 +0000
@@ -23,6 +23,7 @@
 #include <linux/interrupt.h>
 #include <linux/module.h>
 #include <linux/init.h>
+#include <linux/gfp.h>
 #include <linux/usb.h>
 #include <sound/initval.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/usb/caiaq/midi.c linux-2.6.34-rc4/sound/usb/caiaq/midi.c
--- linux-2.6.34-rc3/sound/usb/caiaq/midi.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/caiaq/midi.c	2010-04-13 02:19:02.393883613 +0000
@@ -17,6 +17,7 @@
 */
 
 #include <linux/usb.h>
+#include <linux/gfp.h>
 #include <sound/rawmidi.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/us122l.c linux-2.6.34-rc4/sound/usb/usx2y/us122l.c
--- linux-2.6.34-rc3/sound/usb/usx2y/us122l.c	2010-04-13 02:18:56.849571844 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/us122l.c	2010-04-13 02:19:02.397883708 +0000
@@ -16,6 +16,7 @@
  * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
  */
 
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <linux/usb/audio.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/usX2Yhwdep.c linux-2.6.34-rc4/sound/usb/usx2y/usX2Yhwdep.c
--- linux-2.6.34-rc3/sound/usb/usx2y/usX2Yhwdep.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/usX2Yhwdep.c	2010-04-13 02:19:02.397883708 +0000
@@ -21,6 +21,7 @@
  */
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <sound/core.h>
 #include <sound/memalloc.h>
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/usb_stream.c linux-2.6.34-rc4/sound/usb/usx2y/usb_stream.c
--- linux-2.6.34-rc3/sound/usb/usx2y/usb_stream.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/usb_stream.c	2010-04-13 02:19:02.397883708 +0000
@@ -17,6 +17,7 @@
  */
 
 #include <linux/usb.h>
+#include <linux/gfp.h>
 
 #include "usb_stream.h"
 
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/usbusx2y.c linux-2.6.34-rc4/sound/usb/usx2y/usbusx2y.c
--- linux-2.6.34-rc3/sound/usb/usx2y/usbusx2y.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/usbusx2y.c	2010-04-13 02:19:02.397883708 +0000
@@ -133,6 +133,7 @@
 #include <linux/init.h>
 #include <linux/module.h>
 #include <linux/moduleparam.h>
+#include <linux/slab.h>
 #include <linux/interrupt.h>
 #include <linux/usb.h>
 #include <sound/core.h>
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/usbusx2yaudio.c linux-2.6.34-rc4/sound/usb/usx2y/usbusx2yaudio.c
--- linux-2.6.34-rc3/sound/usb/usx2y/usbusx2yaudio.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/usbusx2yaudio.c	2010-04-13 02:19:02.399217951 +0000
@@ -32,6 +32,7 @@
 
 
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include <linux/usb.h>
 #include <sound/core.h>
 #include <sound/info.h>
diff -urN linux-2.6.34-rc3/sound/usb/usx2y/usx2yhwdeppcm.c linux-2.6.34-rc4/sound/usb/usx2y/usx2yhwdeppcm.c
--- linux-2.6.34-rc3/sound/usb/usx2y/usx2yhwdeppcm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/sound/usb/usx2y/usx2yhwdeppcm.c	2010-04-13 02:19:02.399217951 +0000
@@ -51,6 +51,7 @@
 */
 
 #include <linux/delay.h>
+#include <linux/gfp.h>
 #include "usbusx2yaudio.c"
 
 #if defined(USX2Y_NRPACKS_VARIABLE) || (!defined(USX2Y_NRPACKS_VARIABLE) &&  USX2Y_NRPACKS == 1)
diff -urN linux-2.6.34-rc3/tools/perf/Makefile linux-2.6.34-rc4/tools/perf/Makefile
--- linux-2.6.34-rc3/tools/perf/Makefile	2010-04-13 02:18:56.850570444 +0000
+++ linux-2.6.34-rc4/tools/perf/Makefile	2010-04-13 02:19:02.400883536 +0000
@@ -200,7 +200,7 @@
 
 CFLAGS = -ggdb3 -Wall -Wextra -std=gnu99 -Werror $(CFLAGS_OPTIMIZE) -D_FORTIFY_SOURCE=2 $(EXTRA_WARNINGS) $(EXTRA_CFLAGS)
 EXTLIBS = -lpthread -lrt -lelf -lm
-ALL_CFLAGS = $(CFLAGS)
+ALL_CFLAGS = $(CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64
 ALL_LDFLAGS = $(LDFLAGS)
 STRIP ?= strip
 
@@ -492,19 +492,19 @@
 	PTHREAD_LIBS =
 endif
 
-ifeq ($(shell sh -c "(echo '\#include <libelf.h>'; echo 'int main(void) { Elf * elf = elf_begin(0, ELF_C_READ, 0); return (long)elf; }') | $(CC) -x c - $(ALL_CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
-ifneq ($(shell sh -c "(echo '\#include <gnu/libc-version.h>'; echo 'int main(void) { const char * version = gnu_get_libc_version(); return (long)version; }') | $(CC) -x c - $(ALL_CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
+ifeq ($(shell sh -c "(echo '\#include <libelf.h>'; echo 'int main(void) { Elf * elf = elf_begin(0, ELF_C_READ, 0); return (long)elf; }') | $(CC) -x c - $(ALL_CFLAGS) -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
+ifneq ($(shell sh -c "(echo '\#include <gnu/libc-version.h>'; echo 'int main(void) { const char * version = gnu_get_libc_version(); return (long)version; }') | $(CC) -x c - $(ALL_CFLAGS) -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
 	msg := $(error No gnu/libc-version.h found, please install glibc-dev[el]/glibc-static);
 endif
 
-	ifneq ($(shell sh -c "(echo '\#include <libelf.h>'; echo 'int main(void) { Elf * elf = elf_begin(0, ELF_C_READ_MMAP, 0); return (long)elf; }') | $(CC) -x c - $(ALL_CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
+	ifneq ($(shell sh -c "(echo '\#include <libelf.h>'; echo 'int main(void) { Elf * elf = elf_begin(0, ELF_C_READ_MMAP, 0); return (long)elf; }') | $(CC) -x c - $(ALL_CFLAGS) -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
 		BASIC_CFLAGS += -DLIBELF_NO_MMAP
 	endif
 else
 	msg := $(error No libelf.h/libelf found, please install libelf-dev/elfutils-libelf-devel and glibc-dev[el]);
 endif
 
-ifneq ($(shell sh -c "(echo '\#include <dwarf.h>'; echo '\#include <libdw.h>'; echo 'int main(void) { Dwarf *dbg; dbg = dwarf_begin(0, DWARF_C_READ); return (long)dbg; }') | $(CC) -x c - $(ALL_CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -I/usr/include/elfutils -ldw -lelf -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
+ifneq ($(shell sh -c "(echo '\#include <dwarf.h>'; echo '\#include <libdw.h>'; echo 'int main(void) { Dwarf *dbg; dbg = dwarf_begin(0, DWARF_C_READ); return (long)dbg; }') | $(CC) -x c - $(ALL_CFLAGS) -I/usr/include/elfutils -ldw -lelf -o $(BITBUCKET) $(ALL_LDFLAGS) $(EXTLIBS) "$(QUIET_STDERR)" && echo y"), y)
 	msg := $(warning No libdw.h found or old libdw.h found, disables dwarf support. Please install elfutils-devel/elfutils-dev);
 	BASIC_CFLAGS += -DNO_DWARF_SUPPORT
 else
diff -urN linux-2.6.34-rc3/tools/perf/util/scripting-engines/trace-event-python.c linux-2.6.34-rc4/tools/perf/util/scripting-engines/trace-event-python.c
--- linux-2.6.34-rc3/tools/perf/util/scripting-engines/trace-event-python.c	2010-04-13 02:18:56.860570469 +0000
+++ linux-2.6.34-rc4/tools/perf/util/scripting-engines/trace-event-python.c	2010-04-13 02:19:02.410883718 +0000
@@ -208,7 +208,7 @@
 				 int size __unused,
 				 unsigned long long nsecs, char *comm)
 {
-	PyObject *handler, *retval, *context, *t;
+	PyObject *handler, *retval, *context, *t, *obj;
 	static char handler_name[256];
 	struct format_field *field;
 	unsigned long long val;
@@ -256,16 +256,23 @@
 				offset &= 0xffff;
 			} else
 				offset = field->offset;
-			PyTuple_SetItem(t, n++,
-				PyString_FromString((char *)data + offset));
+			obj = PyString_FromString((char *)data + offset);
 		} else { /* FIELD_IS_NUMERIC */
 			val = read_size(data + field->offset, field->size);
 			if (field->flags & FIELD_IS_SIGNED) {
-				PyTuple_SetItem(t, n++, PyInt_FromLong(val));
+				if ((long long)val >= LONG_MIN &&
+				    (long long)val <= LONG_MAX)
+					obj = PyInt_FromLong(val);
+				else
+					obj = PyLong_FromLongLong(val);
 			} else {
-				PyTuple_SetItem(t, n++, PyInt_FromLong(val));
+				if (val <= LONG_MAX)
+					obj = PyInt_FromLong(val);
+				else
+					obj = PyLong_FromUnsignedLongLong(val);
 			}
 		}
+		PyTuple_SetItem(t, n++, obj);
 	}
 
 	if (_PyTuple_Resize(&t, n) == -1)
diff -urN linux-2.6.34-rc3/virt/kvm/assigned-dev.c linux-2.6.34-rc4/virt/kvm/assigned-dev.c
--- linux-2.6.34-rc3/virt/kvm/assigned-dev.c	2010-04-13 02:18:56.864633413 +0000
+++ linux-2.6.34-rc4/virt/kvm/assigned-dev.c	2010-04-13 02:19:02.413883954 +0000
@@ -16,6 +16,7 @@
 #include <linux/spinlock.h>
 #include <linux/pci.h>
 #include <linux/interrupt.h>
+#include <linux/slab.h>
 #include "irq.h"
 
 static struct kvm_assigned_dev_kernel *kvm_find_assigned_dev(struct list_head *head,
diff -urN linux-2.6.34-rc3/virt/kvm/coalesced_mmio.c linux-2.6.34-rc4/virt/kvm/coalesced_mmio.c
--- linux-2.6.34-rc3/virt/kvm/coalesced_mmio.c	2010-04-13 02:18:56.864633413 +0000
+++ linux-2.6.34-rc4/virt/kvm/coalesced_mmio.c	2010-04-13 02:19:02.414883252 +0000
@@ -10,6 +10,7 @@
 #include "iodev.h"
 
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 #include <linux/kvm.h>
 
 #include "coalesced_mmio.h"
diff -urN linux-2.6.34-rc3/virt/kvm/eventfd.c linux-2.6.34-rc4/virt/kvm/eventfd.c
--- linux-2.6.34-rc3/virt/kvm/eventfd.c	2010-04-13 02:18:56.864633413 +0000
+++ linux-2.6.34-rc4/virt/kvm/eventfd.c	2010-04-13 02:19:02.414883252 +0000
@@ -30,6 +30,7 @@
 #include <linux/list.h>
 #include <linux/eventfd.h>
 #include <linux/kernel.h>
+#include <linux/slab.h>
 
 #include "iodev.h"
 
diff -urN linux-2.6.34-rc3/virt/kvm/ioapic.c linux-2.6.34-rc4/virt/kvm/ioapic.c
--- linux-2.6.34-rc3/virt/kvm/ioapic.c	2010-04-13 02:18:56.864633413 +0000
+++ linux-2.6.34-rc4/virt/kvm/ioapic.c	2010-04-13 02:19:02.414883252 +0000
@@ -33,6 +33,7 @@
 #include <linux/smp.h>
 #include <linux/hrtimer.h>
 #include <linux/io.h>
+#include <linux/slab.h>
 #include <asm/processor.h>
 #include <asm/page.h>
 #include <asm/current.h>
diff -urN linux-2.6.34-rc3/virt/kvm/irq_comm.c linux-2.6.34-rc4/virt/kvm/irq_comm.c
--- linux-2.6.34-rc3/virt/kvm/irq_comm.c	2010-02-24 18:52:17.000000000 +0000
+++ linux-2.6.34-rc4/virt/kvm/irq_comm.c	2010-04-13 02:19:02.414883252 +0000
@@ -20,6 +20,7 @@
  */
 
 #include <linux/kvm_host.h>
+#include <linux/slab.h>
 #include <trace/events/kvm.h>
 
 #include <asm/msidef.h>
diff -urN linux-2.6.34-rc3/virt/kvm/kvm_main.c linux-2.6.34-rc4/virt/kvm/kvm_main.c
--- linux-2.6.34-rc3/virt/kvm/kvm_main.c	2010-04-13 02:18:56.865633040 +0000
+++ linux-2.6.34-rc4/virt/kvm/kvm_main.c	2010-04-13 02:19:02.415883786 +0000
@@ -22,7 +22,6 @@
 #include <linux/module.h>
 #include <linux/errno.h>
 #include <linux/percpu.h>
-#include <linux/gfp.h>
 #include <linux/mm.h>
 #include <linux/miscdevice.h>
 #include <linux/vmalloc.h>
@@ -46,6 +45,7 @@
 #include <linux/compat.h>
 #include <linux/srcu.h>
 #include <linux/hugetlb.h>
+#include <linux/slab.h>
 
 #include <asm/processor.h>
 #include <asm/io.h>
